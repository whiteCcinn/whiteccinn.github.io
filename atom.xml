<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç™½èœå›ã®æŠ€æœ¯åº“</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.crazylaw.cn/"/>
  <updated>2022-04-11T10:39:06.250Z</updated>
  <id>http://blog.crazylaw.cn/</id>
  
  <author>
    <name>ç™½èœ(whiteCcinn)</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€Toponã€‘- Day 1</title>
    <link href="http://blog.crazylaw.cn/2022/04/11/%E5%85%AC%E5%8F%B8/Topon-day1/"/>
    <id>http://blog.crazylaw.cn/2022/04/11/%E5%85%AC%E5%8F%B8/Topon-day1/</id>
    <published>2022-04-11T07:27:40.000Z</published>
    <updated>2022-04-11T10:39:06.250Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç”±äºå…¥èŒäº†æ–°å…¬å¸ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹æ¯å¤©å­¦ä¹ åˆ°å†…å®¹ï¼ŒåŒ…æ‹¬ä½†ä¸å±€é™äºæŠ€æœ¯ï¼Œè¿è¥ï¼Œä¸šåŠ¡ç­‰ç›¸å…³çš„çŸ¥è¯†ã€‚</p><p>ä»Šå¤©æ˜¯å…¥èŒæ–°å…¬å¸çš„ç¬¬ä¸€å¤©ï¼Œè®°å½•ä¸€ä¸‹ä»Šå¤©å¤„ç†äº†çš„äº‹æƒ…ã€‚</p><a id="more"></a><h2 id="ä¸Šåˆ"><a href="#ä¸Šåˆ" class="headerlink" title="ä¸Šåˆ"></a>ä¸Šåˆ</h2><p>ä»Šå¤©ï¼Œ<code>10:30</code>(æå‰äº†20åˆ†é’Ÿ)æ¥åˆ°å…¬å¸ï¼Œä¸€é¢çš„é¢è¯•å®˜æ¥åˆ°å‰å°ï¼Œåˆ°æˆ‘æ¥åˆ°äº†ç»„é‡Œé€‰æ‹©åº§ä½ã€‚</p><p>åœ¨åº§ä½ä¸Šé€šè¿‡é’‰é’‰å¡«å†™äº†å…¥èŒè¡¨æ ¼ï¼Œæ‰“å¼€äº†è‡ªå·±å¸¦è¿‡æ¥çš„ç¬”è®°æœ¬ç”µè„‘ï¼ŒåŠ å…¥é’‰é’‰çš„ç¾¤ç»„ï¼ŒåŠ å…¥å¾®ä¿¡ç¾¤ç»„ï¼Œé™åäº†å°ä¸€ä¼šå„¿ä¹‹åã€‚</p><p>æ—¶é—´æ¥åˆ°äº†<code>11:00</code>ï¼Œäºæ˜¯ä¸Šåˆåˆ°ç¬¬ä¸€åœºåŸ¹è®­å¼€å§‹äº†ï¼Œå°±æ˜¯ <code>å…¥èŒåŸ¹è®­</code></p><p>ä¸»è¦è®²è§£äº†å…¬å¸ä¸šåŠ¡ï¼Œè€ƒå‹¤åˆ¶åº¦ï¼Œè–ªèµ„æ„æˆï¼Œå›¢å»ºæ´»åŠ¨ï¼ŒæŠ¥é”€ï¼Œç¦ä»¤ç­‰åŸºç¡€äº‹é¡¹ã€‚</p><h2 id="ä¸­åˆ"><a href="#ä¸­åˆ" class="headerlink" title="ä¸­åˆ"></a>ä¸­åˆ</h2><p>å’Œç»„å†…çš„åŒäº‹ä»¬ä¸€èµ·ä¸‹å»è§…é£Ÿäº†ï¼Œåƒå®Œä¹‹åå›åˆ°å…¬å¸è¿›è¡Œå°æ†©ä¸€ä¼šå„¿ã€‚</p><h2 id="ä¸‹åˆ"><a href="#ä¸‹åˆ" class="headerlink" title="ä¸‹åˆ"></a>ä¸‹åˆ</h2><p><code>13:30</code> åˆä¼‘ç»“æŸï¼Œç„¶åå¼€å§‹ï¼Œè‡ªè¡Œæµè§ˆé’‰é’‰çš„å†å²èŠå¤©è®°å½•ï¼Œå’Œæ–‡ä»¶ä»¥åŠé€šçŸ¥å…¬å‘Šï¼ŒHRååŠ©ç”³è¯·äº†ä¼ä¸šé‚®ç®±ã€‚</p><p>é™åäº†ä¸€å°ä¼šä¹‹åï¼Œåœ¨<code>15:40</code>çš„æ—¶å€™è§åˆ°äº†éƒ¨é—¨è´Ÿè´£äººï¼ˆä½†æ˜¯å¹¶éäºŒé¢è´Ÿè´£äººï¼Œçœ‹æ¥äºŒé¢çš„é¢è¯•å®˜çš„æŠ€æœ¯å›¢é˜Ÿè´Ÿè´£äººã€‚ï¼‰æ¥ä¸‹æ¥å°±ä¸€é¢é¢è¯•å®˜å°±å‡†å¤‡å¸¦æˆ‘å»è®¤è¯†ä¸€ä¸‹å‘¨å›´çš„åŒäº‹ï¼Œç¤¾æçš„æˆ‘ï¼Œå¤šå°‘æœ‰ç‚¹ç´§å¼ ï¼ˆæ…¢æ…¢ç†Ÿæ‚‰å§ï¼ŒğŸ˜¢ï¼‰</p><p><code>16:00</code> å¼€å§‹ä»‹ç»å…¬å¸ä¸šåŠ¡ï¼Œéƒ¨é—¨ä¸šåŠ¡ï¼Œé‡ç‚¹è®²è§£äº†ä¸€ä¸‹éƒ¨é—¨ä¸šåŠ¡ã€‚</p><p>å½“ä¸‹éƒ¨é—¨çš„ä¸šåŠ¡ä¸»è¦åŒ…å«å‡ ä¸ªæ¨¡å—ï¼Œåˆ†åˆ«ä¸º:</p><ul><li><code>ADX</code>         æ ¸å¿ƒå¹¿å‘ŠB2Bç«ä»·æœåŠ¡</li><li><code>ç›´æŠ•</code>         ç›´æŠ•ç«ä»·æœåŠ¡</li><li><code>EMR</code>         é˜¿é‡Œäº‘æ•°ä»“</li><li><code>GPï¼ˆDGPï¼‰</code>    deep greenplum(ap+tpéä¸»æµåˆ†æ”¯)</li><li><code>BI</code>          BIæœåŠ¡ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥å«ä¸ºæ•°æ®ä¸­å°æœåŠ¡ï¼Œç±»ä¼¼data-serviceï¼Œç”¨äºé˜²æ­¢ä¸šåŠ¡å±‚ç›´è¿æ•°ä»“</li><li><code>Job</code>         åˆ†å¸ƒå¼ï¼ˆä¸»-ä»ï¼‰çš„æ‹‰å–å„å¹³å°çš„æœåŠ¡ï¼ˆç©¿å±±ç”²b/è…¾è®¯t/facebookï¼‰</li><li><code>Other</code>       å…¶ä»–</li></ul><p>å¹¶ä¸”è§£ç­”äº†ä¸€äº›åœ¨ä»‹ç»ä¸šåŠ¡çš„æ—¶å€™æˆ‘çš„ç–‘æƒ‘ï¼Œä¾‹å¦‚ä¸ºä½•è¦æœ‰2ä¸ªæ•°ä»“ï¼Ÿä»¥åŠå†·çƒ­è®¡ç®—åˆ†ç¦»ä¸ºä»€ä¹ˆä¸è€ƒè™‘åœ¨å…¶ä¸­ä¹‹ç±»çš„é—®é¢˜ã€‚</p><p>å…¶å®åœ¨æˆ‘çœ‹æ¥ï¼ŒGPçš„å­˜åœ¨å°±æ˜¯åˆ©ç”¨æ•°ä»“ç›´æ¥å¤„ç†ä¸€äº›å®æ—¶è®¡ç®—çš„é—®é¢˜ï¼Œæ‰€ä»¥æ²¡æœ‰å¼•å…¥ä¸€äº›ç±»ä¼¼flinkçš„æµè®¡ç®—ï¼Œåªæœ‰åŸºäº<code>EMR</code>çš„åˆ©ç”¨sparkçš„è¿™äº›ç¦»çº¿è®¡ç®—æœåŠ¡ã€‚</p><p>è¿™é‡Œæ‰€æœ‰çš„BIæœåŠ¡ï¼Œå…¶å®å¹¶ä¸æ˜¯å¸¸è§„çš„BIç³»ç»Ÿï¼Œä»…ä»…åªæ˜¯å°å¤šä¸€å±‚APIæä¾›å¤–éœ²æœåŠ¡ï¼Œæä¾›ç»™<code>ä¸šåŠ¡å±‚</code>çš„åŒäº‹è°ƒç”¨ã€‚</p><p>åœ¨è®²è§£çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†æœ‰å¾ˆå¤šå¹¿å‘Šè¡Œä¸šçš„çš„ä¸“ä¸šåè¯æˆ‘éƒ½è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œå¯èƒ½éœ€è¦å»äº†è§£ä¸€ä¸‹å¹¿å‘Šè¡Œä¸šçš„ä¸€äº›ä¸“ä¸šåè¯ï¼Œä¾‹å¦‚<code>å¤´éƒ¨ç«ä»·</code>ï¼Œ<code>ad network</code>ç­‰ç­‰ã€‚</p><p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œéœ€è¦éœ€è¦å»äº†è§£ä¸€äº›ä¸“ä¸šçš„å¹¿å‘Šè¡Œä¸šçš„æ–‡ç« ï¼Œæˆ‘ä¹Ÿä¼šè®°å½•ä¸‹æ¥æˆ‘åœ¨å¹¿å‘Šè¡Œä¸šæ‘„å–åˆ°çš„æ‰€æœ‰çš„çŸ¥è¯†ç‚¹ï¼Œåˆ†äº«ç»™å¤§å®¶ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç”±äºå…¥èŒäº†æ–°å…¬å¸ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹æ¯å¤©å­¦ä¹ åˆ°å†…å®¹ï¼ŒåŒ…æ‹¬ä½†ä¸å±€é™äºæŠ€æœ¯ï¼Œè¿è¥ï¼Œä¸šåŠ¡ç­‰ç›¸å…³çš„çŸ¥è¯†ã€‚&lt;/p&gt;
&lt;p&gt;ä»Šå¤©æ˜¯å…¥èŒæ–°å…¬å¸çš„ç¬¬ä¸€å¤©ï¼Œè®°å½•ä¸€ä¸‹ä»Šå¤©å¤„ç†äº†çš„äº‹æƒ…ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å…¬å¸" scheme="http://blog.crazylaw.cn/categories/%E5%85%AC%E5%8F%B8/"/>
    
    
      <category term="å…¬å¸" scheme="http://blog.crazylaw.cn/tags/%E5%85%AC%E5%8F%B8/"/>
    
  </entry>
  
  <entry>
    <title>ã€Macã€‘Macå®‰è£…è½¯ä»¶æµç¨‹</title>
    <link href="http://blog.crazylaw.cn/2022/03/29/Mac/Mac%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E6%B5%81%E7%A8%8B/"/>
    <id>http://blog.crazylaw.cn/2022/03/29/Mac/Mac%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E6%B5%81%E7%A8%8B/</id>
    <published>2022-03-29T08:35:30.000Z</published>
    <updated>2022-04-11T10:31:25.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘ï¼Œå‡†å¤‡é‡æ–°æ‰“é€ æˆ‘çš„macç”µè„‘ã€‚</p><a id="more"></a><h2 id="iterm2"><a href="#iterm2" class="headerlink" title="iterm2"></a>iterm2</h2><p><img src="/images/%E6%9D%82/iterm2.png" alt="iterm2"></p><p><img src="/images/%E6%9D%82/iterm2-2.png" alt="iterm2"></p><p><img src="/images/%E6%9D%82/iterm2-fonts.png" alt="iterm2"></p><ul><li>å®‰è£…zsh</li><li>å®‰è£… <a href="https://github.com/romkatv/powerlevel10k" target="_blank" rel="noopener">powerlevel10k</a> (å®‰è£…æ–¹å¼å‚è€ƒå®˜ç½‘æ–‡æ¡£)</li><li>æ›¿æ¢ <code>.vimrc</code> ä¸­çš„ <code>zshä¸»é¢˜</code>, <code>ZSH_THEME=&quot;powerlevel10k/powerlevel10k&quot;</code></li></ul><h2 id="vimç›¸å…³"><a href="#vimç›¸å…³" class="headerlink" title="vimç›¸å…³"></a>vimç›¸å…³</h2><p>æˆ‘çš„ä¸ªäººvimé…ç½® <a href="https://github.com/whiteCcinn/ccinn-vim" target="_blank" rel="noopener">ccinn-vim</a></p><p><img src="/images/%E6%9D%82/vim.png" alt="vim"></p><p>vimçš„æ’ä»¶ç®¡ç†é€‰æ‹©æœ‰ <code>Vundle</code>, <code>vim-plug</code></p><h3 id="vimçš„ç›®å½•æ’ä»¶"><a href="#vimçš„ç›®å½•æ’ä»¶" class="headerlink" title="vimçš„ç›®å½•æ’ä»¶"></a>vimçš„ç›®å½•æ’ä»¶</h3><ul><li><a href="https://github.com/preservim/nerdtree" target="_blank" rel="noopener">scrooloose/nerdtree</a></li></ul><h3 id="vimçš„ç›®å½•å¢å¼ºæ’ä»¶-å­—ä½“å’Œiconçš„ä¸‹è½½å’Œå®‰è£…"><a href="#vimçš„ç›®å½•å¢å¼ºæ’ä»¶-å­—ä½“å’Œiconçš„ä¸‹è½½å’Œå®‰è£…" class="headerlink" title="vimçš„ç›®å½•å¢å¼ºæ’ä»¶,å­—ä½“å’Œiconçš„ä¸‹è½½å’Œå®‰è£…"></a>vimçš„ç›®å½•å¢å¼ºæ’ä»¶,å­—ä½“å’Œiconçš„ä¸‹è½½å’Œå®‰è£…</h3><p>å¯ä»¥åœ¨nerdç›®å½•ä¸‹æ˜¾ç¤ºå›¾æ ‡ï¼Œå…¶ä»–å­—ä½“ç­‰</p><ul><li><p><a href="https://github.com/ryanoasis/nerd-fonts" target="_blank" rel="noopener">ryanoasis/nerd-fonts</a></p></li><li><p><a href="https://github.com/ryanoasis/vim-devicons" target="_blank" rel="noopener">ryanoasis/vim-devicons</a></p></li></ul><blockquote><p>ä¸»ä½“iterm2 çš„å­—ä½“éœ€è¦å’Œnerd-fontsä¸€è‡´</p></blockquote><h3 id="vim-çª—å£çŠ¶æ€æ "><a href="#vim-çª—å£çŠ¶æ€æ " class="headerlink" title="vim çª—å£çŠ¶æ€æ "></a>vim çª—å£çŠ¶æ€æ </h3><ul><li><a href="https://github.com/vim-airline/vim-airline" target="_blank" rel="noopener">vim-airline/vim-airline</a></li><li><a href="https://github.com/vim-airline/vim-airline-themes" target="_blank" rel="noopener">vim-airline/vim-airline-themes</a></li></ul><h2 id="Clean-my-mac"><a href="#Clean-my-mac" class="headerlink" title="Clean my mac"></a>Clean my mac</h2><p>ä»˜è´¹è½¯ä»¶ï¼Œæ¸…ç†ç”µè„‘</p><h2 id="ntfs-for-mac"><a href="#ntfs-for-mac" class="headerlink" title="ntfs for mac"></a>ntfs for mac</h2><p>å¤–ç½®ç§»åŠ¨ç¡¬ç›˜ä¸“ç”¨</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘ï¼Œå‡†å¤‡é‡æ–°æ‰“é€ æˆ‘çš„macç”µè„‘ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Mac" scheme="http://blog.crazylaw.cn/categories/Mac/"/>
    
    
      <category term="Mac" scheme="http://blog.crazylaw.cn/tags/Mac/"/>
    
  </entry>
  
  <entry>
    <title>ã€DevOpsã€‘gitå‘½ä»¤åœºæ™¯ç”¨æ³•</title>
    <link href="http://blog.crazylaw.cn/2022/03/19/DevOps/git%E5%91%BD%E4%BB%A4%E5%9C%BA%E6%99%AF%E7%94%A8%E6%B3%95/"/>
    <id>http://blog.crazylaw.cn/2022/03/19/DevOps/git%E5%91%BD%E4%BB%A4%E5%9C%BA%E6%99%AF%E7%94%A8%E6%B3%95/</id>
    <published>2022-03-19T06:35:30.000Z</published>
    <updated>2022-03-19T12:31:48.994Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç°åœ¨ï¼Œgitå·²ç»æˆä¸ºäº†å¤§å®¶çš„ä»£ç ä»“åº“ç®¡ç†çš„ä¸€ä¸ªå·¥å…·äº†ã€‚åœ¨æ—¥å¸¸å·¥ä½œï¼Œæˆ‘ä»¬ä¼šé‡åˆ°å„ç§ä¸ªæ ·çš„gité—®é¢˜ï¼Œå› æ­¤ï¼Œç”¨ä¸€ç¯‡æ–‡ç« æ¥ç´¯è®¡è®°å½•ï¼Œæ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ï¼Œä½†æ˜¯ä¸å¸¸ç”¨çš„å‘½ä»¤ã€‚</p><a id="more"></a><h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><p>å…¶å® <code>git</code> çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¼€å‘è€…åº”è¯¥å¾ˆå¤šæœ‰ä¼šäº†ï¼Œå­˜åœ¨ä»¥ä¸‹å‡ ä¸ªåŒºåŸŸï¼š</p><ul><li>å·¥ä½œåŒº   <code>ï¼ˆä½ çš„ä»»ä½•æ”¹åŠ¨ï¼‰</code></li><li>æš‚å­˜åŒº   <code>ï¼ˆgit addï¼‰</code></li><li>æœ¬åœ°ä»“åº“ <code>ï¼ˆgit commitï¼‰</code></li><li>è¿œç«¯ä»£ç ä»“åº“ <code>ï¼ˆgit pushï¼‰</code></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç°åœ¨ï¼Œgitå·²ç»æˆä¸ºäº†å¤§å®¶çš„ä»£ç ä»“åº“ç®¡ç†çš„ä¸€ä¸ªå·¥å…·äº†ã€‚åœ¨æ—¥å¸¸å·¥ä½œï¼Œæˆ‘ä»¬ä¼šé‡åˆ°å„ç§ä¸ªæ ·çš„gité—®é¢˜ï¼Œå› æ­¤ï¼Œç”¨ä¸€ç¯‡æ–‡ç« æ¥ç´¯è®¡è®°å½•ï¼Œæ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ï¼Œä½†æ˜¯ä¸å¸¸ç”¨çš„å‘½ä»¤ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/categories/DevOps/"/>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/tags/DevOps/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- go mapæºç é˜…è¯»</title>
    <link href="http://blog.crazylaw.cn/2022/03/10/Golang/go%20map%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>http://blog.crazylaw.cn/2022/03/10/Golang/go%20map%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2022-03-10T07:55:51.000Z</published>
    <updated>2022-03-22T08:54:11.241Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘å‘ç°åŒäº‹å»é¢è¯•ï¼Œå‘ç°å¾ˆå¤šæ—¶å€™ä¼šè¢«é—®åˆ°<code>go map</code>çš„åº•å±‚ç»“æ„ã€‚ä»Šå¤©æˆ‘ä»¬æ¥è®°å½•ä¸€ä¸‹mapçš„åº•å±‚å®ç°ã€‚</p><a id="more"></a><p>å½“ä¸‹çš„æºç é˜…è¯»åŸºäº1.17</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A header for a Go map.</span></span><br><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.</span></span><br><span class="line"><span class="comment">// Make sure this stays in sync with the compiler's definition.</span></span><br><span class="line">count     <span class="keyword">int</span> <span class="comment">// # live cells == size of map.  Must be first (used by len() builtin)</span></span><br><span class="line">flags     <span class="keyword">uint8</span></span><br><span class="line">B         <span class="keyword">uint8</span>  <span class="comment">// log_2 of # of buckets (can hold up to loadFactor * 2^B items)</span></span><br><span class="line">noverflow <span class="keyword">uint16</span> <span class="comment">// approximate number of overflow buckets; see incrnoverflow for details</span></span><br><span class="line">hash0     <span class="keyword">uint32</span> <span class="comment">// hash seed</span></span><br><span class="line"></span><br><span class="line">buckets    unsafe.Pointer <span class="comment">// array of 2^B Buckets. may be nil if count==0.</span></span><br><span class="line">oldbuckets unsafe.Pointer <span class="comment">// previous bucket array of half the size, non-nil only when growing</span></span><br><span class="line">nevacuate  <span class="keyword">uintptr</span>        <span class="comment">// progress counter for evacuation (buckets less than this have been evacuated)</span></span><br><span class="line"></span><br><span class="line">extra *mapextra <span class="comment">// optional fields</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªmapçš„å¤´éƒ¨ç»“æ„ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªå…³é”®ç»“æ„ï¼Œåˆ†åˆ«æ˜¯</p><ul><li><code>count</code> å½“å‰mapçš„å…ƒç´ ä¸ªæ•°</li><li><code>buckets</code> æ¡¶çš„æ•°é‡ï¼Œä¸€èˆ¬æ˜¯2^Bä¸ª</li><li><code>oldbuckets</code> æ‰©å®¹å‰çš„buckets</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapextra holds fields that are not present on all maps.</span></span><br><span class="line"><span class="keyword">type</span> mapextra <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// If both key and elem do not contain pointers and are inline, then we mark bucket</span></span><br><span class="line"><span class="comment">// type as containing no pointers. This avoids scanning such maps.</span></span><br><span class="line"><span class="comment">// However, bmap.overflow is a pointer. In order to keep overflow buckets</span></span><br><span class="line"><span class="comment">// alive, we store pointers to all overflow buckets in hmap.extra.overflow and hmap.extra.oldoverflow.</span></span><br><span class="line"><span class="comment">// overflow and oldoverflow are only used if key and elem do not contain pointers.</span></span><br><span class="line"><span class="comment">// overflow contains overflow buckets for hmap.buckets.</span></span><br><span class="line"><span class="comment">// oldoverflow contains overflow buckets for hmap.oldbuckets.</span></span><br><span class="line"><span class="comment">// The indirection allows to store a pointer to the slice in hiter.</span></span><br><span class="line">overflow    *[]*bmap</span><br><span class="line">oldoverflow *[]*bmap</span><br><span class="line"></span><br><span class="line"><span class="comment">// nextOverflow holds a pointer to a free overflow bucket.</span></span><br><span class="line">nextOverflow *bmap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªå¯ä»¥å¿½ç•¥ã€‚</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A bucket for a Go map.</span></span><br><span class="line"><span class="keyword">type</span> bmap <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// tophash generally contains the top byte of the hash value</span></span><br><span class="line"><span class="comment">// for each key in this bucket. If tophash[0] &lt; minTopHash,</span></span><br><span class="line"><span class="comment">// tophash[0] is a bucket evacuation state instead.</span></span><br><span class="line">tophash [bucketCnt]<span class="keyword">uint8</span></span><br><span class="line"><span class="comment">// Followed by bucketCnt keys and then bucketCnt elems.</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> packing all the keys together and then all the elems together makes the</span></span><br><span class="line"><span class="comment">// code a bit more complicated than alternating key/elem/key/elem/... but it allows</span></span><br><span class="line"><span class="comment">// us to eliminate padding which would be needed for, e.g., map[int64]int8.</span></span><br><span class="line"><span class="comment">// Followed by an overflow pointer.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bmapæœ‰2ä¸ªæ¨¡å—çš„å±æ€§æ˜¯åœ¨ç¼–è¯‘æ³¨å…¥çš„ï¼Œåœ¨æºç ä¸Šæ²¡åŠæ³•æµè§ˆã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                                                    â”‚bmap                                 â”‚</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                                     â”‚</span><br><span class="line">â”‚bmap                                 â”‚             â”‚                                     â”‚</span><br><span class="line">â”‚                                     â”‚             â”‚                                     â”‚</span><br><span class="line">â”‚                                     â”‚             â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span><br><span class="line">â”‚                                     â”‚             â”‚    â”‚tohash[bucketCnt]uint8        â”‚ â”‚</span><br><span class="line">â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚             â”‚    â”‚                              â”‚ â”‚</span><br><span class="line">â”‚    â”‚tohash[bucketCnt]uint8        â”‚ â”‚             â”‚    â”‚                              â”‚ â”‚</span><br><span class="line">â”‚    â”‚                              â”‚ â”‚             â”‚    â”‚                              â”‚ â”‚</span><br><span class="line">â”‚    â”‚                              â”‚ â”‚             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span><br><span class="line">â”‚    â”‚                              â”‚ â”‚             â”‚                                     â”‚</span><br><span class="line">â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚    ++++++++++++++++++++++++++++++++ â”‚</span><br><span class="line">â”‚                                     â”‚             â”‚    +  byte-array                  + â”‚</span><br><span class="line">â”‚    ++++++++++++++++++++++++++++++++ â”‚             â”‚    +        (save key-value)      + â”‚</span><br><span class="line">â”‚    +  byte-array                  + â”‚     â”Œâ”€â”€â”€â”€â”€â”€â–ºâ”‚    +                              + â”‚</span><br><span class="line">â”‚    +        (save key-value)      + â”‚     â”‚       â”‚    ++++++++++++++++++++++++++++++++ â”‚</span><br><span class="line">â”‚    +                              + â”‚     â”‚       â”‚                                     â”‚</span><br><span class="line">â”‚    ++++++++++++++++++++++++++++++++ â”‚     â”‚       â”‚    ++++++++++++++++++++++++++++++++ â”‚</span><br><span class="line">â”‚                                     â”‚     â”‚       â”‚    +   point to growed bucket     + â”‚</span><br><span class="line">â”‚    ++++++++++++++++++++++++++++++++ â”‚     â”‚       â”‚    +                              + â”‚</span><br><span class="line">â”‚    +   point to growed bucket     + â”‚     â”‚       â”‚    +                              + â”‚</span><br><span class="line">â”‚    +                              + â”œâ”€â”€â”€â”€â”€â”˜       â”‚    +++++++++++++â”€â”+++++++++++++++++ â”‚</span><br><span class="line">â”‚    +                              + â”‚             â”‚                  â”‚                  â”‚</span><br><span class="line">â”‚    ++++++++++++++++++++++++++++++++ â”‚             â”‚                  â”‚                  â”‚</span><br><span class="line">â”‚                                     â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">â”‚                                     â”‚                                â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚</span><br><span class="line">                                                                       â”‚</span><br><span class="line">                                                                       â–¼</span><br><span class="line">                                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">                                                     â”‚bmap                                 â”‚</span><br><span class="line">                                                     â”‚                                     â”‚</span><br><span class="line">                                                     â”‚                                     â”‚</span><br><span class="line">                                                     â”‚                                     â”‚</span><br><span class="line">                                                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚</span><br><span class="line">                                                     â”‚    â”‚tohash[bucketCnt]uint8        â”‚ â”‚</span><br><span class="line">                                                     â”‚    â”‚                              â”‚ â”‚</span><br><span class="line">                                                     â”‚    â”‚                              â”‚ â”‚</span><br><span class="line">                                                     â”‚    â”‚                              â”‚ â”‚</span><br><span class="line">                                                     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚</span><br><span class="line">                                                     â”‚                                     â”‚</span><br><span class="line">                                                     â”‚    ++++++++++++++++++++++++++++++++ â”‚</span><br><span class="line">                                                     â”‚    +  byte-array                  + â”‚</span><br><span class="line">                                                     â”‚    +        (save key-value)      + â”‚</span><br><span class="line">                                                     â”‚    +                              + â”‚</span><br><span class="line">                                                     â”‚    ++++++++++++++++++++++++++++++++ â”‚</span><br><span class="line">                                                     â”‚                                     â”‚</span><br><span class="line">                                                     â”‚    ++++++++++++++++++++++++++++++++ â”‚</span><br><span class="line">                                                     â”‚    +   point to growed bucket     + â”‚</span><br><span class="line">                                                     â”‚    +                              + â”‚</span><br><span class="line">                                                     â”‚    +                              + â”‚</span><br><span class="line">                                                     â”‚    ++++++++++++++++++++++++++++++++ â”‚</span><br><span class="line">                                                     â”‚                                     â”‚</span><br><span class="line">                                                     â”‚                                     â”‚</span><br><span class="line">                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜s</span><br></pre></td></tr></table></figure><p>ç›¸æ¯”äºhmapï¼Œbucketçš„ç»“æ„æ˜¾å¾—ç®€å•ä¸€äº›ï¼Œ<code>byte-array</code>æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„mapä¸­çš„keyå’Œvalueå°±å­˜å‚¨åœ¨è¿™é‡Œã€‚<code>é«˜ä½å“ˆå¸Œå€¼</code>æ•°ç»„è®°å½•çš„æ˜¯å½“å‰bucketä¸­keyç›¸å…³çš„<code>ç´¢å¼•</code></p><h2 id="mapassign-èµ‹å€¼è¿‡ç¨‹"><a href="#mapassign-èµ‹å€¼è¿‡ç¨‹" class="headerlink" title="mapassign èµ‹å€¼è¿‡ç¨‹"></a>mapassign èµ‹å€¼è¿‡ç¨‹</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. åˆ¤æ–­ä¼šå¦å½“å‰å·²ç»è¿›è¡Œäº†å†™ä¿æŠ¤</span></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">"concurrent map writes"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 2. æ ¹æ®keyè®¡ç®—å“ˆå¸Œå€¼</span></span><br><span class="line">hash := t.hasher(key, <span class="keyword">uintptr</span>(h.hash0))</span><br><span class="line"><span class="comment">// 3. è¿›è¡Œå†™ä¿æŠ¤</span></span><br><span class="line">h.flags ^= hashWriting</span><br><span class="line"><span class="comment">// 4. è®¡ç®—hashçš„ä½ä½éƒ¨åˆ†</span></span><br><span class="line">bucket := hash &amp; bucketMask(h.B)</span><br><span class="line"><span class="comment">// 5. åˆ¤æ–­æ˜¯å¦æ­£åœ¨æ‰©å®¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ•°æ®è¿ç§»</span></span><br><span class="line"><span class="keyword">if</span> h.growing() &#123;</span><br><span class="line">growWork(t, h, bucket)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 6. æ ¹æ®ä½ä½hashæ‰¾åˆ°å¯¹åº”çš„bucket</span></span><br><span class="line">b := (*bmap)(add(h.buckets, bucket*<span class="keyword">uintptr</span>(t.bucketsize)))</span><br><span class="line"><span class="comment">// 7. è®¡ç®—é«˜ä½hash</span></span><br><span class="line">top := tophash(hash)</span><br><span class="line"><span class="comment">// 8. ä»å¯¹åº”çš„bucketä»¥åŠoverflow bucketsä¸­æ‰¾åˆ°å¯¹åº”çš„keyçš„ä½ç½®</span></span><br><span class="line"><span class="comment">// 9. åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™é‡æ–°æ‰¾åˆ°keyçš„ä½ç½®</span></span><br><span class="line"><span class="keyword">if</span> !h.growing() &amp;&amp; (overLoadFactor(h.count+<span class="number">1</span>, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) &#123;</span><br><span class="line">hashGrow(t, h)</span><br><span class="line"><span class="keyword">goto</span> again <span class="comment">// Growing the table invalidates everything, so try again</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 10. æ‹¿ç€å¯ä»¥æ’å…¥kvçš„å†…å­˜åœ°å€è¿›è¡Œèµ‹å€¼</span></span><br><span class="line"><span class="keyword">if</span> t.indirectkey() &#123;</span><br><span class="line">kmem := newobject(t.key)</span><br><span class="line">*(*unsafe.Pointer)(insertk) = kmem</span><br><span class="line">insertk = kmem</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> t.indirectelem() &#123;</span><br><span class="line">vmem := newobject(t.elem)</span><br><span class="line">*(*unsafe.Pointer)(elem) = vmem</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 11. å†™ä¿æŠ¤æ£€æŸ¥ï¼Œå¹¶ä¸”è§£é™¤å†™ä¿æŠ¤</span></span><br><span class="line"><span class="keyword">if</span> h.flags&amp;hashWriting == <span class="number">0</span> &#123;</span><br><span class="line">throw(<span class="string">"concurrent map writes"</span>)</span><br><span class="line">&#125;</span><br><span class="line">h.flags &amp;^= hashWriting</span><br></pre></td></tr></table></figure><p>èµ‹å€¼è¿‡ç¨‹å°±æ˜¯ï¼š</p><ol><li>è¿›è¡Œå†™ä¿æŠ¤</li><li>æ ¹æ®keyè®¡ç®—å“ˆå¸Œå€¼</li><li>åœ¨ä½ä½å“ˆå¸Œä¸­æ‰¾åˆ°bucket</li><li>è®¡ç®—é«˜ä½hash</li><li>åœ¨bucketå’Œoverflow bucketæ¡¶ä¸­æ‰¾åˆ°èƒ½æ’å…¥key/valueçš„ä½ç½®</li><li>æ‰¾åˆ°äº†å°±èµ‹å€¼</li><li>è§£é™¤é”ä¿æŠ¤</li></ol><blockquote><p>å…¶ä¸­æœ‰å¤šæ¬¡åˆ¤æ–­bucketæ˜¯å¦éœ€è¦æ‰©å®¹å’Œæ˜¯å¦æ­£åœ¨æ‰©å®¹</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘å‘ç°åŒäº‹å»é¢è¯•ï¼Œå‘ç°å¾ˆå¤šæ—¶å€™ä¼šè¢«é—®åˆ°&lt;code&gt;go map&lt;/code&gt;çš„åº•å±‚ç»“æ„ã€‚ä»Šå¤©æˆ‘ä»¬æ¥è®°å½•ä¸€ä¸‹mapçš„åº•å±‚å®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Goæºç å‰–æç³»åˆ—" scheme="http://blog.crazylaw.cn/categories/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%B3%BB%E5%88%97/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
      <category term="Goæºç å‰–æ" scheme="http://blog.crazylaw.cn/tags/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- go time.Sleepæºç é˜…è¯»</title>
    <link href="http://blog.crazylaw.cn/2022/03/10/Golang/go%20time.Sleep%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>http://blog.crazylaw.cn/2022/03/10/Golang/go%20time.Sleep%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2022-03-10T07:55:51.000Z</published>
    <updated>2022-03-10T14:09:34.592Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç”±äºtime.Sleep()ä¼šæŒ‚èµ·æˆ‘ä»¬çš„åç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„åº•å±‚åŸç†ã€‚</p><a id="more"></a><h2 id="sleep-çš„å®ç°"><a href="#sleep-çš„å®ç°" class="headerlink" title="sleep çš„å®ç°"></a>sleep çš„å®ç°</h2><p>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>time.Sleep(1 * time.Second)</code> æ¥å°† goroutine æš‚æ—¶ä¼‘çœ ä¸€æ®µæ—¶é—´ã€‚sleep æ“ä½œåœ¨åº•å±‚å®ç°ä¹Ÿæ˜¯åŸºäº timer å®ç°çš„ã€‚</p><p>æœ‰ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼Œå•ç‹¬æ‹¿å‡ºæ¥è®²ä¸‹ã€‚</p><p>æˆ‘ä»¬å›ºç„¶ä¹Ÿå¯ä»¥è¿™ä¹ˆåšæ¥å®ç° goroutine çš„ä¼‘çœ :</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">timer := time.NewTimer(<span class="number">2</span> * time.Seconds)</span><br><span class="line">&lt;-timer.C</span><br></pre></td></tr></table></figure><p>è¿™ä¹ˆåšå½“ç„¶å¯ä»¥ã€‚ä½† golang åº•å±‚æ˜¾ç„¶ä¸æ˜¯è¿™ä¹ˆåšçš„ï¼Œå› ä¸ºè¿™æ ·æœ‰ä¸¤ä¸ªæ˜æ˜¾çš„é¢å¤–æ€§èƒ½æŸè€—ã€‚</p><ul><li>æ¯æ¬¡è°ƒç”¨ sleep çš„æ—¶å€™ï¼Œéƒ½è¦åˆ›å»ºä¸€ä¸ª timer å¯¹è±¡</li><li>éœ€è¦ä¸€ä¸ª channel æ¥ä¼ é€’äº‹ä»¶</li></ul><p>æ—¢ç„¶éƒ½å¯ä»¥æ”¾åœ¨ runtime é‡Œé¢åšã€‚golang é‡Œé¢åšçš„æ›´åŠ å¹²å‡€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timeSleep puts the current goroutine to sleep for at least ns nanoseconds.</span></span><br><span class="line"><span class="comment">//go:linkname timeSleep time.Sleep</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">timeSleep</span><span class="params">(ns <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> ns &lt;= <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gp := getg()</span><br><span class="line">t := gp.timer</span><br><span class="line"><span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</span><br><span class="line">t = <span class="built_in">new</span>(timer)</span><br><span class="line">gp.timer = t</span><br><span class="line">&#125;</span><br><span class="line">t.f = goroutineReady</span><br><span class="line">t.arg = gp</span><br><span class="line">t.nextwhen = nanotime() + ns</span><br><span class="line"><span class="keyword">if</span> t.nextwhen &lt; <span class="number">0</span> &#123; <span class="comment">// check for overflow.</span></span><br><span class="line">t.nextwhen = maxWhen</span><br><span class="line">&#125;</span><br><span class="line">gopark(resetForSleep, unsafe.Pointer(t), waitReasonSleep, traceEvGoSleep, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨Gå¯¹è±¡ä¸Šå­˜åœ¨ä¸€ä¸ªtimerå±æ€§ï¼Œåœ¨Gçš„ç”Ÿå‘½å‘¨æœŸé‡Œtimeréƒ½æ˜¯å”¯ä¸€å­˜åœ¨ï¼Œè§£å†³äº†é‡å¤æ–°å»ºå¯¹è±¡çš„é—®é¢˜</li><li>å¦‚æœä¸å­˜åœ¨timerï¼Œåˆ™åœ¨ç¬¬ä¸€æ¬¡çš„æ—¶å€™åˆ›å»ºtimer</li></ul><p>å¹¶ä¸”æŠŠ<code>t.f</code>è®¾ç½®æˆ<code>goroutineReay</code>(è¿™ä¸ªæ„æ€æ˜¯timeåˆ°äº†æ—¶é—´ä¹‹åè®¾ç½®ä¸€ä¸ªè§¦å‘å‡½æ•°ï¼Œè¿™ä¸ªè§¦å‘å‡½æ•°å°±æ˜¯å”¤é†’æˆ‘ä»¬å½“å‰Gä»»åŠ¡)ã€‚</p><p>ç„¶åé€šè¿‡<code>gopark</code>æ¥æŒ‚èµ·å½“å‰çš„Gä»»åŠ¡</p><h2 id="å®šæ—¶å™¨çš„è§¦å‘æœºåˆ¶"><a href="#å®šæ—¶å™¨çš„è§¦å‘æœºåˆ¶" class="headerlink" title="å®šæ—¶å™¨çš„è§¦å‘æœºåˆ¶"></a>å®šæ—¶å™¨çš„è§¦å‘æœºåˆ¶</h2><p>å…±åˆ†ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸º <code>è°ƒåº¦å™¨è§¦å‘</code> å’Œ <code>ç›‘æ§çº¿ç¨‹sysmon</code> è§¦å‘ï¼Œä¸¤è€…ä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨å‡½æ•° <code>checkTimers()</code> æ¥å®ç°çš„ã€‚</p><p>ä¸»è¦æœ‰ä¸¤ä¸ªåœ°æ–¹ä¼šæ£€æŸ¥è®¡æ—¶å™¨ï¼Œä¸€ä¸ªæ˜¯ <code>runtime.schedule</code>ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>findrunnable</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime/proc.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">schedule</span><span class="params">()</span></span> &#123; </span><br><span class="line"> _g_ := getg() </span><br><span class="line"> </span><br><span class="line">top: </span><br><span class="line"> pp := _g_.m.p.ptr() </span><br><span class="line"> pp.preempt = <span class="literal">false</span> </span><br><span class="line"> </span><br><span class="line"> <span class="comment">// å¤„ç†è°ƒåº¦æ—¶çš„è®¡æ—¶å™¨è§¦å‘ </span></span><br><span class="line"> checkTimers(pp, <span class="number">0</span>) </span><br><span class="line"> ... </span><br><span class="line"> </span><br><span class="line"> execute(gp, inheritTime) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–ä¸€ç§æ˜¯å½“å‰å¤„ç†å™¨ P æ²¡æœ‰å¯æ‰§è¡Œçš„ Timerï¼Œä¸”æ²¡æœ‰å¯æ‰§è¡Œçš„ Gã€‚é‚£ä¹ˆæŒ‰ç…§è°ƒåº¦æ¨¡å‹ï¼Œå°±ä¼šå»<code>çªƒå–å…¶ä»–è®¡æ—¶å™¨</code>å’Œ <code>G</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime/proc.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findrunnable</span><span class="params">()</span> <span class="params">(gp *g, inheritTime <span class="keyword">bool</span>)</span></span> &#123; </span><br><span class="line"> _g_ := getg() </span><br><span class="line"> </span><br><span class="line">top: </span><br><span class="line"> _p_ := _g_.m.p.ptr() </span><br><span class="line"> ... </span><br><span class="line"> now, pollUntil, _ := checkTimers(_p_, <span class="number">0</span>) </span><br><span class="line"> ... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç”±äºtime.Sleep()ä¼šæŒ‚èµ·æˆ‘ä»¬çš„åç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„åº•å±‚åŸç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Goæºç å‰–æç³»åˆ—" scheme="http://blog.crazylaw.cn/categories/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%B3%BB%E5%88%97/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
      <category term="Goæºç å‰–æ" scheme="http://blog.crazylaw.cn/tags/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- go channelæºç é˜…è¯»</title>
    <link href="http://blog.crazylaw.cn/2022/03/04/Golang/go%20channel%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>http://blog.crazylaw.cn/2022/03/04/Golang/go%20channel%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2022-03-03T16:43:51.000Z</published>
    <updated>2022-03-29T02:24:03.596Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>channel æ˜¯ Golang ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ <code>Golang CSP</code> å¹¶å‘æ¨¡å‹çš„ä¸€ä¸ªé‡è¦ä½“ç°ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œgoroutine ä¹‹é—´å¯ä»¥é€šè¿‡ channel è¿›è¡Œé€šä¿¡ã€‚</p><p>channel åœ¨ Golang å¦‚æ­¤é‡è¦ï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨é¢‘ç‡éå¸¸é«˜ï¼Œä»¥è‡³äºä¸å¾—ä¸å¥½å¥‡å…¶å†…éƒ¨å®ç°ã€‚æœ¬æ–‡å°†åŸºäº <code>go 1.17</code> çš„æºç ï¼Œåˆ†æ channel çš„å†…éƒ¨å®ç°åŸç†ã€‚</p><a id="more"></a><h2 id="channel-çš„åŸºæœ¬ä½¿ç”¨"><a href="#channel-çš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="channel çš„åŸºæœ¬ä½¿ç”¨"></a>channel çš„åŸºæœ¬ä½¿ç”¨</h2><p>åœ¨æ­£å¼åˆ†æ channel çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ channel çš„æœ€åŸºæœ¬ç”¨æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        c &lt;- <span class="number">1</span> <span class="comment">// send to channel</span></span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    x := &lt;-c <span class="comment">// recv from channel</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>make(chan int)</code> æ¥åˆ›å»ºäº†ä¸€ä¸ªç±»å‹ä¸º int çš„ channelã€‚<br>åœ¨ä¸€ä¸ª goroutine ä¸­ä½¿ç”¨ <code>c &lt;- 1</code> å°†æ•°æ®å‘é€åˆ° channel ä¸­ã€‚åœ¨ä¸» goroutine ä¸­é€šè¿‡ <code>x := &lt;- c</code> ä» channel ä¸­è¯»å–æ•°æ®å¹¶èµ‹å€¼ç»™ xã€‚</p><p>ä»¥ä¸Šä»£ç å¯¹åº”äº† channel çš„ä¸¤ç§åŸºæœ¬æ“ä½œï¼š</p><ul><li>send æ“ä½œ <code>c &lt;- 1</code> è¡¨ç¤ºå‘é€æ•°æ®åˆ° channel</li><li>recv æ“ä½œ <code>x := &lt;- c</code> è¡¨ç¤ºä» channel ä¸­æ¥æ”¶æ•°æ®ã€‚</li></ul><p>æ­¤å¤–ï¼Œchannel è¿˜åˆ†ä¸º<code>æœ‰ç¼“å­˜ channel</code> å’Œ<code>æ— ç¼“å­˜ channel</code>ã€‚ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ— ç¼“å†²çš„ channelã€‚å¯¹äºæ— ç¼“å†²çš„ channelï¼Œå¦‚æœå½“å‰æ²¡æœ‰å…¶ä»– goroutine æ­£åœ¨æ¥æ”¶ channel æ•°æ®ï¼Œåˆ™å‘é€æ–¹ä¼šé˜»å¡åœ¨å‘é€è¯­å¥å¤„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ channel åˆå§‹åŒ–æ—¶æŒ‡å®šç¼“å†²åŒºå¤§å°ã€‚ä¾‹å¦‚ï¼Œ<code>make(chan int, 2)</code> åˆ™æŒ‡å®šç¼“å†²åŒºå¤§å°ä¸º 2ã€‚åœ¨ç¼“å†²åŒºæœªæ»¡ä¹‹å‰ï¼Œå‘é€æ–¹æ— é˜»å¡åœ°å¯ä»¥å¾€ channel å‘é€æ•°æ®ï¼Œæ— éœ€ç­‰å¾…æ¥æ”¶æ–¹å‡†å¤‡å¥½ã€‚è€Œå¦‚æœç¼“å†²åŒºå·²æ»¡ï¼Œåˆ™å‘é€æ–¹ä¾ç„¶ä¼šé˜»å¡ã€‚</p><h2 id="channel-å¯¹åº”çš„åº•å±‚å®ç°å‡½æ•°"><a href="#channel-å¯¹åº”çš„åº•å±‚å®ç°å‡½æ•°" class="headerlink" title="channel å¯¹åº”çš„åº•å±‚å®ç°å‡½æ•°"></a>channel å¯¹åº”çš„åº•å±‚å®ç°å‡½æ•°</h2><p>åœ¨æ¢ç©¶ channel æºç ä¹‹å‰ï¼Œæˆ‘ä»¬è‚¯å®šé¦–å…ˆéœ€è¦å…ˆæ‰¾åˆ° channel åœ¨ Golang çš„å…·ä½“å®ç°åœ¨å“ªã€‚å› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨ channel æ—¶ï¼Œç”¨çš„æ˜¯ <code>&lt;- ç¬¦å·</code>ï¼Œå¹¶ä¸èƒ½ç›´æ¥åœ¨ go æºç ä¸­æ‰¾åˆ°å…¶å®ç°ã€‚ä½†æ˜¯ Golang ç¼–è¯‘å™¨å¿…ç„¶ä¼šå°† <code>&lt;-</code> ç¬¦å·ç¿»è¯‘æˆåº•å±‚å¯¹åº”çš„å®ç°ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Go è‡ªå¸¦çš„å‘½ä»¤: <code>go tool compile -N -l -S hello.go</code>, å°†ä»£ç ç¿»è¯‘æˆå¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ã€‚</p><p>æˆ–è€…ï¼Œç›´æ¥å¯ä»¥ä½¿ç”¨ <code>Compiler Explorer</code> è¿™ä¸ªåœ¨çº¿å·¥å…·ã€‚å¯¹äºä¸Šè¿°ç¤ºä¾‹ä»£ç å¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªé“¾æ¥çœ‹å…¶æ±‡ç¼–ç»“æœ: <a href="go.godbolt.org/z/3xw5Cj">go.godbolt.org/z/3xw5Cj</a>ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="/images/Go/%E6%BA%90%E7%A0%81/chansend1.png" alt="chansend1"></p><blockquote><p>chansend1</p></blockquote><p><img src="/images/Go/%E6%BA%90%E7%A0%81/chanrevc1.png" alt="chanrevc1"></p><blockquote><p>chanrevc1</p></blockquote><p>é€šè¿‡ä»”ç»†æŸ¥çœ‹ä»¥ä¸Šç¤ºä¾‹ä»£ç å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå¯ä»¥å‘ç°ä»¥ä¸‹çš„å¯¹åº”å…³ç³»ï¼š</p><p>channel çš„æ„é€ è¯­å¥ <code>make(chan int)</code>, å¯¹åº”çš„æ˜¯ <code>runtime.makechan</code> å‡½æ•°<br>å‘é€è¯­å¥ <code>c &lt;- 1</code>, å¯¹åº”çš„æ˜¯ <code>runtime.chansend1</code> å‡½æ•°<br>æ¥æ”¶è¯­å¥ <code>x := &lt;- c</code>, å¯¹åº”çš„æ˜¯ <code>runtime.chanrecv1</code> å‡½æ•°<br>ä»¥ä¸Šå‡ ä¸ªå‡½æ•°çš„å®ç°éƒ½ä½äº go æºç ä¸­çš„ <code>runtime/chan.go</code> ä»£ç æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥é’ˆå¯¹è¿™å‡ ä¸ªå‡½æ•°ï¼Œæ¢ç©¶ä¸‹ channel çš„å®ç°ã€‚</p><h2 id="channel-çš„æ„é€ "><a href="#channel-çš„æ„é€ " class="headerlink" title="channel çš„æ„é€ "></a>channel çš„æ„é€ </h2><p>channel çš„æ„é€ è¯­å¥ <code>make(chan int)</code>ï¼Œå°†ä¼šè¢« golang ç¼–è¯‘å™¨ç¿»è¯‘ä¸º <code>runtime.makechan</code> å‡½æ•°, å…¶å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan</span><span class="params">(t *chantype, size <span class="keyword">int</span>)</span> *<span class="title">hchan</span></span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>t *chantype</code> å³æ„é€  channel æ—¶ä¼ å…¥çš„å…ƒç´ ç±»å‹ã€‚<code>size int</code> å³ç”¨æˆ·æŒ‡å®šçš„ channel ç¼“å†²åŒºå¤§å°ï¼Œä¸æŒ‡å®šåˆ™ä¸º 0ã€‚è¯¥å‡½æ•°çš„è¿”å›å€¼æ˜¯ <code>*hchan</code>ã€‚hchan åˆ™æ˜¯ channel åœ¨ golang ä¸­çš„å†…éƒ¨å®ç°ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">qcount   <span class="keyword">uint</span>           <span class="comment">// buffer ä¸­å·²æ”¾å…¥çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">dataqsiz <span class="keyword">uint</span>           <span class="comment">// ç”¨æˆ·æ„é€  channel æ—¶æŒ‡å®šçš„ buf å¤§å°</span></span><br><span class="line">buf      unsafe.Pointer <span class="comment">// buffer</span></span><br><span class="line">elemsize <span class="keyword">uint16</span>         <span class="comment">// buffer ä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å°</span></span><br><span class="line">closed   <span class="keyword">uint32</span>         <span class="comment">// channel æ˜¯å¦å…³é—­ï¼Œ== 0 ä»£è¡¨æœª closed</span></span><br><span class="line">elemtype *_type         <span class="comment">// channel å…ƒç´ çš„ç±»å‹ä¿¡æ¯</span></span><br><span class="line">sendx    <span class="keyword">uint</span>           <span class="comment">// buffer ä¸­å·²å‘é€çš„ç´¢å¼•ä½ç½® send index</span></span><br><span class="line">recvx    <span class="keyword">uint</span>           <span class="comment">// buffer ä¸­å·²æ¥æ”¶çš„ç´¢å¼•ä½ç½® receive index</span></span><br><span class="line">recvq    waitq          <span class="comment">// ç­‰å¾…æ¥æ”¶çš„ goroutine  list of recv waiters</span></span><br><span class="line">sendq    waitq          <span class="comment">// ç­‰å¾…å‘é€çš„ goroutine list of send waiters</span></span><br><span class="line"></span><br><span class="line">lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>hchan ä¸­çš„æ‰€æœ‰å±æ€§å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li>buffer ç›¸å…³çš„å±æ€§ã€‚ä¾‹å¦‚ <code>buf</code>ã€<code>dataqsiz</code>ã€<code>qcount</code> ç­‰ã€‚ å½“ channel çš„ç¼“å†²åŒºå¤§å°ä¸ä¸º 0 æ—¶ï¼Œbuffer ä¸­å­˜æ”¾äº†å¾…æ¥æ”¶çš„æ•°æ®ã€‚ä½¿ç”¨ <code>ring buffer</code> å®ç°ã€‚</li><li>waitq ç›¸å…³çš„å±æ€§ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ª FIFO çš„æ ‡å‡†é˜Ÿåˆ—ã€‚å…¶ä¸­ <code>recvq</code> ä¸­æ˜¯æ­£åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutineï¼Œ<code>sendq</code> ä¸­æ˜¯ç­‰å¾…å‘é€æ•°æ®çš„ goroutineã€‚waitq ä½¿ç”¨<code>åŒå‘é“¾è¡¨</code>å®ç°ã€‚</li><li>å…¶ä»–å±æ€§ï¼Œä¾‹å¦‚ lockã€elemtypeã€closedã€‚</li></ul><p>é€šè¿‡ç®€å•åˆ†æ hchan çš„å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å…¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„ç»„ä»¶ï¼Œ<code>buffer</code> å’Œ <code>waitq</code>ã€‚hchan æ‰€æœ‰è¡Œä¸ºå’Œå®ç°éƒ½æ˜¯å›´ç»•è¿™ä¸¤ä¸ªç»„ä»¶è¿›è¡Œçš„ã€‚</p><h2 id="å‘-channel-ä¸­å‘é€æ•°æ®"><a href="#å‘-channel-ä¸­å‘é€æ•°æ®" class="headerlink" title="å‘ channel ä¸­å‘é€æ•°æ®"></a>å‘ channel ä¸­å‘é€æ•°æ®</h2><p>channel çš„å‘é€å’Œæ¥æ”¶æµç¨‹å¾ˆç›¸ä¼¼ï¼Œæˆ‘ä»¬å…ˆåˆ†æä¸‹ channel çš„å‘é€è¿‡ç¨‹ (å¦‚ <code>c &lt;- 1</code>), å¯¹åº”äº <code>runtime.chansend</code> å‡½æ•°çš„å®ç°ã€‚</p><p>åœ¨å°è¯•å‘ channel ä¸­å‘é€æ•°æ®æ—¶ï¼Œå¦‚æœ <code>recvq</code> é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™é¦–å…ˆä¼šä» <code>recvq</code> ä¸­å¤´éƒ¨å–å‡ºä¸€ä¸ªç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutine å‡ºæ¥ã€‚å¹¶å°†æ•°æ®ç›´æ¥å‘é€ç»™è¯¥ goroutineã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">unlock(&amp;c.lock)</span><br><span class="line"><span class="built_in">panic</span>(plainError(<span class="string">"send on closed channel"</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">send(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æˆ‘ä»¬çœ‹åˆ°å½“æˆ‘ä»¬æ•´ä¸ªsendçš„è¿‡ç¨‹æ˜¯éœ€è¦åŠ é”å¤„ç†çš„ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬è€ç”Ÿå¸¸è°ˆçš„ä¸€ä¸ªé—®é¢˜ï¼Œå½“å‘cloesdçš„channelæ•°æ®çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´panicäº§ç”Ÿ</p></blockquote><p>recvq ä¸­æ˜¯æ­£åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutineã€‚å½“æŸä¸ª goroutine ä½¿ç”¨ recv æ“ä½œ (ä¾‹å¦‚ï¼Œ<code>x := &lt;- c</code>)ï¼Œå¦‚æœæ­¤æ—¶ channel çš„ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œä¸”æ²¡æœ‰å…¶ä»– goroutine æ­£åœ¨ç­‰å¾…å‘é€æ•°æ® (å³ <code>sendq</code> ä¸ºç©º)ï¼Œä¼šå°†è¯¥ goroutine ä»¥åŠè¦æ¥æ”¶çš„æ•°æ®åœ°å€æ‰“åŒ…æˆ <code>sudog</code> å¯¹è±¡ï¼Œå¹¶æ”¾å…¥åˆ° recvq ä¸­ã€‚</p><p>ç»§ç»­æ¥ç€è®²ä¸Šé¢çš„ä»£ç ï¼Œå¦‚æœæ­¤æ—¶ <code>recvq</code> ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>send å‡½æ•°</code>å°†æ•°æ®æ‹·è´åˆ°å¯¹åº”çš„ goroutine çš„å †æ ˆä¸Šã€‚</p><p>è¿™ä¸ªæ—¶å€™<code>ä¸ç»è¿‡</code>æˆ‘ä»¬çš„<code>ç¯å½¢ç¼“å­˜ï¼ï¼ï¼</code></p><p>send å‡½æ•°çš„å®ç°ä¸»è¦åŒ…å«ä¸¤ç‚¹ï¼š</p><ol><li><code>memmove(dst, src, t.size)</code> è¿›è¡Œæ•°æ®çš„è½¬ç§»ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå†…å­˜æ‹·è´ã€‚</li><li><code>goready(gp, skip+1)</code> goready çš„ä½œç”¨æ˜¯å”¤é†’å¯¹åº”çš„ goroutineã€‚</li></ol><p>è€Œå¦‚æœ <code>recvq</code> é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¯´æ˜æ­¤æ—¶<code>æ²¡æœ‰ç­‰å¾…æ¥æ”¶</code>æ•°æ®çš„ goroutineï¼Œé‚£ä¹ˆæ­¤æ—¶ channel ä¼šå°è¯•æŠŠæ•°æ®æ”¾åˆ°ç¼“å­˜ä¸­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line"><span class="comment">// Space is available in the channel buffer. Enqueue the element to send.</span></span><br><span class="line">qp := chanbuf(c, c.sendx)</span><br><span class="line"><span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">racenotify(c, c.sendx, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line">typedmemmove(c.elemtype, qp, ep)</span><br><span class="line">c.sendx++</span><br><span class="line"><span class="keyword">if</span> c.sendx == c.dataqsiz &#123;</span><br><span class="line">c.sendx = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">c.qcount++</span><br><span class="line">unlock(&amp;c.lock)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç çš„ä½œç”¨å…¶å®éå¸¸ç®€å•ï¼Œå°±æ˜¯æŠŠæ•°æ®æ”¾åˆ° buffer ä¸­è€Œå·²ã€‚æ­¤è¿‡ç¨‹æ¶‰åŠäº† <code>ring buffer</code> çš„æ“ä½œï¼Œå…¶ä¸­ <code>dataqsiz</code> ä»£è¡¨ç”¨æˆ·æŒ‡å®šçš„ channel çš„ buffer å¤§å°ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™é»˜è®¤ä¸º 0ã€‚</p><p>å¦‚æœç”¨æˆ·ä½¿ç”¨çš„æ˜¯æ— ç¼“å†² channel æˆ–è€…æ­¤æ—¶ buffer å·²æ»¡ï¼Œåˆ™ <code>c.qcount &lt; c.dataqsiz</code> æ¡ä»¶ä¸ä¼šæ»¡è¶³, ä»¥ä¸Šæµç¨‹ä¹Ÿå¹¶ä¸ä¼šæ‰§è¡Œåˆ°ã€‚æ­¤æ—¶ä¼šå°†å½“å‰çš„ goroutine ä»¥åŠè¦å‘é€çš„æ•°æ®æ”¾å…¥åˆ° <code>sendq</code> é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶ä¼šåˆ‡å‡ºè¯¥ goroutine</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Block on the channel. Some receiver will complete our operation for us.</span></span><br><span class="line">gp := getg()</span><br><span class="line">mysg := acquireSudog()</span><br><span class="line">mysg.releasetime = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">mysg.releasetime = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// No stack splits between assigning elem and enqueuing mysg</span></span><br><span class="line"><span class="comment">// on gp.waiting where copystack can find it.</span></span><br><span class="line">mysg.elem = ep</span><br><span class="line">mysg.waitlink = <span class="literal">nil</span></span><br><span class="line">mysg.g = gp</span><br><span class="line">mysg.isSelect = <span class="literal">false</span></span><br><span class="line">mysg.c = c</span><br><span class="line">gp.waiting = mysg</span><br><span class="line">gp.param = <span class="literal">nil</span></span><br><span class="line">c.sendq.enqueue(mysg)</span><br><span class="line"><span class="comment">// Signal to anyone trying to shrink our stack that we're about</span></span><br><span class="line"><span class="comment">// to park on a channel. The window between when this G's status</span></span><br><span class="line"><span class="comment">// changes and when we set gp.activeStackChans is not safe for</span></span><br><span class="line"><span class="comment">// stack shrinking.</span></span><br><span class="line">atomic.Store8(&amp;gp.parkingOnChan, <span class="number">1</span>)</span><br><span class="line"><span class="comment">// å°† goroutine è½¬å…¥ waiting çŠ¶æ€</span></span><br><span class="line">gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, <span class="number">2</span>)</span><br><span class="line"><span class="comment">// Ensure the value being sent is kept alive until the</span></span><br><span class="line"><span class="comment">// receiver copies it out. The sudog has a pointer to the</span></span><br><span class="line"><span class="comment">// stack object, but sudogs aren't considered as roots of the</span></span><br><span class="line"><span class="comment">// stack tracer.</span></span><br><span class="line">KeepAlive(ep)</span><br><span class="line"><span class="comment">// ç¡®ä¿æ­£åœ¨å‘é€çš„å€¼ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æ¥æ”¶è€…å°†å…¶å¤åˆ¶å‡ºæ¥ã€‚sudogæœ‰ä¸€ä¸ªæŒ‡å‘å †æ ˆå¯¹è±¡çš„æŒ‡é’ˆï¼Œä½†æ˜¯sudogä¸è¢«è®¤ä¸ºæ˜¯å †æ ˆè·Ÿè¸ªç¨‹åºçš„æ ¹ã€‚</span></span><br><span class="line"><span class="comment">// æ€»è€Œè¨€ä¹‹ï¼šé˜²æ­¢è¢«GC</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨ gopark åï¼Œå¯¹äºç”¨æˆ·ä¾§æ¥çœ‹ï¼Œè¯¥å‘ channel å‘é€æ•°æ®çš„ä»£ç è¯­å¥ä¼šè¿›è¡Œé˜»å¡ã€‚</p><p>ä»¥ä¸Šè¿‡ç¨‹å°±æ˜¯ channel çš„å‘é€è¯­å¥ (å¦‚ï¼Œ<code>c &lt;- 1</code>) çš„å†…éƒ¨å·¥ä½œæµç¨‹ï¼ŒåŒæ—¶æ•´ä¸ªå‘é€è¿‡ç¨‹éƒ½ä½¿ç”¨ <code>c.lock</code> è¿›è¡ŒåŠ é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥ recvq æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä» recvq å¤´éƒ¨<code>å–ä¸€ä¸ª goroutine</code>ï¼Œå°†æ•°æ®å‘é€è¿‡å»ï¼Œå¹¶<code>å”¤é†’å¯¹åº”çš„ goroutine</code> å³å¯</li><li>å¦‚æœ recvq ä¸ºç©ºï¼Œåˆ™å°†æ•°æ®æ”¾å…¥åˆ° buffer ä¸­</li><li>å¦‚æœ buffer å·²æ»¡ï¼Œåˆ™å°†è¦å‘é€çš„æ•°æ®å’Œå½“å‰ goroutine æ‰“åŒ…æˆ <code>sudog</code> å¯¹è±¡æ”¾å…¥åˆ° <code>sendq</code> ä¸­ã€‚å¹¶å°†å½“å‰ goroutine ç½®ä¸º waiting çŠ¶æ€ã€‚</li></ol><p>ä» channel ä¸­æ¥æ”¶æ•°æ®çš„è¿‡ç¨‹åŸºæœ¬ä¸å‘é€è¿‡ç¨‹ç±»ä¼¼ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°äº†ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œchannel çš„<code>æ•´ä¸ªå‘é€è¿‡ç¨‹</code>å’Œ<code>æ¥æ”¶è¿‡ç¨‹</code>éƒ½ä½¿ç”¨ <code>runtime.mutex</code> è¿›è¡ŒåŠ é”ã€‚<code>runtime.mutex</code> æ˜¯ runtime ç›¸å…³æºç ä¸­å¸¸ç”¨åˆ°çš„ä¸€ä¸ª<code>è½»é‡çº§é”</code>ã€‚æ•´ä¸ªè¿‡ç¨‹å¹¶ä¸æ˜¯æœ€é«˜æ•ˆçš„ <code>lockfree</code> çš„åšæ³•ã€‚</p><p>golang åœ¨è¿™é‡Œæœ‰ä¸ª <a href="https://github.com/golang/go/issues/8899" target="_blank" rel="noopener">issue:go/issues#8899</a>ï¼Œç»™å‡ºäº† <code>lockfree</code> çš„ <code>channel</code> çš„æ–¹æ¡ˆã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;channel æ˜¯ Golang ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ &lt;code&gt;Golang CSP&lt;/code&gt; å¹¶å‘æ¨¡å‹çš„ä¸€ä¸ªé‡è¦ä½“ç°ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œgoroutine ä¹‹é—´å¯ä»¥é€šè¿‡ channel è¿›è¡Œé€šä¿¡ã€‚&lt;/p&gt;
&lt;p&gt;channel åœ¨ Golang å¦‚æ­¤é‡è¦ï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨é¢‘ç‡éå¸¸é«˜ï¼Œä»¥è‡³äºä¸å¾—ä¸å¥½å¥‡å…¶å†…éƒ¨å®ç°ã€‚æœ¬æ–‡å°†åŸºäº &lt;code&gt;go 1.17&lt;/code&gt; çš„æºç ï¼Œåˆ†æ channel çš„å†…éƒ¨å®ç°åŸç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Goæºç å‰–æç³»åˆ—" scheme="http://blog.crazylaw.cn/categories/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%B3%BB%E5%88%97/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
      <category term="Goæºç å‰–æ" scheme="http://blog.crazylaw.cn/tags/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- SyncåŒ…è¯¦è§£</title>
    <link href="http://blog.crazylaw.cn/2022/03/04/Golang/sync%E5%8C%85%E8%AF%A6%E8%A7%A3/"/>
    <id>http://blog.crazylaw.cn/2022/03/04/Golang/sync%E5%8C%85%E8%AF%A6%E8%A7%A3/</id>
    <published>2022-03-03T16:43:51.000Z</published>
    <updated>2022-03-03T17:21:03.468Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬ç›´åˆ°syncåŒ…ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—å¹¶å‘å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚ä¹‹å‰æœ‰è§è¿‡ä¸€æ¬¡sync-mapï¼Œä½†æ˜¯è¿™ä¸€æ¬¡åˆšå¥½å¤ä¹ æ•´ç†ä¸€ä¸‹syncåŒ…çš„çŸ¥è¯†ç‚¹ã€‚</p><a id="more"></a><h2 id="Sync"><a href="#Sync" class="headerlink" title="Sync"></a>Sync</h2><ul><li>Sync.Map</li><li>Sync.Once</li><li>Sync.Pool</li><li>Sync.Cond</li><li>Sync.WaitGroup</li></ul><h2 id="sync-Map"><a href="#sync-Map" class="headerlink" title="sync.Map"></a>sync.Map</h2><ul><li>sync.Mapä¸»è¦é’ˆå¯¹äºMapå¯¹äºå¹¶å‘è¯»å†™ä¸æ”¯æŒçš„åœºæ™¯ä¸‹æå‡ºå®ç°çš„ï¼Œå…¶åŸç†æ˜¯é€šè¿‡å¯¹mapçš„å†™æ“ä½œè¿›è¡ŒåŠ é”ï¼šSync.RWMutex</li><li>åŒæ—¶sync.Mapå®ç°äº†è¯»å†™åˆ†ç¦»ï¼Œå½“å¯¹mapè¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œé€šè¿‡è¯»read Map, å½“read Mapä¸­ä¸å­˜åœ¨æ˜¯å»dirty mapä¸­è¯»å–</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">me Mutex</span><br><span class="line">read atomic.Value  <span class="comment">// readOnly,è¯»æ•°æ®</span></span><br><span class="line">dirty <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry <span class="comment">// åŒ…å«æœ€æ–°çš„å†™å…¥æ•°æ®ï¼Œå½“missedè¾¾åˆ°ä¸€å®šçš„å€¼æ—¶ï¼Œå°†å€¼èµ‹ç»™read</span></span><br><span class="line">misses <span class="keyword">int</span>  <span class="comment">// è®¡æ•°ä½œç”¨ï¼Œæ¯æ¬¡ä»readä¸­è¯»å¤±è´¥ï¼Œåˆ™missedåŠ ä¸€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// readOnlyçš„æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="keyword">type</span> readOnly <span class="keyword">struct</span>&#123;</span><br><span class="line">m <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*entry</span><br><span class="line">amended <span class="keyword">bool</span>  <span class="comment">// Map.dirtyä¸­çš„æ•°æ®å’Œè¿™é‡Œçš„mä¸­çš„æ•°æ®ä¸åŒæ—¶å€¼ä¸ºtrue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// entryçš„æ•°æ®ç»“æ„ï¼š</span></span><br><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">p unsafe.Pointer <span class="comment">// *interface&#123;&#125;</span></span><br><span class="line"><span class="comment">// å¯è§valueæ˜¯ä¸€ä¸ªæŒ‡é’ˆå€¼ï¼Œè™½ç„¶readå’Œdirtyå­˜åœ¨å†—ä½™æƒ…å†µï¼Œä½†ç”±äºæ˜¯æŒ‡é’ˆç±»å‹ï¼Œå­˜å‚¨ç©ºé—´ä¸ä¼šå¤ªå¤š</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sync.Mapç›¸å…³é—®é¢˜</p><ul><li>sync.Mapçš„æ ¸å¿ƒå®ç°ï¼šä¸¤ä¸ªmap,ä¸€ä¸ªç”¨äºå†™ï¼Œä¸€ä¸ªç”¨äºè¯»ï¼Œè¿™æ ·çš„è®¾è®¡æ€æƒ³å¯ä»¥ç±»æ¯”äºç¼“å­˜ä¸æ•°æ®åº“</li><li>sync.Mapçš„å±€é™æ€§ï¼šå¦‚æœå†™è¿œé«˜äºè¯»ï¼Œdirty -&gt; readOnlyè¿™ä¸ªç±»ä¼¼äºåˆ·æ–°æ•°æ®çš„é¢‘ç‡è¾ƒé«˜ï¼Œä¸å¦‚ç›´æ¥ä½¿ç”¨mutex + mapçš„æ•ˆç‡é«˜</li><li>sync.Mapçš„è®¾è®¡æ€æƒ³ï¼šä¿è¯é«˜é¢‘ç‡è¯»çš„æ— é”ç»“æ„ï¼Œç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³</li></ul><h2 id="sync-WaitGroup"><a href="#sync-WaitGroup" class="headerlink" title="sync.WaitGroup"></a>sync.WaitGroup</h2><ul><li>sync.WaitGroupå¸¸ç”¨äºé’ˆå¯¹goroutineçš„å¹¶å‘æ‰§è¡Œï¼Œé€šè¿‡WaitGroupå¯ä»¥ç­‰å¾…æ‰€æœ‰çš„goç¨‹åºæ‰§è¡Œç»“æŸä¹‹åå†æ‰§è¡Œä¹‹åçš„é€»è¾‘</li><li>WaitGroupå¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæœ€åˆé‡0å¼€å§‹ï¼Œæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼šAdd(),Done(),Wait()ç”¨æ¥æ§åˆ¶è®¡æ•°å™¨çš„æ•°é‡ã€‚Add(n)æŠŠè®¡æ•°å™¨è®¾ç½®ä¸ºn,Done()æ¯æ¬¡æŠŠè®¡æ•°å™¨å‡ä¸€ï¼ŒWait()ä¼šé˜»å¡ä»£ç çš„æ‰§è¡Œï¼Œç›´åˆ°è®¡æ•°å™¨çš„å€¼å‡åˆ°0ä¸ºæ­¢ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬ç›´åˆ°syncåŒ…ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—å¹¶å‘å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚ä¹‹å‰æœ‰è§è¿‡ä¸€æ¬¡sync-mapï¼Œä½†æ˜¯è¿™ä¸€æ¬¡åˆšå¥½å¤ä¹ æ•´ç†ä¸€ä¸‹syncåŒ…çš„çŸ¥è¯†ç‚¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>ã€å¤§æ•°æ®ã€‘- åœ¨å…¬å¸ä»0åˆ°1è½åœ°flinkæµè®¡ç®—ä»»åŠ¡</title>
    <link href="http://blog.crazylaw.cn/2022/02/15/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%9C%A8%E5%85%AC%E5%8F%B8%E4%BB%8E0%E5%88%B01%E8%90%BD%E5%9C%B0flink%E6%B5%81%E8%AE%A1%E7%AE%97%E4%BB%BB%E5%8A%A1/"/>
    <id>http://blog.crazylaw.cn/2022/02/15/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%9C%A8%E5%85%AC%E5%8F%B8%E4%BB%8E0%E5%88%B01%E8%90%BD%E5%9C%B0flink%E6%B5%81%E8%AE%A1%E7%AE%97%E4%BB%BB%E5%8A%A1/</id>
    <published>2022-02-15T03:10:40.000Z</published>
    <updated>2022-02-17T01:14:41.637Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å…¬å¸è½åœ°ä¸€å¥—flinkï¼Œæ€»ç»“åˆ°ç›®å‰ä¸ºæ­¢åšäº†çš„äº‹æƒ…ã€‚</p><a id="more"></a><h2 id="å¼€å‘ç¯å¢ƒçš„éƒ¨ç½²"><a href="#å¼€å‘ç¯å¢ƒçš„éƒ¨ç½²" class="headerlink" title="å¼€å‘ç¯å¢ƒçš„éƒ¨ç½²"></a>å¼€å‘ç¯å¢ƒçš„éƒ¨ç½²</h2><p>æˆ‘ä»¬é»˜è®¤åœºæ™¯ä¸‹ï¼Œ<code>flink</code>ä½¿ç”¨<code>hive-catalog</code>ï¼Œæ‰€ä»¥<code>hive</code>å®‰è£…åœ¨è¿™é‡Œã€‚</p><p>Hiveä½¿ç”¨<code>mysql</code>ä½œä¸º<code>å¤–éƒ¨æ•°æ®å­˜å‚¨</code>ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨<code>mysql</code></p><p>å¯¹äºflinkçš„å¼€å‘ï¼Œå¦‚æœæˆ‘æƒ³è¦ä¸€æ•´å¥—çš„æœ¬åœ°çš„dockerå¼€å‘ç¯å¢ƒã€‚</p><p>éœ€è¦é›†æˆå¦‚ä¸‹æœåŠ¡ï¼š</p><ul><li>hadoop</li><li>hive</li><li>flink</li><li>kafka</li><li>mysql</li></ul><p>æ‰€ä»¥åšäº†ä¸€ä¸ª<a href="https://github.com/whiteCcinn/flink-docker-compose" target="_blank" rel="noopener">flink-docker-compose</a></p><p>åœ¨è¯¥é¡¹ç›®ä¸­ï¼Œç”±äºä¸æ˜¯é‡‡ç”¨<code>CDH</code>æ¥é›†æˆçš„ï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸ªæºç åŒ…æ‰‹åŠ¨å®‰è£…çš„ã€‚æ‰€ä»¥éœ€è¦ä¸‹è½½æºç åŒ…ã€‚</p><p>ç›®å‰çš„ç‰ˆæœ¬ä¸ºï¼š</p><ul><li>flink: 1.12.0_2.11</li><li>mysql: 5.6 ï¼ˆ8.0-jdbcï¼‰</li><li>kafka: 2.12_2.11</li><li>maven: 3.6.3</li><li>jdk: 8/11 (é»˜è®¤jdk8)</li></ul><blockquote><p>æœ¬åœ°ç¯å¢ƒçš„è¯ï¼Œjdkéœ€è¦è‡ªè¡Œå¤„ç†å¥½</p></blockquote><ul><li>hadoop: 3.1.1</li><li>hive: 3.1.0</li></ul><h3 id="ä¸€é”®ä¸‹è½½æºç åŒ…"><a href="#ä¸€é”®ä¸‹è½½æºç åŒ…" class="headerlink" title="ä¸€é”®ä¸‹è½½æºç åŒ…"></a>ä¸€é”®ä¸‹è½½æºç åŒ…</h3><p>ä¸ºäº†æ–¹ä¾¿æ–¹ä¾¿å¤§å®¶ä¸‹è½½ï¼Œå¯¹åº”çš„é•œåƒé“¾æ¥ï¼Œä¹Ÿéƒ½é›†æˆåœ¨äº†<code>download.sh</code>ä¸­ï¼Œå¦‚æœéœ€è¦åˆ©ç”¨<code>è¿…é›·</code>ç­‰p2påŠ é€Ÿä¸‹è½½è½¯ä»¶ï¼Œå¯ä»¥é€šè¿‡ä»ä¸­æå–å‡ºæ¥ <code>url</code> è¿›è¡Œä¸‹è½½ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./download.sh all</span><br></pre></td></tr></table></figure><h3 id="å¯è®¾ç½®çš„-env"><a href="#å¯è®¾ç½®çš„-env" class="headerlink" title="å¯è®¾ç½®çš„.env"></a>å¯è®¾ç½®çš„<code>.env</code></h3><p>åˆ©ç”¨<code>docker-compose</code>å¯¹ <code>.env</code>çš„æ”¯æŒï¼Œå¯ä»¥åœ¨å½“ä¸­è®¾ç½®<code>build image</code>çš„ä¸€äº›ç¯å¢ƒå˜é‡å’Œå‚æ•°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Hadoop</span></span><br><span class="line">HADOOP_VERSION=3.1.1</span><br><span class="line"><span class="meta">#</span><span class="bash"> Hive</span></span><br><span class="line">HIVE_VERSION=3.1.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> Scala</span></span><br><span class="line">SCALA_VERSION=2.11</span><br><span class="line"><span class="meta">#</span><span class="bash"> Flink</span></span><br><span class="line">FLINK_VERSION=1.12.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> Kafka</span></span><br><span class="line">KAFKA_VERSION=2.4.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> Zookeeper</span></span><br><span class="line">ZOOKEEPER_VERSION=3.5.6</span><br><span class="line"><span class="meta">#</span><span class="bash"> Mysql</span></span><br><span class="line">MYSQL_VERSION=5.6</span><br><span class="line">MYSQL_DATABASE=default</span><br><span class="line">MYSQL_PORT=3306</span><br><span class="line">MYSQL_ROOT_PASSWORD=lnhzjm/B4qrSc</span><br><span class="line">MYSQL_ENTRYPOINT_INITDB=./deploy/mysql/docker-entrypoint-initdb.d</span><br><span class="line">MYSQL_TIMEZONE=UTC</span><br></pre></td></tr></table></figure><h3 id="kafkaçš„ç½‘ç»œ"><a href="#kafkaçš„ç½‘ç»œ" class="headerlink" title="kafkaçš„ç½‘ç»œ"></a>kafkaçš„ç½‘ç»œ</h3><p>æˆ‘ä»¬çŸ¥é“kafkaçš„ç½‘ç»œåè®®æ˜¯<code>æ”¯æŒå¤šç«¯å£</code>çš„ï¼Œç”±äºæˆ‘ä»¬æœ‰æ—¶å€™flinkæ˜¯åœ¨æœ¬åœ°ï¼Œæœ‰æ—¶å€™æ˜¯åœ¨å®¹å™¨ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„kafkaé›†ç¾¤ï¼Œæ”¯æŒå®¹å™¨å†…çš„ç½‘ç»œï¼Œä¹Ÿæ”¯æŒå’Œæˆ‘ä»¬ç‰©ç†æœºçš„ç½‘ç»œã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®kafkaçš„2å¥—ç«¯å£åè®®ã€‚æ‰€ä»¥ä½ å¯ä»¥çœ‹åˆ°</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kafka1:</span></span><br><span class="line">   <span class="attr">build:</span></span><br><span class="line">     <span class="attr">context:</span> <span class="string">./deploy/kafka</span></span><br><span class="line">     <span class="attr">args:</span></span><br><span class="line">       <span class="attr">scala_version:</span> <span class="string">$&#123;SCALA_VERSION&#125;</span></span><br><span class="line">       <span class="attr">kafka_version:</span> <span class="string">$&#123;KAFKA_VERSION&#125;</span></span><br><span class="line">   <span class="attr">container_name:</span> <span class="string">flink-kafka1</span></span><br><span class="line">   <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">'19092:19092'</span></span><br><span class="line">   <span class="attr">environment:</span></span><br><span class="line">     <span class="attr">KAFKA_PORT:</span> <span class="number">19092</span></span><br><span class="line">     <span class="attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="string">PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://kafka1:19092</span></span><br><span class="line">     <span class="attr">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP:</span> <span class="string">PLAINTEXT:PLAINTEXT,EXTERNAL_PLAINTEXT:PLAINTEXT</span></span><br><span class="line">     <span class="attr">KAFKA_LISTENERS:</span> <span class="string">PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://:19092</span></span><br><span class="line">     <span class="attr">KAFKA_ZOOKEEPER_CONNECT:</span> <span class="string">zookeeper:2181</span></span><br><span class="line">     <span class="attr">KAFKA_DEFAULT_REPLICATION_FACTOR:</span> <span class="number">3</span></span><br><span class="line">   <span class="attr">networks:</span></span><br><span class="line">     <span class="attr">flink-networks:</span></span><br><span class="line">       <span class="attr">ipv4_address:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.211</span></span><br><span class="line">   <span class="attr">extra_hosts:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">'zookeeper:192.168.6.215'</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">'kafka1:192.168.6.211'</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">'kafka2:192.168.6.212'</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">'kafka3:192.168.6.213'</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">'kafka4:192.168.6.214'</span></span><br><span class="line">   <span class="attr">depends_on:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">zookeeper</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œçš„</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">KAFKA_ADVERTISED_LISTENERS:</span> <span class="string">PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://kafka1:19092</span></span><br><span class="line"><span class="attr">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP:</span> <span class="string">PLAINTEXT:PLAINTEXT,EXTERNAL_PLAINTEXT:PLAINTEXT</span></span><br><span class="line"><span class="attr">KAFKA_LISTENERS:</span> <span class="string">PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://:19092</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ˜¯å†³å®šæˆ‘ä»¬çš„<code>2å¥—åè®®</code>çš„å…³é”®æ‰€åœ¨ï¼Œåˆ†åˆ«æ˜¯å¯¹<code>9092ï¼ˆå®¹å™¨å†…ï¼‰</code>å’Œ<code>19092(å’Œç‰©ç†æœº)</code>ç«¯å£çš„æ”¯æŒã€‚</p><p>ä½†æ˜¯è®¾ç½®å®Œäº†è¿™ä¸ªï¼Œç”±äºä¸€èˆ¬kafka-clientä¼šä»å¯æœ¬æœºçš„å¯è®¿é—®çš„<code>dnsæœåŠ¡å™¨</code>ä¸Šå¯»æ‰¾<code>hostæ˜ å°„</code>ï¼Œåœ¨è¿æ¥çš„æ—¶å€™å¿…å¤‡çš„æµç¨‹ã€‚</p><p>åœ¨æœ¬åœ°è¿æ¥çš„æ—¶å€™ï¼Œä¼šé€šè¿‡<code>kafka1/kafka2</code>ç­‰hostnameè¿”å›åˆ°clientï¼Œclientéœ€è¦åœ¨æœ¬æœºæ‰¾åˆ°æ‰€æœ‰çš„ipæ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸‹<code>etc/hosts</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "127.0.0.1 kafka1 kafka2 kafka3 kafka4" &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure><p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ‰€éœ€è¦çš„ç¯å¢ƒå˜é‡å·²ç»å¤„ç†å®Œäº†ã€‚</p><h2 id="åŸºäºdatastream-apiçš„flinkå¼€å‘"><a href="#åŸºäºdatastream-apiçš„flinkå¼€å‘" class="headerlink" title="åŸºäºdatastream-apiçš„flinkå¼€å‘"></a>åŸºäºdatastream-apiçš„flinkå¼€å‘</h2><p>æˆ‘ä»¬çŸ¥é“flinkæä¾›äº†3ç§APIï¼Œåˆ†åˆ«æ˜¯<code>datastream-api</code>,<code>table-api</code>,<code>sql-api</code></p><p><code>datastream</code>ï¼Œä¹Ÿæ˜¯flinkçš„æœ€åŸå§‹çš„apiï¼Œå’Œflinké›†æˆä¸€ä½“ï¼Œé€šè¿‡<code>datastream-api</code>ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å„ç§çµæ´»çš„æ•°æ®æµå¤„ç†ã€‚</p><p>æŒ‰ç…§æˆ‘ä»¬ä»¥å¾€å¯¹æµè®¡ç®—æ•°æ®çš„å¤„ç†ï¼Œåœ¨æ¸¸æˆå…¬å¸ä¸­ï¼Œä¸€ä¸ªæ¸¸æˆé¡¹ç›®éƒ¨ç½²ä¸€ä¸ªæµè®¡ç®—çš„ä»»åŠ¡å³ä¸ºåˆç†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ pom.xml</span><br><span class="line">â””â”€â”€ src</span><br><span class="line">    â””â”€â”€ main</span><br><span class="line">        â”œâ”€â”€ java</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ deps</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”œâ”€â”€ oaYdSdk</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Youdu.java</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ test</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ YouduTest.java</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ util</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”œâ”€â”€ ParameterToolEnvironmentUtils.java</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â””â”€â”€ Util.java</span><br><span class="line">        â”‚Â Â  â””â”€â”€ org</span><br><span class="line">        â”‚Â Â      â””â”€â”€ cp</span><br><span class="line">        â”‚Â Â          â””â”€â”€ flink</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ Bootstrap.java</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ async</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â””â”€â”€ AsyncOaYdHttpClient.java</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ events</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ CommonEvent.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ CommonEventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ app_error</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ log_ban</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ log_client_loss</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ log_consume_gold</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ log_fcm_error</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ log_index_record</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ log_index_record_data</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ log_role_create</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â””â”€â”€ t_log_market</span><br><span class="line">        â”‚Â Â              â”‚Â Â      â”œâ”€â”€ Event.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â      â”œâ”€â”€ EventHeader.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â      â””â”€â”€ EventLog.java</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ jobs</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ alarm</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ErrorReport_10008.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Job_10002.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Job_10008.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Job_19.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ README.md</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ handler</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ AbstractHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ errorReport_10008</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Logic.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Logic_10012.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ Logic_19.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ Logic_20.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ job_10002</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ LogIndexRecordDataHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ LogIndexRecordHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ model</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â      â”œâ”€â”€ log_index_record</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â      â”‚Â Â  â””â”€â”€ StatisticsMcfx2Model.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â      â””â”€â”€ log_index_record_data</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â          â””â”€â”€ StatisticsMcfx1Model.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ job_10008</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ AppErrorHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ LogFcmErrorHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ model</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â      â”œâ”€â”€ app_error</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â      â”‚Â Â  â””â”€â”€ StatisticsAppErrorModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â      â””â”€â”€ log_fcm_error</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â          â””â”€â”€ StatisticsFcmErrorModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â      â””â”€â”€ job_19</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ LogBanHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ LogClientLossHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ LogConsumeGoldHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ LogRoleCreateHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ TLogMarketHandler.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â          â””â”€â”€ model</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_ban</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ StatisticsModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_client_loss</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ IpMonitorModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_consume_gold</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ StatisticsBindGoldModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ StatisticsUnBindGoldModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_role_create</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ SingleServerRoleCreateModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â              â””â”€â”€ t_log_market</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â                  â”œâ”€â”€ MarketTransactionLogByBuyerModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”‚Â Â                  â””â”€â”€ MarketTransactionLogBySellerModel.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â””â”€â”€ stream</span><br><span class="line">        â”‚Â Â              â”‚Â Â      â””â”€â”€ README.md</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ mock</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ MockAppError.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ MockLogFcmError.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â””â”€â”€ README.md</span><br><span class="line">        â”‚Â Â              â”œâ”€â”€ serializer</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â”œâ”€â”€ AbstractSerializer.java</span><br><span class="line">        â”‚Â Â              â”‚Â Â  â””â”€â”€ log_role_create</span><br><span class="line">        â”‚Â Â              â”‚Â Â      â””â”€â”€ LogRoleCreateDeSerializer.java</span><br><span class="line">        â”‚Â Â              â””â”€â”€ sinks</span><br><span class="line">        â”‚Â Â                  â”œâ”€â”€ AsyncOaYdSdkHttpSink.java</span><br><span class="line">        â”‚Â Â                  â”œâ”€â”€ MysqlItem.java</span><br><span class="line">        â”‚Â Â                  â””â”€â”€ MysqlSink.java</span><br><span class="line">        â””â”€â”€ resources</span><br><span class="line">            â”œâ”€â”€ application-dev.properties</span><br><span class="line">            â”œâ”€â”€ application-local.properties</span><br><span class="line">            â”œâ”€â”€ application-pro.properties</span><br><span class="line">            â”œâ”€â”€ application.properties</span><br><span class="line">            â”œâ”€â”€ jobs</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ org.cp.flink.jobs.alarm.ErrorReport_10008</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-dev.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-local.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-pro.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â””â”€â”€ application.properties</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ org.cp.flink.jobs.alarm.Job_10002</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-dev.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-local.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-pro.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â””â”€â”€ application.properties</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ org.cp.flink.jobs.alarm.Job_10008</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-dev.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-local.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â”œâ”€â”€ application-pro.properties</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â””â”€â”€ application.properties</span><br><span class="line">            â”‚Â Â  â””â”€â”€ org.cp.flink.jobs.alarm.Job_19</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ application-dev.properties</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ application-local.properties</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ application-pro.properties</span><br><span class="line">            â”‚Â Â      â””â”€â”€ application.properties</span><br><span class="line">            â””â”€â”€ log4j2.properties</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æˆ‘ä»¬æ—©æœŸçš„ä¸€ä¸ª<code>ä»£ç å±‚çº§ç»“æ„</code>ï¼Œæ‰€æœ‰çš„æµè®¡ç®—ä»»åŠ¡åŸºäºä¸€ä¸ªflinké¡¹ç›®ä¸‹ï¼Œ<code>resources</code>ä¸‹çš„é…ç½®æ ¹æ®å½“å‰éœ€è¦æäº¤çš„é¡¹ç›®å’Œç¯å¢ƒæ¥è¿›è¡ŒåŒºåˆ†åŠ è½½å…·ä½“çš„é…ç½®ï¼Œå¯ä»¥åšåˆ°æ”¯æŒ<code>å¤šç¯å¢ƒ</code>,<code>å¤šé¡¹ç›®</code>ä¸‹é…ç½®çµæ´»é…ç½®ã€‚</p><p>æˆ‘ä»¬çœ‹åˆ° <code>org.cp.flink</code>ç›®ä¸‹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„æ‰€æœ‰flinkä»£ç ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">âœ  flinkjob git:(master) âœ— tree -d src/main/java/org</span><br><span class="line">src/main/java/org</span><br><span class="line">â””â”€â”€ cp</span><br><span class="line">    â””â”€â”€ flink</span><br><span class="line">        â”œâ”€â”€ async</span><br><span class="line">        â”œâ”€â”€ events</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ app_error</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ log_ban</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ log_client_loss</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ log_consume_gold</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ log_fcm_error</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ log_index_record</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ log_index_record_data</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ log_role_create</span><br><span class="line">        â”‚Â Â  â””â”€â”€ t_log_market</span><br><span class="line">        â”œâ”€â”€ jobs</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ alarm</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ handler</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”œâ”€â”€ job_10002</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ model</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â      â”œâ”€â”€ log_index_record</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â      â””â”€â”€ log_index_record_data</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”œâ”€â”€ job_10008</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ model</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â      â”œâ”€â”€ app_error</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â      â””â”€â”€ log_fcm_error</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â””â”€â”€ job_19</span><br><span class="line">        â”‚Â Â  â”‚Â Â          â””â”€â”€ model</span><br><span class="line">        â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_ban</span><br><span class="line">        â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_client_loss</span><br><span class="line">        â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_consume_gold</span><br><span class="line">        â”‚Â Â  â”‚Â Â              â”œâ”€â”€ log_role_create</span><br><span class="line">        â”‚Â Â  â”‚Â Â              â””â”€â”€ t_log_market</span><br><span class="line">        â”‚Â Â  â””â”€â”€ stream</span><br><span class="line">        â”œâ”€â”€ mock</span><br><span class="line">        â”œâ”€â”€ serializer</span><br><span class="line">        â”‚Â Â  â””â”€â”€ log_role_create</span><br><span class="line">        â””â”€â”€ sinks</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆçœ‹åˆ°ï¼Œ<code>jobs</code>ç›®å½•ä¸‹çš„ï¼Œåˆ†ä¸ºäº†2ç§ç±»å‹ï¼Œæˆ‘ä»¬å¹³æ—¶ç”¨çš„æµè®¡ç®—ä»»åŠ¡å¯ä»¥åˆ†ä¸º2ç§ï¼Œä¸€ç§æ˜¯å¸¸è§„çš„<code>å‘Šè­¦å±æ€§</code>ï¼Œå¦ä¸€ç§æ˜¯<code>äº§å“å±æ€§(ç±»ä¼¼BIç³»ç»Ÿéœ€è¦çš„å®æ—¶æ•°æ®)</code>ã€‚</p><p>æˆ‘ä»¬çœ‹åˆ°<code>alarm/handler/job_xxx</code>å°±æ˜¯æˆ‘ä»¬å…·ä½“çš„é¡¹ç›®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">src/main/java/org/cp/flink/jobs/alarm/</span></span><br><span class="line"><span class="string">â”œâ”€â”€</span> <span class="string">Job_10002.java</span></span><br><span class="line"><span class="string">â”œâ”€â”€</span> <span class="string">Job_10008.java</span></span><br><span class="line"><span class="string">â”œâ”€â”€</span> <span class="string">Job_19.java</span></span><br><span class="line"><span class="string">â”œâ”€â”€</span> <span class="string">README.md</span></span><br><span class="line"><span class="string">â””â”€â”€</span> <span class="string">handler</span></span><br><span class="line">    <span class="string">â”œâ”€â”€</span> <span class="string">AbstractHandler.java</span></span><br><span class="line">    <span class="string">â”œâ”€â”€</span> <span class="string">errorReport_10008</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">Logic.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">Logic_10012.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">Logic_19.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">Logic_20.java</span></span><br><span class="line">    <span class="string">â”œâ”€â”€</span> <span class="string">job_10002</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">LogIndexRecordDataHandler.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">LogIndexRecordHandler.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">model</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â      <span class="string">â”œâ”€â”€</span> <span class="string">log_index_record</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â      <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">StatisticsMcfx2Model.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â      <span class="string">â””â”€â”€</span> <span class="string">log_index_record_data</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â          <span class="string">â””â”€â”€</span> <span class="string">StatisticsMcfx1Model.java</span></span><br><span class="line">    <span class="string">â”œâ”€â”€</span> <span class="string">job_10008</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">AppErrorHandler.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">LogFcmErrorHandler.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">model</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â      <span class="string">â”œâ”€â”€</span> <span class="string">app_error</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â      <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">StatisticsAppErrorModel.java</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â      <span class="string">â””â”€â”€</span> <span class="string">log_fcm_error</span></span><br><span class="line">    <span class="string">â”‚</span>Â Â          <span class="string">â””â”€â”€</span> <span class="string">StatisticsFcmErrorModel.java</span></span><br><span class="line">    <span class="string">â””â”€â”€</span> <span class="string">job_19</span></span><br><span class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">LogBanHandler.java</span></span><br><span class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">LogClientLossHandler.java</span></span><br><span class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">LogConsumeGoldHandler.java</span></span><br><span class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">LogRoleCreateHandler.java</span></span><br><span class="line">        <span class="string">â”œâ”€â”€</span> <span class="string">TLogMarketHandler.java</span></span><br><span class="line">        <span class="string">â””â”€â”€</span> <span class="string">model</span></span><br><span class="line">            <span class="string">â”œâ”€â”€</span> <span class="string">log_ban</span></span><br><span class="line">            <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">StatisticsModel.java</span></span><br><span class="line">            <span class="string">â”œâ”€â”€</span> <span class="string">log_client_loss</span></span><br><span class="line">            <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">IpMonitorModel.java</span></span><br><span class="line">            <span class="string">â”œâ”€â”€</span> <span class="string">log_consume_gold</span></span><br><span class="line">            <span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">StatisticsBindGoldModel.java</span></span><br><span class="line">            <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">StatisticsUnBindGoldModel.java</span></span><br><span class="line">            <span class="string">â”œâ”€â”€</span> <span class="string">log_role_create</span></span><br><span class="line">            <span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">SingleServerRoleCreateModel.java</span></span><br><span class="line">            <span class="string">â””â”€â”€</span> <span class="string">t_log_market</span></span><br><span class="line">                <span class="string">â”œâ”€â”€</span> <span class="string">MarketTransactionLogByBuyerModel.java</span></span><br><span class="line">                <span class="string">â””â”€â”€</span> <span class="string">MarketTransactionLogBySellerModel.java</span></span><br></pre></td></tr></table></figure><p>å¯¹äºå„ä¸ªé¡¹ç›®çš„<code>é”™è¯¯å‘Šè­¦ç›‘æ§</code>ï¼Œè¿™é‡Œåˆ†ä¸ºäº†å¤šä¸ª<code>job</code>ã€‚</p><ul><li>Job_10002.java</li><li>Job_10008.java</li><li>Job_19.java</li></ul><p>æˆ‘ä»¬ä»å…¥å£å¼€å§‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.cp.flink.jobs.alarm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> deps.util.Util;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.SimpleStringSchema;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.ProcessFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.OutputTag;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.Bootstrap;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.jobs.alarm.handler.job_10008.AppErrorHandler;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.jobs.alarm.handler.job_10008.LogFcmErrorHandler;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.events.CommonEvent;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.events.app_error.Event;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Job_10008</span> <span class="keyword">extends</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(Job_10008<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> StreamExecutionEnvironment env = getStreamExecutionEnvironment(args, Job_10008<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        env.enableCheckpointing(<span class="number">5000</span>); <span class="comment">// checkpoint every 5000 msecs</span></span><br><span class="line"></span><br><span class="line">        ParameterTool parameterTool = (ParameterTool) env.getConfig().getGlobalJobParameters();</span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.setProperty(<span class="string">"bootstrap.servers"</span>, parameterTool.get(<span class="string">"kafka.source.bootstrap.servers"</span>));</span><br><span class="line">        props.setProperty(<span class="string">"group.id"</span>, parameterTool.get(<span class="string">"kafka.source.group"</span>));</span><br><span class="line">        props.put(<span class="string">"enable.auto.commit"</span>, parameterTool.get(<span class="string">"kafka.source.enable.auto.commit"</span>));</span><br><span class="line">        props.put(<span class="string">"auto.commit.interval.ms"</span>, parameterTool.get(<span class="string">"kafka.source.auto.commit.interval.ms"</span>));</span><br><span class="line">        props.put(<span class="string">"session.timeout.ms"</span>, parameterTool.get(<span class="string">"kafka.source.session.timeout.ms"</span>));</span><br><span class="line">        props.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        props.put(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®kafkaå¹¶è¡Œåº¦</span></span><br><span class="line">        env.setParallelism(parameterTool.getInt(<span class="string">"kafka.source.parallelism"</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        DataStream&lt;String&gt; stream = env</span><br><span class="line">                .addSource(<span class="keyword">new</span> FlinkKafkaConsumer&lt;&gt;(Arrays.asList(parameterTool.get(<span class="string">"kafka.source.topic"</span>).split(<span class="string">","</span>)), <span class="keyword">new</span> SimpleStringSchema(), props));</span><br><span class="line"></span><br><span class="line">        env.setParallelism(parameterTool.getInt(<span class="string">"app.parallelism"</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;CommonEvent&gt; s0 = stream.filter((String json) -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                JSONObject.parseObject(json, CommonEvent<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                logger.error(json);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;).map(</span><br><span class="line">                (String json) -&gt; JSONObject.parseObject(json, CommonEvent<span class="class">.<span class="keyword">class</span>).<span class="title">setOriginJson</span>(<span class="title">json</span>)</span></span><br><span class="line"><span class="class">        ).<span class="title">returns</span>(<span class="title">CommonEvent</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> OutputTag&lt;CommonEvent&gt; outputTagAppError = <span class="keyword">new</span> OutputTag&lt;CommonEvent&gt;(AppErrorHandler<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()) </span>&#123;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">final</span> OutputTag&lt;CommonEvent&gt; outputTagLogFcmError = <span class="keyword">new</span> OutputTag&lt;CommonEvent&gt;(LogFcmErrorHandler<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()) </span>&#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. ä¸»æµä¸éœ€è¦äº†, æ‰€ä»¥ä¸éœ€è¦è°ƒç”¨collector.collect()</span></span><br><span class="line">        <span class="comment">// 2. åªè¦æ—è·¯è¾“å‡ºæµï¼Œå› ä¸ºè¦åŒºåˆ†æ•°æ®è¿›è¡Œå¤„ç†</span></span><br><span class="line">        <span class="comment">// åˆ©ç”¨low-level-apiçš„processç®—å­å¤„ç†æ—è·¯è¾“å‡ºé‡‡é›†æ•°æ®</span></span><br><span class="line">        SingleOutputStreamOperator&lt;CommonEvent&gt; s1 = s0.process(<span class="keyword">new</span> ProcessFunction&lt;CommonEvent, CommonEvent&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(CommonEvent event, Context context, Collector&lt;CommonEvent&gt; collector)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span> (event.getHeaders().getLogName()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">"app_error"</span>:</span><br><span class="line">                        context.output(outputTagAppError, event);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">"log_fcm_error"</span>:</span><br><span class="line">                        context.output(outputTagLogFcmError, event);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;CommonEvent&gt; AppErrorSource = s1.getSideOutput(outputTagAppError);</span><br><span class="line">        DataStream&lt;CommonEvent&gt; LogFcmErrorSource = s1.getSideOutput(outputTagLogFcmError);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Event&gt; AppErrorSource_s0 = AppErrorSource.map((CommonEvent event) -&gt; JSONObject.parseObject(event.getOriginJson(), Event<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        ).<span class="title">returns</span>(<span class="title">Event</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        DataStream&lt;org.cp.flink.events.log_fcm_error.Event&gt; LogFcmErrorSource_s0 = LogFcmErrorSource.map((CommonEvent event) -&gt; JSONObject.parseObject(event.getOriginJson(), org.cp.flink.events.log_fcm_error.Event<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">        ).<span class="title">returns</span>(<span class="title">org</span>.<span class="title">cp</span>.<span class="title">flink</span>.<span class="title">events</span>.<span class="title">log_fcm_error</span>.<span class="title">Event</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        AppErrorHandler.build().handle(AppErrorSource_s0);</span><br><span class="line">        LogFcmErrorHandler.build().handle(LogFcmErrorSource_s0);</span><br><span class="line"></span><br><span class="line">        env.execute(Util.getCurrentJobName(((ParameterTool) env.getConfig().getGlobalJobParameters())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬ä¸€ä¸ªtopicåªèƒ½å¤Ÿå¯èƒ½å­˜åœ¨å¤šç§æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨äº†<code>æ—è·¯ç”±</code>è¿›è¡Œäº†åˆ†æµã€‚æŠŠæ•°æ®æµåˆ†å‘åˆ°ä¸åŒçš„<code>å­æµ</code>ä¸­ï¼Œæˆ‘ä»¬å†æŠŠ<code>å­æµ</code>ä¼ é€’ä¸åŒçš„<code>Handler</code>è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™é‡Œä¾‹å¦‚: <code>AppErrorHandler</code>ã€‚æˆ‘ä»¬ä»¥æ­¤ä¸ºä¾‹å­è¿›è¡Œè¯´æ˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.cp.flink.jobs.alarm.handler.job_10008;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.ProcessFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.OutputTag;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.jobs.alarm.handler.AbstractHandler;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.jobs.alarm.handler.job_10008.model.app_error.StatisticsAppErrorModel;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.events.app_error.Event;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppErrorHandler</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span>&lt;<span class="title">Event</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AppErrorHandler instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppErrorHandler <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> AppErrorHandler();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(DataStream&lt;Event&gt; s0)</span> </span>&#123;</span><br><span class="line">        ParameterTool parameterTool = <span class="keyword">this</span>.getParameterTool(s0);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ©ç”¨æ—è·¯è¾“å‡ºå¤šæµåˆ°å¯¹åº”åˆ°model</span></span><br><span class="line">        <span class="comment">// StatisticsAppErrorModel</span></span><br><span class="line">        <span class="keyword">final</span> OutputTag&lt;Event&gt; outputTagStatisticsAppError = <span class="keyword">new</span> OutputTag&lt;Event&gt;(StatisticsAppErrorModel<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()) </span>&#123;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;Event&gt; s1 = s0.process(<span class="keyword">new</span> ProcessFunction&lt;Event, Event&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processElement</span><span class="params">(Event event, Context context, Collector&lt;Event&gt; collector)</span> </span>&#123;</span><br><span class="line">                context.output(outputTagStatisticsAppError, event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        DataStream&lt;Event&gt; sideOutputStreamAppError = s1.getSideOutput(outputTagStatisticsAppError);</span><br><span class="line"></span><br><span class="line">        StatisticsAppErrorModel.build().handle(sideOutputStreamAppError);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parameterTool.getBoolean(<span class="string">"app.handler.print.console"</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            s0.print(AppErrorHandler<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºï¼Œæˆ‘ä»¬å¸Œæœ›åˆ°ä¸€æ¡æ•°æ®ä»<code>kafka</code>è¢«<code>pull</code>ä¸‹æ¥åˆ°æ—¶å€™ï¼Œå¯ä»¥ç”¨äºå¤šä¸ªä¸åŒçš„<code>æµè®¡ç®—æ¨¡å‹model</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦<code>copy</code>åˆ°å¤šä¸ª<code>æ—è·¯è¾“å‡º</code>ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ª<code>stream-model</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±åªç”¨ä¸€ä¸ªæ¥å¤„ç†å³å¯ï¼Œä»æ—è·¯è¾“å‡ºæ‹¿åˆ°<code>datastream</code>ä¹‹åï¼Œåœ¨å¯¹åº”çš„æ¨¡å‹ä¸­è¿›è¡Œ<code>æ ¸å¿ƒé€»è¾‘</code>å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.cp.flink.jobs.alarm.handler.job_10008.model.app_error;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> deps.util.Util;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.functions.KeySelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple3;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple5;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.WindowedStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.windowing.WindowFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.TimeWindow;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.runtime.operators.util.AssignerWithPeriodicWatermarksAdapter;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.jobs.alarm.handler.AbstractHandler;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.events.app_error.Event;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.jobs.alarm.handler.job_19.model.log_ban.StatisticsModel;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.sinks.MysqlItem;</span><br><span class="line"><span class="keyword">import</span> org.cp.flink.sinks.MysqlSink;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é”™è¯¯æ—¥å¿—ç»Ÿè®¡</span></span><br><span class="line"><span class="comment"> * çª—å£ï¼šæ»šåŠ¨äº‹ä»¶çª—å£ï¼Œæ¯1åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatisticsAppErrorModel</span> <span class="keyword">extends</span> <span class="title">AbstractHandler</span>&lt;<span class="title">Event</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SINK_DATABASE = <span class="string">"db_app_log_alarm"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SINK_TABLE = <span class="string">"t_log_app_error_alarm_164"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(StatisticsAppErrorModel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StatisticsAppErrorModel instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StatisticsAppErrorModel <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> StatisticsAppErrorModel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(DataStream&lt;Event&gt; s0)</span> </span>&#123;</span><br><span class="line">        s0.getExecutionConfig().setAutoWatermarkInterval(<span class="number">5000L</span>);</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">"getAutoWatermarkInterval: &#123;&#125;"</span>, s0.getExecutionConfig().getAutoWatermarkInterval());</span><br><span class="line">        ParameterTool parameterTool = <span class="keyword">this</span>.getParameterTool(s0);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;Event&gt; s1 = s0.assignTimestampsAndWatermarks(<span class="keyword">new</span> AssignerWithPeriodicWatermarksAdapter.Strategy&lt;&gt;(</span><br><span class="line">                        <span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;Event&gt;(Time.of(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">                                Long ts = event.getLogs().getMtime() * <span class="number">1000L</span>;</span><br><span class="line">                                logger.debug(</span><br><span class="line">                                        <span class="string">"thread-id: &#123;&#125;, eventTime: [&#123;&#125;|&#123;&#125;], watermark: [&#123;&#125;|&#123;&#125;]"</span>,</span><br><span class="line">                                        Thread.currentThread().getId(),</span><br><span class="line">                                        ts,</span><br><span class="line">                                        sdf.format(ts),</span><br><span class="line">                                        <span class="keyword">this</span>.getCurrentWatermark().getTimestamp(),</span><br><span class="line">                                        sdf.format(<span class="keyword">this</span>.getCurrentWatermark().getTimestamp())</span><br><span class="line">                                );</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">return</span> ts;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                )</span><br><span class="line">                        <span class="comment">// å°½å¯èƒ½å’Œçª—å£å¤§å°ä¿æŒä¸€è‡´ï¼Œæ‰€ä»¥å¦‚æœå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œåº¦å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹</span></span><br><span class="line">                        <span class="comment">// æœ€å¤§çš„å»¶è¿Ÿè®¡ç®—ç»“æœæ˜¯ä¸€ä¸ªçª—å£å¤§å°çš„æ—¶é—´</span></span><br><span class="line">                        .withIdleness(Duration.ofMinutes(<span class="number">1L</span>))</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        WindowedStream&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt; s2 = s1.keyBy(<span class="keyword">new</span> KeySelector&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple5&lt;Integer, String, String, Integer, String&gt; <span class="title">getKey</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Tuple5.of(</span><br><span class="line">                        event.getLogs().getRelatedAppId(),</span><br><span class="line">                        event.getLogs().getChildApp(),</span><br><span class="line">                        event.getLogs().getSummary(),</span><br><span class="line">                        event.getLogs().getLevel(),</span><br><span class="line">                        event.getLogs().getIp()</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">                .window(TumblingEventTimeWindows.of(Time.minutes(<span class="number">1L</span>)));</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; s3 = s2.apply(<span class="keyword">new</span> WindowFunction&lt;Event, Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Tuple5&lt;Integer, String, String, Integer, String&gt; key, TimeWindow timeWindow, Iterable&lt;Event&gt; iterable, Collector&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; collector)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (Event event : iterable) &#123;</span><br><span class="line">                    sum++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                logger.debug(<span class="string">"èšåˆçª—å£key: &#123;&#125;, çª—å£ä¸­çš„æ•°é‡:&#123;&#125;, æ­¤æ—¶çš„çª—å£èŒƒå›´æ˜¯[&#123;&#125;,&#123;&#125;)"</span>, key, sum, sdf.format(timeWindow.getStart()), sdf.format(timeWindow.getEnd()));</span><br><span class="line">                collector.collect(Tuple3.of(key, iterable.iterator().next(), sum));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        String sinkDatabase = parameterTool.get(StatisticsModel.class.getName() + ".sink_database", DEFAULT_SINK_DATABASE);</span><br><span class="line">        String sinkTable = parameterTool.get(StatisticsModel.class.getName() + ".sink_table", DEFAULT_SINK_TABLE);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;MysqlItem&gt; s4 = s3.map(e -&gt; &#123;</span><br><span class="line">                    HashMap&lt;String, Object&gt; kv = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                    kv.put(<span class="string">"related_app_id"</span>, e.f1.getLogs().getRelatedAppId());</span><br><span class="line">                    kv.put(<span class="string">"child_app"</span>, e.f1.getLogs().getChildApp());</span><br><span class="line">                    kv.put(<span class="string">"summary"</span>, e.f1.getLogs().getSummary());</span><br><span class="line">                    kv.put(<span class="string">"level"</span>, e.f1.getLogs().getLevel());</span><br><span class="line">                    kv.put(<span class="string">"ip"</span>, e.f1.getLogs().getIp());</span><br><span class="line"></span><br><span class="line">                    kv.put(<span class="string">"mtime"</span>, e.f1.getLogs().getMtime());</span><br><span class="line">                    kv.put(<span class="string">"mdate"</span>, Util.timeStamp2Date(Integer.toString(e.f1.getLogs().getMtime()), <span class="string">"yyyy-MM-dd"</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ¥è‡ªèšåˆçª—å£ç»Ÿè®¡çš„ç»“æœ</span></span><br><span class="line">                    kv.put(<span class="string">"cnt"</span>, e.f2);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> MysqlItem.builder()</span><br><span class="line">                            .database(sinkDatabase)</span><br><span class="line">                            .table(sinkTable)</span><br><span class="line">                            .kv(kv)</span><br><span class="line">                            .build();</span><br><span class="line">                &#125;</span><br><span class="line">        ).returns(MysqlItem<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        s4.addSink(<span class="keyword">new</span> MysqlSink(parameterTool))</span><br><span class="line">                .setParallelism(parameterTool.getInt(<span class="string">"mysql.sink.parallelism"</span>, <span class="number">1</span>))</span><br><span class="line">                .name(<span class="string">"MysqlSink"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parameterTool.getBoolean(<span class="string">"app.handler.print.console"</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            s0.print(StatisticsAppErrorModel<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ•´ä½“ä¸­ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆçœ‹åˆ°è®¾ç½®<code>watermark</code>çš„é€»è¾‘ï¼Œè¿™ä¸ª<code>watermark</code>å†³å®šäº†æˆ‘ä»¬çš„flinkçš„æ•°æ®çš„æœ‰åºæ€§ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// æ¯5s-flinkéœ€è¦è·å–æ–°çš„watermark</span></span><br><span class="line">s0.getExecutionConfig().setAutoWatermarkInterval(<span class="number">5000L</span>);</span><br><span class="line"></span><br><span class="line">logger.debug(<span class="string">"getAutoWatermarkInterval: &#123;&#125;"</span>, s0.getExecutionConfig().getAutoWatermarkInterval());</span><br><span class="line">ParameterTool parameterTool = <span class="keyword">this</span>.getParameterTool(s0);</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Event&gt; s1 = s0.assignTimestampsAndWatermarks(<span class="keyword">new</span> AssignerWithPeriodicWatermarksAdapter.Strategy&lt;&gt;(</span><br><span class="line"><span class="keyword">new</span> BoundedOutOfOrdernessTimestampExtractor&lt;Event&gt;(Time.of(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">extractTimestamp</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">Long ts = event.getLogs().getMtime() * <span class="number">1000L</span>;</span><br><span class="line">logger.debug(</span><br><span class="line"><span class="string">"thread-id: &#123;&#125;, eventTime: [&#123;&#125;|&#123;&#125;], watermark: [&#123;&#125;|&#123;&#125;]"</span>,</span><br><span class="line">Thread.currentThread().getId(),</span><br><span class="line">ts,</span><br><span class="line">sdf.format(ts),</span><br><span class="line"><span class="keyword">this</span>.getCurrentWatermark().getTimestamp(),</span><br><span class="line">sdf.format(<span class="keyword">this</span>.getCurrentWatermark().getTimestamp())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ts;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line"><span class="comment">// å°½å¯èƒ½å’Œçª—å£å¤§å°ä¿æŒä¸€è‡´ï¼Œæ‰€ä»¥å¦‚æœå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œåº¦å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹</span></span><br><span class="line"><span class="comment">// æœ€å¤§çš„å»¶è¿Ÿè®¡ç®—ç»“æœæ˜¯ä¸€ä¸ªçª—å£å¤§å°çš„æ—¶é—´</span></span><br><span class="line">.withIdleness(Duration.ofMinutes(<span class="number">1L</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™é‡Œé€šè¿‡<code>AssignerWithPeriodicWatermarksAdapter</code>è®¾ç½®ä¸€ä¸ª<code>watermark</code>ç”Ÿæˆçš„ç­–ç•¥ã€‚</p><p>å½“æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œå…è®¸<code>1ç§’å»¶è¿Ÿ</code>çš„æƒ…å†µä¸‹ï¼Œè§£ææ•°æ®çš„<code>äº‹ä»¶æ—¶é—´(event-time)</code>ä½œä¸ºæˆ‘ä»¬çš„<code>watermark</code>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä»event-timeæå–çš„æ—¶é—´çš„å•ä½éœ€è¦æ˜¯<code>æ¯«ç§’</code>çº§åˆ«ã€‚</p><p>å†é€šè¿‡<code>.withIdleness</code>ï¼Œè¿›è¡Œå½“æŸä¸ªçª—å£ä¸‹<code>idle</code>äº†ï¼Œé‚£ä¹ˆä¹Ÿä¼šåˆ·æ–°<code>watermark</code>ã€‚è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œåœ¨kafkaä¸­æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„é€»è¾‘ï¼Œç”±äºflinkåœ¨kafkaçš„topicåœ¨å¤špartitionä¸‹ï¼Œåœ¨partitionçš„æ•°æ®<code>watermark</code>å¯¹é½çš„æƒ…å†µï¼Œæ‰ä¼šè¿›è¡Œï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢ï¼Œç”±äºé˜²æ­¢kafkaçš„partitionçš„æ•°æ®å€¾æ–œå¯¹æˆ‘ä»¬é€ æˆä¸šåŠ¡é€»è¾‘ä¸€ç›´æ— æ³•æ›´æ–°watermarkçš„é—®é¢˜ã€‚è¿™ä¸ªååˆ†å¿…è¦ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WindowedStream&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt; s2 = s1.keyBy(<span class="keyword">new</span> KeySelector&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;&gt;() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Tuple5&lt;Integer, String, String, Integer, String&gt; <span class="title">getKey</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Tuple5.of(</span><br><span class="line">event.getLogs().getRelatedAppId(),</span><br><span class="line">event.getLogs().getChildApp(),</span><br><span class="line">event.getLogs().getSummary(),</span><br><span class="line">event.getLogs().getLevel(),</span><br><span class="line">event.getLogs().getIp()</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">.window(TumblingEventTimeWindows.of(Time.minutes(<span class="number">1L</span>)));</span><br></pre></td></tr></table></figure><p>å¯¹äº<code>windowstream</code>ï¼Œä¸»è¦æ˜¯å®šä¹‰<code>çª—å£çš„æ—¶é—´å¤§å°</code>ï¼Œ <code>çª—å£æ•°æ®çš„å”¯ä¸€ä¸»é”®</code>ã€‚</p><p>åœ¨è¿™é‡Œï¼Œç”±äºæˆ‘çš„éœ€æ±‚æ˜¯æ¯1åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘çš„çª—å£æ˜¯åŸºäº<code>EventTimeï¼ˆäº‹ä»¶æ—¶é—´ï¼‰</code>çš„çª—å£ï¼Œå¹¶ä¸”å¤§å°èŒƒå›´ä¸º<code>1åˆ†é’Ÿ</code>ã€‚è€Œæ•°æ®çš„å”¯ä¸€ä¸»é”®åˆ™æ˜¯é€šè¿‡<code>getKet(Event event)</code>æ–¹æ³•æ¥å¤„ç†ã€‚é€šè¿‡flinkå†…ç½®çš„ä¾¿æ·çš„<code>Tuple5</code>è¿™ä¸ªç±»æ¥å¤„ç†çš„åŸå› æ˜¯å› ä¸ºæˆ‘è¿™é‡Œæœ‰5ä¸ªå…ƒç´ ç»„æˆçš„keyã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SingleOutputStreamOperator&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; s3 = s2.apply(<span class="keyword">new</span> WindowFunction&lt;Event, Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(Tuple5&lt;Integer, String, String, Integer, String&gt; key, TimeWindow timeWindow, Iterable&lt;Event&gt; iterable, Collector&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; collector)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (Event event : iterable) &#123;</span><br><span class="line">                    sum++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                logger.debug(<span class="string">"èšåˆçª—å£key: &#123;&#125;, çª—å£ä¸­çš„æ•°é‡:&#123;&#125;, æ­¤æ—¶çš„çª—å£èŒƒå›´æ˜¯[&#123;&#125;,&#123;&#125;)"</span>, key, sum, sdf.format(timeWindow.getStart()), sdf.format(timeWindow.getEnd()));</span><br><span class="line">                collector.collect(Tuple3.of(key, iterable.iterator().next(), sum));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯<code>èšåˆ(ç»Ÿè®¡)</code>çš„é€»è¾‘äº†ï¼Œå½“<code>window-trigger-condition</code>æ»¡è¶³æ¡ä»¶ä¹‹åï¼Œå°±ä¼šæŠŠå½“å‰çª—å£å†…çš„æ‰€æœ‰æ•°æ®æ¨åˆ°ä¸‹ä¸€ä¸ª<code>ç®—å­</code>ï¼Œåœ¨è¿™ä¸ª<code>ç®—å­</code>çš„<code>apply()</code>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªæ˜¯ç®€å•çš„åšäº†ä¸€ä¸ªæ•°æ®ç»Ÿè®¡ï¼Œä¹Ÿå°±æ˜¯<code>sum++</code>ï¼Œç»è¿‡è¿™ä¸€æ“ä½œä¹‹åï¼Œç»è¿‡<code>collector</code>å¯¹è¿›è¡Œè¿›è¡Œ<code>æ”¶é›†</code>ï¼Œå‡†å¤‡ç”¨äºä¸‹ä¸€ä¸ª<code>ç®—å­</code>ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">SingleOutputStreamOperator&lt;MysqlItem&gt; s4 = s3.map(e -&gt; &#123;</span><br><span class="line">                    HashMap&lt;String, Object&gt; kv = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                    kv.put(<span class="string">"related_app_id"</span>, e.f1.getLogs().getRelatedAppId());</span><br><span class="line">                    kv.put(<span class="string">"child_app"</span>, e.f1.getLogs().getChildApp());</span><br><span class="line">                    kv.put(<span class="string">"summary"</span>, e.f1.getLogs().getSummary());</span><br><span class="line">                    kv.put(<span class="string">"level"</span>, e.f1.getLogs().getLevel());</span><br><span class="line">                    kv.put(<span class="string">"ip"</span>, e.f1.getLogs().getIp());</span><br><span class="line"></span><br><span class="line">                    kv.put(<span class="string">"mtime"</span>, e.f1.getLogs().getMtime());</span><br><span class="line">                    kv.put(<span class="string">"mdate"</span>, Util.timeStamp2Date(Integer.toString(e.f1.getLogs().getMtime()), <span class="string">"yyyy-MM-dd"</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// æ¥è‡ªèšåˆçª—å£ç»Ÿè®¡çš„ç»“æœ</span></span><br><span class="line">                    kv.put(<span class="string">"cnt"</span>, e.f2);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> MysqlItem.builder()</span><br><span class="line">                            .database(sinkDatabase)</span><br><span class="line">                            .table(sinkTable)</span><br><span class="line">                            .kv(kv)</span><br><span class="line">                            .build();</span><br><span class="line">                &#125;</span><br><span class="line">        ).returns(MysqlItem<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">s4.addSink(<span class="keyword">new</span> MysqlSink(parameterTool))</span><br><span class="line">.setParallelism(parameterTool.getInt(<span class="string">"mysql.sink.parallelism"</span>, <span class="number">1</span>))</span><br><span class="line">.name(<span class="string">"MysqlSink"</span>);</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‰é¢åˆ°ç®—å­ä¸­ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†ä¸€äº›æˆ‘ä»¬æ‰€æœŸå¾…åˆ°æ•°æ®äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠæ•°æ®è½¬æ¢æˆä¸ºæˆ‘ä»¬éœ€è¦å…¥åº“çš„ä¸€ä¸ªç»“æ„ã€‚é€šè¿‡<code>MysqlItem</code>å¯¹è±¡ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„ç»“æ„åŒ–çš„å¯¹è±¡é€šè¿‡<code>MysqlSink</code>æ–¹æ³•è¿›è¡Œå‘é€ç»™mysqlã€‚<code>mysqlsink</code>æ˜¯æˆ‘ä»¬è‡ªå·±å°çš„ä¸€ä¸ª<code>sinker</code>ï¼Œå…¶ä¸­çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.cp.flink.sinks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Setter;</span><br><span class="line"><span class="keyword">import</span> lombok.experimental.Accessors;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.utils.ParameterTool;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.sink.RichSinkFunction;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Accessors</span>(chain = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlSink</span> <span class="keyword">extends</span> <span class="title">RichSinkFunction</span>&lt;<span class="title">MysqlItem</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MysqlSink<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    ParameterTool parameterTool;</span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MysqlSink</span><span class="params">(ParameterTool parameterTool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.parameterTool = parameterTool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.open(parameters);</span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">            connection = <span class="keyword">this</span>.getConnection();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.close();</span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">            connection.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * todo: å†è€ƒè™‘ä¸€ä¸‹å¦‚æœæ’å…¥å¤±è´¥çš„è¯æ˜¯å¦éœ€è¦é‡è¯•ä¹‹ç±»çš„</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(MysqlItem item, Context context)</span> </span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"mysql-item: &#123;&#125;"</span>, item);</span><br><span class="line">        MysqlItem.Sql sqlInfo = item.toInsertIgnoreSql();</span><br><span class="line">        String sql = sqlInfo.getPreSql();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PreparedStatement ps = <span class="keyword">this</span>.connection.prepareStatement(sql);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= sqlInfo.getValues().size(); i++) &#123;</span><br><span class="line">                ps.setObject(i, sqlInfo.getValues().get(i-<span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            logger.debug(ps.toString());</span><br><span class="line">            ps.execute();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            logger.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException </span>&#123;</span><br><span class="line">        Class.forName(<span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DriverManager.getConnection(</span><br><span class="line">                String.format(</span><br><span class="line">                        <span class="string">"jdbc:mysql://%s:%s/?useUnicode=true&amp;characterEncoding=%s&amp;useSSL=false&amp;autoReconnect=true"</span>,</span><br><span class="line">                        <span class="keyword">this</span>.parameterTool.get(<span class="string">"mysql.sink.host"</span>),</span><br><span class="line">                        <span class="keyword">this</span>.parameterTool.get(<span class="string">"mysql.sink.port"</span>),</span><br><span class="line">                        <span class="keyword">this</span>.parameterTool.get(<span class="string">"mysql.sink.characterEncoding"</span>, StandardCharsets.UTF_8.toString())</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">this</span>.parameterTool.get(<span class="string">"mysql.sink.user"</span>),</span><br><span class="line">                <span class="keyword">this</span>.parameterTool.get(<span class="string">"mysql.sink.password"</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ï¼Œä¸€ä¸ªåŸºäº<code>datastream-api</code>çš„jobï¼Œå°±å®Œæˆäº†ã€‚</p><p>ä½†æ˜¯ç”±äºè¿™æ˜¯<code>javaæŠ€æœ¯æ ˆ</code>ï¼Œå¯¹äºä¸æ˜¯<code>javaæŠ€æœ¯æ ˆ</code>çš„å›¢é˜Ÿè€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä»¶æ¯”è¾ƒéº»çƒ¦çš„äº‹æƒ…ã€‚å°±ç®—æ˜¯<code>javaæŠ€æœ¯æ ˆ</code>ï¼Œä¹Ÿéœ€è¦å»å±äºäº†è§£flinkçš„åŸç†ï¼Œç„¶åå»ç¼–å†™å¯¹åº”çš„flinkä»£ç ï¼Œè¿™å¯¹äºä¸ç†Ÿæ‚‰<code>datastream-api</code>çš„å°ä¼™ä¼´æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ç§å¤´ç—›çš„äº‹æƒ…ã€‚</p><p>æ‰€ä»¥å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ä¸Šå±‚ä¸€äº›çš„apiï¼Œä¹Ÿå°±æ˜¯<code>table-api</code>å’Œ<code>sql-api</code>ã€‚</p><p>ä½†æ˜¯ç”±äºæ­¤ç±»apiè¿˜æ˜¯éœ€è¦ç†Ÿæ‚‰apiçš„ç»†èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°äº†flinkæä¾›äº†ä¸€ä¸ªå«<code>sql-client</code>çš„ä¸œè¥¿ã€‚ä½†æ˜¯ç”±äº<code>sql-client</code>çš„ä¸ç¨³å®šæ€§ï¼ˆæŸäº›ç‰ˆæœ¬ä¸‹å­˜åœ¨æ¯”è¾ƒä¸¥é‡çš„bugï¼‰ï¼Œä¸”æŸäº›éœ€æ±‚æ— æ³•æ»¡è¶³æˆ‘ä»¬ï¼Œä¸ºäº†çµæ´»å’Œå¯æ§æ€§ï¼Œæˆ‘ä»¬æœ€ç»ˆè§£å†³äº†è‡ªè¡Œå¼€å‘<code>flink-sql-client</code>ã€‚</p><h2 id="åŸºäºè‡ªç ”sql-clientçš„flinkå¼€å‘"><a href="#åŸºäºè‡ªç ”sql-clientçš„flinkå¼€å‘" class="headerlink" title="åŸºäºè‡ªç ”sql-clientçš„flinkå¼€å‘"></a>åŸºäºè‡ªç ”<code>sql-client</code>çš„flinkå¼€å‘</h2><p>å…·ä½“çš„å®ç°æ–¹å¼åœ¨ <a href="https://github.com/whiteCcinn/flink-sql-submit" target="_blank" rel="noopener">flink-sql-submit</a></p><p>å®ç°åŸç†å…¶å®ä¹Ÿä¸å¤æ‚ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ä¸€ä¸ªflinké¡¹ç›®ï¼Œå°è£…æˆä¸ºä¸€ä¸ªç±»ä¼¼cmdçš„å‘½ä»¤ï¼Œç„¶åé€šè¿‡æ­¤æ–¹å¼æ¥æäº¤æˆ‘ä»¬çš„<code>sqlæˆ–è€…sqlæ–‡ä»¶</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">src/main/java/</span><br><span class="line">â”œâ”€â”€ deps</span><br><span class="line">â”‚Â Â  â””â”€â”€ util</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ ParameterToolEnvironmentUtils.java</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ SqlCommandParser.java</span><br><span class="line">â”‚Â Â      â””â”€â”€ Util.java</span><br><span class="line">â””â”€â”€ org</span><br><span class="line">    â””â”€â”€ client</span><br><span class="line">        â””â”€â”€ flink</span><br><span class="line">            â”œâ”€â”€ Bootstrap.java</span><br><span class="line">            â”œâ”€â”€ SqlSubmit.java</span><br><span class="line">            â”œâ”€â”€ cmds</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ AbstractCommand.java</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ HelpCommand.java</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ HiveCatalogCommand.java</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ ICommand.java</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ JobCommand.java</span><br><span class="line">            â”‚Â Â  â””â”€â”€ SqlParserCommand.java</span><br><span class="line">            â”œâ”€â”€ enums</span><br><span class="line">            â”‚Â Â  â””â”€â”€ PlanType.java</span><br><span class="line">            â”œâ”€â”€ internals</span><br><span class="line">            â””â”€â”€ udfs</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªé¡¹ç›®åªæœ‰å°‘é‡æ–‡ä»¶ã€‚æä¾›äº†å‡ ä¸ªå‘½ä»¤ï¼š</p><ul><li>help å¸®åŠ©å‘½ä»¤</li><li>hivecatalog ç®¡ç†<ul><li>å¢</li><li>åˆ </li><li>æŸ¥</li></ul></li><li>job æäº¤ä»»åŠ¡<ul><li>sql</li><li>sql-file</li></ul></li><li>sql-parser è°ƒè¯•è§£æsql</li></ul><p>æˆ‘ä»¬ä»¥ä¸€ä¸ª<code>sql-file</code>ä¸ºä¾‹å­ï¼Œå…¶ä»–å¤§å®¶å¯ä»¥åœ¨githubä¸ŠæŸ¥çœ‹æºç ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä»¥":"ä¸ºåˆ†éš”ç¬¦ï¼Œåˆ†åˆ«ä»£è¡¨ï¼šcatalog_type, hive_conf_path, catalog_name</span></span><br><span class="line"><span class="comment">-- "-" ä»£è¡¨ä½¿ç”¨é»˜è®¤å€¼</span></span><br><span class="line">CATALOG_INFO = hive:/opt/hadoopclient/Hive/config/:-;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> mstream_alarm <span class="keyword">COMMENT</span> <span class="string">'å‘Šè­¦ç³»ç»Ÿæµè®¡ç®—'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> mstream_alarm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="string">'pipeline.name'</span> = <span class="string">'æ¯1åˆ†é’ŸåŸºç¡€æœåŠ¡å‘Šè­¦'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'table.exec.emit.early-fire.enabled'</span> = <span class="string">'true'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'table.exec.emit.early-fire.delay'</span> = <span class="string">'10s'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'mc.local.time.zone'</span> = <span class="string">'Asia/Shanghai'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'table.exec.sink.not-null-enforcer'</span> = <span class="string">'drop'</span>;</span><br><span class="line"><span class="comment">-- checkpointé…ç½®</span></span><br><span class="line"><span class="keyword">SET</span> <span class="string">'execution.checkpointing.mode'</span> = <span class="string">'EXACTLY_ONCE'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'execution.checkpointing.interval'</span> = <span class="string">'2min'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'execution.checkpointing.timeout'</span> = <span class="string">'1min'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'execution.checkpointing.prefer-checkpoint-for-recovery'</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'execution.checkpointing.externalized-checkpoint-retention'</span> = <span class="string">'RETAIN_ON_CANCELLATION'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'mc.state.backend.fs.checkpointdir'</span> = <span class="string">'hdfs:///flink/checkpoints/&#123;db&#125;/&#123;pipeline.name&#125;'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'mc.execution.savepoint.dir'</span> = <span class="string">'hdfs:///flink/savepoints/&#123;db&#125;/&#123;pipeline.name&#125;'</span>;</span><br><span class="line"><span class="comment">-- é‡å¯ç­–ç•¥</span></span><br><span class="line"><span class="keyword">SET</span> <span class="string">'restart-strategy'</span> = <span class="string">'failure-rate'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'restart-strategy.failure-rate.delay'</span> = <span class="string">'10s'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'restart-strategy.failure-rate.failure-rate-interval'</span> = <span class="string">'5min'</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="string">'restart-strategy.failure-rate.max-failures-per-interval'</span> = <span class="string">'10'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> app_error_To_t_log_app_error_alarm_164 (</span><br><span class="line">    headers <span class="keyword">ROW</span>&lt;<span class="string">`app_id`</span> <span class="built_in">int</span>,<span class="string">`log_name`</span> <span class="keyword">string</span>&gt;,</span><br><span class="line">    <span class="keyword">logs</span> <span class="keyword">ROW</span>&lt;<span class="string">`related_app_id`</span> <span class="built_in">int</span>, <span class="string">`child_app`</span> <span class="built_in">varchar</span>(<span class="number">200</span>), <span class="string">`summary`</span> <span class="keyword">string</span>,<span class="string">`level`</span> <span class="built_in">int</span>,<span class="string">`ip`</span> <span class="built_in">varchar</span>(<span class="number">200</span>),<span class="string">`detail`</span> <span class="built_in">varchar</span>(<span class="number">100</span>), <span class="string">`mtime`</span> <span class="built_in">int</span>&gt;,</span><br><span class="line">    etime <span class="keyword">as</span> TO_TIMESTAMP(FROM_UNIXTIME(logs.<span class="string">`mtime`</span>)),</span><br><span class="line">    WATERMARK <span class="keyword">for</span> etime <span class="keyword">AS</span> etime <span class="comment">-- defines watermark on ts column, marks ts as event-time attribute</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'mfeilog_dsp_10008_app_error'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'127.0.0.1:9092'</span>,</span><br><span class="line">    <span class="string">'properties.group.id'</span> = <span class="string">'app_error_to_t_log_app_error_alarm_164'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'json'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'latest-offset'</span>,</span><br><span class="line">    <span class="string">'json.fail-on-missing-field'</span> = <span class="string">'false'</span>,</span><br><span class="line">    <span class="string">'json.ignore-parse-errors'</span> = <span class="string">'false'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_log_app_error_alarm_164`</span> (</span><br><span class="line">  <span class="string">`related_app_id`</span> <span class="built_in">int</span>,</span><br><span class="line">  <span class="string">`child_app`</span> <span class="built_in">varchar</span>(<span class="number">200</span>),</span><br><span class="line">  <span class="string">`summary`</span> <span class="keyword">string</span>,</span><br><span class="line">  <span class="string">`level`</span> <span class="built_in">int</span>,</span><br><span class="line">  <span class="string">`ip`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) ,</span><br><span class="line">  <span class="string">`cnt`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">COMMENT</span> <span class="string">'calculate the detail of count()'</span>,</span><br><span class="line">  <span class="string">`mdate`</span> <span class="keyword">string</span>,</span><br><span class="line">  <span class="string">`mtime`</span> <span class="built_in">int</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`related_app_id`</span>,<span class="string">`child_app`</span>,<span class="string">`summary`</span>,<span class="string">`level`</span>,<span class="string">`ip`</span>) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">   <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">   <span class="string">'url'</span> = <span class="string">'jdbc:mysql://127.0.0.1:60701/db_app_log_alarm?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true'</span>,</span><br><span class="line">   <span class="string">'driver'</span> = <span class="string">'com.mysql.cj.jdbc.Driver'</span>,</span><br><span class="line">   <span class="string">'table-name'</span> = <span class="string">'t_log_app_error_alarm_164'</span>,</span><br><span class="line">   <span class="string">'username'</span> = <span class="string">'flink_mstream_alarm'</span>,</span><br><span class="line">   <span class="string">'password'</span> = <span class="string">'xxxx'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_log_app_error_alarm_164 (</span><br><span class="line">    <span class="keyword">select</span> t1.<span class="string">`related_app_id`</span>,t1.<span class="string">`child_app`</span>,t1.<span class="string">`summary`</span>,t1.<span class="string">`level`</span>,t1.<span class="string">`ip`</span>,<span class="keyword">cast</span>(t1.<span class="string">`cnt`</span> <span class="keyword">as</span> <span class="built_in">VARCHAR</span>(<span class="number">200</span>)) <span class="keyword">as</span> <span class="string">`cnt`</span>,t1.<span class="string">`mdate`</span>,<span class="keyword">cast</span> (t1.<span class="string">`mtime`</span> <span class="keyword">as</span> <span class="built_in">INT</span>)  <span class="keyword">from</span> (</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            logs.<span class="string">`related_app_id`</span> <span class="keyword">as</span> <span class="string">`related_app_id`</span>,</span><br><span class="line">            logs.<span class="string">`child_app`</span> <span class="keyword">as</span> <span class="string">`child_app`</span>,</span><br><span class="line">            logs.<span class="string">`summary`</span> <span class="keyword">as</span> <span class="string">`summary`</span>,</span><br><span class="line">            logs.<span class="string">`level`</span> <span class="keyword">as</span> <span class="string">`level`</span>,</span><br><span class="line">            logs.<span class="string">`ip`</span> <span class="keyword">as</span> <span class="string">`ip`</span>,</span><br><span class="line">            <span class="keyword">DATE_FORMAT</span>(TUMBLE_START(etime, <span class="built_in">INTERVAL</span> <span class="string">'1'</span> <span class="keyword">MINUTE</span>), <span class="string">'yyyy-MM-dd'</span>) <span class="keyword">as</span> <span class="string">`mdate`</span>,</span><br><span class="line">            <span class="keyword">UNIX_TIMESTAMP</span>(<span class="keyword">DATE_FORMAT</span>(TUMBLE_START(etime, <span class="built_in">INTERVAL</span> <span class="string">'1'</span> <span class="keyword">MINUTE</span>), <span class="string">'yyyy-MM-dd HH:mm:ss'</span>)) <span class="keyword">as</span> <span class="string">`mtime`</span>,</span><br><span class="line">            <span class="keyword">COUNT</span>(logs.<span class="string">`detail`</span>) <span class="keyword">as</span> <span class="string">`cnt`</span></span><br><span class="line">        <span class="keyword">FROM</span> app_error_To_t_log_app_error_alarm_164</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> logs.<span class="string">`related_app_id`</span>, logs.<span class="string">`child_app`</span>,logs.<span class="string">`summary`</span>,logs.<span class="string">`level`</span>,logs.<span class="string">`ip`</span>,TUMBLE(etime, <span class="built_in">INTERVAL</span> <span class="string">'1'</span> <span class="keyword">MINUTE</span>)</span><br><span class="line">    ) t1</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ª<code>sql-file</code>ï¼Œæ”¯æŒäº†ä¸€äº›<code>å…³é”®å­—</code>ï¼Œè¿™äº›å…³é”®å­—è¢«å¼€å‘åœ¨<code>client</code>å½“ä¸­äº†ï¼Œæ‰€ä»¥å¯ä»¥è¢«æ­£å¸¸è§£æåˆ°ã€‚</p><p>é€šè¿‡è§£æåˆ°å…³é”®å­—ï¼Œå†è°ƒç”¨å¯¹åº”çš„APIï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¾ç½®å¯¹åº”çš„è¡Œä¸ºäº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä»ç¹æ‚çš„<code>datastreamapi</code>ä¸­ï¼Œå·²ç»æŠŠå‰¥ç¦»äº†å‡ºæ¥ï¼Œé€šè¿‡sqlè¿™ç§DSLçš„æ–¹å¼ï¼Œè®©ä¸åŒè¯­è¨€æŠ€æœ¯æ ˆçš„åŒäº‹éƒ½å¯ä»¥å®šåˆ¶è‡ªå·±çš„jobã€‚</p><p>å¹¶ä¸”æ”¯æŒäº†è‡ªå®šä¹‰é‡å¯ç­–ç•¥ï¼Œä¿è¯æ¯ä¸€ä¸ªç®—å­åœ¨å¼‚å¸¸æˆ–è€…æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ä»æ­£ç¡®çš„æ•°æ®ä¸­è¿›è¡Œæ¢å¤é‡å¯ã€‚</p><p>è¿™ä¸€å¥—sqlç¼–å†™ä¸‹æ¥ï¼Œåšçš„äº‹æƒ…å’Œæˆ‘ä»¬ä¸Šé¢çš„<code>datastream</code>åšçš„äº‹æƒ…æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å´æ— éœ€äº†è§£å¤ªå¤šå…¶ä¸­çš„ç»†èŠ‚ã€‚</p><h4 id="UDFçš„è¿ç”¨"><a href="#UDFçš„è¿ç”¨" class="headerlink" title="UDFçš„è¿ç”¨"></a>UDFçš„è¿ç”¨</h4><p>ä¾‹å¦‚æˆ‘ä»¬éœ€è¦ipè½¬åœ°å€å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦udfæ¥ååŠ©æˆ‘ä»¬å®Œæˆè¿™ä»¶äº‹ã€‚</p><p>clienté¡¹ç›®å¯ä»¥å†…ç½®ä¸€äº›æˆ‘ä»¬æ‰€éœ€è¦çš„UDFï¼Œç„¶åè¿åŒjobä¸€èµ·ç”Ÿæ•ˆã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@127.0,0.1_A ~]# flink run -yid `cat /data/flink-stream/mstream/mstream_xx/yid` /data/flink-stream/flink-sql-submit-1.0-SNAPSHOT.jar job --sql "CATALOG_INFO = hive:/opt/hadoopclient/Hive/config/:-;USE mstream_alarm;SELECT ip2location('219.135.155.76');"</span><br><span class="line"> Interface ana-group-1byez.dad44e53-24e6-41be-bfd5-a4055f4c6604.com:32263 of application 'application_1641337362340_6699'.</span><br><span class="line">Job has been submitted with JobID 824af5a31aba88db6e0137f5e834f26b</span><br><span class="line">+----+--------------------------------+</span><br><span class="line">| op |                         EXPR$0 |</span><br><span class="line">+----+--------------------------------+</span><br><span class="line">| +I |                 ä¸­å›½,å¹¿ä¸œ,å¹¿å· |</span><br><span class="line">+----+--------------------------------+</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡<code>ip2localtion()</code>ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªudfï¼Œå¹¶ä¸”å¯ä»¥å®ç°åœ¨sqlçš„æ¨¡å¼ä¸Šã€‚ç”¨è¿‡ipåœ°å€è½¬ä¸ºä¸ºäº†åœ°å€ã€‚</p><h2 id="è½åœ°å®æˆ˜"><a href="#è½åœ°å®æˆ˜" class="headerlink" title="è½åœ°å®æˆ˜"></a>è½åœ°å®æˆ˜</h2><p>ç”±äºèµ„æºçš„æœ‰é™ï¼Œæˆ‘ä»¬åœ¨flinkçš„æ¶æ„ä¸Šï¼Œé‡‡ç”¨çš„æ˜¯æ¯ä¸ªé¡¹ç›®å¯¹åº”ä¸€ä¸ª<code>application</code>çš„æ–¹æ³•ï¼Œæ¯ä¸ª<code>applicationé€šè¿‡yarnæ¥åˆ†é…æ¥åˆ†é…èµ„æºå®¹å™¨</code>ï¼Œç„¶åå†é€šè¿‡<code>yarn-session</code>(é<code>per on job</code>)çš„æ–¹å¼æ¥ç®¡ç†æˆ‘ä»¬çš„flinkåº”ç”¨ã€‚</p><h3 id="ç”³è¯·èµ„æºåº”ç”¨"><a href="#ç”³è¯·èµ„æºåº”ç”¨" class="headerlink" title="ç”³è¯·èµ„æºåº”ç”¨"></a>ç”³è¯·èµ„æºåº”ç”¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn-session.sh -jm 1024 -tm 1024 -s 16 -nm 'å‘Šè­¦æµè®¡ç®—åº”ç”¨' -yd</span><br></pre></td></tr></table></figure><p><img src="/images/FLINK/application.png" alt="application"></p><h3 id="client-ä¾‹å­"><a href="#client-ä¾‹å­" class="headerlink" title="client ä¾‹å­"></a>client ä¾‹å­</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">help</span></span></span><br><span class="line">root@41c5967b5948:/www# flink run target/mc-flink-sql-submit-1.0-SNAPSHOT.jar help</span><br><span class="line">å¸®åŠ©å‘½ä»¤</span><br><span class="line"></span><br><span class="line">Usage of "flink run &lt;.jar&gt; help [options]"</span><br><span class="line"></span><br><span class="line">Available Commands</span><br><span class="line">   job          æäº¤jobä½œä¸š</span><br><span class="line">   sql-parser   è§£æsqlæ–‡ä»¶</span><br><span class="line">   help         å¸®åŠ©å‘½ä»¤</span><br><span class="line">   hive-catalog hive-catalogçš„ç›¸å…³</span><br><span class="line"></span><br><span class="line">Global Options:</span><br><span class="line">   --app.force.remote bool</span><br><span class="line">       æ˜¯å¦å¯åŠ¨è¿œç«¯ç¯å¢ƒå˜é‡: false</span><br><span class="line">   --app.config.debug bool</span><br><span class="line">       æ˜¯å¦æ‰“å°ç”¨æˆ·å‚æ•°: false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> job</span></span><br><span class="line">root@41c5967b5948:/www# flink run target/mc-flink-sql-submit-1.0-SNAPSHOT.jar job help</span><br><span class="line">æäº¤job</span><br><span class="line"></span><br><span class="line">Usage of "flink run &lt;.jar&gt; job [options]"</span><br><span class="line">   --sql string</span><br><span class="line">       æ‰§è¡Œçš„sql (*)</span><br><span class="line">   --plan string</span><br><span class="line">       é€‰æ‹©æ‰§è¡Œè®¡åˆ’å™¨:</span><br><span class="line">           flink-streaming</span><br><span class="line">           flink-batch</span><br><span class="line">           blink-streaming</span><br><span class="line">           flink-batch</span><br><span class="line"></span><br><span class="line">Global Options:</span><br><span class="line">   --app.force.remote bool</span><br><span class="line">       æ˜¯å¦å¯åŠ¨è¿œç«¯ç¯å¢ƒå˜é‡: false</span><br><span class="line">   --app.config.debug bool</span><br><span class="line">       æ˜¯å¦æ‰“å°ç”¨æˆ·å‚æ•°: false</span><br></pre></td></tr></table></figure><h3 id="flink-stream-sql-mctl-ç”¨æ³•"><a href="#flink-stream-sql-mctl-ç”¨æ³•" class="headerlink" title="flink-stream-sql-mctl ç”¨æ³•"></a>flink-stream-sql-mctl ç”¨æ³•</h3><p>è¿™æ˜¯ä¸€ä¸ªé›†æˆè„šæœ¬ï¼Œæ‰€ä»¥å­˜åœ¨çº¦å®šçš„è§„åˆ™å’Œéƒ¨ç½²çš„æ¶æ„çº¦æŸã€‚</p><p>è¿™ä¾¿äºæˆ‘ä»¬ç®¡ç†æ‰€æœ‰çš„applitionå’Œflinkç§çš„æ‰€æœ‰flink-jobã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">flink-sql-submit git:(master) âœ— ./flink-stream-sql-mctl.sh</span><br><span class="line"></span><br><span class="line">  flink-stream-sql-mctl.sh [OPTION] &lt;COMMAND&gt;</span><br><span class="line"></span><br><span class="line">  Flinkæµè®¡ç®—SQL-Clientçš„æ‰§è¡Œè„šæœ¬</span><br><span class="line"></span><br><span class="line">  Command:</span><br><span class="line">    run          [FILE]            è¿è¡Œ</span><br><span class="line">    stop         [FILE]            åœæ­¢</span><br><span class="line">    list         [FILE]            åˆ—å‡ºFILEæ‰€åœ¨yidä¸‹çš„æ‰€æœ‰jobä»»åŠ¡åˆ—è¡¨</span><br><span class="line">    drop_table   [FILE]            åˆ é™¤æ‰€æœ‰è¡¨</span><br><span class="line">    rebuild_run  [FILE]            åˆ é™¤æ‰€æœ‰è¡¨ï¼Œç„¶åé‡è·‘(ç»§æ‰¿savepointï¼‰</span><br><span class="line"></span><br><span class="line">  Command-Common-Options:</span><br><span class="line">    -c, --clientpath  [LEVEL]    flink-sql-submit.jarè·¯å¾„  (Default is '/data/tmp/mc-flink-sql-submit-1.0-SNAPSHOT.jar')</span><br><span class="line">    -f   æ˜¯å¦å¼ºåˆ¶è¿è¡Œï¼Œå¿½ç•¥ä»¥å¾€savepoint</span><br><span class="line"></span><br><span class="line">  Common-Options:</span><br><span class="line">    -h, --help              Display this help and exit</span><br><span class="line">    --loglevel [LEVEL]      One of: FATAL, ERROR, WARN, INFO, NOTICE, DEBUG, ALL, OFF</span><br><span class="line">                            (Default is 'ERROR')</span><br><span class="line">    --logfile [FILE]        Full PATH to logfile.  (Default is '/Users/caiwenhui/logs/flink-stream-sql-mctl.sh.log')</span><br><span class="line">    -n, --dryrun            Non-destructive. Makes no permanent changes.</span><br><span class="line">    -q, --quiet             Quiet (no output)</span><br><span class="line">    -v, --verbose           Output more information. (Items echoed to 'verbose')</span><br><span class="line">    --force                 Skip all user interaction.  Implied 'Yes' to all actions.</span><br></pre></td></tr></table></figure><p>çº¦å®šè§„åˆ™ï¼š</p><ul><li>æ¨¡å‹æ‰€åœ¨çˆ¶ç›®å½•çš„è‡³å°‘æœ‰ä¸€ä¸ªyidæ–‡ä»¶ï¼ˆå–æœ€è¿‘çš„ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„yidï¼‰å¯¹åº”æ‰€åœ¨çš„åº”ç”¨id</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡å‹å¯åŠ¨çš„æ—¶å€™ä¼šå–æœ€è¿‘ä¸€æ¬¡savepointçš„æ•°æ®è¿›è¡Œæ¢å¤ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥å¯åŠ¨</li></ul><h3 id="åœæ­¢æ‰€æœ‰æ¨¡å‹"><a href="#åœæ­¢æ‰€æœ‰æ¨¡å‹" class="headerlink" title="åœæ­¢æ‰€æœ‰æ¨¡å‹"></a>åœæ­¢æ‰€æœ‰æ¨¡å‹</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in $(find /data/flink-stream/mstream_alarm/ -type f -name "*.sql");do /data/flink-stream/flink-stream-sql-mctl stop $i;done</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨æ‰€æœ‰æ¨¡å‹"><a href="#å¯åŠ¨æ‰€æœ‰æ¨¡å‹" class="headerlink" title="å¯åŠ¨æ‰€æœ‰æ¨¡å‹"></a>å¯åŠ¨æ‰€æœ‰æ¨¡å‹</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in $(find /data/flink-stream/mstream_alarm/ -type f -name "*.sql");do /data/flink-stream/flink-stream-sql-mctl run $i;done</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤æ‰€æœ‰è¡¨"><a href="#åˆ é™¤æ‰€æœ‰è¡¨" class="headerlink" title="åˆ é™¤æ‰€æœ‰è¡¨"></a>åˆ é™¤æ‰€æœ‰è¡¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in $(find /data/flink-stream/mstream_alarm/ -type f -name "*.sql");do /data/flink-stream/flink-stream-sql-mctl drop_table $i;done</span><br></pre></td></tr></table></figure><h3 id="ç›¸å…³çš„ä¸€äº›è½åœ°åæˆªå›¾ä¿¡æ¯"><a href="#ç›¸å…³çš„ä¸€äº›è½åœ°åæˆªå›¾ä¿¡æ¯" class="headerlink" title="ç›¸å…³çš„ä¸€äº›è½åœ°åæˆªå›¾ä¿¡æ¯"></a>ç›¸å…³çš„ä¸€äº›è½åœ°åæˆªå›¾ä¿¡æ¯</h3><p><img src="/images/FLINK/server.png" alt="server"></p><p><img src="/images/FLINK/detail-0.png" alt="detail-0"></p><p><img src="/images/FLINK/detail-1.png" alt="detail-1"></p><p><img src="/images/FLINK/detail-2.png" alt="detail-2"></p><p><img src="/images/FLINK/detail-3.png" alt="detail-3"></p><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„flinkç›¸å…³çš„æµè®¡ç®—åº”ç”¨ï¼Œä»0åˆ°1çš„è¿‡ç¨‹æš‚æ—¶ç”»ä¸Šä¸€ä¸ªé‡Œç¨‹ç¢‘ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;åœ¨å…¬å¸è½åœ°ä¸€å¥—flinkï¼Œæ€»ç»“åˆ°ç›®å‰ä¸ºæ­¢åšäº†çš„äº‹æƒ…ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="flink" scheme="http://blog.crazylaw.cn/tags/flink/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- åŸºäºgnetçš„ç«¯å£å¤ç”¨æ”¯æŒå¤šåè®®çš„å®¢æœèŠå¤©ç›‘æ§æœåŠ¡</title>
    <link href="http://blog.crazylaw.cn/2022/02/12/Golang/%E5%9F%BA%E4%BA%8Egnet%E7%9A%84%E5%AE%A2%E6%9C%8D%E8%81%8A%E5%A4%A9%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/"/>
    <id>http://blog.crazylaw.cn/2022/02/12/Golang/%E5%9F%BA%E4%BA%8Egnet%E7%9A%84%E5%AE%A2%E6%9C%8D%E8%81%8A%E5%A4%A9%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/</id>
    <published>2022-02-11T16:46:51.000Z</published>
    <updated>2022-02-12T03:45:01.017Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘ï¼Œå…¬å¸ä»¥å‰æœ‰ä¸€äº›æ—§çš„æœåŠ¡ï¼Œç”±äºå„ç§åŸå› ï¼Œå¯¼è‡´å„ç§é—®é¢˜ï¼Œå¹¶ä¸”æ¶æ„è®¾è®¡è¡Œä¹Ÿä¸æ˜¯é‚£ä¹ˆå‹å¥½å’Œä¸åˆ©äºç»´æŠ¤ã€‚<br>æ‰€ä»¥å‡†å¤‡é‡æ„è®¾è®¡ä¸€äº›æœåŠ¡ã€‚</p><p>åœ¨æ¸¸æˆå…¬å¸ä¸­ï¼ŒGMå®¢æœçš„å…¶ä¸­ä¸€ä¸ªèŒèƒ½å°±æ˜¯ç›‘ç£èˆ†è®ºï¼Œä»ç©å®¶å¹³æ—¥çš„èŠå¤©ä¸­è¿›è¡Œç›‘æ§ã€‚</p><p>æˆ‘ä»¬ä»<code>ä¸šåŠ¡éœ€æ±‚</code>+<code>æŠ€æœ¯æ¶æ„</code>å±‚é¢è¿›è¡Œæ•´ç†ã€‚</p><a id="more"></a><h2 id="å†å²"><a href="#å†å²" class="headerlink" title="å†å²"></a>å†å²</h2><p>åœ¨è¿‡å»ä¸­ï¼Œç”±äºå½“æ—¶phpè¿˜æ˜¯å¦‚æ—¥ä¸­å¤©ï¼Œæ—§çš„åˆ™æ˜¯é‡‡é›†çš„<code>swoole1.x</code>çš„ç‰ˆæœ¬è¿›è¡Œå¼€å‘çš„æœåŠ¡ã€‚<br>å—é™äºphpä¸€ä¸ªè¯­è¨€ç‰¹æ€§ï¼Œæ³¨å®šæ— æ³•å®ç°ä¸€äº›é«˜æ€§èƒ½çš„ä¸­é—´ä»¶ï¼Œæˆ–è€…è¯´å¤§æ•°æ®ç”Ÿæ€ååˆ†æ¬ ç¼ºã€‚å½“æ—¶ç”¨phpé™¤äº†<code>fastcgi</code>çš„<code>webç³»ç»Ÿ</code>å¤–ï¼Œæœ€å¤šå°±åªèƒ½åšä¸€äº›åŸºæœ¬çš„<code>å¸¸é©»</code>ä»»åŠ¡ã€‚</p><p>æ¶ˆæ¯ä¸­é—´ä»¶æœ€å¤šä¹Ÿå°±æ˜¯ç”¨åˆ°<code>rabbitmq</code>ï¼Œ<code>rocketmq</code>ç­‰ç­‰ã€‚</p><p>è€Œå¸¸é©»ï¼Œä¸€èˆ¬æ— éå°±æ˜¯ç›´æ¥<code>cli</code>ï¼Œå¤–åŠ ä¸€ä¸ª<code>å¾ªç¯+sleep</code>çš„ç»„åˆå¥—é¤ã€‚è€Œè¦å®ç°<code>websocket-server</code>è¿™ç§å¸¸é©»æœåŠ¡ï¼Œä¸€èˆ¬æ˜¯å€ŸåŠ©<code>swoole</code>æ¥å¤„ç†ã€‚æ¯•ç«Ÿ<code>reactor</code>çš„æ¨¡å¼ï¼Œæ€ä¹ˆéƒ½æ¯”<code>å•è¿›ç¨‹</code>çš„å®ç°å¥½ã€‚</p><p>åˆ†ä¸ºäº†3ä¸ªæ¨¡å—ï¼ˆæ¯ä¸ªæ¨¡å—=æ¯ä¸ªè§’è‰²=ä¸€ä¸ªè¿›ç¨‹=ä¸€ä¸ªæœåŠ¡ï¼‰ï¼š</p><ul><li>chat_record ï¼ˆèŠå¤©è®°å½•è§’è‰²ï¼‰ï¼ˆweboccket_client, tcp_clinetï¼‰</li><li>db_server ï¼ˆæ•°æ®å±‚è§’è‰²) (tcp_server)</li><li>websocket_server (è¿æ¥å±‚è§’è‰²) (webocket_server)</li></ul><p>ç”±äºå½“æ—¶phpåŸºæœ¬æ— æ³•å¤šçº¿ç¨‹ç¼–ç¨‹(å¯ç”¨ï¼Œä½†æ˜¯ä¸å‹å¥½)ï¼Œåªèƒ½é‡‡ç”¨è¿™ç§å§”å©‰çš„<code>ä¼ªå¤šè¿›ç¨‹</code>çš„æ¨¡æ‹Ÿè¿›è¡Œ<code>ä¸åŒä»»åŠ¡çš„å¤„ç†</code>å’Œ<code>æ•°æ®çš„äº¤äº’</code>ã€‚</p><p><img src="/images/Go/chat_monitor.png" alt="æ—§æœåŠ¡çš„æ•°æ®æµå›¾"></p><h2 id="æ–°æœåŠ¡"><a href="#æ–°æœåŠ¡" class="headerlink" title="æ–°æœåŠ¡"></a>æ–°æœåŠ¡</h2><p><img src="/images/Go/chat_monitor_new.png" alt="æ–°æœåŠ¡çš„æ•°æ®æµå›¾"></p><blockquote><p>ä½†æ˜¯ç”±äºç§ç§åŸå› ï¼Œåé¢å¹¶æœªå¦‚æ­¤æ‹†åˆ†æ¶æ„ï¼Œè€Œæ˜¯å°†<code>websocket-serverç½‘ç»œè¿æ¥å±‚</code>çš„å’Œ<code>ä¸šåŠ¡å±‚</code>åˆå¹¶æˆä¸ºäº†ä¸€ä¸ª<code>å•ä½“æœåŠ¡</code></p></blockquote><p>æŠ€æœ¯é€‰å‹ä¸Š</p><ul><li>go</li><li>gnet</li><li>kafka</li></ul><h3 id="ä¸ºä»€ä¹ˆæ ¸å¿ƒçš„ç½‘ç»œå±‚éœ€è¦é‡‡ç”¨gnetå‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆæ ¸å¿ƒçš„ç½‘ç»œå±‚éœ€è¦é‡‡ç”¨gnetå‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆæ ¸å¿ƒçš„ç½‘ç»œå±‚éœ€è¦é‡‡ç”¨gnetå‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆæ ¸å¿ƒçš„ç½‘ç»œå±‚éœ€è¦é‡‡ç”¨<code>gnet</code>å‘¢ï¼Ÿ</h3><p>ä¸€èˆ¬Goè¯­è¨€çš„TCP(å’ŒHTTP)çš„å¤„ç†éƒ½æ˜¯<code>æ¯ä¸€ä¸ªè¿æ¥</code>å¯åŠ¨<code>ä¸€ä¸ªgoroutine</code>å»å¤„ç†ï¼Œå› ä¸ºæˆ‘ä»¬è¢«æ•™å¯¼<code>goroutine</code>çš„ä¸åƒ<code>thread</code>, å®ƒæ˜¯å¾ˆä¾¿å®œçš„ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨æˆ<code>åƒä¸Šä¸‡çš„goroutine</code>ã€‚</p><p>ä½†æ˜¯å¯¹äº<code>ä¸€ç™¾ä¸‡</code>çš„è¿æ¥ï¼Œè¿™ç§<code>goroutine-per-connection</code>çš„æ¨¡å¼å°±<code>è‡³å°‘</code>è¦å¯åŠ¨<code>ä¸€ç™¾ä¸‡ä¸ªgoroutine</code>ï¼Œè¿™å¯¹èµ„æºçš„æ¶ˆè€—ä¹Ÿæ˜¯æå¤§çš„ã€‚</p><p>é’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œä¸åŒçš„Goç‰ˆæœ¬ï¼Œä¸€ä¸ªgoroutineé”ä½¿ç”¨çš„æœ€å°çš„æ ˆå¤§å°æ˜¯<code>2KB ~ 8 KB (go stack)</code>,å¦‚æœåœ¨æ¯ä¸ªgoroutineä¸­åœ¨<code>åˆ†é…byte buffer</code>ç”¨ä»¥ä»è¿æ¥ä¸­è¯»å†™æ•°æ®ï¼Œ<code>å‡ åGçš„å†…å­˜</code>è½»è½»æ¾æ¾å°±åˆ†é…å‡ºå»äº†ã€‚</p><p><code>ååç‡</code>å’Œ<code>å»¶è¿Ÿ</code>éœ€è¦æ•°æ®æ¥æ”¯æ’‘ï¼Œä½†æ˜¯æ˜¾ç„¶è¿™ä¸ª<code>å•goroutine</code>å¤„ç†çš„æ¨¡å¼<code>ä¸é€‚åˆè€—æ—¶è¾ƒé•¿</code>çš„ä¸šåŠ¡å¤„ç†ï¼Œ<code>&quot;hello world&quot;</code>æˆ–è€…<code>ç›´æ¥çš„ç®€å•çš„memoryæ“ä½œ</code>åº”è¯¥æ²¡æœ‰é—®é¢˜ã€‚</p><p>å¯¹äºç™¾ä¸‡è¿æ¥<code>ä½†æ˜¯å¹¶å‘é‡å¾ˆå°</code>çš„åœºæ™¯ï¼Œæ¯”å¦‚æ¶ˆæ¯æ¨é€ã€é¡µæ¸¸ç­‰åœºæ™¯ï¼Œè¿™ç§å®ç°åº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><p>ä½†æ˜¯å¯¹äºå¹¶å‘é‡å¾ˆå¤§ï¼Œå»¶è¿Ÿè¦æ±‚æ¯”è¾ƒä½çš„åœºæ™¯ï¼Œè¿™ç§å®ç°å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ã€‚</p><p><code>gnet</code>é‡‡ç”¨äº†ç±»ä¼¼<code>netty</code>çš„<code>reactor</code>æ¨¡å¼ï¼ŒåŸºäº<code>epoll</code>æˆ–è€…<code>kqueue</code>å®ç°ioå¤šè·¯å¤ç”¨ã€‚å¹¶ä¸”åŸºäºgolangçš„è¯­è¨€ç‰¹æ€§ï¼Œå…¶å®ç°åŸç†ä¸º<code>å¸¦çº¿ç¨‹/goç¨‹æ± çš„ä¸»ä» Reactors å¤šçº¿ç¨‹</code>æ¨¡å¼ï¼Œåœ¨ç½‘ç»œå±‚ä¸Šæ€§èƒ½ä¸Šæœ‰æå¤§çš„ä¼˜åŒ–ã€‚</p><p>æˆ‘ä»¬é€šè¿‡gnetæä¾›çš„tcpç½‘ç»œå±‚ï¼Œåœ¨åº”ç”¨å±‚ï¼Œå®ç°äº†httpå’Œwebocketçš„ç«¯å£å¤ç”¨çš„å½¢å¼ã€‚</p><p>httpç”¨äºæä¾›<code>prometheus</code>çš„<code>metrics</code>æŒ‡æ ‡ï¼Œä¾‹å¦‚<code>è¿æ¥æ•°/å„ç§ç±»å‹å¼•å‘çš„erroræ•°/æ¯æ¡æ•°æ®è¢«å¤šå°‘ä¸ªGMå®¢æœç›‘è§†ç€</code>ç­‰ç­‰</p><p>websocketåˆ™æ˜¯ç”¨äºåœ¨æˆ‘ä»¬çš„<code>GMå®¢æœ</code>ä¸­ï¼Œæä¸€ä¸ªå®æ—¶çš„èŠå¤©æ•°æ®è·å–</p><h3 id="ä¸ºä»€ä¹ˆé‡‡ç”¨kafka"><a href="#ä¸ºä»€ä¹ˆé‡‡ç”¨kafka" class="headerlink" title="ä¸ºä»€ä¹ˆé‡‡ç”¨kafka"></a>ä¸ºä»€ä¹ˆé‡‡ç”¨kafka</h3><p>ç”±äºæˆ‘ä»¬æ•´å¥—æ—¥å¿—æœåŠ¡éƒ½æ˜¯åŸºäºkafkaä½œä¸ºæ ¸å¿ƒç»„ä»¶çš„ï¼Œæ‰€ä»¥åœ¨æ•°æ®çš„å®æ—¶ä¸Šï¼Œå¯ä»¥ä¿è¯åˆ°æ•°æ®çš„å®æ•ˆæ€§ã€‚</p><p>ä»è€Œå–æ¶ˆäº†ä»¥å¾€ä»mysqlä¸­åˆ†åº“åˆ†è¡¨å»æŸ¥è¯¢æ•°æ®ã€‚ä¹Ÿä¸éœ€è¦é€šè¿‡å…¶ä»–<code>OLAP</code>çš„æœåŠ¡è¿›è¡Œå¤„ç†ã€‚</p><h3 id="ç«¯å£å¤ç”¨å®ç°æ”¯æŒå¤šåè®®"><a href="#ç«¯å£å¤ç”¨å®ç°æ”¯æŒå¤šåè®®" class="headerlink" title="ç«¯å£å¤ç”¨å®ç°æ”¯æŒå¤šåè®®"></a>ç«¯å£å¤ç”¨å®ç°æ”¯æŒå¤šåè®®</h3><p>è¿™ä¸ªæ˜¯ç½‘ç»œè¿æ¥å±‚ï¼Œä¹Ÿæ˜¯é“¾æ¥çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œåœ¨gnetä¸­å½“æœ‰æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œç”±<code>IOå¤šè·¯å¤ç”¨</code>çš„<code>epoll</code>æ¨¡å‹ï¼Œä¼šè§¦å‘<code>OnTraffic(c gnet.Conn)</code>çš„å›è°ƒå‡½æ•°ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç½‘ç»œå±‚ä¸­è·å–çš„æ•°æ®è¿›è¡ŒåŠ å·¥å¤„ç†ï¼Œå½¢æˆè‡ªå·±æƒ³è¦çš„<code>åº”ç”¨åè®®</code>ã€‚</p><p>ç”±äºåˆšæ‰ä»‹ç»åˆ°äº†ï¼Œæˆ‘ä»¬éœ€è¦å®ç°æ ¸å¿ƒéœ€æ±‚ï¼š<code>ç«¯å£å¤šåè®®å¤ç”¨</code></p><p>åœ¨è¿™é‡Œï¼Œå…ˆåˆ—å‡ºæ ¸å¿ƒçš„é€»è¾‘ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> ApplicationLayerProto <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(alp ApplicationLayerProto)</span> <span class="title">String</span><span class="params">()</span> <span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">switch</span> alp &#123;</span><br><span class="line"><span class="keyword">case</span> HttpApplicationLayerProto:</span><br><span class="line">s = <span class="string">"http"</span></span><br><span class="line"><span class="keyword">case</span> WebsocketApplicationLayerProto:</span><br><span class="line">s = <span class="string">"websocket"</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">s = <span class="string">"unknown"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">HttpApplicationLayerProto ApplicationLayerProto = <span class="literal">iota</span></span><br><span class="line">WebsocketApplicationLayerProto</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> codec <span class="keyword">struct</span> &#123;</span><br><span class="line">proto ApplicationLayerProto</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *codec)</span> <span class="title">isHttp</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.proto == HttpApplicationLayerProto &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *codec)</span> <span class="title">isWebsocket</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.proto == WebsocketApplicationLayerProto &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> httpCodec <span class="keyword">struct</span> &#123;</span><br><span class="line">*codec</span><br><span class="line">parser *wildcat.HTTPParser</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> wsCodec <span class="keyword">struct</span> &#123;</span><br><span class="line">*codec</span><br><span class="line">connected <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(serv *server)</span> <span class="title">OnOpen</span><span class="params">(c gnet.Conn)</span> <span class="params">([]<span class="keyword">byte</span>, gnet.Action)</span></span> &#123;</span><br><span class="line">c.SetContext(<span class="built_in">new</span>(codec))</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, gnet.None</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(serv *server)</span> <span class="title">OnTraffic</span><span class="params">(c gnet.Conn)</span> <span class="title">gnet</span>.<span class="title">Action</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> buffer *bytes.Buffer</span><br><span class="line"><span class="keyword">var</span> buff []<span class="keyword">byte</span></span><br><span class="line">pipeline:</span><br><span class="line"><span class="keyword">switch</span> cdc := c.Context().(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> *codec:</span><br><span class="line">buf, err := c.Next(<span class="number">-1</span>)</span><br><span class="line">buff = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(buf))</span><br><span class="line"><span class="built_in">copy</span>(buff, buf)</span><br><span class="line">buffer = bytes.NewBuffer(buff)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> gnet.Close</span><br><span class="line">&#125;</span><br><span class="line">hc := &amp;httpCodec&#123;parser: wildcat.NewHTTPParser(), codec: cdc&#125;</span><br><span class="line">_, err = hc.parser.Parse(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"http parser error: %v"</span>, err)&#125;)</span><br><span class="line"><span class="keyword">return</span> gnet.Close</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> upgrade := hc.parser.FindHeader([]<span class="keyword">byte</span>(<span class="string">"Upgrade"</span>)); upgrade != <span class="literal">nil</span> &amp;&amp; bytes.Equal(upgrade, []<span class="keyword">byte</span>(<span class="string">"websocket"</span>)) &#123;</span><br><span class="line">cdc.proto = WebsocketApplicationLayerProto</span><br><span class="line">wc := &amp;wsCodec&#123;</span><br><span class="line">codec: cdc,</span><br><span class="line">&#125;</span><br><span class="line">c.SetContext(wc)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">cdc.proto = HttpApplicationLayerProto</span><br><span class="line">c.SetContext(hc)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> pipeline</span><br><span class="line"><span class="keyword">case</span> *httpCodec:</span><br><span class="line">buf := bufio.NewReader(buffer)</span><br><span class="line">req, err := http.ReadRequest(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"request from http error: %v"</span>, err)&#125;)</span><br><span class="line"><span class="keyword">return</span> gnet.Close</span><br><span class="line">&#125;</span><br><span class="line">metrics.TotalConnectedCounter.WithLabelValues(HttpApplicationLayerProto.String()).Inc()</span><br><span class="line">resp := route.NewResponse(c)</span><br><span class="line">h, _ := serv.serverMux.Handler(req)</span><br><span class="line">h.ServeHTTP(resp, req)</span><br><span class="line"><span class="keyword">if</span> _, err = resp.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"write to http error: %v"</span>, err)&#125;)</span><br><span class="line"><span class="keyword">return</span> gnet.Close</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> gnet.Close</span><br><span class="line"><span class="keyword">case</span> *wsCodec:</span><br><span class="line"><span class="keyword">if</span> !cdc.connected &#123;</span><br><span class="line">wcb := &amp;wsConnBridge&#123;</span><br><span class="line">buff: buffer,</span><br><span class="line">c:    c,</span><br><span class="line">&#125;</span><br><span class="line">_, err := ws.Upgrade(wcb)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"upgrade[%s] to websocket error: %v"</span>, c.RemoteAddr().String(), err)&#125;)</span><br><span class="line">&#125;</span><br><span class="line">log.Debugf(log.NetServerDebugCategory&#123;&#125;, <span class="string">"conn[%v] upgrade websocket protocol"</span>, c.RemoteAddr().String())</span><br><span class="line">cdc.connected = <span class="literal">true</span></span><br><span class="line">metrics.ConnectedGauge.Inc()</span><br><span class="line">metrics.TotalConnectedCounter.WithLabelValues(WebsocketApplicationLayerProto.String()).Inc()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">msg, op, err := wsutil.ReadClientData(c)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> _, ok := err.(wsutil.ClosedError); !ok &#123;</span><br><span class="line">log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"[%s] receive ws message error: %v"</span>, c.RemoteAddr().String(), err)&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> gnet.Close</span><br><span class="line">&#125;</span><br><span class="line">log.Debugf(log.NetServerDebugCategory&#123;&#125;, <span class="string">"conn[%v] receive [op=%v] [msg=%v]"</span>, c.RemoteAddr().String(), op, <span class="keyword">string</span>(msg))</span><br><span class="line"><span class="keyword">if</span> op == ws.OpText &#123;</span><br><span class="line"><span class="keyword">if</span> rs := route.MatchRequestSpec(msg); rs == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> route.GlobalWsRouter.DefaultHandler().ServeWebsocket(<span class="string">"/"</span>, msg, c, op)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> route.GlobalWsRouter.MatchHandler(rs.Path).ServeWebsocket(rs.Path, rs.Params, c, op)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> gnet.None</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“å­˜åœ¨æ–°é“¾æ¥è¿›æ¥çš„å•¥æ—¶å€™ï¼Œé¦–å…ˆç»è¿‡<code>OnOpen(c gnet.Conn)</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåœ¨<code>gnet.Conn</code>ä¸­è®¾ç½®ä¸€ä¸ªæˆ‘ä»¬ç”¨æˆ·çš„ä¸€ä¸ª<code>ä¸Šä¸‹æ–‡ç¯å¢ƒContext</code>ï¼Œåœ¨è¿™ä¸ªContextä¸‹ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆå§‹åŒ–äº†<code>codec</code>çš„ç»“æ„ä½“å¯¹è±¡ï¼Œå½“å¼€å§‹æ¥æ”¶æ•°æ®çš„æ—¶å€™ï¼Œè§¦å‘åˆ°äº†<code>OnTraffic(c gnet.Conn)</code>æ–¹æ³•ï¼Œè¿™ä¸ªä»¥åï¼Œæˆ‘ä»¬éœ€è¦æŠŠç½‘ç»œå±‚æ¥æ”¶åˆ°çš„æ•°æ®æ‹¿å‡ºæ¥ï¼Œç”±äº<code>æµ</code>çš„å­˜åœ¨ï¼Œä½¿å¾—æˆ‘ä»¬æ— æ³•é‡å¤åœ¨åŒä¸€ä¸ªè¿æ¥ä¸­ï¼Œå¤šæ¬¡é‡å¤è·å–æµï¼Œæ‰€ä»¥å¦‚æœåé¢éœ€è¦ç”¨åˆ°çš„è¯ï¼Œåˆ©ç”¨å–å‡ºæ¥çš„<code>byte-buffer</code>ç”Ÿæˆä¸€ä¸ªæ–°çš„<code>æµ</code>ï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚</p><p>æ‰€ä»¥ä½ ä¼šå‘ç°æœ‰ä¸€æ®µä»£ç ä¸º:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buf, err := c.Next(<span class="number">-1</span>)</span><br><span class="line">buff = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(buf))</span><br><span class="line"><span class="built_in">copy</span>(buff, buf)</span><br><span class="line">buffer = bytes.NewBuffer(buff)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œéœ€è¦åšçš„äº‹æƒ…å°±æ˜¯è§£ææ•°æ®ä¸ºhttpåè®®å¯¹è±¡ï¼Œç”±äºæˆ‘è¿™é‡Œçš„<code>ç«¯å£å¤ç”¨</code>çš„é€»è¾‘æ˜¯<code>http+webocket</code>å¤ç”¨ï¼Œæ‰€ä»¥éƒ½æ˜¯åŸºäº<code>httpåè®®</code>çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç®€å•ç²—æš´çš„å¤„ç†ï¼Œç„¶åé€šè¿‡åˆ¤æ–­<code>httpåè®®</code>ä¸­æ˜¯å¦åŒ…å«äº†éœ€è¦å‡çº§ä¸º<code>webocketåè®®</code>çš„å…³é”®å­—æ®µ<code>Upgrade:webocket</code>ï¼Œå¦‚æœåŒ…å«ï¼Œåˆ™è¡¨ç¤ºæœ¬æ¬¡è¯·æ±‚æ˜¯ä¸€ä¸ªwebsocketè¿æ¥ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªå•çº¯httpè¿æ¥ã€‚ä»¥æ­¤æ¥è¾¾åˆ°å¤ç”¨çš„éœ€æ±‚ã€‚</p><p>åœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿæ›´æ–°äº†å½“å‰è¿æ¥çš„<code>ä¸Šä¸‹æ–‡ç¯å¢ƒContext</code>ï¼Œå‡çº§ä¸ºäº†<code>httpCodec</code>å’Œ<code>wsCodec</code>ï¼Œé€šè¿‡<code>goto+æ–­è¨€</code>è¯­æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°ï¼Œæˆ‘ä»¬æ‰€éœ€è¦è¿›å…¥çš„é€»è¾‘é˜¶æ®µã€‚ä¸è¦è§‰å¾—è¿™å°±å®Œäº‹äº†ï¼Œéº»çƒ¦çš„äº‹æƒ…æ‰åˆšå¼€å§‹ï¼Œç°åœ¨ä½ åªæ˜¯çŸ¥é“äº†å¼€å¤´ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">buf := bufio.NewReader(buffer)</span><br><span class="line">req, err := http.ReadRequest(buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"request from http error: %v"</span>, err)&#125;)</span><br><span class="line">    <span class="keyword">return</span> gnet.Close</span><br><span class="line">&#125;</span><br><span class="line">metrics.TotalConnectedCounter.WithLabelValues(HttpApplicationLayerProto.String()).Inc()</span><br><span class="line">resp := route.NewResponse(c)</span><br><span class="line">h, _ := serv.serverMux.Handler(req)</span><br><span class="line">h.ServeHTTP(resp, req)</span><br><span class="line"><span class="keyword">if</span> _, err = resp.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"write to http error: %v"</span>, err)&#125;)</span><br><span class="line">    <span class="keyword">return</span> gnet.Close</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> gnet.Close</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯<code>httpåè®®</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸éœ€è¦å‡çº§åè®®äº†ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œåœ¨golangçš„<code>http/server.go</code>ä¸­ï¼Œæˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„æ¥å£</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Handler responds to an HTTP request.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ServeHTTP should write reply headers and data to the ResponseWriter</span></span><br><span class="line"><span class="comment">// and then return. Returning signals that the request is finished; it</span></span><br><span class="line"><span class="comment">// is not valid to use the ResponseWriter or read from the</span></span><br><span class="line"><span class="comment">// Request.Body after or concurrently with the completion of the</span></span><br><span class="line"><span class="comment">// ServeHTTP call.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Depending on the HTTP client software, HTTP protocol version, and</span></span><br><span class="line"><span class="comment">// any intermediaries between the client and the Go server, it may not</span></span><br><span class="line"><span class="comment">// be possible to read from the Request.Body after writing to the</span></span><br><span class="line"><span class="comment">// ResponseWriter. Cautious handlers should read the Request.Body</span></span><br><span class="line"><span class="comment">// first, and then reply.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Except for reading the body, handlers should not modify the</span></span><br><span class="line"><span class="comment">// provided Request.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If ServeHTTP panics, the server (the caller of ServeHTTP) assumes</span></span><br><span class="line"><span class="comment">// that the effect of the panic was isolated to the active request.</span></span><br><span class="line"><span class="comment">// It recovers the panic, logs a stack trace to the server error log,</span></span><br><span class="line"><span class="comment">// and either closes the network connection or sends an HTTP/2</span></span><br><span class="line"><span class="comment">// RST_STREAM, depending on the HTTP protocol. To abort a handler so</span></span><br><span class="line"><span class="comment">// the client sees an interrupted response but the server doesn't log</span></span><br><span class="line"><span class="comment">// an error, panic with the value ErrAbortHandler.</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ª<code>Handler</code>interfaceï¼Œéœ€è¦å®ç°<code>ServeHTTP(ResponseWriter, *Request)</code>ï¼Œè€Œè¿™ä¸ª<code>Request</code>ï¼Œå¯¹äºæˆ‘ä»¬ç›®å‰æ¥æ˜¯ï¼Œæ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ„é€ ä¸€ä¸ª<code>Request</code>å¯¹è±¡å‡ºæ¥ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReadRequest reads and parses an incoming request from b.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ReadRequest is a low-level function and should only be used for</span></span><br><span class="line"><span class="comment">// specialized applications; most code should use the Server to read</span></span><br><span class="line"><span class="comment">// requests and handle them via the Handler interface. ReadRequest</span></span><br><span class="line"><span class="comment">// only supports HTTP/1.x requests. For HTTP/2, use golang.org/x/net/http2.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadRequest</span><span class="params">(b *bufio.Reader)</span> <span class="params">(*Request, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> readRequest(b, deleteHostHeader)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½åœ¨æ ‡å‡†åŒ…ä¸­æä¾›ä¸€ä¸ª<code>ReadRequest(b *bufio.Reader) (*Request, error)</code>çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡<code>bufio.Reader</code>å»è¯»å–<code>httpåè®®</code>ï¼Œç„¶åæ„é€ å‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„<code>Request</code>å¯¹è±¡ï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ä¸€å¼€å§‹<code>copy(buff, buf)</code>çš„æ„ä¹‰å°±ä½“ç°åœ¨æ­¤äº†ã€‚<br>è¿˜ä¼šé‚£å¥è¯ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ª<code>æµ</code>ï¼Œæ— æ³•é‡å¤è¯»å–ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨<code>[]byte</code>æ„é€ ä¸€ä¸ªå…¨æ–°çš„å¯åº¦çš„å­—èŠ‚æµã€‚</p><p>è§£å†³äº†<code>Request</code>çš„é—®é¢˜ä¹‹åï¼Œå¦å¤–ä¸€ä¸ªé—®é¢˜ä¹Ÿæ¥äº†ï¼Œ<code>ResponseWriter</code>æ˜¯ä¸€ä¸ªå’ŒResponseç›¸å…³å¯å†™çš„å­—èŠ‚æµã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A ResponseWriter interface is used by an HTTP handler to</span></span><br><span class="line"><span class="comment">// construct an HTTP response.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A ResponseWriter may not be used after the Handler.ServeHTTP method</span></span><br><span class="line"><span class="comment">// has returned.</span></span><br><span class="line"><span class="keyword">type</span> ResponseWriter <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Header returns the header map that will be sent by</span></span><br><span class="line"><span class="comment">// WriteHeader. The Header map also is the mechanism with which</span></span><br><span class="line"><span class="comment">// Handlers can set HTTP trailers.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Changing the header map after a call to WriteHeader (or</span></span><br><span class="line"><span class="comment">// Write) has no effect unless the modified headers are</span></span><br><span class="line"><span class="comment">// trailers.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// There are two ways to set Trailers. The preferred way is to</span></span><br><span class="line"><span class="comment">// predeclare in the headers which trailers you will later</span></span><br><span class="line"><span class="comment">// send by setting the "Trailer" header to the names of the</span></span><br><span class="line"><span class="comment">// trailer keys which will come later. In this case, those</span></span><br><span class="line"><span class="comment">// keys of the Header map are treated as if they were</span></span><br><span class="line"><span class="comment">// trailers. See the example. The second way, for trailer</span></span><br><span class="line"><span class="comment">// keys not known to the Handler until after the first Write,</span></span><br><span class="line"><span class="comment">// is to prefix the Header map keys with the TrailerPrefix</span></span><br><span class="line"><span class="comment">// constant value. See TrailerPrefix.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// To suppress automatic response headers (such as "Date"), set</span></span><br><span class="line"><span class="comment">// their value to nil.</span></span><br><span class="line">Header() Header</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write writes the data to the connection as part of an HTTP reply.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If WriteHeader has not yet been called, Write calls</span></span><br><span class="line"><span class="comment">// WriteHeader(http.StatusOK) before writing the data. If the Header</span></span><br><span class="line"><span class="comment">// does not contain a Content-Type line, Write adds a Content-Type set</span></span><br><span class="line"><span class="comment">// to the result of passing the initial 512 bytes of written data to</span></span><br><span class="line"><span class="comment">// DetectContentType. Additionally, if the total size of all written</span></span><br><span class="line"><span class="comment">// data is under a few KB and there are no Flush calls, the</span></span><br><span class="line"><span class="comment">// Content-Length header is added automatically.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Depending on the HTTP protocol version and the client, calling</span></span><br><span class="line"><span class="comment">// Write or WriteHeader may prevent future reads on the</span></span><br><span class="line"><span class="comment">// Request.Body. For HTTP/1.x requests, handlers should read any</span></span><br><span class="line"><span class="comment">// needed request body data before writing the response. Once the</span></span><br><span class="line"><span class="comment">// headers have been flushed (due to either an explicit Flusher.Flush</span></span><br><span class="line"><span class="comment">// call or writing enough data to trigger a flush), the request body</span></span><br><span class="line"><span class="comment">// may be unavailable. For HTTP/2 requests, the Go HTTP server permits</span></span><br><span class="line"><span class="comment">// handlers to continue to read the request body while concurrently</span></span><br><span class="line"><span class="comment">// writing the response. However, such behavior may not be supported</span></span><br><span class="line"><span class="comment">// by all HTTP/2 clients. Handlers should read before writing if</span></span><br><span class="line"><span class="comment">// possible to maximize compatibility.</span></span><br><span class="line">Write([]<span class="keyword">byte</span>) (<span class="keyword">int</span>, error)</span><br><span class="line"></span><br><span class="line"><span class="comment">// WriteHeader sends an HTTP response header with the provided</span></span><br><span class="line"><span class="comment">// status code.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If WriteHeader is not called explicitly, the first call to Write</span></span><br><span class="line"><span class="comment">// will trigger an implicit WriteHeader(http.StatusOK).</span></span><br><span class="line"><span class="comment">// Thus explicit calls to WriteHeader are mainly used to</span></span><br><span class="line"><span class="comment">// send error codes.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The provided code must be a valid HTTP 1xx-5xx status code.</span></span><br><span class="line"><span class="comment">// Only one header may be written. Go does not currently</span></span><br><span class="line"><span class="comment">// support sending user-defined 1xx informational headers,</span></span><br><span class="line"><span class="comment">// with the exception of 100-continue response header that the</span></span><br><span class="line"><span class="comment">// Server sends automatically when the Request.Body is read.</span></span><br><span class="line">WriteHeader(statusCode <span class="keyword">int</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç§‰ç€é¢å‘æ¥å£å¼€å‘çš„åŸåˆ™ï¼Œå¹¶ä¸”ä¸ºäº†æ›´å¥½çš„å…¼å®¹ç¬¬ä¸‰æ–¹çš„APIï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„<code>ResponseWriter</code>å¯¹è±¡ï¼Œäºæ˜¯å°±æœ‰äº†<code>route.NewResponse(c)</code>ï¼Œè¿™ä¸ª<code>resp</code>å®ç°äº†ä¸Šè¿°çš„æ¥å£.</p><p>å…¼å®¹äº†<code>promhttp</code>æä¾›çš„<code>Handler</code>ï¼Œä¹Ÿå…¼å®¹äº†è‡ªå·±çš„<code>helloworld</code>æ¥å£ã€‚</p><p>æ¥ç€æˆ‘ä»¬é€šè¿‡<code>cmux</code>è¿›è¡Œä¸€ä¸ªè·¯ç”±åŒ¹é…ï¼Œç„¶åè°ƒç”¨åˆ°å¯¹åº”çš„<code>ServeHTTP</code>,å¤„ç†å®Œé€»è¾‘ä¹‹åï¼Œåœ¨<code>resp</code>çš„<code>Close()</code>é˜¶æ®µï¼ŒæŠŠç¼“å­˜åŒºçš„æ‰€æœ‰<code>[]byte</code>ï¼Œæ¨é€åˆ°è¿æ¥å±‚ï¼Œç„¶åé€šè¿‡è¿”å›<code>gnet.Close</code>è¿›è¡Œç½‘ç»œå±‚çš„æ–­å¼€ï¼Œè‡³æ­¤ï¼Œä¸€ä¸ªç®€å•è€Œå®Œæ•´çš„<code>httpäº¤äº’æµç¨‹</code>å®Œæ¯•ã€‚</p><p>å¯¹äº<code>Websocket</code>åè®®æ¥è¯´ï¼Œè¦åšçš„äº‹æƒ…ä¹Ÿæ˜¯ååˆ†ç¹çï¼ˆç”±äºç”¨äº†å¼€æºåè®®åº“ï¼Œç›¸å¯¹ç®€åŒ–äº†å¾ˆå¤šï¼‰ï¼Œè¯·å…ˆçœ‹ä¸‹é¢çš„åº”ç”¨å±‚åè®®å¤„ç†é€»è¾‘ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> !cdc.connected &#123;</span><br><span class="line">        wcb := &amp;wsConnBridge&#123;</span><br><span class="line">            buff: buffer,</span><br><span class="line">            c:    c,</span><br><span class="line">        &#125;</span><br><span class="line">        _, err := ws.Upgrade(wcb)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"upgrade[%s] to websocket error: %v"</span>, c.RemoteAddr().String(), err)&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        log.Debugf(log.NetServerDebugCategory&#123;&#125;, <span class="string">"conn[%v] upgrade websocket protocol"</span>, c.RemoteAddr().String())</span><br><span class="line">        cdc.connected = <span class="literal">true</span></span><br><span class="line">        metrics.ConnectedGauge.Inc()</span><br><span class="line">        metrics.TotalConnectedCounter.WithLabelValues(WebsocketApplicationLayerProto.String()).Inc()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg, op, err := wsutil.ReadClientData(c)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> _, ok := err.(wsutil.ClosedError); !ok &#123;</span><br><span class="line">                log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"[%s] receive ws message error: %v"</span>, c.RemoteAddr().String(), err)&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> gnet.Close</span><br><span class="line">        &#125;</span><br><span class="line">        log.Debugf(log.NetServerDebugCategory&#123;&#125;, <span class="string">"conn[%v] receive [op=%v] [msg=%v]"</span>, c.RemoteAddr().String(), op, <span class="keyword">string</span>(msg))</span><br><span class="line">        <span class="keyword">if</span> op == ws.OpText &#123;</span><br><span class="line">            <span class="keyword">if</span> rs := route.MatchRequestSpec(msg); rs == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> route.GlobalWsRouter.DefaultHandler().ServeWebsocket(<span class="string">"/"</span>, msg, c, op)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> route.GlobalWsRouter.MatchHandler(rs.Path).ServeWebsocket(rs.Path, rs.Params, c, op)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡çº§åè®®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°äº†<code>github.com/gobwas/ws</code>è¿™ä¸ªåè®®åº“ã€‚</p><p>æˆ‘ä»¬åœ¨æ¥å—åˆ°<code>websocket</code>å‰çš„æ—¶å€™éœ€è¦å…ˆå‡çº§ä¸ºwebsocketåè®®ï¼Œä½†æ˜¯è¿™é‡Œé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯åŒç†ï¼Œæˆ‘ä»¬çš„<code>gnet.Conn</code>çš„æ•°æ®å·²ç»è¢«æˆ‘ä»¬å–å‡ºæ¥äº†ï¼Œè€Œå‡çº§çš„APIæ˜¾ç„¶å°±æ˜¯éœ€è¦æä¾›ä¸€ä¸ªå¯è¯»å¯å†™çš„IOã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Upgrade is like Upgrader&#123;&#125;.Upgrade().</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Upgrade</span><span class="params">(conn io.ReadWriter)</span> <span class="params">(Handshake, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> DefaultUpgrader.Upgrade(conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReadWriter is the interface that groups the basic Read and Write methods.</span></span><br><span class="line"><span class="keyword">type</span> ReadWriter <span class="keyword">interface</span> &#123;</span><br><span class="line">Reader</span><br><span class="line">Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œæˆ‘ä»¬åˆéœ€è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„<code>wsConnBridge</code>å¯¹è±¡ï¼Œä¸»è¦æ˜¯å®ç°ä¸Šè¿°çš„æ¥å£ï¼Œä½†æ˜¯è¿™ä¸ªç»“æ„ä½“ç›¸å¯¹æ¥è¯´å°±æ¯”è¾ƒç®€å•äº†ï¼Œåˆ†åˆ«ä¿å­˜ä¹‹å‰æå‡ºæ¥çš„<code>[]byte</code>çš„bufferç”¨äºè¯»è¡Œä¸ºï¼Œå†ä¿å­˜ä¸€ä¸ª<code>gnet.Conn</code>ç”¨äºå†™è¡Œä¸ºå³å¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> wsConnBridge <span class="keyword">struct</span> &#123;</span><br><span class="line">buff *bytes.Buffer</span><br><span class="line">c    gnet.Conn</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *wsConnBridge)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> w.buff.Read(p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *wsConnBridge)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> w.c.Write(p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡çº§å®Œäº†ï¼Œæˆ‘ä»¬éœ€è¦ç»™å½“å‰çš„<code>ä¸Šä¸‹æ–‡ç¯å¢ƒçš„Context</code>æ ‡è®°ä¸ºå·²ç»å‡çº§è¿æ¥å®Œæ¯•ã€‚</p><p>ç„¶åå°±æ˜¯è¿›å…¥åˆ°æ•°æ®çš„æ”¶å‘ç¯èŠ‚äº†ã€‚</p><p><code>github.com/gobwas/ws</code>æä¾›äº†<code>api</code>æ¥è¿›è¡Œæ•°æ®çš„æ”¶å‘ï¼Œåˆ†åˆ«æœ‰<code>high-level</code>å’Œ<code>low-level</code>ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬å¯ä¼˜å…ˆé€‰æ‹©<code>high-level-api</code>ï¼Œç„¶åè¯»å–æ•°æ®ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WebsocketHandler <span class="keyword">interface</span> &#123;</span><br><span class="line">ServeWebsocket(path <span class="keyword">string</span>, data []<span class="keyword">byte</span>, w io.Writer, op ws.OpCode) gnet.Action</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»å–åˆ°æ•°æ®ä¹‹åï¼Œåˆå› ä¸ºæˆ‘éœ€è¦å’Œhttpçš„routeèƒ½æœ‰ä¸€ä¸ªé«˜åº¦åŒ¹é…çš„ä»£ç å†™æ³•ï¼Œæ‰€ä»¥åœ¨è·¯ç”±åŒ¹é…ä¸Šï¼Œä¹Ÿæ˜¯åšäº†ä¸€ä¸ªç±»ä¼¼çš„<code>Match</code>çš„è¡Œä¸ºï¼Œç„¶åé€‰æ‹©åˆ°å¯¹åº”çš„<code>Handler</code>ï¼Œè§¦å‘ç»Ÿä¸€çš„<code>ServeWebsocket()</code>æ¥å£ï¼ˆä¸ºäº†å’Œhttpçš„<code>ServeHttp()</code>å¯¹åº”ï¼‰ã€‚</p><p>åˆ°æ­¤ï¼Œä»<code>ç½‘ç»œå±‚åˆ°åº”ç”¨å±‚</code>çš„<code>ç«¯å£å¤ç”¨å®ç°å¤šåè®®</code>åŸç†å°±åˆ°æ­¤ä¸ºæ­¢äº†ã€‚</p><p>æ¥ç€å°±æ˜¯å¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘æ•°æ®äº†ã€‚</p><h2 id="ä¸šåŠ¡é€»è¾‘æ¦‚è¿°"><a href="#ä¸šåŠ¡é€»è¾‘æ¦‚è¿°" class="headerlink" title="ä¸šåŠ¡é€»è¾‘æ¦‚è¿°"></a>ä¸šåŠ¡é€»è¾‘æ¦‚è¿°</h2><ol><li>è®°å½•å®¢æœéœ€è¦ç›‘æ§çš„æ•°æ®è§„åˆ™å’Œè¿æ¥å…³è”</li><li>kafka-clientä»ç›‘æ§è§„åˆ™ä¸­åŒ¹é…åˆé€‚çš„æ•°æ®ï¼Œæ¨é€åˆ°å¯¹åº”çš„fdä¸­ </li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">var</span> i <span class="keyword">int64</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">ListenChatRuleMap.Range(<span class="function"><span class="keyword">func</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> Match(key.(<span class="keyword">string</span>), kmsKey) &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(c gnet.Conn, wsp *WsSendPayload)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            err := wsutil.WriteServerMessage(c, ws.OpText, wsp.Json())</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Errorf(log.AppErrorCategory&#123;Summary: fmt.Sprintf(<span class="string">"[wsWriteServerMessage failed] [err=%v]"</span>, err)&#125;, <span class="string">"[key=%s],[data=%s]"</span>, key.(<span class="keyword">string</span>), <span class="keyword">string</span>(wsp.Json()))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            atomic.AddInt64(&amp;i, <span class="number">1</span>)</span><br><span class="line">        &#125;(value.(gnet.Conn), wsp)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line">wg.Wait()</span><br><span class="line">metrics.ChatLogCounterClientHistogram.WithLabelValues(strconv.FormatUint(<span class="keyword">uint64</span>(lrc.Pid), <span class="number">10</span>), strconv.Itoa(wsp.ServerId), strconv.Itoa(wsp.AgentId)).Observe(<span class="keyword">float64</span>(atomic.LoadInt64(&amp;i)))</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œç½‘ç»œå±‚å’Œä¸šåŠ¡å±‚çš„æ‰€æœ‰éœ€æ±‚å¤§ä½“å·²ç»å®Œæ¯•äº†ã€‚</p><h2 id="prometheus-æŒ‡æ ‡"><a href="#prometheus-æŒ‡æ ‡" class="headerlink" title="prometheus æŒ‡æ ‡"></a>prometheus æŒ‡æ ‡</h2><p>éƒ¨åˆ†çš„æŒ‡æ ‡å¦‚ä¸‹ï¼Œåç»­å¯ä»¥é€šè¿‡ä¸€äº›æŒ‡æ ‡å¯¹æœåŠ¡çš„ç¨³å®šå’Œå¯é æ€§è¿›è¡Œä¼˜åŒ–å‡çº§å¤„ç†ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># HELP chat_monitor_app_handle_chat_total Counter of handle.</span><br><span class="line"># TYPE chat_monitor_app_handle_chat_total counter</span><br><span class="line">chat_monitor_app_handle_chat_total&#123;agent_id="29",app_id="19",server_id="6558"&#125; 3</span><br><span class="line"># HELP chat_monitor_net_client_recv_counter number of chat log for client</span><br><span class="line"># TYPE chat_monitor_net_client_recv_counter histogram</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="1"&#125; 0</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="2"&#125; 0</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="4"&#125; 2</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="8"&#125; 3</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="16"&#125; 3</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="32"&#125; 3</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="64"&#125; 3</span><br><span class="line">chat_monitor_net_client_recv_counter_bucket&#123;agent_id="29",pid="1643890670000002",server_id="6558",le="+Inf"&#125; 3</span><br><span class="line">chat_monitor_net_client_recv_counter_sum&#123;agent_id="29",pid="1643890670000002",server_id="6558"&#125; 12</span><br><span class="line">chat_monitor_net_client_recv_counter_count&#123;agent_id="29",pid="1643890670000002",server_id="6558"&#125; 3</span><br><span class="line"># HELP chat_monitor_net_current_connected Current Counter Gauge of ws-connected.</span><br><span class="line"># TYPE chat_monitor_net_current_connected gauge</span><br><span class="line">chat_monitor_net_current_connected 4</span><br><span class="line"># HELP chat_monitor_net_total_connected The Total Counter of connected.</span><br><span class="line"># TYPE chat_monitor_net_total_connected counter</span><br><span class="line">chat_monitor_net_total_connected&#123;type="http"&#125; 15</span><br><span class="line">chat_monitor_net_total_connected&#123;type="websocket"&#125; 5</span><br><span class="line"># HELP chat_monitor_server_error_total Counter of error.</span><br><span class="line"># TYPE chat_monitor_server_error_total counter</span><br><span class="line">chat_monitor_server_error_total&#123;type="network_server_error"&#125; 1</span><br><span class="line"># HELP chat_monitor_server_gogc The value of GOGC</span><br><span class="line"># TYPE chat_monitor_server_gogc gauge</span><br><span class="line">chat_monitor_server_gogc 100</span><br><span class="line"># HELP chat_monitor_server_info Indicate the chat_monitor server info, and the value is the start timestamp (s).</span><br><span class="line"># TYPE chat_monitor_server_info gauge</span><br><span class="line">chat_monitor_server_info 1.644568978e+09</span><br><span class="line"># HELP chat_monitor_server_maxprocs The value of GOMAXPROCS.</span><br><span class="line"># TYPE chat_monitor_server_maxprocs gauge</span><br><span class="line">chat_monitor_server_maxprocs 6</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œä¸€äº›åŸºç¡€è€Œæ ¸å¿ƒçš„é€»è¾‘ä¹Ÿä»‹ç»å®Œäº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘ï¼Œå…¬å¸ä»¥å‰æœ‰ä¸€äº›æ—§çš„æœåŠ¡ï¼Œç”±äºå„ç§åŸå› ï¼Œå¯¼è‡´å„ç§é—®é¢˜ï¼Œå¹¶ä¸”æ¶æ„è®¾è®¡è¡Œä¹Ÿä¸æ˜¯é‚£ä¹ˆå‹å¥½å’Œä¸åˆ©äºç»´æŠ¤ã€‚&lt;br&gt;æ‰€ä»¥å‡†å¤‡é‡æ„è®¾è®¡ä¸€äº›æœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æ¸¸æˆå…¬å¸ä¸­ï¼ŒGMå®¢æœçš„å…¶ä¸­ä¸€ä¸ªèŒèƒ½å°±æ˜¯ç›‘ç£èˆ†è®ºï¼Œä»ç©å®¶å¹³æ—¥çš„èŠå¤©ä¸­è¿›è¡Œç›‘æ§ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ä»&lt;code&gt;ä¸šåŠ¡éœ€æ±‚&lt;/code&gt;+&lt;code&gt;æŠ€æœ¯æ¶æ„&lt;/code&gt;å±‚é¢è¿›è¡Œæ•´ç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>TIDBæºç å‰–æï¼ˆä¸€ï¼‰</title>
    <link href="http://blog.crazylaw.cn/2022/01/24/TIDB/TIDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://blog.crazylaw.cn/2022/01/24/TIDB/TIDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2022-01-24T02:28:33.000Z</published>
    <updated>2022-01-25T03:01:50.165Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>è¿™ä¸€ç« ï¼Œä½œä¸ºæˆ‘ä»¬çš„èµ·å§‹ç« èŠ‚ï¼Œè·Ÿç€æºç ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ç†Ÿæ‚‰TIDBçš„æ•´ä½“ä»£ç ç»“æ„</p><hr><a id="more"></a><h2 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h2><p>å½“æˆ‘ä»¬æœ‰ä¸€æ¡åŸºæœ¬çš„sqlå¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mysql.user;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥å¼€å§‹ï¼Œ<code>æ‰§è¡Œ</code>ï¼Œ<code>è§£æ</code>ï¼Œ<code>é€»è¾‘ä¼˜åŒ–å™¨</code>ï¼Œ<code>ç‰©ç†ä¼˜åŒ–å™¨</code>ï¼Œåˆ°<code>æœ€ç»ˆç»“æœ</code>å¼€å§‹åˆ†æã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;planner.optimize at optimize.go:335</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;planner.Optimize at optimize.go:211</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;executor.(*Compiler).Compile at compiler.go:77</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;session.(*session).ExecuteStmt at session.go:1696</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*TiDBContext).ExecuteStmt at driver_tidb.go:220</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).handleStmt at conn.go:1977</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).handleQuery at conn.go:1846</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).dispatch at conn.go:1341</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).Run at conn.go:1091</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*Server).onConn at server.go:556</span><br><span class="line">runtime.goexit at asm_amd64.s:1371</span><br><span class="line"> - Async stack trace</span><br><span class="line">github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*Server).startNetworkListener at server.go:453</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬è·Ÿç€è¿™ä¸€æ®µå †æ ˆæ¥è¿›è¡Œåˆ†æã€‚</p><h2 id="github-com-pingcap-tidb-server-Server-onConn-at-server-go-è¿æ¥å¤„ç†é€»è¾‘"><a href="#github-com-pingcap-tidb-server-Server-onConn-at-server-go-è¿æ¥å¤„ç†é€»è¾‘" class="headerlink" title="github.com/pingcap/tidb/server.(*Server).onConn at server.go (è¿æ¥å¤„ç†é€»è¾‘)"></a>github.com/pingcap/tidb/server.(*Server).onConn at server.go (è¿æ¥å¤„ç†é€»è¾‘)</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conn.Run(ctx)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¿™æ˜¯è¿›å…¥åˆ°äº†ä¸€ä¸ª<code>clientConn</code>çš„ <code>Run</code> æ–¹æ³•ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run reads client query and writes query result to client in for loop, if there is a panic during query handling,</span></span><br><span class="line"><span class="comment">// it will be recovered and log the panic error.</span></span><br><span class="line"><span class="comment">// This function returns and the connection is closed if there is an IO error or there is a panic.</span></span><br><span class="line"><span class="comment">// åœ¨forå¾ªç¯ä¸­ï¼Œæ‰§è¡Œè¯»å–å®¢æˆ·ç«¯æŸ¥è¯¢ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœå†™å…¥å®¢æˆ·ç«¯ï¼Œå¦‚æœåœ¨å¤„ç†æŸ¥è¯¢æ—¶å‡ºç°panicï¼Œ</span></span><br><span class="line"><span class="comment">// å®ƒå°†è¢«æ¢å¤å¹¶è®°å½•panicé”™è¯¯ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœå‡ºç°IOé”™è¯¯æˆ–panicï¼Œè¯¥å‡½æ•°è¿”å›å¹¶å…³é—­è¿æ¥ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cc *clientConn)</span> <span class="title">Run</span><span class="params">(ctx context.Context)</span></span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†æœ‰ä¸€æ®µæ–‡å­—å¸®åŠ©æˆ‘ä»¬ç†è§£æ³¨æ„äº‹é¡¹ã€‚</p><p>æˆ‘ä»¬æŒ‰ç…§è¿‡ç¨‹å¼çš„é¡ºåºæ¥ä»ä¸Šå¾€ä¸‹çœ‹æºç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">const</span> size = <span class="number">4096</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := <span class="built_in">recover</span>()</span><br><span class="line"><span class="keyword">if</span> r != <span class="literal">nil</span> &#123;</span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, size)</span><br><span class="line">stackSize := runtime.Stack(buf, <span class="literal">false</span>)</span><br><span class="line">buf = buf[:stackSize]</span><br><span class="line">logutil.Logger(ctx).Error(<span class="string">"connection running loop panic"</span>,</span><br><span class="line">zap.Stringer(<span class="string">"lastSQL"</span>, getLastStmtInConn&#123;cc&#125;),</span><br><span class="line">zap.String(<span class="string">"err"</span>, fmt.Sprintf(<span class="string">"%v"</span>, r)),</span><br><span class="line">zap.String(<span class="string">"stack"</span>, <span class="keyword">string</span>(buf)),</span><br><span class="line">)</span><br><span class="line">err := cc.writeError(ctx, errors.New(fmt.Sprintf(<span class="string">"%v"</span>, r)))</span><br><span class="line">terror.Log(err)</span><br><span class="line">metrics.PanicCounter.WithLabelValues(metrics.LabelSession).Inc()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> atomic.LoadInt32(&amp;cc.status) != connStatusShutdown &#123;</span><br><span class="line">err := cc.Close()</span><br><span class="line">terror.Log(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å‡ ç‚¹ã€‚</p><ul><li>é€šè¿‡ <code>recover()</code> æ–¹æ³•æ¥é˜»æ­¢<code>panic</code>å¼•èµ·çš„ç¨‹åºå¼‚å¸¸å´©æºƒï¼Œå¦‚æœæ˜¯panicçš„è¯ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰ä¸€æ®µç‰¹æ®Šçš„é€»è¾‘å¤„ç†<br>  1.1 é€šè¿‡ <code>runtime.Stack(buf,false)</code> çš„ç¬¬äºŒä¸ªå‚æ•°æ¥æ§åˆ¶åªè·å–å½“å‰åç¨‹ä¸‹çš„å †æ ˆä¿¡æ¯ï¼Œå¹¶ä¸”å†™å…¥åˆ°<code>buf</code>å˜é‡ä¸­<br>  1.2 ç”±äº <code>const size = 4096</code> çš„åŸå› ï¼Œæˆ‘ä»¬æ‹¿åˆ°çš„bufæœªå¿…æ˜¯é‚£ä¹ˆå¤šï¼Œå› æ­¤ï¼Œé€šè¿‡ <code>buf[:stackSize]</code> æ¥è¿›è¡Œåˆ‡ç‰‡å¤„ç†ï¼ŒæŠŠå˜é‡çš„æŒ‡é’ˆé‡æ–°æŒ‡å‘æ–°çš„æ•°æ®åŒºåŸŸ<br>  1.3 é€šè¿‡æ—¥å¿—ç»„ä»¶æ¥è®°å½•è¯¦ç»†ä¿¡æ¯ï¼Œ æœ‰æ„æ€çš„æ˜¯ï¼Œè¿™é‡Œé€šè¿‡äº†<code>getLastStmtInConnç»“æ„ä½“</code>é‡Œé¢çš„<code>String()</code>æ–¹æ³•æ¥è¿›è¡Œåºåˆ—åŒ–è‡ªå·±æƒ³è¦çš„å†…å®¹ä¿¡æ¯ï¼Œå…¶ä»–çš„å°±æ˜¯åŸºæœ¬çš„<code>err</code>, <code>stack</code>çš„ä¿¡æ¯äº†<br>  1.4 æˆ‘ä»¬ä¸å•å•éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šè®°å½•ä¿¡æ¯ï¼Œè¿˜è¦æŠŠå¯¹åº”çš„ç”¨æˆ·é”™è¯¯ä¿¡æ¯ä¹Ÿè®°å½•ä¸‹æ¥å¹¶ä¸”å‘é€ç»™å®¢æˆ·ç«¯ã€‚æ‰€ä»¥é€šè¿‡äº† <code>err := cc.writeError(ctx, errors.New(fmt.Sprintf(&quot;%v&quot;, r)))</code> æ¥å®ç°è¿™ä¸€ç‚¹ã€‚<br>  1.5 ç„¶åå°±æ˜¯è®°å½•ç›¸å…³çš„<code>metrics</code>ï¼Œå› ä¸ºå‘ç”Ÿäº†ä¸€æ¬¡ <code>panic</code>ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡<code>PanicCounter</code>è®°å½•ä¸‹æ¥ï¼Œç”¨äºç»Ÿè®¡ç”±äº<code>session</code>å¼•èµ·çš„<code>panic</code>æ€»å…±æœ‰å¤šå°‘æ¬¡</li><li>å¦‚æœæ˜¯épanicå¼•èµ·çš„å‡½æ•°ææ„ï¼Œé‚£ä¹ˆè¿˜è¦é€šè¿‡åŸå­æ€§è‰èµ°æ¥åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸ºå…³é—­çŠ¶æ€ï¼Œå¦‚æœæ˜¯å…³é—­çŠ¶æ€ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±éœ€è¦æŠŠè¿æ¥æ–­å¼€ï¼Œå¹¶ä¸”è®°å½•ä¸‹é”™è¯¯ä¿¡æ¯</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Usually, client connection status changes between [dispatching] &lt;=&gt; [reading].</span></span><br><span class="line"><span class="comment">// When some event happens, server may notify this client connection by setting</span></span><br><span class="line"><span class="comment">// the status to special values, for example: kill or graceful shutdown.</span></span><br><span class="line"><span class="comment">// The client connection would detect the events when it fails to change status</span></span><br><span class="line"><span class="comment">// by CAS operation, it would then take some actions accordingly.</span></span><br><span class="line"><span class="comment">// é€šå¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¿æ¥çŠ¶æ€åœ¨[dispatching] &lt;=&gt; [reading]ä¹‹é—´å˜åŒ–ã€‚</span></span><br><span class="line"><span class="comment">// å½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡è®¾ç½®æ¥é€šçŸ¥è¿™ä¸ªå®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line"><span class="comment">// å°†çŠ¶æ€è®¾ç½®ä¸ºç‰¹æ®Šå€¼ï¼Œä¾‹å¦‚:killæˆ–graceful shutdownã€‚</span></span><br><span class="line"><span class="comment">// å½“CASæ“ä½œæ”¹å˜çŠ¶æ€å¤±è´¥æ—¶ï¼Œå®¢æˆ·ç«¯è¿æ¥å°†æ£€æµ‹åˆ°äº‹ä»¶ï¼Œç„¶åé‡‡å–ç›¸åº”çš„åŠ¨ä½œã€‚</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !atomic.CompareAndSwapInt32(&amp;cc.status, connStatusDispatching, connStatusReading) ||</span><br><span class="line"><span class="comment">// The judge below will not be hit by all means,</span></span><br><span class="line"><span class="comment">// But keep it stayed as a reminder and for the code reference for connStatusWaitShutdown.</span></span><br><span class="line">atomic.LoadInt32(&amp;cc.status) == connStatusWaitShutdown &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªå¾ªç¯æ“ä½œï¼Œå¹¶ä¸”é€šè¿‡åŸå­æ€§æ“ä½œ<code>atomic.CompareAndSwapInt32</code>ï¼ˆæ¯”è¾ƒç„¶åå†äº¤æ¢ï¼Œæ‰€ä»¥ç¬¦åˆCASåŸåˆ™ï¼Œä¹è§‚é”ï¼‰æ¥åˆ¤æ–­sessionè¿æ¥æ˜¯å¦èƒ½æ˜¯å¦èƒ½åˆ‡æ¢åˆ°<code>connStatusDispatching</code> =&gt; <code>connStatusReading</code> çŠ¶æ€</li><li>å¦‚æœä¸å¯ä»¥åˆ‡æ¢ï¼Œé‚£ä¹ˆåˆ™ç»“æŸè¯¥æ–¹æ³•</li><li>å¦‚æœè¿æ¥çŠ¶æ€ä¸ºç­‰å¾…å…³é—­çŠ¶æ€ï¼Œé‚£ä¹ˆä¹Ÿç»“æŸè¯¥æ–¹æ³•</li></ul><p>å¯¹äºå…¶ä¸­çš„ <code>...</code>ï¼Œç°åœ¨ä¼šåœ¨ä¸‹é¢è¿›ä¸€æ­¥è¯´æ˜ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cc.alloc.Reset()</span><br><span class="line"><span class="comment">// close connection when idle time is more than wait_timeout</span></span><br><span class="line">waitTimeout := cc.getSessionVarsWaitTimeout(ctx)</span><br><span class="line">cc.pkt.setReadTimeout(time.Duration(waitTimeout) * time.Second)</span><br><span class="line">start := time.Now()</span><br><span class="line">data, err := cc.readPacket()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> terror.ErrorNotEqual(err, io.EOF) &#123;</span><br><span class="line"><span class="keyword">if</span> netErr, isNetErr := errors.Cause(err).(net.Error); isNetErr &amp;&amp; netErr.Timeout() &#123;</span><br><span class="line">idleTime := time.Since(start)</span><br><span class="line">logutil.Logger(ctx).Info(<span class="string">"read packet timeout, close this connection"</span>,</span><br><span class="line">zap.Duration(<span class="string">"idle"</span>, idleTime),</span><br><span class="line">zap.Uint64(<span class="string">"waitTimeout"</span>, waitTimeout),</span><br><span class="line">zap.Error(err),</span><br><span class="line">)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">errStack := errors.ErrorStack(err)</span><br><span class="line"><span class="keyword">if</span> !strings.Contains(errStack, <span class="string">"use of closed network connection"</span>) &#123;</span><br><span class="line">logutil.Logger(ctx).Warn(<span class="string">"read packet failed, close this connection"</span>,</span><br><span class="line">zap.Error(errors.SuspendStack(err)))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">disconnectByClientWithError.Inc()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>cc.alloc.Reset()</code>é‡ç½®å†…å­˜æ± å¤§å°</li><li>å½“ç©ºé—²æ—¶é—´å¤§äºç­‰å¾…è¶…æ—¶æ—¶é—´çš„è¯é‚£ä¹ˆå°†ä¼šå…³é—­ä¸½è¿æ¥ã€‚<code>cc.pkt.setReadTimeout(time.Duration(waitTimeout) * time.Second)</code></li><li>ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼Œå¦‚æœå­˜åœ¨é”™è¯¯ï¼Œé‚£ä¹ˆå°†ä¼šè®°å½•ä¸‹æ¥ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ä»è¯»å–æ•°æ®åˆ°æœ€åçš„æ—¶é—´ï¼Œæ¥ç»Ÿè®¡idletimeï¼Œé€šè¿‡<code>metrics.DisconnectionCounter.WithLabelValues(metrics.LblError)</code>æ¥è®°å½•å› ä¸ºerrå¯¼è‡´è¿æ¥æ–­å¼€çš„æ¬¡æ•°</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> !atomic.CompareAndSwapInt32(&amp;cc.status, connStatusReading, connStatusDispatching) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒç†ï¼Œç»è¿‡casä¹è§‚é”ï¼ŒæŠŠçŠ¶æ€ä» <code>connStatusReading</code> =&gt; <code>connStatusDispatching</code>å¦‚æœï¼Œäº¤æ¢è®¾ç½®å¤±è´¥ï¼Œé‚£ä¹ˆå°±ç»“æŸå‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startTime := time.Now()</span><br><span class="line">err = cc.dispatch(ctx, data)</span><br></pre></td></tr></table></figure><h2 id="github-com-pingcap-tidb-server-clientConn-dispatch-ï¼ˆåˆ†å‘é€»è¾‘ï¼‰"><a href="#github-com-pingcap-tidb-server-clientConn-dispatch-ï¼ˆåˆ†å‘é€»è¾‘ï¼‰" class="headerlink" title="github.com/pingcap/tidb/server.(*clientConn).dispatch ï¼ˆåˆ†å‘é€»è¾‘ï¼‰"></a>github.com/pingcap/tidb/server.(*clientConn).dispatch ï¼ˆåˆ†å‘é€»è¾‘ï¼‰</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dispatch handles client request based on command which is the first byte of the data.</span></span><br><span class="line"><span class="comment">// It also gets a token from server which is used to limit the concurrently handling clients.</span></span><br><span class="line"><span class="comment">// The most frequently used command is ComQuery.</span></span><br><span class="line"><span class="comment">// dispatchæ ¹æ®å‘½ä»¤å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå‘½ä»¤æ˜¯æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚</span></span><br><span class="line"><span class="comment">// å®ƒä¹Ÿä»æœåŠ¡å™¨è·å–ä¸€ä¸ªä»¤ç‰Œï¼Œç”¨äºé™åˆ¶å¹¶å‘å¤„ç†å®¢æˆ·ç«¯ã€‚</span></span><br><span class="line"><span class="comment">// æœ€å¸¸ç”¨çš„å‘½ä»¤æ˜¯ComQueryã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cc *clientConn)</span> <span class="title">dispatch</span><span class="params">(ctx context.Context, data []<span class="keyword">byte</span>)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„æ–¹æ³•éƒ½æ˜¯dispatchçš„è¿‡ç¨‹é¡ºåºé€»è¾‘</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// reset killed for each request</span></span><br><span class="line">atomic.StoreUint32(&amp;cc.ctx.GetSessionVars().Killed, <span class="number">0</span>)</span><br><span class="line">&#125;()</span><br><span class="line">t := time.Now()</span><br><span class="line"><span class="keyword">if</span> (cc.ctx.Status() &amp; mysql.ServerStatusInTrans) &gt; <span class="number">0</span> &#123;</span><br><span class="line">connIdleDurationHistogramInTxn.Observe(t.Sub(cc.lastActive).Seconds())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">connIdleDurationHistogramNotInTxn.Observe(t.Sub(cc.lastActive).Seconds())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™é‡Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªdeferï¼Œå½“å‡½æ•°ç»“æŸçš„æ—¶å€™ï¼Œä¼šé‡ç½®sessionçš„Killedæ¬¡æ•°</li><li><code>cc.ctx.Status() &amp; mysql.ServerStatusInTrans</code> è¿™é‡Œå› ä¸ºå…¼å®¹äº†mysqlçš„æ— çŠ¶æ€åè®®ï¼Œæ‰€ä»¥é€šè¿‡ç¬¬ä¸€ä¸ª<code>ä½è¿ç®—</code>æ¥åˆ¤æ–­å½“å‰çŠ¶æ€<ol><li>å¦‚æœå½“å‰é“¾æ¥å¤„äºä¸€ä¸ª<code>äº‹åŠ¡</code>çŠ¶æ€ä¸‹çš„è¯ï¼Œé‚£ä¹ˆé€šè¿‡<code>connIdleDurationHistogramInTxn.Observe(t.Sub(cc.lastActive).Seconds())</code> ç”¨ç›´æ–¹å›¾ç›‘æ§ä»æœ€åä¸€æ¬¡æ´»è·ƒæ—¶é—´åˆ°å½“å‰åˆ†å‘æ—¶é—´</li><li>å¦åˆ™åˆ™ç”¨å¦ä¸€ä¸ª<code>metrics</code>æ¥è®°å½•</li></ol></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">span := opentracing.StartSpan(<span class="string">"server.dispatch"</span>)</span><br><span class="line">cfg := config.GetGlobalConfig()</span><br><span class="line"><span class="keyword">if</span> cfg.OpenTracing.Enable &#123;</span><br><span class="line">ctx = opentracing.ContextWithSpan(ctx, span)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cancelFunc context.CancelFunc</span><br><span class="line">ctx, cancelFunc = context.WithCancel(ctx)</span><br><span class="line">cc.mu.Lock()</span><br><span class="line">cc.mu.cancelFunc = cancelFunc</span><br><span class="line">cc.mu.Unlock()</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡<code>opentracing</code>æ¥å¼€å§‹è¿›è¡Œ<code>åˆ†å¸ƒå¼è¿½è¸ª</code>ï¼Œ<code>cc.mu</code> ä¸»è¦æ˜¯ç”¨æ¥åœ¨<code>äº‹åŠ¡</code>ä¸­å–æ¶ˆäº‹åŠ¡ç”¨çš„ã€‚</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cc.lastPacket = data</span><br><span class="line">cmd := data[<span class="number">0</span>]</span><br><span class="line">data = data[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">if</span> topsqlstate.TopSQLEnabled() &#123;</span><br><span class="line"><span class="keyword">defer</span> pprof.SetGoroutineLabels(ctx)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> variable.EnablePProfSQLCPU.Load() &#123;</span><br><span class="line">label := getLastStmtInConn&#123;cc&#125;.PProfLabel()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(label) &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> pprof.SetGoroutineLabels(ctx)</span><br><span class="line">ctx = pprof.WithLabels(ctx, pprof.Labels(<span class="string">"sql"</span>, label))</span><br><span class="line">pprof.SetGoroutineLabels(ctx)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æŠŠå½“å‰sessionæ¥æ”¶åˆ°çš„æ•°æ®è®°å½•åœ¨<code>lastPakcet</code>ä¸­</li><li><code>ç¬¬ä¸€ä¸ªå­—èŠ‚</code>ä»£è¡¨<code>å‘½ä»¤</code></li><li><code>åé¢çš„å­—èŠ‚</code>ä»£è¡¨<code>æ•°æ®</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">token := cc.server.getToken()</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// if handleChangeUser failed, cc.ctx may be nil</span></span><br><span class="line"><span class="keyword">if</span> cc.ctx != <span class="literal">nil</span> &#123;</span><br><span class="line">cc.ctx.SetProcessInfo(<span class="string">""</span>, t, mysql.ComSleep, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cc.server.releaseToken(token)</span><br><span class="line">span.Finish()</span><br><span class="line">cc.lastActive = time.Now()</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦å…³æ³¨ä¸€ä¸‹<code>defer</code>é‡Œé¢çš„å†…å®¹</p><ul><li>æ ¹æ®mysqlåè®®ï¼Œå½“å‘½ä»¤ä¸º<code>mysql.ComSleep</code>çš„æ—¶å€™ï¼Œä»£è¡¨executeå·²ç»å®Œæˆäº†ã€‚æ‰€ä»¥å½“ç»“æŸçš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸‹è¿™ä¸ª<code>ProcessInfo</code></li><li>ç„¶åé‡Šæ”¾æœ¬æ¬¡tokenï¼Œå¹¶ä¸”spanä¹Ÿéœ€è¦æ ‡è®°ä¸ºå®Œæˆ</li><li>æ›´æ–°æœ€åä¸€æ¬¡æ´»è·ƒæ—¶é—´</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vars := cc.ctx.GetSessionVars()</span><br><span class="line"><span class="comment">// reset killed for each request</span></span><br><span class="line">atomic.StoreUint32(&amp;vars.Killed, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">if</span> cmd &lt; mysql.ComEnd &#123;</span><br><span class="line">cc.ctx.SetCommandValue(cmd)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è·å–å½“å‰sessionçš„å˜é‡</li><li>é‡ç½®å…¶ä¸­çš„killedå±æ€§</li><li>å¦‚æœ<code>cmd</code>åœ¨èŒƒå›´å†…çš„ï¼Œæ›´æ–°å½“å‰å‘½ä»¤çš„å€¼</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dataStr := <span class="keyword">string</span>(hack.String(data))</span><br><span class="line"><span class="keyword">switch</span> cmd &#123;</span><br><span class="line"><span class="keyword">case</span> mysql.ComPing, mysql.ComStmtClose, mysql.ComStmtSendLongData, mysql.ComStmtReset,</span><br><span class="line">mysql.ComSetOption, mysql.ComChangeUser:</span><br><span class="line">cc.ctx.SetProcessInfo(<span class="string">""</span>, t, cmd, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">case</span> mysql.ComInitDB:</span><br><span class="line">cc.ctx.SetProcessInfo(<span class="string">"use "</span>+dataStr, t, cmd, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™é‡Œåˆ©ç”¨äº†golangç§çš„<code>hackï¼ˆé»‘ç§‘æŠ€ï¼‰</code>çš„æ–¹å¼æ¥æŠŠ<code>byte</code>è½¬æ¢æˆ<code>string</code>ï¼Œå…¶å®ä¸»è¦å°±æ˜¯å› ä¸ºåº•å±‚ç”¨çš„éƒ½æœ‰ä¸€æ ·çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡<code>unsafe.pointer</code>æ¥ç›´æ¥æ“ä½œå†…å®¹æŒ‡é’ˆï¼Œè¿›è¡Œ<code>zero-copy</code></li><li>å¯¹cmdè¿›è¡Œ<code>processinfo</code>çš„å¤„ç†ï¼Œå¦‚æœæ˜¯<code>use db</code>çš„å‘½ä»¤çš„è¯ï¼Œåˆ™éœ€è¦ä¼ é€’æ•°æ®åº“</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> cmd &#123;</span><br><span class="line"><span class="keyword">case</span> mysql.ComSleep:</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> According to mysql document, this command is supposed to be used only internally.</span></span><br><span class="line"><span class="comment">// So it's just a temp fix, not sure if it's done right.</span></span><br><span class="line"><span class="comment">// Investigate this command and write test case later.</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> mysql.ComQuit:</span><br><span class="line"><span class="keyword">return</span> io.EOF</span><br><span class="line"><span class="keyword">case</span> mysql.ComInitDB:</span><br><span class="line"><span class="keyword">if</span> err := cc.useDB(ctx, dataStr); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cc.writeOK(ctx)</span><br><span class="line"><span class="keyword">case</span> mysql.ComQuery: <span class="comment">// Most frequently used command.</span></span><br><span class="line"><span class="comment">// For issue 1989</span></span><br><span class="line"><span class="comment">// Input payload may end with byte '\0', we didn't find related mysql document about it, but mysql</span></span><br><span class="line"><span class="comment">// implementation accept that case. So trim the last '\0' here as if the payload an EOF string.</span></span><br><span class="line"><span class="comment">// See http://dev.mysql.com/doc/internals/en/com-query.html</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; <span class="number">0</span> &amp;&amp; data[<span class="built_in">len</span>(data)<span class="number">-1</span>] == <span class="number">0</span> &#123;</span><br><span class="line">data = data[:<span class="built_in">len</span>(data)<span class="number">-1</span>]</span><br><span class="line">dataStr = <span class="keyword">string</span>(hack.String(data))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> cc.handleQuery(ctx, dataStr)</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å¤åˆ¶äº†ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºæˆ‘ä»¬é‡ç‚¹å…³æ³¨<code>mysql.ComQuery</code>å‘½ä»¤ã€‚</p><ul><li>æ ¹æ®æç¤ºï¼Œæˆ‘ä»¬å‘ç°å› ä¸ºmysqlåè®®è¯´æ˜äº†è¾“å…¥è½½ä½“å¯èƒ½ä»¥<code>\0</code>ä½œä¸ºæœ€åå­—èŠ‚ï¼Œæ‰€ä»¥è¿™é‡Œä¸€å®šè¦å‡å»clientå‘é€çš„å¤šä½™çš„æœ€åä¸€ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥é•¿åº¦è¿›è¡Œäº†-1æ“ä½œ</li><li>ç„¶åè¿›å…¥åˆ°<code>cc.handleQuery(ctx, dataStr)</code></li></ul><h2 id="github-com-pingcap-tidb-server-clientConn-handleQuery"><a href="#github-com-pingcap-tidb-server-clientConn-handleQuery" class="headerlink" title="github.com/pingcap/tidb/server.(*clientConn).handleQuery"></a>github.com/pingcap/tidb/server.(*clientConn).handleQuery</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handleQuery executes the sql query string and writes result set or result ok to the client.</span></span><br><span class="line"><span class="comment">// As the execution time of this function represents the performance of TiDB, we do time log and metrics here.</span></span><br><span class="line"><span class="comment">// There is a special query `load data` that does not return result, which is handled differently.</span></span><br><span class="line"><span class="comment">// Query `load stats` does not return result either.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cc *clientConn)</span> <span class="title">handleQuery</span><span class="params">(ctx context.Context, sql <span class="keyword">string</span>)</span> <span class="params">(err error)</span></span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•ï¼Œç»ˆäºå¼€å§‹æ­£å¼è¿›å…¥æˆ‘ä»¬çš„ä¸»é¢˜äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> trace.StartRegion(ctx, <span class="string">"handleQuery"</span>).End()</span><br><span class="line">sc := cc.ctx.GetSessionVars().StmtCtx</span><br><span class="line">prevWarns := sc.GetWarnings()</span><br><span class="line">stmts, err := cc.ctx.Parse(ctx, sql)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(stmts) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> cc.writeOK(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>deferè¿›è¡Œäº†å½“å‡½æ•°ç»“æŸçš„æ—¶å€™ï¼Œæ ‡è®°<code>handleQuery</code>ç»“æŸ</li><li>æ‹¿åˆ°<code>statement</code>çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</li><li>ä»ä¸Šä¸‹æ–‡ä¸­æ‹¿åˆ°æ‰€æœ‰çš„<code>warinning</code>è­¦å‘Š</li><li>é€šè¿‡<code>cc.ctx.Parse(ctx, sql)</code>æ¥è¿›è¡Œè§£æsqlï¼Œè¿™é‡Œå±äºä¸€ä¸ªå¤§çš„ç¯‡ç« ï¼Œæš‚æ—¶ä¸å¼ å¼€è®²ï¼Œä¸»è¦æ¶‰åŠåˆ°çš„å†…å®¹æœ‰<code>ç¼–è¯‘åŸç†</code>,<code>AST-Tree</code>ï¼Œ<code>Yacc</code>ã€‚æˆ‘ä»¬é€šè¿‡è¿™é‡Œå¯ä»¥æ‹¿åˆ°ä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘ï¼Œå®è´¨æ˜¯<code>SelectStmt</code>ï¼Œå†…éƒ¨åŒ…å«äº†å¦‚ä¸‹å†…å®¹ï¼š<ol><li>dmlNodeï¼ˆå› ä¸ºselectè¯­å¥å±äºdmlè¯­å¥ï¼‰</li><li>å…¶ä»–çš„éƒ½æ˜¯å¸¸è§„çš„ä¾‹å¦‚<code>FROM</code>, <code>WHERE</code>, <code>FIELDS</code>, <code>DISTINCT</code> ç­‰ç­‰</li></ol></li><li>å¦‚æœæ²¡æœ‰ä¸€ä¸ªå®Œæˆçš„æŠ½è±¡è¯­æ³•ä¹¦ï¼Œåˆ™ç›´æ¥è¿”å›å“åº”åè®®å’Œå¯¹åº”çš„å†…å®¹</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pointPlans []plannercore.Plan</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(stmts) &gt; <span class="number">1</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The client gets to choose if it allows multi-statements, and</span></span><br><span class="line"><span class="comment">// probably defaults OFF. This helps prevent against SQL injection attacks</span></span><br><span class="line"><span class="comment">// by early terminating the first statement, and then running an entirely</span></span><br><span class="line"><span class="comment">// new statement.</span></span><br><span class="line"></span><br><span class="line">capabilities := cc.ctx.GetSessionVars().ClientCapability</span><br><span class="line"><span class="keyword">if</span> capabilities&amp;mysql.ClientMultiStatements &lt; <span class="number">1</span> &#123;</span><br><span class="line"><span class="comment">// The client does not have multi-statement enabled. We now need to determine</span></span><br><span class="line"><span class="comment">// how to handle an unsafe situation based on the multiStmt sysvar.</span></span><br><span class="line"><span class="keyword">switch</span> cc.ctx.GetSessionVars().MultiStatementMode &#123;</span><br><span class="line"><span class="keyword">case</span> variable.OffInt:</span><br><span class="line">err = errMultiStatementDisabled</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line"><span class="keyword">case</span> variable.OnInt:</span><br><span class="line"><span class="comment">// multi statement is fully permitted, do nothing</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">warn := stmtctx.SQLWarn&#123;Level: stmtctx.WarnLevelWarning, Err: errMultiStatementDisabled&#125;</span><br><span class="line">parserWarns = <span class="built_in">append</span>(parserWarns, warn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only pre-build point plans for multi-statement query</span></span><br><span class="line">pointPlans, err = cc.prefetchPointPlanKeys(ctx, stmts)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡Sessionä¸­çš„varä¸­çš„<code>ClientCapability</code>çš„<code>ä½è¿ç®—</code>æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒ<code>mysql.ClientMultiStatements</code>ï¼ˆå¤šsqlè¯­å¥ï¼‰</li><li>å¦‚æœ<code>sysvar</code>ä¹Ÿä¸æ”¯æŒ<code>MultiStatementMode</code>,ä¹Ÿå°±æ˜¯<code>variable.OffInt</code>ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›err</li><li>å¦‚æœæ²¡æœ‰èƒ½åŠ›æ”¯æŒclientå¤šstatementçš„è¯ï¼Œä½†æ˜¯varåˆå¼€å¯äº†çš„è¯ï¼Œç›®å‰å•¥äº‹ä¹Ÿæ²¡åš</li><li>é»˜è®¤å°±æ˜¯ä¸æ”¯æŒï¼Œä½†æ˜¯ä¼šé€šè¿‡warnæ¥å±•ç¤ºç»™å®¢æˆ·ç«¯</li><li>åªæœ‰åœ¨å¤šstatementçš„åœºæ™¯ä¸‹é¢„å–ç›®æ ‡è®¡åˆ’å…³é”®å­—</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i, stmt := <span class="keyword">range</span> stmts &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(pointPlans) &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// Save the point plan in Session, so we don't need to build the point plan again.</span></span><br><span class="line">cc.ctx.SetValue(plannercore.PointPlanKey, plannercore.PointPlanVal&#123;Plan: pointPlans[i]&#125;)</span><br><span class="line">&#125;</span><br><span class="line">retryable, err = cc.handleStmt(ctx, stmt, parserWarns, i == <span class="built_in">len</span>(stmts)<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !retryable || !errors.ErrorEqual(err, storeerr.ErrTiFlashServerTimeout) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">_, allowTiFlashFallback := cc.ctx.GetSessionVars().AllowFallbackToTiKV[kv.TiFlash]</span><br><span class="line"><span class="keyword">if</span> !allowTiFlashFallback &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// When the TiFlash server seems down, we append a warning to remind the user to check the status of the TiFlash</span></span><br><span class="line"><span class="comment">// server and fallback to TiKV.</span></span><br><span class="line">warns := <span class="built_in">append</span>(parserWarns, stmtctx.SQLWarn&#123;Level: stmtctx.WarnLevelError, Err: err&#125;)</span><br><span class="line"><span class="built_in">delete</span>(cc.ctx.GetSessionVars().IsolationReadEngines, kv.TiFlash)</span><br><span class="line">_, err = cc.handleStmt(ctx, stmt, warns, i == <span class="built_in">len</span>(stmts)<span class="number">-1</span>)</span><br><span class="line">cc.ctx.GetSessionVars().IsolationReadEngines[kv.TiFlash] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæœ‰ç›®æ ‡è®¡åˆ’çš„è¯ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®valueå³å¯ï¼Œä¸éœ€è¦å†æ¬¡æ„å»ºç›®æ ‡è®¡åˆ’</li><li><code>cc.handleStmt(ctx, stmt, parserWarns, i == len(stmts)-1)</code> è¿™æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼Œè¿™é‡Œé¢å°±æ˜¯å¤„ç†<code>æŠ½è±¡è¯­æ³•æ ‘</code>çš„é€»è¾‘ï¼ŒåŒ…å«äº†<code>é€»è¾‘ä¼˜åŒ–</code>, <code>ç‰©ç†ä¼˜åŒ–</code>, <code>æ‰§è¡Œå™¨</code>ï¼Œ<code>tikv</code>äº¤äº’ç­‰ç­‰</li><li>todoï¼šç•™ç€å›æ¥åˆ†æ</li></ul><h2 id="github-com-pingcap-tidb-server-clientConn-handleStmt"><a href="#github-com-pingcap-tidb-server-clientConn-handleStmt" class="headerlink" title="github.com/pingcap/tidb/server.(*clientConn).handleStmt"></a>github.com/pingcap/tidb/server.(*clientConn).handleStmt</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The first return value indicates whether the call of handleStmt has no side effect and can be retried.</span></span><br><span class="line"><span class="comment">// Currently, the first return value is used to fall back to TiKV when TiFlash is down.</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªè¿”å›å€¼è¡¨ç¤ºè°ƒç”¨handleStmtæ˜¯å¦æ²¡æœ‰å‰¯ä½œç”¨ï¼Œæ˜¯å¦å¯ä»¥é‡è¯•</span></span><br><span class="line"><span class="comment">// å½“å‰ï¼Œç¬¬ä¸€ä¸ªè¿”å›å€¼ç”¨äºåœ¨TiFlash downæ—¶å›è½åˆ°TiKV</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cc *clientConn)</span> <span class="title">handleStmt</span><span class="params">(ctx context.Context, stmt ast.StmtNode, warns []stmtctx.SQLWarn, lastStmt <span class="keyword">bool</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span></span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx = context.WithValue(ctx, execdetails.StmtExecDetailKey, &amp;execdetails.StmtExecDetails&#123;&#125;)</span><br><span class="line">ctx = context.WithValue(ctx, util.ExecDetailsKey, &amp;util.ExecDetails&#123;&#125;)</span><br><span class="line">reg := trace.StartRegion(ctx, <span class="string">"ExecuteStmt"</span>)</span><br><span class="line">cc.audit(plugin.Starting)</span><br><span class="line">rs, err := cc.ctx.ExecuteStmt(ctx, stmt)</span><br></pre></td></tr></table></figure><ul><li>ä¸Šä¸‹æ–‡å¸¦ä¸Švalueï¼Œè®¾ç½®ä¸»è¦æ˜¯<code>StmtExecDetails</code>ï¼Œé‡Œé¢è®°å½•äº†å†™å…¥sqlåˆ°å“åº”çš„æ—¶é—´</li><li>ä¸Šä¸‹æ–‡å¸¦ä¸Švalueï¼Œè®¾ç½®ä¸»è¦æ˜¯<code>ExecDetails</code>ï¼Œé‡Œé¢è®°å½•äº†<code>execution</code>çš„è¯¦æƒ…ä¿¡æ¯ï¼Œåˆ†åˆ«æœ‰</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;è¿™ä¸€ç« ï¼Œä½œä¸ºæˆ‘ä»¬çš„èµ·å§‹ç« èŠ‚ï¼Œè·Ÿç€æºç ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ç†Ÿæ‚‰TIDBçš„æ•´ä½“ä»£ç ç»“æ„&lt;/p&gt;
&lt;hr&gt;
    
    </summary>
    
    
      <category term="TIDB" scheme="http://blog.crazylaw.cn/categories/TIDB/"/>
    
    
      <category term="TIDB" scheme="http://blog.crazylaw.cn/tags/TIDB/"/>
    
  </entry>
  
  <entry>
    <title>2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“</title>
    <link href="http://blog.crazylaw.cn/2022/01/19/2022%E6%9D%82%E4%B9%B1%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"/>
    <id>http://blog.crazylaw.cn/2022/01/19/2022%E6%9D%82%E4%B9%B1%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/</id>
    <published>2022-01-19T06:38:06.000Z</published>
    <updated>2022-02-05T06:14:45.964Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>è®°å½•ä¸€ä¸‹å¸¸è§„ä¸‹çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚</p><hr><a id="more"></a><h2 id="Go"><a href="#Go" class="headerlink" title="Go"></a>Go</h2><h3 id="go-channel-closeåè¯»çš„é—®é¢˜"><a href="#go-channel-closeåè¯»çš„é—®é¢˜" class="headerlink" title="go channel closeåè¯»çš„é—®é¢˜"></a>go channel closeåè¯»çš„é—®é¢˜</h3>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h2&gt;&lt;p&gt;è®°å½•ä¸€ä¸‹å¸¸è§„ä¸‹çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚&lt;/p&gt;
&lt;hr&gt;
    
    </summary>
    
    
      <category term="çŸ¥è¯†ç‚¹" scheme="http://blog.crazylaw.cn/categories/%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
    
      <category term="2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“" scheme="http://blog.crazylaw.cn/tags/2022%E6%9D%82%E4%B9%B1%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>ã€2021ã€‘ 2021å¹´ç»ˆæ€»ç»“</title>
    <link href="http://blog.crazylaw.cn/2022/01/02/2021%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <id>http://blog.crazylaw.cn/2022/01/02/2021%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</id>
    <published>2022-01-02T15:54:00.000Z</published>
    <updated>2022-01-25T03:01:32.272Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>2021å·²ç»è¿‡å»äº†ï¼Œåœ¨è¿™é‡Œå›å¿†ä¸€ä¸‹ï¼Œæˆ‘çš„2021çš„å¹´ç»ˆæ€»ç»“ã€‚</p><a id="more"></a><h2 id="å›°éš¾ä¸æŒ‘æˆ˜"><a href="#å›°éš¾ä¸æŒ‘æˆ˜" class="headerlink" title="å›°éš¾ä¸æŒ‘æˆ˜"></a>å›°éš¾ä¸æŒ‘æˆ˜</h2><p>å·¥ä½œä¸­ï¼Œåœ¨è¿‡å»çš„ä¸€å¹´é‡Œï¼Œè¿æ¥äº†ä¸å°‘çš„æŒ‘æˆ˜ï¼Œåœ¨å…¬å¸ä¸­è½åœ°å¤§æ•°æ®ç›¸å…³çš„æœåŠ¡äº†ä»<code>erlang</code>åˆ°<code>golang</code>çš„è½¬æ¢ã€‚æˆ‘ä»¬æ•´å¥—æ–°çš„ä½“ç³»ç§°ä¸ºï¼š<code>mfeilog</code></p><ol><li><p>åœ¨å…¬å¸ä¸­ï¼Œç§¯ç´¯äº†è®¸å¤šgoè¯­è¨€çš„ç»„ä»¶ï¼Œå¹¶ä¸”ä¸æ–­çš„å®Œå–„ä¿®å¤ç›¸å…³çš„bugï¼Œä¾‹å¦‚ï¼Œmfeilogçš„æ ¸å¿ƒæ•°æ®æºï¼š<code>msource</code>ï¼Œmfeilogçš„åŸºç¡€ç»„ä»¶ï¼š<code>daemonç»„ä»¶</code>/<code>no-named-pipeç»„ä»¶</code>ï¼Œ<code>logbdevç»„ä»¶</code>ï¼Œ<code>sink_mysql</code>/<code>sink_kafka</code>ç­‰ç»„ä»¶ã€‚</p></li><li><p>è¯´åˆ°è¿™ä¸ª<code>msource</code>æœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº<code>rocksdb</code>å®ç°çš„æ”¯æŒ<code>sql</code>è¯­æ³•çš„è½»é‡çº§å°å‹å®šåˆ¶<code>æ•°æ®åº“æœåŠ¡</code>ï¼Œå¯ä»¥è¯´æ˜¯ç»è¿‡äº†ä¸æ–­ä¼˜åŒ–ï¼Œå‡çº§ï¼Œä¿®å¤å†…éƒ¨å„ç§å†…ç½®åŠŸèƒ½ï¼Œæ‰å¾—ä»¥ç°åœ¨çš„ç¨³å®šå’Œé«˜æ•ˆã€‚ç»™åº”ç”¨å±‚æä¾›äº†ä¸€ä¸ªé«˜å¯é ï¼Œç¨³å®šï¼Œçš„æ•°æ®æºåŠŸèƒ½ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªbugï¼Œå°è±¡ç‰¹åˆ«æ·±åˆ»ï¼Œä¹Ÿæ˜¯æˆ‘å§‹æ–™æœªåŠçš„ä¸€ä¸ªbugï¼Œå› ä¸º<code>å‘å·å™¨</code>æ˜¯é™„å±åœ¨<code>Table</code>å½“ä¸­çš„ï¼Œæˆ‘éœ€è¦<code>è‡ªå®šä¹‰åºåˆ—åŒ–</code>åå­˜å‚¨åœ¨åº•å±‚çš„<code>rocksdb</code>ä¸­ï¼Œæ‰€ä»¥åœ¨æˆ‘<code>ååºåˆ—åŒ–</code>å‡ºæ¥çš„æ—¶å€™ï¼Œå¯åŠ¨äº†å¤šä¸ªå‘å·å™¨ï¼Œå¯¼è‡´æ¯ä¸ª<code>field-colunm</code>éƒ½å®ä¾‹åŒ–äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€ŒéåŒä¸€ä¸ªå¯¹è±¡ï¼Œå¼•å‘äº†å‘å·å™¨é”™ä¹±ï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜(å†…å­˜è¢«è¦†ç›–ï¼Œé”™è¯¯ackæ‰äº†æ•°æ®)ã€‚è¿™ä¸ªé—®é¢˜æ’æŸ¥ä¹Ÿæ˜¯ååˆ†ä¸æ˜“ï¼ï¼ï¼æ‰€ä»¥å¯ä»¥è¯´æ˜¯è¡€çš„æ•™è®­ã€‚</p></li><li><p>å¹¶ä¸”ä¹Ÿä¸ºå…¬å¸æ¨å¹¿ â€œæœåŠ¡å™¨æ—¥å¿—æŸ¥è¯¢æ–¹æ¡ˆâ€ ä¸­ï¼Œç¡®å®šäº†ä»¥<code>GPLï¼ˆgrafna+protomal+lokiï¼‰</code>çš„æ—¥å¿—æŸ¥è¯¢æ¶æ„ï¼Œç»Ÿä¸€äº†æ—¥å¿—æŸ¥è¯¢çš„å…¥å£ï¼Œå¤§å¤§æé«˜äº†æ—¥å¿—æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p></li><li><p>åœ¨ <code>goæœåŠ¡æµé‡å½•åˆ¶å’Œå›æ”¾æ–¹æ¡ˆå’Œå®ç°</code> ä¸­ï¼Œä¸ºäº†å®ç°æµé‡é—­ç¯ï¼Œç‰¹æ„å»è°ƒç ”æŸ¥çœ‹äº† æ»´æ»´çš„ <code>ã€Šå†™è½®çœ¼ã€‹</code>é¡¹ç›®ï¼Œå¹¶ä¸”çŸ¥é“äº†é€šè¿‡ç±»ä¼¼æ³¨å…¥çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨ç”¨æˆ·å±‚ç¼–è§£ç ä¸Šæ›¿æ¢åˆ°åŸæ¥çš„å‡½æ•°æŒ‡é’ˆï¼Œä»è€Œå®ç°åœ¨ç”¨æˆ·å±‚æ›¿æ¢goåº•å±‚æºç çš„æ–¹å¼ï¼Œä½†æ˜¯ç”±äºæ€§ä»·æ¯”é—®é¢˜ï¼Œåœ¨å…¬å¸ä¸­æœ€åå¹¶æœªæ¨å¹¿ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œç ”å‘ã€‚è¯¥éœ€æ±‚åé¢è¢«æç½®äº†ã€‚</p></li><li><p>åœ¨ <code>é…ç½®æœåŠ¡æ–¹æ¡ˆ</code> ä¸­ï¼Œè¿™ä¸ªéœ€æ±‚åœ¨ä»¥å¾€å…¶å®å·²ç»è¯•è¿‡æ‰ç”¨<code>consule</code>æ¥åšé…ç½®æœåŠ¡ä¸­å¿ƒï¼ŒåŸå› æ˜¯æ—©æœŸæˆ‘ä»¬æƒ³è¦å¯¹æœåŠ¡åšä¸€ä¸ª<code>æœåŠ¡æ³¨å†Œå’Œå‘ç°</code>ï¼Œåœ¨ <code>php</code> è¿™ç§<code>fastcgi</code>çš„æ–¹å¼æ¥è¯´ï¼Œconsuleçš„ä¸»åŠ¨å‘ç°æœåŠ¡ï¼Œå°±æ¯”å¾ˆå¤šç±»ä¼¼<code>etcd</code>è¢«åŠ¨å‘ç°æ³¨å†ŒæœåŠ¡å¥½ç”¨ã€‚ä½†æ˜¯ç”±äºæœ€ç»ˆå› ä¸ºæˆ‘ä»¬çš„æœåŠ¡ç›®å‰æ¥è¯´æ¯”è¾ƒé›¶æ•£ï¼Œå¹¶ä¸”éœ€æ±‚çš„ä»»åŠ¡ä¸æ˜¯ç€æ€¥ï¼Œè¿™ä»¶äº‹åé¢ä¹Ÿè¢«æç½®äº†ï¼Œåé¢ä»Šå¤©å†æ¬¡æäº†ä¸€ä¸ªè¿™æ ·å­çš„ç±»ä¼¼çš„éœ€æ±‚ï¼Œå®ç°äº†é€šè¿‡ goè¯­è¨€å†™çš„çš„å·¥å…·ï¼Œç±»ä¼¼äº<code>k8s</code>çš„<code>kubectl</code>çš„å·¥å…·ï¼Œè¿›è¡Œé…ç½®çš„åŒæ­¥å’Œç®¡ç†ï¼Œåˆ†åˆ«åˆ†ä¸ºäº†2ä¸ªæ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯Cç«¯çš„å·¥å…·ï¼Œä¸€ä¸ªæ˜¯Sç«¯çš„åŒæ­¥æœåŠ¡ï¼Œä¸­é—´çš„æ¢çº½ï¼Œæœ€ç»ˆé€‰æ‹©äº†ä»¥<code>etcd</code>ä¸ºé…ç½®åˆ†å¸ƒå¼å­˜å‚¨æœåŠ¡ã€‚æˆ‘ä»¬æœåŠ¡çš„éƒ¨ç½²ç‰¹ç‚¹ï¼Œåˆ©ç”¨<code>jenkins</code>çš„<code>å¤šé˜¶æ®µè‡ªå®šä¹‰ç¼–è¯‘</code>çš„<code>jenkins-shared-library</code>å®ç°äº†çµæ´»ç¼–è¯‘ï¼Œæ ¹æ®ç°æœ‰çš„æœåŠ¡çµæ´»éƒ¨ç½²ï¼Œä»è€Œè¾¾åˆ°éåµŒå…¥å¼çš„é…ç½®åŒæ­¥æ–¹å¼ã€‚</p></li><li><p>å› ä¸ºå…¬å¸æˆç«‹å¾—æ¯”è¾ƒæ—©ï¼Œä»£ç ä»“åº“ä¸€ç›´ä»æœªè¿›è¡Œå˜æ›´ï¼Œæ‰€ä»¥å…¶ä¸­ä¸€ä¸ªéœ€æ±‚å°±æ˜¯ <code>gitbucket</code> åˆ° <code>gitlab</code> çš„ä»£ç ä»“åº“è¿ç§»ï¼Œå†™äº†ä¸€ä¸ªå°å·¥å…·ï¼Œä»è€Œå®ç°äº†ä» gitbucketåˆ° gitlabä¸€é”®è‡ªåŠ¨åŒ–æ— ç¼è¿ç§»ä»£ç ï¼ŒåŒ…æ‹¬é¡¹ç›®ç»„ï¼Œé¡¹ç›®çš„å†å²<code>commit</code>ï¼Œ<code>tag</code>ï¼Œ<code>branch</code>ç­‰ç­‰éƒ½è‡ªåŠ¨åŒ–å®Œæˆï¼Œå¤§å¤§å‡è½»äº†é¡¹ç›®è¿ç§»çš„è´Ÿæ‹…ã€‚</p></li><li><p>å¯¹ <code>jenkins</code> çš„<code>shard-library</code> æ¨¡å—è¿›è¡Œä¼˜åŒ–å‡çº§ï¼Œç¼–å†™äº†ä¸€ä¸ª<code>pythonçš„æ”¯æŒå¤šå‡­æ®è®¤è¯çš„è„šæœ¬</code>ï¼Œå¹¶ä¸”æ”¯æŒè‡ªå®šä¹‰ç¼–è¯‘ä»£ç ã€‚</p></li><li><p>é›†æˆäº†ä¸€å¥—ï¼Œ<code>æœ¬åœ°çš„å¤§æ•°æ®dockerç¯å¢ƒ</code>ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å¤§æ•°æ®ç¯å¢ƒååˆ†çš„ç¹æ‚ï¼Œå¹¶ä¸”è¿˜éœ€è¦å¤šå°æœºå™¨æ‰èƒ½å¤„ç†ï¼Œè¿™å¯¹æˆ‘ä»¬æœ¬åœ°å¼€å‘æ¥è¯´ååˆ†çš„ä¸å‹å¥½ï¼Œä½†æ˜¯ç½‘ä¸Šåˆæ²¡æœ‰é‚£äº›å¾ˆå¥½çš„å¼€ç®±å³ç”¨çš„<code>docker-compose</code>ç¯å¢ƒï¼Œå› æ­¤æ•´ç†äº†ä¸€å¥—æœ¬åœ°çš„å¤§æ•°æ®dockerç¯å¢ƒ(éCDHç‰ˆæœ¬)</p></li><li><p>ä¼˜åŒ–å‡çº§éƒ¨åˆ† <code>mproxy</code> çš„ä»£ç ï¼Œä»è€Œè®©æµ‹è¯•äººå‘˜æ›´å‹å¥½çš„åœ¨è¯¥é¡¹ç›®ä¸­å®Œæˆ<code>è‡ªåŠ¨åŒ–æµ‹è¯•</code>çš„è„šæœ¬åŠŸèƒ½ã€‚</p></li><li><p>æ¨åŠ¨<code>flink</code>çš„è½åœ°ï¼Œç”±äºæˆ‘ä»¬æ—©æœŸçš„æµè®¡ç®—ï¼Œæ˜¯å•æœºçš„ï¼Œå¹¶ä¸”å­˜åœ¨ä¸¥é‡çš„å¤–éƒ¨ä¾èµ–å±æ€§ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬æ¨åŠ¨äº†flinkçš„è½åœ°ï¼Œæ¢ç©¶äº†å‡ ç§å¼€å‘æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ç”¨çº¯<code>java</code> å†™çš„<code>datastream-api</code>æ–¹å¼ï¼Œè¿™ä¸ªæ–¹å¼æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œæ‰€æœ‰çš„ä¸Šå±‚çš„apiéƒ½æ˜¯åŸºäº<code>datastream</code>çš„ï¼Œä¸€äº›ä¸Šå±‚çš„apiæ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬é€šè¿‡datastreamå¯ä»¥å¾ˆè½»æ¾çš„å®ç°å„ç±»éœ€æ±‚ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘è¸©äº†ä¸å°‘çš„å‘ï¼Œä¸»è¦æ˜¯æ¥è‡ªäº<code>watermark</code>å’Œ<code>window</code>çš„æ¦‚å¿µï¼Œå’‹ä¸€çœ‹å…¶å®éƒ½æ˜¯ä¸€äº›æ¯”è¾ƒå¥½ç†è§£çš„æ¦‚å¿µï¼Œä½†æ˜¯å…¶å®åœ¨é…åˆå¤§æ•°æ®ä¸“ç”¨çš„<code>kafka</code>æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œä¸€åˆ‡å°±å˜å¾—å¤æ‚èµ·æ¥ï¼Œç”±äº<code>kafka</code>çš„<code>partition</code>åªèƒ½æœ‰ä¸€ä¸ªclientå»æ¶ˆè´¹çš„åŸå› ï¼ŒåŠ ä¸Šflinkè‡ªèº«çš„æ¦‚å¿µ<code>å¹¶è¡Œåº¦</code>ï¼Œè¿™ä¸€åˆ‡ç»“åˆåœ¨ä¸€èµ·ï¼Œå°±ä¼šå‡ºç°ä¸€äº›è®©ä½ ç–‘æƒ‘çš„ç‚¹ã€‚ç»è¿‡äº†å¤§é‡åå¤çš„æ‘¸ç´¢å’Œé’»ç ”ï¼Œæœ€ç»ˆæ‰æŒæ¡äº†åœ¨å¤špartitionä¸‹flinkçš„watermarkå’Œwindow-triggeræœºåˆ¶æ–¹å¼ï¼Œä½†æ˜¯ç”±äºè¯¥æ–¹å¼ä¸å¤Ÿç›´è§‚ï¼Œä¹Ÿä¸ç®¡çµæ´»ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆæ¨å¹¿äº†<code>sql-api</code>ã€‚å¥½å®¶ä¼™ï¼Œä½ ä»¥ä¸ºè¿™å°±å®Œäº†å—ï¼Œå¹¶æ²¡æœ‰ï¼Œç”±äºflinkè‡ªèº«å¸¦æœ‰<code>sql-client</code>çš„åŸå› ï¼Œæˆ‘ä¸€å¼€å§‹å°è¯•äº†ç”¨<code>sql-client</code>æ¥ç¼–å†™æµè®¡ç®—çš„æ¨¡å‹ï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªå·¥å…·æœ‰å¤ªå¤šé—®é¢˜äº†ï¼Œä¸åŒçš„ç‰ˆæœ¬æœ‰ä¸ç”¨çš„è°ƒç”¨æ–¹å¼ï¼Œä¸åŒç‰ˆæœ¬ä¸‹ï¼Œå¯¹äº<code>SET</code>æ”¯æŒçš„ç²’åº¦ä¹Ÿæ˜¯ä¸ä¸€è‡´çš„ï¼Œè¿™è®©æˆ‘å¾ˆå¤´ç–¼ã€‚æ‰€ä»¥æœ€ç»ˆé€‰æ‹©äº†ï¼ŒåŸºäºflinkç¼–å†™äº†ä¸€ä¸ªè‡ªç ”çš„<code>flink-sql-client</code>ï¼Œé€šè¿‡<code>flink run flink-sql-client.jar</code>çš„æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½»æ¾çš„æäº¤sqlä»»åŠ¡æˆ–è€…åšå…¶ä»–çš„éœ€æ±‚ï¼ˆä¾‹å¦‚æŸ¥çœ‹hiveçš„cataglogç­‰ç­‰ï¼‰ã€‚ç„¶è€Œåˆ°äº†è¿™é‡Œè¿˜æ²¡æœ‰ç»“æŸï¼Œç”±äº<code>sql</code>çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ²¡åŠæ³•æ§åˆ¶ï¼Œæ˜¯ç”±<code>flink-core</code>è‡ªèº«æ ‡å‡†åŒ–äº†æµç¨‹ï¼Œæ‰€ä»¥æœ‰ä¸€äº›bugæˆ‘ä»¬æ²¡åŠæ³•è§£å†³ï¼Œä¾‹å¦‚åœ¨ <code>flink-1.12.0</code> ç§ï¼Œå°±ä¼šå› ä¸º<code>watermark</code>åœ¨<code>idle</code>çš„æƒ…å†µä¸‹ï¼Œæ— æ³•æ¨è¿›watermarkï¼Œä»è€Œå¯¼è‡´çª—å£åœ¨å°‘é‡æ•°æ®æƒ…å†µä¸‹ï¼Œæ ¹æœ¬ä¸èƒ½åŠæ—¶çš„ç»Ÿè®¡å’Œè®¡ç®—ï¼ˆè¿™å’Œå·ç§°å®æ—¶åˆ†æçš„æµè®¡ç®—è¿èƒŒï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æƒ³äº†ä¸€äº›ç‰ˆæœ¬åšäº†ä¸€äº›è¿‚å›çš„æ“ä½œã€‚ä»è€Œæœ€ç»ˆè§£å†³ç±»ä¼¼è¿™ç§ç”±äºåº•å±‚bugæ‰€å¸¦æ¥çš„é—®é¢˜ã€‚</p></li></ol><h2 id="è‡ªå·±çš„å­¦ä¹ ä¸Š"><a href="#è‡ªå·±çš„å­¦ä¹ ä¸Š" class="headerlink" title="è‡ªå·±çš„å­¦ä¹ ä¸Š"></a>è‡ªå·±çš„å­¦ä¹ ä¸Š</h2><ol><li><p>å¯¹<code>golang</code>çš„<code>protobuf</code>æœåŠ¡æœ‰ä¸€äº›çš„äº†è§£ï¼Œå¹¶ä¸”å­¦ä¼šäº†<code>protobuf</code>çš„æ’ä»¶å¼€å‘ã€‚äº†è§£äº†protobufçš„åè®®ã€‚</p></li><li><p>å¯¹<code>rust</code>ä¸Šçš„ç”Ÿæ€æ›´ä¸ºæ¸…æ™°äº†ï¼Œåˆ©ç”¨äº†å…¶ä¸­çš„ä¸€äº›<code>actor</code>æ¨¡å‹ï¼Œ<code>async-io</code>ç­‰åˆ†åˆ«å®ç°äº†ä¸€äº›åŸºç¡€çš„å·¥å…·ã€‚</p></li><li><p>å¯¹<code>flutter</code>ä¹Ÿæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œåˆ©ç”¨<code>dart</code>ç¼–å†™äº†ä¸€ä¸ªå¯ä»¥ç”¨äºè‡ªå®šä¹‰é€šä¿¡çš„åº“ã€‚s</p></li><li><p>å¯¹<code>linux</code> ç§çš„ä¸€äº›ç£ç›˜ioï¼Œç½‘ç»œioï¼Œå·²ç»shellå‘½ä»¤çš„çµæ´»è¿ç”¨æ›´åŠ æ·±åˆ»ã€‚</p></li></ol><blockquote><p>æœªå®Œå¾…ç»­ï¼ï¼</p></blockquote><p>(æ‚„å’ªå’ªçš„å‘Šè¯‰å¤§å®¶ï¼Œæˆ‘ä¹°æˆ¿äº†ã€‚å˜¿å˜¿)</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;2021å·²ç»è¿‡å»äº†ï¼Œåœ¨è¿™é‡Œå›å¿†ä¸€ä¸‹ï¼Œæˆ‘çš„2021çš„å¹´ç»ˆæ€»ç»“ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¹´ç»ˆæ€»ç»“" scheme="http://blog.crazylaw.cn/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="å¹´ç»ˆæ€»ç»“" scheme="http://blog.crazylaw.cn/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    
  </entry>
  
  <entry>
    <title>ã€å¤§æ•°æ®ã€‘- flinkå¼€å‘ç¯å¢ƒæ­å»º</title>
    <link href="http://blog.crazylaw.cn/2021/09/28/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <id>http://blog.crazylaw.cn/2021/09/28/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</id>
    <published>2021-09-28T01:56:40.000Z</published>
    <updated>2021-09-28T09:10:18.184Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç”±äºæœ€è¿‘è¦æ¨åŠ¨flinkçš„æµè®¡ç®—ä»£æ›¿æˆ‘ä»¬çš„å†…éƒ¨çš„è‡ªè¡Œç ”å‘çš„mstreamæµè®¡ç®—æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦å¯¹flinkè¿›è¡Œå¼€å‘ã€‚</p><a id="more"></a><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æˆ‘ä»¬çš„flinkçš„ç‰ˆæœ¬ä¸Š1.12.0</p><p>ç†è®ºä¸Šåªæ˜¯jdk8å’Œjdk11.æ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£…jdk8å’Œjdk8</p><p>å› ä¸ºæˆ‘çš„æ˜¯macOSï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘è¯´ä¸€ä¸‹macå®‰è£…çš„è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…jdkã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew tap adoptopenjdk/openjdk</span><br><span class="line">brew install adoptopenjdk8</span><br><span class="line">brew install adoptopenjdk11</span><br></pre></td></tr></table></figure><blockquote><p>ç½®äºè¦ç”¨jdk8è¿˜æ˜¯jdk11ï¼Œè‡ªè¡ŒæŠ‰æ‹©ï¼Œæˆ‘è¿™é‡Œ2ä¸ªéƒ½å®‰è£…äº†ã€‚</p></blockquote><p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™ä½ å¯èƒ½ä¼šæ‰¾ä¸åˆ°å®‰è£…è·¯å¾„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ /usr/libexec/java_home -V</span><br><span class="line">Matching Java Virtual Machines (3):</span><br><span class="line">    11.0.12 (x86_64) "Oracle Corporation" - "Java SE 11.0.12" /Library/Java/JavaVirtualMachines/jdk-11.0.12.jdk/Contents/Home</span><br><span class="line">    11.0.11 (x86_64) "AdoptOpenJDK" - "AdoptOpenJDK 11" /Library/Java/JavaVirtualMachines/adoptopenjdk-11.jdk/Contents/Home</span><br><span class="line">    1.8.0_292 (x86_64) "AdoptOpenJDK" - "AdoptOpenJDK 8" /Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>/usr/libexec/java_home -V</code>å†…ç½®çš„ä¸€ä¸ªç¨‹åºï¼Œå°±å¯ä»¥æ‰¾åˆ°æ‰€æœ‰ç›¸å…³çš„<code>java_home</code>ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å¯¹åº”çš„<code>java_home</code>ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”çš„javaè§£æå™¨ã€‚</p><h2 id="IDEåˆå§‹åŒ–é¡¹ç›®"><a href="#IDEåˆå§‹åŒ–é¡¹ç›®" class="headerlink" title="IDEåˆå§‹åŒ–é¡¹ç›®"></a>IDEåˆå§‹åŒ–é¡¹ç›®</h2><p>æˆ‘è¿™é‡Œç”¨çš„æ˜¯<code>IDEA</code>ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œåˆ—ä¸€ä¸‹æˆ‘çš„æ“ä½œæ­¥éª¤ã€‚</p><h3 id="New-Project"><a href="#New-Project" class="headerlink" title="New Project"></a>New Project</h3><p>å…ˆæŠŠ<code>Maven</code>åŒ…çš„è·¯å¾„ç¡®å®šä¸‹æ¥ã€‚åé¢åˆ©ç”¨docker-mavenå·¥å…·çš„æ—¶å€™ï¼ŒæŒ‡å®šæŒ‚è½½ä»“åº“æœ‰ç”¨ã€‚</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject13.png" alt="newproject13"></p><p>å¼€å§‹åˆ›å»ºé¡¹ç›®</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject1.png" alt="newproject1"></p><p>é€‰æ‹©ä½¿ç”¨Mavenæ¥åˆ›å»ºé¡¹ç›®ï¼Œå¹¶ä¸”é€‰æ‹©åˆšæ‰å®‰è£…å¥½çš„<code>JDK8</code>æˆ–è€…<code>JDK11</code>ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ä¸å¸¦<code>archetype</code>çš„ï¼Œè¿™ä¸ªæ˜¯<code>Maven</code>æ¨¡æ¿çš„ç±»å‹ã€‚æˆ‘ä»¬éœ€è¦å‹¾é€‰è¿™ä¸ª<code>archetype</code>ï¼Œ</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject2.png" alt="newproject2"></p><p>æ¥ä¸‹æ¥æ·»åŠ <code>flink-quickstart-java</code>çš„<code>archetype</code>ã€‚</p><ul><li>GroupId = org.apache.flink</li><li>AryofactId = flink-quickstart-java</li><li>Version = 1.12.0</li></ul><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject3.png" alt="newproject3"></p><p>åˆ©ç”¨æ¨¡ç‰ˆåˆ›å»ºé¡¹ç›®</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject4.png" alt="newproject4"></p><p>å¯ä»¥æ ¹æ®è‡ªè¡Œçš„éœ€è¦ï¼Œå¡«å†™é¡¹ç›®çš„è·¯å¾„ä»¥åŠå¯¹åº”çš„<code>GroupId</code>, <code>AryofactId</code>, <code>Version</code></p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject5.png" alt="newproject5"></p><p>ç„¶åå°±æ˜¯Mavençš„ç›¸å…³é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„é»˜è®¤çš„å°±è¡Œï¼Œç›´æ¥ç‚¹å‡»<code>Finish</code>å®Œæˆé¡¹ç›®åˆå§‹åŒ–ï¼Œç„¶åé¡¹ç›®ä¼šè‡ªåŠ¨æ ¹æ®Mavençš„é…ç½®åŠ è½½å¯¹åº”çš„JaråŒ…ã€‚</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject6.png" alt="newproject6"></p><p>ç­‰å¾…ä¸€åˆ‡åˆå§‹åŒ–å®Œæ¯•åï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹å›¾çš„æ¨¡æ¿</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject7.png" alt="newproject7"></p><p>å…¶ä¸­åŒ…å«äº†2ä¸ªJobï¼Œåˆ†åˆ«æ˜¯<code>BatchJob</code>å’Œ<code>StreamingJob</code>ã€‚</p><ul><li>BatchJob ä»£è¡¨æ‰¹å¤„ç†ä»»åŠ¡</li><li>StreamingJob ä»£è¡¨æµå¤„ç†ä»»åŠ¡</li></ul><h2 id="ç¼–å†™æ‰¹å¤„ç†ä»£ç å¹¶æµ‹è¯•æ‰§è¡Œ"><a href="#ç¼–å†™æ‰¹å¤„ç†ä»£ç å¹¶æµ‹è¯•æ‰§è¡Œ" class="headerlink" title="ç¼–å†™æ‰¹å¤„ç†ä»£ç å¹¶æµ‹è¯•æ‰§è¡Œ"></a>ç¼–å†™æ‰¹å¤„ç†ä»£ç å¹¶æµ‹è¯•æ‰§è¡Œ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="comment"> * or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="comment"> * distributed with this work for additional information</span></span><br><span class="line"><span class="comment"> * regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="comment"> * to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="comment"> * "License"); you may not use this file except in compliance</span></span><br><span class="line"><span class="comment"> * with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> my.flink;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.ExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.operators.DataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Skeleton for a Flink Batch Job.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For a tutorial how to write a Flink batch application, check the</span></span><br><span class="line"><span class="comment"> * tutorials and examples on the &lt;a href="https://flink.apache.org/docs/stable/"&gt;Flink Website&lt;/a&gt;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;To package your application into a JAR file for execution,</span></span><br><span class="line"><span class="comment"> * change the main class in the POM.xml file to this class (simply search for 'mainClass')</span></span><br><span class="line"><span class="comment"> * and run 'mvn clean package' on the command line.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchJob</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// set up the batch execution environment</span></span><br><span class="line">        <span class="keyword">final</span> ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        DataSource&lt;String&gt; el = env.fromElements(<span class="string">"good good study"</span>, <span class="string">"day day up"</span>);</span><br><span class="line"></span><br><span class="line">        el.flatMap(</span><br><span class="line">                (String a, Collector&lt;String&gt; out) -&gt; Arrays.stream(a.split(<span class="string">" "</span>)).forEach(x -&gt; out.collect(x))</span><br><span class="line">        ).returns(String<span class="class">.<span class="keyword">class</span>).<span class="title">print</span>()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”±äºprint()æ˜¯è°ƒè¯•æ¨¡å¼ï¼Œæ‰€ä»¥ä¸èƒ½æŒ‡å®šJobnameï¼Œprint()å†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨Execute()</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ env.execute() å°†æ— æ³•è°ƒç”¨ï¼Œéœ€è¦æ³¨é‡Šæ‰ï¼Œå¦åˆ™ä¼šæœ‰æŠ¥é”™æŠ›å‡ºï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å¿½ç•¥è¿™ä¸ªå¼‚å¸¸</span></span><br><span class="line">        <span class="comment">// execute program</span></span><br><span class="line">        <span class="comment">// env.execute("Flink Batch Java API Skeleton");</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æŠŠ<code>BatchJob</code>åŠ å…¥äº†<code>å…·ä½“</code>çš„ä»»åŠ¡ã€‚æˆ‘è¿™é‡Œçš„å†™æ³•æ˜¯Java8çš„lambaçš„å†™æ³•ï¼Œä½¿ç”¨lambaçš„å†™æ³•è®°å¾—éœ€è¦åœ¨åé¢åŠ ä¸Š<code>returns</code>çš„å‡½æ•°ï¼Œè¿™æ˜¯å› ä¸ºä½¿ç”¨<code>lamba</code>çš„æƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´éƒ¨åˆ†ä¿¡æ¯æ— æ³•è‡ªåŠ¨æ¨å¯¼ï¼Œéœ€è¦æ‰‹åŠ¨æ˜¾å¼æŒ‡å®šï¼Œä»è€Œå¯¼è‡´æˆ‘ä»¬éœ€è¦è°ƒç”¨å¤šè¿™ä¸ªå‡½æ•°ã€‚</p><p>æˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ªæ•°æ®æºé›†åˆï¼Œè¿™ä¸ªé›†åˆç±»å‹ä¸º<code>String</code>ç±»å‹ï¼Œæˆ‘ä»¬æŒ‡å®šè¿™ä¸ªé›†åˆçš„å…ƒç´ æœ‰2ä¸ªï¼Œåˆ†åˆ«æ˜¯<code>good good study</code>, <code>day day up</code>ã€‚</p><p>ç„¶åæˆ‘ä»¬é€šè¿‡<code>flatMap</code>çš„æ–¹æ³•è¿›è¡Œä¸€ä¸ªå½’å¹¶çš„æ“ä½œï¼ŒæŠŠæ¯ä¸ªå…ƒç´ é€šè¿‡<code>ä¸€ä¸ªç©ºæ ¼</code>è¿›è¡Œåˆ‡åˆ†ï¼Œåˆ‡åˆ†ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡<code>Collector</code>çš„<code>collect()</code>è¿›è¡Œæ”¶é›†èµ·æ¥ã€‚æœ€ç»ˆè¾“å‡ºåœ¨ç»ˆç«¯ã€‚</p><p>å¹¶ä¸”è¿™ä¸ªJobçš„åå­—ï¼Œæˆ‘ä»¬å®šä¹‰ä¸º<code>Flink Batch Java API Skeleton</code>ã€‚</p><p>æˆ‘ä»¬è¿è¡Œè¿™ä¸ªJob.é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šé‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: org&#x2F;apache&#x2F;flink&#x2F;api&#x2F;java&#x2F;ExecutionEnvironment</span><br><span class="line">at my.flink.BatchJob.main(BatchJob.java:41)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: org.apache.flink.api.java.ExecutionEnvironment</span><br><span class="line">at java.base&#x2F;jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:581)</span><br><span class="line">at java.base&#x2F;jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:178)</span><br><span class="line">at java.base&#x2F;java.lang.ClassLoader.loadClass(ClassLoader.java:522)</span><br><span class="line">... 1 more</span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½ä¼šè§‰å¾—å¾ˆå¥‡æ€ªï¼Œæ˜æ˜<code>IDEA</code>å·²ç»æŠŠ<code>Flink</code>çš„åŒ…åŠ è½½è¿›æ¥ï¼Œä¹Ÿèƒ½æ­£å¸¸è·³è½¬ï¼Œä¸ºä»€ä¹ˆåœ¨è¿è¡Œçš„æ—¶å€™å´å‡ºç°äº†è¿™ä¸ªï¼Œè¿™æ˜¯å› ä¸ºè¿™æ˜¯ç¼–è¯‘çš„è¡Œä¸ºï¼Œå’ŒIDEAåŠ è½½åŒ…æ²¡æœ‰ç›´æ¥çš„å…³ç³»ã€‚</p><p>æ‰“å¼€ä½ çš„<code>pom.xml</code>ï¼Œæ‰¾åˆ°<code>dependencies</code>ä¸‹çš„<code>&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</code>çš„æ‰€æœ‰ä¾èµ–åŒ…ï¼Œä½ ä¼šå‘ç°æ¯ä¸ªä¾èµ–åŒ…ä¸‹é¢éƒ½æœ‰ä¸€ä¸ª<code>&lt;scope /&gt;</code>çš„å®šä¹‰ï¼Œé‡Œé¢çš„valueå†™çš„æ˜¯<code>provided</code>ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸€æ•´è¡Œæ³¨é‡Šæ‰å°±å¥½äº†ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šå</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;scope&gt;provided&lt;/scope&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;scope&gt;provided&lt;/scope&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;scope&gt;provided&lt;/scope&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å­ï¼Œå°±ç­‰åŒäºå®šä¹‰ä¾èµ–åŒ…ï¼Œä½¿ç”¨é»˜è®¤çš„<code>scope</code>èŒƒå›´ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œéœ€è¦äº†è§£ä¸€ä¸‹scopeçš„ä¸€äº›ç»†èŠ‚ã€‚</p><p>å¯¹äº<code>scope=compile</code>çš„æƒ…å†µï¼ˆ<code>é»˜è®¤scope</code>),ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªé¡¹ç›®åœ¨<code>ç¼–è¯‘</code>ï¼Œ<code>æµ‹è¯•</code>ï¼Œ<code>è¿è¡Œé˜¶æ®µ``éƒ½éœ€è¦</code>è¿™ä¸ªartifact(æ¨¡å—)å¯¹åº”çš„jaråŒ…<code>åœ¨classpathä¸­</code>ã€‚</p><p>è€Œå¯¹äº<code>scope=provided</code>çš„æƒ…å†µï¼Œåˆ™å¯ä»¥è®¤ä¸ºè¿™ä¸ªprovidedæ˜¯<code>ç›®æ ‡å®¹å™¨å·²ç»provideè¿™ä¸ªartifact</code>ã€‚æ¢å¥è¯è¯´ï¼Œ<code>å®ƒåªå½±å“åˆ°ç¼–è¯‘ï¼Œæµ‹è¯•é˜¶æ®µ</code>ã€‚åœ¨ç¼–è¯‘æµ‹è¯•é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸ªartifactå¯¹åº”çš„jaråŒ…åœ¨classpathä¸­ï¼Œè€Œåœ¨è¿è¡Œé˜¶æ®µï¼Œå‡å®šç›®æ ‡çš„å®¹å™¨ï¼ˆæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„liferayå®¹å™¨ï¼‰å·²ç»æä¾›äº†è¿™ä¸ªjaråŒ…ï¼Œæ‰€ä»¥æ— éœ€æˆ‘ä»¬è¿™ä¸ªartifactå¯¹åº”çš„jaråŒ…äº†ã€‚</p><p>mavenä¸­ä¸‰ç§classpath<br>ç¼–è¯‘ï¼Œæµ‹è¯•ï¼Œè¿è¡Œ</p><ul><li>compileï¼šé»˜è®¤èŒƒå›´ï¼Œç¼–è¯‘æµ‹è¯•è¿è¡Œéƒ½æœ‰æ•ˆ</li><li>providedï¼šåœ¨ç¼–è¯‘å’Œæµ‹è¯•æ—¶æœ‰æ•ˆ</li><li>runtimeï¼šåœ¨æµ‹è¯•å’Œè¿è¡Œæ—¶æœ‰æ•ˆ</li><li>testï¼šåªåœ¨æµ‹è¯•æ—¶æœ‰æ•ˆ</li><li>systemï¼šåœ¨ç¼–è¯‘å’Œæµ‹è¯•æ—¶æœ‰æ•ˆï¼Œä¸æœ¬æœºç³»ç»Ÿå…³è”ï¼Œå¯ç§»æ¤æ€§å·®</li></ul><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹å˜çš„å°±æ˜¯è¿™ä¸ª<code>scope</code>çš„èŒƒå›´ï¼Œè®©æŸæƒ…å†µä¸‹å¯ä»¥è¿è¡Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœ¬æœºä¸Šè¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ³¨é‡Šæ‰ï¼Œç„¶åå°±ä¼šä½¿ç”¨é»˜è®¤çš„<code>compile</code>ã€‚</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½ æ”¹åŠ¨äº†è¿™ä¸ª<code>pom.xml</code>ä¹‹åï¼Œideaæˆ‘ä¸çŸ¥é“æ˜¯ä¸æ˜¯bugï¼Œåæ­£æˆ‘çš„å½“å‰ç‰ˆæœ¬ä¸ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œæ€ä¹ˆç†è§£è¿™å¥è¯ï¼Ÿ</p><p>é€šè¿‡<code>File -&gt; Project Structure</code>æ‰“å¼€é¡µé¢ï¼ˆå› ä¸ºæˆ‘æ˜¯macï¼‰ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å¿«æ·é”®<code>Command + [:;]</code>æ‰“å¼€ã€‚ç•Œé¢å¦‚ä¸‹</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject8.png" alt="newproject8"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>Flink</code>ç›¸å…³çš„ä¾èµ–åŒ…å…¶å®å·²ç»å­˜åœ¨äº†ï¼Œè¿™é‡Œæ˜¾ç¤ºäº†æˆ‘ä»¬çš„MavenåŒ…ä¸‹çš„scopeæ˜¯<code>Provided</code>ï¼Œé‚£å°±ä»£è¡¨<code>IDEA</code>å¹¶æœªè‡ªåŠ¨è¯†åˆ«æˆ‘åˆšæ‰çš„æ³¨é‡Šã€‚å› ä¸ºå¦‚æœæˆåŠŸè¯†åˆ«å‡ºæ¥äº†ï¼Œåº”è¯¥æ˜¯ä¼šå˜æˆ<code>Compile</code>ã€‚å½“ç„¶æˆ‘å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œè¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯ä¸ºäº†ç»Ÿä¸€ç»´æŠ¤çš„é—®é¢˜ï¼Œä¸å»ºè®®åœ¨æ­¤å¤„ä¿®æ”¹ï¼Œè™½ç„¶ç›´æ¥ä¿®æ”¹å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä¸‹æ¬¡åŠ è½½è¿˜æ˜¯ä»<code>pom.xml</code>åŠ è½½çš„ï¼Œå¹¶ä¸”é—´æ¥ä¾èµ–åŒ…ä¹Ÿç‰¹åˆ«å¤šï¼Œä½ æ— æ³•æŒæ¡é‚£ä¹ˆå¤šä¾èµ–åŒ…çš„å…³ç³»ã€‚</p><p>æ‰€ä»¥æ³¨é‡Šåï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨<code>pom.xml</code>è¿›è¡Œ<code>maven</code>çš„<code>reload project</code>ã€‚</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject10.png" alt="newproject10"></p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å‘ç°ä¸ç®¡æ˜¯ç›´æ¥è¿˜æ˜¯é—´æ¥çš„ä¾èµ–åŒ…éƒ½å˜æˆäº†<code>Compile</code>ã€‚</p><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject11.png" alt="newproject11"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨è¿è¡Œä¸€æ¬¡æˆ‘ä»¬çš„ä»»åŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">15:33:55,353 INFO  org.apache.flink.api.java.utils.PlanGenerator                [] - The job has 0 registered types and 0 default Kryo serializers</span><br><span class="line">15:33:55,523 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.cpu.cores required for local execution is not set, setting it to the maximal possible value.</span><br><span class="line">15:33:55,523 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.task.heap.size required for local execution is not set, setting it to the maximal possible value.</span><br><span class="line">15:33:55,523 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.task.off-heap.size required for local execution is not set, setting it to the maximal possible value.</span><br><span class="line">15:33:55,523 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.network.min required for local execution is not set, setting it to its default value 64 mb.</span><br><span class="line">15:33:55,524 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.network.max required for local execution is not set, setting it to its default value 64 mb.</span><br><span class="line">15:33:55,524 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.managed.size required for local execution is not set, setting it to its default value 128 mb.</span><br><span class="line">15:33:55,548 INFO  org.apache.flink.runtime.minicluster.MiniCluster             [] - Starting Flink Mini Cluster</span><br><span class="line">15:33:55,551 INFO  org.apache.flink.runtime.minicluster.MiniCluster             [] - Starting Metrics Registry</span><br><span class="line">15:33:55,627 INFO  org.apache.flink.runtime.metrics.MetricRegistryImpl          [] - No metrics reporter configured, no metrics will be exposed&#x2F;reported.</span><br><span class="line">15:33:55,627 INFO  org.apache.flink.runtime.minicluster.MiniCluster             [] - Starting RPC Service(s)</span><br><span class="line">15:33:55,780 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils        [] - Trying to start local actor system</span><br><span class="line">15:33:56,203 INFO  akka.event.slf4j.Slf4jLogger                                 [] - Slf4jLogger started</span><br><span class="line">15:33:56,313 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils        [] - Actor system started at akka:&#x2F;&#x2F;flink</span><br><span class="line">15:33:56,328 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils        [] - Trying to start local actor system</span><br><span class="line">15:33:56,341 INFO  akka.event.slf4j.Slf4jLogger                                 [] - Slf4jLogger started</span><br><span class="line">15:33:56,356 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils        [] - Actor system started at akka:&#x2F;&#x2F;flink-metrics</span><br><span class="line">15:33:56,373 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Starting RPC endpoint for org.apache.flink.runtime.metrics.dump.MetricQueryService at akka:&#x2F;&#x2F;flink-metrics&#x2F;user&#x2F;rpc&#x2F;MetricQueryService .</span><br><span class="line">15:33:56,399 INFO  org.apache.flink.runtime.minicluster.MiniCluster             [] - Starting high-availability services</span><br><span class="line">15:33:56,418 INFO  org.apache.flink.runtime.blob.BlobServer                     [] - Created BLOB server storage directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;blobStore-4ec8c72e-36f6-4b8d-aba8-70bb3d443f93</span><br><span class="line">15:33:56,430 INFO  org.apache.flink.runtime.blob.BlobServer                     [] - Started BLOB server at 0.0.0.0:58212 - max concurrent requests: 50 - max backlog: 1000</span><br><span class="line">15:33:56,434 INFO  org.apache.flink.runtime.blob.PermanentBlobCache             [] - Created BLOB cache storage directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;blobStore-3433044e-b47e-445c-9df2-ceb5d1e8da6f</span><br><span class="line">15:33:56,436 INFO  org.apache.flink.runtime.blob.TransientBlobCache             [] - Created BLOB cache storage directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;blobStore-4d06675d-1b13-4fa2-87e9-0a1609934f09</span><br><span class="line">15:33:56,436 INFO  org.apache.flink.runtime.minicluster.MiniCluster             [] - Starting 1 TaskManger(s)</span><br><span class="line">15:33:56,441 INFO  org.apache.flink.runtime.taskexecutor.TaskManagerRunner      [] - Starting TaskManager with ResourceID: a7c681c7-48a2-4491-803a-535036a51fcb</span><br><span class="line">15:33:56,477 INFO  org.apache.flink.runtime.taskexecutor.TaskManagerServices    [] - Temporary file directory &#39;&#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#39;: total 233 GB, usable 25 GB (10.73% usable)</span><br><span class="line">15:33:56,482 INFO  org.apache.flink.runtime.io.disk.FileChannelManagerImpl      [] - FileChannelManager uses directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-io-dc01cff1-6b52-43ed-9d16-9085f49c732e for spill files.</span><br><span class="line">15:33:56,492 INFO  org.apache.flink.runtime.io.disk.FileChannelManagerImpl      [] - FileChannelManager uses directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-netty-shuffle-41571afb-b13e-494b-b937-0696d2c77ca1 for spill files.</span><br><span class="line">15:33:56,580 INFO  org.apache.flink.runtime.io.network.buffer.NetworkBufferPool [] - Allocated 64 MB for network buffer pool (number of memory segments: 2048, bytes per segment: 32768).</span><br><span class="line">15:33:56,594 INFO  org.apache.flink.runtime.io.network.NettyShuffleEnvironment  [] - Starting the network environment and its components.</span><br><span class="line">15:33:56,596 INFO  org.apache.flink.runtime.taskexecutor.KvStateService         [] - Starting the kvState service and its components.</span><br><span class="line">15:33:56,631 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Starting RPC endpoint for org.apache.flink.runtime.taskexecutor.TaskExecutor at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0 .</span><br><span class="line">15:33:56,650 INFO  org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Start job leader service.</span><br><span class="line">15:33:56,653 INFO  org.apache.flink.runtime.filecache.FileCache                 [] - User file cache uses directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-dist-cache-fc4fd5a1-79fa-4a19-8d7d-f3072006c91e</span><br><span class="line">15:33:56,714 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint   [] - Starting rest endpoint.</span><br><span class="line">15:33:56,717 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint   [] - Failed to load web based job submission extension. Probable reason: flink-runtime-web is not in the classpath.</span><br><span class="line">15:33:57,089 WARN  org.apache.flink.runtime.webmonitor.WebMonitorUtils          [] - Log file environment variable &#39;log.file&#39; is not set.</span><br><span class="line">15:33:57,089 WARN  org.apache.flink.runtime.webmonitor.WebMonitorUtils          [] - JobManager log files are unavailable in the web dashboard. Log file location not found in environment variable &#39;log.file&#39; or configuration key &#39;web.log.path&#39;.</span><br><span class="line">15:33:57,300 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint   [] - Rest endpoint listening at localhost:58223</span><br><span class="line">15:33:57,302 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender http:&#x2F;&#x2F;localhost:58223</span><br><span class="line">15:33:57,305 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint   [] - http:&#x2F;&#x2F;localhost:58223 was granted leadership with leaderSessionID&#x3D;22a043f5-f263-4e6c-87e9-6e61beef3075</span><br><span class="line">15:33:57,306 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader http:&#x2F;&#x2F;localhost:58223 , session&#x3D;22a043f5-f263-4e6c-87e9-6e61beef3075</span><br><span class="line">15:33:57,327 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Starting RPC endpoint for org.apache.flink.runtime.resourcemanager.StandaloneResourceManager at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 .</span><br><span class="line">15:33:57,344 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender LeaderContender: DefaultDispatcherRunner</span><br><span class="line">15:33:57,345 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender LeaderContender: StandaloneResourceManager</span><br><span class="line">15:33:57,347 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - ResourceManager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 was granted leadership with fencing token 99793e5c3d8a81ced62f8a03bd21494c</span><br><span class="line">15:33:57,350 INFO  org.apache.flink.runtime.minicluster.MiniCluster             [] - Flink Mini Cluster started successfully</span><br><span class="line">15:33:57,350 INFO  org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl [] - Starting the SlotManager.</span><br><span class="line">15:33:57,351 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Start SessionDispatcherLeaderProcess.</span><br><span class="line">15:33:57,353 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Recover all persisted job graphs.</span><br><span class="line">15:33:57,354 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Successfully recovered 0 persisted job graphs.</span><br><span class="line">15:33:57,355 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 , session&#x3D;d62f8a03-bd21-494c-9979-3e5c3d8a81ce</span><br><span class="line">15:33:57,357 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Connecting to ResourceManager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1(99793e5c3d8a81ced62f8a03bd21494c).</span><br><span class="line">15:33:57,365 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Starting RPC endpoint for org.apache.flink.runtime.dispatcher.StandaloneDispatcher at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2 .</span><br><span class="line">15:33:57,378 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2 , session&#x3D;0a8eb324-f6f9-44d7-a452-87c855415b0e</span><br><span class="line">15:33:57,387 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Resolved ResourceManager address, beginning registration</span><br><span class="line">15:33:57,393 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Registering TaskManager with ResourceID a7c681c7-48a2-4491-803a-535036a51fcb (akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0) at ResourceManager</span><br><span class="line">15:33:57,395 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Successful registration at resource manager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 under registration id 3e9b649958365e1a080d0b1102807505.</span><br><span class="line">15:33:57,396 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher     [] - Received JobGraph submission c9c27c95a1e3b4a8bfd7250101fa1126 (Flink Java Job at Tue Sep 28 15:33:55 CST 2021).</span><br><span class="line">15:33:57,396 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher     [] - Submitting job c9c27c95a1e3b4a8bfd7250101fa1126 (Flink Java Job at Tue Sep 28 15:33:55 CST 2021).</span><br><span class="line">15:33:57,423 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Starting RPC endpoint for org.apache.flink.runtime.jobmaster.JobMaster at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 .</span><br><span class="line">15:33:57,433 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Initializing job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).</span><br><span class="line">15:33:57,452 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Using restart back off time strategy NoRestartBackoffTimeStrategy for Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).</span><br><span class="line">15:33:57,487 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Running initialization on master for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).</span><br><span class="line">15:33:57,490 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Successfully ran initialization on master in 3 ms.</span><br><span class="line">15:33:57,512 INFO  org.apache.flink.runtime.scheduler.adapter.DefaultExecutionTopology [] - Built 1 pipelined regions in 3 ms</span><br><span class="line">15:33:57,518 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Using failover strategy org.apache.flink.runtime.executiongraph.failover.flip1.RestartPipelinedRegionFailoverStrategy@4fe83a40 for Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).</span><br><span class="line">15:33:57,527 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3</span><br><span class="line">15:33:57,528 INFO  org.apache.flink.runtime.jobmaster.JobManagerRunnerImpl      [] - JobManager runner for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) was granted leadership with session id 00c173d1-6a96-47ad-a2d9-da1ebc4d6a41 at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3.</span><br><span class="line">15:33:57,532 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Starting execution of job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) under job master id a2d9da1ebc4d6a4100c173d16a9647ad.</span><br><span class="line">15:33:57,533 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Starting scheduling with scheduling strategy [org.apache.flink.runtime.scheduler.strategy.PipelinedRegionSchedulingStrategy]</span><br><span class="line">15:33:57,533 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) switched from state CREATED to RUNNING.</span><br><span class="line">15:33:57,537 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from CREATED to SCHEDULED.</span><br><span class="line">15:33:57,537 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from CREATED to SCHEDULED.</span><br><span class="line">15:33:57,546 INFO  org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl     [] - Cannot serve slot request, no ResourceManager connected. Adding as pending request [SlotRequestId&#123;1e28fd68790f78b4b48f557e8ba4d92f&#125;]</span><br><span class="line">15:33:57,552 INFO  org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 , session&#x3D;00c173d1-6a96-47ad-a2d9-da1ebc4d6a41</span><br><span class="line">15:33:57,552 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Connecting to ResourceManager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1(99793e5c3d8a81ced62f8a03bd21494c)</span><br><span class="line">15:33:57,554 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Resolved ResourceManager address, beginning registration</span><br><span class="line">15:33:57,555 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Registering job manager a2d9da1ebc4d6a4100c173d16a9647ad@akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126.</span><br><span class="line">15:33:57,559 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Registered job manager a2d9da1ebc4d6a4100c173d16a9647ad@akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126.</span><br><span class="line">15:33:57,561 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - JobManager successfully registered at ResourceManager, leader id: 99793e5c3d8a81ced62f8a03bd21494c.</span><br><span class="line">15:33:57,562 INFO  org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl     [] - Requesting new slot [SlotRequestId&#123;1e28fd68790f78b4b48f557e8ba4d92f&#125;] and profile ResourceProfile&#123;UNKNOWN&#125; with allocation id d73fe42189235dfaf22a937eb4556ee1 from resource manager.</span><br><span class="line">15:33:57,562 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Request slot with profile ResourceProfile&#123;UNKNOWN&#125; for job c9c27c95a1e3b4a8bfd7250101fa1126 with allocation id d73fe42189235dfaf22a937eb4556ee1.</span><br><span class="line">15:33:57,565 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Receive slot request d73fe42189235dfaf22a937eb4556ee1 for job c9c27c95a1e3b4a8bfd7250101fa1126 from resource manager with leader id 99793e5c3d8a81ced62f8a03bd21494c.</span><br><span class="line">15:33:57,570 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Allocated slot for d73fe42189235dfaf22a937eb4556ee1.</span><br><span class="line">15:33:57,571 INFO  org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Add job c9c27c95a1e3b4a8bfd7250101fa1126 for job leader monitoring.</span><br><span class="line">15:33:57,573 INFO  org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Try to register at job manager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 with leader id 00c173d1-6a96-47ad-a2d9-da1ebc4d6a41.</span><br><span class="line">15:33:57,574 INFO  org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Resolved JobManager address, beginning registration</span><br><span class="line">15:33:57,577 INFO  org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Successful registration at job manager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126.</span><br><span class="line">15:33:57,578 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Establish JobManager connection for job c9c27c95a1e3b4a8bfd7250101fa1126.</span><br><span class="line">15:33:57,580 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Offer reserved slots to the leader of job c9c27c95a1e3b4a8bfd7250101fa1126.</span><br><span class="line">15:33:57,588 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from SCHEDULED to DEPLOYING.</span><br><span class="line">15:33:57,590 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Deploying CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (attempt #0) with attempt id 2d0c18f32aaefecbd6f3d76a781d54b9 to a7c681c7-48a2-4491-803a-535036a51fcb @ localhost (dataPort&#x3D;-1) with allocation id d73fe42189235dfaf22a937eb4556ee1</span><br><span class="line">15:33:57,595 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from SCHEDULED to DEPLOYING.</span><br><span class="line">15:33:57,595 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Deploying DataSink (collect()) (1&#x2F;1) (attempt #0) with attempt id 1feb48784b233306f550eda82cf1b5e9 to a7c681c7-48a2-4491-803a-535036a51fcb @ localhost (dataPort&#x3D;-1) with allocation id d73fe42189235dfaf22a937eb4556ee1</span><br><span class="line">15:33:57,595 INFO  org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Activate slot d73fe42189235dfaf22a937eb4556ee1.</span><br><span class="line">15:33:57,627 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Received task CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9), deploy into slot with allocation id d73fe42189235dfaf22a937eb4556ee1.</span><br><span class="line">15:33:57,628 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) switched from CREATED to DEPLOYING.</span><br><span class="line">15:33:57,630 INFO  org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Activate slot d73fe42189235dfaf22a937eb4556ee1.</span><br><span class="line">15:33:57,630 INFO  org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Activate slot d73fe42189235dfaf22a937eb4556ee1.</span><br><span class="line">15:33:57,633 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Loading JAR files for task CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) [DEPLOYING].</span><br><span class="line">15:33:57,634 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Registering task at network: CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) [DEPLOYING].</span><br><span class="line">15:33:57,642 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Received task DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9), deploy into slot with allocation id d73fe42189235dfaf22a937eb4556ee1.</span><br><span class="line">15:33:57,642 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) switched from CREATED to DEPLOYING.</span><br><span class="line">15:33:57,643 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Loading JAR files for task DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) [DEPLOYING].</span><br><span class="line">15:33:57,644 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Registering task at network: DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) [DEPLOYING].</span><br><span class="line">15:33:57,647 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) switched from DEPLOYING to RUNNING.</span><br><span class="line">15:33:57,648 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) switched from DEPLOYING to RUNNING.</span><br><span class="line">15:33:57,648 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from DEPLOYING to RUNNING.</span><br><span class="line">15:33:57,649 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from DEPLOYING to RUNNING.</span><br><span class="line">15:33:57,659 WARN  org.apache.flink.metrics.MetricGroup                         [] - The operator name DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) exceeded the 80 characters length limit and was truncated.</span><br><span class="line">15:33:57,667 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) switched from RUNNING to FINISHED.</span><br><span class="line">15:33:57,667 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Freeing task resources for CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9).</span><br><span class="line">15:33:57,670 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Un-registering task and sending final execution state FINISHED to JobManager for task CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 2d0c18f32aaefecbd6f3d76a781d54b9.</span><br><span class="line">15:33:57,677 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from RUNNING to FINISHED.</span><br><span class="line">15:33:57,678 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) switched from RUNNING to FINISHED.</span><br><span class="line">15:33:57,678 INFO  org.apache.flink.runtime.taskmanager.Task                    [] - Freeing task resources for DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9).</span><br><span class="line">15:33:57,679 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Un-registering task and sending final execution state FINISHED to JobManager for task DataSink (collect()) (1&#x2F;1)#0 1feb48784b233306f550eda82cf1b5e9.</span><br><span class="line">15:33:57,682 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from RUNNING to FINISHED.</span><br><span class="line">15:33:57,685 INFO  org.apache.flink.runtime.executiongraph.ExecutionGraph       [] - Job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) switched from state RUNNING to FINISHED.</span><br><span class="line">15:33:57,691 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher     [] - Job c9c27c95a1e3b4a8bfd7250101fa1126 reached globally terminal state FINISHED.</span><br><span class="line">15:33:57,691 INFO  org.apache.flink.runtime.minicluster.MiniCluster             [] - Shutting down Flink Mini Cluster</span><br><span class="line">15:33:57,691 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint   [] - Shutting down rest endpoint.</span><br><span class="line">15:33:57,691 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Stopping TaskExecutor akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0.</span><br><span class="line">15:33:57,692 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Close ResourceManager connection 01714233597d70de71bbfbda09ac665e.</span><br><span class="line">15:33:57,692 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Closing TaskExecutor connection a7c681c7-48a2-4491-803a-535036a51fcb because: The TaskExecutor is shutting down.</span><br><span class="line">15:33:57,693 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Close JobManager connection for job c9c27c95a1e3b4a8bfd7250101fa1126.</span><br><span class="line">15:33:57,694 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Stopping the JobMaster for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021(c9c27c95a1e3b4a8bfd7250101fa1126).</span><br><span class="line">15:33:57,695 INFO  org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Free slot TaskSlot(index:0, state:ALLOCATED, resource profile: ResourceProfile&#123;managedMemory&#x3D;128.000mb (134217728 bytes), networkMemory&#x3D;64.000mb (67108864 bytes)&#125;, allocationId: d73fe42189235dfaf22a937eb4556ee1, jobId: c9c27c95a1e3b4a8bfd7250101fa1126).</span><br><span class="line">15:33:57,697 INFO  org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl     [] - Suspending SlotPool.</span><br><span class="line">15:33:57,697 INFO  org.apache.flink.runtime.jobmaster.JobMaster                 [] - Close ResourceManager connection 01714233597d70de71bbfbda09ac665e: Stopping JobMaster for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021(c9c27c95a1e3b4a8bfd7250101fa1126)..</span><br><span class="line">15:33:57,697 INFO  org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl     [] - Stopping SlotPool.</span><br><span class="line">15:33:57,697 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Disconnect job manager a2d9da1ebc4d6a4100c173d16a9647ad@akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126 from the resource manager.</span><br><span class="line">15:33:57,699 INFO  org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Stop job leader service.</span><br><span class="line">15:33:57,699 INFO  org.apache.flink.runtime.state.TaskExecutorLocalStateStoresManager [] - Shutting down TaskExecutorLocalStateStoresManager.</span><br><span class="line">good</span><br><span class="line">good</span><br><span class="line">study</span><br><span class="line">day</span><br><span class="line">day</span><br><span class="line">up</span><br><span class="line">15:33:57,725 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint   [] - Removing cache directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-web-ui</span><br><span class="line">15:33:57,727 INFO  org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint   [] - Shut down complete.</span><br><span class="line">15:33:57,729 INFO  org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Shut down cluster because application is in CANCELED, diagnostics DispatcherResourceManagerComponent has been closed..</span><br><span class="line">15:33:57,729 INFO  org.apache.flink.runtime.io.disk.FileChannelManagerImpl      [] - FileChannelManager removed spill file directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-io-dc01cff1-6b52-43ed-9d16-9085f49c732e</span><br><span class="line">15:33:57,730 INFO  org.apache.flink.runtime.io.network.NettyShuffleEnvironment  [] - Shutting down the network environment and its components.</span><br><span class="line">15:33:57,730 INFO  org.apache.flink.runtime.entrypoint.component.DispatcherResourceManagerComponent [] - Closing components.</span><br><span class="line">15:33:57,730 INFO  org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Stopping SessionDispatcherLeaderProcess.</span><br><span class="line">15:33:57,730 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher     [] - Stopping dispatcher akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2.</span><br><span class="line">15:33:57,731 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher     [] - Stopping all currently running jobs of dispatcher akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2.</span><br><span class="line">15:33:57,731 INFO  org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl [] - Closing the SlotManager.</span><br><span class="line">15:33:57,731 INFO  org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl [] - Suspending the SlotManager.</span><br><span class="line">15:33:57,731 INFO  org.apache.flink.runtime.rest.handler.legacy.backpressure.BackPressureRequestCoordinator [] - Shutting down back pressure request coordinator.</span><br><span class="line">15:33:57,731 INFO  org.apache.flink.runtime.io.disk.FileChannelManagerImpl      [] - FileChannelManager removed spill file directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-netty-shuffle-41571afb-b13e-494b-b937-0696d2c77ca1</span><br><span class="line">15:33:57,732 INFO  org.apache.flink.runtime.taskexecutor.KvStateService         [] - Shutting down the kvState service and its components.</span><br><span class="line">15:33:57,732 INFO  org.apache.flink.runtime.dispatcher.StandaloneDispatcher     [] - Stopped dispatcher akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2.</span><br><span class="line">15:33:57,732 INFO  org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Stop job leader service.</span><br><span class="line">15:33:57,734 INFO  org.apache.flink.runtime.filecache.FileCache                 [] - removed file cache directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-dist-cache-fc4fd5a1-79fa-4a19-8d7d-f3072006c91e</span><br><span class="line">15:33:57,735 INFO  org.apache.flink.runtime.taskexecutor.TaskExecutor           [] - Stopped TaskExecutor akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0.</span><br><span class="line">15:33:57,735 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Stopping Akka RPC service.</span><br><span class="line">15:33:57,760 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Stopping Akka RPC service.</span><br><span class="line">15:33:57,760 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Stopped Akka RPC service.</span><br><span class="line">15:33:57,766 INFO  org.apache.flink.runtime.blob.PermanentBlobCache             [] - Shutting down BLOB cache</span><br><span class="line">15:33:57,768 INFO  org.apache.flink.runtime.blob.TransientBlobCache             [] - Shutting down BLOB cache</span><br><span class="line">15:33:57,772 INFO  org.apache.flink.runtime.blob.BlobServer                     [] - Stopped BLOB server at 0.0.0.0:58212</span><br><span class="line">15:33:57,772 INFO  org.apache.flink.runtime.rpc.akka.AkkaRpcService             [] - Stopped Akka RPC service.</span><br></pre></td></tr></table></figure><p><img src="/images/%E5%A4%A7%E6%95%B0%E6%8D%AE/newproject12.png" alt="newproject12"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„ä»£ç å·²ç»æ‰§è¡Œï¼Œå¹¶ä¸”ç”Ÿæ•ˆã€‚è¿™æ ·å­æˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒå°±æ­å»ºå®Œæ¯•äº†ã€‚å…¶ä»–çš„åŸºæœ¬å¤§åŒå°å¼‚ï¼Œå¦‚éœ€è®°å½•ï¼Œåé¢ä¼šé¢å¤–çš„ç¯‡ç« è¿›è¡Œè®°å½•ã€‚</p><h2 id="é¡¹ç›®æ‰“åŒ…å¹¶æäº¤Flinké›†ç¾¤æ‰§è¡Œ"><a href="#é¡¹ç›®æ‰“åŒ…å¹¶æäº¤Flinké›†ç¾¤æ‰§è¡Œ" class="headerlink" title="é¡¹ç›®æ‰“åŒ…å¹¶æäº¤Flinké›†ç¾¤æ‰§è¡Œ"></a>é¡¹ç›®æ‰“åŒ…å¹¶æäº¤Flinké›†ç¾¤æ‰§è¡Œ</h2><p>ç›´åˆ°åˆšæ‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬éƒ½æ˜¯æœ¬åœ°å¼€å‘çš„æ¨¡å¼ï¼Œä½†æ˜¯å¦‚æœè¦åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰“åŒ…æˆjarï¼Œç„¶åå€ŸåŠ©flink-clientæäº¤jobå›¾å¯¹è±¡ç»™flink-job-managerï¼Œç„¶åå†åˆ†å‘ç»™å„ä¸ªçš„taskManagerè¿›è¡Œæ‰§è¡Œã€‚</p><p>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰“åŒ…å‡º<code>jar</code>åŒ…ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨Mavençš„<code>mvn clean package</code>å‘½ä»¤å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œæ‰“åŒ…ã€‚</p><p>å¦‚æœéœ€è¦é¢å¤–æŒ‡å®šä¸€äº›å†…å®¹çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨<code>mvn clean package -Dfile.encoding=UTF-8 -DskipTests=true</code>ï¼Œè¿™æ ·å­å¯ä»¥å¿½ç•¥æµ‹è¯•é˜¶æ®µã€‚</p><p>åˆ©ç”¨docker</p><ul><li>æ„æ¶ä¸€ä¸ªflink1.12çš„é›†ç¾¤</li><li>æ„å»ºä¸€ä¸ªmavenå·¥å…·ï¼Œç‰ˆæœ¬3.6.3ï¼ˆç”±äºideaé‡‡ç”¨çš„æ˜¯å†…ç½®çš„mavenï¼Œè¿™æ˜¯æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„jaråŒ…ï¼Œæ‰€ä»¥å¤–éƒ¨æ— æ³•ç›´æ¥å¼•ç”¨mvnå‘½ä»¤ï¼‰</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull flink:1.12-scala_2.11-java8</span><br><span class="line">docker pull maven:3.6.3</span><br></pre></td></tr></table></figure><p>åœ¨ä»£ç ç›®å½•ä¸‹æ‰“åŒ…å‡ºjaråŒ…</p><blockquote><p>è®°å¾—æ‰“åŒ…æˆ<code>ç”Ÿæˆç¯å¢ƒçš„jaråŒ…</code>çš„æ—¶å€™ï¼ŒæŠŠ<code>&lt;scope /&gt;</code>æ”¹å› <code>provided</code>, ä¹Ÿå°±æ˜¯æŠŠæ³¨é‡Šå–æ¶ˆæ‰ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">âœ  my-flink-jdk11 docker run --rm -it -v  ~/.m2:/root/.m2 -v $(PWD):/www -w /www maven:3.6.3 mvn clean package</span><br><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] ----------------------&lt; my-flink:my-flink-jdk11 &gt;-----------------------</span><br><span class="line">[INFO] Building Flink Quickstart Job 1.0-SNAPSHOT</span><br><span class="line">[INFO] --------------------------------[ jar ]---------------------------------</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-clean-plugin:2.5:clean (default-clean) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] Deleting /www/target</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] Using 'UTF-8' encoding to copy filtered resources.</span><br><span class="line">[INFO] Copying 1 resource</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] Changes detected - recompiling the module!</span><br><span class="line">[INFO] Compiling 2 source files to /www/target/classes</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] Using 'UTF-8' encoding to copy filtered resources.</span><br><span class="line">[INFO] skip non existing resourceDirectory /www/src/test/resources</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] No sources to compile</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-surefire-plugin:2.12.4:test (default-test) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] No tests to run.</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] Building jar: /www/target/my-flink-jdk11-1.0-SNAPSHOT.jar</span><br><span class="line">[INFO] </span><br><span class="line">[INFO] --- maven-shade-plugin:3.1.1:shade (default) @ my-flink-jdk11 ---</span><br><span class="line">[INFO] Excluding org.slf4j:slf4j-api:jar:1.7.15 from the shaded jar.</span><br><span class="line">[INFO] Excluding org.apache.logging.log4j:log4j-slf4j-impl:jar:2.12.1 from the shaded jar.</span><br><span class="line">[INFO] Excluding org.apache.logging.log4j:log4j-api:jar:2.12.1 from the shaded jar.</span><br><span class="line">[INFO] Excluding org.apache.logging.log4j:log4j-core:jar:2.12.1 from the shaded jar.</span><br><span class="line">[INFO] Replacing original artifact with shaded artifact.</span><br><span class="line">[INFO] Replacing /www/target/my-flink-jdk11-1.0-SNAPSHOT.jar with /www/target/my-flink-jdk11-1.0-SNAPSHOT-shaded.jar</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD SUCCESS</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time:  8.988 s</span><br><span class="line">[INFO] Finished at: 2021-09-28T08:30:35Z</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>è½¬ç§»å°±æ„å»ºæˆåŠŸäº†ã€‚</p><p>åœ¨<code>target</code>ç›®å½•ä¸‹æŸ¥çœ‹<code>jaråŒ…</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  my-flink-jdk11 ll target/my-flink-jdk11-1.0-SNAPSHOT.jar </span><br><span class="line">-rw-r--r--  1 caiwenhui  staff   6.6K Sep 28 16:30 target/my-flink-jdk11-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>åŒæ ·æŠŠä»£ç ç›®å½•æŒ‚è½½è¿›flinkå®¹å™¨ï¼Œç„¶åæ„å»ºflinkå®¹å™¨ï¼ˆæ­¤æ­¥éª¤åªè¦æ˜¯æ‹¿åˆ°targetç›®å½•ä¸‹çš„jaråŒ…ï¼Œå¦‚æœä½ æŒ‡å®šäº†å…¶ä»–è·¯å¾„æ¢ä¸ªæŒ‚è½½ç›®å½•ä¹Ÿå¯ä»¥ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name flinkc --privileged  -w /www -v$(PWD):/www -p 8081:8081 flink:1.12-scala_2.11-java8 bash</span><br></pre></td></tr></table></figure><blockquote><p>8081æ˜¯flink webuiçš„æœåŠ¡ï¼Œå…·ä½“çš„å†…å®¹åé¢å†è¯´</p></blockquote><p>è¿›åˆ°å®¹å™¨åï¼Œå¯åŠ¨å•æœºç‰ˆflinké›†ç¾¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flink@ed5e7ea28514:/www$ start-cluster.sh</span><br><span class="line">Starting cluster.</span><br><span class="line">Starting standalonesession daemon on host ed5e7ea28514.</span><br><span class="line">Starting taskexecutor daemon on host ed5e7ea28514</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">flink@ed5e7ea28514:&#x2F;www$ flink run --class my.flink.BatchJob .&#x2F;target&#x2F;my-flink-jdk11-1.0-SNAPSHOT.jar</span><br><span class="line">Job has been submitted with JobID ca99d6d7ef6f913ac334d7123d63658b</span><br><span class="line">Program execution finished</span><br><span class="line">Job with JobID ca99d6d7ef6f913ac334d7123d63658b has finished.</span><br><span class="line">Job Runtime: 187 ms</span><br><span class="line">Accumulator Results:</span><br><span class="line">- 40a6a5d6af948dba01cbb7bee71f2d4e (java.util.ArrayList) [6 elements]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">good</span><br><span class="line">good</span><br><span class="line">study</span><br><span class="line">day</span><br><span class="line">day</span><br><span class="line">up</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå¯ä»¥è¿™ä¸ªç»“æœå’Œæˆ‘ä»¬å†IDEAæ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œæ‰€ä»¥å¼€å‘ç¯å¢ƒæ­å»ºå®Œæ¯•ã€‚åé¢çš„ç¯‡ç« å°†ä¼šæ˜¯å…·ä½“çš„æµè®¡ç®—å†…å®¹ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ç”±äºæœ€è¿‘è¦æ¨åŠ¨flinkçš„æµè®¡ç®—ä»£æ›¿æˆ‘ä»¬çš„å†…éƒ¨çš„è‡ªè¡Œç ”å‘çš„mstreamæµè®¡ç®—æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦å¯¹flinkè¿›è¡Œå¼€å‘ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="å¤§æ•°æ®" scheme="http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="flink" scheme="http://blog.crazylaw.cn/tags/flink/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- protobufæ’ä»¶æ‰©å±•å¼€å‘2</title>
    <link href="http://blog.crazylaw.cn/2021/09/06/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%912/"/>
    <id>http://blog.crazylaw.cn/2021/09/06/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%912/</id>
    <published>2021-09-06T01:16:51.000Z</published>
    <updated>2021-09-06T01:57:29.825Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸Šä¸€ç‰‡ï¼Œæˆ‘ä»¬è®²åˆ°äº†<code>protobufæ‰©å±•å¼€å‘</code>çš„å¤§ä½“æµç¨‹å’Œæ€è·¯ï¼Œè¿™ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥ç»§ç»­æ€»ç»“ä¸€ä¸‹ç›¸å…³çš„APIç»†èŠ‚ã€‚</p><a id="more"></a><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="ç¬¬ä¸€ç‚¹"><a href="#ç¬¬ä¸€ç‚¹" class="headerlink" title="ç¬¬ä¸€ç‚¹"></a>ç¬¬ä¸€ç‚¹</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option go_package &#x3D; &quot;github.com&#x2F;xxxx&#x2F;pb&#x2F;go-pb&#x2F;api;pb&quot;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»å¸¸å¯ä»¥çœ‹åˆ°è¿™ç§å®šä¹‰ï¼Œåˆ†å¥½å‰é¢çš„<code>github.com/xxxx/pb/go-pb/api</code>ï¼Œæˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ä¼šè¢«åŠ è½½åˆ°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gen *Plugin)</span> <span class="title">NewGeneratedFile</span><span class="params">(filename <span class="keyword">string</span>, goImportPath GoImportPath)</span> *<span class="title">GeneratedFile</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ‘ä»¬è‡ªå·±çš„ä»£ç </span></span><br><span class="line">filename := f.GeneratedFilenamePrefix + <span class="string">".api.go"</span></span><br><span class="line">g := plugin.NewGeneratedFile(strings.TrimPrefix(filename, strings.Trim(pbPkg.String(), <span class="string">"\""</span>)), f.GoImportPath)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>Plugin.NewGeneratedFile</code>æœ‰2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯<code>filename</code>,å¦å¤–ä¸€ä¸ªæ˜¯<code>goImportPath</code>ï¼Œåˆ†åˆ«çš„å«ä¹‰æ˜¯ï¼š</p><p>ç”Ÿæˆçš„æ–‡ä»¶åå’Œè¿™ä¸ªæ–‡ä»¶è¢«importçš„æ—¶å€™ï¼Œåº”è¯¥è¦æ€ä¹ˆimportã€‚</p><ul><li>è¿™ä¸ªæ–‡ä»¶åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨è·¯å¾„æ–‡ä»¶åï¼Œå¦‚æœä½ çš„æ–‡ä»¶åç§å­˜åœ¨<code>/</code>ï¼Œé‚£ä¹ˆå‰é¢çš„éƒ½æ˜¯<code>ç›®å½•</code>ï¼Œç›´åˆ°æœ€åä¸€ä¸ªï¼Œæ‰æ˜¯æ–‡ä»¶åã€‚</li><li>ä¾‹å¦‚æˆ‘è¿™é‡Œçš„æ˜¯<code>github.com/xxxx/pb/go-pb/api</code>ï¼Œé‚£ä¹ˆç”Ÿæˆçš„æ–‡ä»¶è¢«å¼•ç”¨çš„æ—¶å€™ï¼Œå°±ä¼š<code>import &quot;github.com/xxxx/pb/go-pb/api&quot;</code>ã€‚</li></ul><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹åˆ†å·åé¢çš„<code>pb</code>ï¼Œè¿™ä¸ªåœ¨å¤–é¢å†™ä»£ç çš„æ—¶å€™åˆ°ä½“ç°æ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆ‘ä»¬è‡ªå·±çš„ä»£ç </span></span><br><span class="line">g.P(<span class="string">"package "</span> + f.GoPackageName)</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°å…¶å®è¿™ä¸ª<code>pb</code>ä¼šè¢«åŠ è½½è¿›æ–‡ä»¶çš„<code>GoPackageName</code>ç§ï¼Œæ‰€ä»¥åˆ†å·å‰é¢çš„æ„ä¹‰æ˜¯ä¸åŒçš„ï¼Œå‰é¢çš„å¯¹åº”<code>filename</code>å’Œ<code>GoImportPath</code>,åé¢å¯¹åº”çš„å°±æ˜¯<code>GoPackageName</code></p><h3 id="ç¬¬äºŒç‚¹"><a href="#ç¬¬äºŒç‚¹" class="headerlink" title="ç¬¬äºŒç‚¹"></a>ç¬¬äºŒç‚¹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">pbPkg = protogen.GoImportPath(<span class="string">"github.com/xxx/pb/go-pb"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰ä¸€äº›è¿™æ ·å­çš„xxxPkgçš„å˜é‡ï¼Œä»–ä»¬ç”±<code>protogen.GoImportPath</code>æ¥åŒ…è£…èµ·æ¥ï¼Œåœ¨ä½¿ç”¨ä¸Šå°±æ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g.P(<span class="string">"     "</span>, method.GoName, <span class="string">"Api = "</span>, pbPkg.Ident(<span class="string">"NewApi"</span>), <span class="string">"(\""</span>, method.GoName, <span class="string">"\", \""</span>, m, <span class="string">"\", \""</span>, url, <span class="string">"\")"</span>)</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œçš„<code>pbPkg.Ident(&quot;NewApi&quot;)</code>ï¼Œæ„æ€å°±æ˜¯è¿™ä¸ªè¦è°ƒç”¨<code>pbPkg</code>åŒ…ä¸‹çš„<code>NewApi</code>çš„æ–¹æ³•ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œç”¨åˆ°çš„<code>Ident()</code>APIï¼Œé¡¾åæ€ä¹‰å°±æ˜¯<code>.</code>çš„æ„æ€ã€‚</p><h3 id="ç¬¬ä¸‰ç‚¹"><a href="#ç¬¬ä¸‰ç‚¹" class="headerlink" title="ç¬¬ä¸‰ç‚¹"></a>ç¬¬ä¸‰ç‚¹</h3><p>æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨<code>Plugin.NewGeneratedFile</code>ï¼Œåˆ›å»ºäº†ç”Ÿæˆæ–‡ä»¶å®ä¾‹å¹¶ä¸”å·²ç»é¢„å†™å…¥äº†ä¸€äº›å†…å®¹ï¼Œä½†æ˜¯å®é™…ä»£ç ä¸­ï¼Œå¹¶<code>æ²¡æœ‰ä»»ä½•æœ‰æ„ä¹‰</code>æœ‰ä»·å€¼çš„ä»£ç ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘å¸Œæœ›è¿™ä¸ªæ–‡ä»¶<code>ä¸è¦ç”Ÿæˆ</code>ï¼Œæˆ‘å°±å¯ä»¥è°ƒç”¨<code>Skip()</code>çš„APIã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æˆ‘ä»¬è‡ªå·±çš„ä»£ç </span></span><br><span class="line">g := plugin.NewGeneratedFile(strings.TrimPrefix(filename, strings.Trim(pbPkg.String(), <span class="string">"\""</span>)), f.GoImportPath)</span><br><span class="line">g.Skip()</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶åœ¨æœ€ç»ˆå°†ä¸ä¼šè¢«ç”Ÿæˆã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ä¸Šä¸€ç‰‡ï¼Œæˆ‘ä»¬è®²åˆ°äº†&lt;code&gt;protobufæ‰©å±•å¼€å‘&lt;/code&gt;çš„å¤§ä½“æµç¨‹å’Œæ€è·¯ï¼Œè¿™ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥ç»§ç»­æ€»ç»“ä¸€ä¸‹ç›¸å…³çš„APIç»†èŠ‚ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- protobufæ’ä»¶æ‰©å±•å¼€å‘</title>
    <link href="http://blog.crazylaw.cn/2021/09/04/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/"/>
    <id>http://blog.crazylaw.cn/2021/09/04/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/</id>
    <published>2021-09-04T06:16:51.000Z</published>
    <updated>2021-09-04T06:28:36.840Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘ï¼Œé¡¹ç›®éœ€è¦ç”¨åˆ°protobufæ¥å®šä¹‰æ¶ˆæ¯ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´çµæ´»çš„ä»£ç ç‰‡æ®µï¼Œå¦‚ä½•é€šè¿‡<code>proto</code>æ–‡ä»¶æ¥åˆ›å»ºè‡ªå®šä¹‰çš„ä»£ç å‘¢ï¼Ÿ<br>å¯ä»¥é€šè¿‡protoçš„<code>plugin</code>å¯¹æ–¹å¼æ¥è‡ªå·±æ˜¯ä¸€ä¸ª<code>proto-gen</code>ã€‚</p><p>åœ¨ç½‘ä¸Šçœ‹äº†ä¸€äº›æ•™ç¨‹ï¼Œå‘ç°æœ‰ä¸€äº›æ•™ç¨‹å·²ç»è¿‡æ—¶äº†ï¼Œè€Œä¸”è¿‡äºç‰‡é¢ï¼Œæ²¡æœ‰æŠŠæ•´å¥—æ€æƒ³å¾ˆå¥½çš„è¯´æ˜ã€‚å¹¶ä¸”ä¹Ÿæœ‰ä¸€äº›åŠŸèƒ½ç‚¹å¹¶æ²¡æœ‰å®Œå…¨å®ç°ã€‚<br>è¿™é‡Œæ€»ç»“ä¸€ä¸‹ç›¸å…³çš„å†…å®¹ï¼Œå¹¶ä¸”è¯´ä¸€ä¸‹æœ€è¿‘å®ç°çš„ä¸€ä¸ªæ’ä»¶ã€‚</p><blockquote><p>å¯¹äºå·²ç»äº†è§£å¤§æ¦‚<code>proto</code>çš„äººæ¥è¯´ï¼Œç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯å¦‚æœæ˜¯<code>è‡ªå®šä¹‰option</code>å‘¢ï¼Ÿä½ åˆäº†è§£å—ï¼Ÿ</p></blockquote><a id="more"></a><h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; test.proto</span><br><span class="line"></span><br><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line">package pb;</span><br><span class="line">option go_package &#x3D; &quot;&#x2F;;pb&quot;;</span><br><span class="line"></span><br><span class="line">import &quot;unknow.proto&quot;;</span><br><span class="line"></span><br><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http) &#x3D; &#123;</span><br><span class="line">            method: &quot;post&quot;</span><br><span class="line">            url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è®¾å¤‡ç±»å‹</span><br><span class="line">enum ApiIMDeviceType &#123;</span><br><span class="line">    API_IM_UNKNOWN &#x3D; 0;</span><br><span class="line">    API_IM_Android &#x3D; 1;</span><br><span class="line">    API_IM_IOS &#x3D; 2;</span><br><span class="line">    API_IM_Window &#x3D; 3;</span><br><span class="line">    API_IM_MacOS &#x3D; 4;</span><br><span class="line">    API_IM_Web &#x3D; 5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ApiIMRegisterDeviceReq &#123;</span><br><span class="line">    ApiIMDeviceType type &#x3D; 1; &#x2F;&#x2F; è®¾å¤‡ç±»å‹</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ApiIMRegisterDeviceResp &#123;</span><br><span class="line">    int64 device_id &#x3D; 1; &#x2F;&#x2F; è®¾å¤‡id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°è¿™ä¸€ä¸ª<code>proto</code>æ–‡ä»¶ï¼Œå¸¸è§„çš„æˆ‘å°±ä¸è¯´äº†ã€‚ä¸»è¦æ˜¯çœ‹åˆ°<code>import &quot;unknow.proto&quot;</code>, <code>option (unknow.api.http)</code></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘è¿™é‡Œå¼•å…¥ä¸€ä¸ª<code>unknow.proto</code>çš„æ–‡ä»¶ã€‚</p><p>æˆ‘å¸Œæœ›æœ€ç»ˆç”Ÿæˆä¸€ä¸ª<code>api.unknow.go</code>çš„æ–‡ä»¶ã€‚é‡Œé¢çš„å†…å®¹æœŸå¾…å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2021, whiteCcinn Inc.</span></span><br><span class="line"><span class="comment">// Code generated by protoc-gen-unknow. DO NOT EDIT.</span></span><br><span class="line"><span class="comment">// source: test.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Api <span class="keyword">struct</span> &#123;</span><br><span class="line">Name   <span class="keyword">string</span></span><br><span class="line">Method <span class="keyword">string</span></span><br><span class="line">Url    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newApi</span><span class="params">(name, method, url <span class="keyword">string</span>)</span> *<span class="title">Api</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Api&#123;</span><br><span class="line">name, method, url,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">RegisterDeviceApi = newApi(<span class="string">"RegisterDevice"</span>, <span class="string">"post"</span>, <span class="string">"/v1/im/register_device"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæˆ‘å¯ä»¥åœ¨é¡¹ç›®é€šè¿‡<code>pb.RegisterDeviceApi</code>æ‹¿åˆ°åœ¨<code>proto</code>å®šä¹‰å¥½çš„APIå†…å®¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; unknow.proto</span><br><span class="line"></span><br><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package unknow.api;</span><br><span class="line"></span><br><span class="line">option go_package &#x3D; &quot;&#x2F;;pb&quot;;</span><br><span class="line"></span><br><span class="line">import &quot;google&#x2F;protobuf&#x2F;descriptor.proto&quot;;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">    &#x2F;&#x2F; See &#96;HttpRule&#96;.</span><br><span class="line">    HttpRule http &#x3D; 72295728;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HttpRule &#123;</span><br><span class="line">    string url &#x3D; 1;</span><br><span class="line">    string method &#x3D; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto" target="_blank" rel="noopener">google/api/annotations.proto</a></li><li><a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto" target="_blank" rel="noopener">google/api/http.proto</a></li><li><a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/descriptor.proto" target="_blank" rel="noopener">google/protobuf/descriptor.proto</a></li></ul><p>å¦‚æœæœ‰äº†è§£è¿‡<code>google/api/annotations.proto</code> å’Œ <code>google/api/http.proto</code>çš„äººåº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œå½“ä½ éœ€è¦ç”¨åˆ°<code>grpc-gateway</code>æˆ–è€…<code>proto-gen-swaager</code>çš„æ—¶å€™ï¼Œéƒ½ä¼šæœ‰ä»‹ç»åˆ°<code>option(goggle.api.http)</code>çš„ç”¨æ³•ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°<code>unknow.proto</code>çš„ç»“æ„ä½“ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ã€‚ç”¨äºå®ç°<code>è‡ªå®šä¹‰çš„option</code>ç”¨çš„ã€‚</p><h3 id="unknow-proto"><a href="#unknow-proto" class="headerlink" title="unknow.proto"></a>unknow.proto</h3><p>å¯¹äºåŸºç¡€çš„è¯­æ³•è§„åˆ™æ¥è¯´ï¼Œæˆ‘ä»¬æ¥çœ‹å‰–æä¸€ä¸‹<code>unknow.proto</code>ï¼Œå¸¸è§„çš„å°±ä¸è¯´äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package unknow.api;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">    &#x2F;&#x2F; See &#96;HttpRule&#96;.</span><br><span class="line">    HttpRule http &#x3D; 72295728;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HttpRule &#123;</span><br><span class="line">    string url &#x3D; 1;</span><br><span class="line">    string method &#x3D; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äº<code>extend</code>çš„ç”¨æ³•ï¼Œæˆ‘è¿™é‡Œåˆ—ä¸€ä¸‹å®˜æ–¹çš„é“¾æ¥ã€‚</p><ul><li><a href="https://developers.google.com/protocol-buffers/docs/overview#customoptions" target="_blank" rel="noopener">Custom Options</a></li></ul><p>æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œï¼Œ<code>extend google.protobuf.MethodOptions</code>ã€‚</p><p>ä»£è¡¨ç€ï¼Œæˆ‘è¿™é‡Œè‡ªå®šä¹‰ä¸ªä½œç”¨äº<code>Method</code>çš„<code>option</code>ã€‚æ‰€ä»¥åœ¨çœŸæ­£çš„<code>proto</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘å°±å¯ä»¥ä½¿ç”¨<code>unknow.api.option</code>çš„æ ‡ç­¾ã€‚ä¹Ÿå°±æ˜¯<code>option (unknow.api.http)</code>ã€‚</p><p>æ¥ç€æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªoptionæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå…ƒç´ ï¼Œç±»å‹æ˜¯<code>Message HttpRule</code>ï¼Œå‘½åä¸º<code>http</code>ï¼Œå¹¶ä¸”ç»™å®ƒå®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„<code>Number</code>ã€‚</p><p>æ¥ç€æˆ‘ä»¬çœ‹åˆ°<code>HttpRule</code>ï¼Œå†…éƒ¨å­˜åœ¨2ä¸ªå…ƒç´ ï¼Œä¸€ä¸ªæ˜¯<code>string url</code> å’Œ <code>string method</code>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ç‹¬ç«‹è¡Œå†™æ³•</code>ï¼š<code>option (unknow.api.http).url = &quot;/v1/im/register_device&quot;</code>ï¼Œç„¶åå†ä¸‹ä¸€è¡Œä½¿ç”¨ <code>option (unknow.api.http).method = &quot;post&quot;</code>ï¼Œä¸€ä¸ªå®Œæ•´çš„ä¾‹å¦‚å¦‚ä¸‹ï¼š</p><p>åˆšæ‰è¯´åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ª<code>method</code>çš„<code>option</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™é‡Œå®šä¹‰çš„<code>rpc</code>ä¸‹çš„ <code>option</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http).method &#x3D; &quot;post&quot;</span><br><span class="line">        option (unknow.api.http).url &#x3D; &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†è¿™ä¸ªå†™æ³•ï¼Œæˆ‘æ›´æ¨èå¦‚ä¸‹æ›´ç®€æ´çš„å†™æ³•ï¼Œç”¨<code>map</code>çš„å†™æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http) &#x3D; &#123;</span><br><span class="line">            method: &quot;post&quot;</span><br><span class="line">            url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å­ï¼Œæˆ‘ä»¬å°±çœ‹æ‡‚äº†<code>test.proto</code>çš„å†…å®¹äº†å¯¹å§ã€‚è¿è´¯èµ·æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è¿™ä¸ª<code>unknow.proto</code>å°±æ˜¯ç”¨äºå®ç°<code>option(unknow.api.http)</code>ã€‚è€Œ<code>option(unknow.api.http)</code>çš„ä½¿ç”¨åˆ™åœ¨<code>test.proto</code>è¿›è¡Œé‡‡ç”¨ã€‚</p><p>å¥½äº†ï¼Œæœ‰äº†å®šä¹‰çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬çš„é‡ç‚¹äº†ï¼Œå¦‚ä½•ç¼–å†™ä¸€ä¸ªå®ç°<code>è‡ªå®šä¹‰ä»£ç çš„protobufæ’ä»¶æ‰©å±•</code></p><h3 id="æ‰©å±•å®ç°"><a href="#æ‰©å±•å®ç°" class="headerlink" title="æ‰©å±•å®ç°"></a>æ‰©å±•å®ç°</h3><p><img src="/images/Go/protobuf.png" alt="protobufè§£ææµç¨‹å›¾"></p><blockquote><p>protobufè§£ææ—§ç‰ˆçš„æµç¨‹å›¾ï¼Œä¾¿äºæˆ‘ä»¬ç†è§£ã€‚æ–°ç‰ˆçš„åç»­æˆ‘æŠ½ç©ºå†ç”»ç”»</p></blockquote><h3 id="ä¸ç§‘å­¦çš„ä¾‹å­"><a href="#ä¸ç§‘å­¦çš„ä¾‹å­" class="headerlink" title="ä¸ç§‘å­¦çš„ä¾‹å­"></a>ä¸ç§‘å­¦çš„ä¾‹å­</h3><p>ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œä»¥golangæ—§ç‰ˆ<code>proto-gen-go</code>ä¸ºä¾‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;io&#x2F;ioutil&quot;</span><br><span class="line">&quot;os&quot;</span><br><span class="line"></span><br><span class="line">&quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;proto&quot;</span><br><span class="line">&quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;protoc-gen-go&#x2F;generator&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">&#x2F;&#x2F; Begin by allocating a generator. The request and response structures are stored there</span><br><span class="line">&#x2F;&#x2F; so we can do error handling easily - the response structure contains the field to</span><br><span class="line">&#x2F;&#x2F; report failure.</span><br><span class="line">g :&#x3D; generator.New()</span><br><span class="line"></span><br><span class="line">data, err :&#x3D; ioutil.ReadAll(os.Stdin)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;reading input&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if err :&#x3D; proto.Unmarshal(data, g.Request); err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;parsing input proto&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if len(g.Request.FileToGenerate) &#x3D;&#x3D; 0 &#123;</span><br><span class="line">g.Fail(&quot;no files to generate&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.CommandLineParameters(g.Request.GetParameter())</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Create a wrapped version of the Descriptors and EnumDescriptors that</span><br><span class="line">&#x2F;&#x2F; point to the file that defines them.</span><br><span class="line">g.WrapTypes()</span><br><span class="line"></span><br><span class="line">g.SetPackageNames()</span><br><span class="line">g.BuildTypeNameMap()</span><br><span class="line"></span><br><span class="line">g.GenerateAllFiles()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Send back the results.</span><br><span class="line">data, err &#x3D; proto.Marshal(g.Response)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;failed to marshal output proto&quot;)</span><br><span class="line">&#125;</span><br><span class="line">_, err &#x3D; os.Stdout.Write(data)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;failed to write output proto&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘å‘ç°ç°åœ¨ç½‘ä¸Šå¾ˆå¤šæ•™ç¨‹éƒ½ä¼šä»¥æ—§ç‰ˆçš„ä¸ºä¸»ï¼Œå¹¶ä¸”éƒ½æ˜¯æ²¿ç”¨å‚è€ƒäº†<code>proto-gen-go</code>çš„è¿™ä¸ªæ—§ç‰ˆçš„å†™æ³•ï¼Œæ‰€ä»¥å¯¼è‡´ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ å†™çš„æ—¶å€™ï¼Œä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚å¹¶ä¸”å…¶å®ä½ ç”¨äº†æ—§ç‰ˆçš„è¿™ä¸ªå†™æ³•ï¼Œå½“ä½ åœ¨ç”¨<code>protoc</code>å»ç¼–è¯‘çš„æƒ…å†µä¸‹ï¼Œ<code>protoc</code>ä¹Ÿä¼šå‹å¥½çš„æç¤ºä½ ï¼Œè¯¥APIå·²ç»è¢«åºŸå¼ƒï¼Œå°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸‹ç§»é™¤ï¼Œè¯·ä½¿ç”¨æ–°çš„å†™æ³•ã€‚è™½ç„¶ä½ è¿˜æ˜¯èƒ½ç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯ä½ ä¸æ•¢ä¿è¯æœªæ¥å“ªä¸€ä¸ªç‰ˆæœ¬å°±ç›´æ¥ä¸å‘åå…¼å®¹äº†ã€‚</p><p>ç¬¬äºŒä¸ªä¾‹å­ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">input, _ := ioutil.ReadAll(os.Stdin)</span><br><span class="line"><span class="keyword">var</span> req pluginpb.CodeGeneratorRequest</span><br><span class="line">proto.Unmarshal(input, &amp;req)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨é»˜è®¤é€‰é¡¹åˆå§‹åŒ–æˆ‘ä»¬çš„æ’ä»¶</span></span><br><span class="line">opts := protogen.Options&#123;&#125;</span><br><span class="line">plugin, err := opts.New(&amp;req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">   <span class="built_in">panic</span>(err)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼å°±æ˜¯ä»å¤´åˆ°å°¾éƒ½è‡ªå·±å†™ï¼ŒæŠŠæ•´ä¸ª<code>pipeline</code>çš„æµç¨‹éƒ½è‡ªå·±å¤„ç†ã€‚ä½†æ˜¯å¤§å¯ä¸å¿…ï¼Œå› ä¸ºå…¶å®æœ‰å¾ˆå¤šæµç¨‹åŒ–çš„ä¸œè¥¿ï¼Œåœ¨æ–°ç‰ˆçš„<code>genpro</code>ä¸‹å·²ç»å°è£…æˆäº†ä¸€ä¸ª<code>Run</code>ä¼ é€’å›è°ƒå‡½æ•°å³å¯ã€‚</p><h3 id="æ­£ç¡®çš„ä¾‹å­"><a href="#æ­£ç¡®çš„ä¾‹å­" class="headerlink" title="æ­£ç¡®çš„ä¾‹å­"></a>æ­£ç¡®çš„ä¾‹å­</h3><p>å¦‚æœçœŸçš„è¦å‚è€ƒçš„è¯ï¼Œæ¨èå‚è€ƒæœ€æ–°ç‰ˆæœ¬çš„<a href="https://github.com/golang/protobuf/blob/master/protoc-gen-go/main.go" target="_blank" rel="noopener">proto-gen-go</a></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨é‡‡ç”¨<code>protoc</code>å¯¹<code>proto</code>æ–‡ä»¶è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ï¼Œç»å¸¸æ˜¯æ‰§è¡Œç±»ä¼¼å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc -I.:$&#123;GOGO_PROTOBUF&#125; \</span><br><span class="line">--gofast_out=plugins=grpc:./go-pb</span><br></pre></td></tr></table></figure><p><br>ç”±äºè¿™é‡Œæˆ‘ç”¨çš„æ˜¯<code>gogoprotobuf</code>ï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°æˆ‘è¿™é‡Œçš„æ˜¯<code>--gofast_out=plugins=grpc:./go-pb</code>ï¼Œå¦‚æœä½ æ˜¯<code>protobuf</code>çš„å®˜æ–¹çš„<code>proto-gen</code>çš„è¯ï¼Œé‚£ä¹ˆä½ è¿™é‡Œåº”è¯¥æ˜¯<code>--go_out=plugins=grpc:./go-pb</code></p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Œå°±æ˜¯<code>æ’ä»¶äºŒè¿›åˆ¶æ–‡ä»¶å</code>ï¼Œè¿™æ˜¯æœ‰ä¸€å®šè§„åˆ™çš„ï¼Œè¿™æ˜¯æˆ‘ä¹‹å‰åœ¨<code>è‡ªå®šä¹‰gitå‡­æ®</code>æ–‡ç« ä¸­è¯´æ˜çš„ä¸€æ ·ï¼Œè¿™äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦åœ¨ä½ çš„ç¯å¢ƒå˜é‡ä¸­ï¼Œå¦åˆ™ä½ å°±éœ€è¦é€šè¿‡<code>-I</code>æ¥æŒ‡å®šæ–‡ä»¶è·¯å¾„ã€‚ç„¶åå‘½åè§„åˆ™ä¸º<code>proto-gen-xxx</code>ï¼Œè€Œè¿™ä¸ª<code>xxx</code>å°±æ˜¯ä½ çš„è‡ªå®šä¹‰çš„åå­—ã€‚åœ¨æœ¬ä¾‹å­ä¸­ï¼Œæˆ‘çš„æ‰©å±•åå­—å°±æ˜¯<code>proto-gen-unknow</code>ã€‚</p><p>å› æ­¤ï¼Œæœ€ç»ˆå¦‚æœæˆ‘è¦æ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc -I.:$&#123;GOGO_PROTOBUF&#125; \</span><br><span class="line">--unknow_out=./go-pb</span><br></pre></td></tr></table></figure><p>å…¶å®å¦‚æœæœ‰æ¥è§¦è¿‡<code>thrift</code> æˆ–è€… <code>Rust</code>çš„<code>å…ƒç¼–ç¨‹</code> ç”šè‡³æ˜¯ <code>Python</code>çš„ <code>lark-parser</code>è‡ªå®šä¹‰æŠ½è±¡è¯­æ³•æ ‘ï¼Œæˆ–è€…å…¶ä»–ç»ç”±<code>AST</code>æŠ½è±¡è¯­æ³•æ ‘å†™ä»£ç çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ï¼Œè¿™å…¶å®æŠ½è±¡å‡ºæ¥å°±æ˜¯ä¸€ä¸ª<code>AST</code>çš„è§£æå¤„ç†è€Œå·²ã€‚æ‰€ä»¥æˆ‘é¦–å…ˆéœ€è¦äº†è§£ä»–çš„éƒ¨ç½²ã€‚</p><p>ä¸€ä¸ªç®€é™‹çš„<code>AST</code>å®šä¹‰å¦‚ä¸‹ï¼ˆå“ˆå“ˆï¼Œç•¥æ˜¾ç®€é™‹ï¼Œä½†æ˜¯äº†è§£ASTæ˜¯å•¥çš„åº”è¯¥å¤šå°‘èƒ½çœ‹æ‡‚ä¸€äº›ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FileDescriptor -&gt; ServiceDescriptor</span><br><span class="line">-&gt; ServiceOptionDescriptor</span><br><span class="line">-&gt; MethodDescriptor</span><br><span class="line">-&gt; MethodOptionDescriptor</span><br><span class="line">    -&gt; [MessageDescriptor]</span><br><span class="line">               -&gt; MessageDescriptor</span><br><span class="line">-&gt; MessageOptionDescriptor</span><br><span class="line">-&gt; FieldDescriptor</span><br><span class="line">-&gt; FieldOptionDescriptor</span><br><span class="line">   -&gt; FieldOptionDescriptor</span><br></pre></td></tr></table></figure><p>çŸ¥é“æ€ä¹ˆæ‰§è¡Œäº†ï¼Œå’Œ<code>AST</code>, æˆ‘ä»¬å°±æ¥çœ‹çœ‹æ€ä¹ˆç¼–å†™ä»£ç ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ  protoc-gen-unknow git:(main) tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ internal</span><br><span class="line">â”‚Â Â  â””â”€â”€ unknow.go</span><br><span class="line">â”œâ”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ out</span><br><span class="line">â”‚Â Â  â””â”€â”€ unknow.pb.go</span><br><span class="line">â””â”€â”€ proto</span><br><span class="line">    â”œâ”€â”€ descriptor.proto</span><br><span class="line">    â””â”€â”€ unknow.proto</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯æˆ‘çš„ä¸€ä¸ªä»£ç ç»“æ„ç›®å½•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"internal"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/compiler/protogen"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">u := internal.Unknow&#123;&#125;</span><br><span class="line">protogen.Options&#123;&#125;.Run(u.Generate)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬å€ŸåŠ©<code>protobuf</code> ç¼–è¯‘åŒ…ä¸‹çš„ <code>protogen</code> å·¥å…·æ¥è§£æ <code>proto</code> æ–‡ä»¶ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ <code>internal</code> åŒ…ä¸‹å…·ä½“çš„å†™æ³•ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> internal</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">pb <span class="string">"out"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/compiler/protogen"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/proto"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/types/descriptorpb"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Unknow <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">Generate</span><span class="params">(plugin *protogen.Plugin)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(plugin.Files) &lt; <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æŒ‡å®šç”Ÿæˆæ–‡ä»¶çš„æ–‡ä»¶å</span></span><br><span class="line">filename := <span class="string">"/api.unknow.go"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç”Ÿæˆå™¨å¯¹è±¡</span></span><br><span class="line">g := plugin.NewGeneratedFile(filename, plugin.Files[<span class="built_in">len</span>(plugin.Files)<span class="number">-1</span>].GoImportPath)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨g.På°±æ˜¯å¾€æ–‡ä»¶å¼€å§‹å†™å…¥è‡ªå·±æœŸå¾…çš„ä»£ç </span></span><br><span class="line">g.P(<span class="string">`// Copyright (c) 2021, whiteCcinn Inc.`</span>)</span><br><span class="line">g.P(<span class="string">"// Code generated by protoc-gen-unknow. DO NOT EDIT."</span>)</span><br><span class="line">g.P(<span class="string">"// source: all MethodOptions(unknow.api.http) in proto file"</span>)</span><br><span class="line">g.P()</span><br><span class="line">g.P(<span class="string">"package "</span>, plugin.Files[<span class="built_in">len</span>(plugin.Files)<span class="number">-1</span>].GoPackageName)</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">`</span></span><br><span class="line"><span class="string">type Api struct &#123;</span></span><br><span class="line"><span class="string">Name   string</span></span><br><span class="line"><span class="string">Method string</span></span><br><span class="line"><span class="string">Url    string</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">func newApi(name, method, url string) *Api &#123;</span></span><br><span class="line"><span class="string">return &amp;Api&#123;</span></span><br><span class="line"><span class="string">name, method, url,</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">"var ("</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡plugin.Fielsï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°æ‰€æœ‰çš„è¾“å…¥çš„protoæ–‡ä»¶</span></span><br><span class="line"><span class="comment">// å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªæ–‡ä»¶ç”Ÿæˆä»£ç çš„è¯ï¼Œé‚£ä¹ˆå°±è¿›å…¥åˆ°generateFile()é€»è¾‘</span></span><br><span class="line"><span class="comment">// å¹¶ä¸”æŠŠgå’Œfä¸€èµ·ä¼ é€’è¿‡å»</span></span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> plugin.Files &#123;</span><br><span class="line"><span class="keyword">if</span> f.Generate &#123;</span><br><span class="line"><span class="keyword">if</span> _, err := u.generateFile(g, f); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">")"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">generateFile</span><span class="params">(g *protogen.GeneratedFile, file *protogen.File)</span> <span class="params">(*protogen.GeneratedFile, error)</span></span> &#123;</span><br><span class="line"><span class="comment">// è¿™ä¸€æ®µä»£ç ä»…ä»…åªæ˜¯ä¸ºäº†å¿½ç•¥åŒ…å«protoæ–‡ä»¶ä¸­åŒ…å«äº†streamClientå’ŒstreamServerçš„ä»£ç </span></span><br><span class="line">isGenerated := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> _, srv := <span class="keyword">range</span> file.Services &#123;</span><br><span class="line"><span class="keyword">for</span> _, method := <span class="keyword">range</span> srv.Methods &#123;</span><br><span class="line"><span class="keyword">if</span> method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">isGenerated = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !isGenerated &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file çš„ä¸‹ä¸€å±‚çº§å°±æ˜¯ services å±‚çº§</span></span><br><span class="line"><span class="keyword">for</span> _, srv := <span class="keyword">range</span> file.Services &#123;</span><br><span class="line"><span class="keyword">if</span> err := u.genService(g, srv); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> g, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">genService</span><span class="params">(g *protogen.GeneratedFile, srv *protogen.Service)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// service å†…éƒ¨æœ‰å¾ˆå¤š rpc å…³é”®å­—çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">for</span> _, method := <span class="keyword">range</span> srv.Methods &#123;</span><br><span class="line"><span class="keyword">if</span> method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”±äºæˆ‘ä»¬è‡ªå®šä¹‰çš„æ˜¯å°±æ˜¯MethodOptionsï¼Œæ‰€ä»¥å°±æ¥åˆ°äº†è¿™é‡Œæ¥è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line"><span class="keyword">if</span> err := u.genMethodHTTPRule(g, method); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">genMethodHTTPRule</span><span class="params">(g *protogen.GeneratedFile, method *protogen.Method)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// å› ä¸ºæˆ‘ä»¬é€šè¿‡method.Desc.Options() æ‹¿åˆ°çš„æ•°æ®ç±»å‹æ˜¯`interface&#123;&#125;` ç±»å‹</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹Optionsï¼Œæ˜ç¡®æŒ‡å®šè½¬æ¢ä¸º *descriptorpb.MethodOptions ç±»å‹</span></span><br><span class="line"><span class="comment">// è¿™æ ·å­å°±èƒ½æ‹¿åˆ°æˆ‘ä»¬çš„MethodOptionå¯¹è±¡</span></span><br><span class="line">options, ok := method.Desc.Options().(*descriptorpb.MethodOptions)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PSï¼šé‡ç‚¹</span></span><br><span class="line"><span class="comment">// è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å€ŸåŠ©äº†ä¸€ä¸ªéprotogenä¸‹çš„åŒ…çš„å†…å®¹</span></span><br><span class="line"><span class="comment">// åŸå› å°±æ˜¯ï¼Œprotobufç¼–è¯‘å™¨ä¼šæŠŠè‡ªå®šä¹‰çš„Optionå…¨éƒ¨æŒ‡å®šä¸ºExtensionï¼Œç”±äºå¹¶éå†…ç½®çš„å±æ€§å’Œå€¼</span></span><br><span class="line"><span class="comment">// protobufå®˜æ–¹æ˜¯æ²¡åŠæ³•æ‹¿åˆ°å’Œä½ å¯¹åº”çš„å¯è¯»çš„å†…å®¹çš„ï¼Œåªèƒ½é€šè¿‡æ‹¿åˆ°ç»è¿‡åºåˆ—åŒ–ä¹‹åçš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// å› æ­¤ï¼Œæˆ‘ä»¬è¿™é‡Œé€šè¿‡ proto.GetExtensionçš„æ–¹æ³•ï¼ŒæŠŠåˆšæ‰unknow.protoå•ç‹¬ç¼–è¯‘å¥½çš„ unknow.pb.proto æ–‡ä»¶ä¸‹çš„ pb. E_HTTP åŠ è½½è¿›æ¥ï¼ŒæŒ‡å®šäº†æˆ‘éœ€è¦åœ¨è‡ªå®šä¹‰æ‰©å±•çš„MethodOptionsä¸­ï¼Œæ‹¿åˆ°è¯¥Httpä¸‹é‡Œé¢çš„value</span></span><br><span class="line"><span class="comment">// ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å†ç»è¿‡ä¸€æ¬¡ç±»å‹è½¬æ¢ï¼Œå°±å¯ä»¥æ‹¿åˆ°äº†å…·ä½“çš„httpRule</span></span><br><span class="line">httpRule, ok := proto.GetExtension(options, pb.E_Http).(*pb.HttpRule)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡GetXxxçš„æ–¹å¼ï¼Œæ¥è·å–æˆ‘ä»¬è®¾ç½®åœ¨å…¶Messageå†…éƒ¨filed</span></span><br><span class="line">m := httpRule.GetMethod()</span><br><span class="line">url := httpRule.GetUrl()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(m) == <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(url) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">"     "</span>, method.GoName, <span class="string">"Api = "</span>, <span class="string">"newApi(\""</span>, method.GoName, <span class="string">"\", \""</span>, m, <span class="string">"\", \""</span>, url, <span class="string">"\")"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¯·è·Ÿç€è¯´æ˜ä¸­æ³¨é‡Šä¸€æ­¥æ­¥æŸ¥çœ‹è¯¦è§£</p></blockquote><p>æŸ¥çœ‹è¿™æ®µä»£ç é€»è¾‘ï¼Œä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œå› ä¸ºæ²¡æœ‰ç‰¹åˆ«å¤æ‚çš„é€»è¾‘ï¼Œå°½é‡ä¸è¦è·³è¿‡ï¼Œå› ä¸ºé‡Œé¢æ¶‰åŠåˆ°å¦‚ä½•è¯»å–è‡ªå®šä¹‰çš„Optionçš„é—®é¢˜ã€‚ä»£ç å¤§è‡´å®šä½åœ¨ <code>proto.GetExtension</code>æ–¹æ³•é™„è¿‘ã€‚</p><p>å› ä¸ºè¿™é‡Œçš„demoç”Ÿæˆçš„ä»£ç æ¯”è¾ƒç®€å•ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬ç”Ÿæˆçš„ä»£ç å°±æ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2021, whiteCcinn Inc.</span></span><br><span class="line"><span class="comment">// Code generated by protoc-gen-unknow. DO NOT EDIT.</span></span><br><span class="line"><span class="comment">// source: source: all MethodOptions(unknow.api.http) in proto file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Api <span class="keyword">struct</span> &#123;</span><br><span class="line">Name   <span class="keyword">string</span></span><br><span class="line">Method <span class="keyword">string</span></span><br><span class="line">Url    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newApi</span><span class="params">(name, method, url <span class="keyword">string</span>)</span> *<span class="title">Api</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Api&#123;</span><br><span class="line">name, method, url,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">RegisterDeviceApi = newApi(<span class="string">"RegisterDevice"</span>, <span class="string">"post"</span>, <span class="string">"/v1/im/register_device"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>æ”¾ä¸€ä¸‹å®Œæ•´çš„æµ‹è¯•å‘½ä»¤:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install . &amp;&amp; protoc --proto_path proto/ -I=. test.proto  test2.proto --unknow_out=./out --go_out=./out</span><br></pre></td></tr></table></figure><p>æœ€åç”Ÿæˆçš„æ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">âœ  protoc-gen-unknow git:(main) tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ internal</span><br><span class="line">â”‚Â Â  â””â”€â”€ unknow.go</span><br><span class="line">â”œâ”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ out</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ api.unknow.go</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ test.pb.go</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ test2.pb.go</span><br><span class="line">â”‚Â Â  â””â”€â”€ unknow.pb.go</span><br><span class="line">â””â”€â”€ proto</span><br><span class="line">    â”œâ”€â”€ descriptor.proto</span><br><span class="line">    â”œâ”€â”€ test.proto</span><br><span class="line">    â”œâ”€â”€ test2.proto</span><br><span class="line">    â””â”€â”€ unknow.protos</span><br></pre></td></tr></table></figure><p>æœ€åæ¨èå‡ ä¸ªæ‰©å±•åº“å†™å¾—ä¸é”™çš„æ‰©å±•æ’ä»¶: </p><ul><li><a href="https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-grpc-gateway" target="_blank" rel="noopener">protoc-gen-grpc-gateway</a></li><li><a href="https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-openapiv2" target="_blank" rel="noopener">protoc-gen-grpc-openapiv2</a></li><li><a href="https://github.com/nametake/protoc-gen-gohttp" target="_blank" rel="noopener">protoc-gen-grpc-gohttp</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘ï¼Œé¡¹ç›®éœ€è¦ç”¨åˆ°protobufæ¥å®šä¹‰æ¶ˆæ¯ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´çµæ´»çš„ä»£ç ç‰‡æ®µï¼Œå¦‚ä½•é€šè¿‡&lt;code&gt;proto&lt;/code&gt;æ–‡ä»¶æ¥åˆ›å»ºè‡ªå®šä¹‰çš„ä»£ç å‘¢ï¼Ÿ&lt;br&gt;å¯ä»¥é€šè¿‡protoçš„&lt;code&gt;plugin&lt;/code&gt;å¯¹æ–¹å¼æ¥è‡ªå·±æ˜¯ä¸€ä¸ª&lt;code&gt;proto-gen&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ç½‘ä¸Šçœ‹äº†ä¸€äº›æ•™ç¨‹ï¼Œå‘ç°æœ‰ä¸€äº›æ•™ç¨‹å·²ç»è¿‡æ—¶äº†ï¼Œè€Œä¸”è¿‡äºç‰‡é¢ï¼Œæ²¡æœ‰æŠŠæ•´å¥—æ€æƒ³å¾ˆå¥½çš„è¯´æ˜ã€‚å¹¶ä¸”ä¹Ÿæœ‰ä¸€äº›åŠŸèƒ½ç‚¹å¹¶æ²¡æœ‰å®Œå…¨å®ç°ã€‚&lt;br&gt;è¿™é‡Œæ€»ç»“ä¸€ä¸‹ç›¸å…³çš„å†…å®¹ï¼Œå¹¶ä¸”è¯´ä¸€ä¸‹æœ€è¿‘å®ç°çš„ä¸€ä¸ªæ’ä»¶ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å¯¹äºå·²ç»äº†è§£å¤§æ¦‚&lt;code&gt;proto&lt;/code&gt;çš„äººæ¥è¯´ï¼Œç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯å¦‚æœæ˜¯&lt;code&gt;è‡ªå®šä¹‰option&lt;/code&gt;å‘¢ï¼Ÿä½ åˆäº†è§£å—ï¼Ÿ&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>ã€Golangã€‘- []byteåœ¨ç»“æ„ä½“çš„å‹å¥½å¯è¯»æ€§å¤„ç†</title>
    <link href="http://blog.crazylaw.cn/2021/09/03/Golang/[]byte%E5%9C%A8%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%8F%8B%E5%A5%BD%E5%8F%AF%E8%AF%BB%E6%80%A7%E5%A4%84%E7%90%86/"/>
    <id>http://blog.crazylaw.cn/2021/09/03/Golang/[]byte%E5%9C%A8%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%8F%8B%E5%A5%BD%E5%8F%AF%E8%AF%BB%E6%80%A7%E5%A4%84%E7%90%86/</id>
    <published>2021-09-03T03:16:51.000Z</published>
    <updated>2021-09-03T05:55:43.831Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œ<code>[]byte</code> ç±»å‹åœ¨ <code>struct</code> ä¸­ï¼Œæ˜¯å¿…ä¸å¯å°‘çš„ç»“æ„ä½“ï¼Œå› ä¸ºç”¨äº†<code>[]byte</code>ä»£è¡¨å¯ä»¥å­˜å‚¨å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå¯ä»¥å«åšäºŒè¿›åˆ¶å®‰å…¨çš„å­˜å‚¨ã€‚ä»£è¡¨å¯ä»¥å­˜å‚¨ä»»ä½•æ•°æ®ã€‚</p><p>å¦‚ä½•æ‰èƒ½åšåˆ°åœ¨åºåˆ—åŒ–jsonçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥<code>Println</code>å‡ºä¸€ä¸ªå¯è¯»æ€§çš„åœ¨<code>struct</code>çš„<code>[]byte</code>å‘¢ï¼Ÿ</p><a id="more"></a><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>æœ€è¿‘æˆ‘åœ¨å¼€å‘æˆ‘ä»¬çš„éƒ¨é—¨çš„é…ç½®æœåŠ¡ï¼Œéœ€è¦æä¾›ä¸€ä¸ªé…ç½®å·¥å…·ã€‚é‡Œé¢è®¾è®¡çš„ä¸€ä¸ªstructï¼Œæœ‰ä¸€ä¸ª<code>[]byte</code>ç±»å‹ï¼Œå°±æ˜¯ç”¨æ¥å­˜å‚¨å®é™…æ•°æ®çš„ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæŸ¥çœ‹åŸå§‹æ•°æ®çš„éœ€æ±‚ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ç»è¿‡äº†<code>åŠ å¯†</code>ï¼Œå’Œ<code>å‹ç¼©</code>ï¼Œæœ€ç»ˆæ‰ä¼šæ”¾åˆ°è¯¥ç»“æ„ä½“ã€‚</p><p>ç®€åŒ–ç»“æ„ä½“ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ä¸‹ä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> V []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Value <span class="keyword">struct</span> &#123;</span><br><span class="line">PublishTime     <span class="keyword">int64</span></span><br><span class="line">PublishDateTime <span class="keyword">string</span></span><br><span class="line">Value           V</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™é‡Œçš„<code>Value</code>å®é™…å°±æ˜¯ä¸€ä¸ª<code>[]byte</code>ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªç»“æ„ä½“ç»è¿‡<code>json.Marshal</code>ä¹‹åæ¨é€åˆ°è¿œç«¯<code>kv</code>æœåŠ¡ä¸­ï¼Œä¸€åˆ‡éƒ½æ­£å¸¸ã€‚</p><p>ä½†æ˜¯å½“æˆ‘ä»¬éœ€è¦æŸ¥çœ‹çš„æ—¶å€™ï¼Œå°±éœ€è¦ä»è¿œç«¯çš„<code>kv</code>æ‹‰å›æ¥ï¼Œç»è¿‡<code>json.Unmarsha</code>å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"PublishTime"</span>:<span class="number">1630636657</span>,<span class="attr">"PublishDateTime"</span>:<span class="string">"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101"</span>,<span class="attr">"Value"</span>:<span class="string">"MTIzCg=="</span>&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°<code>Value</code>æ˜¯ä¸€ä¸ªç»è¿‡<code>base64</code>åŠ å¯†è¿‡çš„æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹<code>[]byte</code>å°†ä¼šæŠŠæ•°æ®ç»è¿‡<code>base64</code>å˜æˆ<code>å­—ç¬¦ä¸²</code>æ¥ç¬¦åˆ<code>jsonæ•°æ®ç±»å‹</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬æœ‰ä»€ä¹ˆç‰ˆæœ¬è®©ä»–æ˜¾ç¤ºå‡ºåŸæ¥çœŸæ˜¯çš„æ•°æ®å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªæ–¹æ¡ˆï¼Œå€ŸåŠ©å¤šä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå¯¹<code>T V</code>è¿›è¡Œä¸€ä¸ª<code>é‡ç»„</code>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> VO []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ValueReadable <span class="keyword">struct</span> &#123;</span><br><span class="line">PublishTime     <span class="keyword">int64</span></span><br><span class="line">PublishDateTime <span class="keyword">string</span></span><br><span class="line">Value           VO</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *VO)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> *b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *VO)</span> <span class="title">UnmarshalJSON</span><span class="params">(input []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">*b = input</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰å¤šä¸€ä¸ª<code>å¤§ä½“ä¸Šä¸€è‡´</code>çš„ç»“æ„ä½“ï¼Œæ³¨æ„æ­¤æ—¶çš„<code>Value</code>ä¸å†æ˜¯<code>V</code>ï¼Œè€Œæ˜¯<code>VO</code>ï¼Œæˆ‘ä»¬å¯¹<code>VO</code>è‡ªå®šä¹‰jsonåºåˆ—åŒ–çš„è¡Œä¸ºï¼Œé‚£å°±æ˜¯æŠŠ<code>base64</code>çš„è¡Œä¸ºç»™å»æ‰ã€‚</p><p>è¿™æ ·å­ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ•°æ®å°±ä¼šæ˜¯</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"PublishTime"</span>:<span class="number">1630636657</span>,<span class="attr">"PublishDateTime"</span>:<span class="string">"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101"</span>,<span class="attr">"Value"</span>:<span class="number">123</span>&#125;</span><br></pre></td></tr></table></figure><p>ç»†å¿ƒçš„æœ‹å‹ä¸€å®šå‘ç°äº†é—®é¢˜æ‰€åœ¨ï¼Œé‚£å°±æ˜¯<code>Value</code>å’Œ<code>ValueReadable</code>æ€ä¹ˆè¿›è¡Œè½¬æ¢ã€‚</p><p>å› ä¸ºä½ å­˜çš„æ—¶å€™æ˜¯é€šè¿‡<code>Value</code>è¿›è¡Œ<code>marshal</code>çš„ï¼Œé‚£ä¹ˆä½ çš„<code>unmarsha</code>è¡Œä¸ºä¸€å®šè¦å¯¹åº”æ‰èƒ½è§£åˆ°æ­£ç¡®çš„æ•°æ®ã€‚</p><p>æ‰€ä»¥è¿™é‡Œï¼Œå°±æ˜¯æˆ‘ä»¬çš„ä¸€ä¸ªé‡ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©<code>unsafe.Pointer</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// because []byte in struct will be base64encode</span></span><br><span class="line"><span class="comment">// so you will see such as "Ik1USXpDZz09Ig=="</span></span><br><span class="line"><span class="comment">// we should base64decode, so we custom a struct do not base64encode</span></span><br><span class="line"><span class="comment">// struct type transform use unsafe.Pointer</span></span><br><span class="line">p := unsafe.Pointer(&amp;persistenceValue)</span><br><span class="line">vr := (*config_sync.ValueReadable)(p)</span><br><span class="line">tv, err := json.Marshal(vr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="keyword">string</span>(tv))</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ©ç”¨<code>unsafe</code>çš„<code>æŒ‡é’ˆ</code>æ•°æ®ç±»å‹ï¼Œè¿›è¡Œä¸€ä¸ªå¼ºåˆ¶è½¬æ¢ï¼Œä¸ºä»€ä¹ˆä¼šæˆåŠŸå‘¢ï¼Œå› ä¸ºåœ¨å†…å­˜å¯¹é½çš„ç»“æ„ä¸Šï¼Œè¿™2ä¸ªå¯¹è±¡çš„å†…å­˜æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œå¼ºåˆ¶è½¬æ¢ï¼Œè€Œä¸ç”¨æ‹…å¿ƒæœ‰<code>panic</code>çš„äº§ç”Ÿã€‚è¿™åªæ˜¯<code>unsafe</code>æŒ‡é’ˆçš„ä¸€ä¸ªçµæ´»è¿ç”¨ã€‚ä½†æ˜¯å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œååˆ†çš„æœ‰æ•ˆæœã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"PublishTime"</span>:<span class="number">1630636657</span>,<span class="attr">"PublishDateTime"</span>:<span class="string">"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101"</span>,<span class="attr">"Value"</span>:<span class="number">123</span>&#125;</span><br></pre></td></tr></table></figure><p>è½¬æ¢åï¼Œå°±å¯ä»¥çœ‹åˆ°æˆ‘åŸæœ¬çš„æ•°æ®äº† <code>123</code>.</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œ&lt;code&gt;[]byte&lt;/code&gt; ç±»å‹åœ¨ &lt;code&gt;struct&lt;/code&gt; ä¸­ï¼Œæ˜¯å¿…ä¸å¯å°‘çš„ç»“æ„ä½“ï¼Œå› ä¸ºç”¨äº†&lt;code&gt;[]byte&lt;/code&gt;ä»£è¡¨å¯ä»¥å­˜å‚¨å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå¯ä»¥å«åšäºŒè¿›åˆ¶å®‰å…¨çš„å­˜å‚¨ã€‚ä»£è¡¨å¯ä»¥å­˜å‚¨ä»»ä½•æ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚ä½•æ‰èƒ½åšåˆ°åœ¨åºåˆ—åŒ–jsonçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥&lt;code&gt;Println&lt;/code&gt;å‡ºä¸€ä¸ªå¯è¯»æ€§çš„åœ¨&lt;code&gt;struct&lt;/code&gt;çš„&lt;code&gt;[]byte&lt;/code&gt;å‘¢ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>ã€kubernetesã€‘k8s-docker-for-mac-ç£ç›˜æŒ‚è½½</title>
    <link href="http://blog.crazylaw.cn/2021/08/18/k8s/k8s-docker-for-mac-%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/"/>
    <id>http://blog.crazylaw.cn/2021/08/18/k8s/k8s-docker-for-mac-%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/</id>
    <published>2021-08-18T09:47:30.000Z</published>
    <updated>2021-08-18T14:45:43.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸Šä¸€æ¬¡ï¼Œæˆ‘ä»¬è¯´åˆ°äº†<code>docker-for-mac</code> å·²ç»å†…ç½®äº†æœ€å°åŒ–çš„k8sã€‚æˆ‘ä»¬åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™ï¼Œæˆ–å¤šæˆ–å°‘å¸Œæœ›<code>yamlé…ç½®</code>æ˜¯æœ€æ¥è¿‘çº¿ä¸Šç¯å¢ƒçš„é…ç½®ã€‚</p><p>å› æ­¤ï¼Œä¸Šä¸€æ¬¡ï¼Œæ•™ä¼šäº†å¤§å®¶ï¼Œå¦‚ä½•åœ¨macä¸Šå¼€å¯nfs,æŠŠæˆ‘ä»¬çš„pvå’Œæœ¬åœ°macçš„nfsè¿›è¡Œä¸€ä¸ªé€šä¿¡ã€‚</p><p>è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ¥èŠèŠ<code>docker-for-mac</code>ç£ç›˜æŒ‚åœ¨çš„ç›¸å…³å†…å®¹ã€‚</p><a id="more"></a><h2 id="è™šæ‹Ÿæœº"><a href="#è™šæ‹Ÿæœº" class="headerlink" title="è™šæ‹Ÿæœº"></a>è™šæ‹Ÿæœº</h2><p><code>Docker for Mac</code>æ˜¯ä¸€ä¸ªåŸç”Ÿçš„è‹¹æœåº”ç”¨ç¨‹åºï¼Œè¢«å®‰è£…åˆ° <code>/Application ç›®å½•</code>ï¼Œå®‰è£…æ—¶ä¼šåˆ›å»º <code>/usr/local/bin</code> ç›®å½•ä¸‹çš„ <code>dockerã€docker-compose</code> ç¬¦å·é“¾æ¥ã€‚</p><p><code>Docker for Mac</code> ä½¿ç”¨é€šè¿‡ Hypervisor.framework æä¾›çš„è½»é‡çº§çš„ xhyve è™šæ‹ŸåŒ–æŠ€æœ¯<br><code>Docker for Mac</code> <code>ä¸ä½¿ç”¨</code> <code>docker-machine</code> ç®¡ç†è™šæ‹Ÿæœº<br><code>Docker for Mac</code> <code>ä¸é€šè¿‡ TCP ç«¯å£é€šä¿¡</code>ï¼Œåè€Œä½¿ç”¨ <code>docker.sock</code> å¥—æ¥å­—æ–‡ä»¶é€šä¿¡ï¼ˆå®é™…ä¸Šæ˜¯å°† /var/tmp ç›®å½•æŒ‚è½½åˆ°äº†è™šæ‹Ÿæœºä¸­ï¼Œè™šæ‹Ÿæœºåœ¨å…¶ä¸­ç”Ÿæˆå¥—æ¥å­—æ–‡ä»¶ï¼‰</p><p>ä½†æ˜¯å°½ç®¡å¦‚æ­¤ï¼Œä½ å¯ä»¥ç†è§£ä¸ºè¿˜æ˜¯å­˜åœ¨è™šæ‹Ÿæœºçš„ã€‚è¿™ä¸ªè™šæ‹Ÿæœºçš„ä½œç”¨å°±æ˜¯å…è®¸åœ¨macosä¸Šè¿è¡Œdockerã€‚</p><h2 id="docker-for-mac"><a href="#docker-for-mac" class="headerlink" title="docker for mac"></a>docker for mac</h2><p><img src="/images/k8s/docker-for-mac-1.png" alt="docker for mac 1"></p><p>è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„<code>docker-for-mac</code>çš„æ¡Œé¢ç‰ˆå®¢æˆ·ç«¯ã€‚</p><p><img src="/images/k8s/docker-for-mac-2.png" alt="docker for mac 2"></p><p>æ ¹æ®ä¸Šé¢è¿™ä¸ªå›¾ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ‰€æœ‰çš„é•œåƒéƒ½å­˜å‚¨åœ¨ã€‚</p><ul><li><code>/Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data</code> (è®°å¾—ä¿®æ”¹ä¸ºè‡ªå·±çš„è·¯å¾„ï¼Œå°±æ˜¯æˆ‘è¿™é‡Œçš„<code>caiwenhui</code>)</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ ll /Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data</span><br><span class="line">total 103652496</span><br><span class="line">-rw-r--r--  1 caiwenhui  staff    96G  8 18 20:21 Docker.raw</span><br><span class="line"></span><br><span class="line">âœ  ~ head -n 10 /Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw</span><br><span class="line">ï¿½Dï¿½ï¿½?ï¿½ï¿½ï¿½</span><br><span class="line">        Uï¿½`ï¿½&amp;3ï¿½Ñº`1Oï¿½ï¿½ ï¿½haï¿½haï¿½ï¿½Sï¿½Jï¿½#`</span><br><span class="line">                                     &lt;ï¿½kD*ï¿½&lt;O5Kï¿½VSï¿½~~ï¿½/var/libï¿½ï¿½Bï¿½uKï¿½ï¿½ï¿½ï¿½Jï¿½1ï¿½@</span><br><span class="line">                                                                             ]ï¿½#`</span><br><span class="line">ï¿½ï¿½ï¿½pï¿½ï¿½q  Zï¿½]J,)NLï¿½ï¿½ï¿½ï¿½ï¿½ï¿½w</span><br><span class="line">)ï¿½ï¿½%ï¿½</span><br><span class="line">z?fw</span><br><span class="line">    G/ï¿½%|gCÔ¬?fï¿½u</span><br><span class="line">                )</span><br><span class="line">)ï¿½% ï¿½.?f</span><br><span class="line">  ï¿½% |?f) ï¿½% ï¿½ï¿½?f)ï¿½ (L ï¿½ X %X i;ï¿½F!)D0 M %@ï¿½")ï¿½ ï¿½ï¿½ Ö‘@#)ï¿½ ï¿½ ï¿½fï¿½H$)" - :,ï¿½%)ï¿½</span><br><span class="line"> ï¿½e LEï¿½ï¿½()"h ï¿½a ï¿½ï¿½Snî±ªU&amp;43ï¿½%ï¿½C4kï¿½?f ï¿½% &#123; ï¿½% ï¿½D WA T Ò›                            ï¿½ï¿½ ï¿½ï¿½v&amp;)ï¿½" tï¿½ FWï¿½D') &#125;</span><br><span class="line">ï¿½1 &amp;ï¿½ ï¿½ ï¿½</span><br><span class="line">       (A ï¿½ï¿½ =ï¿½97 ï¿½; ï¿½&amp;N ï¿½ _ZË­ï¿½ ï¿½ ï¿½ï¿½</span><br><span class="line"> ï¿½% F?f</span><br><span class="line">      ï¿½0 ï¿½Vï¿½ï¿½</span><br><span class="line">           s</span><br><span class="line"> ï¿½% Ô‡ ï¿½% Xï¿½ ï¿½% sï¿½?f ï¿½RiDX0ï¿½mï¿½&#125;ï¿½u ï¿½</span><br><span class="line">                                  ï¿½@$ï¿½ï¿½ï¿½w?ï¿½  ï¿½% ï¿½ï¿½?f  ï¿½% ï¿½ï¿½?f. ï¿½ Õ‡ï¿½</span><br><span class="line"> ï¿½% MS?f</span><br><span class="line">         W s ï¿½wï¿½ ï¿½ ! ï¿½oï¿½</span><br><span class="line">  ï¿½% Eï¿½?f  ï¿½% nï¿½?f</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–‡ä»¶ï¼Œå ç”¨äº†<code>96G</code>ï¼Œå°±æ˜¯æˆ‘æ‰€åˆ†é…çš„ç£ç›˜å¤§å°ã€‚å¹¶ä¸”è¿™æ˜¯ä¸€ä¸ªç»è¿‡äº†å­—èŠ‚å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p><img src="/images/k8s/docker-for-mac-3.png" alt="docker for mac 3"></p><p><img src="/images/k8s/docker-for-mac-4.png" alt="docker for mac 4"></p><p>è¿™å¼ å›¾ï¼Œç®—å¾—ä¸Šæ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹ã€‚</p><p>ä½¿ç”¨æ–‡ä»¶å…±äº«å…è®¸ Mac ä¸Šçš„æœ¬åœ°ç›®å½•ä¸ Linux å®¹å™¨å…±äº«ã€‚é»˜è®¤æƒ…å†µä¸‹<code>/Users</code>ï¼Œ<code>/Volume</code>ã€<code>/private</code>ã€<code>/tmp</code>å’Œ<code>/var/folders</code>ç›®å½•æ˜¯å…±äº«çš„ã€‚å¦‚æœæ‚¨çš„é¡¹ç›®åœ¨æ­¤ç›®å½•ä¹‹å¤–ï¼Œåˆ™å¿…é¡»å°†å…¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚å¦åˆ™ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶å¾—åˆ°<code>Mounts denied</code>æˆ–<code>cannot start service</code>å‡ºé”™ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ‰å‡ ä¸ªç›®å½•æ˜¯å·²ç»è¢«å…±äº«çš„äº†ã€‚æˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯<code>/Users</code>ç›®å½•ï¼Œå› ä¸ºæˆ‘ä»¬å¸¸å¸¸æŠŠæˆ‘ä»¬çš„æ‰€æœ‰ä¸ªäººç”¨æˆ·ç›¸å…³çš„ä¸œè¥¿ï¼Œéƒ½ä¼šæ”¾åœ¨å¯¹åº”ç”¨æˆ·ä¸‹ï¼Œå°±æˆ‘è€Œè¨€ï¼Œæˆ‘ä¼šæŠŠæ‰€æœ‰çš„ä»£ç éƒ½åœ¨ <code>/Users/caiwenhui/www</code> ä¸‹ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘çš„æ‰€æœ‰ä»£ç ï¼Œéƒ½å°†ä¼šè¢«<code>è™šæ‹Ÿæœº</code>åŒæ­¥åˆ°<code>linuxç³»ç»Ÿ</code>ä¸­ï¼Œä¹Ÿæ­£æ˜¯å› æ­¤ï¼Œå½“ä½ åœ¨MACç³»ç»Ÿä¸‹ï¼Œæ‰§è¡Œ<code>docker run -v $(PWD):/www xxx</code>ä¹‹ç±»çš„å‘½ä»¤çš„æ—¶å€™ï¼Œä½ å¯ä»¥æˆåŠŸçš„æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚<strong>å¦‚æœä½ æŠŠæŒ‚è½½çš„ç›®å½•æ”¾åœ¨ä¸Šè¿°çš„å‡ ä¸ªç›®å½•ä¹‹å¤–</strong>ï¼Œdockerå‘½ä»¤å°†ä¼š<code>æŒ‚è½½å¤±è´¥</code>ã€‚</p><p>ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œä½ ä¼šå‘ç°ï¼Œå½“ä½ çš„ä»£ç ï¼Œåœ¨ä¸‹è½½å¤§é‡ä¾èµ–ï¼Œæˆ–è€…åœ¨æ„å»ºä¸€å †ç´¢å¼•çš„æ—¶å€™ï¼Œæˆ–è€…ä½ çš„<code>/Users</code>ç›®å½•ä¸‹æœ‰å¾ˆå¤šæ–‡ä»¶åœ¨å˜åŠ¨çš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°ä½ çš„<code>CPU</code>å˜æˆå¼‚å¸¸çš„é«˜ï¼Œè€Œä¸”ä¼šç‰¹åˆ«å¡ï¼Œå¯èƒ½ä½ ä¼šè§‰å¾—æ€ä¹ˆé‚£ä¹ˆå¡ã€‚å¦‚æœä½ ä¸å»æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹å ç”¨é‚£ä¹ˆå¤šcpuçš„è¯ï¼Œä½ æ°¸è¿œä¸ä¼šçŸ¥é“ï¼Œå…¶å®å¤§å¤šæ•°ï¼Œæ˜¾ç¤ºå‡ºæ¥éƒ½æ˜¯dockerçš„<code>è™šæ‹Ÿæœº</code>å ç”¨çš„cpuä¸ºå¤§å¤´å°±æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ã€‚</p><h2 id="è·å–è™šæ‹Ÿæœºshell"><a href="#è·å–è™šæ‹Ÿæœºshell" class="headerlink" title="è·å–è™šæ‹Ÿæœºshell"></a>è·å–è™šæ‹Ÿæœºshell</h2><p>æ—¢ç„¶ï¼Œæˆ‘ä»¬çŸ¥é“äº†ä¸Šè¿°çš„å…±äº«æ–‡ä»¶äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šæƒ³çŸ¥é“ï¼Œæˆ‘è¦æ€ä¹ˆå»çœ‹ï¼Œæ€ä¹ˆå»è°ƒè¯•ï¼Œæˆ–è€…æˆ‘æœ‰ä»€ä¹ˆæ›´æ·±çš„ç†è§£å‘¢ï¼Ÿ</p><p>å…¶å®æ˜¯æœ‰çš„ï¼Œä¾‹å¦‚ï¼Œæˆ‘æƒ³çœ‹çœ‹ï¼Œæ•´ä¸ªè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œéƒ½æŒ‚è½½äº†ä»€ä¹ˆæ•°æ®å·æ„æˆæˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>æˆ‘ä»¬çŸ¥é“<code>MacOS</code>ä¸Šçš„<code>Docker Desktop for mac</code>å®é™…ä¸Šæ˜¯åœ¨Linuxè™šæ‹Ÿæœºä¸­è¿è¡Œçš„Dockerå®¹å™¨ï¼Œè¿™å¯¹äºmacOSä¸»æœºä¸Šä½¿ç”¨Docker<code>å¤šäº†ä¸€å±‚è™šæ‹ŸåŒ–</code>ã€‚æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿè®¿é—®è¿™ä¸ªLinuxè™šæ‹Ÿæœºï¼Œä»¥ä¾¿å®ç°ä¸€äº›<code>hack</code>æ“ä½œã€‚</p><h3 id="netcat"><a href="#netcat" class="headerlink" title="netcat"></a>netcat</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ ll ~/Library/Containers/com.docker.docker/Data/debug-shell.sock</span><br><span class="line">srwxr-xr-x  1 caiwenhui  staff     0B  8 16 21:31 /Users/caiwenhui/Library/Containers/com.docker.docker/Data/debug-shell.sock</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªåå­—å«<code>debug-shell.sock</code>çš„æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„sockæ–‡ä»¶ã€‚</p><p>ä½¿ç”¨ <code>nc</code> å‘½ä»¤è¿æ¥Dockerçš„<code>debug-shell socket</code>æ–‡ä»¶:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ nc -U ~/Library/Containers/com.docker.docker/Data/debug-shell.sock</span><br><span class="line">/ # ^[[49;5R</span><br></pre></td></tr></table></figure><blockquote><p>æ˜¾ç¤ºçš„æç¤ºç¬¦æ¯”è¾ƒå¥‡æ€ªï¼Œä¸è¿‡ä¸å½±å“ä½¿ç”¨</p></blockquote><p>æˆ‘ä»¬ä½¿ç”¨ <code>df -h</code> å‘½ä»¤å¯ä»¥çœ‹åˆ°Dockerè™šæ‹Ÿæœºçš„å­˜å‚¨æŒ‚è½½:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/ # ^[[49;5Rdf -h</span><br><span class="line">df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /</span><br><span class="line">tmpfs                     3.9G      8.0K      3.9G   0% /containers/onboot/000-dhcpcd/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/001-sysfs/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/002-sysctl/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/003-format/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/004-extend/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/005-mount/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/006-metadata/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/007-services0/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/008-services1/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/009-swap/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/010-mount-docker/tmp</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /containers/services</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /containers/services/docker</span><br><span class="line">tmpfs                     3.9G      4.0K      3.9G   0% /containers/services/acpid/tmp</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /containers/services/acpid/rootfs</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/services/binfmt/tmp</span><br><span class="line">overlay                   3.9G         0      3.9G   0% /containers/services/binfmt/rootfs</span><br><span class="line">tmpfs                     3.9G      8.0K      3.9G   0% /containers/services/dhcpcd/tmp</span><br><span class="line">overlay                   3.9G      8.0K      3.9G   0% /containers/services/dhcpcd/rootfs</span><br><span class="line">tmpfs                     3.9G      4.0K      3.9G   0% /containers/services/diagnose/tmp</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /containers/services/diagnose/rootfs</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /containers/services/diagnose/rootfs</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/011-bridge/tmp</span><br><span class="line">tmpfs                    64.0M         0     64.0M   0% /dev</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/resolvconf/resolv.conf</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/config</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/containerd</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/guest-services</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/host-services</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/resolvconf/resolv.conf</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /var/lib/containerd</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /var/lib/docker</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /var/run</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /var/run/linuxkit-containerd/containerd.sock</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤ <code>exit</code> æˆ–è€…<code>^C</code> å¯ä»¥é€€å‡ºè¿™ä¸ªshell</p><p>è¿›å…¥shellï¼Œå¯ä»¥æ‰§è¡Œ <code>. /etc/profile</code> è·å¾—ç¯å¢ƒ</p><h3 id="nsenter"><a href="#nsenter" class="headerlink" title="nsenter"></a>nsenter</h3><p>ä½¿ç”¨nsenterä»å®¹å™¨å†…éƒ¨è¿›å…¥hostä¸»æœºçš„<code>åå­—ç©ºé—´(namespace)</code>ï¼Œä½†æ˜¯å¯¹æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯»</p><p>å¦å¤–ä¸€ç§å·§å¦™çš„æ–¹æ³•æ˜¯è¿è¡Œä¸€ä¸ªdebianå®¹å™¨ï¼Œç„¶ååœ¨è¿™ä¸ª<code>debian</code>å®¹å™¨ä¸­æ‰§è¡Œ <code>nsenter</code> é€šè¿‡ <code>pid=host</code> æ¥å®ç°è¿›å…¥åˆ°è¿è¡Œ <code>Docker4Mac</code> çš„<code>mini VM</code>çš„è¿›ç¨‹ç©ºé—´ï¼Œè¿™æ ·å°±ç›¸å½“äºè¿›å…¥äº†macOSçš„Dockerè™šæ‹Ÿæœº</p><p>åœ¨è¿™ä¸ªè¿è¡Œçš„debianå®¹å™¨ä¸­é€šè¿‡ nsenter è¿›å…¥åˆ°hostä¸»æœºï¼Œä¹Ÿå°±æ˜¯Docker VMåå­—ç©ºé—´ä»¥åï¼Œå°±å¯ä»¥çœ‹åˆ°è™šæ‹Ÿæœºçš„æç¤ºç¬¦:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker run -it --rm --privileged --pid=host debian nsenter -t 1 -m -u -n -i bash</span><br><span class="line">bash-5.0#</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªDocker VMä¸­æ‰§è¡Œç½‘ç»œæ£€æŸ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 brd 127.255.255.255 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 02:50:00:00:00:01 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.65.3/24 brd 192.168.65.255 scope global dynamic noprefixroute eth0</span><br><span class="line">       valid_lft 1576sec preferred_lft 136sec</span><br><span class="line">    inet6 fe80::50:ff:fe00:1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">4: ip6tnl0@NONE: &lt;NOARP&gt; mtu 1452 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/tunnel6 :: brd ::</span><br><span class="line">5: services1@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 42:2f:8d:45:a3:03 brd ff:ff:ff:ff:ff:ff link-netns services</span><br><span class="line">    inet 192.168.65.4 peer 192.168.65.5/32 scope global services1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::402f:8dff:fe45:a303/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: br-3a4b2ff7a5cb: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:11:9a:3a:8f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.7.1/24 brd 192.168.7.255 scope global br-3a4b2ff7a5cb</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: br-ef48d4809428: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:10:cb:22:b6 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-ef48d4809428</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: br-f6b05f844262: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:f4:ec:b5:c4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.19.0.1/16 brd 172.19.255.255 scope global br-f6b05f844262</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">10: br-ff0c8e959ac0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:48:7f:f8:bb brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.110.1/24 brd 192.168.110.255 scope global br-ff0c8e959ac0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:b9:db:7e:59 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:b9ff:fedb:7e59/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¿¡æ¯æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨å‡ ä¸ªç½‘å¡ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 02:50:00:00:00:01 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.65.3/24 brd 192.168.65.255 scope global dynamic noprefixroute eth0</span><br><span class="line">       valid_lft 1576sec preferred_lft 136sec</span><br><span class="line">    inet6 fe80::50:ff:fe00:1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:b9:db:7e:59 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:b9ff:fedb:7e59/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/docker-for-mac-5.png" alt="docker for mac 5"></p><p>ä¸Šé¢çš„ä¿¡æ¯ï¼Œç»“åˆæ¥çœ‹ï¼Œæˆ‘ä»¬åœ¨<code>docker-for-mac</code>å®¢æˆ·ç«¯è®¾ç½®äº†æˆ‘ä»¬çš„è™šæ‹Ÿæœºçš„ç½‘æ®µ <code>192.168.65.0/24</code>ï¼Œç»“åˆ<code>eth0</code>å’Œ<code>docker0</code>è¿™2ä¸ªç½‘å¡ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œ<code>eth0</code> çš„ <code>192.168.65.3</code>, å°±æ˜¯æˆ‘ä»¬è¿™æ˜¯çš„ç½‘æ®µçš„ä¿¡æ¯ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªè™šæ‹Ÿæœºå’ŒmacOSç‰©ç†ä¸»æœºä¸Šå¯¹åº”çš„IPåœ°å€ <code>192.168.65.1</code> å¯¹åº”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ <code>NFS æ–¹å¼</code>æŒ‚è½½ç‰©ç†ä¸»æœºä¸Šçš„NFSå·ï¼Œè®¿é—®çš„NFSæœåŠ¡å™¨ç«¯åœ°å€å°±æ˜¯è¿™æ ·è·å¾—çš„ã€‚</p><p>è¿™é‡Œè¿˜å¯ä»¥çœ‹åˆ°åœ¨<code>Docker VM</code>ä¸Šè¿è¡Œçš„<code>Dockerç½‘ç»œ</code>æ˜¯ <code>172.17.xx.xx/16</code> ï¼Œæ˜¯ä¸€ä¸ª<code>NATç½‘ç»œ</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨<code>Docker VMç«¯</code>åˆ†é…çš„IPåœ°å€æ˜¯ <code>172.17.0.1</code> ã€‚è¿™ä¹ŸéªŒè¯äº†æˆ‘ä»¬çš„<code>Docker VM</code>ä¸Šå®é™…ä¸Šæœ‰<code>2ä¸ªç½‘ç»œ</code>ã€‚</p><ul><li><code>192.168.65.x/24</code> =&gt; å’Œ<code>ç‰©ç†ä¸»æœºmacOS</code>è¿æ¥çš„NATç½‘ç»œï¼Œç”¨äºè™šæ‹Ÿæœº</li><li><code>172.17.x.x/16</code> =&gt; å’Œ<code>Docker0</code>è¿æ¥çš„NATç½‘ç»œï¼Œç”¨äºå®¹å™¨</li></ul><p>åœ¨Dockerå®¹å™¨ä¸­ï¼Œé€šè¿‡ä¸¤å±‚NATï¼Œä¾ç„¶å¯ä»¥è®¿é—®å¤–ç•ŒInternetã€‚ä¸è¿‡ï¼Œåè¿‡æ¥ï¼Œå¤–éƒ¨éœ€è¦è®¿é—®Dockerå®¹å™¨å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œéœ€è¦åš<code>ç«¯å£æ˜ å°„</code>ã€‚</p><h2 id="æŒ‚è½½"><a href="#æŒ‚è½½" class="headerlink" title="æŒ‚è½½"></a>æŒ‚è½½</h2><p>æˆ‘ä»¬å‰é¢è¯´åˆ°äº†ï¼Œå½“ä½ é€šè¿‡ <code>docker run -v</code>çš„æ—¶å€™ï¼Œä½ å¯ä»¥æŒ‡å®šåœ¨<code>å…±äº«ç›®å½•</code>ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¸‹ï¼Œè¿›è¡ŒæŒ‚è½½è¿›å»ã€‚é‚£ä¹ˆæˆ‘ä»¬åè¿‡æ¥æƒ³ä¸€ä¸‹ï¼Œæ—¢ç„¶æ˜¯å…±äº«ç›®å½•çš„è¯ï¼Œé‚£ä¹ˆå®¹å™¨æ˜¯å¦‚ä½•åšåˆ°æŸ¥æ‰¾è¿™äº›ç›®å½•çš„å‘¢ï¼Ÿ</p><p>é€šè¿‡<code>mount -l</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŒ‚è½½ç‚¹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# mount -l</span><br><span class="line">rootfs on / type tmpfs (ro,relatime)</span><br><span class="line">proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">tmpfs on /run type tmpfs (rw,nosuid,nodev,noexec,relatime,size=815300k,mode=755)</span><br><span class="line">tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noexec,relatime,size=815300k)</span><br><span class="line">tmpfs on /var type tmpfs (rw,nosuid,nodev,noexec,relatime,mode=755)</span><br><span class="line">dev on /dev type devtmpfs (rw,nosuid,noexec,relatime,size=4008488k,nr_inodes=1002122,mode=755)</span><br><span class="line">mqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">shm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)</span><br><span class="line">sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">debugfs on /sys/kernel/debug type debugfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">fusectl on /sys/fs/fuse/connections type fusectl (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">none on /sys/fs/bpf type bpf (rw,nodev,relatime)</span><br><span class="line">binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup_root on /sys/fs/cgroup type tmpfs (rw,nosuid,nodev,noexec,relatime,size=10240k,mode=755)</span><br><span class="line">cpuset on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)</span><br><span class="line">cpu on /sys/fs/cgroup/cpu type cgroup (rw,nosuid,nodev,noexec,relatime,cpu)</span><br><span class="line">cpuacct on /sys/fs/cgroup/cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)</span><br><span class="line">blkio on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">memory on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">devices on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">freezer on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)</span><br><span class="line">net_cls on /sys/fs/cgroup/net_cls type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls)</span><br><span class="line">perf_event on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">net_prio on /sys/fs/cgroup/net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio)</span><br><span class="line">hugetlb on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">pids on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™é‡Œæœ‰å¤§é‡çš„æŒ‚è½½ç‚¹ï¼Œè¿™äº›æŒ‚è½½ç‚¹ï¼Œç»„åˆæˆäº†ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…å„ç§å‘½åç©ºé—´ã€‚</p><p>ç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ä½¿ç”¨k8sçš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ç”¨<code>pv</code>çš„<code>type</code>ä¸º<code>hostPath</code>çš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥åšåˆ°æŒä¹…åŒ–æ•°æ®ç£ç›˜çš„ï¼Œé‚£ä¹ˆæˆ‘èƒ½ä¸èƒ½åšåˆ°ï¼Œæ•°æ®å­˜æ”¾åœ¨<code>Docker VM éå…±äº«ç›®å½•</code>ä¸­å‘¢ï¼Ÿ</p><p>å°±æ˜¯æˆ‘çš„ç‰©ç†ä¸»æœºï¼Œå¹¶ä¸å¸Œæœ›åŒæ­¥è¿™äº›æ•°æ®ã€‚è¿™äº›æ•°æ®ä»…ä»…åªéœ€è¦å­˜åœ¨<code>Docker VM</code>ä¸­å°±å¥½äº†ã€‚</p><p>å½“ç„¶ï¼Œè¿™ä¸ªåœºæ™¯å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´ï¼Œæˆ‘ä»¬æƒ³è¦çœ‹ä¸€äº›å®¹å™¨çš„é…ç½®æˆ–è€…ç›®å½•çš„æ—¶å€™ï¼Œä¼šå‘ç°è¾“å‡ºçš„è·¯å¾„ï¼Œåœ¨æˆ‘ä»¬çš„å®¿ä¸»æœºä¸Šæ‰¾ä¸åˆ°ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å­ï¼Ÿéš¾é“æ˜¯å‡ºé”™äº†å—ï¼Ÿå…¶å®åªæ˜¯è¿™äº›æ–‡ä»¶éƒ½åœ¨<code>Docker VM</code>ä¸­ï¼Œå…¶å®å°±æ˜¯å› ä¸ºè¿™ä¸ªåŸå› å¯¼è‡´çš„ã€‚åªè¦æˆ‘ä»¬è¿›å…¥åˆ° <code>Docker VM</code>å°±å¯ä»¥çœ‹åˆ°è¿™äº›æ–‡ä»¶ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥æˆ‘ç›®å‰çš„ä¾‹å­ä¸ºä¾‹å­ï¼Œæˆ‘éœ€è¦é‡‡é›†æˆ‘æœ¬åœ°æ‰€æœ‰<code>k8s-pods</code>çš„è¾“å‡ºåœ¨ç»ˆç«¯çš„æ—¥å¿—ä¿¡æ¯ï¼Œæˆ‘æƒ³é€šè¿‡<code>promtail</code>æ¥è¿›è¡Œæ—¥å¿—é‡‡é›†ï¼Œç„¶åé€šè¿‡<code>loki</code>ä½œä¸ºå­˜å‚¨å’ŒæŸ¥è¯¢æœåŠ¡å™¨ï¼Œå†é€šè¿‡<code>grafna</code>æ¥è¿›è¡Œå±•ç¤ºã€‚æˆ‘ä»¬çš„æœåŠ¡ä»¥å‰å°çš„æ–¹å¼è¿›è¡Œå¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬é‚£ä¹ˆé¦–å…ˆæˆ‘éœ€è¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯podsçš„æ ‡å‡†è¾“å‡ºåˆ°å“ªé‡Œï¼Ÿåæ¥å‘ç°<code>/var/log/pods/</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# ls -l /var/log/pods/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-grafana-7cd4c89fd4-wdkpb_cf869741-be0d-44d2-b776-3239dd276069</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-loki-statefulset-0_1d34dcac-a763-478a-b17b-addb082462ef</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-loki-statefulset-1_c82d61e9-c66f-4b6a-960a-a8f7a1d5a8e2</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-promtail-n6jgs_51afda31-be9c-4377-8167-8e29e991d9b0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_coredns-558bd4d5db-g2m9h_67ec7c7f-2e48-4cd7-8298-86295073072b</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_coredns-558bd4d5db-jk9bp_b9d8b64f-dda8-426a-8f55-029298828333</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_etcd-docker-desktop_5d9d97b8d8daed31d6fd5c6d386c29c5</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-apiserver-docker-desktop_6fcd2fd42808f86960df2a06a72d6dc0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-controller-manager-docker-desktop_bed77ee1871d9eabd1710836ad671f32</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-proxy-4wbs6_8bece9c8-e5fb-41f5-8869-2d408e71ba31</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-scheduler-docker-desktop_a52842863dff28cb2f7d4171a9f614a0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_storage-provisioner_79a3e8e5-6a93-43c1-abf3-c916384a4018</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_vpnkit-controller_3742d607-ea8f-43df-aecf-4f925accbc3e</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éšä¾¿æ‰¾ä¸€ä¸ªpodsï¼Œå»æŸ¥çœ‹æ—¥å¿—ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# tail -n 10 /var/log/pods/default_dev-grafana-7cd4c89fd4-wdkpb_cf869741-be0d-44d2-b776-3239dd276069/grafana/0.log</span><br><span class="line">&#123;"log":"&#123;\"@level\":\"debug\",\"@message\":\"datasource: registering query type handler\",\"@timestamp\":\"2021-08-18T09:05:05.385825Z\",\"queryType\":\"node_graph\"&#125;\n","stream":"stderr","time":"2021-08-18T09:05:05.3860495Z"&#125;</span><br><span class="line">&#123;"log":"&#123;\"@level\":\"debug\",\"@message\":\"datasource: registering query type fallback handler\",\"@timestamp\":\"2021-08-18T09:05:05.385855Z\"&#125;\n","stream":"stderr","time":"2021-08-18T09:05:05.3860803Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:05:05+0000 lvl=info msg=\"HTTP Server Listen\" logger=http.server address=[::]:3000 protocol=http subUrl= socket=\n","stream":"stdout","time":"2021-08-18T09:05:05.3939314Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:07:52+0000 lvl=eror msg=\"Failed to look up user based on cookie\" logger=context error=\"user token not found\"\n","stream":"stdout","time":"2021-08-18T09:07:52.5402974Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:07:52+0000 lvl=info msg=\"Request Completed\" logger=context userId=0 orgId=0 uname= method=GET path=/dashboard/new status=302 remote_addr=192.168.65.3 time_ms=0 size=29 referer=\n","stream":"stdout","time":"2021-08-18T09:07:52.5403468Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:07:56+0000 lvl=info msg=\"Successful Login\" logger=http.server User=admin@localhost\n","stream":"stdout","time":"2021-08-18T09:07:56.6167821Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:08:00+0000 lvl=info msg=\"Request Completed\" logger=context userId=1 orgId=1 uname=admin method=GET path=/login status=302 remote_addr=192.168.65.3 time_ms=11 size=24 referer=\n","stream":"stdout","time":"2021-08-18T09:08:00.7292107Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:09:50+0000 lvl=info msg=\"Request Completed\" logger=context userId=1 orgId=1 uname=admin method=GET path=/api/datasources/proxy/1/loki/api/v1/query_range status=400 remote_addr=192.168.65.3 time_ms=2 size=57 referer=\"http://localhost:3000/dashboard/new?editPanel=2\u0026orgId=1\"\n","stream":"stdout","time":"2021-08-18T09:09:50.7530735Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:14:53+0000 lvl=eror msg=\"Data proxy error\" logger=data-proxy-log userId=1 orgId=1 uname=admin path=/api/datasources/proxy/1/loki/api/v1/label/filename/values remote_addr=192.168.65.3 referer=\"http://localhost:3000/d/UWO8RT7nk/new-dashboard-copy?editPanel=2\u0026viewPanel=2\u0026orgId=1\" error=\"http: proxy error: EOF\"\n","stream":"stdout","time":"2021-08-18T09:14:53.0497419Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:14:53+0000 lvl=eror msg=\"Request Completed\" logger=context userId=1 orgId=1 uname=admin method=GET path=/api/datasources/proxy/1/loki/api/v1/label/filename/values status=502 remote_addr=192.168.65.3 time_ms=79695 size=0 referer=\"http://localhost:3000/d/UWO8RT7nk/new-dashboard-copy?editPanel=2\u0026viewPanel=2\u0026orgId=1\"\n","stream":"stdout","time":"2021-08-18T09:14:53.0502414Z"&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ—¥å¿—æ˜¯å­˜å‚¨åœ¨è¿™é‡Œäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼Œåœ¨<code>Docker VM</code>ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‚è½½<code>/var/log/pods</code>åˆ°æˆ‘ä»¬çš„å®¹å™¨<code>promtail</code>ä¸­ï¼Œç„¶åè¿›è¡Œé‡‡é›†å†æ¨é€åˆ°<code>loki</code>ï¼Œå°±å¯ä»¥é€šè¿‡<code>grafna</code>æŸ¥è¯¢äº†ã€‚</p><p>è¿™ä¸ªæ€è·¯æ˜¯æ²¡é—®é¢˜çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†å¾€æ·±ç¨‹åº¦çš„è§’åº¦æƒ³ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çš„<code>k8s-pv-type</code>åº”è¯¥å¡«ä»€ä¹ˆå‘¢ï¼Ÿåˆšæ‰ä¸æ˜¯è¯´äº†<code>hostPath</code>æ˜¯å¯ä»¥æŒä¹…åŒ–åˆ°æœ¬åœ°å—ï¼Ÿä½†æ˜¯é‚£æ˜¯é’ˆå¯¹ç‰©ç†ä¸»æœº<code>macos</code>æ¥è¯´çš„ï¼Œå†µä¸”è¿™ä¸ªç›®å½•ï¼Œæˆ‘ä»¬å¹¶éåœ¨<code>Docker VM</code>ä¹‹ä¸‹ï¼Œè¿™å°±å›åˆ°äº†æˆ‘ä»¬ä¸Šé¢è¯´çš„ï¼Œåœ¨<code>Docker VM</code>å­˜åœ¨ï¼Œåœ¨<code>ç‰©ç†ä¸»æœº</code>ä¸å­˜åœ¨çš„éœ€æ±‚ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®è¿˜æ˜¯å¯ä»¥ä½¿ç”¨<code>hostPath</code>çš„ï¼Œç†ç”±å¾ˆç®€å•ï¼Œå› ä¸ºk8sä¼šè¯†åˆ«è·¯å¾„ï¼Œå¦‚æœæ˜¯åœ¨å…±äº«ç›®å½•ä¸‹çš„è¯ï¼Œé‚£ä¹ˆä»–ä¼šä»å…±äº«ç›®å½•çš„æ•°æ®å·ä¸­æ‰¾åˆ°å¯¹åº”çš„ç£ç›˜è·¯å¾„ï¼Œå¦‚æœä¸åœ¨å…±äº«ç›®å½•ä¸‹çš„ï¼Œåˆ™ä»<code>Docker VM</code>ä¸­æŸ¥æ‰¾ï¼Œå› æ­¤ï¼Œè¿™å°±æ˜¯è§£å¼€äº†æˆ‘ä»¬è¿™ä¸ªç–‘æƒ‘äº†ã€‚å¯ä»¥å¤§èƒ†çš„æ”¾å¿ƒä½¿ç”¨<code>hostPath</code>æ¥åˆ›å»º<code>pv</code>èµ„æºã€‚</p><p>æœ€åï¼Œé™„ä¸Šä¸€å¼ æœ€ç»ˆçš„æ•ˆæœå›¾ï¼š</p><p><img src="/images/k8s/docker-for-mac-6.png" alt="docker-for-mac-6"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ä¸Šä¸€æ¬¡ï¼Œæˆ‘ä»¬è¯´åˆ°äº†&lt;code&gt;docker-for-mac&lt;/code&gt; å·²ç»å†…ç½®äº†æœ€å°åŒ–çš„k8sã€‚æˆ‘ä»¬åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™ï¼Œæˆ–å¤šæˆ–å°‘å¸Œæœ›&lt;code&gt;yamlé…ç½®&lt;/code&gt;æ˜¯æœ€æ¥è¿‘çº¿ä¸Šç¯å¢ƒçš„é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;å› æ­¤ï¼Œä¸Šä¸€æ¬¡ï¼Œæ•™ä¼šäº†å¤§å®¶ï¼Œå¦‚ä½•åœ¨macä¸Šå¼€å¯nfs,æŠŠæˆ‘ä»¬çš„pvå’Œæœ¬åœ°macçš„nfsè¿›è¡Œä¸€ä¸ªé€šä¿¡ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ¥èŠèŠ&lt;code&gt;docker-for-mac&lt;/code&gt;ç£ç›˜æŒ‚åœ¨çš„ç›¸å…³å†…å®¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€kubernetesã€‘k8s-glp</title>
    <link href="http://blog.crazylaw.cn/2021/08/16/k8s/k8s-glp/"/>
    <id>http://blog.crazylaw.cn/2021/08/16/k8s/k8s-glp/</id>
    <published>2021-08-16T14:45:30.000Z</published>
    <updated>2021-08-19T02:58:22.026Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬ç»å¸¸æœ‰ä¸€äº›æ—¥å¿—é‡‡é›†çš„éœ€æ±‚ï¼Œé‡‡é›†å®Œæ¯•ä¹‹åï¼Œå¸Œæœ›æœ‰ä¸€ä¸ªä¸­å¿ƒWebUiæ¥æ–¹ä¾¿çš„æŸ¥çœ‹å¾ˆå¤šä¸åŒèŠ‚ç‚¹ï¼Œä¸åŒæœåŠ¡çš„æ—¥å¿—ã€‚</p><p>æŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼šé‡‡ç”¨<code>ELK</code>,å°±æ˜¯<code>elasticsearch+logstash+kibana</code>ï¼Œä½†æ˜¯ç”±äº<code>JVM</code>å¯¹èµ„æºçš„æ¶ˆè€—å¤ªå¤§ï¼ŒåŠ ä¸Š<code>ES</code>æ˜¯é€šè¿‡å…¨æ–‡æœç´¢çš„æ–¹å¼éœ€è¦è¿›è¡Œå€’æ’ç´¢å¼•çš„åˆ†è¯ï¼Œæ‰€ä»¥è¿™äº›åŠŸèƒ½å‡ ä¹æ˜¯ç”¨ä¸ä¸Šï¼Œæˆ‘ä»¬æŸ¥è¯¢æ—¥å¿—ä¸€èˆ¬éƒ½å¯ä»¥é€šè¿‡å®šåˆ¶å¸¸è§„çš„<code>label</code>ä¿¡æ¯ï¼Œç„¶åæœç´¢å³å¯ï¼Œå¤§å¯ä¸å¿…è¿›è¡Œåˆ†è¯çš„è¡Œä¸ºã€‚å°½ç®¡åç»­åˆç”±äº<code>logstash</code>çš„èµ„æºå ç”¨è¿‡å¤§é—®é¢˜ï¼Œä½œè€…åˆåˆ©ç”¨goè¯­è¨€å¼€å‘å‡ºäº†<code>filebeat</code>ï¼Œæ¥è¾…åŠ©æ—¥å¿—é‡‡é›†ä½“ç³»ï¼Œåç»­åŠ å…¥äº†æŸå…¬å¸ä¹‹åï¼Œè¢«é›†æˆåˆ°äº†<code>beats</code>çš„é¡¹ç›®ä¸­ï¼Œå› ä¸ºä¹Ÿå¯ä»¥äº¤<code>efk/ebk</code>ï¼Œéƒ½å¯ä»¥ã€‚</p><p>é‰´äºè¿™ä¸€ç‚¹ï¼Œéšä¹‹è€Œæ¥çš„å°±æ˜¯<code>GLP</code>ï¼Œå°±æ˜¯<code>grafna+loki+promtail</code>ã€‚è¿™æ˜¯ä¸€å¥—å®Œå…¨åŸºäºgoè¯­è¨€ç”Ÿæ€å†™çš„ï¼Œæ›´è´´è¿‘äº‘åŸç”Ÿã€‚ä¸€å¥—ä½“ç³»éƒ½æ˜¯ç»è¿‡<code>grafna lab</code>äº‘åŸç”Ÿå­•è‚²è€Œç”Ÿã€‚èµ„æºå ç”¨å°‘ï¼Œæ•ˆç‡é«˜ï¼Œèƒ½å¤Ÿè§£å†³ç—›ç‚¹ï¼Œå¤©ç”Ÿæ”¯æŒk8sç­‰ç­‰ç‰¹æ€§ã€‚éƒ½è®©ä»–æˆä¸ºæ–°çš„å´›èµ·ä¹‹ç§€ã€‚</p><a id="more"></a><h2 id="Kubernetes-Logs"><a href="#Kubernetes-Logs" class="headerlink" title="Kubernetes Logs"></a>Kubernetes Logs</h2><p><img src="/images/k8s/glp-1.webp" alt="glp-1"></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨æ—¥å¿—ä¼šå­˜å‚¨åœ¨ <code>/var/log/pods</code> è·¯å¾„ä¸‹ã€‚</p><p>æ¯ä¸ªæ–‡ä»¶å¤¹å¯¹åº”ä¸€ä¸ª Podï¼ŒPod ä¸‹çº§ç›®å½•ä¸ºå®¹å™¨åï¼Œå†ä¸‹çº§å³ä¸ºå®¹å™¨æ—¥å¿—ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tree kube-system_kube-flannel-ds-amd64-9x66j_28e71490-d614-4cd8-9ea7-af23cc7b9bff/</span><br><span class="line"></span><br><span class="line">kube-system_kube-flannel-ds-amd64-9x66j_28e71490-d614-4cd8-9ea7-af23cc7b9bff/</span><br><span class="line">â”œâ”€â”€ install-cni</span><br><span class="line">â”‚   â””â”€â”€ 3.log -&gt; /data/docker/containers/6accaa2d6890df8ca05d1f40aaa9b8da69ea0a00a8e4b07a0949cdc067843e37/6accaa2d6890df8ca05d1f40aaa9b8da69ea0a00a8e4b07a0949cdc067843e37-json.log</span><br><span class="line">â””â”€â”€ kube-flannel</span><br><span class="line">    â”œâ”€â”€ 2.log -&gt; /data/docker/containers/9e8eea717cc3efd0804900a53244a32286d9e04767f76d9c8a8cc3701c83ece5/9e8eea717cc3efd0804900a53244a32286d9e04767f76d9c8a8cc3701c83ece5-json.log</span><br><span class="line">    â””â”€â”€ 3.log -&gt; /data/docker/containers/06389981d26cbe60328cd5a46af7b003c8d687d1c411704784aa12d4d82672b8/06389981d26cbe60328cd5a46af7b003c8d687d1c411704784aa12d4d82672b8-json.log</span><br></pre></td></tr></table></figure><p>æ—¥å¿—æ–‡ä»¶ <code>kube-flannel/3.log</code> åªæ˜¯å¯¹ <code>/var/lib/docker/containers/***/***.log</code> æ–‡ä»¶çš„<code>è½¯é“¾æ¥</code>ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ Docker ç»´æŠ¤æ—¥å¿—ï¼Œ k8s å¯¹å…¶<code>å¼•ç”¨</code>è€Œå·²ã€‚</p><p>æ—¥å¿—æ˜¯ JSON æ ¼å¼çš„ï¼Œæ¯ä¸€è¡ŒåŒ…å«å¦‚ä¸‹ä¸‰ä¸ªä¿¡æ¯ï¼š</p><ul><li><code>log</code>ï¼šæ—¥å¿—å†…å®¹</li><li><code>stream</code>ï¼šstderr(å¼‚å¸¸è¾“å‡º)ã€stdout(æ­£å¸¸è¾“å‡º)</li><li><code>time</code>ï¼šæ—¶é—´</li></ul><p><code>/var/lib/docker/containers</code> æ˜¯é€šè¿‡ <code>/etc/docker/daemon.json</code> é…ç½®çš„ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯é»˜è®¤è·¯å¾„ã€‚</p><h2 id="grafna"><a href="#grafna" class="headerlink" title="grafna"></a>grafna</h2><p>ç”±äºk8sçš„ç½‘ç»œæ¶æ„çš„åŸå› ï¼Œæˆ‘ä»¬è®¿é—®çš„æ—¶å€™éƒ½æ˜¯é€šè¿‡è®¿é—®<code>service</code>çš„åå­—çš„ï¼Œå’Œdocker-composeä¸‹çš„è®¿é—®æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚</p><p>ä¾‹å¦‚.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  whiteccinn.github.io git:(master) âœ— kubectl get svc</span><br><span class="line">NAME           TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">dev-grafana    LoadBalancer   10.102.248.247   localhost     3000:32695/TCP   17h</span><br><span class="line">dev-loki       ClusterIP      10.106.32.224    &lt;none&gt;        3100/TCP         17h</span><br><span class="line">dev-promtail   ClusterIP      10.108.116.190   &lt;none&gt;        9080/TCP         17h</span><br><span class="line">kubernetes     ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          3d9h</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œå®¹å™¨ä¸­çš„è®¿é—®æ–¹å¼å°±æ˜¯é€šè¿‡<code>dev-loki</code>, <code>dev-promtail</code>, <code>dev-grafna</code>æ¥å¯¹podè¿›è¡Œè®¿é—®ï¼Œserviceçš„portå†æ˜ å°„åˆ°å¯¹åº”çš„å®¹å™¨çš„portä¸Š</p><h3 id="depployment"><a href="#depployment" class="headerlink" title="depployment"></a>depployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">472</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/grafana:7.5.2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-grafana</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/robots.txt</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">750Mi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">grafana-pvc</span></span><br></pre></td></tr></table></figure><h3 id="pvc"><a href="#pvc" class="headerlink" title="pvc"></a>pvc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-grafana</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure><h2 id="loki"><a href="#loki" class="headerlink" title="loki"></a>loki</h2><h3 id="config-map"><a href="#config-map" class="headerlink" title="config-map"></a>config-map</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">loki-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">auth_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">3100</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">ingester:</span></span><br><span class="line">      <span class="attr">lifecycler:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">ring:</span></span><br><span class="line">          <span class="attr">kvstore:</span></span><br><span class="line">            <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">          <span class="attr">replication_factor:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">final_sleep:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">chunk_idle_period:</span> <span class="string">5m</span></span><br><span class="line">      <span class="attr">chunk_retain_period:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">schema_config:</span></span><br><span class="line">      <span class="attr">configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">from:</span> <span class="number">2020</span><span class="number">-05</span><span class="number">-15</span></span><br><span class="line">        <span class="attr">store:</span> <span class="string">boltdb</span></span><br><span class="line">        <span class="attr">object_store:</span> <span class="string">filesystem</span></span><br><span class="line">        <span class="attr">schema:</span> <span class="string">v11</span></span><br><span class="line">        <span class="attr">index:</span></span><br><span class="line">          <span class="attr">prefix:</span> <span class="string">index_</span></span><br><span class="line">          <span class="attr">period:</span> <span class="string">168h</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">storage_config:</span></span><br><span class="line">      <span class="attr">boltdb:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/index</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">filesystem:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/chunks</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">limits_config:</span></span><br><span class="line">      <span class="attr">enforce_metric_name:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">reject_old_samples:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">reject_old_samples_max_age:</span> <span class="string">168h</span></span><br></pre></td></tr></table></figure><h3 id="pvc-1"><a href="#pvc-1" class="headerlink" title="pvc"></a>pvc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h3 id="service-1"><a href="#service-1" class="headerlink" title="service"></a>service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3100</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-loki</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">loki</span></span><br></pre></td></tr></table></figure><h3 id="statefulet"><a href="#statefulet" class="headerlink" title="statefulet"></a>statefulet</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/loki:2.3.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/loki-config.yml</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3100</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-loki</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp/loki</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">loki-pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">loki-config</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">loki-config.yml</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">loki-config.yml</span></span><br></pre></td></tr></table></figure><h2 id="promtail"><a href="#promtail" class="headerlink" title="promtail"></a>promtail</h2><h3 id="config-map-1"><a href="#config-map-1" class="headerlink" title="config-map"></a>config-map</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">promtail-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">grpc_listen_port:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">positions:</span></span><br><span class="line">      <span class="attr">filename:</span> <span class="string">/tmp/positions.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># clients:</span></span><br><span class="line">    <span class="comment"># - url: http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">containers</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">log_from:</span> <span class="string">static_pods</span></span><br><span class="line">          <span class="attr">__path__:</span> <span class="string">/var/log/pods/*/*/*.log</span></span><br><span class="line">      <span class="attr">pipeline_stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">docker:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;log_from="static_pods"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"(?:pods)/(?P&lt;namespace&gt;\\S+?)_(?P&lt;pod&gt;\\S+)-\\S+?-\\S+?_\\S+?/(?P&lt;container&gt;\\S+?)/"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">namespace:</span></span><br><span class="line">              <span class="attr">pod:</span></span><br><span class="line">              <span class="attr">container:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;namespace!~"(default|kube-system)"&#125;'</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">          <span class="attr">drop_counter_reason:</span> <span class="string">no_use</span></span><br></pre></td></tr></table></figure><h3 id="daemonest"><a href="#daemonest" class="headerlink" title="daemonest"></a>daemonest</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/promtail:2.3.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/promtail-config.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-client.url=http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-client.external-labels=hostname=$(NODE_NAME)</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9080</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-promtail</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/pods</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/pods</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">promtail-config</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šä¸Šè¿°æåˆ° <code>/var/log/pods</code> ä¸‹çš„æ—¥å¿—åªæ˜¯å¯¹ <code>/var/lib/docker/containers</code> ä¸‹æ—¥å¿—çš„<code>è½¯é“¾æ¥</code>ï¼Œæ‰€ä»¥ Promtail éƒ¨ç½²æ—¶éœ€è¦<code>åŒæ—¶æŒ‚è½½è¿™ä¸¤ä¸ªç›®å½•</code>ã€‚</p><h3 id="service-2"><a href="#service-2" class="headerlink" title="service"></a>service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-promtail</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">promtail</span></span><br></pre></td></tr></table></figure><p>è¿™äº›è¯¦æƒ…çš„å‚æ•°å°±ä¸è§£é‡Šçš„ï¼Œè¿™å°±æ˜¯ä¸€æ•´å¥—<code>GLP</code>çš„k8sçš„éƒ¨ç½²æ–‡ä»¶ã€‚ç”±äºæˆ‘è¿™é‡Œæ˜¯é‡‡ç”¨<code>kustomize</code>æ¥éƒ¨ç½²çš„ã€‚æ‰€ä»¥ä¼šæœ‰å¤šå±‚ç»“æ„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">âœ  kustomize git:(main) tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ base</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ grafna</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ deployment.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pvc.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ service.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kustomization.yml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ loki</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ config-map.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pvc.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ service.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ statefulset.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ promtail</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ config-map.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ daemonset.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ kustomization.yml</span><br><span class="line">â”‚Â Â      â””â”€â”€ service.yaml</span><br><span class="line">â””â”€â”€ overlays</span><br><span class="line">    â”œâ”€â”€ dev</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ kustomization.yml</span><br><span class="line">    â”‚Â Â  â””â”€â”€ patch.yaml</span><br><span class="line">    â””â”€â”€ prod</span><br><span class="line">        â”œâ”€â”€ kustomization.yml</span><br><span class="line">        â””â”€â”€ patch.yaml</span><br></pre></td></tr></table></figure><p>ä¸€æ•´å¥—çš„è¿è¡Œå°±æ˜¯:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">âœ</span>  <span class="string">kustomize</span> <span class="string">git:(main)</span> <span class="string">kustomize</span> <span class="string">build</span> <span class="string">overlays/dev</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">promtail-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">grpc_listen_port:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">positions:</span></span><br><span class="line">      <span class="attr">filename:</span> <span class="string">/tmp/positions.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># clients:</span></span><br><span class="line">    <span class="comment"># - url: http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">containers</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">log_from:</span> <span class="string">static_pods</span></span><br><span class="line">          <span class="attr">__path__:</span> <span class="string">/var/log/pods/*/*/*.log</span></span><br><span class="line">      <span class="attr">pipeline_stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">docker:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;log_from="static_pods"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"(?:pods)/(?P&lt;namespace&gt;\\S+?)_(?P&lt;pod&gt;\\S+)-\\S+?-\\S+?_\\S+?/(?P&lt;container&gt;\\S+?)/"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">namespace:</span></span><br><span class="line">              <span class="attr">pod:</span></span><br><span class="line">              <span class="attr">container:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;namespace!~"(default|kube-system)"&#125;'</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">          <span class="attr">drop_counter_reason:</span> <span class="string">no_use</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-promtail-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">loki-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">auth_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">3100</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">ingester:</span></span><br><span class="line">      <span class="attr">lifecycler:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">ring:</span></span><br><span class="line">          <span class="attr">kvstore:</span></span><br><span class="line">            <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">          <span class="attr">replication_factor:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">final_sleep:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">chunk_idle_period:</span> <span class="string">5m</span></span><br><span class="line">      <span class="attr">chunk_retain_period:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">schema_config:</span></span><br><span class="line">      <span class="attr">configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">from:</span> <span class="number">2020</span><span class="number">-05</span><span class="number">-15</span></span><br><span class="line">        <span class="attr">store:</span> <span class="string">boltdb</span></span><br><span class="line">        <span class="attr">object_store:</span> <span class="string">filesystem</span></span><br><span class="line">        <span class="attr">schema:</span> <span class="string">v11</span></span><br><span class="line">        <span class="attr">index:</span></span><br><span class="line">          <span class="attr">prefix:</span> <span class="string">index_</span></span><br><span class="line">          <span class="attr">period:</span> <span class="string">168h</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">storage_config:</span></span><br><span class="line">      <span class="attr">boltdb:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/index</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">filesystem:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/chunks</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">limits_config:</span></span><br><span class="line">      <span class="attr">enforce_metric_name:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">reject_old_samples:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">reject_old_samples_max_age:</span> <span class="string">168h</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-grafana</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3100</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-loki</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-promtail</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-grafana-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">      <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">      <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">        <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">        <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">grafana/grafana:7.5.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-grafana</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/robots.txt</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">750Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">472</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">dev-grafana-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">      <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">      <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">dev-loki</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">        <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">        <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/loki-config.yml</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/loki:2.3.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3100</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-loki</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp/loki</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">dev-loki-pvc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">loki-config.yml</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">loki-config.yml</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dev-loki-config</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">      <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">      <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">        <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">        <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/promtail-config.yml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-client.url=http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-client.external-labels=hostname=$(NODE_NAME)</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/promtail:2.3.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-promtail</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/pods</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log/pods</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dev-promtail-config</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-volume</span></span><br></pre></td></tr></table></figure><p>é‡‡ç”¨ <code>kustomize build overlays/dev | kubectl apply -f -</code> æ¥è¿è¡Œæˆ‘ä»¬çš„<code>dev</code>ç¯å¢ƒçš„k8sæ‰€æœ‰çš„æœåŠ¡ã€‚</p><p>é€šè¿‡<code>kubectl port-forward deployment.apps/dev-grafana 3000:3000</code> æ¥åšç«¯å£çš„è½¬å‘ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  whiteccinn.github.io git:(master) âœ— kubectl port-forward deployment.apps/dev-grafana 3000:3000</span><br><span class="line">Forwarding from 127.0.0.1:3000 -&gt; 3000</span><br><span class="line">Forwarding from [::1]:3000 -&gt; 3000</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>kubectl get svc</code> æŸ¥çœ‹ç«¯å£è½¬å‘æƒ…å†µã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  whiteccinn.github.io git:(master) âœ— kubectl get svc</span><br><span class="line">NAME           TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">dev-grafana    LoadBalancer   10.102.248.247   localhost     3000:32695/TCP   17h</span><br><span class="line">dev-loki       ClusterIP      10.106.32.224    &lt;none&gt;        3100/TCP         17h</span><br><span class="line">dev-promtail   ClusterIP      10.108.116.190   &lt;none&gt;        9080/TCP         17h</span><br><span class="line">kubernetes     ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          3d10h</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé€šè¿‡å‘½ä»¤ <code>kubectl get pods -o wide</code> çœ‹åˆ°æ‰€æœ‰çš„podséƒ½åœ¨æ­£å¸¸è¿ä½œäº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  whiteccinn.github.io git:(master) âœ— kubectl get pods -o wide</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP          NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">dev-grafana-7cd4c89fd4-wdkpb   1/1     Running   0          17h   10.1.0.16   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">dev-loki-statefulset-0         1/1     Running   0          17h   10.1.0.18   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">dev-loki-statefulset-1         1/1     Running   0          17h   10.1.0.19   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">dev-promtail-n6jgs             1/1     Running   0          17h   10.1.0.17   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æµè§ˆå™¨æ‰“å¼€<code>localhost:3000</code>ï¼Œå³å¯è®¿é—®åˆ°<code>grafna</code>äº†ã€‚</p><p>grafnaé»˜è®¤çš„è´¦å·å¯†ç å°±æ˜¯<code>admin</code>ã€‚</p><p>1.æˆ‘ä»¬å…ˆæ¥é…ç½®grafnaçš„Dashboardã€‚</p><p><img src="/images/k8s/glp-3.png" alt="æ•°æ®æº"></p><p>2.å¯¹æ—¥å¿—è¿›è¡Œå¯è§†åŒ–é…ç½®ã€‚</p><p><img src="/images/k8s/glp-2.png" alt="log panel"></p><p>3.é…ç½®æœç´¢æ ã€‚</p><p><img src="/images/k8s/glp-4.png" alt="æœç´¢æ "></p><p>4.å¯ä»¥çœ‹åˆ°æœç´¢æ äº†ï¼Œå¹¶ä¸”éœ€è¦æ›´æ–°ä¸€ä¸‹æŸ¥è¯¢çš„å…¬å¼</p><p><img src="/images/k8s/glp-5.png" alt="å…¬å¼"></p><p>è¿™é‡Œå°±æ˜¯æˆ‘å¸Œæœ›åˆ©ç”¨k8sçš„<code>glp</code>æ¥é‡‡é›†æˆ‘çš„æ‰€æœ‰çš„podsåœ¨æ ‡å‡†è¾“å‡ºçš„æ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯ï¼Œåšä¸€ä¸ªæ±‡æ€»å’Œæ—¥å¿—ä¸­å¿ƒæŸ¥è¯¢çš„web-uiã€‚</p><p><img src="/images/k8s/docker-for-mac-6.png" alt="docker-for-mac-6"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬ç»å¸¸æœ‰ä¸€äº›æ—¥å¿—é‡‡é›†çš„éœ€æ±‚ï¼Œé‡‡é›†å®Œæ¯•ä¹‹åï¼Œå¸Œæœ›æœ‰ä¸€ä¸ªä¸­å¿ƒWebUiæ¥æ–¹ä¾¿çš„æŸ¥çœ‹å¾ˆå¤šä¸åŒèŠ‚ç‚¹ï¼Œä¸åŒæœåŠ¡çš„æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;æŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼šé‡‡ç”¨&lt;code&gt;ELK&lt;/code&gt;,å°±æ˜¯&lt;code&gt;elasticsearch+logstash+kibana&lt;/code&gt;ï¼Œä½†æ˜¯ç”±äº&lt;code&gt;JVM&lt;/code&gt;å¯¹èµ„æºçš„æ¶ˆè€—å¤ªå¤§ï¼ŒåŠ ä¸Š&lt;code&gt;ES&lt;/code&gt;æ˜¯é€šè¿‡å…¨æ–‡æœç´¢çš„æ–¹å¼éœ€è¦è¿›è¡Œå€’æ’ç´¢å¼•çš„åˆ†è¯ï¼Œæ‰€ä»¥è¿™äº›åŠŸèƒ½å‡ ä¹æ˜¯ç”¨ä¸ä¸Šï¼Œæˆ‘ä»¬æŸ¥è¯¢æ—¥å¿—ä¸€èˆ¬éƒ½å¯ä»¥é€šè¿‡å®šåˆ¶å¸¸è§„çš„&lt;code&gt;label&lt;/code&gt;ä¿¡æ¯ï¼Œç„¶åæœç´¢å³å¯ï¼Œå¤§å¯ä¸å¿…è¿›è¡Œåˆ†è¯çš„è¡Œä¸ºã€‚å°½ç®¡åç»­åˆç”±äº&lt;code&gt;logstash&lt;/code&gt;çš„èµ„æºå ç”¨è¿‡å¤§é—®é¢˜ï¼Œä½œè€…åˆåˆ©ç”¨goè¯­è¨€å¼€å‘å‡ºäº†&lt;code&gt;filebeat&lt;/code&gt;ï¼Œæ¥è¾…åŠ©æ—¥å¿—é‡‡é›†ä½“ç³»ï¼Œåç»­åŠ å…¥äº†æŸå…¬å¸ä¹‹åï¼Œè¢«é›†æˆåˆ°äº†&lt;code&gt;beats&lt;/code&gt;çš„é¡¹ç›®ä¸­ï¼Œå› ä¸ºä¹Ÿå¯ä»¥äº¤&lt;code&gt;efk/ebk&lt;/code&gt;ï¼Œéƒ½å¯ä»¥ã€‚&lt;/p&gt;
&lt;p&gt;é‰´äºè¿™ä¸€ç‚¹ï¼Œéšä¹‹è€Œæ¥çš„å°±æ˜¯&lt;code&gt;GLP&lt;/code&gt;ï¼Œå°±æ˜¯&lt;code&gt;grafna+loki+promtail&lt;/code&gt;ã€‚è¿™æ˜¯ä¸€å¥—å®Œå…¨åŸºäºgoè¯­è¨€ç”Ÿæ€å†™çš„ï¼Œæ›´è´´è¿‘äº‘åŸç”Ÿã€‚ä¸€å¥—ä½“ç³»éƒ½æ˜¯ç»è¿‡&lt;code&gt;grafna lab&lt;/code&gt;äº‘åŸç”Ÿå­•è‚²è€Œç”Ÿã€‚èµ„æºå ç”¨å°‘ï¼Œæ•ˆç‡é«˜ï¼Œèƒ½å¤Ÿè§£å†³ç—›ç‚¹ï¼Œå¤©ç”Ÿæ”¯æŒk8sç­‰ç­‰ç‰¹æ€§ã€‚éƒ½è®©ä»–æˆä¸ºæ–°çš„å´›èµ·ä¹‹ç§€ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€kubernetesã€‘k8s-pv-nfs-for-mac</title>
    <link href="http://blog.crazylaw.cn/2021/08/16/k8s/k8s-mac-pv-nfs/"/>
    <id>http://blog.crazylaw.cn/2021/08/16/k8s/k8s-mac-pv-nfs/</id>
    <published>2021-08-16T06:18:30.000Z</published>
    <updated>2021-08-16T07:06:32.263Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>docker-for-mac ç°åœ¨å·²ç»å†…ç½®äº†k8sï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾çš„å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡kubectlæ¥æ‰§è¡Œæˆ‘ä»¬çš„k8sçš„å‘½ä»¤æ¥å¯¹å®¹å™¨èµ„æºè¿›è¡Œç®¡ç†ã€‚</p><p>ä½†æ˜¯æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤´ç–¼çš„ç‚¹ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬çš„pvèµ„æºã€‚æˆ‘ä»¬å¹³æ—¶ç”¨dockerçš„æ—¶å€™ï¼Œæœ‰ä¸€äº›ä¿¡æ¯ä¾‹å¦‚ï¼Œæ—¥å¿—ä¹‹ç±»çš„ï¼Œéœ€è¦æŒä¹…åŒ–ä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªæ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–ä¼šå’Œå®¹å™¨æ‰€åœ¨çš„ç‰©ç†æœºåœ¨åŒä¸€ä¸ªæœºå™¨ä¸‹ï¼Œå› æ­¤ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„åšåˆ°â€œå­˜â€ï¼Œâ€œç®—â€åˆ†ç¦»çš„ç›®çš„ã€‚å¹¶ä¸”æ²¡åŠæ³•åˆ©ç”¨äº†ç½‘ç»œä¸Šçš„å…¶ä»–èµ„æºã€‚</p><p>å†è€…å°±æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œæˆ‘éœ€è¦åˆ©ç”¨k8séƒ¨ç½²ä¸€äº›åŸºç¡€æœåŠ¡ï¼Œä¾‹å¦‚mysqlï¼Œä¾‹å¦‚redisï¼Œè¿™äº›åŸºç¡€æ•°æ®éƒ½æ˜¯éœ€è¦æŒä¹…åŒ–çš„ï¼Œå› æ­¤ï¼Œå’Œç‰©ç†æœºå™¨å¼ºè¡Œç»‘å®šåœ¨ä¸€èµ·çš„è¯ï¼Œä¸‹æ¬¡æ•°æ®åœ¨å“ªä¸ªæ•°æ®å·éƒ½ä¸æ¸…æ¥šäº†ï¼Œæ›´æ²¡åŠæ³•é‡æ–°å›å¤æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„pvï¼Œä¸èƒ½ç®€å•çš„ä½¿ç”¨<code>hostPath</code>æˆ–è€…<code>local</code>ç±»å‹ï¼Œæ ¹æ®æœåŠ¡å™¨ä¸Šç”¨çš„æ¯”è¾ƒå¤šçš„æˆ–è®¸æ˜¯è‡ªå·±æ­å»ºä¸€ä¸ª<code>nfs</code> æœåŠ¡å™¨ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™å®šä¹‰èµ„æºæ–‡ä»¶<code>çš„yaml</code>ä¹Ÿæ˜¯ç”¨<code>nfs</code>æ¥ä½œä¸ºæˆ‘ä»¬çš„<code>pv-type</code>ã€‚</p><p>ä½†æ˜¯ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨macä¸Šå¼€å¯ä¸€ä¸ª<code>nfs-server</code>ã€‚å°è¯•è¿‡<a href="https://github.com/ehough/docker-nfs-server" target="_blank" rel="noopener">docker-nfs-server</a>ï¼Œä½†æ˜¯ç”±äºmacç³»ç»Ÿçš„æ¶æ„é—®é¢˜ï¼Œæ— æ³•é¡ºåˆ©çš„è¿è¡Œèµ·æ¥ï¼Œéœ€è¦å¤„ç†modpreæ¨¡å—ï¼Œå¤„ç†é‚£ä¹ˆå¤šå†…æ ¸çš„ä¸œè¥¿ä¸å¤ªåˆç†ã€‚</p><a id="more"></a><h2 id="built-in-nfs"><a href="#built-in-nfs" class="headerlink" title="built-in-nfs"></a>built-in-nfs</h2><p>åæ¥æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°äº†åŸæ¥æˆ‘ä»¬çš„macosï¼Œå†…ç½®äº†nfsï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ å¯¹åº”çš„é…ç½®å’Œå¼€å¯æœåŠ¡å³å¯ï¼Œååˆ†çš„æ–¹ä¾¿ã€‚</p><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>è¿™ä¸ªæ–‡ä»¶é»˜è®¤æ˜¯ä¸å­˜åœ¨çš„ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºå’Œæ·»åŠ é‡Œé¢çš„å†…å®¹ï¼Œä¸ç†Ÿæ‚‰nfsçš„æœ‹å‹éœ€è¦å»çœ‹ä¸€ä¸‹nfsçš„é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/exports</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># è¿½åŠ ä»¥ä¸‹æ–‡ä»¶åˆ°æ–‡ä»¶ä¸­</span></span></span><br><span class="line">/Users/caiwenhui/nas_a -alldirs -maproot=caiwenhui:staff</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„å«ä¹‰æ˜¯:</p><ul><li>/Users/caiwenhui/nas_a æŒ‡å®šå…±äº«ç›®å½•</li><li>-alldirs å…±äº«ç›®å½•ä¸‹çš„æ‰€æœ‰ç›®å½•</li><li>-maproot æŠŠclientç«¯çš„caiwenhuiç”¨æˆ·æ˜ å°„ä¸ºMacOSä¸Šçš„rootï¼Œclientç«¯çš„staffç»„æ˜ å°„ä¸ºMacOSä¸Šçš„wheel (gid=0) ç»„</li></ul><h3 id="æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®"><a href="#æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®" class="headerlink" title="æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®"></a>æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nfsd checkexports</span><br></pre></td></tr></table></figure><p>å¦‚æœéƒ½æ­£ç¡®çš„è¯ï¼Œé»˜è®¤ä»€ä¹ˆéƒ½ä¸ä¼šè¾“å‡ºã€‚å¦‚æœå­˜åœ¨é—®é¢˜çš„è¯ï¼Œåˆ™ä¼šå¼¹å‡ºé”™è¯¯é…ç½®ä¿¡æ¯ã€‚</p><h3 id="etc-nfs-conf"><a href="#etc-nfs-conf" class="headerlink" title="/etc/nfs.conf"></a>/etc/nfs.conf</h3><p>å¦‚æœk8séœ€è¦è¿ç”¨nfsï¼Œè¿˜éœ€è¦æ·»åŠ ä¸€è¡Œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs.server.mount.require_resv_port &#x3D; 0</span><br></pre></td></tr></table></figure><h3 id="æœåŠ¡å‘½ä»¤"><a href="#æœåŠ¡å‘½ä»¤" class="headerlink" title="æœåŠ¡å‘½ä»¤"></a>æœåŠ¡å‘½ä»¤</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo nfsd start # å¯åŠ¨æœåŠ¡</span><br><span class="line">sudo nfsd stop # åœæ­¢æœåŠ¡</span><br><span class="line">sudo nfsd restart # é‡å¯æœåŠ¡</span><br><span class="line">sudo nfsd status # æŸ¥çœ‹çŠ¶æ€</span><br><span class="line">sudo nfsd enable # å¼€æœºè‡ªå¯</span><br><span class="line">sudo nfsd disable # ç¦æ­¢å¼€æœºè‡ªå¯</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ"><a href="#æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ" class="headerlink" title="æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ"></a>æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ</h3><p><code>showmount -e</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ showmount -e</span><br><span class="line">Exports list on localhost:</span><br><span class="line">&#x2F;Users&#x2F;caiwenhui&#x2F;nas_a              Everyone</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æŒ‚åœ¨çš„æ•°æ®å·å·²ç»ç”Ÿæ•ˆï¼Œå¹¶ä¸”æ˜¯everyone(ä»»ä½•ç½‘æ®µï¼Œä»»ä½•ç”¨æˆ·)éƒ½å¯ä»¥è¿›è¡Œ<code>è¯»å†™</code>ã€‚å› ä¸ºæ˜¯æœ¬åœ°å¼€å‘ï¼Œæ‰€ä»¥è¿™ä¹ˆè®¾ç½®æœ€æ–¹ä¾¿ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨ä¸Šçš„ï¼Œå°±éœ€è¦é’ˆå¯¹ç‰¹å®šçš„ç½‘æ®µæˆ–è€…ipä»¥åŠuseräº†ã€‚è¯¦æƒ…æŸ¥çœ‹nfsé…ç½®ã€‚</p><h3 id="æœ¬åœ°æµ‹è¯•"><a href="#æœ¬åœ°æµ‹è¯•" class="headerlink" title="æœ¬åœ°æµ‹è¯•"></a>æœ¬åœ°æµ‹è¯•</h3><blockquote><p>è¿™ä¸€æ­¥ä½ å¤§å¯ä¸å¿…æµ‹è¯•ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘æƒ³å…ˆç¡®ä¿nfsçš„æœåŠ¡çš„æ­£å¸¸ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># åˆ›å»ºclientè§’è‰²çš„ç›®å½•ï¼Œå°±æ˜¯è¢«æŒ‚è½½çš„ç›®å½•</span></span></span><br><span class="line">mkdir /Users/caiwenhui/nas_a2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># æ¨¡æ‹ŸclientæŒ‚è½½nfsæ•°æ®å·å‘½ä»¤</span></span></span><br><span class="line">sudo mount -t nfs -o nolock,nfsvers=3,vers=3 127.0.0.1:/Users/caiwenhui/nas_a /Users/caiwenhui/nas_a2</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„æ„æ€æ˜¯ï¼š</p><ul><li>æŒ‚è½½ç±»å‹ï¼šnfs</li><li>é‡‡ç”¨nfs-v3åè®®: nfsvers=3,vers=3</li><li>nfs-serverçš„ç›®å½•: 127.0.0.1:/Users/caiwenhui/nas_a ï¼ˆè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬<code>showmount -e</code>æŸ¥çœ‹åˆ°çš„è·¯å¾„ï¼‰</li><li>nfs-clientçš„ç›®å½•ï¼š/Users/caiwenhui/nas_a2</li></ul><p>æŒ‚è½½æˆåŠŸä¹‹åï¼Œå°è¯•åœ¨clientç›®å½•æ·»åŠ æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /Users/caiwenhui/nas_a2/hello</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹serverç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶åŒæ­¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /Users/caiwenhui/nas_a</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ä¼šå‘ç°nas_aç›®å½•ä¸‹ï¼Œè‡ªåŠ¨å¤šäº†ä¸€ä¸ª<code>hello</code>çš„æ–‡ä»¶</p><p>å–æ¶ˆæŒ‚åœ¨ï¼Œå¯ä»¥åœ¨<code>finderä¸­ç›´æ¥å¼¹å‡ºæŒ‚è½½</code>ï¼Œæˆ–è€…<code>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</code>å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /Users/caiwenhui/nas_a2</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ä½ å†å»çœ‹ <code>/Users/caiwenhui/nas_a2</code> ç›®å½•ä¸‹ï¼Œ<code>hello</code>æ–‡ä»¶ä¸è§äº†ï¼Œä½†æ˜¯<code>/Users/caiwenhui/nas_a/hello</code>ä¾æ—§å­˜åœ¨ã€‚</p><h2 id="k8sä¸­æµ‹è¯•nfs"><a href="#k8sä¸­æµ‹è¯•nfs" class="headerlink" title="k8sä¸­æµ‹è¯•nfs"></a>k8sä¸­æµ‹è¯•nfs</h2><h3 id="NFS-PersistentVolume"><a href="#NFS-PersistentVolume" class="headerlink" title="NFS PersistentVolume"></a>NFS PersistentVolume</h3><p>å‰é¢æˆ‘ä»¬å·²ç»åœ¨macä¸Šå¯åŠ¨äº†ä¸€ä¸ªNFSæœåŠ¡ï¼Œç°åœ¨é€šè¿‡åœ¨k8sä¸Šåˆ›å»ºä¸€ä¸ªPersistentVolumeæ¥ä½¿ç”¨NFSã€‚</p><p>åˆ›å»ºä¸€ä¸ªPVï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶<code>nfs-pv-1.yaml</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">âœ</span>  <span class="string">~</span> <span class="string">cat</span> <span class="string">nfs-pv-1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfsvers=3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nolock</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/Users/caiwenhui/nas_a</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">docker.for.mac.host.internal</span></span><br></pre></td></tr></table></figure><p>nfsç›¸å…³çš„é…ç½®ï¼š</p><ul><li>nfsvers=3 ä½¿ç”¨v3åè®®</li><li>è·¯å¾„å°±æ˜¯nfsä¸Šçš„ç›®å½•</li><li>æ³¨æ„è¿™é‡Œï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨ipï¼Œå¦‚æœä¸èƒ½æ˜ç¡®çš„ç›®å‰ç°åœ¨çš„ç½‘ç»œé€šä¿¡æƒ…å†µçš„ä¸‹ï¼Œè¯·ä½¿ç”¨<code>docker.for.mac.host.internal</code></li></ul><p>ç”³è¯·èµ„æºPVã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nfs-pv-1.yaml</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹èµ„æºçŠ¶æ€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">nfspv1   2Gi        RWO            Recycle          Available           nfs                     13h</span><br></pre></td></tr></table></figure><p>STATUSä¸º<code>Available</code>è¡¨ç¤ºnfspv1å°±ç»ªï¼Œå¯ä»¥è¢«PVCç”³è¯·ã€‚</p><h3 id="PersistentVolumeClaim"><a href="#PersistentVolumeClaim" class="headerlink" title="PersistentVolumeClaim"></a>PersistentVolumeClaim</h3><p>ä¸‹é¢åˆ›å»ºPVCï¼Œç¼–è¾‘nfs-pvc-1.yamlæ–‡ä»¶</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">âœ</span>  <span class="string">~</span> <span class="string">cat</span> <span class="string">nfs-pvc-1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspvc1</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br></pre></td></tr></table></figure><p>ç”³è¯·èµ„æºPVCã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nfs-pvc-1.yaml</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹pvcçŠ¶æ€/æŸ¥çœ‹pvçŠ¶æ€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ kubectl get pvc</span><br><span class="line">NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">nfspvc1   Bound    nfspv1   10Gi       RWO            nfs            85s</span><br><span class="line"></span><br><span class="line">âœ  ~ kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM             STORAGECLASS   REASON   AGE</span><br><span class="line">nfspv1   2Gi        RWO            Recycle          Bound    default/nfspvc1   nfs                     13h</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>status = bound</code>ï¼Œä»£è¡¨æ­¤æ—¶<code>pv</code>å’Œ<code>pvc</code>å·²ç»ç»‘å®šåœ¨ä¸€èµ·äº†ã€‚è¿™æ ·å­æˆ‘ä»¬å°±å¯ä»¥æŠŠ<code>pod</code>å’Œ<code>pvc</code>ç»‘å®šã€‚</p><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>ç¼–è¾‘pod1.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">âœ</span>  <span class="string">~</span> <span class="string">cat</span> <span class="string">pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/mydata"</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">nfspvc1</span></span><br></pre></td></tr></table></figure><p>ç”³è¯·èµ„æºpod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pod1.yaml</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹podçŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ kubectl describe pod</span><br><span class="line">Name:         mypod1</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         docker-desktop&#x2F;192.168.65.4</span><br><span class="line">Start Time:   Mon, 16 Aug 2021 01:07:01 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.1.0.6</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.1.0.6</span><br><span class="line">Containers:</span><br><span class="line">  mypod1:</span><br><span class="line">    Container ID:  docker:&#x2F;&#x2F;0351e0c89fb94a3a1c8888939c641fc7b9b48d1f915f3653ca0ac188c50ae242</span><br><span class="line">    Image:         busybox</span><br><span class="line">    Image ID:      docker-pullable:&#x2F;&#x2F;busybox@sha256:0f354ec1728d9ff32edcd7d1b8bbdfc798277ad36120dc3dc683be44524c8b60</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Args:</span><br><span class="line">      &#x2F;bin&#x2F;sh</span><br><span class="line">      -c</span><br><span class="line">      sleep 30000</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Mon, 16 Aug 2021 01:07:08 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      &#x2F;mydata from mydata (rw)</span><br><span class="line">      &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount from kube-api-access-pftwg (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  mydata:</span><br><span class="line">    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)</span><br><span class="line">    ClaimName:  nfspvc1</span><br><span class="line">    ReadOnly:   false</span><br><span class="line">  kube-api-access-pftwg:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io&#x2F;not-ready:NoExecute op&#x3D;Exists for 300s</span><br><span class="line">                             node.kubernetes.io&#x2F;unreachable:NoExecute op&#x3D;Exists for 300s</span><br><span class="line">Events:                      &lt;none&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°<code>Mounts</code>ç›¸å…³çš„å†…å®¹å·²ç»æŒ‚è½½æ­£ç¡®ï¼Œå¹¶ä¸”å®¹å™¨ä¹Ÿæ­£ç¡®åœ¨è¿è¡Œäº†ã€‚æˆ‘ä»¬å¯¹æŒ‚è½½å¥½çš„æ•°æ®å·æ“ä½œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec mypod1 touch /mydata/hello2</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨æœ¬åœ°çš„nfs-serverçš„ç›®å½•<code>/Users/caiwenhui/nas_a</code> æŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦å¤šäº†<code>hello2</code>çš„æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /Users/caiwenhui/nas_a</span><br><span class="line">hello hello2</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œhello2è¢«æˆåŠŸåˆ›å»ºï¼Œpodèƒ½æ­£ç¡®çš„è®¿é—®çš„pvæŒ‚è½½é“¾æ¥æœ¬åœ°nfs-serveräº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;docker-for-mac ç°åœ¨å·²ç»å†…ç½®äº†k8sï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾çš„å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡kubectlæ¥æ‰§è¡Œæˆ‘ä»¬çš„k8sçš„å‘½ä»¤æ¥å¯¹å®¹å™¨èµ„æºè¿›è¡Œç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤´ç–¼çš„ç‚¹ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬çš„pvèµ„æºã€‚æˆ‘ä»¬å¹³æ—¶ç”¨dockerçš„æ—¶å€™ï¼Œæœ‰ä¸€äº›ä¿¡æ¯ä¾‹å¦‚ï¼Œæ—¥å¿—ä¹‹ç±»çš„ï¼Œéœ€è¦æŒä¹…åŒ–ä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªæ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–ä¼šå’Œå®¹å™¨æ‰€åœ¨çš„ç‰©ç†æœºåœ¨åŒä¸€ä¸ªæœºå™¨ä¸‹ï¼Œå› æ­¤ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„åšåˆ°â€œå­˜â€ï¼Œâ€œç®—â€åˆ†ç¦»çš„ç›®çš„ã€‚å¹¶ä¸”æ²¡åŠæ³•åˆ©ç”¨äº†ç½‘ç»œä¸Šçš„å…¶ä»–èµ„æºã€‚&lt;/p&gt;
&lt;p&gt;å†è€…å°±æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œæˆ‘éœ€è¦åˆ©ç”¨k8séƒ¨ç½²ä¸€äº›åŸºç¡€æœåŠ¡ï¼Œä¾‹å¦‚mysqlï¼Œä¾‹å¦‚redisï¼Œè¿™äº›åŸºç¡€æ•°æ®éƒ½æ˜¯éœ€è¦æŒä¹…åŒ–çš„ï¼Œå› æ­¤ï¼Œå’Œç‰©ç†æœºå™¨å¼ºè¡Œç»‘å®šåœ¨ä¸€èµ·çš„è¯ï¼Œä¸‹æ¬¡æ•°æ®åœ¨å“ªä¸ªæ•°æ®å·éƒ½ä¸æ¸…æ¥šäº†ï¼Œæ›´æ²¡åŠæ³•é‡æ–°å›å¤æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„pvï¼Œä¸èƒ½ç®€å•çš„ä½¿ç”¨&lt;code&gt;hostPath&lt;/code&gt;æˆ–è€…&lt;code&gt;local&lt;/code&gt;ç±»å‹ï¼Œæ ¹æ®æœåŠ¡å™¨ä¸Šç”¨çš„æ¯”è¾ƒå¤šçš„æˆ–è®¸æ˜¯è‡ªå·±æ­å»ºä¸€ä¸ª&lt;code&gt;nfs&lt;/code&gt; æœåŠ¡å™¨ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™å®šä¹‰èµ„æºæ–‡ä»¶&lt;code&gt;çš„yaml&lt;/code&gt;ä¹Ÿæ˜¯ç”¨&lt;code&gt;nfs&lt;/code&gt;æ¥ä½œä¸ºæˆ‘ä»¬çš„&lt;code&gt;pv-type&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨macä¸Šå¼€å¯ä¸€ä¸ª&lt;code&gt;nfs-server&lt;/code&gt;ã€‚å°è¯•è¿‡&lt;a href=&quot;https://github.com/ehough/docker-nfs-server&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;docker-nfs-server&lt;/a&gt;ï¼Œä½†æ˜¯ç”±äºmacç³»ç»Ÿçš„æ¶æ„é—®é¢˜ï¼Œæ— æ³•é¡ºåˆ©çš„è¿è¡Œèµ·æ¥ï¼Œéœ€è¦å¤„ç†modpreæ¨¡å—ï¼Œå¤„ç†é‚£ä¹ˆå¤šå†…æ ¸çš„ä¸œè¥¿ä¸å¤ªåˆç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€DevOpsã€‘è‡ªå®šä¹‰gitå‡­æ®å­˜å–å™¨</title>
    <link href="http://blog.crazylaw.cn/2021/08/02/DevOps/%E8%87%AA%E5%AE%9A%E4%B9%89git%E5%87%AD%E6%8D%AE%E5%AD%98%E5%8F%96%E5%99%A8/"/>
    <id>http://blog.crazylaw.cn/2021/08/02/DevOps/%E8%87%AA%E5%AE%9A%E4%B9%89git%E5%87%AD%E6%8D%AE%E5%AD%98%E5%8F%96%E5%99%A8/</id>
    <published>2021-08-02T06:35:30.000Z</published>
    <updated>2021-08-02T07:09:57.437Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘ï¼Œåœ¨å¤„ç†å…¬å¸åˆ°ä»£ç ä»“åº“ï¼Œå…¬å¸ç”±<code>gitbucket</code>è¿ç§»åˆ°<code>gitlab</code>åï¼Œä¸šåŠ¡é¡¹ç›®æ‹‰å–ç§æœ‰<code>vcs</code>çš„ä»£ç ä¾èµ–åŒ…çš„æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ã€‚</p><p>ä»¥å‰å¯èƒ½æ˜¯ä¸€ä¸ªâ€œæƒé™è¾ƒå¤§â€çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰å¤šä¸ªé¡¹ç›®ç»„çš„è®¿é—®æƒé™ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—®ç§æœ‰çš„<code>vcs</code>çš„ä»£ç ã€‚</p><p>ä½†æ˜¯è¿ç§»åˆ°gitlabä¹‹åï¼Œæ¯ä¸ªgroupä¸‹ï¼Œowneréƒ½å¯ä»¥é’ˆå¯¹è¿™ä¸ªgroupç”Ÿæˆå¯¹åº”éƒ½<code>deploy-key</code>ï¼Œæ‰€ä»¥å˜æˆäº†ä¸€ä¸ªgroupä¸‹ä¸€ä¸ªdeploy-keyã€‚</p><p>è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬éƒ½<code>go/php/node</code>é¡¹ç›®ï¼Œåœ¨æ‹‰å–ä¸åŒé¡¹ç›®éƒ½ä¾èµ–åŒ…éƒ½æ—¶å€™ï¼Œéœ€è¦æŠŠ<code>git-credential</code>çš„è´¦å·ä¿¡æ¯åˆ‡æ¢ã€‚</p><a id="more"></a><h2 id="git-build-in"><a href="#git-build-in" class="headerlink" title="git-build-in"></a>git-build-in</h2><p>Git æœ‰ä¸€ä¸ªå†…éƒ¨æ¥å£,ç”¨äºå­˜å‚¨å’Œæ£€ç´¢ç³»ç»Ÿç‰¹å®šåŠ©æ‰‹çš„è¯ä¹¦,ä»¥åŠæç¤ºç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚<code>git-credential</code> å‘½ä»¤å‘è„šæœ¬å¼€æ”¾äº†è¿™ä¸ªæ¥å£,è„šæœ¬å¯ä»¥åƒ Git ä¸€æ ·æ£€ç´¢ã€å­˜å‚¨æˆ–æç¤ºç”¨æˆ·è¾“å…¥å‡­è¯ã€‚è¿™ä¸ªå¯è„šæœ¬æ¥å£çš„è®¾è®¡ä¸å†…éƒ¨çš„ C API ä¸€æ ·,è¯·å‚è§ <code>credential.h</code> ä»¥äº†è§£æ›´å¤šçš„æ¦‚å¿µèƒŒæ™¯ã€‚</p><p>git-credentialåœ¨å‘½ä»¤è¡Œä¸Šä½¿ç”¨â€œæ“ä½œâ€é€‰é¡¹ï¼ˆ fill ï¼Œ approve æˆ– reject ä¹‹ä¸€ï¼‰ï¼Œå¹¶åœ¨stdinä¸Šè¯»å–å‡­æ®æè¿°ï¼ˆè¯·å‚é˜…<code>INPUT / OUTPUT FORMAT</code>ï¼‰ã€‚</p><p>å¦‚æœæ“ä½œä¸º fill ï¼Œåˆ™git-credentialå°†å°è¯•é€šè¿‡è¯»å–é…ç½®æ–‡ä»¶ï¼Œè”ç³»ä»»ä½•å·²é…ç½®çš„å‡­æ®å¸®åŠ©ç¨‹åºæˆ–æç¤ºç”¨æˆ·æ¥å‘æè¿°ä¸­æ·»åŠ â€œç”¨æˆ·åâ€å’Œâ€œå¯†ç â€å±æ€§ã€‚ç„¶åå°†å‡­è¯æè¿°çš„ç”¨æˆ·åå’Œå¯†ç å±æ€§ä¸å·²ç»æä¾›çš„å±æ€§ä¸€èµ·æ‰“å°åˆ°stdoutã€‚</p><p>å¦‚æœæ“ä½œè¢« <code>approve</code> ï¼Œåˆ™git-credentialä¼šå°†æè¿°å‘é€ç»™ä»»ä½•å·²é…ç½®çš„å‡­æ®å¸®åŠ©å™¨ï¼Œè¯¥å¸®åŠ©å™¨å¯ä»¥å­˜å‚¨è¯¥å‡­æ®ä»¥ä¾›ä»¥åä½¿ç”¨ã€‚</p><p>å¦‚æœè¯¥æ“ä½œè¢« <code>reject</code> ï¼Œåˆ™git-credentialä¼šå°†æè¿°å‘é€ç»™ä»»ä½•å·²é…ç½®çš„å‡­æ®å¸®åŠ©å™¨ï¼Œè¿™äº›å¸®åŠ©å™¨å¯èƒ½ä¼šåˆ é™¤æ‰€æœ‰ä¸è¯¥æè¿°åŒ¹é…çš„å­˜å‚¨å‡­æ®ã€‚</p><p>å¦‚æœæ“ä½œæ˜¯ <code>approve æˆ– reject</code> ï¼Œåˆ™ä¸åº”å‘å‡ºä»»ä½•è¾“å‡ºã€‚</p><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨<code>window</code>å’Œ<code>mac</code>ä¸‹ï¼Œåˆ†åˆ«å¯¹åº”çš„å¤šå‡­æ®ç®¡ç†å™¨ï¼Œåˆ†åˆ«æ˜¯<code>git credential for window</code> å’Œ <code>oschinakey</code>ï¼Œå¯ä»¥åšåˆ°ç²¾ç¡®çš„è®°å½•ä¸‹æˆ‘ä»¬çš„æ‰€æœ‰å‡­æ®ã€‚ä½†æ˜¯åœ¨linuxä¸‹å°±åªæœ‰<br><code>build-in(å†…ç½®)</code>çš„å­˜å–å™¨ï¼Œåˆ†åˆ«æ˜¯ <code>cache</code>, <code>store</code> ã€‚</p><p>ç»è¿‡å®ç°ï¼Œåœ¨<code>.gitconfig</code>é»˜è®¤çš„é…ç½®çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡éƒ½ä¼šåªè¯»å– <code>.git-credential</code> çš„ç¬¬ä¸€è¡Œæ•°æ®ï¼Œå¦‚æœä¸æ­£ç¡®ï¼Œåˆ™è§¦å‘ git çš„ <code>build-in</code> çš„ <code>reject</code> æ–¹æ³•ï¼Œæ¸…ç†æ‰è¿™ä¸€è¡Œçš„å‡­æ®ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨å¤šå‡­æ®ä¸‹æ— æ³•æ­£å¸¸çš„å·¥ä½œã€‚æˆ‘ä»¬éœ€è¦<code>.git-credentital</code>èƒ½æ ¹æ®<code>vcs</code>çš„åœ°å€ç‰¹ç‚¹ï¼Œä¾‹å¦‚æ ¹æ®<code>group</code>æ¥è¯†åˆ«å‡­æ®ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±éœ€è¦å€ŸåŠ©<code>è‡ªå®šä¹‰å­˜å–å™¨</code>ã€‚</p><h2 id="è‡ªå®šä¹‰å­˜å‚¨å™¨"><a href="#è‡ªå®šä¹‰å­˜å‚¨å™¨" class="headerlink" title="è‡ªå®šä¹‰å­˜å‚¨å™¨"></a>è‡ªå®šä¹‰å­˜å‚¨å™¨</h2><p>è¦å®ç°è‡ªå®šä¹‰å­˜å‚¨å™¨ï¼Œå°±éœ€è¦çŸ¥é“ä»–æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå’Œæ€ä¹ˆå®ç°ã€‚</p><p><code>è‡ªå®šä¹‰å­˜å‚¨å™¨</code>å…è®¸ä½ ç”¨<code>ä»»ä½•è¯­è¨€</code>æ¥ç¼–å†™ï¼Œä½ ç”¨<code>c/c++/python/php/java/go/rust/erlang</code>ç­‰ç­‰çš„è¯­è¨€å†™éƒ½æ˜¯å¯ä»¥çš„ï¼Œåªéœ€è¦ç¨‹åºèƒ½ç›´æ¥è¿è¡Œï¼Œå¹¶ä¸”ç¬¦åˆ<code>è¾“å…¥/è¾“å‡ºæ ¼å¼</code>å’Œåœ¨<code>PATH</code>çš„ç³»ç»Ÿç¯å¢ƒä¸‹èƒ½æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯å¯è¡Œçš„ã€‚æˆ‘è®°å¾—<code>git-scm</code>çš„ä¾‹å­é‡‡ç”¨çš„æ˜¯rubyçš„å†™æ³•ï¼Œä½†æ˜¯ç”±äºè€ƒè™‘åˆ°<code>python2</code>ä¸€èˆ¬æ˜¯æ¯ä¸ªç³»ç»Ÿéƒ½è‡ªå¸¦çš„ï¼Œæˆ‘ä»¬ä¹Ÿé‡‡ç”¨äº†<code>python2</code>çš„å†™æ³•æ¥å®ç°ä¸€ä¸ª<code>æ ¹æ®ç»„ç»‡æ¥æ™ºèƒ½åŒºåˆ†gitè´¦å·å’Œå¯†ç çš„è‡ªå®šä¹‰å­˜å–å™¨</code></p><p>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥è®°ä½ï¼ŒæŠŠè‡ªå®šä¹‰å­˜å‚¨å™¨æƒ³åƒæˆä¸€ä¸ª<code>ç®¡é“(pipe)</code>çš„æ¦‚å¿µï¼Œæœ‰<code>è¾“å…¥ç«¯</code>ï¼Œä¹Ÿæœ‰<code>è¾“å‡ºç«¯</code>ï¼Œä»–ä»¬éƒ½æœ‰è‡ªå·±å¯¹åº”çš„è§„åˆ™ï¼ˆåè®®/æ ¼å¼ï¼‰ã€‚</p><h3 id="è¾“å…¥-è¾“å‡ºæ ¼å¼"><a href="#è¾“å…¥-è¾“å‡ºæ ¼å¼" class="headerlink" title="è¾“å…¥/è¾“å‡ºæ ¼å¼"></a>è¾“å…¥/è¾“å‡ºæ ¼å¼</h3><p>git credential åœ¨å…¶<code>æ ‡å‡†è¾“å…¥/è¾“å‡º</code>ä¸­è¯»å–æˆ–å†™å…¥ï¼ˆå–å†³äºä½¿ç”¨çš„æ“ä½œï¼‰<code>å‡­è¯ä¿¡æ¯</code>ã€‚æ­¤ä¿¡æ¯å¯ä»¥å¯¹åº”äº <code>git credential</code> å°†ä¸ºå…¶è·å–ç™»å½•ä¿¡æ¯çš„å¯†é’¥ï¼ˆä¾‹å¦‚ä¸»æœºï¼Œåè®®ï¼Œè·¯å¾„ï¼‰ï¼Œä¹Ÿå¯ä»¥<code>å¯¹åº”</code>äºå°†è¦è·å–çš„å®é™…å‡­è¯æ•°æ®ï¼ˆç”¨æˆ·å/å¯†ç ï¼‰ã€‚</p><p>å‡­è¯åˆ†ä¸ºä¸€ç»„å‘½åå±æ€§ï¼Œ<code>æ¯è¡Œä¸€ä¸ªå±æ€§</code>ã€‚æ¯ä¸ªå±æ€§å‡ç”±é”®å€¼å¯¹æŒ‡å®šï¼Œå¹¶ä»¥ <code>= ï¼ˆç­‰å·ï¼‰åˆ†éš”</code>ï¼Œåè·Ÿ<code>æ¢è¡Œç¬¦</code>ã€‚</p><p>å¯†é’¥å¯ä»¥åŒ…å«é™¤ = ï¼Œæ¢è¡Œç¬¦æˆ–NULä¹‹å¤–çš„ä»»ä½•å­—èŠ‚ã€‚è¯¥å€¼å¯ä»¥åŒ…å«é™¤æ¢è¡Œç¬¦æˆ–NULä¹‹å¤–çš„ä»»ä½•å­—èŠ‚ã€‚</p><p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹,æ‰€æœ‰çš„å­—èŠ‚éƒ½æŒ‰åŸæ ·å¤„ç†(å³æ²¡æœ‰å¼•å·,ä¹Ÿä¸èƒ½ä¼ è¾“å¸¦æœ‰æ¢è¡Œæˆ–NULçš„å€¼)ã€‚å±æ€§åˆ—è¡¨ä»¥ç©ºè¡Œæˆ–æ–‡ä»¶æœ«å°¾ç»“æŸã€‚</p><p>Gitäº†è§£ä»¥ä¸‹å±æ€§ã€‚</p><ul><li><p>protocol å°†ä½¿ç”¨å‡­è¯çš„åè®®ï¼ˆä¾‹å¦‚ https ï¼‰ã€‚</p></li><li><p>host ç½‘ç»œå‡­è¯çš„è¿œç¨‹ä¸»æœºå,åŒ…æ‹¬æŒ‡å®šçš„ç«¯å£å·(å¦‚ â€œexample.com:8088â€)ã€‚å¦‚æœæŒ‡å®šäº†ç«¯å£å·,åˆ™åŒ…æ‹¬ç«¯å£å·(ä¾‹å¦‚ â€œexample.com:8088â€)ã€‚</p></li><li><p>path å‡­æ®å°†ä½¿ç”¨çš„è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œå¯¹äºè®¿é—®è¿œç¨‹httpsèµ„æºåº“ï¼Œè¿™å°†æ˜¯æœåŠ¡å™¨ä¸Šèµ„æºåº“çš„è·¯å¾„ã€‚(åªæœ‰å¼€å¯äº†<code>useHttpPath=true</code>çš„æƒ…å†µä¸‹ï¼Œè¾“å…¥æ ¼å¼æ‰ä¼šæºå¸¦è¿™ä¸ªå‚æ•°)</p></li><li><p>username å‡­æ®çš„ç”¨æˆ·åï¼ˆå¦‚æœå·²ç»æœ‰ï¼‰ï¼ˆä¾‹å¦‚ï¼Œæ¥è‡ªURLï¼Œé…ç½®ï¼Œç”¨æˆ·æˆ–å…ˆå‰è¿è¡Œçš„å¸®åŠ©ç¨‹åºï¼‰ã€‚</p></li><li><p>password å‡­æ®çš„å¯†ç ï¼ˆå¦‚æœæˆ‘ä»¬è¦æ±‚å°†å…¶å­˜å‚¨ï¼‰ã€‚</p></li><li><p>url å½“ git credential è¯»å–æ­¤ç‰¹æ®Šå±æ€§æ—¶ï¼Œè¯¥å€¼å°†è§£æä¸ºURLï¼Œå¹¶è¢«è§†ä¸ºå·²è¯»å–å…¶ç»„æˆéƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œ url=<a href="https://example.com" target="_blank" rel="noopener">https://example.com</a> çš„è¡Œä¸ºå°±å¥½åƒ protocol=https å’Œ host=example.com å·²æä¾›ï¼‰ã€‚è¿™å¯ä»¥å¸®åŠ©å‘¼å«è€…é¿å…è‡ªå·±è§£æURLã€‚</p></li></ul><blockquote><p>è¯·æ³¨æ„ï¼ŒæŒ‡å®šåè®®æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå¹¶ä¸”å¦‚æœURLæœªæŒ‡å®šä¸»æœºåï¼ˆä¾‹å¦‚ï¼Œâ€œ certï¼š/// path / to / fileâ€ï¼‰ï¼Œåˆ™å‡­è¯å°†åŒ…å«å…¶ä¸»æœºåå±æ€§ï¼Œå…¶å€¼ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</p></blockquote><h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>äº†è§£äº†<code>è¾“å…¥/è¾“å‡ºæ ¼å¼</code>åã€‚æˆ‘ä»¬é€šè¿‡å®æˆ˜ä¾‹å­æ¥è¯´æ˜ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> git-credential.example</span></span><br><span class="line">https://caiwenhui:testpass@gitlab.mingchao.com/group1</span><br><span class="line">https://caiwenhui:testpass2@gitlab.mingchao.com/group2</span><br><span class="line">https://caiwenhui:testpass3@gitlab.mingchao.com/group3</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ–‡ä»¶ï¼Œå‘½åä¸º <code>git-credential-mc</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Date    : 2021-07-30 10:58:53</span></span><br><span class="line"><span class="comment"># @Author  : caiwenhui</span></span><br><span class="line"><span class="comment"># @Version : 1.0</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">"get credentials by https://gitlab.mimgchao.com/&#123;group&#125;"</span>,</span><br><span class="line">                                 prog=<span class="string">'git-credential-mc'</span>,</span><br><span class="line">                                 usage=<span class="string">'%(prog)s [options] &lt;action&gt;'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-f'</span>, <span class="string">'--file'</span>, help=<span class="string">'Specify path for backing store'</span>, required=<span class="literal">True</span>, default=<span class="string">"~/.git-credentials"</span>,</span><br><span class="line">                    type=str)</span><br><span class="line">parser.add_argument(<span class="string">'action'</span>, metavar=<span class="string">"action"</span>, help=<span class="string">'just support &lt;get&gt;'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CredentialsHelper</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, credential_file=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.inputs = dict()</span><br><span class="line">        self.file = credential_file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_input</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            line = sys.stdin.readline()</span><br><span class="line">            <span class="keyword">if</span> line.strip() == <span class="string">''</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            k, v = line.strip().split(<span class="string">'='</span>, <span class="number">2</span>)</span><br><span class="line">            self.inputs[k] = v</span><br><span class="line"></span><br><span class="line">        <span class="comment"># éœ€è¦å¼€å¯useHttpPath = true</span></span><br><span class="line">        <span class="keyword">if</span> self.inputs[<span class="string">'path'</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è§£æpathå‚æ•°</span></span><br><span class="line">        self.inputs[<span class="string">'group'</span>] = self.inputs[<span class="string">'path'</span>].split(<span class="string">'/'</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_output</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(self.file, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            lines = f.readlines()</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                m = re.match(<span class="string">r'^(?P&lt;protocol&gt;.*?)://(?P&lt;username&gt;.*?):(?P&lt;password&gt;.*?)@(?P&lt;host&gt;.*)/(?P&lt;group&gt;.*)$'</span>,</span><br><span class="line">                             line)</span><br><span class="line">                gd = m.groupdict()</span><br><span class="line">                <span class="keyword">if</span> self.inputs[<span class="string">'protocol'</span>] == gd[<span class="string">'protocol'</span>] <span class="keyword">and</span> self.inputs[<span class="string">'host'</span>] == gd[<span class="string">'host'</span>] <span class="keyword">and</span> self.inputs[</span><br><span class="line">                    <span class="string">'group'</span>] == gd[<span class="string">'group'</span>]:</span><br><span class="line">                    sys.stdout.write(<span class="string">'protocol=&#123;protocol&#125;\n'</span>.format(protocol=gd[<span class="string">'protocol'</span>]))</span><br><span class="line">                    sys.stdout.write(<span class="string">'host=&#123;host&#125;\n'</span>.format(host=gd[<span class="string">'host'</span>]))</span><br><span class="line">                    sys.stdout.write(<span class="string">'username=&#123;username&#125;\n'</span>.format(username=gd[<span class="string">'username'</span>]))</span><br><span class="line">                    sys.stdout.write(<span class="string">'password=&#123;password&#125;\n'</span>.format(password=gd[<span class="string">'password'</span>]))</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._input()</span><br><span class="line">        self._output()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt;= <span class="number">1</span>:</span><br><span class="line">        parser.print_help()</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> args.action != <span class="string">"get"</span>:</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(args.file):</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    credentialsHelper = CredentialsHelper(credential_file=args.file)</span><br><span class="line">    credentialsHelper.execute()</span><br></pre></td></tr></table></figure><p>ç›´æ¥è¿è¡Œä¸‹ï¼Œè„šæœ¬è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">âœ  python git:(master) ./git-credential-mc</span><br><span class="line">usage: git-credential-mc [options] &lt;action&gt;</span><br><span class="line"></span><br><span class="line">get credentials by https://gitlab.mimgchao.com/&#123;group&#125;</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  action                just support &lt;get&gt;</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -f FILE, --file FILE  Specify path for backing store</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥æ¨¡æ‹Ÿgitçš„ä¸€ä¸ªè¾“å…¥è¿‡ç¨‹ï¼Œç„¶åè®©è‡ªå®šä¹‰å­˜å‚¨å™¨è¾“å‡ºæ­£ç¡®çš„è¾“å‡ºæ ¼å¼å‘Šè¯‰gitå‡­æ®è¦ç”¨çš„è´¦å·å¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">âœ  python git-credential-mc -f git-credential.example  get</span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">path=group1/repo1.git</span><br><span class="line"></span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">username=caiwenhui</span><br><span class="line">password=testpass</span><br><span class="line"></span><br><span class="line">âœ  python git-credential-mc -f git-credential.example  get</span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">path=group2/repo1.git</span><br><span class="line"></span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">username=caiwenhui</span><br><span class="line">password=testpass2</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬æ ¹æ®ä¸åŒçš„<code>group</code>ï¼Œå·²ç»è¿”å›äº†ä¸åŒçš„è´¦å·å¯†ç äº†ã€‚è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼Œæˆ‘ä»¬çš„è‡ªå®šä¹‰è¯»å–å™¨å°±ç®—æ˜¯å®Œæˆäº†ã€‚ä½†æ˜¯ç³»ç»ŸåŒ–çš„æ•´ç†èµ·æ¥ï¼Œè¿˜éœ€è¦æŠŠè¿™ä¸ªè„šæœ¬ï¼Œæ”¾åœ¨<code>PATH</code>è·¯å¾„ä¸‹ï¼Œå¹¶ä¸”ï¼Œå¹¶ä¸”è®°å¾—å¿…é¡»ä»¥<code>git-credential-*</code>æ¥å‘½ä»¤ç¨‹åºçš„æ–‡ä»¶åã€‚å› ä¸ºgitæºç çš„credentialæ¨¡å—ä¸­çš„æºç è¯»å–è‡ªå®šä¹‰è§„åˆ™å­˜å‚¨å™¨å°±æ˜¯è¿™æ ·å­è°ƒç”¨å¤–éƒ¨ç¨‹åºçš„ã€‚</p><h3 id="é…ç½®git"><a href="#é…ç½®git" class="headerlink" title="é…ç½®git"></a>é…ç½®git</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.https:&#x2F;&#x2F;gitlab.mingchao.com.useHttpPath true</span><br><span class="line">git config --global credential.https:&#x2F;&#x2F;gitlab.mingchao.com.helper &quot;mc --file ~&#x2F;.git-credential.example&quot;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å­ï¼Œgitå°±å¯ä»¥é’ˆå¯¹<code>https://gitlab.mingchao.com</code>çš„æ—¶å€™ï¼Œé‡‡ç”¨<code>git-credential-mc</code>çš„ç¨‹åºæ¥è¯»å–å‡­æ®ã€‚è¾¾åˆ°æˆ‘ä»¬çš„<code>å¤šç»„/å¤šå‡­æ®</code>çš„æƒ…å†µä¸‹<code>æ­£ç¡®</code>çš„<code>è¯»å–è´¦å·å’Œå¯†ç </code>ã€‚</p><p>è¿™é‡Œåªæ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æ³•ï¼Œåç»­å¦‚æœæœ‰å¤æ‚çš„ç”¨æ³•ï¼Œéƒ½å¯ä»¥æ‰©å±•è¿™ä¸ªè‡ªå®šä¹‰å­˜å–å™¨ï¼Œååˆ†çš„çµæ´»ã€‚</p><h2 id="å‚è€ƒèµ„æ–™ï¼š"><a href="#å‚è€ƒèµ„æ–™ï¼š" class="headerlink" title="å‚è€ƒèµ„æ–™ï¼š"></a>å‚è€ƒèµ„æ–™ï¼š</h2><ul><li><a href="https://github.com/git/git" target="_blank" rel="noopener">https://github.com/git/git</a></li><li><a href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8</a></li><li><a href="https://revs.runtime-revolution.com/extending-git-with-ruby-874fddffd069" target="_blank" rel="noopener">https://revs.runtime-revolution.com/extending-git-with-ruby-874fddffd069</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;æœ€è¿‘ï¼Œåœ¨å¤„ç†å…¬å¸åˆ°ä»£ç ä»“åº“ï¼Œå…¬å¸ç”±&lt;code&gt;gitbucket&lt;/code&gt;è¿ç§»åˆ°&lt;code&gt;gitlab&lt;/code&gt;åï¼Œä¸šåŠ¡é¡¹ç›®æ‹‰å–ç§æœ‰&lt;code&gt;vcs&lt;/code&gt;çš„ä»£ç ä¾èµ–åŒ…çš„æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥å‰å¯èƒ½æ˜¯ä¸€ä¸ªâ€œæƒé™è¾ƒå¤§â€çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰å¤šä¸ªé¡¹ç›®ç»„çš„è®¿é—®æƒé™ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—®ç§æœ‰çš„&lt;code&gt;vcs&lt;/code&gt;çš„ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;ä½†æ˜¯è¿ç§»åˆ°gitlabä¹‹åï¼Œæ¯ä¸ªgroupä¸‹ï¼Œowneréƒ½å¯ä»¥é’ˆå¯¹è¿™ä¸ªgroupç”Ÿæˆå¯¹åº”éƒ½&lt;code&gt;deploy-key&lt;/code&gt;ï¼Œæ‰€ä»¥å˜æˆäº†ä¸€ä¸ªgroupä¸‹ä¸€ä¸ªdeploy-keyã€‚&lt;/p&gt;
&lt;p&gt;è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬éƒ½&lt;code&gt;go/php/node&lt;/code&gt;é¡¹ç›®ï¼Œåœ¨æ‹‰å–ä¸åŒé¡¹ç›®éƒ½ä¾èµ–åŒ…éƒ½æ—¶å€™ï¼Œéœ€è¦æŠŠ&lt;code&gt;git-credential&lt;/code&gt;çš„è´¦å·ä¿¡æ¯åˆ‡æ¢ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/categories/DevOps/"/>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/tags/DevOps/"/>
    
  </entry>
  
</feed>
