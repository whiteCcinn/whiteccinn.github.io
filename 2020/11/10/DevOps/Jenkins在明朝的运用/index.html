<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【DevOps】Jenkins的share-libraries明朝的运用 | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="【DevOps】Jenkins的share-libraries明朝的运用"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>【DevOps】Jenkins的share-libraries明朝的运用</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/11/10/DevOps/Jenkins在明朝的运用/" rel="bookmark">
        <time class="entry-date published" datetime="2020-11-10T08:44:30.000Z">
          2020-11-10
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次我们不从Jenkins的部署架构和具体配置说明，我们主要围绕 <code>jenkinsfile</code> 的内部来讲解。</p>
<a id="more"></a>

<h2 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h2><p>目前我们的 jenkins 服务用过<code>普通的pipeline</code>和 <code>多分支的pipeline</code>，其主要区别就是<code>多分支pipeline</code>更加灵活一些，能够让我们少做一些逻辑处理。<br>但是这引入了一个问题，那就是我们的<code>jenkins</code>，必须存在与对应的分支中，也因此，pipeline 的流程变成了代码管理，并且由于我们存在多个项目，那么将会有<code>项目数 * 2(master/pre-develop)</code> 那么多的 jenkins 需要管理，于是就导致了我们有很多这种冗余的写法，这还不是最糟糕的，最糟糕的是如果我们需要修改一些通用的内容的时候，就需要一个个去修改，这绝对是灾难级别的需求。</p>
<p>Jenkinsfile的实现分为<code>2</code>种，分别是<code>声明式pipeline</code>和<code>脚本式pipeline</code>，这2种各有优缺点</p>
<p>jenkins需要做的事情，可以概括为如下几种：</p>
<ol>
<li>拉取代码</li>
<li>版本管理</li>
<li>单元测试</li>
<li>构建部署</li>
<li>通知结果</li>
</ol>
<h3 id="声明式pipeline"><a href="#声明式pipeline" class="headerlink" title="声明式pipeline"></a>声明式pipeline</h3><p>可以为我们提供<code>关键字</code> 和 <code>顺序结构</code>来辅助我们完成如上的5个阶段。</p>
<p>但是他的缺点也是明显的，就是<code>不能很灵活</code>根据自己的想法去做处理逻辑。</p>
<p>还有一种情况是比较蛋疼的，例如项目A和项目B，独立维护一个jenkinsfile，但是其实项目A和项目B的jenkinsfile其实是一致的，如果某一条要优化这个jenkinsfile的部署逻辑了。那么项目B和项目A都需要一起处理，无法实现<code>复用</code>的概念，并没有提供<code>抽象</code>的概念，不利于维护。</p>
<p>对于一些<code>相对简单，没有太复杂流程</code>的构建过程来说，声明式一定是大家的首要选择。</p>
<h3 id="脚本式pipeline"><a href="#脚本式pipeline" class="headerlink" title="脚本式pipeline"></a>脚本式pipeline</h3><p>可以给我们提供类似于写代码脚本的方式来组织部署逻辑，我把<code>脚本式pipeline</code>定义为<code>升级版的声明式pipeline</code>。</p>
<p>虽然脚本式的pipeline可以给我们提供灵活的部署逻辑，但是依旧无法解决我们的<code>复用</code>的问题。</p>
<p>我们需要把这种能<code>复用</code>的东西放在同一个地方进行统一管理，类似于<code>依赖库</code>的概念，独立与jenkinsfile之外的一种存在。于是乎，这便有了<code>jenkins-shard-libaray</code>。</p>
<h2 id="Jenkins-shard-libaray"><a href="#Jenkins-shard-libaray" class="headerlink" title="Jenkins-shard-libaray"></a>Jenkins-shard-libaray</h2><p>这是一个jenkins中的共享类库，只需要在jenkinsfile中对其引入，就可以引用共享库的代码，从而实现我们的<code>复用</code>。</p>
<p>但是有一点是这个共享库，需要我们储备点<code>groovy</code>语言的知识，因为他是用groovy作为”外挂”的方式加载运行的。</p>
<p>我们在写共享库的时候，<code>必须</code> 依照要有2个基本目录，否则jenkins无法类库。</p>
<ul>
<li>src (必要，核心代码)</li>
<li>vars (非必要，声明自己的语法)</li>
<li>resources (非必要，配置存放的目录)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├── Jenkinsfile.example                                   jenkinsfile的DEMO样式</span><br><span class="line">├── README.MD</span><br><span class="line">├── jars</span><br><span class="line">│   ├── groovy-cps-1.1.jar</span><br><span class="line">│   └── pipeline-model-definition-1.7.1.jar</span><br><span class="line">├── resources                                              配置文件和基础库分开管理了，所以这里不会存在静态资源文件</span><br><span class="line">├── src</span><br><span class="line">│   └── com</span><br><span class="line">│       └── company</span><br><span class="line">│           └── jenkins</span><br><span class="line">│               ├── BasePipeline.groovy                    基础管道</span><br><span class="line">│               ├── CommonPipeline.groovy                  公共管道</span><br><span class="line">│               ├── Constant.groovy                        常量类</span><br><span class="line">│               ├── Deploy.groovy                          部署基类</span><br><span class="line">│               ├── Git.groovy                             git相关的操作类</span><br><span class="line">│               ├── GolangPipeline.groovy                  golang项目管道</span><br><span class="line">│               ├── LaravelPipeline.groovy                 laravel项目管道</span><br><span class="line">│               ├── MPipeline.groovy                       初始化类</span><br><span class="line">│               ├── MetlNotify.groovy                      用于发送通知的类</span><br><span class="line">│               ├── Repo.groovy                            用于实例化代码仓库信息</span><br><span class="line">│               ├── SummaryNotify.groovy                   用于结构化通知内容的类</span><br><span class="line">│               └── deployments                            具体的部署类</span><br><span class="line">│                   ├── AbstractDeployment.groovy          抽象部署类</span><br><span class="line">│                   ├── BaseDeployment.groovy              基础部署类</span><br><span class="line">│                   ├── DefaultDeployment.groovy           默认部署类</span><br><span class="line">│                   └── GolangDeployment.groovy            Go部署类</span><br><span class="line">├── tests                                                  单元测试目录</span><br><span class="line">│   ├── RepoTest.groovy</span><br><span class="line">│   └── classfiles</span><br><span class="line">│       └── com</span><br><span class="line">│           └── company</span><br><span class="line">│               └── jenkins</span><br><span class="line">│                   ├── Constant.class</span><br><span class="line">│                   ├── Git.class</span><br><span class="line">│                   ├── MPipeline.class</span><br><span class="line">│                   ├── MetlNotify.class</span><br><span class="line">│                   ├── Repo.class</span><br><span class="line">│                   └── SummaryNotify.class</span><br><span class="line">└── vars                                                   全局函数定义目录</span><br><span class="line">    ├── mpipeline.groovy                                   自定义入口语法糖</span><br><span class="line">    └── notify.groovy                                      定义通知全局调用函数</span><br></pre></td></tr></table></figure>

<h3 id="Jenkinsfile-1"><a href="#Jenkinsfile-1" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mpipeline&#123;</span><br><span class="line">    script&#x3D;this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import com.company.jenkins.LaravelPipeline</span><br><span class="line">def laravelPipeline &#x3D; new LaravelPipeline(this)</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    laravelPipeline.preBuild().build().debug().reviews().production().execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个最基本的jenkinsfile的demo。我们把他分为2个部分。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 第一部分</span><br><span class="line">mpipeline&#123;</span><br><span class="line">    script&#x3D;this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 第二部分</span><br><span class="line">import com.company.jenkins.LaravelPipeline</span><br><span class="line">def laravelPipeline &#x3D; new LaravelPipeline(this)</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    laravelPipeline.preBuild().build().debug().reviews().production().execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这2个部分各司其职。</p>
<p>第一部分 <code>mpipeline</code> 的语法糖，来自于我们<code>vars/mpipeline.groovy</code>文件，这是我们自定义的语法糖。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import com.company.jenkins.*</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * @param body</span><br><span class="line"> *      repo 代码仓库地址 default: null</span><br><span class="line"> *      autoCheckout 是否需要自动checkout代码，default: true</span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">def call(body) &#123;</span><br><span class="line">    def config &#x3D; [:]</span><br><span class="line">    body.resolveStrategy &#x3D; Closure.DELEGATE_FIRST</span><br><span class="line">    body.delegate &#x3D; config</span><br><span class="line">    body()</span><br><span class="line"></span><br><span class="line">    config.repo &#x3D; config.repo ?: null</span><br><span class="line">    config.script &#x3D; config.script ?: null</span><br><span class="line">    config.autoCheckout &#x3D; config.autoCheckout ?: true</span><br><span class="line"></span><br><span class="line">    if (config.script &#x3D;&#x3D; null) &#123;</span><br><span class="line">        throw new Exception(&quot;&lt;script&#x3D;this&gt;是必填参数&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (config.repo &#x3D;&#x3D; null) &#123;</span><br><span class="line">        config.repo &#x3D;  config.script.scm.getUserRemoteConfigs()[0].getUrl()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line">        def mpipe &#x3D; new MPipeline(config.script, config.repo)</span><br><span class="line">        mpipe.initializeResources()</span><br><span class="line">        def credentialsId &#x3D; config.credentialsId ?: config.script.gitCredentialsId</span><br><span class="line"></span><br><span class="line">        if (config.autoCheckout) &#123;</span><br><span class="line">            stage(&quot;Checkout&quot;) &#123;</span><br><span class="line">                &#x2F;&#x2F; git clone repo</span><br><span class="line">                git credentialsId: credentialsId, url: mpipe.repo.getGitLink(), branch: env.BRANCH_NAME</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mpipe.initializeEnvironment()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个语法糖做的内容定义了 <code>mpipeline</code> 做的内容，其中有三个有效参数 <code>repo</code>, <code>script</code>, <code>autoCheckout</code>，分别的意思是代表<code>该任务下的操作仓库地址</code>，<code>当前任务上下文</code>, <code>是否自动拉取代码</code>。其中 <code>script</code>参数为必填参数，其他2个都是选填参数，其都存在默认值。这个<code>script</code>必填的原因是因为一定要从jenkinsfile把对象传递进来，否则作用域有所不同。因为我们在第二部分要把这个对象继续传递下去，因为他携带了贯穿整个任务的上下文。</p>
<p>我们这里看到了 <code>node</code> 结构块，这是因为在<code>脚本式pipeline</code>中，他其实也是jenkins内置的一个自定义语法糖，所以他可以直接被嵌入在我们的代码中。因为我们这里实例化了共享库中的<code>Mpipeline类</code>，所以需要在 <code>node</code> 结构块中编写代码。</p>
<p>在这一块，我们可以看到，我们做了3件事</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------------------+                +--------------------------------+              +----------------------------------------------------+</span><br><span class="line">|                                      |                |                                |              |                                                    |</span><br><span class="line">|  1. Initialize the custom resource   +---------------&gt;+   2. Pull the warehouse code   +-------------&gt;+   3. Initialize the custom environment variable    |</span><br><span class="line">|                                      |                |                                |              |                                                    |</span><br><span class="line">+--------------------------------------+                +--------------------------------+              +----------------------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><p>初始化自定义资源（接下来要说的resource-libaray共享库）</p>
</li>
<li><p>拉取仓库代码（这是jenkins自带的一个git插件，调用git函数，加上一些参数，就会拉取代码到一个目录，如果目录不存在，则会创建）</p>
</li>
<li><p>初始化自定义环境变量</p>
</li>
</ul>
<p>初始化自定义资源的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化资源库</span><br><span class="line"> *&#x2F;</span><br><span class="line">def initializeResources() &#123;</span><br><span class="line">    this.script.mresource_load([</span><br><span class="line">            script: this.script,</span><br><span class="line">            groupRepo: this.getRepoGroupRepo(),</span><br><span class="line">            shortJobName: this.getShortName(),</span><br><span class="line">            host: this.getHost()</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们可以看到我们通过上下文变量，调用了 <code>mresource_load</code> 函数，这个是我们在 <code>resource-libaray共享库</code> 定义的函数，用于加载对应仓库的具体资源配置用，相关参数依旧会加载到上下文之中。</p>
<p>自定义环境变量部分代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化环境变量</span><br><span class="line"> *&#x2F;</span><br><span class="line">def initializeEnvironment() &#123;</span><br><span class="line">    this.initBaseEnv().initEnvDependGit().initEnvDependRepo()</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def initBaseEnv() &#123;</span><br><span class="line">    &#x2F;&#x2F; SHORT_JOB_NAME</span><br><span class="line">    this.script.env.SHORT_JOB_NAME &#x3D; this.getShortName()</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否仅仅显示stage节点而不执行内容</span><br><span class="line">    this.script.mStageShow &#x3D; false</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def initEnvDependGit() &#123;</span><br><span class="line">    &#x2F;&#x2F; COMMIT_ID</span><br><span class="line">    this.script.env.COMMIT_ID &#x3D; this.git.commitId()</span><br><span class="line">    &#x2F;&#x2F; COMMIT_AUTHOR</span><br><span class="line">    this.script.env.COMMIT_AUTHOR &#x3D; this.git.commitAuthor()</span><br><span class="line">    &#x2F;&#x2F; COMMIT_TIME</span><br><span class="line">    this.script.env.COMMIT_TIME &#x3D; this.git.commitTime()</span><br><span class="line">    &#x2F;&#x2F; COMMIT_COMMENT</span><br><span class="line">    this.script.env.COMMIT_COMMENT &#x3D; this.git.commitMessage()</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def initEnvDependRepo() &#123;</span><br><span class="line">    &#x2F;&#x2F; REPO</span><br><span class="line">    this.script.env.REPO &#x3D; this.repo.getRepo()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY</span><br><span class="line">    this.script.env.REPOSITORY &#x3D; this.repo.getFullRepoString()</span><br><span class="line">    &#x2F;&#x2F; Notify</span><br><span class="line">    this.script.env.COMMIT_ID_PATH &#x3D; this.repo.getCommitIdHostPath()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY_LINK</span><br><span class="line">    this.script.env.REPOSITORY_LINK &#x3D; this.repo.getGitLink()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY_GROUP</span><br><span class="line">    this.script.env.REPOSITORY_GROUP &#x3D; this.repo.getGroup()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY_GROUP_REPO</span><br><span class="line">    this.script.env.REPOSITORY_GROUP_REPO &#x3D; this.getRepoGroupRepo()</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个，我们把环境变量也拆分封装到对应的方法了，分别是git相关的环境变量和仓库信息的环境变量等等。</p>
<p>接下来，我们看下 <code>第二部分</code> 的代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 第二部分</span><br><span class="line">import com.company.jenkins.LaravelPipeline</span><br><span class="line">def laravelPipeline &#x3D; new LaravelPipeline(this)</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    laravelPipeline.preBuild().build().testing().debug().reviews().production().execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们import进来了Laravel的具体实现管道，并且实例化这个对象，传入了当前上下文对象。</p>
<p>并且在下面的node结构中，调用laravelpipeline对象的相关封装方法。</p>
<p>经过我们对部署流程的抽象和统一，我们的部署流程大致分为 <code>5个阶段</code>。分别如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------+</span><br><span class="line">|  1. Pre-construction phase  |</span><br><span class="line">+------------+----------------+</span><br><span class="line">             |</span><br><span class="line">             |             +-----------------------+</span><br><span class="line">             +------------&gt;+2. Construction phase  +------------------+</span><br><span class="line">                           +-----------------------+                  |</span><br><span class="line">                                                                      |</span><br><span class="line">                                                                      |</span><br><span class="line">                                                +---------------------v-----------------------------+</span><br><span class="line">                                        +-------+3. Deployment development environment phase (Debug)|</span><br><span class="line">                                        |       +---------------------------------------------------+</span><br><span class="line">                                        |</span><br><span class="line">                                        v</span><br><span class="line">                           +------------+---------------------------------------+</span><br><span class="line">             +-------------+4. Grayscale Environment Deployment Stage（ reviews） |</span><br><span class="line">             |             +----------------------------------------------------+</span><br><span class="line">             |</span><br><span class="line">+------------v----------------------------------------------+</span><br><span class="line">| 5. Deployment of production environment phase（ prodution） |</span><br><span class="line">+-----------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>预构建阶段</li>
<li>构建阶段</li>
<li>部署开发环境阶段（debug）</li>
<li>部署灰度环境阶段（reviews）</li>
<li>部署生产环境阶段（production）</li>
</ul>
<p>因此，我们把所有的仓库jenkinsfile都按照这样子的不是来写，这样子就可以做到，当我们需要修改部署的内容的时候，代码仓库的jenkinsfile不需要做任务变动，只需要修改我们的共享库即可。</p>
<p>部分代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">def preBuild() &#123;</span><br><span class="line">    def callback &#x3D; &#123;</span><br><span class="line">        this.startNotify()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def apiName &#x3D; &#39;preBuild&#39;</span><br><span class="line">    this.addCallback(apiName, callback)</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def build(isParallel &#x3D; true) &#123;</span><br><span class="line">    def callback &#x3D; &#123;</span><br><span class="line">        this.script.stage(&#39;Build&#39;) &#123;</span><br><span class="line">            if (isParallel) &#123;</span><br><span class="line">                def stages &#x3D; [failFast: true]</span><br><span class="line"></span><br><span class="line">                stages[&quot;Composer Install&quot;] &#x3D; this.composerInstall()</span><br><span class="line">                stages[&quot;Client Build&quot;] &#x3D; this.clientBuild()</span><br><span class="line">                this.script.parallel stages</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.composerInstall()()</span><br><span class="line">                this.clientBuild()()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def apiName &#x3D; &#39;build&#39;</span><br><span class="line">    this.addCallback(apiName, callback)</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里看到，我们几乎所有的代码都会通过回调函数来编写的，所以，我们在实际调用的时候，必须加上 <code>execute()</code> 方法来实际触发链式过程。</p>
<p>因为在我们这个例子中，laravel是php的项目，默认情况下，我们是有前端和后端的代码。分别是<code>composer依赖</code>，<code>npm依赖</code>。</p>
<p>由于这2个部分的依赖，他们是没有相关性的，所以，我们在设计上，默认是支持 <code>并发</code> 执行的，所以我们这里调用了jenkins的一个内置函数 <code>parallel</code>来实现并发。实际效果如下展示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                          +-----------------------+</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          | | Composer Install |  |</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          |                       |</span><br><span class="line">                          |                       |</span><br><span class="line">+----------------+        |                       |</span><br><span class="line">|   pre-build    +-------&gt;+        build          |</span><br><span class="line">+----------------+        |                       |</span><br><span class="line">                          |                       |</span><br><span class="line">                          |                       |</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          | | Client Build     |  |</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          |                       |</span><br><span class="line">                          +-----------------------+</span><br></pre></td></tr></table></figure>

<p>以npm依赖安装为例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public npmInstall(def packageFile &#x3D; &#39;client&#x2F;package.json&#39;, def clientDir &#x3D; &#39;client&#39;, def version &#x3D; &#39;latest&#39;) &#123;</span><br><span class="line">    def md5File &#x3D; &quot;$&#123;packageFile&#125;.md5&quot;</span><br><span class="line">    def callback &#x3D; &#123; isChange -&gt;</span><br><span class="line">        this.script.echo &quot;package.json是否有变化:$&#123;isChange&#125;&quot;</span><br><span class="line">        this.script.echo &quot;是否强制编译前端资源:$&#123;this.script.params.isBuild&#125;&quot;</span><br><span class="line">        if (isChange || this.script.params.isBuild) &#123;</span><br><span class="line">            this.script.docker.image(&quot;jenkins_docker_node:$&#123;version&#125;&quot;).inside(&#39;--dns-opt&#x3D;ndots:5 -v $HOME&#x2F;.npm:&#x2F;root&#x2F;.npm&#39;) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.checkChangeFile(packageFile, md5File, callback)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外在composer和npm依赖安装的过程中，我们做了一些细节上的优化，例如，我们会检测<code>package.json</code>以及<code>composer.json</code>，如果这2个文件没有变化的话，则不会更新依赖。避免了每次构建都需要去检查更新依赖包。<br>另外由于我们的jenkisn环境本身也是一个jenkins的docker容器，所以我们的jenkins环境下是不会存在<code>php</code>以及<code>node</code>的环境，所以我们这个时候，在安装依赖的时候，借助了上下文中的 <code>docker.image</code> 关键字来构建一个容器来触发我们的依赖安装。</p>
<p>接下来就是部署相关的内容了，我们以部署 <code>production</code> 环境来举例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def production(def map &#x3D; [</span><br><span class="line">        sshId      : null,</span><br><span class="line">        deployClass: null</span><br><span class="line">]) &#123;</span><br><span class="line">    def callback &#x3D; &#123;</span><br><span class="line">        if (map[&#39;sshId&#39;] &#x3D;&#x3D; null) &#123;</span><br><span class="line">            map[&#39;sshId&#39;] &#x3D; this.getValue(&#39;deploySshId&#39;)</span><br><span class="line">        &#125;</span><br><span class="line">        if (map[&#39;deployClass&#39;] &#x3D;&#x3D; null) &#123;</span><br><span class="line">            map[&#39;deployClass&#39;] &#x3D; this.getDeployClass()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map[&#39;pipeline&#39;] &#x3D; this</span><br><span class="line"></span><br><span class="line">        this.deploy.production(map)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def apiName &#x3D; &#39;production&#39;</span><br><span class="line">    this.addCallback(apiName, callback)</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不指定 <code>sshId</code> 和 <code>deployClass</code> 的话，都会存在默认值。由于我们整个过程都是通过回调的方式调用的（其实类似于中间件），所以我们这里的多了一个 <code>map[pipeline] = this</code> 的代码，意义在于把当前上下文传递进具体的部署类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">def production(def map &#x3D; [</span><br><span class="line">        sshId      : null,</span><br><span class="line">        deployClass: null,</span><br><span class="line">        pipeline   : null</span><br><span class="line">]) &#123;</span><br><span class="line"></span><br><span class="line">    def keyword &#x3D; &#39;production&#39;</span><br><span class="line">    this.script.stage(&#39;Production Deploy&#39;) &#123;</span><br><span class="line">        if (this.git.isMasterBranch() &amp;&amp; this.script.currentResources[keyword].enabled !&#x3D; false) &#123;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 注入参数</span><br><span class="line">            def tags &#x3D; this.git.tagsList()</span><br><span class="line"></span><br><span class="line">            def buildParameters &#x3D; [</span><br><span class="line">                    [</span><br><span class="line">                            &#39;$class&#39;    : &#39;ChoiceParameter&#39;,</span><br><span class="line">                            choiceType  : &#39;PT_SINGLE_SELECT&#39;,</span><br><span class="line">                            description : &#39;&#39;&#39;</span><br><span class="line">选择构建类型：</span><br><span class="line">auto_deploy - 自动发布（直接发布最新代码）        </span><br><span class="line">deploy - 指定版本发布</span><br><span class="line">rollback - 版本回滚发布</span><br><span class="line">&#39;&#39;&#39;,</span><br><span class="line">                            filterLength: 1,</span><br><span class="line">                            filterable  : false,</span><br><span class="line">                            name        : &#39;buildType&#39;,</span><br><span class="line">                            randomName  : &#39;choice-parameter-69483043309720&#39;,</span><br><span class="line">                            script      : [</span><br><span class="line">                                    &#39;$class&#39;      : &#39;GroovyScript&#39;,</span><br><span class="line">                                    fallbackScript: [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &#39;return[&quot;unknow&quot;]&#39;</span><br><span class="line">                                    ],</span><br><span class="line">                                    script        : [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &#39;return[&quot;auto_deploy&quot;, &quot;deploy&quot;, &quot;rollback&quot;]&#39;,</span><br><span class="line">                                    ]</span><br><span class="line">                            ]</span><br><span class="line">                    ],</span><br><span class="line">                    [</span><br><span class="line">                            &#39;$class&#39;    : &#39;ChoiceParameter&#39;,</span><br><span class="line">                            choiceType  : &#39;PT_SINGLE_SELECT&#39;,</span><br><span class="line">                            description : &#39;&#39;&#39;</span><br><span class="line">选择Tag标签：</span><br><span class="line">auto_deploy时该参数无效</span><br><span class="line">&#39;&#39;&#39;,</span><br><span class="line">                            filterLength: 20,</span><br><span class="line">                            filterable  : true,</span><br><span class="line">                            name        : &#39;buildTag&#39;,</span><br><span class="line">                            randomName  : &#39;choice-parameter-69483043309721&#39;,</span><br><span class="line">                            script      : [</span><br><span class="line">                                    &#39;$class&#39;      : &#39;GroovyScript&#39;,</span><br><span class="line">                                    fallbackScript: [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &#39;return[&quot;unknow&quot;]&#39;</span><br><span class="line">                                    ],</span><br><span class="line">                                    script        : [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &quot;return [$&#123;tags&#125;]&quot;,</span><br><span class="line">                                    ]</span><br><span class="line">                            ]</span><br><span class="line">                    ]</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">            if (!this.script.mStageShow) &#123;</span><br><span class="line">                this.script.notify &#39;请确认是否发布到生产环境？&#39;</span><br><span class="line"></span><br><span class="line">                this.script.timeout(time: 10, unit: &#39;MINUTES&#39;) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        this.script.input &#39;请确认是否要发布到生产环境？&#39;</span><br><span class="line">                    &#125; catch (e) &#123;</span><br><span class="line">                        map[&#39;pipeline&#39;].parameters +&#x3D; buildParameters</span><br><span class="line">                        throw e</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    def updateHistoryFile &#x3D; &#39;UPDATE_HISTORY&#39;</span><br><span class="line">                    def currentTag</span><br><span class="line"></span><br><span class="line">                    if (this.script.params.buildType &#x3D;&#x3D; &#39;deploy&#39; || this.script.params.buildType &#x3D;&#x3D; &#39;rollback&#39;) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 发布指定tag</span><br><span class="line">                        this.script.sh &quot;git checkout $&#123;this.script.params.buildTag&#125;&quot;</span><br><span class="line">                        this.script.currentBuild.description &#x3D; &quot;【指定发布】Tag: $&#123;this.script.params.buildTag&#125;&quot;</span><br><span class="line">                        if (this.script.params.buildType &#x3D;&#x3D; &#39;rollback&#39;) &#123;</span><br><span class="line">                            this.script.currentBuild.description &#x3D; &quot;【回滚】Tag: $&#123;this.script.params.buildTag&#125;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                        currentTag &#x3D; this.script.params.buildTag</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        &#x2F;&#x2F; 开始打tag</span><br><span class="line">                        ...</span><br><span class="line">                            try &#123;</span><br><span class="line">                                def tagRes</span><br><span class="line">                                if (link.startsWith(&quot;http&quot;)) &#123;</span><br><span class="line">                                    &#x2F;&#x2F; gitbucket</span><br><span class="line">                                    ...</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    &#x2F;&#x2F; gitlab</span><br><span class="line">                                    ...</span><br><span class="line">                                &#125;</span><br><span class="line">                                if (tagRes[&#39;exitCode&#39;] &gt; 0 &amp;&amp; !tagRes[&#39;stdout&#39;].contains(&#39;already exists&#39;)) &#123;</span><br><span class="line">                                    throw new Exception(tagRes[&#39;stdout&#39;])</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; catch (e) &#123;</span><br><span class="line">                                throw e</span><br><span class="line">                            &#125;</span><br><span class="line">                            this.script.sh &quot;tee $&#123;preCommitIdFile&#125; &lt;&lt;&lt; $&#123;this.git.commitId()&#125;&quot;</span><br><span class="line"></span><br><span class="line">                            currentTag &#x3D; nextTag</span><br><span class="line"></span><br><span class="line">                            &#x2F;&#x2F; 最新tag加入下拉框</span><br><span class="line">                            buildParameters[1][&#39;script&#39;][&#39;script&#39;][&#39;script&#39;] &#x3D; &quot;return [\&quot;$&#123;currentTag&#125;\&quot;,$&#123;tags&#125;]&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ...</span><br><span class="line">                    this.script.currentBuild.description &#x3D; &quot;【自动发布】Tag: $&#123;currentTag&#125;&quot;</span><br><span class="line">                    this.publishDeployment(keyword)(map[&#39;sshId&#39;], map[&#39;deployClass&#39;])</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.script.echo &#39;Production Deploy Show&#39;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            map[&#39;pipeline&#39;].parameters +&#x3D; buildParameters</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Utils.markStageSkippedForConditional(this.script.env.STAGE_NAME)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们再说明一下我们的自动化流程。</p>
<ul>
<li><ol>
<li>提交feature代码</li>
</ol>
</li>
<li><ol start="2">
<li>合并到pre-develop分支，触发jenkins任务构建更新debug环境代码</li>
</ol>
</li>
<li><ol start="3">
<li>最终合并到master分支，触发jenkins任务，如果代码有变化则对最新的master代码进行打tag，构建更新production环境代码</li>
</ol>
</li>
</ul>
<p>基于以上几点，我们就可以很直观的看到部署production类的时候，我们会检测master的代码，如果存在变化则进行打tag。然后再调用具体的部署逻辑。其中 <code>this.script.currentResources[keyword].enabled</code> 是来自于我们的 <code>resource-libaray</code> 的配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">abstract class AbstractDeployment &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 打包逻辑</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    abstract def parallelBefore(def packFiles, def packExclude)</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 并行逻辑</span><br><span class="line">     * @param ip</span><br><span class="line">     * @param port</span><br><span class="line">     * @param directory</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    abstract def parallel(def ip, def port, def directory, def backupExclude)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的抽象具体部署类存在2个必须实现的抽象方法，分别是 <code>parallelBefore</code>, <code>parallel</code>。</p>
<ul>
<li>parallelBefore：并发部署前做的事情</li>
<li>parallel：并发部署到多台目标机器上</li>
</ul>
<h2 id="resources-libraries"><a href="#resources-libraries" class="headerlink" title="resources-libraries"></a>resources-libraries</h2><p>资源共享库</p>
<p>对外提供一个全局的函数 <code>mresource_load</code>，内部提供给上下文关键字拿到当前项目，当前环境的对应的部署内容信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">├── README.MD</span><br><span class="line">├── resources</span><br><span class="line">│   ├── git.xxxx.com</span><br><span class="line">│   │   ├── repo-group1</span><br><span class="line">│   │   │   ├── a.yaml</span><br><span class="line">│   │   │   └── b.yaml</span><br><span class="line">│   │   └── repo-group2</span><br><span class="line">│   │       └── c.yaml</span><br><span class="line">│   └── gitlab.xxx.com</span><br><span class="line">│       ├── repo-group3</span><br><span class="line">│       │   ├── d.yaml</span><br><span class="line">│       │   └── e.yaml</span><br><span class="line">│       └── repo-group4</span><br><span class="line">│           ├── f.yaml</span><br><span class="line">│           └── g.yaml</span><br><span class="line">├── tests</span><br><span class="line">│   └── test_mresource_load.groovy</span><br><span class="line">└── vars</span><br><span class="line">    └── mresource_load.groovy</span><br></pre></td></tr></table></figure>

<p>我们看到我们的基本结构和上一个 <code>jenkins-shard-libraries</code> 十分的类似，区别在于 <code>resources-libraries</code> 不存在 <code>src</code> 目录，但是 <code>resources</code> 全部都存在资源配置。</p>
<p>资源存放的目录，结构目录规则为 <code>&lt;FQDN&gt;/&lt;group&gt;/&lt;repo&gt;</code>，对应git仓库。</p>
<p>资源库采用<code>yaml</code>格式。目前支持的key有：</p>
<ul>
<li><p>type(normal|job_name)</p>
<ul>
<li>normal   常规项目，不区分项目</li>
<li>job_name 区分项目，一套仓库，多个项目区分部署</li>
</ul>
</li>
<li><p>debug 内测环境</p>
<ul>
<li>address   ip:port</li>
<li>directory 代码目录路径</li>
<li>deploy_ssh_id 部署的凭证</li>
<li>execute_user 执行的用户，目前仅仅在GolangPipline有效</li>
<li>ssh_username 部署代码的ssh的账号，目前在GolangPipline仅调试用</li>
</ul>
</li>
<li><p>reviews 灰度环境</p>
<ul>
<li>enabled:  false  跳过reviews步骤</li>
<li>address   ip:port</li>
<li>directory 代码目录路径</li>
<li>deploy_ssh_id 部署的凭证</li>
<li>execute_user 执行的用户，目前仅仅在GolangPipline有效</li>
<li>ssh_username 部署代码的ssh的账号，目前在GolangPipline仅调试用【非必填，默认采用deploy_ssh_id的信息】</li>
</ul>
</li>
<li><p>production 生产环境</p>
<ul>
<li>address   ip:port</li>
<li>directory 代码目录路径</li>
<li>deploy_ssh_id 部署的凭证</li>
<li>branch    生产环境对应的分支 【非必填】</li>
<li>execute_user 执行的用户，目前仅仅在GolangPipline有效【非必填】</li>
<li>ssh_username 部署代码的ssh的账号，目前在GolangPipline仅调试用【非必填，默认采用deploy_ssh_id的信息】</li>
</ul>
</li>
</ul>
<p>附加在上下文的变量：</p>
<ul>
<li>script.currentResources</li>
<li>script.gitCredentialsId</li>
<li>script.buildCredentialsId</li>
</ul>
<p>具体的yaml配置格式的demo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">type: &#39;normal&#39;</span><br><span class="line"></span><br><span class="line">git_credentials_id: &#39;git_credentials_id&#39;</span><br><span class="line"></span><br><span class="line">common: &amp;common</span><br><span class="line">  deploy_ssh_id: &#39;deploy_ssh_id&#39;</span><br><span class="line"></span><br><span class="line">environment:</span><br><span class="line">  debug:</span><br><span class="line">    &lt;&lt;: *common</span><br><span class="line">    address:</span><br><span class="line">      - &#39;2.2.2.2:22&#39;</span><br><span class="line">      - &#39;1.1.1.1:22&#39;</span><br><span class="line">    directory:</span><br><span class="line">      &#39;2.2.2.2:22&#39;: &#39;&#x2F;a&#39;</span><br><span class="line">      &#39;1.1.1.1:22&#39;: &#39;&#x2F;b&#39;</span><br><span class="line"></span><br><span class="line">  reviews:</span><br><span class="line">    &lt;&lt;: *common</span><br><span class="line">    address: &#39;3.3.3.3:22&#39;</span><br><span class="line">    directory: &#39;&#x2F;c&#39;</span><br><span class="line"></span><br><span class="line">  production:</span><br><span class="line">    &lt;&lt;: *common</span><br><span class="line">    address: &#39;4.4.4.4:22&#39;</span><br><span class="line">    directory: &#39;&#x2F;d&#39;</span><br></pre></td></tr></table></figure>

<p>这是基本的配置文件，我们借助了yaml的灵活性，配置出尽可能简洁，可复用的项。<br>我们还有更加灵活的配置和格式，具体参考以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">@Grab(&#39;org.yaml:snakeyaml:1.26&#39;)</span><br><span class="line">import org.yaml.snakeyaml.*</span><br><span class="line"></span><br><span class="line">def call(def config &#x3D; [script: null, groupRepo: null, shortJobName: null, host: null]) &#123;</span><br><span class="line"></span><br><span class="line">    def script &#x3D; config.script</span><br><span class="line">    def groupRepo &#x3D; config.groupRepo</span><br><span class="line">    def shortJobName &#x3D; config.shortJobName</span><br><span class="line">    def host &#x3D; config.host</span><br><span class="line"></span><br><span class="line">    if (groupRepo &#x3D;&#x3D; null) &#123;</span><br><span class="line">        groupRepo &#x3D; script.env.REPOSITORY_GROUP_REPO</span><br><span class="line">    &#125;</span><br><span class="line">    if (shortJobName &#x3D;&#x3D; null) &#123;</span><br><span class="line">        shortJobName &#x3D; script.env.SHORT_JOB_NAME</span><br><span class="line">    &#125;</span><br><span class="line">    if (host &#x3D;&#x3D; null) &#123;</span><br><span class="line">        host &#x3D; &quot;git.xxxx.com&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    configFile &#x3D; host + &#39;&#x2F;&#39; + groupRepo + &#39;.yaml&#39;</span><br><span class="line">    Yaml yaml &#x3D; new Yaml()</span><br><span class="line">    String resourceString &#x3D; libraryResource(configFile)</span><br><span class="line">    Map&lt;String, Object&gt; obj &#x3D; yaml.load(resourceString)</span><br><span class="line">    obj.type &#x3D; obj.type ?: null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def resource &#x3D; [:]</span><br><span class="line">    def git_credentials_id &#x3D; &#39;&#39;</span><br><span class="line">    def build_credentials_id &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">    if (obj.type &#x3D;&#x3D; &#39;job_name&#39;) &#123;</span><br><span class="line">        String pointJobName &#x3D; shortJobName</span><br><span class="line">        for (item in obj) &#123;</span><br><span class="line">            if (item.key &#x3D;&#x3D; pointJobName) &#123;</span><br><span class="line">                def value &#x3D; item.value</span><br><span class="line">                for (it1 in value) &#123;</span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;git_credentials_id&#39;) &#123;</span><br><span class="line">                        git_credentials_id &#x3D; it1.value</span><br><span class="line">                        continue</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;build_credentials_id&#39;) &#123;</span><br><span class="line">                        build_credentials_id &#x3D; it1.value</span><br><span class="line">                        continue</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;environment&#39;) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 兼容 address，String &amp;&amp; List</span><br><span class="line">                        for (it in it1.value) &#123;</span><br><span class="line">                            for (values in it.value) &#123;</span><br><span class="line">                                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                                    if (values.key &#x3D;&#x3D; &#39;address&#39;) &#123;</span><br><span class="line">                                        if (values.value instanceof String) &#123;</span><br><span class="line">                                            values.value &#x3D; [values.value]</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;environment&#39;) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 兼容 directory</span><br><span class="line">                        for (it in it1.value) &#123;</span><br><span class="line">                            for (values in it.value) &#123;</span><br><span class="line">                                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                                    if (values.key &#x3D;&#x3D; &#39;directory&#39;) &#123;</span><br><span class="line">                                        if (values.value instanceof String) &#123;</span><br><span class="line">                                            def dir &#x3D; values.value</span><br><span class="line">                                            values.value &#x3D; [:]</span><br><span class="line">                                            for (def addr in it.value.address) &#123;</span><br><span class="line">                                                values.value[addr] &#x3D; dir</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                resource &#x3D; value</span><br><span class="line"></span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;  &#x2F;&#x2F; job.type &#x3D;&#x3D; normal</span><br><span class="line">        resource &#x3D; obj</span><br><span class="line">        resource.remove(&#39;type&#39;)</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 兼容 address，String &amp;&amp; List</span><br><span class="line">        for (item in resource.environment) &#123;</span><br><span class="line">            for (values in item.value) &#123;</span><br><span class="line">                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                    if (values.key &#x3D;&#x3D; &#39;address&#39;) &#123;</span><br><span class="line">                        if (values.value instanceof String) &#123;</span><br><span class="line">                            values.value &#x3D; [values.value]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 兼容 directory</span><br><span class="line">        for (item in resource.environment) &#123;</span><br><span class="line">            for (values in item.value) &#123;</span><br><span class="line">                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                    if (values.key &#x3D;&#x3D; &#39;directory&#39;) &#123;</span><br><span class="line">                        if (values.value instanceof String) &#123;</span><br><span class="line">                            def dir &#x3D; values.value</span><br><span class="line">                            values.value &#x3D; [:]</span><br><span class="line">                            for (def addr in item.value.address) &#123;</span><br><span class="line">                                values.value[addr] &#x3D; dir</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        git_credentials_id &#x3D; resource.git_credentials_id</span><br><span class="line">        build_credentials_id &#x3D; resource.build_credentials_id</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def environment &#x3D; resource.environment</span><br><span class="line"></span><br><span class="line">    script.currentResources &#x3D; environment ?: [:]</span><br><span class="line">    script.gitCredentialsId &#x3D; git_credentials_id ?: null</span><br><span class="line">    script.buildCredentialsId &#x3D; build_credentials_id ?: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上就是我们的jenkins对共享库应用场景了，后续也会随着服务器对架构而升级优化改变。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/DevOps/">DevOps</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/DevOps/">DevOps</a><a href="/tags/Jenkins/">Jenkins</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>