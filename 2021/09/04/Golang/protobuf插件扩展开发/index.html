<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【Golang】- protobuf插件扩展开发 | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="【Golang】- protobuf插件扩展开发"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>【Golang】- protobuf插件扩展开发</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/09/04/Golang/protobuf插件扩展开发/" rel="bookmark">
        <time class="entry-date published" datetime="2021-09-04T06:16:51.000Z">
          2021-09-04
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近，项目需要用到protobuf来定义消息，但是我们需要一个更灵活的代码片段，如何通过<code>proto</code>文件来创建自定义的代码呢？<br>可以通过proto的<code>plugin</code>对方式来自己是一个<code>proto-gen</code>。</p>
<p>在网上看了一些教程，发现有一些教程已经过时了，而且过于片面，没有把整套思想很好的说明。并且也有一些功能点并没有完全实现。<br>这里总结一下相关的内容，并且说一下最近实现的一个插件。</p>
<blockquote>
<p>对于已经了解大概<code>proto</code>的人来说，相对简单，但是如果是<code>自定义option</code>呢？你又了解吗？</p>
</blockquote>
<a id="more"></a>

<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; test.proto</span><br><span class="line"></span><br><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line">package pb;</span><br><span class="line">option go_package &#x3D; &quot;&#x2F;;pb&quot;;</span><br><span class="line"></span><br><span class="line">import &quot;unknow.proto&quot;;</span><br><span class="line"></span><br><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http) &#x3D; &#123;</span><br><span class="line">            method: &quot;post&quot;</span><br><span class="line">            url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 设备类型</span><br><span class="line">enum ApiIMDeviceType &#123;</span><br><span class="line">    API_IM_UNKNOWN &#x3D; 0;</span><br><span class="line">    API_IM_Android &#x3D; 1;</span><br><span class="line">    API_IM_IOS &#x3D; 2;</span><br><span class="line">    API_IM_Window &#x3D; 3;</span><br><span class="line">    API_IM_MacOS &#x3D; 4;</span><br><span class="line">    API_IM_Web &#x3D; 5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ApiIMRegisterDeviceReq &#123;</span><br><span class="line">    ApiIMDeviceType type &#x3D; 1; &#x2F;&#x2F; 设备类型</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ApiIMRegisterDeviceResp &#123;</span><br><span class="line">    int64 device_id &#x3D; 1; &#x2F;&#x2F; 设备id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到这一个<code>proto</code>文件，常规的我就不说了。主要是看到<code>import &quot;unknow.proto&quot;</code>, <code>option (unknow.api.http)</code></p>
<p>可以看到，我这里引入一个<code>unknow.proto</code>的文件。</p>
<p>我希望最终生成一个<code>api.unknow.go</code>的文件。里面的内容期待如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2021, whiteCcinn Inc.</span></span><br><span class="line"><span class="comment">// Code generated by protoc-gen-unknow. DO NOT EDIT.</span></span><br><span class="line"><span class="comment">// source: test.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Api <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Method <span class="keyword">string</span></span><br><span class="line">	Url    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newApi</span><span class="params">(name, method, url <span class="keyword">string</span>)</span> *<span class="title">Api</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Api&#123;</span><br><span class="line">		name, method, url,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	RegisterDeviceApi = newApi(<span class="string">"RegisterDevice"</span>, <span class="string">"post"</span>, <span class="string">"/v1/im/register_device"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>生成的文件，我可以在项目通过<code>pb.RegisterDeviceApi</code>拿到在<code>proto</code>定义好的API内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; unknow.proto</span><br><span class="line"></span><br><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package unknow.api;</span><br><span class="line"></span><br><span class="line">option go_package &#x3D; &quot;&#x2F;;pb&quot;;</span><br><span class="line"></span><br><span class="line">import &quot;google&#x2F;protobuf&#x2F;descriptor.proto&quot;;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">    &#x2F;&#x2F; See &#96;HttpRule&#96;.</span><br><span class="line">    HttpRule http &#x3D; 72295728;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HttpRule &#123;</span><br><span class="line">    string url &#x3D; 1;</span><br><span class="line">    string method &#x3D; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto" target="_blank" rel="noopener">google/api/annotations.proto</a></li>
<li><a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto" target="_blank" rel="noopener">google/api/http.proto</a></li>
<li><a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/descriptor.proto" target="_blank" rel="noopener">google/protobuf/descriptor.proto</a></li>
</ul>
<p>如果有了解过<code>google/api/annotations.proto</code> 和 <code>google/api/http.proto</code>的人应该不会陌生，当你需要用到<code>grpc-gateway</code>或者<code>proto-gen-swaager</code>的时候，都会有介绍到<code>option(goggle.api.http)</code>的用法。</p>
<p>这里我们看到<code>unknow.proto</code>的结构体，这就是一个简化版本。用于实现<code>自定义的option</code>用的。</p>
<h3 id="unknow-proto"><a href="#unknow-proto" class="headerlink" title="unknow.proto"></a>unknow.proto</h3><p>对于基础的语法规则来说，我们来看剖析一下<code>unknow.proto</code>，常规的就不说了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package unknow.api;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">    &#x2F;&#x2F; See &#96;HttpRule&#96;.</span><br><span class="line">    HttpRule http &#x3D; 72295728;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HttpRule &#123;</span><br><span class="line">    string url &#x3D; 1;</span><br><span class="line">    string method &#x3D; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于<code>extend</code>的用法，我这里列一下官方的链接。</p>
<ul>
<li><a href="https://developers.google.com/protocol-buffers/docs/overview#customoptions" target="_blank" rel="noopener">Custom Options</a></li>
</ul>
<p>我们看到这里，<code>extend google.protobuf.MethodOptions</code>。</p>
<p>代表着，我这里自定义个作用于<code>Method</code>的<code>option</code>。所以在真正的<code>proto</code>文件中，我就可以使用<code>unknow.api.option</code>的标签。也就是<code>option (unknow.api.http)</code>。</p>
<p>接着我们看到，这个option我们定义了一个元素，类型是<code>Message HttpRule</code>，命名为<code>http</code>，并且给它定义一个唯一的<code>Number</code>。</p>
<p>接着我们看到<code>HttpRule</code>，内部存在2个元素，一个是<code>string url</code> 和 <code>string method</code>，这意味着我们可以使用<code>独立行写法</code>：<code>option (unknow.api.http).url = &quot;/v1/im/register_device&quot;</code>，然后再下一行使用 <code>option (unknow.api.http).method = &quot;post&quot;</code>，一个完整的例如如下：</p>
<p>刚才说到，这是一个<code>method</code>的<code>option</code>，也就是我们这里定义的<code>rpc</code>下的 <code>option</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http).method &#x3D; &quot;post&quot;</span><br><span class="line">        option (unknow.api.http).url &#x3D; &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了这个写法，我更推荐如下更简洁的写法，用<code>map</code>的写法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http) &#x3D; &#123;</span><br><span class="line">            method: &quot;post&quot;</span><br><span class="line">            url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样子，我们就看懂了<code>test.proto</code>的内容了对吧。连贯起来，那么我们的这个<code>unknow.proto</code>就是用于实现<code>option(unknow.api.http)</code>。而<code>option(unknow.api.http)</code>的使用则在<code>test.proto</code>进行采用。</p>
<p>好了，有了定义的文件，那么接下来就是我们的重点了，如何编写一个实现<code>自定义代码的protobuf插件扩展</code></p>
<h3 id="扩展实现"><a href="#扩展实现" class="headerlink" title="扩展实现"></a>扩展实现</h3><p><img src="/images/Go/protobuf.png" alt="protobuf解析流程图"></p>
<blockquote>
<p>protobuf解析旧版的流程图，便于我们理解。新版的后续我抽空再画画</p>
</blockquote>
<h3 id="不科学的例子"><a href="#不科学的例子" class="headerlink" title="不科学的例子"></a>不科学的例子</h3><p>第一个例子，以golang旧版<code>proto-gen-go</code>为例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;io&#x2F;ioutil&quot;</span><br><span class="line">	&quot;os&quot;</span><br><span class="line"></span><br><span class="line">	&quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;proto&quot;</span><br><span class="line">	&quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;protoc-gen-go&#x2F;generator&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	&#x2F;&#x2F; Begin by allocating a generator. The request and response structures are stored there</span><br><span class="line">	&#x2F;&#x2F; so we can do error handling easily - the response structure contains the field to</span><br><span class="line">	&#x2F;&#x2F; report failure.</span><br><span class="line">	g :&#x3D; generator.New()</span><br><span class="line"></span><br><span class="line">	data, err :&#x3D; ioutil.ReadAll(os.Stdin)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		g.Error(err, &quot;reading input&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if err :&#x3D; proto.Unmarshal(data, g.Request); err !&#x3D; nil &#123;</span><br><span class="line">		g.Error(err, &quot;parsing input proto&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if len(g.Request.FileToGenerate) &#x3D;&#x3D; 0 &#123;</span><br><span class="line">		g.Fail(&quot;no files to generate&quot;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g.CommandLineParameters(g.Request.GetParameter())</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Create a wrapped version of the Descriptors and EnumDescriptors that</span><br><span class="line">	&#x2F;&#x2F; point to the file that defines them.</span><br><span class="line">	g.WrapTypes()</span><br><span class="line"></span><br><span class="line">	g.SetPackageNames()</span><br><span class="line">	g.BuildTypeNameMap()</span><br><span class="line"></span><br><span class="line">	g.GenerateAllFiles()</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; Send back the results.</span><br><span class="line">	data, err &#x3D; proto.Marshal(g.Response)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		g.Error(err, &quot;failed to marshal output proto&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">	_, err &#x3D; os.Stdout.Write(data)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		g.Error(err, &quot;failed to write output proto&quot;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我发现现在网上很多教程都会以旧版的为主，并且都是沿用参考了<code>proto-gen-go</code>的这个旧版的写法，所以导致，我们在学习写的时候，会出现一些问题。并且其实你用了旧版的这个写法，当你在用<code>protoc</code>去编译的情况下，<code>protoc</code>也会友好的提示你，该API已经被废弃，将在未来的版本下移除，请使用新的写法。虽然你还是能编译通过，但是你不敢保证未来哪一个版本就直接不向后兼容了。</p>
<p>第二个例子。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">input, _ := ioutil.ReadAll(os.Stdin)</span><br><span class="line"><span class="keyword">var</span> req pluginpb.CodeGeneratorRequest</span><br><span class="line">proto.Unmarshal(input, &amp;req)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认选项初始化我们的插件</span></span><br><span class="line">opts := protogen.Options&#123;&#125;</span><br><span class="line">plugin, err := opts.New(&amp;req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">   <span class="built_in">panic</span>(err)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这种方式就是从头到尾都自己写，把整个<code>pipeline</code>的流程都自己处理。但是大可不必，因为其实有很多流程化的东西，在新版的<code>genpro</code>下已经封装成了一个<code>Run</code>传递回调函数即可。</p>
<h3 id="正确的例子"><a href="#正确的例子" class="headerlink" title="正确的例子"></a>正确的例子</h3><p>如果真的要参考的话，推荐参考最新版本的<a href="https://github.com/golang/protobuf/blob/master/protoc-gen-go/main.go" target="_blank" rel="noopener">proto-gen-go</a></p>
<p>首先，我们需要知道一点，我们在采用<code>protoc</code>对<code>proto</code>文件进行编译的时候，经常是执行类似如下代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc -I.:$&#123;GOGO_PROTOBUF&#125; \</span><br><span class="line">--gofast_out=plugins=grpc:./go-pb</span><br></pre></td></tr></table></figure>
<p><br>由于这里我用的是<code>gogoprotobuf</code>，所以你会看到我这里的是<code>--gofast_out=plugins=grpc:./go-pb</code>，如果你是<code>protobuf</code>的官方的<code>proto-gen</code>的话，那么你这里应该是<code>--go_out=plugins=grpc:./go-pb</code></p>
<p>这里我们需要注意的是什么呢，就是<code>插件二进制文件名</code>，这是有一定规则的，这是我之前在<code>自定义git凭据</code>文章中说明的一样，这二进制文件需要在你的环境变量中，否则你就需要通过<code>-I</code>来指定文件路径。然后命名规则为<code>proto-gen-xxx</code>，而这个<code>xxx</code>就是你的自定义的名字。在本例子中，我的扩展名字就是<code>proto-gen-unknow</code>。</p>
<p>因此，最终如果我要执行的话，那么就是执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc -I.:$&#123;GOGO_PROTOBUF&#125; \</span><br><span class="line">--unknow_out=./go-pb</span><br></pre></td></tr></table></figure>

<p>其实如果有接触过<code>thrift</code> 或者 <code>Rust</code>的<code>元编程</code> 甚至是 <code>Python</code>的 <code>lark-parser</code>自定义抽象语法树，或者其他经由<code>AST</code>抽象语法树写代码的同学应该都知道，这其实抽象出来就是一个<code>AST</code>的解析处理而已。所以我首先需要了解他的部署。</p>
<p>一个简陋的<code>AST</code>定义如下（哈哈，略显简陋，但是了解AST是啥的应该多少能看懂一些）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FileDescriptor -&gt; ServiceDescriptor</span><br><span class="line">					-&gt; ServiceOptionDescriptor</span><br><span class="line">					-&gt; MethodDescriptor</span><br><span class="line">						-&gt; MethodOptionDescriptor</span><br><span class="line">					    -&gt; [MessageDescriptor]</span><br><span class="line">               -&gt; MessageDescriptor</span><br><span class="line">					-&gt; MessageOptionDescriptor</span><br><span class="line">					-&gt; FieldDescriptor</span><br><span class="line">						-&gt; FieldOptionDescriptor</span><br><span class="line">			   -&gt; FieldOptionDescriptor</span><br></pre></td></tr></table></figure>

<p>知道怎么执行了，和<code>AST</code>, 我们就来看看怎么编写代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  protoc-gen-unknow git:(main) tree</span><br><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── internal</span><br><span class="line">│   └── unknow.go</span><br><span class="line">├── main.go</span><br><span class="line">├── out</span><br><span class="line">│   └── unknow.pb.go</span><br><span class="line">└── proto</span><br><span class="line">    ├── descriptor.proto</span><br><span class="line">    └── unknow.proto</span><br></pre></td></tr></table></figure>

<p>可以看到，这是我的一个代码结构目录</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"internal"</span></span><br><span class="line">	<span class="string">"google.golang.org/protobuf/compiler/protogen"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	u := internal.Unknow&#123;&#125;</span><br><span class="line">	protogen.Options&#123;&#125;.Run(u.Generate)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们借助<code>protobuf</code> 编译包下的 <code>protogen</code> 工具来解析 <code>proto</code> 文件。我们接下来看一下 <code>internal</code> 包下具体的写法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> internal</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	pb <span class="string">"out"</span></span><br><span class="line">	<span class="string">"google.golang.org/protobuf/compiler/protogen"</span></span><br><span class="line">	<span class="string">"google.golang.org/protobuf/proto"</span></span><br><span class="line">	<span class="string">"google.golang.org/protobuf/types/descriptorpb"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Unknow <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">Generate</span><span class="params">(plugin *protogen.Plugin)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(plugin.Files) &lt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 指定生成文件的文件名</span></span><br><span class="line">	filename := <span class="string">"/api.unknow.go"</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个文件生成器对象</span></span><br><span class="line">	g := plugin.NewGeneratedFile(filename, plugin.Files[<span class="built_in">len</span>(plugin.Files)<span class="number">-1</span>].GoImportPath)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用g.P就是往文件开始写入自己期待的代码</span></span><br><span class="line">	g.P(<span class="string">`// Copyright (c) 2021, whiteCcinn Inc.`</span>)</span><br><span class="line">	g.P(<span class="string">"// Code generated by protoc-gen-unknow. DO NOT EDIT."</span>)</span><br><span class="line">	g.P(<span class="string">"// source: all MethodOptions(unknow.api.http) in proto file"</span>)</span><br><span class="line">	g.P()</span><br><span class="line">	g.P(<span class="string">"package "</span>, plugin.Files[<span class="built_in">len</span>(plugin.Files)<span class="number">-1</span>].GoPackageName)</span><br><span class="line"></span><br><span class="line">	g.P(<span class="string">`</span></span><br><span class="line"><span class="string">type Api struct &#123;</span></span><br><span class="line"><span class="string">	Name   string</span></span><br><span class="line"><span class="string">	Method string</span></span><br><span class="line"><span class="string">	Url    string</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">func newApi(name, method, url string) *Api &#123;</span></span><br><span class="line"><span class="string">	return &amp;Api&#123;</span></span><br><span class="line"><span class="string">		name, method, url,</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line"></span><br><span class="line">	g.P(<span class="string">"var ("</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通过plugin.Fiels，我们可以拿到所有的输入的proto文件</span></span><br><span class="line">	<span class="comment">// 如果我们需要对这个文件生成代码的话，那么就进入到generateFile()逻辑</span></span><br><span class="line">	<span class="comment">// 并且把g和f一起传递过去</span></span><br><span class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> plugin.Files &#123;</span><br><span class="line">		<span class="keyword">if</span> f.Generate &#123;</span><br><span class="line">			<span class="keyword">if</span> _, err := u.generateFile(g, f); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g.P(<span class="string">")"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">generateFile</span><span class="params">(g *protogen.GeneratedFile, file *protogen.File)</span> <span class="params">(*protogen.GeneratedFile, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 这一段代码仅仅只是为了忽略包含proto文件中包含了streamClient和streamServer的代码</span></span><br><span class="line">	isGenerated := <span class="literal">false</span></span><br><span class="line">	<span class="keyword">for</span> _, srv := <span class="keyword">range</span> file.Services &#123;</span><br><span class="line">		<span class="keyword">for</span> _, method := <span class="keyword">range</span> srv.Methods &#123;</span><br><span class="line">			<span class="keyword">if</span> method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			isGenerated = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !isGenerated &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// file 的下一层级就是 services 层级</span></span><br><span class="line">	<span class="keyword">for</span> _, srv := <span class="keyword">range</span> file.Services &#123;</span><br><span class="line">		<span class="keyword">if</span> err := u.genService(g, srv); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> g, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">genService</span><span class="params">(g *protogen.GeneratedFile, srv *protogen.Service)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// service 内部有很多 rpc 关键字的方法</span></span><br><span class="line">	<span class="keyword">for</span> _, method := <span class="keyword">range</span> srv.Methods &#123;</span><br><span class="line">		<span class="keyword">if</span> method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 由于我们自定义的是就是MethodOptions，所以就来到了这里来进行判断</span></span><br><span class="line">		<span class="keyword">if</span> err := u.genMethodHTTPRule(g, method); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">genMethodHTTPRule</span><span class="params">(g *protogen.GeneratedFile, method *protogen.Method)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 因为我们通过method.Desc.Options() 拿到的数据类型是`interface&#123;&#125;` 类型</span></span><br><span class="line">	<span class="comment">// 所以这里我们需要对Options，明确指定转换为 *descriptorpb.MethodOptions 类型</span></span><br><span class="line">	<span class="comment">// 这样子就能拿到我们的MethodOption对象</span></span><br><span class="line">	options, ok := method.Desc.Options().(*descriptorpb.MethodOptions)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PS：重点</span></span><br><span class="line">	<span class="comment">// 这里我们看到我们借助了一个非protogen下的包的内容</span></span><br><span class="line">	<span class="comment">// 原因就是，protobuf编译器会把自定义的Option全部指定为Extension，由于并非内置的属性和值</span></span><br><span class="line">	<span class="comment">// protobuf官方是没办法拿到和你对应的可读的内容的，只能通过拿到经过序列化之后的数据。</span></span><br><span class="line">	<span class="comment">// 因此，我们这里通过 proto.GetExtension的方法，把刚才unknow.proto单独编译好的 unknow.pb.proto 文件下的 pb. E_HTTP 加载进来，指定了我需要在自定义扩展的MethodOptions中，拿到该Http下里面的value</span></span><br><span class="line">	<span class="comment">// 也因此，我们可以再经过一次类型转换，就可以拿到了具体的httpRule</span></span><br><span class="line">	httpRule, ok := proto.GetExtension(options, pb.E_Http).(*pb.HttpRule)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 接下来，我们就可以通过GetXxx的方式，来获取我们设置在其Message内部filed</span></span><br><span class="line">	m := httpRule.GetMethod()</span><br><span class="line">	url := httpRule.GetUrl()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(m) == <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(url) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	g.P(<span class="string">"     "</span>, method.GoName, <span class="string">"Api = "</span>, <span class="string">"newApi(\""</span>, method.GoName, <span class="string">"\", \""</span>, m, <span class="string">"\", \""</span>, url, <span class="string">"\")"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请跟着说明中注释一步步查看详解</p>
</blockquote>
<p>查看这段代码逻辑，也是非常简单，因为没有特别复杂的逻辑，尽量不要跳过，因为里面涉及到如何读取自定义的Option的问题。代码大致定位在 <code>proto.GetExtension</code>方法附近。</p>
<p>因为这里的demo生成的代码比较简单。最终，我们生成的代码就是：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2021, whiteCcinn Inc.</span></span><br><span class="line"><span class="comment">// Code generated by protoc-gen-unknow. DO NOT EDIT.</span></span><br><span class="line"><span class="comment">// source: source: all MethodOptions(unknow.api.http) in proto file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Api <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name   <span class="keyword">string</span></span><br><span class="line">	Method <span class="keyword">string</span></span><br><span class="line">	Url    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newApi</span><span class="params">(name, method, url <span class="keyword">string</span>)</span> *<span class="title">Api</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Api&#123;</span><br><span class="line">		name, method, url,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	RegisterDeviceApi = newApi(<span class="string">"RegisterDevice"</span>, <span class="string">"post"</span>, <span class="string">"/v1/im/register_device"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>放一下完整的测试命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install . &amp;&amp; protoc --proto_path proto/ -I=. test.proto  test2.proto --unknow_out=./out --go_out=./out</span><br></pre></td></tr></table></figure>

<p>最后生成的文件目录结构如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  protoc-gen-unknow git:(main) tree</span><br><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── internal</span><br><span class="line">│   └── unknow.go</span><br><span class="line">├── main.go</span><br><span class="line">├── out</span><br><span class="line">│   ├── api.unknow.go</span><br><span class="line">│   ├── test.pb.go</span><br><span class="line">│   ├── test2.pb.go</span><br><span class="line">│   └── unknow.pb.go</span><br><span class="line">└── proto</span><br><span class="line">    ├── descriptor.proto</span><br><span class="line">    ├── test.proto</span><br><span class="line">    ├── test2.proto</span><br><span class="line">    └── unknow.protos</span><br></pre></td></tr></table></figure>

<p>最后推荐几个扩展库写得不错的扩展插件: </p>
<ul>
<li><a href="https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-grpc-gateway" target="_blank" rel="noopener">protoc-gen-grpc-gateway</a></li>
<li><a href="https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-openapiv2" target="_blank" rel="noopener">protoc-gen-grpc-openapiv2</a></li>
<li><a href="https://github.com/nametake/protoc-gen-gohttp" target="_blank" rel="noopener">protoc-gen-grpc-gohttp</a></li>
</ul>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Golang/">Golang</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Golang/">Golang</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2025 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>