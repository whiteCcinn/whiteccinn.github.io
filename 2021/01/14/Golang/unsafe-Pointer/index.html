<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【Golang】- unsafe Pointer | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="【Golang】- unsafe Pointer"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>【Golang】- unsafe Pointer</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2021/01/14/Golang/unsafe-Pointer/" rel="bookmark">
        <time class="entry-date published" datetime="2021-01-14T03:37:12.000Z">
          2021-01-14
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于目前在使用使用一些go写的odbc库，里面涉及到一些cgo的内容，那就避不开内存和指针等问题，在这边文章中记录一下<code>unsafe Pointer</code> 和 <code>uintptr</code> 的相关内容。</p>
<p>Go语言在设计的时候，为了编写方便、效率高以及降低复杂度，被设计成为一门强类型的静态语言。强类型意味着一旦定义了，它的类型就不能改变了；静态意味着类型检查在运行前就做了。</p>
<p>同时为了安全的考虑，Go语言是不允许两个指针类型进行转换的。</p>
<a id="more"></a>

<h2 id="指针类型转换"><a href="#指针类型转换" class="headerlink" title="指针类型转换"></a>指针类型转换</h2><p>我们一般使用<code>*T</code>作为一个指针类型，表示一个指向类型<code>T变量</code>的<code>指针</code>。为了安全的考虑，两个不同的指针类型不能相互转换，比如<code>*int</code>不能转为<code>*float64</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	i:= <span class="number">10</span></span><br><span class="line">	ip:=&amp;i</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> fp *<span class="keyword">float64</span> = (*<span class="keyword">float64</span>)(ip)</span><br><span class="line"></span><br><span class="line">	fmt.Println(fp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码我们在编译的时候，会提示 <code>cannot convert ip (type *int) to type *float64</code>，也就是不能进行强制转型。那如果我们还是需要进行转换怎么做呢？这就需要我们使用 <code>unsafe包</code> 里的 <code>Pointer</code> 了，下面我们先看看 <code>unsafe.Pointer</code> 是什么，然后再介绍如何转换。</p>
<h2 id="unsafe-Pointer"><a href="#unsafe-Pointer" class="headerlink" title="unsafe.Pointer"></a>unsafe.Pointer</h2><p><code>unsafe.Pointer</code> 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 <code>C语言</code> 里的 <code>void*</code> 指针，全能型的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	i:= <span class="number">10</span></span><br><span class="line">	ip:=&amp;i</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> fp *<span class="keyword">float64</span> = (*<span class="keyword">float64</span>)(unsafe.Pointer(ip))</span><br><span class="line"></span><br><span class="line">	*fp = *fp * <span class="number">3</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上示例，我们可以把 <code>*int</code> 转为 <code>*float64</code> ,并且我们尝试了对新的 <code>*float64</code> 进行操作，打印输出i，就会发现i的址同样被改变。</p>
<p>以上这个例子没有任何实际的意义，但是我们说明了，通过 <code>unsafe.Pointer</code> 这个万能的指针，我们可以在 <code>*T</code> 之间做任何转换。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ArbitraryType <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pointer *ArbitraryType</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>unsafe.Pointer</code> 其实就是一个 <code>*int</code>,一个通用型的指针。</p>
<p>我们看下关于 <code>unsafe.Pointer</code> 的4个规则。</p>
<ul>
<li><code>任何指针</code> 都可以转换为 <code>unsafe.Pointer</code></li>
<li><code>unsafe.Pointer</code> 可以转换为 <code>任何指针</code></li>
<li><code>uintptr</code> 可以转换为 <code>unsafe.Pointer</code></li>
<li><code>unsafe.Pointer</code> 可以转换为 <code>uintptr</code></li>
</ul>
<p>前面两个规则我们刚刚已经演示了，主要用于 <code>*T1</code> 和 <code>*T2</code> 之间的转换，那么最后两个规则是做什么的呢？我们都知道 <code>*T</code> 是 <code>不能计算偏移量</code> 的，也不能进行计算，<code>但是uintptr可以</code>，所以我们可以把<code>指针</code>转为<code>uintptr</code>再<code>进行偏移计算</code>，这样我们就可以<code>访问特定的内存</code>了，达到对不同的<code>内存读写</code>的目的。</p>
<p>下面我们以通过<code>指针偏移</code> 修改Struct结构体内的字段为例，来演示 <code>uintptr</code> 的用法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	u:=<span class="built_in">new</span>(user)</span><br><span class="line">	fmt.Println(*u)</span><br><span class="line"></span><br><span class="line">	pName:=(*<span class="keyword">string</span>)(unsafe.Pointer(u))</span><br><span class="line">	*pName=<span class="string">"张三"</span></span><br><span class="line"></span><br><span class="line">	pAge:=(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(u))+unsafe.Offsetof(u.age)))</span><br><span class="line">	*pAge = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(*u)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">	name <span class="keyword">string</span></span><br><span class="line">	age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上我们通过内存偏移的方式，定位到我们需要操作的字段，然后改变他们的值。</p>
<p>第一个修改user的name值的时候，<code>因为name是第一个字段，所以不用偏移</code>，我们获取user的指针，然后通过 <code>unsafe.Pointer</code> 转为<code>*string</code> 进行赋值操作<code>即可</code>。</p>
<p>第二个修改user的age值的时候，<code>因为age不是第一个字段，所以我们需要内存偏移</code>，内存偏移牵涉到的计算只能通过<code>uintptr</code>，所我们要先把<code>user的指针地址</code>转为<code>uintptr</code>，然后我们再通过<code>unsafe.Offsetof(u.age)</code>获取需要偏移的值，进行<code>地址运算(+)偏移</code>即可。</p>
<p>现在偏移后，地址已经是user的age字段了，如果要给它赋值，我们需要把<code>uintptr</code>转为<code>*int</code>才可以。所以我们通过把<code>uintptr</code>转为<code>unsafe.Pointer</code>,再转为<code>*int</code>就可以操作了。</p>
<p>这里我们可以看到，我们第二个偏移的表达式非常长，但是也千万不要把他们分段，不能像下面这样。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp:=<span class="keyword">uintptr</span>(unsafe.Pointer(u))+unsafe.Offsetof(u.age)</span><br><span class="line">pAge:=(*<span class="keyword">int</span>)(unsafe.Pointer(temp))</span><br><span class="line">*pAge = <span class="number">20</span></span><br></pre></td></tr></table></figure>

<p>栈内指针在栈扩容的时候，有了新的地址，因此<code>uintptr</code>只能作为指针计算的中间态，<code>不允许</code>使用变量<code>保存uintptr的值</code>。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>unsafe是不安全的，所以我们应该尽可能少的使用它</code>，比如内存的操纵，这是绕过Go本身设计的安全机制的，不当的操作，可能会破坏一块内存，而且这种问题非常不好定位。</p>
<p>当然必须的时候我们可以使用它，比如底层类型相同的数组之间的转换；比如使用sync/atomic包中的一些函数时；还有访问Struct的私有字段时，该用还是要用，不过一定要慎之又慎。</p>
<p><code>整个unsafe包都是用于Go编译器的，不用运行时，在我们编译的时候，Go编译器已经把他们都处理了</code>。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Golang/">Golang</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Golang/">Golang</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>