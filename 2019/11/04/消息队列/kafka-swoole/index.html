<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【消息队列】- kafka-swoole | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="【消息队列】- kafka-swoole"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>【消息队列】- kafka-swoole</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/11/04/消息队列/kafka-swoole/" rel="bookmark">
        <time class="entry-date published" datetime="2019-11-04T02:37:40.000Z">
          2019-11-04
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前 kafka 客户端在 php 中比较出名的仅有 2 个，这 2 个项目都有各自的利弊。在这里我选择几个来列一下</p>
<ul>
<li><a href="https://github.com/weiboad/kafka-php" target="_blank" rel="noopener">weiboad/kafka-php</a><ul>
<li>协议非结构化封装，自定义性较强，不好维护</li>
<li>目前的 API 在消费者中由于单例设计的原因，不允许在消费者中生产消息</li>
<li>不支持多种压缩协议</li>
<li>单进程“协程式”逻辑，数据未实现分离，容易堵塞消费</li>
</ul>
</li>
<li><a href="https://github.com/arnaud-lb/php-rdkafka" target="_blank" rel="noopener">arnaud-lb/php-rdkafka</a><ul>
<li>协议非结构化封装，自定义性较强，不好维护</li>
<li>不支持多种压缩协议</li>
<li>利用多线程，但是 PHP 对多线程对支持并不友好，相对于用 swoole 而言，劣势较为明显，容易出 bug，且维护性不高</li>
</ul>
</li>
</ul>
<p>基于以上几点，我们在基于<code>swoole-4.3</code>以上重新开发了<code>kafka-swoole</code>项目，优点如下：</p>
<ul>
<li>多进程多核处理</li>
<li>支持 kafka 多个 sink 方式，实现拉取 kafka 数据和业务逻辑分离，从而不堵塞数据拉取</li>
<li>首个支持多种压缩方式（normal(不压缩)/gzip/snappy）的 php 客户端，从而在大吞吐对情况下减少带宽占用，提高传输速率</li>
<li>协议封装采用 OOP 的方式，结构化了协议的封装，利于维护和封装，对协议利用反射来统一封包和解包</li>
<li>利用协程来实现单个进程中对异步逻辑处理</li>
<li>提供了 runtime 的 rpc 命令，实时获取 kafka 成员进程对内部数据，实时查看消费情况</li>
<li>提供了 kafka 命令，方便获取 kafka 服务相关信息和 kafka 相关操作</li>
<li>在成员进程挂掉的情况下，记录错误信息，自动拉起。</li>
<li>对于常驻进程，不排除业务逻辑写出了内存泄漏的情况，所以所有的子进程都带有内存临界值重启机制来释放内存</li>
<li>主进程退出的情况下，发起了<code>离开消费者组</code>的请求，使得 kafka 能快速响应消费者组最新状态，从而更好平滑重新加入消费者</li>
</ul>
<a id="more"></a>

<h2 id="服务架构"><a href="#服务架构" class="headerlink" title="服务架构"></a>服务架构</h2><p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/kafka-swoole.jpg" alt="kafka-swoole架构图"></p>
<p>kafka-swoole 的大体架构图如上，可以笼统的概括为 2 个部分组成，分别的 <code>kafka-client</code> 和<code>consumer/sinker</code>。</p>
<p><code>kafka-client</code>主要是负责从 kafka 服务中拉取数据，<code>consumer/sinker</code>主要负责消费数据。</p>
<p><code>consumer</code>和<code>sinker</code> 的区别在于，数据是否经过了<code>中间存储介质</code>，如果不经过<code>中间存储介质</code>的话，那么就是<code>consumer</code>，就是我们接下来会在配置说到的<code>KAFKA_MESSAGE_STORAGE=Directly</code>，这也将会是我们是否启用额外的 <code>sinker</code> 进程的<code>关键所在</code>，如果它被选择之后，client 和消费者将会在同一个进程中处理，所以如果你的业务逻辑比较耗时的话，势必会影响数据拉取速度。如果采用<code>中间存储介质</code>的话，那么目前支持 2 种存储介质，分别是<code>Redis</code>,<code>File</code>。目前来说更加推荐采用<code>Redis</code>的方式，虽然借助了第三方服务，但是它在其他各个方面都比 File 好，就举一个例子来说，如果用 File 作为存储介质的话，File 的话还需要自己做磁盘备份来保证数据不会丢失。</p>
<h2 id="runtime-的-rpc-命令的实现细节"><a href="#runtime-的-rpc-命令的实现细节" class="headerlink" title="runtime 的 rpc 命令的实现细节"></a>runtime 的 rpc 命令的实现细节</h2><p>本项目中，所谓的 rpc 的命名，主要是由主进程想 kafka-client 进程发起 rpc 请求的行为。用于获取 kakfa-client 实时状况而存在的一种方式，所以，这里我们需要实现进程间的通信，这里的选型，我们选择选择了<code>AF_UNIX</code>的方式来进行通信，而没有使用端口服务的方式，是因为，我们的 rpc 请求不对外提供服务，并且是针对本项目，并且<code>AF_UNIX</code>也让我们通信更加高效。</p>
<p>由于我们这里需要实现三方通信，所有发起请求的命令独占一个<code>UNIX_FILE</code>，我们主进程占一个<code>UNIX_FILE</code>，每个 kafka-client 同样占一个<code>UNIX_FILE</code>，实现三方通信。</p>
<h3 id="rpc-协议"><a href="#rpc-协议" class="headerlink" title="rpc 协议"></a>rpc 协议</h3><p>协议本身十分简单，协议头有 4 个字节的无符号整形封包协议主体的长度，协议主体是由<code>role</code>,<code>rpc</code>,<code>method</code>一起组成的 json_encode 后的字符串。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$cmd = [</span><br><span class="line">          <span class="string">'role'</span>   =&gt; $external,</span><br><span class="line">          <span class="string">'rpc'</span>    =&gt; $rpc,</span><br><span class="line">          <span class="string">'method'</span> =&gt; $method,</span><br><span class="line">      ];</span><br><span class="line">$data = json_encode($cmd);</span><br><span class="line">$package = pack(<span class="string">'N'</span>, strlen($data)) . $data;</span><br></pre></td></tr></table></figure>

<h3 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h3><p>在 core 项目 <code>src/RPC</code>中，是我们的所有的 RPC 服务处理类，类有 2 种类型的方法，分别是<code>getXxx</code>和<code>onXxx</code>，它们的区别在于</p>
<p><code>getXxx</code>：各个 kafka-client 进程处理该 RPC 请求处理的逻辑</p>
<p><code>onXxx</code>：负责主进程节奏各个 kafka-client 进程处理后的结果，进行汇总处理</p>
<h2 id="sinker-相关的内容"><a href="#sinker-相关的内容" class="headerlink" title="sinker 相关的内容"></a>sinker 相关的内容</h2><p>当我们使用<code>kafka-swoole</code>项目的时候，要如何使用呢，其实业务方并不需要过多的关注 kafka-client 的细节，因为它的作用仅仅是拉取数据到<code>存储介质</code>，我们写业务的时候，其实主要都是在<code>sinker</code>中写业务。</p>
<p>我们在 <code>app/Controller</code>中有一个<code>SinkerController</code>，里面的<code>hanlder(array $messages)</code>就是接收从存储介质中读取回来的数据，但是这里需要注意的是，从存储介质中拉取出来的时候是否被消费这个问题，这里不管是<code>Redis</code>还是<code>File</code>，都没有自带的一个<code>ack</code>机制让我们保证数据正确被消费了。但是，我们迂回得实现了这个方式，利用的就是 redis 的可靠性队列。</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/Redis%E5%AD%98%E5%82%A8%E4%BB%8B%E8%B4%A8%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="kafka-swoole-redis的存储介质关系图"></p>
<p>通过上图所示的方式，我们的 ack 机制通过业务方来确认，所以，该方法的返回结果为一个数组，数组下标对应每条消息的状态，当状态为<code>true</code>的时候代表被顺利消费了，消息会在 <code>processing</code>的队列中被移除，如果被标记为了<code>false</code>，那么消息将不会被移除，对于失败的消息，目前我们并没有做任何的处理，因为对于部分消息，可能是重试的情况，部分消息，可能是真的错误的情况。因此这部分消息如果重新消费的话，需要业务方确认，并且通过命令来把数据拉回到<code>pending</code>队列中来实现重新消费的情况。如果是错误的话，就需要通过命令来清空队列。</p>
<h2 id="kafka-相关的命令的提供"><a href="#kafka-相关的命令的提供" class="headerlink" title="kafka 相关的命令的提供"></a>kafka 相关的命令的提供</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">php bin/kafka-client</span><br><span class="line">Console Tool</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  <span class="built_in">command</span> [options] [arguments]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --<span class="built_in">help</span>            Display this <span class="built_in">help</span> message</span><br><span class="line">  -q, --quiet           Do not output any message</span><br><span class="line">  -V, --version         Display this application version</span><br><span class="line">      --ansi            Force ANSI output</span><br><span class="line">      --no-ansi         Disable ANSI output</span><br><span class="line">  -n, --no-interaction  Do not ask any interactive question</span><br><span class="line">  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 <span class="keyword">for</span> normal output, 2 <span class="keyword">for</span> more verbose output and 3 <span class="keyword">for</span> debug</span><br><span class="line"></span><br><span class="line">Available commands:</span><br><span class="line">  <span class="built_in">help</span>                  Displays <span class="built_in">help</span> <span class="keyword">for</span> a <span class="built_in">command</span></span><br><span class="line">  kafka.describeGroups  See consumer group details</span><br><span class="line">  kafka.produce         Send a message</span><br><span class="line">  list                  Lists commands</span><br><span class="line">  rpc                   Built-in runtime RPC <span class="built_in">command</span></span><br><span class="line">  start                 Start Kafka-Swoole</span><br></pre></td></tr></table></figure>

<p>带有 kafka 前缀的命令，都是直接请求 kafka 相关的 API 的命令。</p>
<h3 id="kafka-describeGroups"><a href="#kafka-describeGroups" class="headerlink" title="kafka.describeGroups"></a>kafka.describeGroups</h3><p>用于查询某个消费者组订阅的 topic 的详情</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">php bin/kafka-client kafka.describeGroups -h</span><br><span class="line">Description:</span><br><span class="line">  See consumer group details</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  kafka.describeGroups [options]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -t, --topic=TOPIC     Which topic is subscribed by the consumer group?</span><br><span class="line">  -g, --group=GROUP     Which consumer group?</span><br><span class="line">  -h, --<span class="built_in">help</span>            Display this <span class="built_in">help</span> message</span><br><span class="line">  -q, --quiet           Do not output any message</span><br><span class="line">  -V, --version         Display this application version</span><br><span class="line">      --ansi            Force ANSI output</span><br><span class="line">      --no-ansi         Disable ANSI output</span><br><span class="line">  -n, --no-interaction  Do not ask any interactive question</span><br><span class="line">  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 <span class="keyword">for</span> normal output, 2 <span class="keyword">for</span> more verbose output and 3 <span class="keyword">for</span> debug</span><br><span class="line"></span><br><span class="line">Help:</span><br><span class="line">  See consumer group details...</span><br></pre></td></tr></table></figure>

<p>例子如下图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">php bin/kafka-client kafka.describeGroups -t mulog_clean_24 -g kafka-swoole</span><br><span class="line"></span><br><span class="line">DescribeGruops-BaseInfo</span><br><span class="line">=======================</span><br><span class="line"></span><br><span class="line"> -------------- ------------ -------------- --------------</span><br><span class="line">  groupId        groupState   protocolType   protocolData</span><br><span class="line"> -------------- ------------ -------------- --------------</span><br><span class="line">  kafka-swoole   Stable       consumer       Range</span><br><span class="line"> -------------- ------------ -------------- --------------</span><br><span class="line"></span><br><span class="line"> --------------------------------------------------- -------------- -------------- ---------------- -----------</span><br><span class="line">  memberId                                            clientId       clientHost     topcic           paritions</span><br><span class="line"> --------------------------------------------------- -------------- -------------- ---------------- -----------</span><br><span class="line">  kafka-swoole-44857c49-b019-439b-90dd-d71112b2c01e   kafka-swoole   /192.167.8.2   mulog_clean_24   0,1</span><br><span class="line"> --------------------------------------------------- -------------- -------------- ---------------- -----------</span><br><span class="line"></span><br><span class="line"> --------------------------------------------------- -------------- -------------- ---------------- -----------</span><br><span class="line">  memberId                                            clientId       clientHost     topcic           paritions</span><br><span class="line"> --------------------------------------------------- -------------- -------------- ---------------- -----------</span><br><span class="line">  kafka-swoole-5714cd77-a0dd-4d29-aa20-718f9d713908   kafka-swoole   /192.167.8.2   mulog_clean_24   2,3</span><br><span class="line"> --------------------------------------------------- -------------- -------------- ---------------- -----------</span><br></pre></td></tr></table></figure>

<h3 id="kafka-produce"><a href="#kafka-produce" class="headerlink" title="kafka.produce"></a>kafka.produce</h3><p>用于生产一条消息到某个 topic 中，支持多种压缩方式，支持多种生产消息策略</p>
<p>生产者 partition 策略：</p>
<ul>
<li><code>-p/--partition=</code> 采用指定 partition 的策略</li>
<li><code>-k/--key=</code> 采用通过 key 的哈希到 partition 策略</li>
<li>以上两个都不选，则采用 随机发送 partition 策略</li>
</ul>
<p>生产者压缩方式：</p>
<ul>
<li><code>-c/--compress=</code> 采用的压缩方式：0=不压缩/1=采用 gzip 压缩/2=使用 snappy 压缩/3=使用 lz4 压缩</li>
<li>不填写，则不进行压缩</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">php bin/kafka-client kafka.produce --<span class="built_in">help</span></span><br><span class="line">Description:</span><br><span class="line">  Send a message</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  kafka.produce [options] [--] &lt;message&gt;</span><br><span class="line"></span><br><span class="line">Arguments:</span><br><span class="line">  message                      The message you wish to send.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -t, --topic[=TOPIC]          Which is the topic you want to send?</span><br><span class="line">  -p, --partition[=PARTITION]  Which is the topic you want to send to partition?</span><br><span class="line">  -k, --key[=KEY]              Which is the topic you want to send to partition by key?</span><br><span class="line">  -c, --compress[=COMPRESS]    Which one <span class="keyword">do</span> you want to compress: 0: normal 1:gzip 2:snappy 3:lz4</span><br><span class="line">  -h, --<span class="built_in">help</span>                   Display this <span class="built_in">help</span> message</span><br><span class="line">  -q, --quiet                  Do not output any message</span><br><span class="line">  -V, --version                Display this application version</span><br><span class="line">      --ansi                   Force ANSI output</span><br><span class="line">      --no-ansi                Disable ANSI output</span><br><span class="line">  -n, --no-interaction         Do not ask any interactive question</span><br><span class="line">  -v|vv|vvv, --verbose         Increase the verbosity of messages: 1 <span class="keyword">for</span> normal output, 2 <span class="keyword">for</span> more verbose output and 3 <span class="keyword">for</span> debug</span><br><span class="line"></span><br><span class="line">Help:</span><br><span class="line">  This <span class="built_in">command</span> will <span class="built_in">help</span> you send separate messages to a topic...</span><br></pre></td></tr></table></figure>

<p>例子如下图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">php bin/kafka-client kafka.produce -t test_topic_A -- <span class="string">'This is my test'</span></span><br><span class="line">array(3) &#123;</span><br><span class="line">  [<span class="string">"responses"</span>]=&gt;</span><br><span class="line">  array(1) &#123;</span><br><span class="line">    [0]=&gt;</span><br><span class="line">    array(2) &#123;</span><br><span class="line">      [<span class="string">"topic"</span>]=&gt;</span><br><span class="line">      string(12) <span class="string">"test_topic_A"</span></span><br><span class="line">      [<span class="string">"partition_responses"</span>]=&gt;</span><br><span class="line">      array(1) &#123;</span><br><span class="line">        [0]=&gt;</span><br><span class="line">        array(3) &#123;</span><br><span class="line">          [<span class="string">"partition"</span>]=&gt;</span><br><span class="line">          int(0)</span><br><span class="line">          [<span class="string">"errorCode"</span>]=&gt;</span><br><span class="line">          int(0)</span><br><span class="line">          [<span class="string">"baseOffset"</span>]=&gt;</span><br><span class="line">          int(0)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  [<span class="string">"responseHeader"</span>]=&gt;</span><br><span class="line">  array(1) &#123;</span><br><span class="line">    [<span class="string">"correlationId"</span>]=&gt;</span><br><span class="line">    int(0)</span><br><span class="line">  &#125;</span><br><span class="line">  [<span class="string">"size"</span>]=&gt;</span><br><span class="line">  int(40)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>目前输出方式并没有优化，后续进行输出样式优化</p>
<h3 id="rpc"><a href="#rpc" class="headerlink" title="rpc"></a>rpc</h3><p>提供实时获取 kafka-client 成员的内部情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">php bin/kafka-client rpc -h</span><br><span class="line">Description:</span><br><span class="line">  Built-in runtime RPC <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  rpc &lt;<span class="built_in">type</span>&gt;</span><br><span class="line"></span><br><span class="line">Arguments:</span><br><span class="line">  <span class="built_in">type</span>                  <span class="built_in">which</span> you want to execute <span class="built_in">command</span>?</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --<span class="built_in">help</span>            Display this <span class="built_in">help</span> message</span><br><span class="line">  -q, --quiet           Do not output any message</span><br><span class="line">  -V, --version         Display this application version</span><br><span class="line">      --ansi            Force ANSI output</span><br><span class="line">      --no-ansi         Disable ANSI output</span><br><span class="line">  -n, --no-interaction  Do not ask any interactive question</span><br><span class="line">  -v|vv|vvv, --verbose  Increase the verbosity of messages: 1 <span class="keyword">for</span> normal output, 2 <span class="keyword">for</span> more verbose output and 3 <span class="keyword">for</span> debug</span><br><span class="line"></span><br><span class="line">Help:</span><br><span class="line">  The following are the built-in RPC <span class="built_in">command</span> options：</span><br><span class="line">  kafka_lag</span><br><span class="line">  offset_checker</span><br><span class="line">  block_size</span><br><span class="line">  member_leader</span><br><span class="line">  metadata_brokers</span><br><span class="line">  metadata_topics</span><br></pre></td></tr></table></figure>

<p>例子如下图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">php bin/kafka-client rpc kafka_lag</span><br><span class="line">1000</span><br><span class="line"></span><br><span class="line">php bin/kafka-client rpc offset_checker</span><br><span class="line"> -------------- ----------- ---------------- ------------------ -----------------</span><br><span class="line">  topic          partition   current-offset   kafka-max-offset   remaining-count</span><br><span class="line"> -------------- ----------- ---------------- ------------------ -----------------</span><br><span class="line">  kafka-swoole   2           50223            50223              0</span><br><span class="line">  kafka-swoole   3           70353            70353              0</span><br><span class="line">  kafka-swoole   0           52395            52395              0</span><br><span class="line">  kafka-swoole   1           50407            50407              0</span><br><span class="line"> -------------- ----------- ---------------- ------------------ -----------------</span><br><span class="line"></span><br><span class="line">php bin/kafka-client rpc block_size</span><br><span class="line">254</span><br><span class="line"></span><br><span class="line">php bin/kafka-client rpc member_leader</span><br><span class="line"> ---------------------------------------------------</span><br><span class="line">  consumer-group-leaderId</span><br><span class="line"> ---------------------------------------------------</span><br><span class="line">  kafka-swoole-da43c9a0-b12d-46df-9941-ee80456ec9a2</span><br><span class="line"> ---------------------------------------------------</span><br><span class="line"></span><br><span class="line"> ---------------------------------------------------</span><br><span class="line">  consumer-group-membersId</span><br><span class="line"> ---------------------------------------------------</span><br><span class="line">  kafka-swoole-6080eb8e-3bfb-4be0-a923-037bb99a2666</span><br><span class="line">  kafka-swoole-da43c9a0-b12d-46df-9941-ee80456ec9a2</span><br><span class="line"> ---------------------------------------------------</span><br><span class="line"></span><br><span class="line"> php bin/kafka-client rpc metadata_brokers</span><br><span class="line"> --------- --------- ------</span><br><span class="line">  node-id   host      port</span><br><span class="line"> --------- --------- ------</span><br><span class="line">  1003      mkafka3   9092</span><br><span class="line">  1004      mkafka4   9092</span><br><span class="line">  1001      mkafka1   9092</span><br><span class="line">  1002      mkafka2   9092</span><br><span class="line"> --------- --------- ------</span><br><span class="line"></span><br><span class="line"> php bin/kafka-client rpc metadata_topics</span><br><span class="line"> -------------- ----------- ----------- --------------- -----------</span><br><span class="line">  topic          partition   leader-id   replica-nodes   isr-nodes</span><br><span class="line"> -------------- ----------- ----------- --------------- -----------</span><br><span class="line">  kafka-swoole   2           1001        1001,1004       1001,1004</span><br><span class="line">  kafka-swoole   1           1004        1004,1003       1004,1003</span><br><span class="line">  kafka-swoole   3           1002        1002,1001       1002,1001</span><br><span class="line">  kafka-swoole   0           1003        1003,1002       1002,1003</span><br><span class="line"> -------------- ----------- ----------- --------------- -----------</span><br></pre></td></tr></table></figure>

<h2 id="kafka-客户端启动到拉取数据流程"><a href="#kafka-客户端启动到拉取数据流程" class="headerlink" title="kafka 客户端启动到拉取数据流程"></a>kafka 客户端启动到拉取数据流程</h2><p>以下列出所有的必备请求，到<code>Fetch</code>请求位置，都是同步请求，<code>OffsetCommit</code>和<code>HeartBeat</code>都是分开的独立请求</p>
<ul>
<li>Metadata 获取元数据信息</li>
<li>FindCoordinator 让 kafka 分配消费者组协调器入口</li>
<li>JoinGroup 告诉 kafka 当前 kafka-client 需要加入消费者组</li>
<li>SyncGroup 同步消费者组消息（如果发起请求的是 leader 的话，则需要带上所有消费者组成员所需要订阅 topic 和 partition 的信息，所以由 leader 分配）</li>
<li>ListsOffsets 获取当前 topic 在 kafka/zookeeper 中存储的 offset 的最大值和最小值</li>
<li>OffsetFetch 获取当前消费者组在 kafka/zookeeper 中存储的 offset 的值</li>
<li>Fetch 拉取数据</li>
<li>OffsetCommit 提交当前消费者组处理到的 offset</li>
<li>HeartBeat  心跳请求</li>
</ul>
<h3 id="Rebalance-流程"><a href="#Rebalance-流程" class="headerlink" title="Rebalance 流程"></a>Rebalance 流程</h3><h4 id="发送加入组请求（Rebalance-流程）"><a href="#发送加入组请求（Rebalance-流程）" class="headerlink" title="发送加入组请求（Rebalance 流程）"></a>发送加入组请求（Rebalance 流程）</h4><p>消费者首次加入 group 也可以认为是 Rebalance 的一种，其中包含了两类请求：JoinGroup 和 SyncGroup 请求。我们先看一下两次请求的流程：</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/Rebalance-JoinGroup.jpg" alt="Rebalance-JoinGroup"></p>
<p>当组内成员加入 group 时，它会向协调者发送一个 JoinGroup 请求。请求中会将自己要订阅的 Topic 上报，这样协调者就可以收集到所有成员的订阅信息。收集完订阅信息之后，通常情况下，第一个发送 JoinGroup 请求的成员将会自动称为 Leader。所有后棉其他成员加入的时候，就发生了 Rebalance 的情况了。</p>
<h4 id="新成员入组"><a href="#新成员入组" class="headerlink" title="新成员入组"></a>新成员入组</h4><p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/Rebalance-JoinGroup-2.jpg" alt="Rebalance-JoinGroup-2"></p>
<h4 id="组成员主动离组"><a href="#组成员主动离组" class="headerlink" title="组成员主动离组"></a>组成员主动离组</h4><p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/Rebalance-LeaveGroup.jpg" alt="Rebalance-LeaveGroup"></p>
<h4 id="组成员崩溃离组"><a href="#组成员崩溃离组" class="headerlink" title="组成员崩溃离组"></a>组成员崩溃离组</h4><p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/Rebalance-LeaveGroup-2.jpg" alt="Rebalance-LeaveGroup-2"></p>
<h4 id="Rebalance-时组内成员需要提交-offset"><a href="#Rebalance-时组内成员需要提交-offset" class="headerlink" title="Rebalance 时组内成员需要提交 offset"></a>Rebalance 时组内成员需要提交 offset</h4><p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/Rebalance-commitoffset.jpg" alt="Rebalance-commitoffset"></p>
<h3 id="Consumer-分区分配策略"><a href="#Consumer-分区分配策略" class="headerlink" title="Consumer 分区分配策略"></a>Consumer 分区分配策略</h3><h4 id="RangeAssignor"><a href="#RangeAssignor" class="headerlink" title="RangeAssignor"></a>RangeAssignor</h4><p>RangeAssignor 是按照 Topic 的维度进行分配的，也就是说按照 Topic 对应的每个分区平均的按照范围区段分配给 Consumer 实例。这种分配方案是按照 Topic 的维度去分发分区的，此时可能会造成先分配分区的 Consumer 实例的任务过重。</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/RangeAssignor.jpg" alt="RangeAssignor"></p>
<p>从上图的最终分配结果看来，因为是按照 Topic A 和 Topic B 的维度进行分配的。对于 Topic A 而言，有 2 个消费者，此时算出来 C0 得到 2 个分区，C1 得到 1 个分区；对于 Topic B 的维度也是一样，也就是先分配的 Consumer 会得到的更多，从而造成倾斜。需要注意一点的是，RangeAssignor 是按照范围截断分配的，不是按顺序分发的。</p>
<h4 id="RoundRobinAssignor"><a href="#RoundRobinAssignor" class="headerlink" title="RoundRobinAssignor"></a>RoundRobinAssignor</h4><p>RoundRobinAssignor 中文可以翻译为轮询，也就是顺序一个一个的分发。其中代码里面的大概逻辑如下：拿到组内所有 Consumer 订阅的 TopicPartition，按照顺序挨个分发给 Consumer，此时如果和当前 Consumer 没有订阅关系，则寻找下一个 Consumer。从上面逻辑可以看出，如果组内每个消费者的订阅关系是同样的，这样 TopicPartition 的分配是均匀的。</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/RoundRobinAssignor.jpg" alt="RoundRobinAssignor"></p>
<p>当组内每个消费者订阅的 Topic 是不同的，这样就可能会造成分区订阅的倾斜。</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/RoundRobinAssignor-2.jpg" alt="RoundRobinAssignor-2"></p>
<h4 id="StickyAssignor"><a href="#StickyAssignor" class="headerlink" title="StickyAssignor"></a>StickyAssignor</h4><p>StickyAssignor 是 Kafka Java 客户端提供的 3 中分配策略中最复杂的一种，从字面上可以看出是具有“粘性”的分区策略。Kafka 从 0.11 版本开始引入，其主要实现了两个功能：</p>
<p>1、主题分区的分配要尽可能的均匀。</p>
<p>2、当 Rebalance 发生时，尽可能保持上一次的分配方案。</p>
<p>当然，当上面两个条件发生冲突是，第一个提交件要优先于第二个提交，这样可以使分配更加均匀。下面我们看一下官方提供的 2 个例子，来看一下 RoundRoubin 和 Sticky 两者的区别。</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/StickyAssignor.jpg" alt="StickyAssignor"></p>
<p>从上面我们可以看出，初始状态各个 Consumer 订阅是相同的时候，并且主题的分区数也是平均的时候，两种分配方案的结果是相同的。但是当 Rebalance 发生时，可能就会不太相同了，加入上面的 C1 发生了离组操作，此时分别会有下面的 Rebalance 结果：</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/StickyAssignor-2.jpg" alt="StickyAssignor-2"></p>
<p>从上面 Rebalance 后的结果可以看出，虽然两者最后分配都是均匀的，但是 RoundRoubin 完全是重新分配了一遍，而 Sticky 则是在原先的基础上达到了均匀的状态。</p>
<p>下面我们再看一个 Consumer 订阅主题不均匀的例子。</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/StickyAssignor-3.jpg" alt="StickyAssignor-3"></p>
<p>从上面的订阅关系可以看出，Consumer 的订阅主题个数不均匀，并且各个主题的分区数也是不相同的。此时两种分配方案的结果有了较大的差异，但是相对来说 Sticky 方式的分配相对来说是最合理的。下面我们看一下 C1 发生离组时，Rebalance 之后的分配结果。</p>
<p><img src="/images/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/StickyAssignor-4.jpg" alt="StickyAssignor-4"></p>
<p>从上面结果可以看出，RoundRoubin 的方案在 Rebalance 之后造成了严重的分配倾斜。因此在生产上如果想要减少 Rebalance 的开销，可以选用 Sticky 的分区分配策略。</p>
<h2 id="协议封装细节规则"><a href="#协议封装细节规则" class="headerlink" title="协议封装细节规则"></a>协议封装细节规则</h2><p>官方协议说明链接：<a href="http://kafka.apache.org/protocol.html" target="_blank" rel="noopener">Apache-kafka-protocol</a><br>非官方协议说明链接：<a href="https://www.iteblog.com/archives/2217.html" target="_blank" rel="noopener">非官方协议说明</a></p>
<p>项目中协议的封装在我们的 core 项目中的<code>src/Protocol</code>里面。整个树形图如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">rpc/Protocol</span><br><span class="line">├── AbstractRequest.php</span><br><span class="line">├── AbstractRequestOrResponse.php</span><br><span class="line">├── AbstractResponse.php</span><br><span class="line">├── CommonRequest.php</span><br><span class="line">├── CommonResponse.php</span><br><span class="line">├── Request</span><br><span class="line">│   ├── Common</span><br><span class="line">│   │   └── RequestHeader.php</span><br><span class="line">│   ├── CreateTopics</span><br><span class="line">│   │   ├── AssignmentsCreateTopics.php</span><br><span class="line">│   │   ├── ConfigsCreateTopics.php</span><br><span class="line">│   │   └── TopicsCreateTopics.php</span><br><span class="line">│   ├── CreateTopicsRequest.php</span><br><span class="line">│   ├── DescribeGroupsRequest.php</span><br><span class="line">│   ├── Fetch</span><br><span class="line">│   │   ├── PartitionsFetch.php</span><br><span class="line">│   │   └── TopicsFetch.php</span><br><span class="line">│   ├── FetchRequest.php</span><br><span class="line">│   ├── FindCoordinatorRequest.php</span><br><span class="line">│   ├── HeartbeatRequest.php</span><br><span class="line">│   ├── JoinGroup</span><br><span class="line">│   │   ├── ProtocolMetadataJoinGroup.php</span><br><span class="line">│   │   ├── ProtocolNameJoinGroup.php</span><br><span class="line">│   │   ├── ProtocolsJoinGroup.php</span><br><span class="line">│   │   └── TopicJoinGroup.php</span><br><span class="line">│   ├── JoinGroupRequest.php</span><br><span class="line">│   ├── LeaveGroupRequest.php</span><br><span class="line">│   ├── ListOffsets</span><br><span class="line">│   │   ├── PartitionsListsOffsets.php</span><br><span class="line">│   │   └── TopicsListsOffsets.php</span><br><span class="line">│   ├── ListOffsetsRequest.php</span><br><span class="line">│   ├── Metadata</span><br><span class="line">│   │   └── TopicMetadata.php</span><br><span class="line">│   ├── MetadataRequest.php</span><br><span class="line">│   ├── OffsetCommit</span><br><span class="line">│   │   ├── PartitionsOffsetCommit.php</span><br><span class="line">│   │   └── TopicsOffsetCommit.php</span><br><span class="line">│   ├── OffsetCommitRequest.php</span><br><span class="line">│   ├── OffsetFetch</span><br><span class="line">│   │   ├── PartitionsOffsetFetch.php</span><br><span class="line">│   │   └── TopicsOffsetFetch.php</span><br><span class="line">│   ├── OffsetFetchRequest.php</span><br><span class="line">│   ├── Produce</span><br><span class="line">│   │   ├── DataProduce.php</span><br><span class="line">│   │   ├── MessageProduce.php</span><br><span class="line">│   │   ├── MessageSetProduce.php</span><br><span class="line">│   │   └── TopicDataProduce.php</span><br><span class="line">│   ├── ProduceRequest.php</span><br><span class="line">│   ├── SyncGroup</span><br><span class="line">│   │   ├── AssignmentsSyncGroup.php</span><br><span class="line">│   │   ├── GroupAssignmentsSyncGroup.php</span><br><span class="line">│   │   ├── MemberAssignmentsSyncGroup.php</span><br><span class="line">│   │   └── PartitionAssignmentsSyncGroup.php</span><br><span class="line">│   └── SyncGroupRequest.php</span><br><span class="line">├── Response</span><br><span class="line">│   ├── Common</span><br><span class="line">│   │   └── ResponseHeader.php</span><br><span class="line">│   ├── CreateTopics</span><br><span class="line">│   │   └── TopicsCreateTopics.php</span><br><span class="line">│   ├── CreateTopicsResponse.php</span><br><span class="line">│   ├── DescribeGroups</span><br><span class="line">│   │   ├── GroupsDescribeGroups.php</span><br><span class="line">│   │   ├── MembersAssignmentDescribeGroups.php</span><br><span class="line">│   │   ├── MembersDescribeGroups.php</span><br><span class="line">│   │   ├── MembersMetadataDescribeGroups.php</span><br><span class="line">│   │   └── PartitionsAssignmentDescribeGroups.php</span><br><span class="line">│   ├── DescribeGroupsResponse.php</span><br><span class="line">│   ├── Fetch</span><br><span class="line">│   │   ├── MessageFetch.php</span><br><span class="line">│   │   ├── MessageSetFetch.php</span><br><span class="line">│   │   ├── PartitionHeaderFetch.php</span><br><span class="line">│   │   ├── PartitionResponsesFetch.php</span><br><span class="line">│   │   └── ResponsesFetch.php</span><br><span class="line">│   ├── FetchResponse.php</span><br><span class="line">│   ├── FindCoordinatorResponse.php</span><br><span class="line">│   ├── HeartbeatResponse.php</span><br><span class="line">│   ├── JoinGroup</span><br><span class="line">│   │   ├── MembersJoinGroup.php</span><br><span class="line">│   │   ├── ProtocolMetadataJoinGroup.php</span><br><span class="line">│   │   └── TopicJoinGroup.php</span><br><span class="line">│   ├── JoinGroupResponse.php</span><br><span class="line">│   ├── LeaveGroupResponse.php</span><br><span class="line">│   ├── ListOffsets</span><br><span class="line">│   │   ├── PartitionsResponsesListOffsets.php</span><br><span class="line">│   │   └── ResponsesListOffsets.php</span><br><span class="line">│   ├── ListOffsetsResponse.php</span><br><span class="line">│   ├── Metadata</span><br><span class="line">│   │   ├── BrokerMetadata.php</span><br><span class="line">│   │   ├── PartitionMetadata.php</span><br><span class="line">│   │   └── TopicMetadata.php</span><br><span class="line">│   ├── MetadataResponse.php</span><br><span class="line">│   ├── OffsetCommit</span><br><span class="line">│   │   ├── PartitionsOffsetCommit.php</span><br><span class="line">│   │   └── TopicOffsetCommit.php</span><br><span class="line">│   ├── OffsetCommitResponse.php</span><br><span class="line">│   ├── OffsetFetch</span><br><span class="line">│   │   ├── PartitionsResponsesOffsetFetch.php</span><br><span class="line">│   │   └── ResponsesOffsetFetch.php</span><br><span class="line">│   ├── OffsetFetchResponse.php</span><br><span class="line">│   ├── Produce</span><br><span class="line">│   │   ├── PartitionResponsesProduce.php</span><br><span class="line">│   │   └── ResponsesProduce.php</span><br><span class="line">│   ├── ProduceResponse.php</span><br><span class="line">│   ├── SyncGroup</span><br><span class="line">│   │   ├── MemberAssignmentsSyncGroup.php</span><br><span class="line">│   │   └── PartitionAssignmentsSyncGroup.php</span><br><span class="line">│   └── SyncGroupResponse.php</span><br><span class="line">├── TraitStructure</span><br><span class="line">│   ├── ToArrayTrait.php</span><br><span class="line">│   └── ValueTrait.php</span><br><span class="line">└── Type</span><br><span class="line">    ├── AbstractType.php</span><br><span class="line">    ├── Arrays32.php</span><br><span class="line">    ├── Bytes32.php</span><br><span class="line">    ├── Int16.php</span><br><span class="line">    ├── Int32.php</span><br><span class="line">    ├── Int64.php</span><br><span class="line">    ├── Int8.php</span><br><span class="line">    └── String16.php</span><br></pre></td></tr></table></figure>

<p>我们先说明一下以此目录为根目录到情况下，一级文件（非目录）的作用：</p>
<ul>
<li>AbstractRequestOrResponse.php (这个是无论是 request 还是 response 都必须有都字段：字节长度)</li>
<li>AbstractRequest.php (继承 AbstractRequestOrResponse，包含了请求协议头，封包核心逻辑)</li>
<li>AbstractResponse.php （继承 AbstractRequestOrResponse，包含了响应协议头，解包核心逻辑）</li>
<li>CommonRequest.php （继承 AbstractRequest，用于辅助封装协议中特殊的字段处理方式）</li>
<li>CommonResponse.php（继承 AbstractResponse，用于辅助解开协议中特殊的字段处理方式）</li>
</ul>
<h3 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h3><p>在这个目录中，全部都是数据类型，我们整个协议的所有字段的定义都来自于此目录的数据类型，目前用到的数据类型有</p>
<ul>
<li>Arrays32 (数组类型，占 32bits，PHP 中的标记为：N)</li>
<li>Bytes32 (字节类型，占 32bits，PHP 中的标记为：N)</li>
<li>String16 (字符串类型，占 16bits，PHP 中的标记为：n)</li>
<li>Int8 (整型类型，占 8bits，PHP 中的标记为：C)</li>
<li>Int16 (整型类型，占 16bits，PHP 中的标记为：n)</li>
<li>Int32 (整型类型，占 32bits，PHP 中的标记为：N)</li>
<li>Int64 (整型类型，占 64bits，PHP 中的标记为：N2)</li>
</ul>
<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><p>在这个目录中，全部都是请求协议体的内容，以此为根目录下的一级文件（非目录），都是对应的每一个 API 协议，它们全部都继承<code>AbstractRequest</code>类，并且属性必须为<code>private</code>修饰符，更重要的是，不要忘记了写上关键信息，就是这个<code>属性的数据类型的注解(@var Xxx $ooo)</code>，这将会我们封包关键所在，这个数据类型，都来自于<code>Type目录</code>。而根目录下的二级目录则是对应的协议结构中的子结构，规则和之前描述的大体一致，需要注意的是，这个时候子结构并没有继承了任何父类。</p>
<p>其中每个类中可能存在<code>onXxx</code>的方法，这个时候<code>AbstractRequest</code>并不会正常的解析这个类中的字段，而是去执行每个类中特定的回调方法，进行定制封包。</p>
<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p>在这个目录中，全部都是请求协议体的内容，以此为根目录下的一级文件（非目录），都是对应的每一个 API 协议，它们全部都继承<code>AbstractResponse</code>类，并且属性必须为<code>private</code>修饰符，更重要的是，不要忘记了写上关键信息，就是这个<code>属性的数据类型的注解(@var Xxx $ooo)</code>，这将会我们封包关键所在，这个数据类型，都来自于<code>Type目录</code>。而根目录下的二级目录则是对应的协议结构中的子结构，规则和之前描述的大体一致，需要注意的是，这个时候子结构并没有继承了任何父类。</p>
<p>其中每个类中可能存在<code>onXxx</code>的方法，这个时候<code>AbstractRespose</code>并不会正常的解析这个类中的字段，先执行回调方法，进行定制解包。通过返回 true 或者返回 false 来判断是否需要继续正常解析这个字段，如果返回 true 则是跳过这个字段不再解析，说明了这个字段在<code>onXxx</code>中可以解析完毕了。否则将继续解析这个字段。</p>
<h3 id="TraitStructure"><a href="#TraitStructure" class="headerlink" title="TraitStructure"></a>TraitStructure</h3><p>在这个目录中，都是一些复用体（trait），目前来说用上的只有<code>ToArrayTrait</code>，这个结构体主要的职责是把对象返回成数组结构。</p>
<h2 id="压缩方式详解"><a href="#压缩方式详解" class="headerlink" title="压缩方式详解"></a>压缩方式详解</h2><p>经过我对上文中提到对 2 个最多 star 的仓库的考察，发现这 2 个仓库要么是压缩方式不支持，要么就是协议方式封装错误。</p>
<p>所以，在这里可以很对压缩方式做一些说明。</p>
<p>正常情况下，我们的数据是可以不压缩的，但是，当我们的生产者在决定用压缩数据的方式来传输数据的时候，就代表你这的消费端就必须支持对应的解压方式。</p>
<p>在压缩的情况下，我们的数据量可以被压缩存储在 kafka 中，不但可以节约服务器的磁盘空间，而且还减少了带宽的占用，提高了传输速率。所以在生产者和消费者的机器 CPU 有条件的情况下，最好还是对数据进行压缩传输。</p>
<p>由于我们目前只对 VERSION=0 的协议进行封装，所以用此来说明。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MessageSet (Version: 0) &#x3D;&gt; [offset message_size message]</span><br><span class="line">    offset &#x3D;&gt; INT64</span><br><span class="line">    message_size &#x3D;&gt; INT32</span><br><span class="line">    message &#x3D;&gt; crc magic_byte attributes key value</span><br><span class="line">        crc &#x3D;&gt; INT32</span><br><span class="line">        magic_byte &#x3D;&gt; INT8</span><br><span class="line">        attributes &#x3D;&gt; INT8</span><br><span class="line">            bit 0~2:</span><br><span class="line">                0: no compression</span><br><span class="line">                1: gzip</span><br><span class="line">                2: snappy</span><br><span class="line">            bit 3~7: unused</span><br><span class="line">        key &#x3D;&gt; BYTES</span><br><span class="line">        value &#x3D;&gt; BYTES</span><br></pre></td></tr></table></figure>

<p>我们看到这个协议说明中，message 结构体中包含了以下几个关键内容：</p>
<ul>
<li>crc</li>
<li>magic_byte</li>
<li>attributes<ul>
<li>第[0-2]bit 代表着压缩方式</li>
<li>第[3-7]bit 留空</li>
</ul>
</li>
<li>key</li>
<li>value</li>
</ul>
<p>所以我们在解协议的时候，从 attributes 的第[0-2]个 bit 中可以知道 value 的数据是否需要进行压缩或者解压。</p>
<p>在代码层面中就是：</p>
<p>压缩：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $protocol</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> \Kafka\Exception\ProtocolTypeException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> \ReflectionException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onMessageSetSize</span><span class="params">(&amp;$protocol)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">$this</span>-&gt;getMessage()-&gt;getAttributes()-&gt;getValue() &amp; <span class="number">0x07</span>) !== CompressionCodecEnum::NORMAL) &#123;</span><br><span class="line">        $wrapperMessage = <span class="keyword">clone</span> <span class="keyword">$this</span>-&gt;getMessage();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;getMessage()-&gt;setAttributes(Int8::value(CompressionCodecEnum::NORMAL))</span><br><span class="line">             -&gt;setValue(<span class="keyword">$this</span>-&gt;getMessage()</span><br><span class="line">                             -&gt;getValue());</span><br><span class="line">        $commentRequest = <span class="keyword">new</span> CommonRequest();</span><br><span class="line">        $data = $commentRequest-&gt;packProtocol(MessageProduce::class, <span class="keyword">$this</span>-&gt;getMessage());</span><br><span class="line">        $data = pack(Int32::getWrapperProtocol(), strlen($data)) . $data;</span><br><span class="line"></span><br><span class="line">        $left = <span class="number">0xffffffff00000000</span>;</span><br><span class="line">        $right = <span class="number">0x00000000ffffffff</span>;</span><br><span class="line">        $l = (<span class="number">-1</span> &amp; $left) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        $r = <span class="number">-1</span> &amp; $right;</span><br><span class="line">        $data = pack(Int64::getWrapperProtocol(), $l, $r) . $data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (($wrapperMessage-&gt;getAttributes()-&gt;getValue() &amp; <span class="number">0x07</span>) === CompressionCodecEnum::SNAPPY) &#123;</span><br><span class="line">            $compressValue = snappy_compress($data);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (($wrapperMessage-&gt;getAttributes()-&gt;getValue() &amp; <span class="number">0x07</span>) === CompressionCodecEnum::GZIP) &#123;</span><br><span class="line">            $compressValue = gzencode($data);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'not support lz4'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $wrapperMessage-&gt;setKey(Bytes32::value(<span class="string">''</span>))-&gt;setValue(Bytes32::value($compressValue));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setMessage($wrapperMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $commentRequest = <span class="keyword">new</span> CommonRequest();</span><br><span class="line">    $data = $commentRequest-&gt;packProtocol(MessageProduce::class, <span class="keyword">$this</span>-&gt;getMessage());</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setMessageSetSize(Int32::value(strlen($data)));</span><br><span class="line">    $protocol .= pack(Int32::getWrapperProtocol(), <span class="keyword">$this</span>-&gt;getMessageSetSize()-&gt;getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解压：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $protocol</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> \Kafka\Exception\ProtocolTypeException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> \ReflectionException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onRecordSet</span><span class="params">(&amp;$protocol)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $recordSet = [];</span><br><span class="line">    <span class="keyword">while</span> (is_string($protocol) &amp;&amp; strlen($protocol) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        $commonResponse = <span class="keyword">new</span> CommonResponse();</span><br><span class="line">        $instance = <span class="keyword">new</span> MessageSetFetch();</span><br><span class="line">        $commonResponse-&gt;unpackProtocol(MessageSetFetch::class, $instance, $protocol);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Insufficient reading sub-section, the message is put on the next read</span></span><br><span class="line">        <span class="keyword">if</span> ($instance-&gt;getMessage()-&gt;getCrc()-&gt;getValue() === <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Internal decompression</span></span><br><span class="line">        <span class="keyword">if</span> ($instance-&gt;getMessage()-&gt;getAttributes()-&gt;getValue() !== CompressionCodecEnum::NORMAL) &#123;</span><br><span class="line">            $buffer = $instance-&gt;getMessage()-&gt;getValue()-&gt;getValue();</span><br><span class="line">            $commonResponse-&gt;unpackProtocol(MessageSetFetch::class, $instance, $buffer);</span><br><span class="line">        &#125;</span><br><span class="line">        $recordSet[] = $instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;setRecordSet($recordSet);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $protocol</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onValue</span><span class="params">(&amp;$protocol)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">$this</span>-&gt;getAttributes()-&gt;getValue() &amp; <span class="number">0x07</span>) === CompressionCodecEnum::SNAPPY) &#123;</span><br><span class="line">        <span class="comment">/* snappy-java adds its own header (SnappyCodec)</span></span><br><span class="line"><span class="comment">           which is not compatible with the official Snappy</span></span><br><span class="line"><span class="comment">           implementation.</span></span><br><span class="line"><span class="comment">           8: magic, 4: version, 4: compatible</span></span><br><span class="line"><span class="comment">           followed by any number of chunks:</span></span><br><span class="line"><span class="comment">             4: length</span></span><br><span class="line"><span class="comment">             ...: snappy-compressed data.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        $protocol = substr($protocol, <span class="number">20</span>);</span><br><span class="line">        $ret = [];</span><br><span class="line">        SnappyDecompression:</span><br><span class="line">        <span class="keyword">if</span> (!is_string($protocol) || (is_string($protocol) &amp;&amp; strlen($protocol) &lt;= <span class="number">0</span>)) &#123;</span><br><span class="line">            $ret = implode(<span class="string">''</span>, $ret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $buffer = substr($protocol, <span class="number">0</span>, ProtocolTypeEnum::B32);</span><br><span class="line">            $protocol = substr($protocol, ProtocolTypeEnum::B32);</span><br><span class="line">            $len = unpack(ProtocolTypeEnum::getTextByCode(ProtocolTypeEnum::B32), $buffer);</span><br><span class="line">            $len = is_array($len) ? array_shift($len) : $len;</span><br><span class="line"></span><br><span class="line">            $data = substr($protocol, <span class="number">0</span>, $len);</span><br><span class="line">            $protocol = substr($protocol, $len);</span><br><span class="line">            $ret[] = snappy_uncompress($data);</span><br><span class="line">            <span class="keyword">goto</span> SnappyDecompression;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setValue(Bytes32::value($ret));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">$this</span>-&gt;getAttributes()-&gt;getValue() &amp; <span class="number">0x07</span>) === CompressionCodecEnum::GZIP) &#123;</span><br><span class="line">        $buffer = substr($protocol, <span class="number">0</span>, ProtocolTypeEnum::B32);</span><br><span class="line">        $protocol = substr($protocol, ProtocolTypeEnum::B32);</span><br><span class="line">        $len = unpack(ProtocolTypeEnum::getTextByCode(ProtocolTypeEnum::B32), $buffer);</span><br><span class="line">        $len = is_array($len) ? array_shift($len) : $len;</span><br><span class="line"></span><br><span class="line">        $data = substr($protocol, <span class="number">0</span>, $len);</span><br><span class="line">        $protocol = substr($protocol, $len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setValue(Bytes32::value(gzdecode($data)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Normal</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在压缩的时候，我们需要注意的是，在对数据进行压缩处理的时候，<code>attributes</code>属性必须设置为 0，这是和解压逻辑相对应的。只要在压缩完毕之后，二次封装的时候，attributes 在第二次赋值的时候才会设置成真正的值。</p>
<p>所以这里，我们通过<code>$this-&gt;getAttributes()-&gt;getValue() &amp; 0x07</code>的方式，来判断当前数据是否需要解压。需要注意的是，当采用 snappy/zip 的压缩方式的时候,数据压缩了，细节被屏蔽了起来，消息更加的安全了，我们在第一次对<code>messageSet</code>解压后得出来后来，value 其实仍然并没有被解压，这个时候，我们需要判断<code>attributes</code>的值，如果经过第一次解压，<code>attributes</code>不为 0 的情况下，那么它需要再进行一次解压，这一次，数据将重新覆盖整个<code>messageSet</code>结构体，并且<code>arttibutes</code>将会被设置为 0，以此来告诉客户端，协议已经正确解析完毕。</p>
<p>还有一点需要注意的是 kafka 并不仅仅只是单单用了 snappy 压缩方式，它还加入了它自己的协议头（这个真的是个巨坑），所以你需要忽略前面的 20 个字节。后续以被 4 个字节的解析出来的字符长度来递归解压。相对于 snappy 的压缩方式，gzip 的压缩方式就是中规中矩了。</p>
<h2 id="如何利用-docker-环境尝试加入开发"><a href="#如何利用-docker-环境尝试加入开发" class="headerlink" title="如何利用 docker 环境尝试加入开发"></a>如何利用 docker 环境尝试加入开发</h2><p>项目中，已经把开发用的<code>docker-composer.yaml</code>已经写好了，只需要采用<code>docker-composer up</code>即可。其他的都是常规操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">version: &quot;3&quot;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mzookeeper:</span><br><span class="line">    image: wurstmeister&#x2F;zookeeper</span><br><span class="line">    container_name: kafka-swoole-zookeeper</span><br><span class="line"></span><br><span class="line">  mkafka1:</span><br><span class="line">    image: wurstmeister&#x2F;kafka:2.11-0.9.0.1</span><br><span class="line">    container_name: kafka-swoole-kafka1</span><br><span class="line">    environment:</span><br><span class="line">      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181</span><br><span class="line">      KAFKA_NUM_PARTITIONS: 4</span><br><span class="line">    depends_on:</span><br><span class="line">    - mzookeeper</span><br><span class="line"></span><br><span class="line">  mkafka2:</span><br><span class="line">    image: wurstmeister&#x2F;kafka:2.11-0.9.0.1</span><br><span class="line">    container_name: kafka-swoole-kafka2</span><br><span class="line">    environment:</span><br><span class="line">      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181</span><br><span class="line">      KAFKA_NUM_PARTITIONS: 4</span><br><span class="line">    depends_on:</span><br><span class="line">    - mzookeeper</span><br><span class="line"></span><br><span class="line">  mkafka3:</span><br><span class="line">    image: wurstmeister&#x2F;kafka:2.11-0.9.0.1</span><br><span class="line">    container_name: kafka-swoole-kafka3</span><br><span class="line">    environment:</span><br><span class="line">      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181</span><br><span class="line">      KAFKA_NUM_PARTITIONS: 4</span><br><span class="line">    depends_on:</span><br><span class="line">    - mzookeeper</span><br><span class="line"></span><br><span class="line">  mkafka4:</span><br><span class="line">    image: wurstmeister&#x2F;kafka:2.11-0.9.0.1</span><br><span class="line">    container_name: kafka-swoole-kafka3</span><br><span class="line">    environment:</span><br><span class="line">      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092</span><br><span class="line">      KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181</span><br><span class="line">      KAFKA_NUM_PARTITIONS: 4</span><br><span class="line">    depends_on:</span><br><span class="line">    - mzookeeper</span><br><span class="line"></span><br><span class="line">  kafka-swoole:</span><br><span class="line">    build: .&#x2F;</span><br><span class="line">    container_name: kafka-swoole-php</span><br><span class="line">    volumes:</span><br><span class="line">      - .&#x2F;:&#x2F;data&#x2F;www</span><br><span class="line">    depends_on:</span><br><span class="line">    - mzookeeper</span><br><span class="line">    - mkafka1</span><br><span class="line">    - mkafka2</span><br><span class="line">    - mkafka3</span><br><span class="line">    - mkafka4</span><br></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/消息队列/">消息队列</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Swoole/">Swoole</a><a href="/tags/消息队列，Kafka/">消息队列，Kafka</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2025 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>