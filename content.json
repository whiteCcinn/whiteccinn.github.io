{"meta":{"title":"ç™½èœå›ã®æŠ€æœ¯åº“","subtitle":null,"description":"çŸ¥é“åšä¸åˆ°ï¼Œç­‰äºä¸çŸ¥é“","author":"ç™½èœ(whiteCcinn)","url":"http://blog.crazylaw.cn","root":"/"},"pages":[{"title":"å…³äºæˆ‘","date":"2022-04-11T16:00:00.000Z","updated":"2022-04-12T15:26:27.405Z","comments":true,"path":"about/index.html","permalink":"http://blog.crazylaw.cn/about/index.html","excerpt":"","text":"Hi there ğŸ‘‹Hello, Iâ€™m whiteCcinn, Chinese name is wen-hui CAI, nickname can call me â€œç™½èœğŸ¥¬â€ in Chinese, I am a full stack development engineer, standard enterprise, has a lot of interest in the application of distributed storage, so language are: I like Rust, Golang, C, C++ , of course, I also like PHP, because this is my most good at language, hope you like me, too Contact me Company: @Topon Addressï¼šGuangZhou, GuangDong, China Github: https://github.com/whiteCcinn Blog: https://whiteccinn.github.io/ QQ: &#52;&#55;&#49;&#x31;&#49;&#51;&#x37;&#52;&#x34;&#64;&#113;&#x71;&#x2e;&#x63;&#x6f;&#109;"},{"title":"åˆ†ç±»","date":"2019-03-18T16:00:00.000Z","updated":"2021-03-20T16:25:01.824Z","comments":true,"path":"categories/index.html","permalink":"http://blog.crazylaw.cn/categories/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2019-03-18T16:00:00.000Z","updated":"2021-03-20T16:25:01.824Z","comments":true,"path":"tags/index.html","permalink":"http://blog.crazylaw.cn/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"ssp-adx-localcacheä¼˜åŒ–","slug":"å…¬å¸/localcache","date":"2023-08-27T01:53:00.000Z","updated":"2023-08-28T09:40:43.131Z","comments":true,"path":"2023/08/27/å…¬å¸/localcache/","link":"","permalink":"http://blog.crazylaw.cn/2023/08/27/%E5%85%AC%E5%8F%B8/localcache/","excerpt":"å‰è¨€æœ€è¿‘åœ¨å¤„ç†ssp-adx-rtbçš„æœåŠ¡çš„æ€§èƒ½ä¼˜åŒ–ï¼Œåšäº†å¥½å¤šæ–¹é¢çš„ä¼˜åŒ–ï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬çš„æœ¬åœ°çš„localcacheçš„é—®é¢˜ã€‚ ç»è¿‡pprofçš„æ€§èƒ½åˆ†æï¼Œå‘ç°cache2goï¼Œåœ¨ CPU Flame Graph ä¸­ï¼Œå æ¯”ååˆ†ä¸¥é‡ï¼ŒåŸºæœ¬å¤§äº1/3ï¼Œæ—¢ç„¶æ˜¯localcacheï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ç›®çš„æœ¬æ„å°±æ˜¯ä¸ºäº†æé€Ÿï¼Œæ‰€ä»¥å æ¯”é‚£ä¹ˆå¤§ï¼Œæ˜¯ååˆ†ä¸åˆç†çš„ã€‚ æ‰€ä»¥éœ€è¦æ‰¾åˆ°åŸå› ï¼Œå¹¶ä¸”è§£å†³å®ƒã€‚é™ä½cpuä½¿ç”¨ç‡ï¼Œä»è€Œæé«˜æœåŠ¡çš„QPSï¼Œå‡å°‘æœåŠ¡å™¨æˆæœ¬ã€‚","text":"å‰è¨€æœ€è¿‘åœ¨å¤„ç†ssp-adx-rtbçš„æœåŠ¡çš„æ€§èƒ½ä¼˜åŒ–ï¼Œåšäº†å¥½å¤šæ–¹é¢çš„ä¼˜åŒ–ï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬çš„æœ¬åœ°çš„localcacheçš„é—®é¢˜ã€‚ ç»è¿‡pprofçš„æ€§èƒ½åˆ†æï¼Œå‘ç°cache2goï¼Œåœ¨ CPU Flame Graph ä¸­ï¼Œå æ¯”ååˆ†ä¸¥é‡ï¼ŒåŸºæœ¬å¤§äº1/3ï¼Œæ—¢ç„¶æ˜¯localcacheï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ç›®çš„æœ¬æ„å°±æ˜¯ä¸ºäº†æé€Ÿï¼Œæ‰€ä»¥å æ¯”é‚£ä¹ˆå¤§ï¼Œæ˜¯ååˆ†ä¸åˆç†çš„ã€‚ æ‰€ä»¥éœ€è¦æ‰¾åˆ°åŸå› ï¼Œå¹¶ä¸”è§£å†³å®ƒã€‚é™ä½cpuä½¿ç”¨ç‡ï¼Œä»è€Œæé«˜æœåŠ¡çš„QPSï¼Œå‡å°‘æœåŠ¡å™¨æˆæœ¬ã€‚ cache2goæ—§ç‰ˆ cache2go https://github.com/muesli/cache2go é¡¹ç›®çš„æè¿°ä¸ºï¼š 1Concurrency-safe Go caching library with expiration capabilities and access counters å¹¶å‘å®‰å…¨ï¼Œå¹¶ä¸”å¸¦æœ‰æ•ˆæœŸçš„å’Œè®¿é—®è®¡æ•°å™¨çš„ä¸€ä¸ªç±»åº“ç»„ä»¶ æˆ‘ä»¬éœ€è¦ç”¨ä»–æ¥è§£å†³æˆ‘ä»¬çš„3å¤§æ ¸å¿ƒé—®é¢˜ æœ¬åœ°ç¼“å­˜ å¹¶å‘å®‰å…¨ å¸¦ttlåŠŸèƒ½ å¯¹äºå¼€æºç‰ˆæœ¬ç¬¬ä¸€ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å·²ç»åšä¸ºå¤„ç†äº†ã€‚ å°±æ˜¯ä»–çš„æ·˜æ±°ç­–ç•¥ï¼Œæ˜¯ttl+lruï¼Œå½“ä¸€ä¸ªç¼“å­˜åœ¨ä¸€å®šæ—¶é—´å†…è¢«è¿ç»­è®¿é—®ï¼Œæˆ–è€…åœ¨ä¸€ä¸ªkeyï¼Œå‡†å¤‡è¿‡æœŸçš„æ—¶å€™ï¼Œå¦‚æœè¢«è®¿é—®ï¼Œé‚£ä¹ˆä»–çš„è¿‡æœŸæ—¶é—´å°†ç»§ç»­å»¶é•¿åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸã€‚ è¿™ä¸€ç‰¹ç‚¹ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸€ç‚¹è¿›è¡Œäº†è°ƒæ•´ï¼Œè¿‡æœŸæ—¶é—´ï¼Œåªéœ€è¦åˆ¤æ–­ä¸º ttl è¿‡æœŸå³å¯ï¼Œä¸éœ€è¦åŠ ä¸Š lru çš„æ–¹å¼ã€‚ è¿™é‡Œå°±ä¸å±•å¼€ç»†è¯´ã€‚ cache2goæ–°ç‰ˆ cache2go-new https://github.com/whiteCcinn/cache2go åœ¨è¿™ä¸€ä¸ªç‰ˆæœ¬ï¼ŒåŸºæœ¬æŠŠæ•´ä¸ªåº“éƒ½æŒ‰éœ€é‡æ„äº†ã€‚ä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ã€‚ åŠ å…¥hashåˆ†ç‰‡æœºåˆ¶ï¼ŒæŠŠkeyæ‰“æ•£åˆ°ä¸åŒçš„bucketä¸­ï¼Œè®©bucket-lockçš„äº‰æŠ¢é™ä½ åŒä¸€ä¸ªcache-tableï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªgoroutineï¼Œæ¥å¤„ç† ttl æ•°æ®ï¼Œå¹¶ä¸ä¼šå› ä¸ºåˆ†ç‰‡çš„ä¸ªæ•°è°ƒæ•´å¸¦æ¥æ›´å¤šçš„æ— æ•ˆgoroutine æ²¡æœ‰é‡‡ç”¨æ¸è¿›å¼çš„æ–¹å¼æ¥åˆ é™¤key, åœ¨ add, get çš„é˜¶æ®µï¼Œå°½é‡ä¿æŒæœåŠ¡çš„é«˜æ•ˆæ€§èƒ½ï¼Œæ–¹å¼ç”±äºé”å¸¦æ¥çš„æ€§èƒ½è¡°å‡ é‡‡ç”¨åŒå†™æœºåˆ¶ï¼Œå®ç°L1å’ŒL2çš„äºŒçº§åŒ…è£…çº§åˆ«ï¼Œä»è€Œåšåˆ° è¯»å†™åˆ†ç¦», å°½å¯èƒ½çš„é¿å…åœ¨å¿…è¦çš„åœºæ™¯ä¸‹ç”±äºæ•´ä¸ªå†™é”å¯¼è‡´è¯»é”é˜»å¡çš„é—®é¢˜ï¼Œè®©åå°åœ¨å¤„ç† ttl å’Œ é‡å»ºmapçš„è¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ä¾ç„¶é«˜æ•ˆæä¾›æœåŠ¡ å®šæœŸé‡å»ºåº•å±‚mapå±æ€§ï¼Œæ¥é‡Šæ”¾mapç”³è¯·çš„å†…å­˜ï¼Œè®©æ•´ä¸ªæœåŠ¡ç›¸å¯¹å¤„äºä¸€ä¸ªå†…å­˜ç¨³å®šçš„çŠ¶æ€ éœ€æ±‚+æœºåˆ¶ï¼Œå°±å¯ä»¥åœ¨è¯»å†™è¾ƒå¤šæˆ–è€…åå°éœ€è¦å¤„ç†mapçš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½ä¾æ—§ä¿æŒæœ‰ä¸€ä¸ªè¾ƒå¥½çš„æ€§èƒ½ä½“ç°ã€‚ ä¸ºäº†å®ç°è¿™å‡ ç‚¹ï¼š 123456789101112131415161718192021type CacheTable struct &#123; sync.RWMutex hash *fnv64a // ç”¨äºhash shardMask uint64 // ç”¨äºhashçš„maskï¼Œåœ¨åšæŒ‰ä½ä¸æ“ä½œçš„æ—¶å€™ï¼Œå®ç°æ±‚ä½™ä¸€æ ·çš„è¡Œä¸ºï¼Œç”±äºæ˜¯ä½è¿ç®—ï¼Œæ•ˆç‡ä¸€èˆ¬éƒ½åé«˜ name string // cacheçš„å‘½å L1Shards shardItems // L1çš„åˆ†ç‰‡ç»„ L2Shards shardItems // L2çš„åˆ†ç‰‡ç»„ cleanupInterval time.Duration // å®šæ—¶å¤„ç†ttlçš„æ•°æ® l1BlockChan []*CacheItem // ç”¨äºåœ¨L1åˆ†ç‰‡ç»„è¢«åå°å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæš‚æ—¶æŠŠæ•°æ®ç¼“å­˜èµ·æ¥ l2BlockChan []*CacheItem // ç”¨äºåœ¨L2åˆ†ç‰‡ç»„è¢«åå°å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæš‚æ—¶æŠŠæ•°æ®ç¼“å­˜èµ·æ¥ l1Mask int32 // L1åŸå­è®¡æ•°å™¨ï¼Œç”¨æ¥ä»£æ›¿lockï¼Œé˜²æ­¢lockçš„å µå¡ç°è±¡ï¼Œå¯¼è‡´æœåŠ¡è¢«å½±å“ l2Mask int32 // L2åŸå­è®¡æ•°å™¨ï¼Œç”¨æ¥ä»£æ›¿lockï¼Œé˜²æ­¢lockçš„å µå¡ç°è±¡ï¼Œå¯¼è‡´æœåŠ¡è¢«å½±å“ switchMask uint8 // è®°å½•å½“å‰ cache-tableæ˜¯å¦åœ¨å¤„ç†L1,L2åˆ†ç‰‡ç»„&#125; Addè¿™æ˜¯ä¸€ä¸ªå†™å…¥è¿‡ç¨‹ï¼Œå®ç°èµ·æ¥ä¹Ÿä¸ç®—å¤ªå¤æ‚ 123456789101112131415161718192021222324252627282930313233343536373839func (table *CacheTable) Add(key interface&#123;&#125;, lifeSpan time.Duration, data interface&#123;&#125;) *CacheItem &#123; item := NewCacheItem(key, lifeSpan, data) // åˆ¤æ–­å½“å‰è¡¨æ˜¯å¦åœ¨å¤„ç†L1 if table.switchMask != 1&lt;&lt;1 &#123; // è®°å½•L1æ­£åœ¨å¤„ç†å†™å…¥è¡Œä¸ºï¼Œ+1æ“ä½œ atomic.AddInt32(&amp;table.l1Mask, 1) // ç»“æŸçš„æ—¶å€™L1å†™å…¥çš„æ—¶å€™ï¼Œ-1æ“ä½œ defer atomic.AddInt32(&amp;table.l1Mask, -1) // L1å†…éƒ¨åˆ†ç‰‡ç‰‡çº§å†™é”å¼€å‘ table.L1Shards[item.hashedKey&amp;table.shardMask].lock.Lock() // L1å†…éƒ¨åˆ†ç‰‡å†™å…¥item table.L1Shards[item.hashedKey&amp;table.shardMask].m[item.key] = item // L1å†…éƒ¨åˆ†ç‰‡ç‰‡çº§å†™é”ç»“æŸ table.L1Shards[item.hashedKey&amp;table.shardMask].lock.Unlock() &#125; else &#123; // å¦‚æœå½“å‰åå°åœ¨å¤„ç†L1çš„è¯ï¼Œé‚£ä¹ˆå…ˆç¼“å­˜èµ·æ¥ table.l1BlockChan = append(table.l1BlockChan, item) &#125; // åˆ¤æ–­å½“å‰è¡¨æ˜¯å¦åœ¨å¤„ç†L2 if table.switchMask != 1&lt;&lt;2 &#123; // è®°å½•L2æ­£åœ¨å¤„ç†å†™å…¥è¡Œä¸ºï¼Œ+1æ“ä½œ atomic.AddInt32(&amp;table.l2Mask, 1) // ç»“æŸçš„æ—¶å€™L2å†™å…¥çš„æ—¶å€™ï¼Œ-1æ“ä½œ defer atomic.AddInt32(&amp;table.l2Mask, -1) // L2å†…éƒ¨åˆ†ç‰‡ç‰‡çº§å†™é”å¼€å‘ table.L2Shards[item.hashedKey&amp;table.shardMask].lock.Lock() // L2å†…éƒ¨åˆ†ç‰‡å†™å…¥item table.L2Shards[item.hashedKey&amp;table.shardMask].m[item.key] = item // L2å†…éƒ¨åˆ†ç‰‡ç‰‡çº§å†™é”ç»“æŸ table.L2Shards[item.hashedKey&amp;table.shardMask].lock.Unlock() &#125; else &#123; // å¦‚æœå½“å‰åå°åœ¨å¤„ç†L2çš„è¯ï¼Œé‚£ä¹ˆå…ˆç¼“å­˜èµ·æ¥ table.l2BlockChan = append(table.l2BlockChan, item) &#125; return item&#125; é€šè¿‡åŒå†™çš„æ–¹å¼ï¼Œå®ç°L1å’ŒL2çš„åŒæ—¶å†™å…¥,ä»¥æ­¤è¾¾åˆ°ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ã€‚ å…¶ä¸­ (&amp; 2^(n-1)) åšåˆ° (%m)çš„æ•ˆæœï¼Œå¹¶ä¸”ç”±äºæ˜¯ä½è¿ç®—ï¼Œæ‰€ä»¥æŒ‰ç†è¯´æ•ˆç‡ä¼šæ›´é«˜ Value Value å’Œ å°±æ˜¯Getæ–¹æ³•ï¼Œè·å–keyçš„item 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960func (table *CacheTable) Value(key interface&#123;&#125;, args ...interface&#123;&#125;) (*CacheItem, error) &#123; keyBytes, _ := json.Marshal(key) // å“ˆå¸Œçš„key hashedKey := table.hash.Sum64(string(keyBytes)) var sm *shardItem if table.switchMask == 1&gt;&gt;1 &#123; // å…ˆæŸ¥l1 sm = table.L1Shards[hashedKey&amp;table.shardMask] sm.lock.RLock() r, ok := sm.m[key] sm.lock.RUnlock() if ok &#123; // æ­£å¸¸è¿”å›ç»“æœ return r, nil &#125; // å†æŸ¥l2 sm = table.L2Shards[hashedKey&amp;table.shardMask] sm.lock.RLock() r, ok = sm.m[key] sm.lock.RUnlock() if ok &#123; // æ­£å¸¸è¿”å›ç»“æœ return r, nil &#125; // æ‰¾ä¸åˆ°key return nil, ErrKeyNotFound &#125; else if table.switchMask == 1&lt;&lt;1 &#123; // æ­£åœ¨å¤„ç†l1ï¼Œéœ€è¦ä»l2è¯» sm = table.L2Shards[hashedKey&amp;table.shardMask] sm.lock.RLock() r, ok := sm.m[key] sm.lock.RUnlock() if ok &#123; // æ­£å¸¸è¿”å›ç»“æœ return r, nil &#125; // æ‰¾ä¸åˆ°key return nil, ErrKeyNotFound &#125; else &#123; // æ­£åœ¨å¤„ç†l2ï¼Œéœ€è¦ä»l1è¯» sm = table.L1Shards[hashedKey&amp;table.shardMask] sm.lock.RLock() r, ok := sm.m[key] sm.lock.RUnlock() if ok &#123; // æ­£å¸¸è¿”å›ç»“æœ return r, nil &#125; // æ‰¾ä¸åˆ°key return nil, ErrKeyNotFound &#125;&#125; å¯ä»¥çœ‹åˆ°è¿™é‡Œï¼Œå¦‚æœåå°æ²¡æœ‰åœ¨æ“ä½œL1, L2 çš„è¯ï¼Œé‚£ä¹ˆå…ˆä»L1æ‹¿æ•°æ®ï¼Œç„¶åå†ä»L2æ‹¿æ•°æ® å¦‚æœåå°åœ¨æ“ä½œL1, é‚£ä¹ˆåªèƒ½ä» L2 è¯»å– å¦‚æœåå°åœ¨æ“ä½œL2, é‚£ä¹ˆåªèƒ½ä» L1 è¯»å– æ‰€ä»¥é€šè¿‡L1å’ŒL2ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªè¯»å†™åˆ†ç¦»çš„ç­–ç•¥ï¼Œå¹¶ä¸”åœ¨æœ€å¤§çš„ç¨‹åº¦ä¸Šå‡å°‘åˆ†ç‰‡é”çš„è¯»å†™é”å†²çªï¼Œä»è€Œæé«˜æœåŠ¡çš„æ•ˆç‡ åå°ä»»åŠ¡123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169// å®šæ—¶æ¸…ç†è¿‡æœŸç¼“å­˜go func(t *CacheTable, ctx context.Context) &#123; // å®šæ—¶ç›‘æµ‹ttlæ•°æ® ticker := time.NewTicker(cleanInterval) // å®šæœŸé‡å»ºmapï¼Œä»¥æ­¤æ¥é‡Šæ”¾mapç”³è¯·çš„ç©ºé—´ reBuildTicker := time.NewTicker(30 * time.Minute) for &#123; select &#123; case &lt;-ctx.Done(): ticker.Stop() reBuildTicker.Stop() return case &lt;-ticker.C: // è¡¨é” t.Lock() // æ‰«æéœ€è¦åˆ é™¤çš„key var deleteList []*CacheItem // å…ˆå¤„ç†l1ï¼Œå†å¤„ç†l2 t.switchMask = 1 &lt;&lt; 1 now := time.Now() // å¤„ç†l1 // ä¸å…è®¸l1è¯»å†™å…¥ï¼Œè¯»å†™é€šè¿‡l2 for &#123; if atomic.LoadInt32(&amp;t.l1Mask) == 0 &#123; // å½“L1å·²ç»æ“ä½œå®ŒAddæ“ä½œçš„æ—¶å€™ç»§ç»­å¾€ä¸‹èµ° break &#125; &#125; for i, sad := range t.L1Shards &#123; // åˆ†ç‰‡ç‰‡çº§åˆ«è¯»é” sad.lock.RLock() for _, r := range sad.m &#123; // ttlæ•°æ®æ ¡éªŒå¤„ç† if now.Sub(r.createdOn).Seconds() &gt; r.lifeSpan.Seconds() &#123; deleteList = append(deleteList, r) &#125; &#125; sad.lock.RUnlock() &#125; // å¼€å§‹åˆ é™¤ for _, item := range deleteList &#123; // åˆ†ç‰‡ç‰‡çº§åˆ«å†™é”ï¼Œé˜²æ­¢åœ¨ Valueæ“ä½œçš„æ—¶å€™ï¼Œå¹¶è¡Œè¯»å†™å¼‚å¸¸ t.L1Shards[item.hashedKey&amp;t.shardMask].lock.Lock() delete(t.L1Shards[item.hashedKey&amp;t.shardMask].m, item.key) t.L1Shards[item.hashedKey&amp;t.shardMask].lock.Unlock() &#125; // é‡ç½®deleteList deleteList = make([]*CacheItem, 0) // å¤„ç†å®Œl1,å¤„ç†l2 t.switchMask = 1 &lt;&lt; 2 // å µå¡çš„itemåŠ å›æ¥åˆ°l1 l1Length := len(t.l1BlockChan) for _, item := range t.l1BlockChan &#123; if item != nil &#123; t.L1Shards[item.hashedKey&amp;t.shardMask].lock.Lock() t.L1Shards[item.hashedKey&amp;t.shardMask].m[item.key] = item t.L1Shards[item.hashedKey&amp;t.shardMask].lock.Unlock() &#125; &#125; // é‡ç½®l1BlockChan, é¢„å…ˆç”³è¯·å¤§å°ä¸ºåŸæ¥åˆ°ä¸€åŠ t.l1BlockChan = make([]*CacheItem, 0, l1Length/2) // ä¸å…è®¸l2è¯»å†™å…¥ï¼Œè¯»å†™é€šè¿‡l1 for &#123; if atomic.LoadInt32(&amp;t.l2Mask) == 0 &#123; break &#125; &#125; for i, sad := range t.L2Shards &#123; sad.lock.RLock() for _, r := range sad.m &#123; if now.Sub(r.createdOn).Seconds() &gt; r.lifeSpan.Seconds() &#123; deleteList = append(deleteList, r) &#125; &#125; sad.lock.RUnlock() &#125; // å¼€å§‹åˆ é™¤ for _, item := range deleteList &#123; t.L2Shards[item.hashedKey&amp;t.shardMask].lock.Lock() delete(t.L2Shards[item.hashedKey&amp;t.shardMask].m, item.key) t.L2Shards[item.hashedKey&amp;t.shardMask].lock.Unlock() &#125; // æ¢å¤æ­£å¸¸ t.switchMask = 1 &gt;&gt; 1 for _, item := range t.l2BlockChan &#123; //fmt.Println(t.name, t.L1Shards[item.hashedKey&amp;t.shardMask]) if item != nil &#123; t.L2Shards[item.hashedKey&amp;t.shardMask].lock.Lock() t.L2Shards[item.hashedKey&amp;t.shardMask].m[item.key] = item t.L2Shards[item.hashedKey&amp;t.shardMask].lock.Unlock() &#125; &#125; // é‡ç½®l2BlockChan t.l2BlockChan = make([]*CacheItem, 0, l2Length/2) t.Unlock() case &lt;-reBuildTicker.C: t.Lock() // ä¸ºäº†é‡Šæ”¾mapå†…å­˜ // å…ˆå¤„ç†l1ï¼Œå†å¤„ç†l2 t.switchMask = 1 &lt;&lt; 1 now := time.Now() // å¤„ç†l1 // ä¸å…è®¸l1è¯»å†™å…¥ï¼Œè¯»å†™é€šè¿‡l2 for &#123; if atomic.LoadInt32(&amp;t.l1Mask) == 0 &#123; break &#125; &#125; for _, sad := range t.L1Shards &#123; sad.lock.Lock() nm := make(shard, len(sad.m)) for key, r := range sad.m &#123; if now.Sub(r.createdOn).Seconds() &lt; r.lifeSpan.Seconds() &#123; nm[key] = r &#125; &#125; sad.m = nil sad.m = nm sad.lock.Unlock() &#125; // å…ˆå¤„ç†l1ï¼Œå†å¤„ç†l2 t.switchMask = 1 &lt;&lt; 2 for &#123; if atomic.LoadInt32(&amp;t.l2Mask) == 0 &#123; break &#125; &#125; for _, sad := range t.L2Shards &#123; sad.lock.Lock() nm := make(shard, len(sad.m)) for key, r := range sad.m &#123; if now.Sub(r.createdOn).Seconds() &lt; r.lifeSpan.Seconds() &#123; nm[key] = r &#125; &#125; sad.m = nil sad.m = nm sad.lock.Unlock() &#125; // æ¢å¤æ­£å¸¸ t.switchMask = 1 &gt;&gt; 1 runtime.GC() debug.FreeOSMemory() t.Unlock() &#125; &#125;&#125;(t, ctx)","categories":[{"name":"ç»„ä»¶ä¼˜åŒ–","slug":"ç»„ä»¶ä¼˜åŒ–","permalink":"http://blog.crazylaw.cn/categories/%E7%BB%84%E4%BB%B6%E4%BC%98%E5%8C%96/"}],"tags":[{"name":"cache","slug":"cache","permalink":"http://blog.crazylaw.cn/tags/cache/"}]},{"title":"Home Assistant ï¼ˆäºŒï¼‰","slug":"æ™ºèƒ½å®¶å±…/Home-Assistant2","date":"2023-07-31T16:00:19.000Z","updated":"2023-08-02T16:45:58.961Z","comments":true,"path":"2023/08/01/æ™ºèƒ½å®¶å±…/Home-Assistant2/","link":"","permalink":"http://blog.crazylaw.cn/2023/08/01/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/Home-Assistant2/","excerpt":"å‰è¨€æœ¬æ¬¡ä¸»è¦æ˜¯è®²è§£ä¸€ä¸‹è¿›é˜¶ç‰ˆçš„HAï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯è¿›é˜¶ç‰ˆæœ¬å‘¢ï¼Œå› ä¸ºæˆ‘ä¹Ÿæ˜¯èŠ±äº†å‡ å¤©çš„æ—¶å€™ï¼Œå»äº†è§£å„ç§çŸ¥è¯†æ‰äº†è§£å¾—åˆ°çš„å†…å®¹ã€‚ å†…å®¹åŒ…æ‹¬ï¼šä»€ä¹ˆå«hassioï¼Œhassosï¼Œå¹¶ä¸”ä»–ä»¬å’ŒHome Assistant æ˜¯ä»€ä¹ˆå…³ç³»ã€‚ å¹¶ä¸”æˆ‘ä¼šé‡ç‚¹è®²è§£dockerç‰ˆæœ¬çš„HAéƒ½æ˜¯éœ€è¦æ€ä¹ˆç©ï¼ˆä¸å€ŸåŠ©hassioï¼‰ï¼Œä½ é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œæˆ‘å°±å‘Šè¯‰ä½ å› ä¸ºè¿‡äºç¹çï¼Œå¹¶ä¸”å¤šäº†å¾ˆå¤šæ— ç”¨çš„å®¹å™¨å ç”¨ç³»ç»Ÿèµ„æºã€‚ ä¸ºä»€ä¹ˆæˆ‘åæ‰§äºdockerç‰ˆæœ¬çš„haï¼Ÿå› ä¸ºæˆ‘ä¸æƒ³ä¸€å°æœºå™¨ï¼Œåªåšä¸€ä»¶äº‹ï¼Œè¿™å¯¹é«˜é…ç½®å’Œé«˜æ€§èƒ½çš„æœºå™¨æ˜¯ä¸€ç§ç»å¯¹çš„æµªè´¹ã€‚ åœ¨è¿™ä¸ªæ—¶å€™ï¼Œç¯å¢ƒéš”ç¦»å°±æˆäº†é‡è¦çš„å› ç´ , è€Œdockerå°±å¾ˆå¥½çš„åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”ä¸åƒhassioçš„åº•å±‚ä¾èµ–ã€‚","text":"å‰è¨€æœ¬æ¬¡ä¸»è¦æ˜¯è®²è§£ä¸€ä¸‹è¿›é˜¶ç‰ˆçš„HAï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯è¿›é˜¶ç‰ˆæœ¬å‘¢ï¼Œå› ä¸ºæˆ‘ä¹Ÿæ˜¯èŠ±äº†å‡ å¤©çš„æ—¶å€™ï¼Œå»äº†è§£å„ç§çŸ¥è¯†æ‰äº†è§£å¾—åˆ°çš„å†…å®¹ã€‚ å†…å®¹åŒ…æ‹¬ï¼šä»€ä¹ˆå«hassioï¼Œhassosï¼Œå¹¶ä¸”ä»–ä»¬å’ŒHome Assistant æ˜¯ä»€ä¹ˆå…³ç³»ã€‚ å¹¶ä¸”æˆ‘ä¼šé‡ç‚¹è®²è§£dockerç‰ˆæœ¬çš„HAéƒ½æ˜¯éœ€è¦æ€ä¹ˆç©ï¼ˆä¸å€ŸåŠ©hassioï¼‰ï¼Œä½ é—®æˆ‘ä¸ºä»€ä¹ˆï¼Œæˆ‘å°±å‘Šè¯‰ä½ å› ä¸ºè¿‡äºç¹çï¼Œå¹¶ä¸”å¤šäº†å¾ˆå¤šæ— ç”¨çš„å®¹å™¨å ç”¨ç³»ç»Ÿèµ„æºã€‚ ä¸ºä»€ä¹ˆæˆ‘åæ‰§äºdockerç‰ˆæœ¬çš„haï¼Ÿå› ä¸ºæˆ‘ä¸æƒ³ä¸€å°æœºå™¨ï¼Œåªåšä¸€ä»¶äº‹ï¼Œè¿™å¯¹é«˜é…ç½®å’Œé«˜æ€§èƒ½çš„æœºå™¨æ˜¯ä¸€ç§ç»å¯¹çš„æµªè´¹ã€‚ åœ¨è¿™ä¸ªæ—¶å€™ï¼Œç¯å¢ƒéš”ç¦»å°±æˆäº†é‡è¦çš„å› ç´ , è€Œdockerå°±å¾ˆå¥½çš„åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œå¹¶ä¸”ä¸åƒhassioçš„åº•å±‚ä¾èµ–ã€‚ MQTT ä»€ä¹ˆæ˜¯MQTTåè®®ï¼Œè¿™ä¸ªå¾—å¤§å®¶å»äº†è§£äº†ï¼Œè¿™é‡Œæˆ‘åªå’Œå¤§å®¶è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼€æºçš„å‘å¸ƒè®¢é˜…çš„ç®€æ˜“åè®®å®ƒå¯ä»¥åšåˆ°æœåŠ¡å‘ç°çš„åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥åšåˆ°äº‹ä»¶é€šçŸ¥ç­‰ç­‰å®ƒæ˜¯ä¼ ç»Ÿçš„ç‰©è”ç½‘å¤§å®¶éƒ½ä¼šé€‰æ‹©çš„ä¸€ä¸ªåè®® è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªMQTTçš„æœåŠ¡å™¨ï¼Œè¿™ä¸ªé¡¹ç›®å°±æ˜¯å¦‚ä¸‹ eclipse-mosquitto (https://github.com/eclipse/mosquitto) (https://hub.docker.com/r/amd64/eclipse-mosquitto) è¿™æ˜¯ä¸€ä¸ªä¸€ä¸ªç”±äºCè¯­è¨€å®ç°çš„MQTTåè®®çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸ç›´æ¥ç”¨ä»–ã€‚æˆ‘ä»¬å€ŸåŠ©dockerçš„ç‰¹æ€§ï¼Œç”¨dockeræ¥å®‰è£…ã€‚ æ’ä¸€ä¸ªé¢˜å¤–è¯ï¼Œå…¶å®Home Assistantçš„ ADD-ON åŠŸèƒ½ï¼Œä¹Ÿæ˜¯åˆ›å»ºä¸€äº›æœåŠ¡çš„å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰‹åŠ¨æ“ä½œï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚è¿™ä¸ªæ—¶å€™å°±æ˜¯è§£ç­”æœ‰ä¸€äº›å°ä¼™ä¼´ç»å¸¸ä¼šçº ç»“çš„ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæˆ‘ç”¨dockerå®‰è£…çš„HAï¼Œå®ƒä¸å­˜åœ¨ Add-on è¿™ä¸ªåŠ è½½é¡¹ï¼Œæˆ‘è¦æ€ä¹ˆä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚ç­”æ¡ˆå°±æ˜¯ï¼šæ‰‹åŠ¨å¤„ç†ã€‚å½“ç„¶å¦‚æœä½ æœ‰ç¼–ç¨‹èƒ½åŠ›çš„è¯ï¼Œä¹Ÿå¯ä»¥åšæˆä¸€ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æ¥ä¸‹æ¥å‡†å¤‡åšçš„ã€‚ å¥½çš„ï¼Œè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„æ“ä½œï¼ŒåŸºäº docker å®‰è£… eclipse-mosquitto æœåŠ¡ã€‚ æ‰¾åˆ°ä¸€ä¸ªç›®å½•ï¼Œæ¥ç€æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºç›®å½• 123mkdir -p ~/ha/mqtt/configmkdir -p ~/ha/mqtt/datamkdir -p ~/ha/mqtt/log åœ¨ ~/ha/mqtt/config ç›®å½•ä¸‹åˆ›å»ºé…ç½®æ–‡ä»¶ mosquitto.conf 1vim mosquitto.conf å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦åˆ†åˆ«æ˜¯éœ€è¦æŒä¹…åŒ–æ•°æ®ï¼Œå­˜å‚¨çš„è·¯å¾„æ˜¯å®¹å™¨å†…éƒ¨çš„è·¯å¾„ 12345678910# æ˜¯å¦å…è®¸æœªæä¾›ç”¨æˆ·åçš„å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥allow_anonymous true# 0.0.0.0å¾ˆé‡è¦ï¼Œå¦åˆ™ä½ çš„å®¿ä¸»æœºè½¬å‘çš„ç«¯å£ï¼Œä¹Ÿæ— æ³•è¢«mqttæ¥æ”¶åˆ°listener 1883 0.0.0.0# æ˜¯å¦æŒä¹…åŒ–æ•°æ®persistence true# æŒä¹…åŒ–æ•°æ®çš„è·¯å¾„persistence_location /mosquitto/data# è½ç›˜æ—¥å¿—log_dest file /mosquitto/log/mosquitto.log å…·ä½“é…ç½®æ–‡æ¡£ https://mosquitto.org/man/mosquitto-conf-5.html æœ€åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯å¯åŠ¨ mosquitto å®¹å™¨ï¼š 123456docker run -d --name=mosquitto --privileged-p 1883:1883 \\-v $(PWD)/config/mosquitto.conf:/mosquitto/config/mosquitto.conf \\-v $(PWD)/data:/mosquitto/data \\-v $(PWD)/log:/mosquitto/log \\eclipse-mosquitto æˆ‘çš„ $(PWD)ä»£è¡¨å½“å‰ç›®å½•ï¼Œä½ å¯ä»¥æ”¹æˆä¸Šé¢çš„ ~/ha/mqtt/ç›®å½• æŸ¥çœ‹å®¹å™¨æ˜¯å¦å¯åŠ¨ï¼š 12CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESb4a8f33dc8b2 eclipse-mosquitto \"/docker-entrypoint.â€¦\" 17 seconds ago Up 17 seconds 0.0.0.0:1883-&gt;1883/tcp mosquitto æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯: 12345678910tail log/mosquitto.log1690908079: mosquitto version 2.0.15 starting1690908079: Config loaded from /mosquitto/config/mosquitto.conf.1690908079: Starting in local only mode. Connections will only be possible from clients running on this machine.1690908079: Create a configuration file which defines a listener to allow remote access.1690908079: For more details see https://mosquitto.org/documentation/authentication-methods/1690908079: Opening ipv4 listen socket on port 1883.1690908079: Opening ipv6 listen socket on port 1883.1690908079: Error: Address not available1690908079: mosquitto version 2.0.15 running OKï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€åˆ‡æ­£å¸¸ã€‚ è®©æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹æ˜¯ä¸æ˜¯çœŸçš„okäº†ã€‚ æˆ‘ä»¬åŒæ ·ï¼Œç”¨2ä¸ªå®¹å™¨ï¼Œåˆ†åˆ«åˆ›å»ºå‘å¸ƒè€…å’Œè®¢é˜…è€… ç”±äºæˆ‘çš„æ˜¯macbookï¼Œæ‰€ä»¥æˆ‘çš„å®¹å™¨å¯ä»¥é€šè¿‡host.docker.internalæ¥è®¿é—®å®¿ä¸»æœºï¼Œå¦‚æœæ˜¯linuxç¯å¢ƒä¸‹çš„ï¼Œå¯ä»¥ä½¿ç”¨ --net host æ¨¡å¼ è®¢é˜…è€…ï¼ˆçª—å£1ï¼‰: 1docker run --rm -it eclipse-mosquitto sh -c 'mosquitto_sub -h host.docker.internal -p 1883 -t \"#\" -v' å¯¹åº”çš„å‚æ•°å°±ä¸ä¸€ä¸€è§£é‡Šäº† å‘å¸ƒè€…ï¼ˆçª—å£2ï¼‰: 1docker run --rm -it eclipse-mosquitto sh -c 'mosquitto_pub -h host.docker.internal -p 1883 -t \"test/testdevice\" -m caiwenhui-hello' å›åˆ°çª—å£1æŸ¥çœ‹è®¢é˜…è€…çš„æƒ…å†µ 12docker run --rm -it eclipse-mosquitto sh -c 'mosquitto_sub -h host.docker.internal -p 1883 -t \"#\" -v' test/testdevice caiwenhui-hello å¯ä»¥çœ‹è§ï¼Œæˆ‘ä»¬çš„æ¶ˆæ¯å’Œå¯¹åº”çš„topicéƒ½æ­£å¸¸æ¥å—åˆ°äº†ã€‚éå¸¸å¥½ï¼ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å…¥æˆ‘ä»¬çš„HAï¼ï¼ è®©HAå’ŒMQTTè¿æ¥æˆ‘ä»¬æ‰“å¼€å›åˆ°æˆ‘ä»¬çš„HA, http://127.0.0.1:8123 ç”±äºæˆ‘è¿™é‡Œæ²¡æœ‰è´¦å·å¯†ç ï¼Œå¹¶ä¸”å…è®¸åŒ¿åå‘é€ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å…ˆå¿½è§†è¿™äº›ï¼Œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ï¼Œå¦åˆ™ä¸€æ—¦mqttè¢«ç ´è§£ï¼Œè¢«å‘é€æ¶æ„æŒ‡ä»¤ï¼Œå¯èƒ½ä¼šè®©ä½ çš„è®¾å¤‡â€œå‘ç–¯â€ çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é…ç½®å®Œæˆäº†ã€‚æ¥ä¸‹é‡Œï¼Œå°±æ˜¯åœ¨HAé‡Œé¢æµ‹è¯•æ˜¯å¦çœŸçš„é…ç½®æ­£ç¡®å¹¶ä¸”å¯é€šçš„äº†ã€‚ å¯ä»¥çœ‹åˆ°å…³é”®ä¿¡æ¯: i am ha&#39;s caiwenhui , æ˜¯å› ä¸ºæˆ‘åœ¨æˆ‘çš„ç”µè„‘å‘é€çš„æ¶ˆæ¯è¢«HAæ¥æ”¶åˆ°äº† å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå›¾ï¼Œä»£è¡¨ï¼Œæˆ‘æ¥æ”¶åˆ°äº†ä»haç³»ç»Ÿå‘å‡ºçš„æ¶ˆæ¯ã€‚okï¼Œæˆ‘ä»¬haå’Œmqttçš„è¿æ¥åœ¨ä¸å€ŸåŠ© hassio å’Œ add-onçš„æƒ…å†µä¸‹å·²ç»æ‰“é€šäº†ã€‚","categories":[{"name":"æ™ºèƒ½å®¶å±…","slug":"æ™ºèƒ½å®¶å±…","permalink":"http://blog.crazylaw.cn/categories/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/"}],"tags":[{"name":"æ™ºèƒ½å®¶å±…","slug":"æ™ºèƒ½å®¶å±…","permalink":"http://blog.crazylaw.cn/tags/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/"},{"name":"Home Assistant","slug":"Home-Assistant","permalink":"http://blog.crazylaw.cn/tags/Home-Assistant/"},{"name":"HA","slug":"HA","permalink":"http://blog.crazylaw.cn/tags/HA/"}]},{"title":"Home Assistant ï¼ˆä¸€ï¼‰","slug":"æ™ºèƒ½å®¶å±…/Home-Assistant","date":"2023-07-29T16:00:19.000Z","updated":"2023-08-01T16:22:01.707Z","comments":true,"path":"2023/07/30/æ™ºèƒ½å®¶å±…/Home-Assistant/","link":"","permalink":"http://blog.crazylaw.cn/2023/07/30/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/Home-Assistant/","excerpt":"å‰è¨€æ—¢ç„¶æ˜¯æŠ€æœ¯åšå®¢ï¼Œé‚£ä¹ˆè¿™ä¸€æœŸï¼Œæˆ‘ä¼šå¼€å§‹åšä¸€ç³»åˆ—çš„å…³äºæ™ºèƒ½å®¶å±…çš„ç©æ³•ã€‚ Home Assistant ä¹Ÿå« HA + Zigbeeåè®®(ç¡¬ä»¶ä¹‹é—´çš„é€šä¿¡åè®®) HACS æ˜¯ HA çš„ä¸€ä¸ªç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶åŒ…æ‹¬äº†è®¸å¤šå¼€å‘è€…æ‰€è´¡çŒ®çš„æ’ä»¶ï¼Œå¦‚æœä½ æ˜¯ä¸€åå¼€å‘äººå‘˜ï¼Œé‚£ä¹ˆä½ ä¸€å®šäº†è§£ä»€ä¹ˆå«ä¾èµ–åº“ã€‚æ‰€ä»¥å¯ä»¥ç†è§£ä¸º HACS å°±æ˜¯ HA çš„ç¬¬ä¸‰æ–¹æ’ä»¶ä¾èµ–åº“ï¼Œä½ å¯ä»¥åœ¨è¿æ‰¾åˆ°éœ€è¦å¯¹ä½ æœ‰ç”¨çš„æ’ä»¶ï¼Œè€Œä½ ä¸å¿…é‡æ–°å¼€å‘ã€‚ ä¸ºä»€ä¹ˆé€‰æ‹© Zigbeeåè®® ï¼Ÿ åœ¨å¯¹æ¯”è¿‡è“ç‰™mesh,wifiåè®®ä¹‹åï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©äº†zigbeeåè®®ï¼Œåœ¨äºç¡¬ä»¶ä¹‹é—´çš„æ§åˆ¶ä¿¡å·é‡ä¼ è¾“æœ¬èº«å°±å°‘ï¼Œæ‰€ä»¥å®ƒè‡ªèº«çš„ç¨³å®šæ€§å’Œåˆ†å¸ƒå¼çš„ç‰¹ç‚¹ï¼Œå¯ä»¥å¾ˆå¥½çš„æ”¯æŒåˆ°å®¶åº­ä¸­çš„å„ä¸ªè§’è½ï¼Œä¸ä¼šå‡ºç°ç”±äºä¿¡å·å·®å¯¼è‡´å¤±çµçš„æƒ…å†µï¼Œå¹¶ä¸”zigbeeåè®®çš„ç‰¹ç‚¹ï¼Œç”µé‡çš„æ¶ˆè€—ä¹Ÿæ˜¯ååˆ†çš„ä½ã€‚","text":"å‰è¨€æ—¢ç„¶æ˜¯æŠ€æœ¯åšå®¢ï¼Œé‚£ä¹ˆè¿™ä¸€æœŸï¼Œæˆ‘ä¼šå¼€å§‹åšä¸€ç³»åˆ—çš„å…³äºæ™ºèƒ½å®¶å±…çš„ç©æ³•ã€‚ Home Assistant ä¹Ÿå« HA + Zigbeeåè®®(ç¡¬ä»¶ä¹‹é—´çš„é€šä¿¡åè®®) HACS æ˜¯ HA çš„ä¸€ä¸ªç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶åŒ…æ‹¬äº†è®¸å¤šå¼€å‘è€…æ‰€è´¡çŒ®çš„æ’ä»¶ï¼Œå¦‚æœä½ æ˜¯ä¸€åå¼€å‘äººå‘˜ï¼Œé‚£ä¹ˆä½ ä¸€å®šäº†è§£ä»€ä¹ˆå«ä¾èµ–åº“ã€‚æ‰€ä»¥å¯ä»¥ç†è§£ä¸º HACS å°±æ˜¯ HA çš„ç¬¬ä¸‰æ–¹æ’ä»¶ä¾èµ–åº“ï¼Œä½ å¯ä»¥åœ¨è¿æ‰¾åˆ°éœ€è¦å¯¹ä½ æœ‰ç”¨çš„æ’ä»¶ï¼Œè€Œä½ ä¸å¿…é‡æ–°å¼€å‘ã€‚ ä¸ºä»€ä¹ˆé€‰æ‹© Zigbeeåè®® ï¼Ÿ åœ¨å¯¹æ¯”è¿‡è“ç‰™mesh,wifiåè®®ä¹‹åï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©äº†zigbeeåè®®ï¼Œåœ¨äºç¡¬ä»¶ä¹‹é—´çš„æ§åˆ¶ä¿¡å·é‡ä¼ è¾“æœ¬èº«å°±å°‘ï¼Œæ‰€ä»¥å®ƒè‡ªèº«çš„ç¨³å®šæ€§å’Œåˆ†å¸ƒå¼çš„ç‰¹ç‚¹ï¼Œå¯ä»¥å¾ˆå¥½çš„æ”¯æŒåˆ°å®¶åº­ä¸­çš„å„ä¸ªè§’è½ï¼Œä¸ä¼šå‡ºç°ç”±äºä¿¡å·å·®å¯¼è‡´å¤±çµçš„æƒ…å†µï¼Œå¹¶ä¸”zigbeeåè®®çš„ç‰¹ç‚¹ï¼Œç”µé‡çš„æ¶ˆè€—ä¹Ÿæ˜¯ååˆ†çš„ä½ã€‚ ç¡¬ä»¶ç”±äºæˆ‘ç°åœ¨æ²¡æœ‰æ ‘è“æ´¾æˆ–è€…nasç­‰æœ¬åœ°æœåŠ¡å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¥æˆ‘çš„macbook proæ¥ä¾‹ã€‚ä½†æ˜¯å®é™…æƒ…å†µä¸‹çš„æ™ºèƒ½å®¶å±…ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€å°è¿æ¥åœ¨æœ¬åœ°å±€åŸŸç½‘çš„æœåŠ¡ï¼Œå®ƒéœ€è¦è¦æ±‚çš„ç‰¹ç‚¹åŒ…æ‹¬å¦‚ä¸‹ï¼š ä½åŠŸè€— ä¾¿æºï¼Œä¸å ç”¨å®¶åº­ç©ºé—´ æ”¯æŒæ›´å¤šçš„å…¶ä»–åŠŸèƒ½ï¼Œä¾‹å¦‚ç”¨äºnasï¼Œtime machine, è½¯è·¯ç”±(ç§‘å­¦ä¸Šå­¦) ç­‰ç­‰ï¼ˆéå¿…è¦ï¼Œä½†æ˜¯å¯ä»¥åšåœ¨ä¸€èµ·ï¼Œæ‰€ä»¥æœºå™¨çš„æ€§èƒ½è¶Šå‡ºè‰²è¶Šå¥½ï¼‰ ç”±äºæ˜¯æµ‹è¯•ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘åªä¹°äº†2ä¸ª æ¶‚é¸¦ å“ç‰Œçš„ e27 çš„æ™ºèƒ½ç¯æ³¡ å’Œ zigbee2mqtt çš„ zigbeeåè®®ä¿¡å·ç½‘å…³ ** éœ€è¦å»æ·˜å®ä¹° ** zigbeeä¿¡å·ç½‘å…³ 2ä¸ªæ™ºèƒ½ç¯æ³¡ zigbeeä¿¡å·ç½‘å…³ æ”¯æŒzigbeeåè®®çš„æ™ºèƒ½ç¯æ³¡ Home Assistant å®‰è£…ç”±äºç›®å‰æˆ‘åœ¨å°è¯•é˜¶æ®µï¼Œå¹¶ä¸”æ˜¯macbookï¼Œå¹¶ä¸”æˆ‘æ›´å€¾å‘äºç”¨dockerå®‰è£…å„ç§æœåŠ¡ï¼Œåœ¨å®¹å™¨åŒ–çš„æ—¶ä»£ï¼Œç‰©ç†ç¯å¢ƒçš„éš”ç¦»æ˜¯ååˆ†é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ã€‚ docker å®‰è£… è¿™é‡Œä¸ä»‹ç»dockeræ€ä¹ˆå®‰è£…äº†ï¼Œå¦‚æœæ˜¯å®Œå…¨æ²¡ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†çš„è¯ï¼ŒæŠ˜è…¾èµ·æ¥ç¡®å®æœ‰ç‚¹éº»çƒ¦ åˆ›å»ºæ•°æ®å­˜å‚¨ç›®å½•ï¼Œmkdir -p ~/ha;cd ~/haï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹ dockerå‘½ä»¤ è¿›è¡Œå®‰è£… 1234567docker run -d \\ --name homeassistant \\ --privileged \\ -e TZ=Asia/Shanghai \\ -v $(PWD):/config \\ -p 8123:8123 \\ homeassistant/home-assistant ç½‘ä¸Šå¾ˆå¤šéƒ½è¯´è¦ç”¨â€“net=hostæ¨¡å¼ï¼Œä½†æ˜¯å…¶å®æ²¡å¿…è¦çš„ï¼ŒæŒ‡å®šç«¯å£æš´éœ²å°±å¥½haçš„é»˜è®¤ç«¯å£å°±æ˜¯8123 docker ps æŸ¥çœ‹å®¹å™¨æƒ…å†µ 12CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMESb2f9de1af25b homeassistant/home-assistant \"/init\" 2 seconds ago Up 1 second 0.0.0.0:8123-&gt;8123/tcp homeassistant å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å®¹å™¨å¯åŠ¨äº†ã€‚å¹¶ä¸”æ­£å¸¸è¿è¡Œäº†ã€‚å¦‚æœä½ è¿˜ä¸æ”¾å¿ƒï¼Œå¯ä»¥çœ‹ä¸€ä¸‹æ—¥å¿—ä¹Ÿå¯ä»¥ docker log homeassistant 123456789s6-rc: info: service s6rc-oneshot-runner: startings6-rc: info: service s6rc-oneshot-runner successfully starteds6-rc: info: service fix-attrs: startings6-rc: info: service fix-attrs successfully starteds6-rc: info: service legacy-cont-init: startings6-rc: info: service legacy-cont-init successfully starteds6-rc: info: service legacy-services: startingservices-up: info: copying legacy longrun home-assistant (no readiness notification)s6-rc: info: service legacy-services successfully started æ‰“å¼€æµè§ˆå™¨ï¼Œåœ¨æµè§ˆå™¨ä¸­è¾“å…¥ 127.0.0.1:8123ï¼Œå°±ä¼šçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºå¥½è´¦å·å¯†ç ï¼Œåˆ‡å‹¿å¿˜è®°å¯†ç ï¼Œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œè®°å¾—è®°å½•ä¸‹æ¥ è¿™é‡Œæˆ‘ä»¬ï¼Œä¸æ€ä¹ˆéœ€è¦ç†ä¼šï¼Œæ­£å¸¸å¡«å†™å³å¯ã€‚ è¿™é‡Œé»˜è®¤çš„éƒ½æ˜¯å…³é—­çš„ï¼Œä¹Ÿæ¨èå…³é—­ã€‚ç„¶åç‚¹å‡»ä¸‹ä¸€æ­¥ã€‚ è¿™é‡Œå…¶å®å°±å¯ä»¥é€‰æ‹©ä½ è¦è¿æ¥çš„å“ç‰Œäº†ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘å…ˆè·³è¿‡ï¼Œåé¢å†è®¾ç½®ã€‚ç›´æ¥ç‚¹å‡» å®Œæˆ å³å¯ okï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°äº†ï¼Œå®Œæˆä¹‹åï¼Œè¿›åˆ° HAç³»ç»Ÿ äº†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå†…ç½®äº†ä¸€ä¸ªè°·æ­Œçš„TTSçš„åŠŸèƒ½ï¼Œå¯ä»¥ä¸ç”¨ç†ä¼šï¼ˆè¿™ä¸ªæ˜¯è°·æ­Œæ¨å‡ºçš„ä¸€ä¸ªæ–‡æœ¬è½¬è¯­éŸ³çš„æœºå™¨å­¦ä¹ çš„åŠŸèƒ½ï¼‰ã€‚ HACS å®‰è£…Home Assistant Community Store ä¸ºç¤¾åŒºå»ºè®¾çš„HomeAssistantå•†åº—ï¼Œå¯ä»¥å®‰è£…ç¬¬ä¸‰æ–¹é›†æˆã€ä¸»é¢˜ã€è¡¨ç›˜ä»¥åŠè‡ªåŠ¨åŒ–ç­‰ã€‚ GitHub åœ°å€å¦‚ä¸‹: https://github.com/hacs https://github.com/hacs/integration å®‰è£…ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæŠŠèµ„æºç›®å½•æ•´ç†å¥½. 1234# å­˜æ”¾ç­‰ä¼šè¦å®‰è£…çš„ HACSæ–‡ä»¶mkdir -p ~/ha/custom_components/hacs# å­˜æ”¾æœªæ¥ HACS å®‰è£…çš„å„ç§é¦–é¡µç£è´´å•¥çš„ï¼ˆå®˜æ–¹å«Lovelace ï¼‰mkdir -p ~/ha/www æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥github çš„åœ°å€ https://github.com/hacs/integration/releases ï¼Œåœ¨è¿™é‡Œä¸‹è½½æœ€æ–°çš„hacsçš„releasesåŒ…ã€‚ è¿™é‡Œçœ‹è§ï¼Œæˆ‘å½“å‰çœ‹åˆ°çš„ç›®å‰çš„ç‰ˆæœ¬æ˜¯å»åˆ°äº† 1.32.1ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« å°†ä»¥ 1.32.1 ä¸ºä¾‹å­. ä¸‹è½½è¿™ä¸ª zip çš„å‹ç¼©åŒ…ï¼Œç„¶åè§£å‹åˆ° ~/ha/custom_components/hacs ç›®å½• ç»ˆç«¯å‘½ä»¤å¦‚ä¸‹ï¼š unzip ~/Downloads/hacs.zip -d ~/ha/custom_components/hacs è§£å‹åçš„æƒ…å†µå¦‚ä¸Šå›¾ã€‚ åœ¨è¿™é‡Œç‚¹å‡»å¼€å‘è€…å·¥å…·é¡µé¢ï¼Œç„¶åç‚¹å‡»æ£€æµ‹é…ç½®ã€‚ æ¥ä¸‹æ¥å°±å¯ä»¥çœ‹åˆ°æ£€æµ‹é€šè¿‡ï¼Œç„¶åæˆ‘ä»¬åœ¨åŒä¸€ä¸ªé¡µé¢ä¸­æ‰¾åˆ°é‡å¯æŒ‰é’®, å°±å¯ä»¥é‡å¯æˆ‘ä»¬çš„HAç³»ç»Ÿï¼Œè®©æ’ä»¶åŠ è½½ç”Ÿæ•ˆ. ç‚¹å‡»é‡å¯æŒ‰é’®ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ç³»ç»Ÿæ­£åœ¨é‡å¯ï¼Œç›®å‰å¤±å»äº†è¿æ¥. æ¥ç€ï¼Œæˆ‘ä»¬æ‰‹åŠ¨åˆ·æ–°ä¸€ä¸‹é¡µé¢ï¼Œç”¨æˆ·ç™»é™†å¤±æ•ˆäº†ï¼Œä»£è¡¨é‡å¯æˆåŠŸäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡æ–°ç™»é™†åˆ°æˆ‘ä»¬çš„HAç³»ç»Ÿï¼Œè¿™ä¸ªæ—¶å€™ï¼Œéœ€è¦è¾“å…¥æˆ‘ä»¬è®°ä¸‹æ¥çš„è´¦å·å¯†ç  ** æ¢å¦å¤–ä¸€ç§ ** æ–¹å¼å»å®‰è£…HACSä¹Ÿå¯ä»¥çš„ï¼Œç›´æ¥åœ¨dockerå®¹å™¨å†…éƒ¨å®‰è£…ï¼Œé€šè¿‡hacsè„šæœ¬è‡ªåŠ¨å®‰è£…ã€‚ 1docker exec -it homeassistant bash -c 'wget -q -O - https://install.hacs.xyz | bash -' å¯ä»¥çœ‹åˆ°ï¼Œç°åœ¨å®‰è£…å®Œæ¯•äº†ï¼Œæˆ‘éœ€è¦é‡å¯ç„¶åè®©æ’ä»¶åŠ è½½æˆåŠŸã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç‚¹å‡» é…ç½® ï¼Œæ‰¾åˆ° è®¾å¤‡ä¸æœåŠ¡ é¡¹ ç‚¹å‡» æ·»åŠ é›†æˆ æœç´¢ä¸€ä¸‹hacsï¼Œç„¶åæˆ‘ä»¬å°±èƒ½è¯†åˆ«åˆ°çš„åˆšæ‰å®‰è£…çš„hacsäº†ã€‚ è¿™é‡ŒæŠŠå…¨éƒ¨é€‰ä¸­ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œæ‰€ä»¥HAéœ€è¦ç¡®ä¿ä½ ä¼šæ’æŸ¥é—®é¢˜ã€‚æ‰€ä»¥éœ€è¦çœ‹ä½ æ˜¯å¦æ‡‚å¾—è¿™äº›ï¼Œä½ åªéœ€è¦å…¨é€‰äº†å³å¯. è¿™æ˜¯è®¾å¤‡æ³¨å†Œã€‚éœ€è¦å…ˆæ‹¥æœ‰Githubè´¦å·ï¼Œæ²¡æœ‰çš„è¯æ³¨å†Œä¸€ä¸ªå¹¶åœ¨æµè§ˆå™¨ä¸Šç™»å½•,github.com ç„¶åæ‰“å¼€ä¸Šé¢çš„æä¾›çš„è¿æ¥: https://github.com/login/device, è¾“å…¥æä¾›çš„ è®¾å¤‡ç  ç‚¹å‡» è´¦å·æˆæƒç»™ hacs æœåŠ¡ï¼Œå³å¯ã€‚ å›åˆ° HAç³»ç»Ÿï¼Œä¼šå‘ç°å·²ç»è¯†åˆ«åˆ°äº†ï¼Œæ‰€ä»¥å®Œæˆå®‰è£…äº† HACS ã€‚ homeassistant AppHAå®˜æ–¹æä¾›äº†APPï¼ŒiOSå’ŒAndroidéƒ½æœ‰ï¼Œå¯è‡ªè¡Œä¸‹è½½~ 12ios: https://www.github.com/home-assistant/iOSandroid: https://github.com/home-assistant/android å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œå»å„å¤§åº”ç”¨å•†åº—ä¸‹è½½ï¼Œä¾‹å¦‚ appstore æ¸©é¦¨æç¤ºï¼š Appéœ€è¦å¡«å…¥è‡ªå·±çš„HAåœ°å€ï¼Œæ‰€ä»¥å¦‚æœæœåŠ¡è·‘åœ¨å®¶é‡Œçš„è¯ï¼Œéœ€è¦å†…ç½‘ç©¿é€æˆ–è€…å…¬ç½‘æ‰èƒ½åœ¨å¤–é¢ä½¿ç”¨å™¢~ å¦‚æœHAå†…ç½‘ç©¿é€ï¼Œconfiguration.yamléœ€è¦åŠ ä¸Šä¸‹é¢å†…å®¹ï¼ŒåŒæ—¶å†…ç½‘ç©¿é€æœåŠ¡å™¨(å¦‚ngrokã€frpç­‰)çš„nginxéœ€è¦å¼€å¯websocketæ”¯æŒï¼Œå¦åˆ™ä¼šå‡ºç°å¤–ç½‘æ— æ³•è®¿é—®ã€èƒ½è®¿é—®ä½†æ˜¯æ— æ³•ç™»å½•ç­‰é—®é¢˜ã€‚ HAé…ç½®æ–‡ä»¶configuration.yaml 12345http: use_x_forwarded_for: True trusted_proxies: - 127.0.0.1/24 - ::1/128 nginxé…ç½®å‚è€ƒ(ç”¨frpå†…ç½‘ç©¿é€) 1234567891011121314server &#123; listen 80; server_name *.frp.yourdomain.cn frp.yourdomain.cn; location / &#123; proxy_redirect off; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # ä¸‹é¢ä¸¤è¡Œæä¾›websocketæ”¯æŒ,homeassistantéœ€è¦ proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection \"upgrade\"; proxy_pass http://127.0.0.1:8123; &#125;&#125; æœ€åé™„ä¸ŠåŒä¸€ä¸ªå±€åŸŸç½‘ä¸‹çš„è®¿é—®æ•ˆæœå›¾","categories":[{"name":"æ™ºèƒ½å®¶å±…","slug":"æ™ºèƒ½å®¶å±…","permalink":"http://blog.crazylaw.cn/categories/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/"}],"tags":[{"name":"æ™ºèƒ½å®¶å±…","slug":"æ™ºèƒ½å®¶å±…","permalink":"http://blog.crazylaw.cn/tags/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/"},{"name":"Home Assistant","slug":"Home-Assistant","permalink":"http://blog.crazylaw.cn/tags/Home-Assistant/"},{"name":"HA","slug":"HA","permalink":"http://blog.crazylaw.cn/tags/HA/"}]},{"title":"ã€å¤šåª’ä½“ã€‘- AACéŸ³é¢‘","slug":"å¤šåª’ä½“/aac","date":"2022-08-20T03:10:40.000Z","updated":"2022-08-20T16:00:19.452Z","comments":true,"path":"2022/08/20/å¤šåª’ä½“/aac/","link":"","permalink":"http://blog.crazylaw.cn/2022/08/20/%E5%A4%9A%E5%AA%92%E4%BD%93/aac/","excerpt":"å‰è¨€éŸ³é¢‘ä¸­çš„audioæœ‰å¾ˆå¤šæ ¼å¼ï¼Œåˆ†åˆ«æœ‰aac,mp3ç­‰ç­‰ åœ¨æµ·å¤–å¸‚åœºä¸­ï¼Œaacæ ¼å¼æ¯”è¾ƒæ™®éï¼Œæ‰€ä»¥æœ€è¿‘å¯¹å…¶è¿›è¡Œäº†ä¸€äº›ç ”ç©¶ã€‚","text":"å‰è¨€éŸ³é¢‘ä¸­çš„audioæœ‰å¾ˆå¤šæ ¼å¼ï¼Œåˆ†åˆ«æœ‰aac,mp3ç­‰ç­‰ åœ¨æµ·å¤–å¸‚åœºä¸­ï¼Œaacæ ¼å¼æ¯”è¾ƒæ™®éï¼Œæ‰€ä»¥æœ€è¿‘å¯¹å…¶è¿›è¡Œäº†ä¸€äº›ç ”ç©¶ã€‚ è¯´æ˜æ ¼å¼åè®®è§£ç id3v2adts","categories":[{"name":"å¤šåª’ä½“","slug":"å¤šåª’ä½“","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%9A%E5%AA%92%E4%BD%93/"}],"tags":[{"name":"aac","slug":"aac","permalink":"http://blog.crazylaw.cn/tags/aac/"}]},{"title":"å¤§æ•°æ®-sparkè§£ææ•°æ®å…¥åº“","slug":"å…¬å¸/å¤§æ•°æ®-sparkè§£ææ•°æ®å…¥åº“","date":"2022-06-08T10:52:40.000Z","updated":"2022-06-08T09:40:50.786Z","comments":true,"path":"2022/06/08/å…¬å¸/å¤§æ•°æ®-sparkè§£ææ•°æ®å…¥åº“/","link":"","permalink":"http://blog.crazylaw.cn/2022/06/08/%E5%85%AC%E5%8F%B8/%E5%A4%A7%E6%95%B0%E6%8D%AE-spark%E8%A7%A3%E6%9E%90%E6%95%B0%E6%8D%AE%E5%85%A5%E5%BA%93/","excerpt":"å‰è¨€æœ€è¿‘åœ¨å¤„ç†åŸå§‹æ—¥å¿—å…¥åº“çš„æ“ä½œï¼Œç”±äºè¿™ä¸ªä¸æ˜¯ä¸€ä¸ªå¸¸æ€åŒ–çš„éœ€æ±‚ï¼Œæ˜¯ä¸€äº›æ—¥å¿—çš„æ•°æ®ï¼Œæ‰€ä»¥å’Œæˆ‘ä»¬å¸¸è§„çš„æ—¥å¿—å­˜å‚¨ä¸åŒï¼Œä¸ç»è¿‡textæ•°æ®çš„å­˜å‚¨ï¼Œç›´æ¥å­˜å‚¨ä¸ºorcçš„æ ¼å¼ã€‚ å¹¶ä¸”ä»¥å¾€è§£æéƒ½æ˜¯é€šè¿‡javaçš„hadoopçš„map-reduceçš„apiçš„å»æ“ä½œè§£ææ•°æ®ï¼Œè¿™æ¬¡é‡‡ç”¨sparkæ¥å¯¹æ•°æ®è¿›è¡Œè§£æï¼Œæé«˜è§£æçš„é€Ÿåº¦ã€‚","text":"å‰è¨€æœ€è¿‘åœ¨å¤„ç†åŸå§‹æ—¥å¿—å…¥åº“çš„æ“ä½œï¼Œç”±äºè¿™ä¸ªä¸æ˜¯ä¸€ä¸ªå¸¸æ€åŒ–çš„éœ€æ±‚ï¼Œæ˜¯ä¸€äº›æ—¥å¿—çš„æ•°æ®ï¼Œæ‰€ä»¥å’Œæˆ‘ä»¬å¸¸è§„çš„æ—¥å¿—å­˜å‚¨ä¸åŒï¼Œä¸ç»è¿‡textæ•°æ®çš„å­˜å‚¨ï¼Œç›´æ¥å­˜å‚¨ä¸ºorcçš„æ ¼å¼ã€‚ å¹¶ä¸”ä»¥å¾€è§£æéƒ½æ˜¯é€šè¿‡javaçš„hadoopçš„map-reduceçš„apiçš„å»æ“ä½œè§£ææ•°æ®ï¼Œè¿™æ¬¡é‡‡ç”¨sparkæ¥å¯¹æ•°æ®è¿›è¡Œè§£æï¼Œæé«˜è§£æçš„é€Ÿåº¦ã€‚ parse_s2s123456789101112131415161718192021222324252627282930313233343536373839404142#!/bin/bashsource ./config.shyyyy=$(echo $&#123;yyyy_mm_dd_hh&#125; | awk -F- '&#123;print $1&#125;')mm=$(echo $&#123;yyyy_mm_dd_hh&#125; | awk -F- '&#123;print $2&#125;')dd=$(echo $&#123;yyyy_mm_dd_hh&#125; | awk -F- '&#123;print $3&#125;')hh=$(echo $&#123;yyyy_mm_dd_hh&#125; | awk -F- '&#123;print $4&#125;')# æ‰€æœ‰åœ°åŒºï¼Œä¾‹å¦‚singaporearea='*'if [[ ! $&#123;is_day&#125; == \"0\" ]];then hh='*'fiinput_path=\"$&#123;LOG_TRACKING_S2S_PATH&#125;/$&#123;yyyy&#125;/$&#123;mm&#125;/$&#123;dd&#125;/$&#123;hh&#125;/$&#123;area&#125;/\"output_path=\"$&#123;HIVE_DB_PATH&#125;/$&#123;T_UPARPU_S2S&#125;/\"dt=$&#123;yyyy_mm_dd_hh&#125;if [[ ! $&#123;is_day&#125; == \"0\" ]];then dt=$&#123;yyyy_mm_dd&#125;fispark-submit --class com.xx.spark.jobs.parse.S2sParsingJob \\ --name \"xx_S2sParsingJob_dt$&#123;dt&#125;\" \\ --master yarn \\ --deploy-mode cluster \\ --executor-memory \"$&#123;SPARK_EXECUTOR_MEMORY&#125;\" \\ --driver-memory \"$&#123;SPARK_DRIVER_MEMORY&#125;\" \\ --executor-cores 2 \\ --num-executors \"$&#123;SPARK_NUM_EXECUTORS&#125;\" \\ --conf spark.dynamicAllocation.enabled=false \\ --conf spark.dynamicAllocation.minExecutors=8 \\ --conf spark.dynamicAllocation.maxExecutors=32 \\ --conf spark.core.connection.ack.wait.timeout=3000 \\ --files \"$&#123;HIVE_SITE_PATH&#125;\" \\ $&#123;SPARK_SQL_JAR&#125; \"$&#123;CLIENT_TMP_LOG_PATH&#125;\" \"$&#123;dt&#125;\" \"$&#123;input_path&#125;\" \"$&#123;output_path&#125;\"hive -e \" use $&#123;DB_UPARPU&#125;; MSCK REPAIR TABLE $&#123;T_UPARPU_S2S&#125;;\" è„šæœ¬å¾ˆç®€å•ï¼Œåªæ˜¯ä¸€äº›å‚æ•°çš„è°ƒæ•´ä»¥åŠæ•°æ®å†™å…¥åˆ°ossåï¼Œå¯¹hiveçš„æ•°æ®è¿›è¡Œå¯ä»¥é‡æ–°ä¿®å¤åˆ†åŒºçš„è¡Œä¸ºã€‚ S2sParsingJobæˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹è¿™ä¸ªå’Œsparkç›¸å…³çš„scalaä»¥åŠjavaçš„ä»£ç éƒ¨åˆ†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109package com.xx.spark.jobs.parseimport com.xx.spark.beans.S2sBeanimport com.xx.spark.json.S2sParsingimport org.apache.spark.sql.types.&#123;StringType, StructType&#125;import org.apache.spark.sql.&#123;Row, SaveMode, SparkSession&#125;import org.apache.spark.sql.types.StructFieldobject S2sParsingJob &#123; def main(args: Array[String]): Unit = &#123; val tmpPath = args(0) val dt = args(1) val inputPath = args(2) var outputPath = args(3) val spark: SparkSession = SparkSession.builder .master(\"yarn\") // avoid hardcoding the deployment environment .enableHiveSupport() // self-explanatory, isn't it? .config(\"spark.sql.warehouse.dir\", tmpPath) .getOrCreate() val lineRDD = spark.sparkContext.textFile(inputPath) val beans = lineRDD .map(line =&gt; S2sParsing.map(line)) val dts = dt.split(\"-\") var yyyy = \"0000\" var mm = \"00\" var dd = \"00\" var hh = \"25\" yyyy = if (dts.nonEmpty) &#123; dts(0) &#125; else &#123; \"0000\" &#125; mm = if (dts.length &gt; 1) &#123; dts(1) &#125; else &#123; \"00\" &#125; dd = if (dts.length &gt; 2) &#123; dts(2) &#125; else &#123; \"00\" &#125; hh = if (dts.length &gt; 3) &#123; dts(3) &#125; else &#123; \"25\" &#125; outputPath = dts.length match &#123; case 1 =&gt; outputPath + \"/yyyy=\" + yyyy case 2 =&gt; outputPath + \"/yyyy=\" + yyyy + \"/mm=\" + mm case 3 =&gt; outputPath + \"/yyyy=\" + yyyy + \"/mm=\" + mm + \"/dd=\" + dd case 4 =&gt; outputPath + \"/yyyy=\" + yyyy + \"/mm=\" + mm + \"/dd=\" + dd + \"/hh=\" + hh &#125; val values = beans.map(bean =&gt; S2sBean.transfer(bean)) // ä¸ä¾èµ–timeè§£æï¼Œé‡ç½®åˆ†åŒºå±æ€§ // å¦‚æœä¼ é€’çš„æ˜¯2022-06-08ï¼Œé‚£ä¹ˆhhçš„åˆ†åŒºç”±timeè§£æè·å¾— .map(bean =&gt; &#123; if (dts.length &gt; 3) &#123; bean.hh = hh &#125; if (dts.length &gt; 2) &#123; bean.dd = dd &#125; if (dts.length &gt; 1) &#123; bean.mm = mm &#125; if (dts.nonEmpty) &#123; bean.yyyy = yyyy &#125; bean &#125;) .map(bean =&gt; S2sParsing.extractValueToArray(bean)) val fields = S2sParsing.extractKeyToArray(beans.first()) .map(fieldName =&gt; StructField(fieldName, StringType, nullable = true)) val schema = StructType(fields) val requiredNumberOfFields = schema.fieldNames.length val rowRDD = values.map(line =&gt; &#123; Row.fromSeq(appendDummyData(line, requiredNumberOfFields).toSeq) &#125;) val lineDF = spark.createDataFrame(rowRDD, schema) // lineDF.show() val partition = S2sBean.getPartitionBy(dts.length) lineDF.write .partitionBy(partition: _*) .mode(SaveMode.Overwrite) .option(\"orc.compress\", \"zlib\") .orc(outputPath) spark.stop() &#125; def appendDummyData(row: Array[String], len: Int): Array[String] = row.length == len match &#123; case true =&gt; row case false =&gt; if (len &gt; row.length) &#123; val add = (for (loop &lt;- 1 to len - row.length) yield \"unknow\").toArray row ++ add &#125; else row.take(len) &#125;&#125; è¿™ä¸€æ®µçš„scalaä»£ç ä¹Ÿæ¯”è¾ƒç®€æ´ï¼Œä¸»è¦æ¶‰åŠåˆ°å‡ ä¸ªå‚æ•° ä¸´æ—¶ç›®å½•è·¯å¾„ æ—¥æœŸæ—¶é—´ æ•°æ®æºçš„è·¯å¾„ æ¸…æ´—åæ•°æ®è¾“å‡ºè·¯å¾„ æœ‰æ„æ€çš„æ˜¯ï¼Œè¿™é‡Œçœ‹åˆ°æœ‰ä¸€ä¸ªappendDummyDataçš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ç”¨äºå¯¹æ¯”schema.fieldNames.lengthç”¨åˆ°ï¼Œå½“ä»javabeanä¸­æå–çš„fieldsä¸ªæ•°å’Œvaluesä¸ªæ•°ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç»™æˆ‘ä»¬å¯¹é½æ•°æ®é‡ï¼Œé˜²æ­¢ç¨‹åºæŠ¥é”™ï¼Œå¦‚æœæ•°æ®å°‘äº†ï¼Œåˆ™è¿½åŠ unknowå€¼ï¼Œå¦‚æœæ•°æ®å¤šäº†ï¼Œåˆ™è¿½åŠ æœ€åä¸€ä¸ªå…ƒç´ çš„å€¼ã€‚ å…¶æ¬¡ï¼Œæˆ‘ä»¬çœ‹åˆ°ä»¥ä¸‹ä¸€æ®µä»£ç ï¼š 123val partition = S2sBean.getPartitionBy(dts.length) lineDF.write .partitionBy(partition: _*) è¿™ä¸€éƒ¨åˆ†çš„ä»£ç ï¼Œæ˜¯ç”¨äºè·å–partitionåˆ†åŒºç”¨çš„ï¼Œé€šè¿‡dtsçš„é•¿åº¦ï¼Œæˆ‘ä»¬è°ƒæ•´äº†outputçš„è·¯å¾„å’Œåˆ†åŒºçš„ä¿¡æ¯ï¼Œåšåˆ°äº†ä¸ç®¡æ˜¯è·‘ä¸€å¤©çš„æ•°æ®ï¼Œè¿˜æ˜¯è·‘æ¯ä¸ªå°æ—¶çš„æ•°æ®ï¼Œéƒ½ç¡®ä¿äº†æ— å…³çš„æ•°æ®ä¸ä¼šè¢«åˆ é™¤æ‰ã€‚ å¹¶ä¸”é€šè¿‡scalaçš„å¯å˜å‚æ•°è¯­æ³• :_*ï¼Œå¯¹ String* è¿™ç§å‚æ•°è¿›è¡ŒåŠ¨æ€ä¼ å‚ï¼Œä»è€Œå®ç°äº†ä»£ç çš„ç®€æ´æ€§æ“ä½œã€‚ å¦å¤–ï¼Œæ¥ä¸‹é‡Œï¼Œæœ€æ ¸å¿ƒçš„å…¶å®è¿˜æ˜¯æˆ‘ä»¬çš„javabean S2sBean123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173public class S2sBean extends AbstractExtract implements java.io.Serializable &#123; public String time; public CommonBean common; public DataBean data; public String callbackUrl; public String yyyy; public String mm; public String dd; public String hh; public static S2sBean transfer(S2sBean s2sBean) &#123; if (s2sBean.time == null) &#123; s2sBean.time = \"0\"; &#125; SimpleDateFormat reformat = new SimpleDateFormat(\"yyyy MM dd HH\"); reformat.setTimeZone(TimeZone.getTimeZone(\"Asia/Shanghai\")); String formatDate = reformat.format(new Date(Integer.parseInt(s2sBean.time) * 1000L)); String[] DateArr = formatDate.split(\" \"); s2sBean.yyyy = DateArr[0]; s2sBean.mm = DateArr[1]; s2sBean.dd = DateArr[2]; s2sBean.hh = DateArr[3]; return s2sBean; &#125; public static String[] getPartitionBy() &#123; return new String[]&#123;\"yyyy\", \"mm\", \"dd\", \"hh\"&#125;; &#125; public static String[] getPartitionBy(int offset) &#123; String[] partitions = new String[]&#123;\"yyyy\", \"mm\", \"dd\", \"hh\"&#125;; ArrayList&lt;String&gt; partitionList = new ArrayList&lt;&gt;(Arrays.asList(partitions)); while (offset &gt; 0) &#123; partitionList.remove(0); offset--; &#125; String[] newPartition = new String[partitionList.size()]; partitionList.toArray(newPartition); return newPartition; &#125;&#125;class CommonBean extends AbstractExtract implements java.io.Serializable &#123; public static class CustomBean extends AbstractExtract implements java.io.Serializable &#123; public String userCustomData; public String userId; &#125; public String appId; public String system; public String platform; public String osVn; public String osVc; public String packageName; public String appVn; public String appVc; public String brand; public String model; public String screen; public String networkType; public String mnc; public String mcc; public String language; public String timezone; public String sdkVer; public String gpVer; public String ua; public String orient; public String upid; public String androidId; public String gaid; public String gdprCs; public String isCnSdk; public String itSrc; public String abtestId; public String firstInitTime; public String daysFromFirstInit; public CustomBean custom;&#125;class DataBean extends AbstractExtract implements java.io.Serializable &#123; public String plId; public String reqId; public String showId; public String unitId; public String nwFirmId; public String scenarioId; public String rvStartTs; public String rCallbackTs; public String rvPlayDur; public String currTs; public String ilrd;&#125;abstract class AbstractExtract &#123; public static &lt;T&gt; ArrayList&lt;String&gt; extractValue(T bean) &#123; ArrayList&lt;String&gt; rs = new ArrayList&lt;&gt;(); try &#123; Class&lt;?&gt; c = bean.getClass(); Field[] fields = c.getDeclaredFields(); for (Field f : fields) &#123; f.setAccessible(true); Object oo = f.get(bean); if (oo == null) &#123; if (f.getType().getName().contains(\"xx\")) &#123; Class&lt;?&gt; clazz = Class.forName(f.getType().getName()); oo = clazz.getDeclaredConstructor().newInstance(); &#125; else &#123; oo = \"\"; &#125; &#125; if (oo.getClass().getSuperclass().getName().equals(Thread.currentThread().getStackTrace()[1].getClassName())) &#123; try &#123; Method method = oo.getClass().getSuperclass().getDeclaredMethod(Thread.currentThread().getStackTrace()[1].getMethodName(), Object.class); rs.addAll((ArrayList&lt;String&gt;) method.invoke(oo, oo)); &#125; catch (NoSuchMethodException | InvocationTargetException e) &#123; e.printStackTrace(); &#125; &#125; else &#123; rs.add((String) oo); &#125; &#125; &#125; catch (IllegalAccessException | ClassNotFoundException | InstantiationException | NoSuchMethodException | InvocationTargetException e) &#123; e.printStackTrace(); &#125; return rs; &#125; public static &lt;T&gt; ArrayList&lt;String&gt; extractKey(T bean) &#123; ArrayList&lt;String&gt; rs = new ArrayList&lt;&gt;(); try &#123; Class&lt;?&gt; c = bean.getClass(); Field[] fields = c.getDeclaredFields(); for (Field f : fields) &#123; f.setAccessible(true); Object o = f.get(bean); if (o == null) &#123; if (f.getType().getName().contains(\"topon\")) &#123; Class&lt;?&gt; clazz = Class.forName(f.getType().getName()); o = clazz.getDeclaredConstructor().newInstance(); &#125; else &#123; o = \"\"; &#125; &#125; if (o.getClass().getSuperclass().getName().equals(Thread.currentThread().getStackTrace()[1].getClassName())) &#123; try &#123; Method method = o.getClass().getSuperclass().getDeclaredMethod(Thread.currentThread().getStackTrace()[1].getMethodName(), Object.class); rs.addAll((ArrayList&lt;String&gt;) method.invoke(o, o)); &#125; catch (NoSuchMethodException | InvocationTargetException e) &#123; e.printStackTrace(); &#125; &#125; else &#123; rs.add(StrUtil.camelToSnake(f.getName())); &#125; &#125; &#125; catch (IllegalAccessException | ClassNotFoundException | NoSuchMethodException | InstantiationException | InvocationTargetException e) &#123; e.printStackTrace(); &#125; return rs; &#125; public String toString() &#123; return com.alibaba.fastjson.JSON.toJSONString(this); &#125;&#125; æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ­£å¸¸åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä¸€ä¸ªbeanå¯¹è±¡å…¶å®å°±æ˜¯ä¸€ä¸ªæ•°æ®è½½ä½“ï¼Œä»–åŒ…å«äº†å¿…è¦çš„æ•°æ®å­—æ®µï¼Œå¹¶ä¸”æˆ‘ä»¬çš„æ—¥å¿—ä¸€èˆ¬å¤šä¸ºç»“æ„åŒ–çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œçš„javaBean é€šè¿‡å®ç°å¯¹åº”çš„ç»“æ„åŒ–ï¼Œé€šè¿‡json çš„è½¬åŒ–ï¼Œå¯ä»¥å¿«é€Ÿçš„å®åŠ›åŒ–javabeanï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬å­˜å‚¨æ•°æ®çš„æ—¶å€™ï¼Œéƒ½æ˜¯ä¸€ç»´æ•°æ®ï¼Œæ‰€ä»¥ï¼Œéœ€è¦å¯¹æ•°æ®è¿›è¡Œæ‰å¹³åŒ–å¤„ç†ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªéœ€è¦ç®€å•çš„æå–å‡ºæ¥å³å¯ï¼Œä¸éœ€è¦åŠ ä»»ä½•çš„å‰ç¼€ï¼Œæ‰€ä»¥è¿™é‡Œæ²¡æœ‰åšè¿‡å¤šçš„ç‰¹æ®Šå¤„ç†ã€‚ æˆ‘ä»¬ä¸»è¦è§‚çœ‹abstract class AbstractExtractï¼Œé€šè¿‡è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬é€šè¿‡ extractValue() , extractKey()ï¼Œå¯ä»¥æ‹¿åˆ°javabeanä¸‹çš„æ‰€æœ‰å±æ€§å’Œæ‰€æœ‰å±æ€§å€¼ã€‚è¯¥æ–¹æ³•çš„åŸç†æ˜¯é€šè¿‡javaçš„åå°„å’Œé€’å½’å®ç°çš„ï¼Œå’Œæˆ‘ä»¥å‰å®ç°çš„kafka-swooleçš„åè®®å®ç°å·®ä¸å¤šæ€è·¯ã€‚ä½†æ˜¯åœ¨è¿™é‡Œæ›´é‡è¦çš„ä¸€ä¸ªåŸå› æ˜¯å› ä¸ºæˆ‘ä¸æƒ³å†™å¤ªå¤šé‡å¤çš„å­—æ®µï¼Œæˆ‘è§‰å¾—é‚£äº›å­—æ®µåœ¨ä»£ç å±‚é¢ä¸Šï¼Œéƒ½åº”è¯¥åªå†™ä¸€æ¬¡æ‰åˆç†ï¼Œå¦‚æœé‡å¤å†™äº†æˆ–è€…ç›´æ¥é€šè¿‡é™æ€ä»£ç å†™æ­»çš„æ–¹å¼ï¼Œåœ¨åç»­æƒ³ä¿®æ”¹ä»£ç æ˜¯å¾ˆéº»çƒ¦çš„ä¸€ä¸ªäº‹æƒ…ï¼Œæ‰€ä»¥é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåç»­ä¸ç®¡æ˜¯å¦éœ€è¦åŠ å­—æ®µå»è§£æï¼Œæˆ‘éƒ½åªéœ€è¦æ‰¾åˆ°å¯¹åº”çš„ç»“æ„ä½“ä¸‹çš„ç±»ï¼Œæ·»åŠ æˆ–è€…åˆ é™¤ä¸€ä¸ªå­—æ®µå³å¯ï¼Œä¸ºåç»­çš„å¤§å¤§å‡å°‘çš„å·¥ä½œé‡è€Œè€ƒè™‘ã€‚ ç»è¿‡æµ‹è¯•ï¼Œé€šè¿‡sparkè§£ææ•°æ®å†åˆ°å†™å…¥orcå’Œåˆ†åŒºå¤„ç†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¤„ç†2kä¸‡æ¡ï¼ˆæ¯æ¡æ•°æ®å¤§æ¦‚åœ¨3.3kbï¼‰çš„æ•°æ®å¤§æ¦‚éœ€è¦10åˆ†é’Ÿå³å¯ã€‚æ‰€ä»¥å¤„ç†æ•°æ®çš„ä¸€ä¸ªtpsæ˜¯åœ¨33k/så·¦å³ã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"å…¬å¸","slug":"å…¬å¸","permalink":"http://blog.crazylaw.cn/tags/%E5%85%AC%E5%8F%B8/"}]},{"title":"å¤§æ•°æ®ä»»åŠ¡-dau-deuä»»åŠ¡","slug":"å…¬å¸/å¤§æ•°æ®-dau-deuä»»åŠ¡","date":"2022-05-27T10:52:40.000Z","updated":"2022-06-08T09:16:06.844Z","comments":true,"path":"2022/05/27/å…¬å¸/å¤§æ•°æ®-dau-deuä»»åŠ¡/","link":"","permalink":"http://blog.crazylaw.cn/2022/05/27/%E5%85%AC%E5%8F%B8/%E5%A4%A7%E6%95%B0%E6%8D%AE-dau-deu%E4%BB%BB%E5%8A%A1/","excerpt":"å‰è¨€æ€»ç»“ä¸€ä¸‹å…¬å¸å¤§æ•°æ®çš„ä»»åŠ¡ETLç¦»çº¿å·¥ä½œæµ - dau-deuä»»åŠ¡","text":"å‰è¨€æ€»ç»“ä¸€ä¸‹å…¬å¸å¤§æ•°æ®çš„ä»»åŠ¡ETLç¦»çº¿å·¥ä½œæµ - dau-deuä»»åŠ¡ å…¬å¸çš„ETLæœåŠ¡ï¼Œç›®å‰é‡‡ç”¨çš„æ˜¯ç»„ä»¶ä¸ºï¼š æ•°ä»“ (hadoop) ä»»åŠ¡è°ƒåº¦å™¨ (azkaban) å‡ºä»“ (gp) æ•°ä»“æŸ¥è¯¢ (hue)(hive)(spark)","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"å…¬å¸","slug":"å…¬å¸","permalink":"http://blog.crazylaw.cn/tags/%E5%85%AC%E5%8F%B8/"}]},{"title":"å¤§æ•°æ®ä»»åŠ¡-é‡åˆ†é…ä»»åŠ¡","slug":"å…¬å¸/å¤§æ•°æ®-é‡åˆ†é…ä»»åŠ¡","date":"2022-05-27T10:52:40.000Z","updated":"2022-05-27T11:12:44.819Z","comments":true,"path":"2022/05/27/å…¬å¸/å¤§æ•°æ®-é‡åˆ†é…ä»»åŠ¡/","link":"","permalink":"http://blog.crazylaw.cn/2022/05/27/%E5%85%AC%E5%8F%B8/%E5%A4%A7%E6%95%B0%E6%8D%AE-%E9%87%8D%E5%88%86%E9%85%8D%E4%BB%BB%E5%8A%A1/","excerpt":"å‰è¨€æ€»ç»“ä¸€ä¸‹å…¬å¸å¤§æ•°æ®çš„ä»»åŠ¡ETLç¦»çº¿å·¥ä½œæµ - é‡åˆ†é…ä»»åŠ¡","text":"å‰è¨€æ€»ç»“ä¸€ä¸‹å…¬å¸å¤§æ•°æ®çš„ä»»åŠ¡ETLç¦»çº¿å·¥ä½œæµ - é‡åˆ†é…ä»»åŠ¡ å…¬å¸çš„ETLæœåŠ¡ï¼Œç›®å‰é‡‡ç”¨çš„æ˜¯ç»„ä»¶ä¸ºï¼š æ•°ä»“ (hadoop) ä»»åŠ¡è°ƒåº¦å™¨ (azkaban) å‡ºä»“ (gp) æ•°ä»“æŸ¥è¯¢ (hue)(hive)(spark) job_tk_reassignï¼ˆé‡åˆ†é…ä»»åŠ¡ï¼‰ schedule: 30 10 * * * æŒ‰ å¤© ä¸ºä¸€ä¸ªå‘¨æœŸ å¤©çº§æŒ‡æ ‡ï¼š isready isready_success showfailed æ‰€ä»¥åœ¨æŸ¥çœ‹æŠ¥è¡¨æ•°æ®çš„æ—¶å€™ï¼Œè¿™3ä¸ªæŒ‡æ ‡æ˜¯å¤©çº§çš„ã€‚ é™¤äº†ä¸Šé¢æ‰€è¯´çš„ï¼Œä»£ç ä¹ŸåŒ…å«äº†source_type = 2ï¼Œå³å®æ—¶çš„æ•°æ®ã€‚ä½†æ˜¯ç›®å‰æ¥è¯´ï¼Œå·²ç»æ²¡æœ‰source_type=2çš„æ•°æ®äº†ï¼Œä¸»è¦æ˜¯ä¸šåŠ¡å¯¼å‘ã€‚ sync_mysql_unit_and_placement æ‹‰å–æœ€æ–°çš„å¹¿å‘Šä½æ•°æ® 12345678910111213141516171819202122232425262728293031323334353637383940414243444546stat_source='placement'tmpfilename=\"tmp/uparpu_mysql_placement.log\"mkdir -p tmpif [ -f \"$&#123;tmpfilename&#125;\" ]; then rm -f $&#123;tmpfilename&#125; echo \"delete $&#123;tmpfilename&#125;\"fimysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e \" select id, uuid, publisher_id, app_id, name, format, remark, create_time, update_time from $&#123;DB_NAME&#125;.$&#123;stat_source&#125; ;\" --skip-column-names | sed 's/\\t/|/g' &gt;$&#123;tmpfilename&#125;if [ -f \"$&#123;tmpfilename&#125;\" ]; then target=\"$&#123;HIVE_DB_PATH&#125;/$&#123;T_UPARPU_PLACEMENT&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/\" hadoop fs -rm -r $&#123;target&#125; $&#123;FILE_COMMAND_CP&#125; $&#123;tmpfilename&#125; $&#123;target&#125; hive -e \" use $&#123;DB_UPARPU&#125;; alter table $&#123;T_UPARPU_PLACEMENT&#125; drop partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;'); alter table $&#123;T_UPARPU_PLACEMENT&#125; add partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;') location 'yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;'; \" echo \"sync $&#123;tmpfilename&#125; to $&#123;target&#125;\"fi ä»mysqlæŠŠå‡ºæœ€æ–°çš„å¹¿å‘Šä½æ•°æ®ï¼Œç„¶ååŒæ­¥åˆ°å¯¹åº”çš„hiveè¡¨ä¸­ merge_isready ç»Ÿè®¡isreadyçš„æ•°æ® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196#æ¸…æ´—isreadyæ•°æ®ï¼Œå†™å…¥report_tk,dt&amp;dimen=15hourGap=0date_time_timeStamp=$(date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00\" +%s)next_date_time_timeStamp=$(expr $&#123;date_time_timeStamp&#125; + 86400)next_date_time=$(date -d @$&#123;next_date_time_timeStamp&#125; \"+%Y-%m-%d\")where_dt=\"dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;'\"if [[ $&#123;run_type&#125; = 'utc0' ]]; then hourGap=8 where_dt=\"dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')\"else if [[ $&#123;run_type&#125; = 'utcw8' ]]; then hourGap=16 where_dt=\"dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')\" else hourGap=0 fifi#è½¬æ¢æˆutc8æ—¶é—´day_start_timeStamp=$(date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00\" +%s)day_end_timeStamp=$(date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 23:00:00\" +%s)while_run_stamp=$&#123;day_start_timeStamp&#125;where_hour='('while [ \"$&#123;while_run_stamp&#125;\" -le \"$&#123;day_end_timeStamp&#125;\" ]; do tmp_run_stamp=$(expr $&#123;while_run_stamp&#125; + $&#123;hourGap&#125; \\* 3600) tmp_date_time=$(date -d @$&#123;tmp_run_stamp&#125; \"+%Y-%m-%d-%H\") tmp_yyyy=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $1&#125;') tmp_mm=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $2&#125;') tmp_dd=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $3&#125;') tmp_hh=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $4&#125;') if [ \"$&#123;while_run_stamp&#125;\" == \"$&#123;day_start_timeStamp&#125;\" ]; then where_hour=\"$&#123;where_hour&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'\" else where_hour=\"$&#123;where_hour&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'\" fi while_run_stamp=$(expr $&#123;while_run_stamp&#125; + 3600)donewhere_hour=\"$&#123;where_hour&#125;)\"hql=\" select '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;', case when (c.nw_firm_id is null) then '0' else c.nw_firm_id end, case when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end, case c.nw_firm_id when '35' then '1' else case when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end, 1, a.sdk_version, a.app_vn, a.os_platform, a.geo_short, a.publisher_id, a.app_raw_id, b.id, b.format, 0, 0, 0, 0, 0, 0, 0, 0, 0, case when (a.channel is null) then '' else a.channel end, case when (a.sub_channel is null) then '' else a.sub_channel end, 0, 0, 0, 0, case when (c.network_id is null) then '0' else c.network_id end, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, 0, 0, 0, 0, 0, 0, 1, 0, '', 0, 0, 0, case when (a.is_cn_sdk is null or cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end, cast(sum(case when (a.key_count is null or a.key_count='') then 0 else a.key_count end) as bigint), 0, 0, case when device_type is null then 1 else device_type end, 0, 0, 0, 0, 0, 0, case when abtest_id is null then '' else abtest_id end, 0 from ( select nw_firm_id, group_id, unit_id, placement_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_raw_id, channel, sub_channel, traffic_group_id, is_cn_sdk, device_type, abtest_id, cast(sum(case when (key_count is null or key_count='') then 0 else key_count end) as bigint) key_count from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_EVENT_ANALYSIS_COUNT&#125; where $&#123;where_dt&#125; and key='1004632' and $&#123;where_hour&#125; $&#123;whereInPublisherList&#125; group by nw_firm_id, group_id, unit_id, placement_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_raw_id, channel, sub_channel, traffic_group_id, is_cn_sdk, device_type, abtest_id ) as a left outer join ( select id,uuid,app_id,format from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_PLACEMENT&#125; where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125; group by id,uuid,app_id,format ) as b on a.placement_id=b.uuid and a.app_raw_id=b.app_id left outer join ( select id,network_id,nw_firm_id from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_UNIT&#125; where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125; ) as c on a.unit_id=c.id where cast(a.group_id as bigint)&lt;=2147483647 and b.uuid is not null group by case when (c.nw_firm_id is null) then '0' else c.nw_firm_id end, case when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end, case c.nw_firm_id when '35' then '1' else case when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end, a.sdk_version, a.app_vn, a.os_platform, a.geo_short, a.publisher_id, a.app_raw_id, b.id, b.format, case when (a.channel is null) then '' else a.channel end, case when (a.sub_channel is null) then '' else a.sub_channel end, case when (c.network_id is null) then '0' else c.network_id end, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, case when (a.is_cn_sdk is null or cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end, case when device_type is null then 1 else device_type end, case when abtest_id is null then '' else abtest_id end\"spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \\ --name \"TopOn_CommonSparkDateTimeJob_report_isready_dt$&#123;yyyy_mm_dd&#125;\" \\ --master yarn \\ --deploy-mode cluster \\ --executor-memory \"$&#123;SPARK_EXECUTOR_MEMORY&#125;\" \\ --driver-memory \"$&#123;SPARK_DRIVER_MEMORY&#125;\" \\ --executor-cores 2 \\ --num-executors \"$&#123;SPARK_NUM_EXECUTORS&#125;\" \\ --conf spark.dynamicAllocation.enabled=false \\ --conf spark.dynamicAllocation.minExecutors=32 \\ --conf spark.dynamicAllocation.maxExecutors=64 \\ --conf spark.core.connection.ack.wait.timeout=300 \\ $&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_PATH&#125; \"$&#123;yyyy_mm_dd&#125;\" \"$&#123;hql&#125;\" \"$&#123;DB_UPARPU&#125;.$&#123;T_RUN_REASSIGN_REPORT_TK&#125;\" \"dt='$&#123;ymd&#125;', dimen='15'\" \"overwrite\" key=&#39;1004632&#39; çš„æ•°æ®ä¸ºisreadyçš„æ•°æ® ç”±äºåŸå§‹æ•°æ®å·²ç»æœ‰ç»Ÿè®¡ï¼Œæ‰€ä»¥sum(key_count)çš„æ€»å’Œå°±æ˜¯isreadyçš„å¯¹åº”ç»´åº¦çš„æ€»æ•° æ•°æ®å†™å…¥åˆ° dimen = &#39;15&#39; çš„åˆ†åŒº merge_isready_success ç»Ÿè®¡isready_successçš„æ•°æ® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202#æ¸…æ´—isready_successæ•°æ®ï¼Œå†™å…¥report_tk,dt&amp;dimen=16hourGap=0date_time_timeStamp=`date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00\" +%s`next_date_time_timeStamp=`expr $&#123;date_time_timeStamp&#125; + 86400`next_date_time=`date -d @$&#123;next_date_time_timeStamp&#125; \"+%Y-%m-%d\"`where_dt=\"dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;'\"if [[ $&#123;run_type&#125; = 'utc0' ]] then hourGap=8 where_dt=\"dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')\" else if [[ $&#123;run_type&#125; = 'utcw8' ]] then hourGap=16 where_dt=\"dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')\" else hourGap=0 fifi#è½¬æ¢æˆutc8æ—¶é—´day_start_timeStamp=`date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00\" +%s`day_end_timeStamp=`date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 23:00:00\" +%s`while_run_stamp=$&#123;day_start_timeStamp&#125;where_hour='('while [ \"$&#123;while_run_stamp&#125;\" -le \"$&#123;day_end_timeStamp&#125;\" ]do tmp_run_stamp=`expr $&#123;while_run_stamp&#125; + $&#123;hourGap&#125; \\* 3600` tmp_date_time=`date -d @$&#123;tmp_run_stamp&#125; \"+%Y-%m-%d-%H\"` tmp_yyyy=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $1&#125;'` tmp_mm=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $2&#125;'` tmp_dd=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $3&#125;'` tmp_hh=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $4&#125;'` if [ \"$&#123;while_run_stamp&#125;\" == \"$&#123;day_start_timeStamp&#125;\" ] then where_hour=\"$&#123;where_hour&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'\" else where_hour=\"$&#123;where_hour&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'\" fi while_run_stamp=`expr $&#123;while_run_stamp&#125; + 3600`donewhere_hour=\"$&#123;where_hour&#125;)\"hql=\" select '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;', case when (c.nw_firm_id is null) then '0' else c.nw_firm_id end, case when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end, case c.nw_firm_id when '35' then '1' else case when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end, 1, a.sdk_version, a.app_vn, a.os_platform, a.geo_short, a.publisher_id, a.app_raw_id, b.id, b.format, 0, 0, 0, 0, 0, 0, 0, 0, 0, case when (a.channel is null) then '' else a.channel end, case when (a.sub_channel is null) then '' else a.sub_channel end, 0, 0, 0, 0, case when (c.network_id is null) then '0' else c.network_id end, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, 0, 0, 0, 0, 0, 0, 1, 0, '', 0, 0, 0, case when (a.is_cn_sdk is null or cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end, 0, cast(sum(case when (a.key_count is null or a.key_count='') then 0 else a.key_count end) as bigint), 0, case when device_type is null then 1 else device_type end, 0, 0, 0, 0, 0, 0, case when abtest_id is null then '' else abtest_id end, 0 from ( select nw_firm_id, group_id, unit_id, placement_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_raw_id, channel, sub_channel, traffic_group_id, is_cn_sdk, device_type, abtest_id, cast(sum(case when (key_count is null or key_count='') then 0 else key_count end) as bigint) key_count from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_EVENT_ANALYSIS_COUNT&#125; where $&#123;where_dt&#125; and key='1004632' and extra3='1' and $&#123;where_hour&#125; $&#123;whereInPublisherList&#125; group by nw_firm_id, group_id, unit_id, placement_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_raw_id, channel, sub_channel, traffic_group_id, is_cn_sdk, device_type, abtest_id ) as a left outer join ( select id,uuid,app_id,format from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_PLACEMENT&#125; where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125; group by id,uuid,app_id,format ) as b on a.placement_id=b.uuid and a.app_raw_id=b.app_id left outer join ( select id,network_id,nw_firm_id from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_UNIT&#125; where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125; ) as c on a.unit_id=c.id where cast(a.group_id as bigint)&lt;=2147483647 and b.uuid is not null group by case when (c.nw_firm_id is null) then '0' else c.nw_firm_id end, case when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end, case c.nw_firm_id when '35' then '1' else case when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end, a.sdk_version, a.app_vn, a.os_platform, a.geo_short, a.publisher_id, a.app_raw_id, b.id, b.format, case when (a.channel is null) then '' else a.channel end, case when (a.sub_channel is null) then '' else a.sub_channel end, case when (c.network_id is null) then '0' else c.network_id end, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, case when (a.is_cn_sdk is null or cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end, case when device_type is null then 1 else device_type end, case when abtest_id is null then '' else abtest_id end\"spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \\ --name \"TopOn_CommonSparkDateTimeJob_report_isready_success_dt$&#123;yyyy_mm_dd&#125;\" \\ --master yarn \\ --deploy-mode cluster \\ --executor-memory \"$&#123;SPARK_EXECUTOR_MEMORY&#125;\" \\ --driver-memory \"$&#123;SPARK_DRIVER_MEMORY&#125;\" \\ --executor-cores 2 \\ --num-executors \"$&#123;SPARK_NUM_EXECUTORS&#125;\" \\ --conf spark.dynamicAllocation.enabled=false \\ --conf spark.dynamicAllocation.minExecutors=32 \\ --conf spark.dynamicAllocation.maxExecutors=64 \\ --conf spark.core.connection.ack.wait.timeout=300 \\ $&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_PATH&#125; \"$&#123;yyyy_mm_dd&#125;\" \"$&#123;hql&#125;\" \"$&#123;DB_UPARPU&#125;.$&#123;T_RUN_REASSIGN_REPORT_TK&#125;\" \"dt='$&#123;ymd&#125;', dimen='16'\" \"overwrite\" key=&#39;1004632&#39; and extra3=&#39;1&#39; ä»£è¡¨ isready ä¸‹ï¼Œå¹¶ä¸”ç›¸åº”æˆåŠŸçš„æ•°æ® ç”±äºåŸå§‹æ•°æ®å·²ç»æœ‰ç»Ÿè®¡ï¼Œæ‰€ä»¥sum(key_count)çš„æ€»å’Œå°±æ˜¯isready_successçš„å¯¹åº”ç»´åº¦çš„æ€»æ•° å†™å…¥åˆ° dimen = &#39;16&#39; çš„åˆ†åŒº merge_showfailed ç»Ÿè®¡å¹¿å‘Šå±•ç¤ºå¤±è´¥ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199#æ¸…æ´—isreadyæ•°æ®ï¼Œå†™å…¥report_tk,dt&amp;dimen=15hourGap=0date_time_timeStamp=`date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00\" +%s`next_date_time_timeStamp=`expr $&#123;date_time_timeStamp&#125; + 86400`next_date_time=`date -d @$&#123;next_date_time_timeStamp&#125; \"+%Y-%m-%d\"`where_dt=\"dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;'\"if [[ $&#123;run_type&#125; = 'utc0' ]] then hourGap=8 where_dt=\"dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')\" else if [[ $&#123;run_type&#125; = 'utcw8' ]] then hourGap=16 where_dt=\"dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')\" else hourGap=0 fifi#è½¬æ¢æˆutc8æ—¶é—´day_start_timeStamp=`date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00\" +%s`day_end_timeStamp=`date -d \"$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 23:00:00\" +%s`while_run_stamp=$&#123;day_start_timeStamp&#125;where_hour='('while [ \"$&#123;while_run_stamp&#125;\" -le \"$&#123;day_end_timeStamp&#125;\" ]do tmp_run_stamp=`expr $&#123;while_run_stamp&#125; + $&#123;hourGap&#125; \\* 3600` tmp_date_time=`date -d @$&#123;tmp_run_stamp&#125; \"+%Y-%m-%d-%H\"` tmp_yyyy=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $1&#125;'` tmp_mm=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $2&#125;'` tmp_dd=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $3&#125;'` tmp_hh=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $4&#125;'` if [ \"$&#123;while_run_stamp&#125;\" == \"$&#123;day_start_timeStamp&#125;\" ] then where_hour=\"$&#123;where_hour&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'\" else where_hour=\"$&#123;where_hour&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'\" fi while_run_stamp=`expr $&#123;while_run_stamp&#125; + 3600`donewhere_hour=\"$&#123;where_hour&#125;)\"hql=\" select '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;', case when (c.nw_firm_id is null) then '0' else c.nw_firm_id end, case when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end, case c.nw_firm_id when '35' then '1' else case when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end, 1, a.sdk_version, a.app_vn, a.os_platform, a.geo_short, a.publisher_id, a.app_raw_id, b.id, b.format, 0, 0, 0, 0, 0, 0, 0, 0, 0, case when (a.channel is null) then '' else a.channel end, case when (a.sub_channel is null) then '' else a.sub_channel end, 0, 0, 0, 0, case when (c.network_id is null) then '0' else c.network_id end, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, 0, 0, 0, 0, 0, 0, 1, 0, '', 0, 0, 0, case when (a.is_cn_sdk is null or cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end, 0, 0, cast(sum(case when (a.key_count is null or a.key_count='') then 0 else a.key_count end) as bigint), case when device_type is null then 1 else device_type end, 0, 0, 0, 0, 0, 0, case when abtest_id is null then '' else abtest_id end, 0 from ( select group_id, unit_id, placement_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_raw_id, channel, sub_channel, traffic_group_id, is_cn_sdk, device_type, abtest_id, cast(sum(case when (key_count is null or key_count='') then 0 else key_count end) as bigint) key_count from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_EVENT_ANALYSIS_COUNT&#125; where $&#123;where_dt&#125; and key='1004633' and $&#123;where_hour&#125; $&#123;whereInPublisherList&#125; group by group_id, unit_id, placement_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_raw_id, channel, sub_channel, traffic_group_id, is_cn_sdk, device_type, abtest_id ) as a left outer join ( select id,uuid,app_id,format from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_PLACEMENT&#125; where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125; group by id,uuid,app_id,format ) as b on a.placement_id=b.uuid and a.app_raw_id=b.app_id left outer join ( select id,network_id,nw_firm_id from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_UNIT&#125; where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125; ) as c on a.unit_id=c.id where cast(a.group_id as bigint)&lt;=2147483647 and b.uuid is not null group by case when (c.nw_firm_id is null) then '0' else c.nw_firm_id end, case when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end, case c.nw_firm_id when '35' then '1' else case when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end, a.sdk_version, a.app_vn, a.os_platform, a.geo_short, a.publisher_id, a.app_raw_id, b.id, b.format, case when (a.channel is null) then '' else a.channel end, case when (a.sub_channel is null) then '' else a.sub_channel end, case when (c.network_id is null) then '0' else c.network_id end, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, case when (a.is_cn_sdk is null or cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end, case when device_type is null then 1 else device_type end, case when abtest_id is null then '' else abtest_id end\"spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \\ --name \"TopOn_CommonSparkDateTimeJob_report_showfailed_dt$&#123;yyyy_mm_dd&#125;\" \\ --master yarn \\ --deploy-mode cluster \\ --executor-memory \"$&#123;SPARK_EXECUTOR_MEMORY&#125;\" \\ --driver-memory \"$&#123;SPARK_DRIVER_MEMORY&#125;\" \\ --executor-cores 2 \\ --num-executors \"$&#123;SPARK_NUM_EXECUTORS&#125;\" \\ --conf spark.dynamicAllocation.enabled=false \\ --conf spark.dynamicAllocation.minExecutors=32 \\ --conf spark.dynamicAllocation.maxExecutors=64 \\ --conf spark.core.connection.ack.wait.timeout=300 \\ $&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_PATH&#125; \"$&#123;yyyy_mm_dd&#125;\" \"$&#123;hql&#125;\" \"$&#123;DB_UPARPU&#125;.$&#123;T_RUN_REASSIGN_REPORT_TK&#125;\" \"dt='$&#123;ymd&#125;', dimen='17'\" \"overwrite\" key=&#39;1004633&#39; ä»£è¡¨ showfailed çš„æ•°æ® ç”±äºåŸå§‹æ•°æ®å·²ç»æœ‰ç»Ÿè®¡ï¼Œæ‰€ä»¥sum(key_count)çš„æ€»å’Œå°±æ˜¯showfailedçš„å¯¹åº”ç»´åº¦çš„æ€»æ•° å†™å…¥åˆ° dimen = &#39;17&#39; çš„åˆ†åŒº merge_revenue ç»Ÿè®¡æ”¶ç›Šæ•°æ® 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147hql=\" select '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;', case when (a.nw_firm_id is null or a.nw_firm_id='' or a.nw_firm_id not rlike '^\\\\\\\\\\\\d+$') then '0' else a.nw_firm_id end, case when (a.group_id is null or a.group_id='' or a.group_id not rlike '^\\\\\\\\\\\\d+$') then '0' else a.group_id end, case when (a.unit_id is null or a.unit_id='' or a.unit_id not rlike '^\\\\\\\\\\\\d+$') then '0' else a.unit_id end, a.system_type, a.sdk_version, case a.app_vn when 'null' then '0' else regexp_replace(a.app_vn,'\\\\\\\\\\\\\\\\0000','') end, a.os_platform, a.geo_short, a.publisher_id, a.app_id, a.placement_id, a.format, a.sc_type, cast(sum(a.request) as bigint), cast(sum(a.filled_request) as bigint), cast(sum(a.impression) as bigint), cast(sum(a.click) as bigint), cast(sum(a.load) as bigint), cast(sum(a.filled_load) as bigint), cast(sum(a.rv_play_start) as bigint), cast(sum(a.rv_play_complete) as bigint), a.channel, a.sub_channel, cast(sum(a.app_request) as bigint), cast(sum(a.placement_request) as bigint), cast(sum(a.show) as bigint), cast(sum(a.impression_optimize) as bigint), a.network_id, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, case when (a.bidtype is null or a.bidtype='') then '0' else a.bidtype end, cast(sum(case when (a.bid_request is null or a.bid_request='') then '0' else a.bid_request end) as bigint), cast(sum(case when (a.bid_response is null or a.bid_response='') then '0' else a.bid_response end) as bigint), cast(sum(case when (a.estimated_revenue is null or a.estimated_revenue='') then '0' else a.estimated_revenue end) as float), case when (sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end)* sum(b.total_revenue) / sum(b.total_impression)) is null then '0' else cast((sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end) * sum(b.total_revenue) / sum(b.total_impression)) as float) end, case when (sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end)* sum(b.total_currency_revenue) / sum(b.total_impression)) is null then '0' else cast((sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end) * sum(b.total_currency_revenue) / sum(b.total_impression)) as float) end, case when (scenario is null or scenario='') then '1' else scenario end, case when (error_type is null or error_type='') then '0' else error_type end, case when (error_msg is null or error_msg='') then '' else error_msg end, cast(sum(case when (a.fake_impression_optimize is null or a.fake_impression_optimize='') then a.impression_optimize else a.fake_impression_optimize end) as bigint), cast(sum(case when (a.fake_filled_load is null or a.fake_filled_load='') then a.filled_load else a.fake_filled_load end) as bigint), cast(sum(case when (a.fake_filled_request is null or a.fake_filled_request='') then a.filled_request else a.fake_filled_request end) as bigint), case when (a.is_cn_sdk is null or a.is_cn_sdk not rlike '^\\\\\\\\\\\\d+$') then '0' else a.is_cn_sdk end, cast(sum(case when (a.ready_request is null or a.ready_request='' or a.ready_request='(null)') then 0 else a.ready_request end) as bigint), cast(sum(case when (a.ready_success is null or a.ready_success='' or a.ready_success='(null)') then 0 else a.ready_success end) as bigint), cast(sum(case when (a.show_failed is null or a.show_failed='' or a.show_failed='(null)') then 0 else a.show_failed end) as bigint), case when device_type is null then 1 else device_type end, cast(sum(case when load_cost_time is null or load_cost_time&lt;0 then 0 else load_cost_time end) as bigint), cast(sum(case when request_cost_time is null or request_cost_time&lt;0 then 0 else request_cost_time end) as bigint), case when idfa_exist_tag is null then 0 else idfa_exist_tag end, case coalesce(sum(bid_response),0) when 0 then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end, cast(coalesce(sum(scenario_entry),0) as bigint), cast(coalesce(sum(scenario_entry_ready),0) as bigint), case when abtest_id is null then '' else abtest_id end, case when ofl is null then 0 else ofl end from (select * from $&#123;DB_UPARPU&#125;.$&#123;T_RUN_REPORT_TK&#125; where dt = '$&#123;ymd&#125;' and dimen in ('0','15','16','17','18') and os_platform is not null and length(sdk_version) &lt; 15 and bidtype&lt;=20 and bidtype&gt;=0 and format&gt;=0 $&#123;whereInPublisherList&#125; ) as a left join ( select app_id, placement_id, geo_short, unit_id, tk_impression as total_impression, revenue as total_revenue, currency_revenue as total_currency_revenue, dt from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_TK_UNIT_ECPM&#125; where dt = '$&#123;ymd&#125;' $&#123;whereInPublisherList&#125; ) as b on a.app_id = b.app_id and a.placement_id=b.placement_id and a.geo_short = b.geo_short and a.unit_id = b.unit_id and a.dt = '$&#123;ymd&#125;' and b.dt = '$&#123;ymd&#125;' and a.dimen in ('0','15','16','17','18') where a.dt = '$&#123;ymd&#125;' and a.dimen in ('0','15','16','17','18') group by case when (a.nw_firm_id is null or a.nw_firm_id='' or a.nw_firm_id not rlike '^\\\\\\\\\\\\d+$') then '0' else a.nw_firm_id end, case when (a.group_id is null or a.group_id='' or a.group_id not rlike '^\\\\\\\\\\\\d+$') then '0' else a.group_id end, case when (a.unit_id is null or a.unit_id='' or a.unit_id not rlike '^\\\\\\\\\\\\d+$') then '0' else a.unit_id end, a.system_type, a.sdk_version, case a.app_vn when 'null' then '0' else regexp_replace(a.app_vn,'\\\\\\\\\\\\\\\\0000','') end, a.os_platform, a.geo_short, a.publisher_id, a.app_id, a.placement_id, a.format, a.sc_type, a.channel, a.sub_channel, a.network_id, case when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end, case when (a.bidtype is null or a.bidtype='') then '0' else a.bidtype end, case when (scenario is null or scenario='') then '1' else scenario end, case when (error_type is null or error_type='') then '0' else error_type end, case when (error_msg is null or error_msg='') then '' else error_msg end, case when (a.is_cn_sdk is null or a.is_cn_sdk not rlike '^\\\\\\\\\\\\d+$') then '0' else a.is_cn_sdk end, case when device_type is null then 1 else device_type end, case when idfa_exist_tag is null then 0 else idfa_exist_tag end, case when abtest_id is null then '' else abtest_id end, case when ofl is null then 0 else ofl end\"spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \\ --name \"TopOn_CommonSparkDateTimeJob_ltv_tk_reassign_revenue_dt$&#123;yyyy_mm_dd&#125;\" \\ --master yarn \\ --deploy-mode cluster \\ --executor-memory \"$&#123;SPARK_EXECUTOR_MEMORY&#125;\" \\ --driver-memory \"$&#123;SPARK_DRIVER_MEMORY&#125;\" \\ --executor-cores 2 \\ --num-executors \"$&#123;SPARK_NUM_EXECUTORS&#125;\" \\ --conf spark.dynamicAllocation.enabled=false \\ --conf spark.dynamicAllocation.minExecutors=32 \\ --conf spark.dynamicAllocation.maxExecutors=64 \\ --conf spark.core.connection.ack.wait.timeout=300 \\ $&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_PATH&#125; \"$&#123;ymd&#125;\" \"$&#123;hql&#125;\" \"$&#123;DB_UPARPU&#125;.$&#123;T_RUN_REASSIGN_REPORT_TK&#125;\" \"dt='$&#123;ymd&#125;', dimen='00'\" \"overwrite\" dimen in (&#39;0&#39;,&#39;15&#39;,&#39;16&#39;,&#39;17&#39;,&#39;18&#39;)ï¼Œåˆ†åˆ«æ˜¯0=åŸæ¥çš„å°æ—¶ä»»åŠ¡ç»Ÿè®¡å‡ºæ¥çš„æ•°æ®ï¼Œ15=isreadyæ•°æ®, 16=isready_successæ•°æ®,17=showfailedæ•°æ®, 18=source_type=2çš„å®æ—¶æ•°æ®ï¼Œæ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œé‡æ–°å†™å…¥ é‡æ–°å†™å…¥åˆ° dimen = &#39;00&#39; çš„åˆ†åŒºä¸­ to_db æ•°æ®å‡ºä»“åˆ°gp 12source ./export_tk_util.shexport_tk_func \"$&#123;DB_UPARPU&#125;.$&#123;T_RUN_REASSIGN_REPORT_TK&#125;\" \"$&#123;T_RUN_REPORT_TK_SOURCE&#125;\" \"dt='$&#123;ymd&#125;' AND dimen='00'\" \" date_time =$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125; $&#123;whereInPublisherList&#125; \" æŠŠå½“å¤©çš„æ•°æ®deleteæ‰ æŠŠæ‰€æœ‰æ•°æ®é‡æ–°å†™å…¥åˆ°gp é‡åˆ†é…åˆ°ä»»åŠ¡åšçš„äº‹æƒ…å¤„ç†å®Œæ¯•ã€‚æ³¨æ„è¿™é‡Œæ¶‰åŠåˆ°äº†æ”¶ç›Šæ•°æ®ï¼Œç”±äºä¸šåŠ¡å¯¼å‘æ˜¯èšåˆå¹³å°ï¼Œæ‰€ä»¥ä¼šæ”¶ç›Šæ˜¯ä»å¤šä¸ªå¹³å°æ‹‰å–å›æ¥çš„æ•°æ®ï¼Œå¯èƒ½å­˜åœ¨æ‹‰å–æ”¶ç›Šæ•°æ®å¤±è´¥çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦æœ‰é‡è¯•æœºåˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œçš„çš„ä»»åŠ¡æœ‰åˆ†ä¸ºè·‘å‰1å¤©ï¼Œè·‘å‰2å¤©ï¼Œè·‘å‰3å¤©çš„æ•°æ®ï¼Œå¦‚æœè¶…è¿‡3å¤©ï¼Œéƒ½æ‹‰å–å¤±è´¥ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ•°æ®æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨é‡è·‘ã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"å…¬å¸","slug":"å…¬å¸","permalink":"http://blog.crazylaw.cn/tags/%E5%85%AC%E5%8F%B8/"}]},{"title":"å¤§æ•°æ®ä»»åŠ¡-å°æ—¶ä»»åŠ¡","slug":"å…¬å¸/å¤§æ•°æ®-å°æ—¶ä»»åŠ¡","date":"2022-05-26T03:52:40.000Z","updated":"2022-05-27T10:44:13.097Z","comments":true,"path":"2022/05/26/å…¬å¸/å¤§æ•°æ®-å°æ—¶ä»»åŠ¡/","link":"","permalink":"http://blog.crazylaw.cn/2022/05/26/%E5%85%AC%E5%8F%B8/%E5%A4%A7%E6%95%B0%E6%8D%AE-%E5%B0%8F%E6%97%B6%E4%BB%BB%E5%8A%A1/","excerpt":"å‰è¨€æ€»ç»“ä¸€ä¸‹å…¬å¸å¤§æ•°æ®çš„ä»»åŠ¡ETLç¦»çº¿å·¥ä½œæµ - å°æ—¶ä»»åŠ¡","text":"å‰è¨€æ€»ç»“ä¸€ä¸‹å…¬å¸å¤§æ•°æ®çš„ä»»åŠ¡ETLç¦»çº¿å·¥ä½œæµ - å°æ—¶ä»»åŠ¡ å…¬å¸çš„ETLæœåŠ¡ï¼Œç›®å‰é‡‡ç”¨çš„æ˜¯ç»„ä»¶ä¸ºï¼š æ•°ä»“ (hadoop) ä»»åŠ¡è°ƒåº¦å™¨ (azkaban) å‡ºä»“ (gp) æ•°ä»“æŸ¥è¯¢ (hue)(hive)(spark) job_hourï¼ˆå°æ—¶ä»»åŠ¡ï¼‰ schedule: 30 * * * * æ¯å°æ—¶30åˆ†çš„æ—¶å€™è¿›è¡Œå¯åŠ¨ä»»åŠ¡ check_tk_batch_log_success æ£€æµ‹tkæœåŠ¡æ˜¯å¦æŠŠåŸå§‹æ—¥å¿—å·²ç»ä¸Šä¼ åˆ°ossæœåŠ¡ä¸­ æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š 12345path=$&#123;LOG_TRACKING_BATCH_PATH&#125;path=$&#123;path&#125;/$&#123;yyyy&#125;/$&#123;mm&#125;/$&#123;dd&#125;/$&#123;hh&#125;/_SUCCESShadoop fs -test -e $&#123;path&#125; æ•°æ®æ˜¯æ ¹æ®æ¯ä¸ªå°æ—¶ä¸ºä¸€ä¸ªåŸºæœ¬å•ä½ï¼Œé€šè¿‡_SUCCESSæ–‡ä»¶æ¥æ ‡å¿—å½“å‰å°æ—¶çš„æ•°æ®æ˜¯å¦å·²ç»åŒæ­¥åˆ°OSSå®Œæ¯•ã€‚ sync_mysql_config åŒæ­¥mysqlçš„å½“å‰é…ç½®ä¿¡æ¯ åŒæ­¥å¹¿å‘Šä½æ•°æ®æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š 1234567891011stat_source='placement'mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e \"select id,uuid,format from $&#123;DB_NAME&#125;.$&#123;stat_source&#125;\" &gt; tmp/bigdata_mysql_placement_list.logif [ -f \"tmp/bigdata_mysql_placement_list.log\" ]; then # hadoop fs -rm -r $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/ $&#123;FILE_COMMAND_RM&#125; $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/ --recursive $&#123;FILE_COMMAND_CP&#125; tmp/bigdata_mysql_placement_list.log $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/fi ä»æ•°æ®åº“å¯¼å‡ºå¹¿å‘Šä¿¡æ¯ï¼šid, uuid, format(å¹¿å‘Šæ ·å¼) åˆ°å¹¿å‘Šåˆ—è¡¨æ–‡ä»¶ æŠŠæœ¬åœ°æ•°æ®æ›´æ–°åˆ°ossä¸­ 1234567891011121314151617181920212223242526272829tmpfilename=\"tmp/bigdata_mysql_placement.log\"mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e \" select id, uuid, publisher_id, app_id, name, format, remark, create_time, update_time from $&#123;DB_NAME&#125;.$&#123;stat_source&#125; ;\" --skip-column-names | sed 's/\\t/|/g' &gt; $&#123;tmpfilename&#125;if [ -f \"$&#123;tmpfilename&#125;\" ]; then target=\"$&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_PLACEMENT&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/\" $&#123;FILE_COMMAND_RM&#125; $&#123;target&#125; --recursive $&#123;FILE_COMMAND_CP&#125; $&#123;tmpfilename&#125; $&#123;target&#125; echo \"sync $&#123;tmpfilename&#125; to $&#123;target&#125;\"fi å¯¼å‡ºæ•°æ®å¹¿å‘Šä½æ•°æ®ï¼Œå¹¶ä¸”ä»¥|ç¬¦å·ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå†™å…¥åˆ°å¹¿å‘Šä½æ–‡ä»¶ å¦‚æœ å¹¿å‘Šä½ æ–‡ä»¶å­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆå°±æŠŠ å¹¿å‘Šä½æ–‡ä»¶ ä» file-oss åŒæ­¥åˆ° hive-oss åŒæ­¥å¹¿å‘Šèšåˆæ”¶ç›Šæ•°æ®12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788bigdata_unit_source='unit'bigdata_network_source='network'tmpAdsourcefilename=\"tmp/bigdata_mysql_unit.log\"tmpAdsourceFbFilename=\"tmp/bigdata_mysql_unit_fb.log\"mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e \" select a.id, a.publisher_id, a.placement_id, a.network_id, a.network_id, 0, a.name, a.remote_unique, a.remote_unit, a.header_bidding_switch, a.ecpm, a.ecpm_currency, a.cap_hour, a.cap_hour_switch, a.cap_day, a.cap_day_switch, a.pacing, a.pacing_switch, a.create_time, a.update_time, a.status, b.nw_firm_id from $&#123;DB_NAME&#125;.$&#123;bigdata_unit_source&#125; a left outer join $&#123;DB_NAME&#125;.$&#123;bigdata_network_source&#125; b on a.network_id=b.id where b.nw_firm_id!=1 ;\" --skip-column-names | sed 's/\\t/|/g' &gt; $&#123;tmpAdsourcefilename&#125;mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e \" select a.id, a.publisher_id, a.placement_id, b.parent_id, a.network_id, b.parent_id, a.name, a.remote_unique, a.remote_unit, a.header_bidding_switch, a.ecpm, a.ecpm_currency, a.cap_hour, a.cap_hour_switch, a.cap_day, a.cap_day_switch, a.pacing, a.pacing_switch, a.create_time, a.update_time, a.status, b.nw_firm_id from $&#123;DB_NAME&#125;.$&#123;bigdata_unit_source&#125; a left outer join $&#123;DB_NAME&#125;.$&#123;bigdata_network_source&#125; b on a.network_id=b.id where b.nw_firm_id=1 ;\" --skip-column-names | sed 's/\\t/|/g' &gt; $&#123;tmpAdsourceFbFilename&#125;if [ -f \"$&#123;tmpfilename&#125;\" ]; then target=\"$&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_UNIT&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/\" $&#123;FILE_COMMAND_RM&#125; $&#123;target&#125; --recursive $&#123;FILE_COMMAND_CP&#125; $&#123;tmpAdsourcefilename&#125; $&#123;target&#125; $&#123;FILE_COMMAND_CP&#125; $&#123;tmpAdsourceFbFilename&#125; $&#123;target&#125; echo \"sync $&#123;tmpfilename&#125; to $&#123;target&#125;\"fi æŠŠ å›½å†…å¹¿å‘Š å’Œ å›½å¤–å¹¿å‘Š æ•°æ®å¯¼å‡ºåˆ†åˆ«æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ ç„¶åä» file-oss åŒæ­¥åˆ° hive-oss å¤‡æ³¨ï¼šè¿™é‡Œé‡‡ç”¨çš„æ˜¯åˆ¤æ–­${tmpfilename}æ˜¯å¹¿å‘Šä½çš„æ–‡ä»¶ï¼Œæš‚ä¸ç¡®å®šæ˜¯ä¸æ˜¯è¯´æ˜å¦‚æœå¹¿å‘Šä½æ–‡ä»¶æ²¡æ•°æ®çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªé€»è¾‘ä¹Ÿä¸åšå¤„ç†äº†ã€‚ å¹¿å‘Šåœºæ™¯12345678910111213141516171819202122232425262728293031bigdata_scenario_source='scenario'tmpScenariofilename=\"tmp/bigdata_mysql_scenario.log\"mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e \" select id, uuid, publisher_id, app_id, placement_id, name, remark, create_time, update_time, status from $&#123;DB_NAME&#125;.$&#123;bigdata_scenario_source&#125; ;\" --skip-column-names | sed 's/\\t/|/g' &gt; $&#123;tmpScenariofilename&#125;if [ -f \"$&#123;tmpScenariofilename&#125;\" ]; then target=\"$&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_SCENARIO&#125;/\" $&#123;FILE_COMMAND_RM&#125; $&#123;target&#125; --recursive $&#123;FILE_COMMAND_CP&#125; $&#123;tmpScenariofilename&#125; $&#123;target&#125; echo \"sync $&#123;tmpScenariofilename&#125; to $&#123;target&#125;\"fi æŠŠå¹¿å‘Šåœºæ™¯æ•°æ®å¯¼å…¥åˆ°å¹¿å‘Šåœºæ™¯æ–‡ä»¶ä¸­ ç„¶åä» file-oss åŒæ­¥åˆ° hive-oss ç­‰ç­‰â€¦check_strategy_app_log_success æ£€æµ‹appæ—¥å¿—ç­–ç•¥æ˜¯å¦å†™å…¥å®Œæˆ check_strategy_placement_log_success æ£€æµ‹å¹¿å‘Šç­–ç•¥æ—¥å¿—å†™å…¥æ˜¯å¦å†™å…¥å®Œæˆ parse_tk_batch12dependencies=check_tk_batch_log_success,sync_mysql_configcommand=sh -x parse_tk_batch.sh å¼€å§‹è§£ætkæ•°æ® 123log_type=18hadoop fs -rm -r $&#123;CLIENT_TMP_LOG_META_PATH&#125;/$&#123;T_BIGDATA_TK_BATCH&#125;/hadoop jar $&#123;parse_jar&#125; $&#123;LOG_TRACKING_BATCH_PATH&#125;/$&#123;yyyy&#125;/$&#123;mm&#125;/$&#123;dd&#125;/$&#123;hh&#125;/* $&#123;CLIENT_TMP_LOG_META_PATH&#125; $&#123;yyyy_mm_dd_hh&#125; $&#123;log_type&#125; $&#123;T_BIGDATA_TK_BATCH&#125; $&#123;T_BIGDATA_DEVICE_ACTIVE_HOUR&#125; $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/bigdata_mysql_placement_list.log é€šè¿‡hadoopçš„map-reduceè¿›è¡Œå¤„ç†åˆ†å¸ƒå¼å¤„ç†æ•°æ® å…¶å®ç›®å‰è„šæœ¬æ¥è¯´ï¼Œè¿™é‡Œåªæœ‰å‰5ä¸ªå‚æ•°æœ‰ç”¨ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŸå§‹æ—¥å¿—çš„ç›®å½•ï¼ˆæœ‰ç”¨ï¼‰ ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¾“å‡ºæ—¥å¿—çš„ç›®å½•ï¼ˆæ²¡ç”¨ï¼‰ ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ—¥æœŸæ—¶é—´ ç¬¬å››ä¸ªå‚æ•°æ˜¯æ—¥å¿—ç±»å‹ï¼ˆè¿™é‡Œ=18ï¼‰ ç¬¬äº”ä¸ªå‚æ•°æ˜¯è¡¨åï¼ˆä¹Ÿæ˜¯å®Œæ•´hiveè·¯å¾„çš„ä¸€çº§ç›®å½•ï¼‰ ç¬¬å…­ä¸ªå‚æ•°æ˜¯è¾“å‡ºç»“æœè¡¨åï¼ˆè¿™é‡Œæ²¡ç”¨ï¼‰ ç¬¬ä¸ƒä¸ªå‚æ•°æ˜¯è¿™é‡Œæ˜¯å¹¿å‘Šæ—¥å¿—æ–‡ä»¶è·¯å¾„ TKåŸå§‹æ—¥å¿—çš„å­˜å‚¨ç›®å½•ä¸‹ï¼ŒtkåŸå§‹æ—¥å¿—æ–‡ä»¶ä¸­é‡Œé¢æœ‰ä¸åŒç±»å‹çš„æ•°æ®ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªtypeç±»å‹ï¼Œå¯ä»¥å«åštk_type, ä»£è¡¨ä¸åŒç±»å‹çš„æ•°æ®(TYPE_TRACKING_XXX) 123456789101112131415161718192021222324252627282930public class TrackingLogConst &#123; public static final int TYPE_TRACKING_REQUEST = 1; // è¯·æ±‚ public static final int TYPE_TRACKING_FILLED_REQUEST = 2; // æœ‰å¡«å……çš„è¯·æ±‚ public static final int TYPE_TRACKING_NO_FILLED_REQUEST = 3; // æ²¡å¡«å……çš„è¯·æ±‚ public static final int TYPE_TRACKING_IMPRESSION = 4; // å±•ç¤º public static final int TYPE_TRACKING_REFERSH_IMPRESSION = 5; //åˆ·æ–°å±•ç¤º public static final int TYPE_TRACKING_CLICK = 6; // ç‚¹å‡» public static final int TYPE_TRACKING_VIDEO_PLAY = 7; // è§†é¢‘æ’­æ”¾ public static final int TYPE_TRACKING_RV_PLAY_START = 8;// æ¿€åŠ±è§†é¢‘æ’­æ”¾å¼€å§‹ public static final int TYPE_TRACKING_RV_PLAY_COMPLETE = 9;// æ¿€åŠ±è§†é¢‘æ’­æ”¾å®Œæˆ public static final int TYPE_TRACKING_LOAD = 10;// loadè°ƒç”¨æ•°æ® public static final int TYPE_TRACKING_HEADER_BIDDING = 11;// header bidding public static final int TYPE_TRACKING_LOADFILLED = 12;// loadfilledæ•°æ® public static final int TYPE_TRACKING_SHOW = 13;// showè°ƒç”¨ public static final int TYPE_TRACKING_RAND_WATERFALL = 15;// showè°ƒç”¨ public static final int TYPE_TRACKING_AD_SCENARIO = 16;// åˆ°è¾¾å¹¿å‘Šåœºæ™¯ // myofferçš„trackingå¯¹åº”ç±»å‹ public static final String TYPE_MYOFFER_TRACKING_RV_0 = \"1\"; public static final String TYPE_MYOFFER_TRACKING_RV_25 = \"2\"; public static final String TYPE_MYOFFER_TRACKING_RV_50 = \"3\"; public static final String TYPE_MYOFFER_TRACKING_RV_75 = \"4\"; public static final String TYPE_MYOFFER_TRACKING_RV_100 = \"5\"; public static final String TYPE_MYOFFER_TRACKING_RV_END_SHOW = \"6\"; public static final String TYPE_MYOFFER_TRACKING_RV_END_CLOSE = \"7\"; public static final String TYPE_MYOFFER_TRACKING_IMPRESSION = \"8\"; public static final String TYPE_MYOFFER_TRACKING_CLICK = \"9\";&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950private org.apache.hadoop.mapreduce.lib.output.MultipleOutputs&lt;Text, Text&gt; mos;protected void setup(Mapper.Context context) throws IOException, InterruptedException &#123; mos = new MultipleOutputs&lt;Text, Text&gt;(context); Configuration conf = context.getConfiguration(); tableName = conf.get(\"table_name\"); deviceTable = conf.get(\"result_table\"); inputTime = conf.get(\"date\"); inputTimeSplit = inputTime.split(\"-\"); logType = Integer.parseInt(conf.get(\"log_type\")); Path[] uriList = context.getLocalCacheFiles(); placementMap = PlacementData.getPlacementListFromUri(uriList); super.setup(context);&#125;private void writeMosString(StringBuilder stringBuilder, int trackingType) &#123; String resultString = stringBuilder.toString(); if (LogFactory.isDebug) &#123; System.out.println(\"result:\" + resultString + \" tableName:\" + tableName + \"/yyyy=\" + inputTimeSplit[0] + \"/mm=\" + inputTimeSplit[1] + \"/dd=\" + inputTimeSplit[2] + \"/hh=\" + inputTimeSplit[3] + \"/\"); &#125; // å†™ç»“æœè¡¨ if (resultString != null &amp;&amp; resultString != \"\" &amp;&amp; !LogFactory.isDebug) &#123; // å†™ç»“æœåï¼Œä¼šä½¿ç”¨logtype_ä½œä¸ºå‰ç¼€ try &#123; mos.write(new Text(resultString), new Text(), tableName + \"/\" + trackingType + \"/raw/\" + logType + \"_\" + trackingType + \"_\"); &#125; catch (IOException e) &#123; e.printStackTrace(); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; &#125;&#125;... String outputPathTmp = outputPath + \"/\" + tableName + logType + \"/\"; FileSystem fs = null; try &#123; fs = FileSystem.get(new URI(inputPath), conf); Path outPath = new Path(outputPathTmp); if (fs.exists(outPath)) &#123; fs.delete(outPath, true); &#125; &#125; catch (URISyntaxException e) &#123; e.printStackTrace(); &#125; çˆ¶çº§è·¯å¾„ä½ï¼šoutputPathTmp: /{table}{logType}/ çœ‹åˆ°æ•°æ®è¢«è§£æä¹‹åï¼Œä¼šè¢«å†™å…¥åˆ°å¦‚ä¸‹å­çº§è·¯å¾„ï¼š {tableName} + &quot;/&quot; + {trackingType} + &quot;/raw/&quot; + {logType} + &quot;_&quot; + {trackingType} + &quot;_&quot; åœ¨å½“å‰çš„è§£æä»»åŠ¡ä¸­ï¼Œä»¥ TYPE_TRACKING_IMPRESSION=4 ä¸ºä¾‹å­ï¼Œå…·ä½“çš„ä¾‹å­å¦‚ä¸‹ï¼š {T_BIGDATA_TK_BATCH}/4/raw/18_4_xxx å…·ä½“ç”¨æ³•éœ€è¦ä¸²è”ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ¥çœ‹ã€‚ copy_xxx(copy_impressionä¸ºä¾‹)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129$&#123;FILE_COMMAND_RM&#125; $&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_IMPRESSION&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125; --recursive$&#123;FILE_COMMAND_RM&#125; $&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_IMPRESSION_V2&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125; --recursive$&#123;FILE_COMMAND_SYNC&#125; $&#123;CLIENT_TMP_LOG_META_PATH&#125;/$&#123;T_BIGDATA_TK_BATCH&#125;18/$&#123;T_BIGDATA_TK_BATCH&#125;/4/raw/ $&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_IMPRESSION&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125;/$&#123;FILE_COMMAND_SYNC&#125; $&#123;CLIENT_TMP_LOG_META_PATH&#125;/$&#123;T_BIGDATA_TK_BATCH&#125;18/$&#123;T_BIGDATA_TK_BATCH&#125;/5/raw/ $&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_IMPRESSION&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125;/hive -e \" use $&#123;DB_BIGDATA&#125;; alter table $&#123;T_BIGDATA_IMPRESSION&#125; drop IF EXISTS partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;'); alter table $&#123;T_BIGDATA_IMPRESSION&#125; add partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;') location 'yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125;';\"hql=\" select cast(c_date as int) as c_date, c_time, cast(created as bigint) as created, ip, remote_ip, server_id, country_code, cast((case when os_platform is null or os_platform='' then 1 else os_platform end) as int) as os_platform, imei, mac, android_id, gaid, idfa, os_vn, os_vc, model, brand, screen_size, cast((case when orientation is null or orientation='' then 1 else orientation end) as int) as orientation, network_type, mcc, mnc, language, time_zone, user_agent, gpv, app_vn, app_vc, app_package, sdk_version, cast((case when publisher_id is null or publisher_id='' then 0 else publisher_id end) as int) as publisher_id, app_id, cast((case when app_raw_id is null or app_raw_id='' then 0 else app_raw_id end) as int) as app_raw_id, placement_id, cast((case when placement_raw_id is null or placement_raw_id='' then 0 else placement_raw_id end) as int) as placement_raw_id, request_id, psid, sessionid, cast((case when sdk_time is null or sdk_time='' then 0 else sdk_time end) as bigint) as sdk_time, ug_id, nw_version, cast((case when nw_firm_id is null or nw_firm_id='' then 0 else nw_firm_id end) as int) as nw_firm_id, cast((case when sc_type is null or sc_type='' then 0 else sc_type end) as int) as sc_type, cast((case when group_id is null or group_id='' then 0 else group_id end) as int) as group_id, cast((case when format is null or format='' then 0 else format end) as int) as format, extra, cast((case when is_refresh is null or is_refresh='' then 0 else is_refresh end) as int) as is_refresh, cast((case when unit_id is null or unit_id='' then 0 else unit_id end) as int) as unit_id, cast((case when system_type is null or system_type='' then 0 else system_type end) as int) as system_type, cast((case when load_type is null or load_type='' then 0 else load_type end) as int) as load_type, case when asid is null then '' else asid end as asid, case when channel is null then '' else channel end as channel, case when upid is null then '' else upid end as upid, cast((case when auto_refresh is null or auto_refresh='' then 0 else auto_refresh end) as int) as auto_refresh, cast((case when aprn_auto_req is null or aprn_auto_req='' then 0 else aprn_auto_req end) as int) as aprn_auto_req, cast((case when bidtype is null or bidtype='' then 0 else bidtype end) as int) as bidtype, cast((case when bidprice is null or bidprice='' then 0 else bidprice end) as float) as bidprice, case when offer_pkg is null then '' else offer_pkg end as offer_pkg, case when sub_channel is null then '' else sub_channel end as sub_channel, case when idfv is null then '' else idfv end as idfv, cast((case when traffic_group_id is null or traffic_group_id='' then 0 else traffic_group_id end) as int) as traffic_group_id, cast((case when myoffer_show_type is null or myoffer_show_type='' then 0 else myoffer_show_type end) as int) as myoffer_show_type, cast((case when ofl is null or ofl='' then 0 else ofl end) as int) as ofl, cast((case when gdpr_cs is null or gdpr_cs='' then 0 else gdpr_cs end) as int) as gdpr_cs, case when scenario is null then '1' else scenario end as scenario, cast((case when deduction_res is null or deduction_res='' then 0 else deduction_res end) as int) as deduction_res, cast((case when deduction_num is null or deduction_num='' then 1 else deduction_num end) as int) as deduction_num, case when oaid is null then '' else oaid end as oaid, cast((case when is_cn_sdk is null or is_cn_sdk='' then 0 else is_cn_sdk end) as int) as is_cn_sdk, cast((case when adtype_day_show_times is null or adtype_day_show_times='' then 0 else adtype_day_show_times end) as int) as adtype_day_show_times, cast((case when adtype_hour_show_times is null or adtype_hour_show_times='' then 0 else adtype_hour_show_times end) as int) as adtype_hour_show_times, cast((case when placement_day_show_times is null or placement_day_show_times='' then 0 else placement_day_show_times end) as int) as placement_day_show_times, cast((case when placement_hour_show_times is null or placement_hour_show_times='' then 0 else placement_hour_show_times end) as int) as placement_hour_show_times, case when install_source is null then '' else install_source end as install_source, protocol, origin_num, protocol_type, abtest_id, first_init_time, days_from_first_init, app_custom, user_id, age, gender, cl_imp, ex_ad from $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_IMPRESSION&#125; where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' and hh='$&#123;hh&#125;' \"spark-submit --class com.BigData.spark.jobs.common.CommonSparkSaveORCJob \\--name \"BigData_CommonSparkDateTimeJob_copy_impression_dt$&#123;yyyy_mm_dd_hh&#125;\" \\--master yarn \\--deploy-mode cluster \\--executor-memory 2g \\--driver-memory 2g \\--executor-cores 2 \\--num-executors 8 \\--conf spark.dynamicAllocation.enabled=false \\--conf spark.dynamicAllocation.minExecutors=8 \\--conf spark.dynamicAllocation.maxExecutors=64 \\--conf spark.core.connection.ack.wait.timeout=300 \\--files \"$&#123;HIVE_SITE_PATH&#125;\" \\$&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_HIVE_PATH&#125; \"$&#123;hql&#125;\" \"$&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_IMPRESSION_V2&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125;/\"\\ hive -e \" use $&#123;DB_BIGDATA&#125;; alter table $&#123;T_BIGDATA_IMPRESSION_V2&#125; drop IF EXISTS partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;'); alter table $&#123;T_BIGDATA_IMPRESSION_V2&#125; add partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;') location 'yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125;'; \" è¿™é‡Œæ¥ç€ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„åˆ†æï¼Œè¿™é‡Œçš„${CLIENT_TMP_LOG_META_PATH}/${T_BIGDATA_TK_BATCH}18/${T_BIGDATA_TK_BATCH}/4/raw/ å°±æ˜¯ç»è¿‡hadoopè§£æåè¾“å‡ºæ–‡ä»¶çš„ç›®å½• å¦‚æœæœ‰å†å²çš„æ•°æ®ï¼Œåˆ™åˆ é™¤å†å²çš„æ•°æ®ï¼Œç„¶åé‡æ–°å¯¼å…¥æ•°æ®åˆ°è¡¨ä¸­ æ¥ç€å†æŠŠæ•°æ®copyåˆ° impression å¯¹åº”çš„ç›®å½•åˆ†åŒºä¸­ é‡å»ºï¼ˆä¿®å¤ï¼‰åˆ†åŒºï¼ŒæŠŠæ•°æ®åŠ è½½åˆ°hiveä¸­çš„impression é€šè¿‡sqlæŠŠæ•°æ®è¿›è¡Œ ç¬¬ä¸€æ¬¡ æ¸…æ´—ï¼Œç»è¿‡è¿™ä¸€çº§çš„æ¸…æ´—ï¼Œé€šè¿‡sparkæŠŠæ•°æ®è½¬æˆ ORC æ ¼å¼è¿›è¡Œå­˜å‚¨åˆ° impression_v2 è¡¨ é‡å»ºï¼ˆä¿®å¤ï¼‰åˆ†åŒºï¼ŒæŠŠæ•°æ®åŠ è½½åˆ°hiveä¸­impression_v2 merge_xxx(merge_tk_impressionä¸ºä¾‹) æ¸…æ´—tkçš„impressionæ•°æ®åˆ°tkå°æ—¶çš„orcè¡¨ï¼ˆæ­¤orcéç‰©ç†ä¸Šçš„orcè¡¨ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127hql=\"select $&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;, $&#123;hh&#125;, a.nw_firm_id, a.group_id, a.unit_id, a.system_type, a.sdk_version, a.app_vn, a.os_platform, a.country_code, a.publisher_id, a.app_raw_id, a.placement_raw_id, a.format, a.sc_type, 0, 0, cast(count(a.request_id) as bigint), 0, 0, 0, 0, 0, a.channel, a.sub_channel, 0, 0, 0, $&#123;timeStamp&#125;, 0, cast(b.network_id as int), a.traffic_group_id, a.bidtype, 0, 0, cast((sum(a.bidprice)/1000) as float), case when (a.scenario is null or a.scenario='' or c.uuid is null or c.status&lt;&gt;3) then '1' else a.scenario end, case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null) then 1 when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then 2 else 0 end, case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null or a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then a.scenario else '' end, cast(sum(case when a.deduction_num is null or a.deduction_num = '' then '1' else a.deduction_num end) as bigint), 0, 0, case when (a.is_cn_sdk is null or a.is_cn_sdk='null') then 0 else a.is_cn_sdk end, case when os_platform=2 and length(model)&gt;=4 and upper(substr(model,1,4))='IPAD' then 2 else 1 end, 0, 0, case when (os_platform = '2' and ((length(idfa) &gt; 0 and idfa &lt;&gt; '00000000-0000-0000-0000-000000000000') or (idfa = '' and gdpr_cs = '1'))) then 1 else 0 end as idfa_exist_tag, 0, 0, 0, a.abtest_id from $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_IMPRESSION_V2&#125; as a left outer join $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_UNIT&#125; as b on a.yyyy='$&#123;yyyy&#125;' and a.mm='$&#123;mm&#125;' and a.dd='$&#123;dd&#125;' and a.hh='$&#123;hh&#125;' and b.yyyy='$&#123;yyyy&#125;' and b.mm='$&#123;mm&#125;' and b.dd='$&#123;dd&#125;' and a.unit_id=b.id left outer join $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_SCENARIO&#125; as c on a.yyyy='$&#123;yyyy&#125;' and a.mm='$&#123;mm&#125;' and a.dd='$&#123;dd&#125;' and a.hh='$&#123;hh&#125;' and a.placement_raw_id=c.placement_id and a.scenario=c.uuid where a.yyyy='$&#123;yyyy&#125;' and a.mm='$&#123;mm&#125;' and a.dd='$&#123;dd&#125;' and a.hh='$&#123;hh&#125;' and a.is_refresh=0 and a.unit_id&gt;0 and a.publisher_id is not null and a.bidprice &lt;&gt; 'Infinity' and a.bidprice &gt;= 0 and a.bidprice &lt;= 100000 group by a.nw_firm_id, a.group_id, a.unit_id, a.system_type, a.sdk_version, a.app_vn, a.os_platform, a.country_code, a.publisher_id, a.app_raw_id, a.placement_raw_id, a.format, a.sc_type, a.channel, a.sub_channel, b.network_id, a.traffic_group_id, a.bidtype, case when (a.scenario is null or a.scenario='' or c.uuid is null or c.status&lt;&gt;3) then '1' else a.scenario end, case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null) then 1 when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then 2 else 0 end, case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null or a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then a.scenario else '' end, case when (a.is_cn_sdk is null or a.is_cn_sdk='null') then 0 else a.is_cn_sdk end, case when os_platform=2 and length(model)&gt;=4 and upper(substr(model,1,4))='IPAD' then 2 else 1 end, case when (os_platform = '2' and ((length(idfa) &gt; 0 and idfa &lt;&gt; '00000000-0000-0000-0000-000000000000') or (idfa = '' and gdpr_cs = '1'))) then 1 else 0 end, a.abtest_id\"spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \\--name \"BigData_CommonSparkDateTimeJob_merge_impression_dt$&#123;yyyy_mm_dd_hh&#125;\" \\--master yarn \\--deploy-mode cluster \\--executor-memory 2g \\--driver-memory 2g \\--executor-cores 2 \\--num-executors 8 \\--conf spark.dynamicAllocation.enabled=false \\--conf spark.dynamicAllocation.minExecutors=8 \\--conf spark.dynamicAllocation.maxExecutors=64 \\--conf spark.core.connection.ack.wait.timeout=300 \\--files \"$&#123;HIVE_SITE_PATH&#125;\" \\$&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_HIVE_PATH&#125; \"$&#123;yyyy_mm_dd_hh&#125;\" \"$&#123;hql&#125;\" \"$&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR_ORC&#125;\" \"dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;', hh='$&#123;hh&#125;', dimen='3'\" \"overwrite\"\\ è¿™é‡Œæ˜¯æ“ä½œçš„ä¸»è¡¨ä¸ºv2è¡¨ï¼Œjoinçš„è¡¨ä¸€èˆ¬åªèƒ½æ˜¯v1è¡¨ï¼Œå› ä¸ºæ–‡æœ¬çš„è§£ææ˜¯ä¸€èµ·æ‰§è¡Œçš„ï¼Œä½†æ˜¯å„ä¸ªä»»åŠ¡çš„v2è¡¨ä»€ä¹ˆæ—¶å€™æ›´æ–°å®Œæ¯•æš‚æ—¶æ˜¯ä¸ç¡®å®šçš„ã€‚ è¿™é‡Œçœ‹åˆ°åˆ†åŒºä¿¡æ¯ä¸­æœ‰ä¸€ä¸ª dimen = &#39;3&#39;ï¼Œæ˜¯å’Œæ¥ä¸‹æ¥çš„ ${T_BIGDATA_REPORT_TK_HOUR_ORC} æœ‰å…³ç³»ã€‚è¿™æ˜¯ä¸€ä¸ªtkæ•°æ®çš„æ±‡æ€»è¡¨ï¼Œå‡ ä¹æ‰€æœ‰ç»´åº¦çš„æ•°æ®æœ€åéƒ½ä¼šæ±‡é›†åœ¨è¿™é‡Œï¼ŒåŠ ä¸Šæˆ‘ä»¬æœ‰ä¸åŒçš„ä»»åŠ¡çš„æ•°æ®éƒ½å†™å…¥åˆ°è¿™ä¸ªè¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ä¸€ä¸ªdimençš„åˆ†åŒºï¼Œä¾¿äºåŒºåˆ†ä¸åŒçš„æ•°æ®çš„æ¥æºã€‚ merge_tracking_hour æ¸…æ´—orcçš„è¡¨æ•°æ®åˆ°éorcçš„è¡¨ï¼Œæ•°æ®åŸºæœ¬å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä»½åŸºæœ¬å¯ä»¥å‡ºä»“çš„æ•°æ®äº† 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121hql=\"select $&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;, $&#123;hh&#125;, case nw_firm_id when '' then 0 else nw_firm_id end, case group_id when '' then 0 else group_id end, case nw_firm_id when '35' then 1 else unit_id end, case system_type when '' then 0 else system_type end, case sdk_version when 'null' then '0' else sdk_version end, case when app_vn = 'null' then '0' when length(app_vn) &gt;= 50 then '0' else regexp_replace(app_vn,'\\\\\\\\\\\\\\\\0000','') end as app_vn, case os_platform when '' then 0 else os_platform end, case geo_short when 'null' then '00' else geo_short end, case publisher_id when '' then 0 else publisher_id end, case app_id when '' then 0 else app_id end, case placement_id when '' then 0 when 'null' then 0 else placement_id end, case format when '' then 0 else format end, case sc_type when '' then 0 else sc_type end, cast(sum(request) as bigint), cast(sum(filled_request) as bigint), cast(sum(impression) as bigint), cast(sum(click) as bigint), cast(sum(load) as bigint), cast(sum(filled_load) as bigint), cast(sum(rv_play_start) as bigint), cast(sum(rv_play_complete) as bigint), case channel when '' then '' else channel end, case sub_channel when '' then '' else sub_channel end, cast(sum(app_request) as bigint), cast(sum(placement_request) as bigint), cast(sum(show) as bigint), $&#123;timeStamp&#125;, cast(sum(impression_optimize) as bigint), case network_id when '' then 0 else network_id end, case when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end, case when (bidtype is null or bidtype='') then 0 else bidtype end, cast(sum(bid_request) as bigint), cast(sum(bid_response) as bigint), cast(sum(case when dimen='12' then estimated_revenue else 0 end) as float), case when (scenario is null or scenario='') then '1' else scenario end, case when (error_type is null or error_type='') then 0 else error_type end, case when (error_msg is null or error_msg='') then '' else error_msg end, cast(sum(case when (fake_impression_optimize&gt;0 and dimen='12') then fake_impression_optimize else 0 end) as bigint), cast(sum(case when (fake_filled_load is null) then 0 else fake_filled_load end) as bigint), cast(sum(case when (fake_filled_request is null) then 0 else fake_filled_request end) as bigint), case when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end, case when device_type is null then 1 else device_type end, cast(sum(load_cost_time) as bigint), cast(sum(request_cost_time) as bigint), idfa_exist_tag, case coalesce(sum(bid_response),0) when 0 then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end, cast(sum(case when (scenario_entry is null or scenario_entry='') then 0 else scenario_entry end) as bigint), cast(sum(case when (scenario_entry_ready is null or scenario_entry_ready='') then 0 else scenario_entry_ready end) as bigint), abtest_id from $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR_ORC&#125; where dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;' and hh='$&#123;hh&#125;' and dimen in ('1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16') and unit_id is not null and publisher_id is not null and app_id is not null and placement_id is not null and format is not null and sc_type is not null and system_type is not null and os_platform is not null and sdk_version is not null and app_vn is not null and channel is not null and sub_channel is not null and group_id is not null and nw_firm_id is not null and network_id is not null and group_id&gt;=0 and group_id&lt;=2147483647 and format&lt;=10 and estimated_revenue &lt;&gt; 'Infinity' and is_cn_sdk&lt;=1 and length(geo_short)&lt;=2 group by case nw_firm_id when '' then 0 else nw_firm_id end, case group_id when '' then 0 else group_id end, case nw_firm_id when '35' then 1 else unit_id end, case system_type when '' then 0 else system_type end, case sdk_version when 'null' then '0' else sdk_version end, case when app_vn = 'null' then '0' when length(app_vn) &gt;= 50 then '0' else regexp_replace(app_vn,'\\\\\\\\\\\\\\\\0000','') end, case os_platform when '' then 0 else os_platform end, case geo_short when 'null' then '00' else geo_short end, case publisher_id when '' then 0 else publisher_id end, case app_id when '' then 0 else app_id end, case placement_id when '' then 0 when 'null' then 0 else placement_id end, case format when '' then 0 else format end, case sc_type when '' then 0 else sc_type end, case channel when '' then '' else channel end, case sub_channel when '' then '' else sub_channel end, case network_id when '' then 0 else network_id end, case when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end, case when (bidtype is null or bidtype='') then 0 else bidtype end, case when (scenario is null or scenario='') then '1' else scenario end, case when (error_type is null or error_type='') then 0 else error_type end, case when (error_msg is null or error_msg='') then '' else error_msg end, case when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end, case when device_type is null then 1 else device_type end, idfa_exist_tag, abtest_id\"spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \\--name \"BigData_CommonSparkDateTimeJob_merge_report_hour_dt$&#123;yyyy_mm_dd_hh&#125;\" \\--master yarn \\--deploy-mode cluster \\--executor-memory 2g \\--driver-memory 2g \\--executor-cores 2 \\--num-executors 8 \\--conf spark.dynamicAllocation.enabled=false \\--conf spark.dynamicAllocation.minExecutors=8 \\--conf spark.dynamicAllocation.maxExecutors=64 \\--conf spark.core.connection.ack.wait.timeout=300 \\--files \"$&#123;HIVE_SITE_PATH&#125;\" \\$&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_HIVE_PATH&#125; \"$&#123;yyyy_mm_dd_hh&#125;\" \"$&#123;hql&#125;\" \"$&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR&#125;\" \"dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;', hh='$&#123;hh&#125;', dimen='0'\" \"overwrite\"\\ whereæ¡ä»¶åŠ ä¸Šäº†dimen in (&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;10&#39;,&#39;11&#39;,&#39;12&#39;,&#39;13&#39;,&#39;14&#39;,&#39;15&#39;,&#39;16&#39;)ï¼Œä»£è¡¨è¦æ‹¿åˆ°æ‰€æœ‰çˆ¶èŠ‚ç‚¹çš„ä»»åŠ¡æ•°æ® å…¶ä»–çš„whereæ¡ä»¶ä»£è¡¨åœ¨è¿™ä¸ªèŠ‚ç‚¹ï¼Œä¸å¯èƒ½å­˜åœ¨è¿™äº›å­—æ®µæ²¡æœ‰æ•°æ® æŠŠæ•°æ®å†™å…¥åˆ°éorcçš„è¡¨ä¸­ï¼Œå¹¶ä¸” dimen = &#39;0&#39; to_db_tracking_hour æ•°æ®å‡ºä»“åˆ°gp 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859dimension_tk_hour_field=\"date_time,hour,nw_firm_id,group_id,unit_id,system,sdk_version,app_version,platform,geo_short,publisher_id,app_id,placement_id,format,sc_type,channel,sub_channel,hour_timestamp,network_id,traffic_group_id,bid_type,scenario,error_type,error_msg,is_cn_sdk,device_type,idfa_exist_tag \"hive_dimension_tk_hour_field=\"date_time,hour,nw_firm_id,group_id,unit_id,system_type,sdk_version,app_vn,os_platform,geo_short,publisher_id,app_id,placement_id,format,sc_type,channel,sub_channel,hour_timestamp,network_id,traffic_group_id,bidtype,scenario,error_type,error_msg,is_cn_sdk,device_type,idfa_exist_tag\"select_tk_hour_field=\"$&#123;hive_dimension_tk_hour_field&#125;,cast(sum(request) as bigint),cast(sum(filled_request) as bigint),cast(sum(impression) as bigint),cast(sum(click) as bigint),cast(sum(load) as bigint),cast(sum(filled_load) as bigint),cast(sum(rv_play_start) as bigint),cast(sum(rv_play_complete) as bigint),cast(sum(app_request) as bigint),cast(sum(placement_request) as bigint),cast(sum(show) as bigint),cast(sum(impression_optimize) as bigint),cast(sum(bid_request) as bigint),cast(sum(bid_response) as bigint),cast(sum(estimated_revenue) as float),cast(sum(fake_impression_optimize) as bigint),cast(sum(fake_filled_load) as bigint),cast(sum(fake_filled_request) as bigint),cast(sum(load_cost_time) as bigint),cast(sum(request_cost_time) as bigint), case coalesce(sum(bid_response),0) when 0 then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end as bid_response_ecpm,cast(sum(scenario_entry) as bigint),cast(sum(scenario_entry_ready) as bigint) \"export_tk_hour_field=\"$&#123;dimension_tk_hour_field&#125;,request,filled_request,impression,click,loads,filled_loads,rv_start,rv_complete,strategy_app_request,strategy_placement_request,shows,impression_optimize,bid_request,bid_filled_request,estimated_revenue,fake_impression_optimize,fake_filled_load,fake_filled_request,load_cost_time,request_cost_time,bid_filled_request_ecpm,scenario_entry,scenario_entry_ready\"function export_tk_hour_func() &#123; stat_source_hour='report_tk_hour' gp_delete_timeStamp=$(expr $&#123;timeStamp&#125; + 1 \\* 3600) del_sql=\"delete from $&#123;stat_source_hour&#125; where date_time = $&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125; and hour=$&#123;hh&#125; and add_timestamp&lt;$&#123;gp_delete_timeStamp&#125; and source_type not in (2);\" select_sql=\"select $&#123;select_tk_hour_field&#125; from $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR&#125; where dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;' and hh='$&#123;hh&#125;' and dimen='0' group by $&#123;hive_dimension_tk_hour_field&#125;\" # é’ˆå¯¹ä¸¤ä¸ªåº“çš„åˆ é™¤å’Œå¯¼å…¥ export_to_pgsql_by_select_data \"$&#123;select_sql&#125;\" $&#123;stat_source_hour&#125; bigdata_job_base_data_report_hour_$&#123;RANDOM&#125;_tmp.log \"$&#123;del_sql&#125;\" '|' \"($&#123;export_tk_hour_field&#125;)\"&#125;export_to_pgsql_by_select_data() &#123; el_sql=$1 el_stat_source=$2 el_tmp_file=$3 el_delete_sql=$4 el_terminated=$5 el_rows=$6 filepath=$( cd \"$(dirname \"$0\")\" pwd ) fileTmpDir=tmp_$&#123;el_stat_source&#125;/$&#123;el_stat_source&#125;/ if [ -f \"$&#123;el_tmp_file&#125;\" ]; then rm $&#123;el_tmp_file&#125; fi hive -e \" INSERT OVERWRITE DIRECTORY '$&#123;fileTmpDir&#125;' ROW format delimited fields terminated BY '$&#123;el_terminated&#125;' $&#123;el_sql&#125; \" hadoop fs -getmerge $&#123;fileTmpDir&#125;* $&#123;el_tmp_file&#125; head -n 20 $&#123;el_tmp_file&#125; #export to pgsql echo \"copy $&#123;el_stat_source&#125; $&#123;el_rows&#125; from STDIN delimiter as '$&#123;el_terminated&#125;';\" sql=\"copy $&#123;el_stat_source&#125; $&#123;el_rows&#125; from STDIN delimiter as '$&#123;el_terminated&#125;'\" if [[ $&#123;PG_BI_DB_ENABLE&#125; = true ]]; then psql \"host=$&#123;PG_BI_DB_HOST&#125; port=$&#123;PG_BI_DB_PORT&#125; user=$&#123;PG_BI_DB_USER&#125; password=$&#123;PG_BI_DB_PWD&#125; dbname=$&#123;PG_BI_DB_NAME&#125;\" -c \"$&#123;el_delete_sql&#125;\" psql \"host=$&#123;PG_BI_DB_HOST&#125; port=$&#123;PG_BI_DB_PORT&#125; user=$&#123;PG_BI_DB_USER&#125; password=$&#123;PG_BI_DB_PWD&#125; dbname=$&#123;PG_BI_DB_NAME&#125;\" -c \"$&#123;sql&#125;\" &lt;$&#123;el_tmp_file&#125; fi if [[ $&#123;PG_REL_BI_DB_ENABLE&#125; = true ]]; then psql \"host=$&#123;PG_REL_BI_DB_HOST&#125; port=$&#123;PG_REL_BI_DB_PORT&#125; user=$&#123;PG_REL_BI_DB_USER&#125; password=$&#123;PG_REL_BI_DB_PWD&#125; dbname=$&#123;PG_REL_BI_DB_NAME&#125;\" -c \"$&#123;el_delete_sql&#125;\" psql \"host=$&#123;PG_REL_BI_DB_HOST&#125; port=$&#123;PG_REL_BI_DB_PORT&#125; user=$&#123;PG_REL_BI_DB_USER&#125; password=$&#123;PG_REL_BI_DB_PWD&#125; dbname=$&#123;PG_REL_BI_DB_NAME&#125;\" -c \"$&#123;sql&#125;\" &lt;$&#123;el_tmp_file&#125; fi rm $&#123;el_tmp_file&#125; hadoop fs -rmr $&#123;fileTmpDir&#125;&#125;export_tk_hour_func æŠŠæ•°æ®é€šè¿‡sqlæŸ¥å‡ºæ¥ï¼Œç„¶åé€šè¿‡ | ç¬¦å·è¿›è¡Œåˆ†å‰²ï¼Œç„¶åå†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ åˆ é™¤å½“å‰å°æ—¶å‘¨æœŸä¸‹çš„æ•°æ® é€šè¿‡ copy å‘½ä»¤åˆ—å‡ºæ‰€æœ‰çš„å­—æ®µï¼Œç„¶åé€šè¿‡æ ‡å‡†è¾“å…¥STDIN ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä»ä¸´æ—¶æ–‡ä»¶ä¸­å¯¼å…¥æ•°æ® to_db_traking æŠŠå°æ—¶çº§è¡¨çš„æ•°æ®åˆå¹¶åˆ°å¤©çº§è¡¨ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119# å¤©è¡¨çš„æ•°æ®éƒ½æ¥è‡ªäºå°æ—¶è¡¨ï¼Œä»å°æ—¶è¡¨å¯¼å‡ºåå¯¼å…¥å¤©è¡¨# tkè¡¨åŠä¸œå…«åŒºçš„æ—¶é—´å’Œå°æ—¶è¡¨çš„æ—¶é—´ä¸€æ ·ï¼Œ0æ—¶åŒºå’Œè¥¿å…«åŒºéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹currentUnixTime=$(date '+%s')tmpTkHourFileName=\"/data/gp_tk_tmp/report_tk_utce8_$&#123;currentUnixTime&#125;.log\" # æ­¤æ–‡ä»¶æ˜¯åœ¨GPæœåŠ¡å™¨ä¸Šé¢çš„ï¼Œéœ€è¦æœ‰ä¸“é—¨çš„ä»»åŠ¡å»åšæ¸…é™¤# å‚ç…§æ”¶ç›Šä»»åŠ¡hourå°æ—¶æ•°æ®åˆ°å¤©çº§æ•°æ®çš„å¤„ç†æ–¹å¼: export_report_unit_hour.shCurrentDay=$&#123;utce8_yyyy&#125;$&#123;utce8_mm&#125;$&#123;utce8_dd&#125;# æœºå™¨ä¸ºé›¶æ—¶åŒºstartTimeStamp=`date -d \"8 hour ago $&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 00:00:00\" +%s`endTimeStamp=`date -d \"8 hour ago $&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 23:59:59\" +%s`# estimate_revenue_api,estimate_currency_revenue_api,ready_request,ready_success,show_failed ç”±ltvä»»åŠ¡å†™å…¥pgSearchSql=\"SELECT $&#123;CurrentDay&#125;, nw_firm_id, group_id, geo_short, publisher_id, channel, sub_channel, system, platform, app_id, sdk_version, app_version, placement_id, unit_id, format, sc_type, SUM(request), SUM(filled_request), SUM(strategy_app_request), SUM(strategy_placement_request), SUM(impression), SUM(shows), SUM(click), SUM(loads), SUM(filled_loads), SUM(rv_start), SUM(rv_complete), SUM(impression_optimize), network_id, bid_type, SUM(estimated_revenue), traffic_group_id, SUM(bid_request), SUM(bid_filled_request), case when (scenario is null or scenario='') then '1' else scenario end, error_type, case when (error_msg is null or error_msg='') then '' else error_msg end, SUM(fake_impression_optimize), SUM(fake_filled_load), SUM(fake_filled_request), is_cn_sdk, device_type, source_type, SUM(load_cost_time), SUM(request_cost_time), idfa_exist_tag, case coalesce(sum(bid_filled_request),0) when 0 then 0.0 else cast(sum(bid_filled_request * bid_filled_request_ecpm) / sum(bid_filled_request) as float) end, SUM(scenario_entry), SUM(scenario_entry_ready)FROM report_tk_hourWHERE hour_timestamp &gt;= $&#123;startTimeStamp&#125; AND hour_timestamp &lt;= $&#123;endTimeStamp&#125; AND source_type NOT IN (2) AND add_timestamp &lt; $&#123;gp_delete_timeStamp&#125;GROUP BY nw_firm_id, group_id, geo_short, publisher_id, channel, sub_channel, system, platform, app_id, sdk_version, app_version, placement_id, unit_id, format, sc_type, network_id, bid_type, traffic_group_id, case when (scenario is null or scenario='') then '1' else scenario end, error_type, case when (error_msg is null or error_msg='') then '' else error_msg end, is_cn_sdk, device_type, source_type, idfa_exist_tag \"# å¯¼å‡ºæ•°æ®ï¼Œreport_tk å’Œ report_tk_utce8 è¡¨æ•°æ®ä¸€è‡´ï¼Œåªç”¨å¯¼å‡ºä¸€æ¬¡ä¾¿å¯outputSql=\"COPY ( $&#123;pgSearchSql&#125; ) TO '$&#123;tmpTkHourFileName&#125;' WITH CSV;\"export PGPASSWORD=$&#123;PG_BI_DB_PWD&#125;psql --host=$&#123;PG_BI_DB_HOST&#125; --port=$&#123;PG_BI_DB_PORT&#125; --user=$&#123;PG_BI_DB_USER&#125; --dbname=$&#123;PG_BI_DB_NAME&#125; -c \"$&#123;outputSql&#125;\"deleteSql=\"DELETE FROM report_tk_utce8 WHERE date_time = $&#123;CurrentDay&#125; AND source_type NOT IN (2) AND add_timestamp &lt; $&#123;gp_delete_timeStamp&#125;;\"inputSql=\"COPY report_tk_utce8 ( $&#123;rowNames&#125; ) FROM '$&#123;tmpTkHourFileName&#125;' WITH CSV;\"export PGPASSWORD=$&#123;PG_BI_DB_PWD&#125;respTag10=`psql --host=$&#123;PG_BI_DB_HOST&#125; --port=$&#123;PG_BI_DB_PORT&#125; --user=$&#123;PG_BI_DB_USER&#125; --dbname=$&#123;PG_BI_DB_NAME&#125; &lt;&lt;EOFBEGIN;$&#123;deleteSql&#125;$&#123;inputSql&#125;COMMIT;EOF`echo $&#123;respTag10&#125;if [[ $&#123;respTag10&#125; =~ \"ROLLBACK\" ]] ; then exit 1fi å…ˆæŠŠæ•°æ®å¯¼å‡ºåˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶${tmpTkHourFileName} å†æŠŠæ•°æ®ä»ä¸´æ—¶æ–‡ä»¶å¯¼å…¥åˆ°å¦å¤–ä¸€ä¸ªå¤©çº§è¡¨report_tk_utce8 utc0/utcw8æ—¶åŒºçš„ä¸€æ ·çš„æ“ä½œ merge_tracking_hour123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131#è½¬æ¢æˆutc8æ—¶é—´utce8_day_start_timeStamp=`date -d \"$&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 00:00:00\" +%s`utce8_day_end_timeStamp=`date -d \"$&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 23:00:00\" +%s`while_run_stamp=$&#123;utce8_day_start_timeStamp&#125;utce8_utc0_hour_where='('while [ \"$&#123;while_run_stamp&#125;\" -le \"$&#123;utce8_day_end_timeStamp&#125;\" ]do tmp_run_stamp=`expr $&#123;while_run_stamp&#125; - 8 \\* 3600` tmp_date_time=`date -d @$&#123;tmp_run_stamp&#125; \"+%Y-%m-%d-%H\"` tmp_yyyy=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $1&#125;'` tmp_mm=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $2&#125;'` tmp_dd=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $3&#125;'` tmp_hh=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $4&#125;'` if [ \"$&#123;while_run_stamp&#125;\" == \"$&#123;utce8_day_start_timeStamp&#125;\" ] then utce8_utc0_hour_where=\"$&#123;utce8_utc0_hour_where&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hh='$&#123;tmp_hh&#125;'\" else utce8_utc0_hour_where=\"$&#123;utce8_utc0_hour_where&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hh='$&#123;tmp_hh&#125;'\" fi while_run_stamp=`expr $&#123;while_run_stamp&#125; + 3600`doneutce8_utc0_hour_where=\"$&#123;utce8_utc0_hour_where&#125;)\"hql=\"select $&#123;utce8_yyyy&#125;$&#123;utce8_mm&#125;$&#123;utce8_dd&#125;, nw_firm_id, group_id, unit_id, system_type, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_id, placement_id, format, sc_type, cast(sum(request) as bigint), cast(sum(filled_request) as bigint), cast(sum(impression) as bigint), cast(sum(click) as bigint), cast(sum(load) as bigint), cast(sum(filled_load) as bigint), cast(sum(rv_play_start) as bigint), cast(sum(rv_play_complete) as bigint), channel, sub_channel, cast(sum(app_request) as bigint), cast(sum(placement_request) as bigint), cast(sum(show) as bigint), cast(sum(impression_optimize) as bigint), case when network_id is null then 0 else network_id end, case when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end, case when (bidtype is null or bidtype='') then 0 else bidtype end, cast(sum(case when (bid_request is null or bid_request='') then 0 else bid_request end) as bigint), cast(sum(case when (bid_response is null or bid_response='') then 0 else bid_response end) as bigint), cast(sum(case when (estimated_revenue is null or estimated_revenue='') then 0 else estimated_revenue end) as float), 0, 0, case when (scenario is null or scenario='') then '1' else scenario end, case when (error_type is null or error_type='') then 0 else error_type end, case when (error_msg is null or error_msg='') then '' else error_msg end, cast(sum(case when (fake_impression_optimize is null or fake_impression_optimize='') then impression_optimize else fake_impression_optimize end) as bigint), cast(sum(case when (fake_filled_load is null or fake_filled_load='') then filled_load else fake_filled_load end) as bigint), cast(sum(case when (fake_filled_request is null or fake_filled_request='') then filled_request else fake_filled_request end) as bigint), case when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end, 0, 0, 0, case when device_type is null then 1 else device_type end, cast(sum(case when load_cost_time is null or load_cost_time&lt;0 then 0 else load_cost_time end) as bigint), cast(sum(case when request_cost_time is null or request_cost_time&lt;0 then 0 else request_cost_time end) as bigint), case when idfa_exist_tag is null then 0 else idfa_exist_tag end, case coalesce(sum(bid_response),0) when 0 then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end, cast(coalesce(sum(scenario_entry),0) as bigint), cast(coalesce(sum(scenario_entry_ready),0) as bigint), abtest_id from $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR&#125; where $&#123;utce8_utc0_hour_where&#125; and dimen='0' and group_id&gt;=0 and group_id&lt;=2147483647 group by nw_firm_id, group_id, unit_id, system_type, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_id, placement_id, format, sc_type, channel, sub_channel, case when network_id is null then 0 else network_id end, case when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end, case when (bidtype is null or bidtype='') then 0 else bidtype end, case when (scenario is null or scenario='') then '1' else scenario end, case when (error_type is null or error_type='') then 0 else error_type end, case when (error_msg is null or error_msg='') then '' else error_msg end, case when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end, case when device_type is null then 1 else device_type end, case when idfa_exist_tag is null then 0 else idfa_exist_tag end, abtest_id\"spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \\--name \"BigData_CommonSparkDateTimeJob_merge_report_utce8_dt$&#123;yyyy_mm_dd_hh&#125;\" \\--master yarn \\--deploy-mode cluster \\--executor-memory 2g \\--driver-memory 2g \\--executor-cores 2 \\--num-executors 8 \\--conf spark.dynamicAllocation.enabled=false \\--conf spark.dynamicAllocation.minExecutors=8 \\--conf spark.dynamicAllocation.maxExecutors=64 \\--conf spark.core.connection.ack.wait.timeout=300 \\--files \"$&#123;HIVE_SITE_PATH&#125;\" \\$&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_HIVE_PATH&#125; \"$&#123;yyyy_mm_dd_hh&#125;\" \"$&#123;hql&#125;\" \"$&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_UTCE8&#125;\" \"dt='$&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125;', dimen='0'\" \"overwrite\"\\ æ•°æ®é€šè¿‡å°æ—¶è¡¨è½¬æˆreport_tkè¡¨ï¼Œå¹¶ä¸” dimen=&#39;0&#39; abtest_tk_xxx ä¸šåŠ¡éœ€è¦ï¼Œæ ¹æ®abtest_idï¼ŒæŠŠæ•°æ®åˆ†åˆ«æˆä¸åŒçš„traffi_group_idï¼ŒåŸå§‹çš„æ•°æ®çš„abtest_idå­—æ®µä¼šå˜æˆ&amp;&amp;ï¼Œåˆ†åˆ«å‡ºæ¥çš„ä¼šå˜æˆ00 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198tk_dimen='0'abtest_tk_tmp_dimen=\"10$&#123;tk_dimen&#125;\"zone_type=$1if [ -n \"$&#123;run_type&#125;\" ]; then if [[ $&#123;run_type&#125; = 'utcw8' ]]; then zone_type=\"3\" else if [[ $&#123;run_type&#125; = 'utc0' ]]; then zone_type=\"2\" else zone_type=\"1\" fi fifizone_yyyy=\"$&#123;yyyy&#125;\"zone_mm=\"$&#123;mm&#125;\"zone_dd=\"$&#123;dd&#125;\"zone_tk_table=\"$&#123;T_BIGDATA_REPORT_TK_UTCE8&#125;\"zone_abtest_tk_table=\"$&#123;T_BIGDATA_REPORT_ABTEST_TK_UTCE8&#125;\"zone_gp_abtest_tk_table=\"report_abtest_tk_utce8\"if [ \"$&#123;zone_type&#125;\" == \"2\" ]; then zone_yyyy=\"$&#123;utc0_yyyy&#125;\" zone_mm=\"$&#123;utc0_mm&#125;\" zone_dd=\"$&#123;utc0_dd&#125;\" zone_tk_table=\"$&#123;T_BIGDATA_REPORT_TK_UTC0&#125;\" zone_abtest_tk_table=\"$&#123;T_BIGDATA_REPORT_ABTEST_TK_UTC0&#125;\" zone_gp_abtest_tk_table=\"report_abtest_tk_utc0\"else if [ \"$&#123;zone_type&#125;\" == \"3\" ]; then zone_yyyy=\"$&#123;utcw8_yyyy&#125;\" zone_mm=\"$&#123;utcw8_mm&#125;\" zone_dd=\"$&#123;utcw8_dd&#125;\" zone_tk_table=\"$&#123;T_BIGDATA_REPORT_TK_UTCW8&#125;\" zone_abtest_tk_table=\"$&#123;T_BIGDATA_REPORT_ABTEST_TK_UTCW8&#125;\" zone_gp_abtest_tk_table=\"report_abtest_tk_utcw8\" fifihql=\"select date_time, nw_firm_id, group_id, unit_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_id, placement_id, format, device_type, channel, network_id, case when abtest_id is null then '' else abtest_id end as abtest_id, traffic_group_id, bidtype, cast(sum(request) as bigint), cast(sum(filled_request) as bigint), cast(sum(impression) as bigint), cast(sum(click) as bigint), cast(sum(load) as bigint), cast(sum(filled_load) as bigint), cast(sum(rv_play_start) as bigint), cast(sum(rv_play_complete) as bigint), cast(sum(show) as bigint), cast(sum(impression_optimize) as bigint), cast(sum(case when (bid_request is null or bid_request='') then 0 else bid_request end) as bigint), cast(sum(case when (bid_response is null or bid_response='') then 0 else bid_response end) as bigint), cast(sum(case when (estimated_revenue is null or estimated_revenue='') then 0 else estimated_revenue end) as float), cast(sum(case when (estimate_revenue_api is null or estimate_revenue_api='') then 0 else estimate_revenue_api end) as float), cast(sum(case when (estimate_currency_revenue_api is null or estimate_currency_revenue_api='') then 0 else estimate_currency_revenue_api end) as float), cast(sum(case when (fake_impression_optimize is null or fake_impression_optimize='') then impression_optimize else fake_impression_optimize end) as bigint), cast(sum(case when (fake_filled_load is null or fake_filled_load='') then filled_load else fake_filled_load end) as bigint), cast(sum(case when (fake_filled_request is null or fake_filled_request='') then filled_request else fake_filled_request end) as bigint), sum(ready_request), sum(ready_success), sum(show_failed) from $&#123;DB_BIGDATA&#125;.$&#123;zone_tk_table&#125; where dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;' and dimen='$&#123;tk_dimen&#125;' group by date_time, nw_firm_id, group_id, unit_id, sdk_version, app_vn, os_platform, geo_short, publisher_id, app_id, placement_id, format, device_type, channel, network_id, case when abtest_id is null then '' else abtest_id end, traffic_group_id, bidtype \"spark-submit --class com.BigData.spark.parse.jobs.ParseAndSpiltAbtestTkJob \\ --name \"BigData_ParseAndSpiltAbtestTkJob_abtest_dt$&#123;yyyy_mm_dd_hh&#125;_$&#123;zone_type&#125;\" \\ --master yarn \\ --deploy-mode cluster \\ --executor-memory 2g \\ --driver-memory 2g \\ --executor-cores 2 \\ --num-executors 8 \\ --conf spark.dynamicAllocation.enabled=false \\ --conf spark.dynamicAllocation.minExecutors=32 \\ --conf spark.dynamicAllocation.maxExecutors=64 \\ --conf spark.core.connection.ack.wait.timeout=300 \\ --files \"$&#123;HIVE_SITE_PATH&#125;\" \\ $&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_PATH&#125; \"$&#123;yyyy_mm_dd_hh&#125;\" \"$&#123;hql&#125;\" \"abtest_id\" \"traffic_group_id\" \"$&#123;DB_BIGDATA&#125;.$&#123;zone_abtest_tk_table&#125;\" \"dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;', dimen='$&#123;abtest_tk_tmp_dimen&#125;'\"# åˆå¹¶åˆ†è§£åçš„æ•°æ®# å†æ¬¡å‡å°‘ç»´åº¦æ•°æ®merge_hql=\" select date_time, 0 as nw_firm_id, 0 as group_id, 0 as unit_id, '', '', 0 as os_platform, geo_short, publisher_id, app_id, placement_id, -1 as format, -1 as device_type, '', 0, case when abtest_id &lt;&gt;'&amp;&amp;' then '00' else abtest_id end as abtest_id, traffic_group_id, -1 as bidtype, cast(sum(request) as bigint), cast(sum(filled_request) as bigint), cast(sum(impression) as bigint), cast(sum(click) as bigint), cast(sum(load) as bigint), cast(sum(filled_load) as bigint), cast(sum(rv_play_start) as bigint), cast(sum(rv_play_complete) as bigint), cast(sum(show) as bigint), cast(sum(impression_optimize) as bigint), cast(sum(case when (bid_request is null or bid_request='') then 0 else bid_request end) as bigint), cast(sum(case when (bid_response is null or bid_response='') then 0 else bid_response end) as bigint), cast(sum(case when (estimated_revenue is null or estimated_revenue='') then 0 else estimated_revenue end) as float), cast(sum(case when (estimate_revenue_api is null or estimate_revenue_api='') then 0 else estimate_revenue_api end) as float), cast(sum(case when (estimate_currency_revenue_api is null or estimate_currency_revenue_api='') then 0 else estimate_currency_revenue_api end) as float), cast(sum(case when (fake_impression_optimize is null or fake_impression_optimize='') then impression_optimize else fake_impression_optimize end) as bigint), cast(sum(case when (fake_filled_load is null or fake_filled_load='') then filled_load else fake_filled_load end) as bigint), cast(sum(case when (fake_filled_request is null or fake_filled_request='') then filled_request else fake_filled_request end) as bigint), sum(ready_request), sum(ready_success), sum(show_failed) from $&#123;DB_BIGDATA&#125;.$&#123;zone_abtest_tk_table&#125; where dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;' and dimen='$&#123;abtest_tk_tmp_dimen&#125;' group by date_time, geo_short, publisher_id, app_id, placement_id, case when abtest_id &lt;&gt;'&amp;&amp;' then '00' else abtest_id end, traffic_group_id \"spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \\ --name \"BigData_CommonSparkDateTimeJob_merge_strategy_app_dt$&#123;yyyy_mm_dd_hh&#125;\" \\ --master yarn \\ --deploy-mode cluster \\ --executor-memory 2g \\ --driver-memory 2g \\ --executor-cores 2 \\ --num-executors 8 \\ --conf spark.dynamicAllocation.enabled=false \\ --conf spark.dynamicAllocation.minExecutors=32 \\ --conf spark.dynamicAllocation.maxExecutors=64 \\ --conf spark.core.connection.ack.wait.timeout=300 \\ --files \"$&#123;HIVE_SITE_PATH&#125;\" \\ $&#123;SPARK_SQL_JAR&#125; $&#123;CLIENT_TMP_LOG_PATH&#125; \"$&#123;yyyy_mm_dd_hh&#125;\" \"$&#123;merge_hql&#125;\" \"$&#123;DB_BIGDATA&#125;.$&#123;zone_abtest_tk_table&#125;\" \"dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;', dimen='$&#123;tk_dimen&#125;'\" \"overwrite\"source ./export_tk_util.shexport_abtest_tk_func \"$&#123;DB_BIGDATA&#125;.$&#123;zone_abtest_tk_table&#125;\" \" dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;' and dimen='$&#123;tk_dimen&#125;' and traffic_group_id&gt;0\" \"$&#123;zone_gp_abtest_tk_table&#125;\" \"date_time=$&#123;zone_yyyy&#125;$&#123;zone_mm&#125;$&#123;zone_dd&#125; and add_timestamp&lt;$&#123;gp_delete_timeStamp&#125; and source_type not in (2)\" æŠŠæ•°æ®ä¼ é€’è¿›åˆ°sparkè„šæœ¬ä¸­ï¼Œåœ¨sparkä¸­æŠŠæ•°æ®è¿›è¡Œåˆ†è£‚ï¼Œç„¶åå­˜æ”¾åœ¨å¯¹åº”çš„dimen = &#39;100&#39; ä»è¡¨ä¸­çš„dimen = &#39;100&#39;ä¸­æå–æ•°æ®ï¼ŒæŠŠæ•°æ®çš„ç»´åº¦å†æ¬¡ç¼©å° sparkä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495object ParseAndSpiltAbtestTkJob &#123; def main(args: Array[String]): Unit &#x3D; &#123; val tmpPath &#x3D; parseArg(args(0)) &#x2F;&#x2F;format:yyyy-mm-dd-hh val dt &#x3D; args(1) val selectSql &#x3D; parseArg(args(2)) val abtestField &#x3D; args(3) val trafficGroupField &#x3D; args(4) val outputTable &#x3D; parseArg(args(5)) val partition &#x3D; args(6) var trafficGroupFieldRaw &#x3D; &quot;&amp;&amp;&quot; var trafficGroupFieldNew &#x3D; &quot;&quot; if (args.length &gt;&#x3D; 8) &#123; trafficGroupFieldRaw &#x3D; args(7) &#125; if (args.length &gt;&#x3D; 9) &#123; trafficGroupFieldNew &#x3D; args(8) &#125; val sparkSession: SparkSession &#x3D; SparkSession.builder &#x2F;&#x2F; .master(&quot;local[3]&quot;) .enableHiveSupport() &#x2F;&#x2F; self-explanatory, isn&#39;t it? .config(&quot;spark.sql.warehouse.dir&quot;, tmpPath) .getOrCreate sparkSession.sqlContext.setConf(&quot;hive.merge.mapfiles&quot;, &quot;true&quot;) sparkSession.sqlContext.setConf(&quot;mapred.max.split.size&quot;, &quot;256000000&quot;) sparkSession.sqlContext.setConf(&quot;mapred.min.split.size.per.node&quot;, &quot;192000000&quot;) sparkSession.sqlContext.setConf(&quot;mapred.min.split.size.per.rack&quot;, &quot;192000000&quot;) sparkSession.sqlContext.setConf(&quot;hive.input.format&quot;, &quot;org.apache.hadoop.hive.ql.io.CombineHiveInputFormat&quot;) val rawData &#x3D; sparkSession.sql(selectSql) val newRdd: RDD[Row] &#x3D; rawData.rdd.map(row &#x3D;&gt; &#123; &#x2F;&#x2F; System.out.println(&quot;--------------------------------------&quot;, row.toString()) var resultList: ArrayBuffer[Row] &#x3D; new ArrayBuffer[Row]() val tkRows &#x3D; mapSpiltFunc(row, abtestField, trafficGroupField, trafficGroupFieldRaw, trafficGroupFieldNew) if (tkRows !&#x3D; null &amp;&amp; tkRows.nonEmpty) &#123; resultList ++&#x3D; tkRows &#125; resultList &#125;).flatMap(row &#x3D;&gt; row) &#x2F;&#x2F;é€šè¿‡æ—¶é—´æˆ³éšæœºè¡¨å val time &#x3D; System.currentTimeMillis() % 100000000; val tmpTable &#x3D; &quot;spark_CommonSparkDateTimeJob_&quot; + time + &quot;_table&quot; sparkSession.createDataFrame(newRdd, rawData.schema).registerTempTable(tmpTable) val insertString &#x3D; &quot;insert overwrite table &quot; + outputTable + &quot; partition(&quot; + partition + &quot;) select * from &quot; + tmpTable sparkSession.sql(insertString) sparkSession.stop() &#125; def parseArg(arg: String): String &#x3D; &#123; var tmpArg &#x3D; arg if (tmpArg.startsWith(&quot;&#39;&quot;)) &#123; tmpArg &#x3D; tmpArg.substring(1); &#125; if (tmpArg.endsWith(&quot;&#39;&quot;)) &#123; tmpArg &#x3D; tmpArg.substring(0, tmpArg.length() - 1); &#125; tmpArg; &#125; def mapSpiltFunc(row: Row, abtestField: String, trafficGroupField: String, trafficGroupFieldRaw: String, trafficGroupFieldNew: String): ArrayBuffer[Row] &#x3D; &#123; var resultList: ArrayBuffer[Row] &#x3D; new ArrayBuffer[Row]() val abtest &#x3D; row.getAs[String](abtestField) val rowRawArray &#x3D; row.toSeq.toArray val trafficGroupIndex &#x3D; row.fieldIndex(trafficGroupField) val abtestGroupIndex &#x3D; row.fieldIndex(abtestField) val curtGroupId &#x3D; row.getAs[String](trafficGroupField) if (!TextUtils.isEmpty(curtGroupId) &amp;&amp; curtGroupId &gt; &quot;0&quot;) &#123; val newCurGroupRow &#x3D; rowRawArray.clone() if (trafficGroupFieldRaw.isEmpty) &#123; newCurGroupRow(abtestGroupIndex) &#x3D; &quot;&amp;&amp;&quot; &#125; else &#123; newCurGroupRow(abtestGroupIndex) &#x3D; trafficGroupFieldRaw; &#125; resultList +&#x3D; Row.fromSeq(newCurGroupRow) &#125; if (TextUtils.isEmpty(abtest) || abtest.equals(&quot;&#123;&#125;&quot;)) &#123; return resultList &#125; val tGroupIDs &#x3D; AbtestTkParsing.getTrafficGroupIDs(abtest) for (groupId &lt;- tGroupIDs) &#123; if (!groupId.equals(curtGroupId)) &#123; val newGroupRow &#x3D; rowRawArray.clone() if (trafficGroupFieldNew.nonEmpty) &#123; newGroupRow(abtestGroupIndex) &#x3D; trafficGroupFieldNew &#125; newGroupRow(trafficGroupIndex) &#x3D; groupId; resultList +&#x3D; Row.fromSeq(newGroupRow) &#125; &#125; resultList &#125; è‡³æ­¤ï¼Œä¸€ä¸ªåŸºæœ¬çš„å°æ—¶ä»»åŠ¡çš„å¤§æ•°æ®ETLæœåŠ¡å°±åšå®Œäº†è¯¥ä½œçš„äº‹æƒ…äº†","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"å…¬å¸","slug":"å…¬å¸","permalink":"http://blog.crazylaw.cn/tags/%E5%85%AC%E5%8F%B8/"}]},{"title":"ã€å¹¿å‘Šè¡Œä¸šã€‘çŸ¥è¯†ç‚¹","slug":"å…¬å¸/å¹¿å‘Šè¡Œä¸šçŸ¥è¯†ç‚¹","date":"2022-04-12T01:53:00.000Z","updated":"2022-04-12T12:20:15.427Z","comments":true,"path":"2022/04/12/å…¬å¸/å¹¿å‘Šè¡Œä¸šçŸ¥è¯†ç‚¹/","link":"","permalink":"http://blog.crazylaw.cn/2022/04/12/%E5%85%AC%E5%8F%B8/%E5%B9%BF%E5%91%8A%E8%A1%8C%E4%B8%9A%E7%9F%A5%E8%AF%86%E7%82%B9/","excerpt":"å‰è¨€ç”±äºå¹¿å‘Šè¡Œä¸šæœ‰ä¼—å¤šçš„çŸ¥è¯†ç‚¹ï¼Œæ‰€ä»¥è®°å½•ä¸€ç¯‡æ–‡ç« ç”¨ä»¥äº†è§£ç›¸å…³çš„ä¸“ä¸šåè¯å’Œæœ¯è¯­ï¼Œå¹¶ä¸”åŠ æ·±äº†è§£çš„å°è±¡ã€‚","text":"å‰è¨€ç”±äºå¹¿å‘Šè¡Œä¸šæœ‰ä¼—å¤šçš„çŸ¥è¯†ç‚¹ï¼Œæ‰€ä»¥è®°å½•ä¸€ç¯‡æ–‡ç« ç”¨ä»¥äº†è§£ç›¸å…³çš„ä¸“ä¸šåè¯å’Œæœ¯è¯­ï¼Œå¹¶ä¸”åŠ æ·±äº†è§£çš„å°è±¡ã€‚ å¤´éƒ¨ç«ä»·Header Biddingï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¤´éƒ¨ç«ä»·ï¼Œè·Ÿå…¶ç›¸å¯¹åº”çš„å°±æ˜¯Waterfallï¼Œç€‘å¸ƒæµã€‚åœ¨Header Biddingé£é¡ä¹‹å‰ï¼ŒWaterfallæ‰æ˜¯å„å®¶å¹¿å‘Šå¹³å°çš„ä¸»æµç«ä»·æ–¹å¼ã€‚æƒ³è¦äº†è§£Header Biddingï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å…ˆå¼„æ¸…æ¥šä»€ä¹ˆæ˜¯Waterfalläº†ã€‚ è¿™é‡Œæ¶‰åŠåˆ°çš„è§’è‰²æœ‰å¼€å‘è€…ï¼ˆpublisherï¼‰ï¼Œå¹¿å‘Šè°ƒè§£å¹³å°ï¼ˆmediation platformï¼‰ï¼Œéœ€æ±‚æ–¹ï¼ˆdemand partnerï¼‰ã€‚é¦–å…ˆï¼Œå¹¿å‘Šè°ƒè§£å¹³å°æ‰®æ¼”ä¸€ä¸ªï¼ˆä¸­ç«‹ï¼‰çš„ç¬¬ä¸‰æ–¹è§’è‰²ï¼Œæ¥å…¥äº†å¤šå®¶å¹¿å‘Šå¹³å°çš„å¹¿å‘Šæºï¼Œæ¯”å¦‚Facebookï¼ŒVungleï¼ŒFyberï¼ŒApplovinç­‰ï¼Œå³å°†å„å®¶çš„å¹¿å‘Šæ”¾åˆ°ä¸€ä¸ªSDKä¸­ï¼Œè¿™æ—¶å€™å¼€å‘è€…å¦‚æœæƒ³è¦å˜ç°è‡ªå®¶çš„æµé‡ï¼Œåªéœ€æ¥å…¥å¹¿å‘Šè°ƒè§£å¹³å°çš„SDKå³å¯ï¼Œå†é€šè¿‡ä¸€ä¸ªç®€å•çš„é…ç½®å³å¯è‡ªä¸»å†³å®šæ¥é€šå“ªå‡ å®¶çš„å¹¿å‘Šæºäº†ï¼Œè€Œä¸éœ€è¦æ¯å®¶çš„å¹¿å‘ŠSDKéƒ½æ¥ä¸€éï¼Œçœæ—¶çœåŠ›ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ£’ï¼Ÿ é‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ã€‚å¼€å‘è€…é€šè¿‡è°ƒè§£å¹³å°çš„SDKä»‹å…¥äº†å¤šå®¶çš„å¹¿å‘Šæºåï¼Œæµé‡æ”¹æ€ä¹ˆåˆ†é…å‘¢ï¼ŸåŒä¸€ä¸ªå¹¿å‘Šè¯·æ±‚ï¼ˆad requestï¼‰åˆ°åº•æ˜¯è¯¥å‘ç»™Facebookï¼Œè¿˜æ˜¯googleè¿˜æ˜¯vungleè¿˜æ˜¯å…¶ä»–äººå‘¢ï¼Ÿè¿™æ—¶å€™å°±æ¶‰åŠåˆ°è°ƒè§£å¹³å°çš„ç®—æ³•é€»è¾‘äº†ï¼Œé€šå¸¸ï¼Œè¿™ä¸ªè°ƒè§£å¹³å°ä¼šå¯¹ç»™æ–°ä»‹å…¥çš„å¹¿å‘Šå¹³å°åˆ†é…ä¸€å®šçš„æµé‡ï¼Œæµ‹è¯•ä¸‹å…¶è¡¨ç°ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªå¤§æ¦‚çš„eCPMçš„å€¼ï¼›ç„¶åï¼Œè°ƒè§£å¹³å°ä¼šæ ¹æ®ä¸åŒçš„å¹¿å‘Šå¹³å°åœ¨è¿‡å»24å°æ—¶å†…çš„eCPMçš„é«˜ä½æ¥æ’åºï¼Œå¹¿å‘Šè¯·æ±‚ä¼˜å…ˆå‘ç»™eCPMæœ€é«˜çš„ç¬¬ä¸€ä½é€‰æ‰‹ï¼Œè‹¥æ²¡æœ‰å¡«å……ï¼ˆfillï¼‰ï¼Œå°±ä¸‹ä¸€ä¸ªï¼Œæ²¡æœ‰å¡«å……å°±å†ä¸‹ä¸€ä¸ªï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚Waterfallåˆšå‡ºæ¥çš„æ—¶å€™çœŸçš„æ˜¯ä¸€ä¸ªè¶…çº§æ£’çš„æ¦‚å¿µï¼Œå¾ˆå¥½åœ°è§£å†³äº†å¼€å‘è€…æµé‡å˜ç°æœ€å¤§åŒ–çš„é—®é¢˜ã€‚ ä½†æ˜¯ï¼Œé—®é¢˜åˆæ¥äº†ã€‚æ˜¨å¤©æ’åœ¨ç¬¬ä¸€çš„å¹¿å‘Šå¹³å°ï¼Œè°èƒ½ä¿è¯å®ƒä»Šå¤©ç»™çš„eCPMä¹Ÿæ˜¯è¶³å¤Ÿé«˜è€Œæ’åœ¨ç¬¬ä¸€ä½å‘¢ï¼Ÿåˆæˆ–è€…ï¼Œæ˜¨å¤©æ’åœ¨ç¬¬ä¸‰ä½çš„å¹¿å‘Šå¹³å°ï¼Œä»Šå¤©æœ‰ä¸ªçˆ†æ¬¾çš„å•å­æ¨å¹¿ï¼Œå¯ä»¥ç»™åˆ°å¾ˆé«˜çš„ä»·æ ¼ï¼Œä½†æ˜¯ç”±äºè°ƒè§£å¹³å°çš„ç®—æ³•æœºåˆ¶ï¼Œå®ƒä¸å…·æœ‰ä¼˜å…ˆé€‰æ‹©å¹¿å‘Šä½çš„æƒåˆ©ï¼Œè€Œå¯¼è‡´å®ƒå¹¶ä¸èƒ½ä¹°åˆ°å¤šå°‘é‡ã€‚ è¿™æ—¶å€™ï¼Œèªæ˜çš„ç§»åŠ¨äº’è”ç½‘äººå°±æƒ³åˆ°äº†å€Ÿé‰´æ¡Œé¢ç«¯å¹¿å‘Šçš„åšæ³•ï¼Œæ²¡é”™ï¼Œå°±æ˜¯Header Biddingã€‚å¤´éƒ¨ç«ä»·æŠ€æœ¯æºäºç½‘é¡µç«¯ï¼Œå¼€å‘è€…é€šè¿‡åœ¨ç½‘é¡µå¤´éƒ¨åµŒå…¥ä»£ç ï¼Œä»è€Œä¼¼çš„å¹¿å‘Šè¯·æ±‚åœ¨å…¬å¼€ç«ä»·ä¹‹å‰å¯ä»¥å‘ç»™å¼€å‘è€…ä¼˜é€‰çš„åˆä½œä¼™ä¼´ï¼Œæ‹¿åˆ°ä¼˜é€‰åˆä½œä¼™ä¼´çš„è¿”å›åå°†å…¶ä»·æ ¼ä¸å…¬å¼€ç«ä»·ä»·æ ¼åšå¯¹æ¯”ï¼Œä»·é«˜è€…å¾—ã€‚è€Œè¿™ä¸ªæ¨¡å‹ä¹Ÿå¾—ä»¥è¿ç”¨åˆ°ç§»åŠ¨ç«¯äº†ã€‚ è°ƒè§£å¹³å°ä¸€æ”¹å¾€æ—¥çš„ç€‘å¸ƒæµçš„å½¢å¼ï¼Œå°†ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å‘å¹¿å‘Šè¯·æ±‚çš„æ–¹å¼ æ”¹ä¸º åŒæ—¶åƒæ‰€æœ‰çš„å¹¿å‘Šå¹³å°å‘è¯·æ±‚ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´å†…å°†æ”¶åˆ°çš„è¿”å›æœ€æ¯”è¾ƒï¼Œæœ€é«˜å‡ºä»·å³èµ¢å¾—å¹¿å‘Šçš„å±•ç¤ºæƒã€‚ DSPï¼ˆDemand-Side Platformï¼‰éœ€æ±‚æ–¹å¹³å°äº’è”ç½‘å¹¿å‘ŠDSPï¼ˆDemand-Side Platformï¼‰ï¼Œå°±æ˜¯éœ€æ±‚æ–¹å¹³å° DSPä¸ºéœ€æ±‚æ–¹ï¼ˆå³å¹¿å‘Šä¸»æˆ–ä»£ç†å•†ï¼‰æä¾›å®æ—¶ç«ä»·æŠ•æ”¾å¹³å°ã€‚å¹¿å‘Šéœ€æ±‚æ–¹å¯ä»¥åœ¨å¹³å°ä¸Šç®¡ç†å¹¿å‘Šæ´»åŠ¨åŠå…¶æŠ•æ”¾ç­–ç•¥ï¼ŒåŒ…æ‹¬è®¾ç½®ç›®æ ‡å—ä¼—çš„å®šå‘æ¡ä»¶ã€é¢„ç®—ã€å‡ºä»·ã€åˆ›æ„ç­‰ã€‚ SSPï¼ˆSupply-Side Platformï¼‰ä¾›åº”æ–¹å¹³å°SSPæœåŠ¡äºåª’ä½“æ–¹ï¼Œå¯ä»¥ä½œä¸ºåˆ†æ•£çš„æµé‡å…¥å£ã€å¤§å°åª’ä½“çš„èšåˆå¹³å°ã€‚ ADNï¼ˆAd Networkï¼‰å¹¿å‘Šç½‘ç›ŸADNå¯ä»¥è¢«ç†è§£ä¸ºåª’ä½“ä»£ç†å…¬å¸ï¼Œé€šè¿‡ä¸ºå¹¿å‘Šä¸»é‡‡è´­åª’ä½“æ–¹æµé‡ï¼Œèµšå–ä¸­é—´å·®ä»·ï¼Œå…¶ä»£è¡¨æœ‰ç™¾åº¦ç½‘ç›Ÿç­‰ã€‚ ADXï¼ˆAd Exchangeï¼‰å¹¿å‘Šäº¤æ˜“å¹³å°ADXæä¾›çš„åŠŸèƒ½æ˜¯äº¤æ¢ï¼Œå®ç°å®æ—¶ç«ä»·ã€å¹¿å‘Šåº“å­˜å’Œå¹¿å‘Šéœ€æ±‚çš„åŒ¹é…ã€‚å¹¿å‘Šéœ€æ±‚æ–¹å¯ä»¥éšæ—¶æ”¹å˜è‡ªå·±çš„å‡ºä»·ç­–ç•¥å’Œæ‰€é€‰æ‹©çš„èµ„æºã€‚ ç¨‹åºåŒ–å¹¿å‘Š-äº¤æ˜“æ¨¡å¼æœ¯è¯­RTB (real time bidding) å®æ—¶ç«ä»·Real Time Bidding(å®æ—¶ç«ä»·)ï¼Œä¹Ÿå«Open Auctionï¼ˆå…¬å¼€ç«ä»·ï¼‰ï¼Œç®€ç§°RTB æµé‡éœ€æ±‚æ–¹åœ¨å¹¿å‘Šäº¤æ˜“å¹³å°ä¸­ï¼Œè®¾å®šå¹¿å‘Šæµé‡åº•ä»·çš„æƒ…å†µä¸‹ï¼Œå½“æœ‰æµé‡è¿‡æ¥æ—¶ï¼Œä¸å…¶ä»–ç¨‹åºåŒ–å¹¿å‘Šä¹°å®¶ä¸€èµ·å¯¹æµé‡å‡ºä»·ï¼Œå¹¿å‘Šäº¤æ˜“å¹³å°æ”¶åˆ°å„ä¸ªç¨‹åºåŒ–ä¹°å®¶çš„å‡ºä»·åï¼Œè¿›è¡Œæ¯”ä»·ï¼Œä»·é«˜è€…è·å¾—æµé‡å¹¶åŒæ­¥ç«ä»·æˆåŠŸçš„ç»“æœã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯é€šè¿‡ç¨‹åºåŒ–çš„æ–¹å¼åœ¨ 100 æ¯«ç§’å†…å®Œæˆçš„ã€‚ å“ç‰Œèƒ½å¤Ÿå¯¹å•ä¸ªå±•ç¤ºå¹¿å‘Šä½ç½®è¿›è¡Œç«ä»·è´­ä¹°ï¼Œè€Œä¸æ˜¯ä»¥é¢„å…ˆå›ºå®šçš„ä»·æ ¼è¿›è¡Œè´­ä¹°ï¼Œä»è€Œä½¿è´­ä¹°å†³ç­–æ›´åŠ åˆ’ç®—ï¼Œé¿å…å¹¿å‘Šä¸»é¢„ç®—æµªè´¹ PDBï¼ˆPrivate Direct Buyï¼‰ç¨‹åºåŒ–ç›´æ¥è´­ä¹° è¿™ä¸ªæ¦‚å¿µåº”è¯¥å’Œç›´æŠ•æ˜¯åŒä¸€ä¸ªæ¦‚å¿µ æ˜¯ç›®å‰å›½å†…å¸‚åœºæœ€ä¸ºå¸¸è§å’Œä¸»æµåº”ç”¨çš„ä¸€ç§ç§æœ‰äº¤æ˜“æ¨¡å¼ã€‚ æŒ‡æµé‡éœ€æ±‚æ–¹ç”¨ç¡®å®šçš„ä»·æ ¼ä¹°æ–­å›ºå®šã€ä¼˜è´¨çš„åª’ä½“èµ„æºï¼Œç„¶åè¿›è¡Œç¨‹åºåŒ–å¹¿å‘Šçš„ç²¾å‡†å®šå‘æŠ•æ”¾ã€‚å¸¸è¯´çš„â€œä¿ä»·ä¿é‡â€ã€‚ PDï¼ˆPreferred Dealsï¼‰ä¼˜å…ˆäº¤æ˜“ä¸ PDB åŒºåˆ«åœ¨äºï¼Œè¿™ç§ç§æœ‰äº¤æ˜“æ–¹å¼åœ¨å¹¿å‘Šèµ„æºä¸Šå…·æœ‰ä¸€å®šçš„ä¸ç¡®å®šæ€§ã€‚å³æµé‡éœ€æ±‚æ–¹å¯ä»¥è´­ä¹°æŸä¸€ä¼˜è´¨å¹¿å‘Šä½ï¼Œä½†å…¶èƒ½è·å¾—å¤šå°‘æ›å…‰å±•ç¤ºé‡å´ä¸èƒ½é¢„å…ˆä¿è¯ã€‚å¸¸è¯´çš„â€œä¿ä»·ä¸ä¿é‡â€ã€‚ PAï¼ˆPrivate Auctionï¼‰ç§æœ‰ç«ä»·ä¾›åº”æ–¹å¹³å°å°†è¾ƒä¼˜è´¨çš„å›ºå®šå¹¿å‘Šä½èµ„æºä¸“é—¨æ‹¿å‡ºæ¥ï¼Œæ”¾åœ¨ä¸€ä¸ªåŠå…¬å¼€å¸‚åœºä¸­ï¼Œä»…ç”±è¿›å…¥ç™½åå•çš„ä¹°æ–¹ï¼ˆVIPï¼‰è¿›è¡Œç«ä»·ï¼Œä»·é«˜è€…å¾—ã€‚å› æ­¤ï¼Œå¹¿å‘Šä½å¯ä»¥é”å®šï¼Œä½†é‡‡ä¹°ä»·æ ¼å’Œæ˜¯å¦æœ€ç»ˆè·å¾—æ›å…‰éƒ½ä¸èƒ½é¢„å…ˆä¿è¯ã€‚å¸¸è¯´çš„â€œä¸ä¿ä»·ä¸ä¿é‡â€ã€‚ ç¨‹åºåŒ–å¹¿å‘Š-æ•ˆæœæœ¯è¯­å¹¿å‘Šä¼ æ’­å½±å“å—ä¼—çš„è®¤çŸ¥ã€å¿ƒç†ã€è¡Œä¸ºå’Œæ€åº¦ï¼Œç”±æ­¤å¸¦æ¥çš„ç›´æ¥å’Œé—´æ¥å¹¿å‘Šæ•ˆç›Šï¼Œå¯¹å¹¿å‘Šæ•ˆæœçš„è¯„ä¼°çš„ä¹Ÿæœ‰ç€å¤šæ–¹é¢è¦ç´ å’Œç»´åº¦ã€‚ ROIReturn On Investmentï¼ˆæŠ•èµ„å›æŠ¥ç‡ï¼‰ï¼Œç®€ç§°ROIã€‚å³è¥é”€è€…é€šè¿‡å¹¿å‘ŠæŠ•æ”¾å¾—åˆ°çš„ç»æµå›æŠ¥å å¹¿å‘ŠæŠ•å…¥ï¼ˆèŠ±è´¹ï¼‰çš„æ¯”ä¾‹ã€‚ ImpressionImpressionï¼Œå³æ›å…‰é‡ï¼Œä¹Ÿè¢«ç§°ä¸ºâ€œå±•ç¤ºé‡â€ã€â€œå±•ç°é‡â€ã€‚å³æŠ•æ”¾æœŸå¹¿å‘Šè¢«å±•ç¤ºçš„æ€»æ¬¡æ•°ã€‚ä¸€èˆ¬ç”¨æˆ·æ¯æµè§ˆä¸€æ¬¡é¡µé¢ï¼ŒåŒæ—¶é¡µé¢ä¸­å¹¿å‘Šä½çš„å¹¿å‘Šè¢«å±•ç¤ºä¸€æ¬¡ï¼Œå°±æ˜¯ä¸€ä¸ªæ›å…‰ã€‚ ClickClickï¼Œå³ç‚¹å‡»é‡ï¼Œä¸ºæŠ•æ”¾æœŸç”¨æˆ·ç‚¹å‡»æŸä¸ªå¹¿å‘Šçš„æ€»æ¬¡æ•°ã€‚ CTR(Click-Through-Rate) ç‚¹å‡»ç‡å¹¿å‘Šè¢«ç‚¹å‡»çš„æ¬¡æ•°ä¸å¹¿å‘Šæ›å…‰æ¬¡æ•°çš„æ¯”ä¾‹ è®¡ç®—å…¬å¼ï¼šClick/Impression*100% åæ˜ äº†å¹¿å‘Šçš„å—å…³æ³¨ç¨‹åº¦ï¼Œæˆ–ç”¨æ¥è¡¡é‡å¹¿å‘Šçš„å¸å¼•ç¨‹åº¦ã€‚ RRï¼ˆReach Rateï¼‰åˆ°è¾¾ç‡åˆ°è¾¾é‡ä¸ç‚¹å‡»é‡çš„æ¯”ä¾‹ï¼ˆåˆ°è¾¾é‡/ç‚¹å‡»é‡*100%ï¼‰ åˆ°è¾¾é‡ï¼šå³æœ‰å¤šå°‘ç”¨æˆ·ç‚¹å‡»å¹¿å‘Šåè¿›å…¥è½åœ°é¡µã€‚ CRï¼ˆConversion Rateï¼‰è½¬åŒ–ç‡è½¬åŒ–é‡ä¸ç‚¹å‡»é‡çš„æ¯”ä¾‹ï¼ˆè½¬åŒ–é‡/ç‚¹å‡»é‡*100%ï¼‰ è½¬åŒ–é‡ï¼šå³æœ‰å¤šå°‘ç”¨æˆ·ç‚¹å‡»å¹¿å‘Šå¹¶è¿›å…¥è½åœ°é¡µï¼ˆæ´»åŠ¨é¡µï¼‰åï¼Œç»§ç»­å‘ç”Ÿå’¨è¯¢ã€æ³¨å†Œã€ä¸‹è½½ã€åŠ å…¥è´­ç‰©è½¦ã€ä¸‹å•ç­‰è¡Œä¸ºã€‚ ç•™å­˜ç‡ç‰¹å®šå‘¨æœŸå†…ï¼ˆå¦‚æ¬¡æ—¥ç•™å­˜ã€ä¸ƒæ—¥ç•™å­˜ç­‰ï¼‰ï¼Œç•™å­˜ç”¨æˆ·æ•°é‡ï¼ˆæœ‰å¤šå°‘ç”¨æˆ·ç•™ä¸‹æ¥ï¼‰å å¹¿å‘Šï¼ˆå½“æ—¶ï¼‰å¯¼å…¥çš„æ–°å¢ç”¨æˆ·æ•°é‡çš„æ¯”ä¾‹ã€‚ç•™å­˜ç‡=ç•™å­˜ç”¨æˆ·æ•°/æ–°å¢ç”¨æˆ·æ•°é‡*100% LTï¼ˆLife Timeï¼‰ç”Ÿå‘½å‘¨æœŸä¸€ä¸ªç”¨æˆ·ä»ç¬¬1æ¬¡åˆ°æœ€å1æ¬¡å‚ä¸æ¸¸æˆä¹‹é—´çš„æ—¶é—´æ®µï¼Œä¸€èˆ¬æŒ‰æœˆè®¡ç®—å¹³å‡å€¼ LTV(Life Time Value) ç”¨æˆ·ç»ˆç”Ÿä»·å€¼ç”¨æˆ·åœ¨ç”Ÿå‘½å‘¨æœŸå†…ä¸ºè¯¥æ¸¸æˆåˆ›é€ çš„æ”¶å…¥æ€»è®¡ï¼Œå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªARPU å€¼çš„é•¿æœŸç´¯è®¡ã€‚ è®¡ç®—å…¬å¼ï¼šLTV = ARPUxLTã€‚ DAU(Daily Active Users) æ—¥æ´»è·ƒç”¨æˆ·æ•°é‡DAU æŒ‡çš„æ˜¯æŸäº§å“ï¼ˆç½‘ç«™ã€è½¯ä»¶æˆ–æ¸¸æˆç­‰ï¼‰åœ¨ä¸€æ—¥ä¹‹å†…ç™»å½•æˆ–ä½¿ç”¨è¿‡çš„ç”¨æˆ·æ€»æ•°ï¼ˆä¸åŒ…æ‹¬é‡å¤çš„ç”¨æˆ·ï¼‰ã€‚ DAU æ˜¯ä¸€ä¸ªæ¯”è¾ƒåŸºæœ¬çš„æŒ‡æ ‡ï¼Œèƒ½å¤Ÿç›¸å¯¹ç‰‡é¢åœ°å±•ç°äº§å“çŸ­æ—¶é—´å†…çš„çƒ­åº¦ã€‚ ä¸€èˆ¬æ¥è¯´åªçœ‹äº§å“çš„ DAU å…¶å®æ„ä¹‰ä¸å¤§ï¼Œå•çº¯é€šè¿‡ DAU æ— æ³•åˆ¤æ–­äº§å“çš„çœŸå®è´¨é‡ï¼Œä¸” DAU å¾ˆå®¹æ˜“ä¼ªé€ ã€‚ MAU(Monthly Active Users) æœˆæ´»è·ƒç”¨æˆ·æ•°é‡MAU æŒ‡çš„æ˜¯æŸäº§å“ï¼ˆç½‘ç«™ã€è½¯ä»¶æˆ–æ¸¸æˆç­‰ï¼‰åœ¨ä¸€ä¸ªæœˆï¼ˆç»Ÿè®¡æœˆï¼‰ä¹‹å†…ç™»å½•æˆ–ä½¿ç”¨è¿‡çš„ç”¨æˆ·æ€»æ•°ï¼ˆä¸åŒ…æ‹¬é‡å¤çš„ç”¨æˆ·ï¼‰ã€‚ MAU åŒæ ·ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒåŸºæœ¬çš„æŒ‡æ ‡ï¼Œèƒ½å¤Ÿç›¸å¯¹ç‰‡é¢çš„å±•ç°äº§å“ä¸€æ®µæ—¶é—´å†…çš„çƒ­åº¦ã€‚ é€šè¿‡ DAU å’Œ MAU è™½ç„¶èƒ½å¤Ÿçœ‹å‡ºäº§å“åœ¨ä¸€æ®µæ—¶é—´å†…çš„çƒ­åº¦ï¼Œä½†æ˜¯æ— æ³•ç²¾ç¡®åœ°åˆ¤æ–­äº§å“çš„ç•™å­˜ç‡ï¼Œå› ä¸ºä½ æ— æ³•å¾—çŸ¥ç”¨æˆ·çš„å±æ€§ï¼ˆæ˜¯å¦ä¸ºè€ç”¨æˆ·ï¼‰ã€‚æ­¤æ—¶ DNU å’Œ DOU æ˜¯æ—¶å€™å‡ºæ¥æ•‘åœºäº†ã€‚ DNU &amp; DOUã€ŒDaily New Usersï¼ˆæ—¥æ–°å¢ç”¨æˆ·æ•°é‡ ï¼‰&amp; Daily Old Usersï¼ˆæ—¥éæ–°å¢ç”¨æˆ·æ•°é‡ï¼‰ã€ è¿™ä¸¤ä¸ªè¯çš„æ„ä¹‰éå¸¸æ˜ç¡®ï¼Œå°±æ˜¯ç›´æ¥å±•ç°äº†äº§å“çŸ­æ—¶é—´å†…çš„æ–°è€ç”¨æˆ·æƒ…å†µã€‚ é€šè¿‡ DNU å’Œ DOU åŠ ä¸Š DAU å’Œ MAU è¿™å‡ ä¸ªæŒ‡æ ‡èƒ½å¤Ÿæ¯”è¾ƒç›´æ¥åœ°åˆ¤æ–­äº§å“çš„ç•™å­˜ç‡ï¼ˆå³ç”¨æˆ·ç²˜æ€§ï¼‰ã€‚ ARPU(Average Revenue Per User) æ¯ç”¨æˆ·å¹³å‡æ”¶ç›Šç›®å‰ ARPU è¿™ä¸ªæ¦‚å¿µåœ¨è®¸å¤šè¡Œä¸šéƒ½æœ‰ç€å¹¿æ³›çš„åº”ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨äº’è”ç½‘æ¸¸æˆäº§ä¸šé‡Œé¢ï¼Œéšç€å…è´¹æ¸¸æˆçš„å…´èµ·ï¼ŒARPU æ—¥æ¸æˆä¸ºæ¸¸æˆè¿è¥å•†ç€é‡å…³æ³¨çš„å…ƒç´ ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä¸åŒçš„è¡Œä¸šä¹ƒè‡³ä¸åŒçš„ä¼ä¸šéƒ½æœ‰è‡ªå·±ä¸“å±çš„ ARPU è®¡ç®—æ–¹å¼ã€‚ å¸¸ç”¨è®¡ç®—å…¬å¼ï¼šæ¯ç”¨æˆ·å¹³å‡æ”¶ç›Š = æ€»æ”¶ç›Š Ã· æ€»ç”¨æˆ·æ•° å¹¿å‘Šç›¸å…³eCPMï¼ˆEffective Cost Per Milleï¼‰ æ¯åƒæ¬¡å±•ç¤ºæ”¶ç›ŠeCPM æ˜¯ä¸€ä¸ªä¸»è¦é¢å‘äº§å“æ–¹çš„æŒ‡æ ‡ã€‚ æŒ‡çš„æ˜¯åœ¨äº§å“ï¼ˆç½‘é¡µã€åº”ç”¨ç­‰ç­‰ï¼‰ä¸­å±•ç¤ºæŸå¹¿å‘Š 1000 æ¬¡æ‰€å¸¦æ¥çš„æ”¶ç›Šã€‚ è®¡ç®—å…¬å¼ï¼šæ¯åƒæ¬¡å±•ç¤ºæ”¶ç›Š = æ€»æ”¶ç›Š Ã· å¹¿å‘Šå±•ç¤ºæ€»æ¬¡æ•° Ã— 1000 åªè¦æ˜¯æœ‰æ•ˆå±•ç¤ºå°±è¡Œï¼Œå¯ä»¥è¯´æ˜¯å¾ˆç®€å•ç²—æš´çš„å˜ç°æ–¹å¼äº†â€¦ CPMã€ŒCost Per Mille / Cost Per Thousand Impressionsï¼ˆæ¯åƒæ¬¡å°è±¡æˆæœ¬ï¼‰ã€ CPM æ˜¯ä¸€ç§ä¸»è¦é¢å‘å¹¿å‘Šä¸»çš„å¹¿å‘Šè®¡è´¹æ¨¡å¼ã€‚ æŒ‡çš„æ˜¯å¹¿å‘ŠæŠ•æ”¾è¿‡ç¨‹ä¸­ï¼Œå¹³å‡æ¯å‘ 1000 äººå±•ç¤ºæŸå¹¿å‘Š 1 æ¬¡éœ€è¦çš„æˆæœ¬ã€‚ä¸€èˆ¬åŒä¸€ IP åœ¨ 24 å°æ—¶å†…æœ€å¤šåªæœ‰ä¸€æ¬¡æœ‰æ•ˆå±•ç¤ºã€‚ è®¡ç®—å…¬å¼ï¼šæ¯åƒæ¬¡å°è±¡æˆæœ¬ = æ€»æˆæœ¬ Ã· å¹¿å‘Šè¾¾åˆ°äººæ•° Ã— 1000 ä½ å¯ä»¥ä¸çœ‹ï¼Œä½†æ˜¯æˆ‘è¿™ä¸ªå¹¿å‘Šä¸€å®šè¦æ’­ï¼ CPCï¼ˆCost Per Clickï¼‰ æ¯ç‚¹å‡»æˆæœ¬CPC æ˜¯ä¸€ç§ä¸»è¦é¢å‘å¹¿å‘Šä¸»çš„å¹¿å‘Šè®¡è´¹æ¨¡å¼ã€‚ æŒ‡çš„æ˜¯åœ¨å¹¿å‘ŠæŠ•æ”¾ä¸­ï¼Œå¹¿å‘Šä¸»ä»…ä¸ºç”¨æˆ·çš„æœ‰æ•ˆç‚¹å‡»è¡Œä¸ºä»˜è´¹ï¼Œè€Œä¸å†ä¸ºå¹¿å‘Šçš„å±•ç¤ºæ¬¡æ•°ä»˜è´¹ã€‚ è®¡ç®—å…¬å¼ï¼šæ¯ç‚¹å‡»æˆæœ¬ = æ€»æˆæœ¬ Ã· ç‚¹å‡»æ•° ä¸ç‚¹ä¸ç»™é’±ï¼ CPAï¼ˆCost Per Actionï¼‰ æ¯è¡ŒåŠ¨æˆæœ¬CPA æ˜¯ä¸€ç§ä¸»è¦é¢å‘å¹¿å‘Šä¸»çš„å¹¿å‘Šè®¡è´¹æ¨¡å¼ã€‚ CPA é¡¾åæ€ä¹‰æ˜¯æŒ‰ç…§ç”¨æˆ·çš„è¡Œä¸ºï¼ˆActionï¼‰ä½œä¸ºæŒ‡æ ‡æ¥è®¡è´¹ï¼Œè¿™ä¸ªè¡Œä¸ºå¯ä»¥æ˜¯æ³¨å†Œã€å’¨è¯¢æˆ–åŠ å…¥è´­ç‰©è½¦ç­‰ç­‰ã€‚ æ„æ€å°±æ˜¯ç”¨æˆ·ç‚¹å‡»äº†å¹¿å‘Šè¿˜ä¸ç®—ï¼Œéœ€è¦ç”¨æˆ·æœ‰æ³¨å†ŒæˆåŠŸä¹‹ç±»çš„è¡Œä¸ºæ‰è¡Œï¼Œä¸è¿‡è¿™ç§æ¨¡å¼ä¸‹å¹¿å‘Šè´¹ä¹Ÿç›¸å¯¹è¾ƒé«˜ã€‚ è¿™æ˜¯ä¸€ä¸ªä¸å—äº§å“æ–¹å¾…è§çš„æ¨¡å¼ï¼Œæ¡ä»¶å¤ªè‹›åˆ»äº†â€¦ CPS(Cost Per Sale) æ¯é”€å”®æˆæœ¬CPS æ˜¯ä¸€ç§é¢å‘å¹¿å‘Šä¸»çš„å¹¿å‘Šè®¡è´¹æ¨¡å¼ã€‚ åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œå¹¿å‘Šä¸»çš„å•†å“æˆåŠŸé”€å”®å‡ºå»ä¹‹åï¼Œäº§å“æ–¹æ‰å¯ä»¥è·å–åˆ°ä¸€å®šæ¯”ä¾‹çš„ä½£é‡‘ï¼ˆææˆï¼‰ã€‚ è¿™ä¹ˆè¯´æ¥ä¼¼ä¹æœ‰ç‚¹é”€å”®çš„æ„æ€ï¼ˆåƒææˆï¼‰ CPPï¼ˆCost Per Purchaseï¼‰æ¯è´­ä¹°æˆæœ¬CPP æ˜¯ä¸€ç§é¢å‘å¹¿å‘Šä¸»çš„å¹¿å‘Šè®¡è´¹æ¨¡å¼ã€‚ åœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œç”¨æˆ·ç‚¹å‡»å¹¿å‘Šå¹¶æˆåŠŸè¿›è¡Œäº¤æ˜“åï¼Œå¹¿å‘Šä¸»æŒ‰ç…§é”€å”®ç¬”æ•°ä»˜ç»™äº§å“æ–¹å¹¿å‘Šè´¹ç”¨ã€‚ è¦æ³¨æ„äº†ï¼ŒCPP æ˜¯æŒ‰ç…§é”€å”®ç¬”æ•°æ¥ç®—é’±çš„ CPRï¼ˆCost Per Responseï¼‰æ¯å›åº”æˆæœ¬CPR æ˜¯ä¸€ç§é¢å‘å¹¿å‘Šä¸»çš„å¹¿å‘Šè®¡è´¹æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼çš„ç‰¹ç‚¹ä¸ºï¼šåŠæ—¶ååº”ã€ç›´æ¥äº’åŠ¨ã€å‡†ç¡®è®°å½•ã€‚ åœ¨ CPR æ¨¡å¼ä¸‹ï¼Œå¹¿å‘Šå±•ç¤ºåï¼Œè¿˜éœ€è¦ç”¨æˆ·ç»™äºˆå¹¿å‘Šä¸»å›åº”æ‰ç®—æœ‰æ•ˆã€‚æ‰€è°“å›åº”ï¼Œä¸€èˆ¬æ˜¯æ‹¨æ‰“ç”µè¯ä¹‹ç±»çš„å½¢å¼ã€‚ä¾‹å¦‚ç”µè§†è´­ç‰©å¹¿å‘Šï¼Œä¸€èˆ¬åœ¨å›ºå®šæ—¶æ®µæ’­å‡ºï¼Œå½“ç”¨æˆ·æ‹¨æ‰“äº†å¹¿å‘Šä¸­çš„ç”µè¯ä¹‹åæ‰ç®—ä½œæœ‰æ•ˆä¼ æ’­ã€‚ è¿™ç§æ¨¡å¼è¦æ±‚ç›¸å¯¹è¾ƒé«˜ï¼Œä¹ŸæŒºä¸å—å¾…è§çš„ï¼Œè¿™å¹¿å‘Šè´¹å¤ªéš¾èµšäº†â€¦ åˆæƒ³èµ·äº†è¢«ç”µè§†è´­ç‰©å¹¿å‘Šæ”¯é…çš„æ—¥å­.. PPCï¼ˆPay Per Clickï¼‰ç‚¹å‡»ä»˜è´¹å¹¿å‘ŠPPC æ˜¯å¤§å…¬å¸æœ€å¸¸ç”¨çš„ç½‘ç»œå¹¿å‘Šå½¢å¼ï¼Œè¿™ç§æ–¹æ³•è´¹ç”¨å¾ˆé«˜ï¼Œä½†æ•ˆæœä¹Ÿå¾ˆå¥½ï¼Œæ¯”å¦‚ç™¾åº¦ç«ä»·ã€æœç‹å’Œæ–°æµªé¦–é¡µä¸Šçš„ Banner å¹¿å‘Šã€‚ è®¡ä»·å…¬å¼ï¼šèµ·ä»· + (ç‚¹å‡»æ•° Ã— æ¯æ¬¡ç‚¹å‡»çš„ä»·æ ¼) è¶Šæ˜¯è‘—åçš„æœç´¢å¼•æ“ï¼Œèµ·ä»·è¶Šé«˜ï¼Œæœ€é«˜å¯è¾¾æ•°ä¸‡ç”šè‡³æ•°åä¸‡ï¼Œè€Œæ¯æ¬¡ç‚¹å‡»çš„ä»·æ ¼åœ¨ 0.30 å…ƒå·¦å³ã€‚ æä¾›ç‚¹å‡»ä»˜è´¹çš„ç½‘ç«™éå¸¸å¤šï¼Œä¸»è¦æœ‰å„å¤§é—¨æˆ·ç½‘ç«™(å¦‚æœç‹ã€æ–°æµª)å’Œæœç´¢å¼•æ“ï¼ˆGoogle å’Œç™¾åº¦ï¼‰ï¼Œä»¥åŠå…¶ä»–æµè§ˆé‡è¾ƒå¤§çš„ç½‘ç«™ï¼Œæ¯”å¦‚æä¾›è½¯ä»¶ä¸‹è½½çš„åå†›ç­‰ç­‰ã€‚ å°±æ˜¯é‚£ç§åœ¨æœç´¢å¼•æ“æœç´ å…³é”®è¯ï¼Œç„¶ååœ¨å±•ç¤ºåœ¨æœç´¢ç»“æœå‰é¢çš„é‚£ç§å¹¿å‘Šâ€¦ PPSï¼ˆPay Per Saleï¼‰ æŒ‰é”€å”®ä»˜è´¹PPS å¹¿å‘Šæ˜¯æ ¹æ®ç½‘ç»œå¹¿å‘Šæ‰€äº§ç”Ÿçš„ç›´æ¥é”€å”®æ•°é‡è€Œä»˜è´¹çš„ä¸€ç§å®šä»·æ¨¡å¼ã€‚ PPS å’Œ CPS åŸºæœ¬ä¸€ä¸ªæ„æ€ï¼Œç±»ä¼¼äºæ·˜å®å®¢è¿™ç±»çš„æœåŠ¡ã€‚å¹¿ä¹‰ä¸Šä¸ä»…ä»…æ˜¯æŒ‡äº’è”ç½‘å¹¿å‘ŠèŒƒç•´ï¼Œåº”åŒ…æ‹¬æ‰€æœ‰å½¢å¼çš„åŸºäºæˆåŠŸé”€å”®è€Œæ”¶å–ä¸€å®šæ¯”ä¾‹ä½£é‡‘çš„å•†ä¸šåˆä½œæ–¹å¼ã€‚ ç½‘ç«™ç›¸å…³UVï¼ˆUnique Visitorsï¼‰ç‹¬ç«‹è®¿å®¢æ•°UV è¡¨ç¤ºæŸç½‘ç«™ 1 å¤©å†…ï¼ˆ00:00 - 24:00ï¼‰çš„ç‹¬ç«‹è®¿å®¢æ€»æ•°ã€‚ æ‰€è°“çš„â€œç‹¬ç«‹â€è®¿å®¢ï¼Œæ˜¯ä»¥æµè§ˆå™¨çš„ Cookie ä¸ºä¾æ®çš„ï¼Œåªè¦ Cookie ç›¸åŒï¼Œé‚£ä¹ˆå°±ç®—æ›´æ¢äº† IP ä¹Ÿéƒ½å°†è¢«è§†ä¸ºåŒä¸€ä¸ªè®¿å®¢ï¼Œä¸”å½“å¤©æ— è®ºè®¿é—®å¤šå°‘æ¬¡ UV éƒ½åªä¼šåŠ  1 ä¸ªã€‚ é€šå¸¸æ˜¯ä¸€éƒ¨æ‰‹æœºï¼ˆç”µè„‘ï¼‰ä¸€ä¸ªå‘~ PVï¼ˆPage Viewsï¼‰é¡µé¢æµè§ˆé‡PV è¡¨ç¤ºæŸé¡µé¢åœ¨ä¸€å®šç»Ÿè®¡å‘¨æœŸå†…çš„æ€»æµè§ˆé‡ã€‚ åœ¨ä¸€å®šå‘¨æœŸå†…ï¼Œç”¨æˆ·æ¯æ¬¡æ‰“å¼€æˆ–åˆ·æ–°è¯¥é¡µé¢éƒ½å°†è¢«è§†ä¸º 1 æ¬¡æµè§ˆã€‚ åˆ·æ–°ä¸€ä¸‹å¤šä¸€ä¸ªçœŸå¥½ç©~ IPï¼ˆInternet Protocolï¼‰ç‹¬ç«‹ IP æ•°IP è¡¨ç¤º 1 å¤©å†…ï¼ˆ00:00 - 24:00ï¼‰è®¿é—®æŸç½‘ç«™çš„ IP æ€»æ•°ã€‚ è¯¥æŒ‡æ ‡ä»¥å¹¿åŸŸç½‘ IP ä¸ºä¾æ®ï¼ŒåŒä¸€ IP çš„è®¾å¤‡æ— è®ºè®¿é—®å¤šå°‘æ¬¡éƒ½åªç®—ä¸€ä¸ªè®¡æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿æ¥åŒä¸€è·¯ç”±å™¨çš„ä¸åŒè®¾å¤‡åœ¨åŒä¸€å¤©å†…å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹éƒ½åªä¼šå¢åŠ ä¸€ä¸ª IP è®¡æ•°ã€‚ ä¸€æ¡ç½‘çº¿ä¸€ä¸ªå‘~ RVï¼ˆRepeat Visitorsï¼‰é‡å¤è®¿å®¢æ•°RV æŒ‡çš„æ˜¯åœ¨ä¸€å®šç»Ÿè®¡å‘¨æœŸå†…ï¼Œè®¿é—®æŸç½‘ç«™ä¸¤æ¬¡æˆ–ä¸¤æ¬¡ä»¥ä¸Šçš„è®¿å®¢æ€»æ•°ã€‚ ä¿—ç§°ï¼šå›å¤´å®¢ TPï¼ˆTime On Pageï¼‰é¡µé¢åœç•™æ—¶é—´TP æŒ‡çš„æ˜¯ï¼ˆæ€»çš„ï¼‰ç”¨æˆ·åœ¨æŸä¸ªé¡µé¢çš„å¹³å‡åœç•™æ—¶é•¿ã€‚ TP æ—¶é•¿å¯ä»¥åæ˜ å‡ºæŸä¸ªé¡µé¢å¯¹ç”¨æˆ·çš„å¸å¼•åŠ›ï¼Œå¸®åŠ©åˆ¤æ–­ç”¨æˆ·çš„å–œå¥½ã€‚ èƒ½çœ‹å®Œè¿™ç¯‡æ–‡ç« çš„è¯ TP åº”è¯¥èƒ½æœ‰ 5 åˆ†é’Ÿå§ TSï¼ˆTime On Siteï¼‰ ç½‘ç«™åœç•™æ—¶é—´TS æŒ‡çš„æ˜¯ï¼ˆæ€»çš„ï¼‰ç”¨æˆ·åœ¨æŸç½‘ç«™ï¼ˆåŒ…æ‹¬äº†è¯¥ç½‘ç«™ä¸‹çš„æ‰€æœ‰é¡µé¢ï¼‰çš„å¹³å‡åœç•™æ—¶é•¿ã€‚ åæ­£è§†é¢‘ç½‘ç«™çš„ TS è‚¯å®šéƒ½æŒºé•¿çš„ SDï¼ˆSession Duration ï¼‰å¹³å‡ä¼šè¯æ—¶é•¿SD æ˜¯åœ¨ Google Analytics ä¸­ä½¿ç”¨çš„ä¸€ä¸ªæŒ‡æ ‡ï¼Œç”¨æ¥ç»Ÿè®¡ç½‘ç«™çš„å¹³å‡åœç•™æ—¶é•¿ã€‚ SD çš„ä½œç”¨ç±»ä¼¼äº Time On Siteï¼Œä½†æ˜¯è¿™ä¸¤è€…çš„è®¡ç®—æ–¹å¼ä¸ä¸€æ ·ã€‚","categories":[{"name":"å¹¿å‘Šè¡Œä¸š","slug":"å¹¿å‘Šè¡Œä¸š","permalink":"http://blog.crazylaw.cn/categories/%E5%B9%BF%E5%91%8A%E8%A1%8C%E4%B8%9A/"}],"tags":[{"name":"å¹¿å‘Šè¡Œä¸š","slug":"å¹¿å‘Šè¡Œä¸š","permalink":"http://blog.crazylaw.cn/tags/%E5%B9%BF%E5%91%8A%E8%A1%8C%E4%B8%9A/"}]},{"title":"ã€Macã€‘Macå®‰è£…è½¯ä»¶æµç¨‹","slug":"Mac/Macå®‰è£…è½¯ä»¶æµç¨‹","date":"2022-03-29T08:35:30.000Z","updated":"2022-04-11T10:31:25.337Z","comments":true,"path":"2022/03/29/Mac/Macå®‰è£…è½¯ä»¶æµç¨‹/","link":"","permalink":"http://blog.crazylaw.cn/2022/03/29/Mac/Mac%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E6%B5%81%E7%A8%8B/","excerpt":"å‰è¨€æœ€è¿‘ï¼Œå‡†å¤‡é‡æ–°æ‰“é€ æˆ‘çš„macç”µè„‘ã€‚","text":"å‰è¨€æœ€è¿‘ï¼Œå‡†å¤‡é‡æ–°æ‰“é€ æˆ‘çš„macç”µè„‘ã€‚ iterm2 å®‰è£…zsh å®‰è£… powerlevel10k (å®‰è£…æ–¹å¼å‚è€ƒå®˜ç½‘æ–‡æ¡£) æ›¿æ¢ .vimrc ä¸­çš„ zshä¸»é¢˜, ZSH_THEME=&quot;powerlevel10k/powerlevel10k&quot; vimç›¸å…³æˆ‘çš„ä¸ªäººvimé…ç½® ccinn-vim vimçš„æ’ä»¶ç®¡ç†é€‰æ‹©æœ‰ Vundle, vim-plug vimçš„ç›®å½•æ’ä»¶ scrooloose/nerdtree vimçš„ç›®å½•å¢å¼ºæ’ä»¶,å­—ä½“å’Œiconçš„ä¸‹è½½å’Œå®‰è£…å¯ä»¥åœ¨nerdç›®å½•ä¸‹æ˜¾ç¤ºå›¾æ ‡ï¼Œå…¶ä»–å­—ä½“ç­‰ ryanoasis/nerd-fonts ryanoasis/vim-devicons ä¸»ä½“iterm2 çš„å­—ä½“éœ€è¦å’Œnerd-fontsä¸€è‡´ vim çª—å£çŠ¶æ€æ  vim-airline/vim-airline vim-airline/vim-airline-themes Clean my macä»˜è´¹è½¯ä»¶ï¼Œæ¸…ç†ç”µè„‘ ntfs for macå¤–ç½®ç§»åŠ¨ç¡¬ç›˜ä¸“ç”¨","categories":[{"name":"Mac","slug":"Mac","permalink":"http://blog.crazylaw.cn/categories/Mac/"}],"tags":[{"name":"Mac","slug":"Mac","permalink":"http://blog.crazylaw.cn/tags/Mac/"}]},{"title":"ã€DevOpsã€‘gitå‘½ä»¤åœºæ™¯ç”¨æ³•","slug":"DevOps/gitå‘½ä»¤åœºæ™¯ç”¨æ³•","date":"2022-03-19T06:35:30.000Z","updated":"2022-04-15T07:40:12.764Z","comments":true,"path":"2022/03/19/DevOps/gitå‘½ä»¤åœºæ™¯ç”¨æ³•/","link":"","permalink":"http://blog.crazylaw.cn/2022/03/19/DevOps/git%E5%91%BD%E4%BB%A4%E5%9C%BA%E6%99%AF%E7%94%A8%E6%B3%95/","excerpt":"å‰è¨€ç°åœ¨ï¼Œgitå·²ç»æˆä¸ºäº†å¤§å®¶çš„ä»£ç ä»“åº“ç®¡ç†çš„ä¸€ä¸ªå·¥å…·äº†ã€‚åœ¨æ—¥å¸¸å·¥ä½œï¼Œæˆ‘ä»¬ä¼šé‡åˆ°å„ç§ä¸ªæ ·çš„gité—®é¢˜ï¼Œå› æ­¤ï¼Œç”¨ä¸€ç¯‡æ–‡ç« æ¥ç´¯è®¡è®°å½•ï¼Œæ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ï¼Œä½†æ˜¯ä¸å¸¸ç”¨çš„å‘½ä»¤ã€‚","text":"å‰è¨€ç°åœ¨ï¼Œgitå·²ç»æˆä¸ºäº†å¤§å®¶çš„ä»£ç ä»“åº“ç®¡ç†çš„ä¸€ä¸ªå·¥å…·äº†ã€‚åœ¨æ—¥å¸¸å·¥ä½œï¼Œæˆ‘ä»¬ä¼šé‡åˆ°å„ç§ä¸ªæ ·çš„gité—®é¢˜ï¼Œå› æ­¤ï¼Œç”¨ä¸€ç¯‡æ–‡ç« æ¥ç´¯è®¡è®°å½•ï¼Œæ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°ï¼Œä½†æ˜¯ä¸å¸¸ç”¨çš„å‘½ä»¤ã€‚ æ¦‚å¿µå…¶å® git çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¼€å‘è€…åº”è¯¥å¾ˆå¤šæœ‰ä¼šäº†ï¼Œå­˜åœ¨ä»¥ä¸‹å‡ ä¸ªåŒºåŸŸï¼š å·¥ä½œåŒº ï¼ˆä½ çš„ä»»ä½•æ”¹åŠ¨ï¼‰ æš‚å­˜åŒº ï¼ˆgit addï¼‰ æœ¬åœ°ä»“åº“ ï¼ˆgit commitï¼‰ è¿œç«¯ä»£ç ä»“åº“ ï¼ˆgit pushï¼‰ åˆå¹¶æˆ‘ä»¬ä¸€èˆ¬è¯´åˆå¹¶å…¶å®æ˜¯æœ‰","categories":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/categories/DevOps/"}],"tags":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/tags/DevOps/"}]},{"title":"ã€Golangã€‘- go mapæºç é˜…è¯»","slug":"Golang/go mapæºç é˜…è¯»","date":"2022-03-10T07:55:51.000Z","updated":"2022-03-22T08:54:11.241Z","comments":true,"path":"2022/03/10/Golang/go mapæºç é˜…è¯»/","link":"","permalink":"http://blog.crazylaw.cn/2022/03/10/Golang/go%20map%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/","excerpt":"å‰è¨€æœ€è¿‘å‘ç°åŒäº‹å»é¢è¯•ï¼Œå‘ç°å¾ˆå¤šæ—¶å€™ä¼šè¢«é—®åˆ°go mapçš„åº•å±‚ç»“æ„ã€‚ä»Šå¤©æˆ‘ä»¬æ¥è®°å½•ä¸€ä¸‹mapçš„åº•å±‚å®ç°ã€‚","text":"å‰è¨€æœ€è¿‘å‘ç°åŒäº‹å»é¢è¯•ï¼Œå‘ç°å¾ˆå¤šæ—¶å€™ä¼šè¢«é—®åˆ°go mapçš„åº•å±‚ç»“æ„ã€‚ä»Šå¤©æˆ‘ä»¬æ¥è®°å½•ä¸€ä¸‹mapçš„åº•å±‚å®ç°ã€‚ å½“ä¸‹çš„æºç é˜…è¯»åŸºäº1.17 12345678910111213141516// A header for a Go map.type hmap struct &#123; // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. // Make sure this stays in sync with the compiler's definition. count int // # live cells == size of map. Must be first (used by len() builtin) flags uint8 B uint8 // log_2 of # of buckets (can hold up to loadFactor * 2^B items) noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details hash0 uint32 // hash seed buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields&#125; å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªmapçš„å¤´éƒ¨ç»“æ„ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªå…³é”®ç»“æ„ï¼Œåˆ†åˆ«æ˜¯ count å½“å‰mapçš„å…ƒç´ ä¸ªæ•° buckets æ¡¶çš„æ•°é‡ï¼Œä¸€èˆ¬æ˜¯2^Bä¸ª oldbuckets æ‰©å®¹å‰çš„buckets 12345678910111213141516// mapextra holds fields that are not present on all maps.type mapextra struct &#123; // If both key and elem do not contain pointers and are inline, then we mark bucket // type as containing no pointers. This avoids scanning such maps. // However, bmap.overflow is a pointer. In order to keep overflow buckets // alive, we store pointers to all overflow buckets in hmap.extra.overflow and hmap.extra.oldoverflow. // overflow and oldoverflow are only used if key and elem do not contain pointers. // overflow contains overflow buckets for hmap.buckets. // oldoverflow contains overflow buckets for hmap.oldbuckets. // The indirection allows to store a pointer to the slice in hiter. overflow *[]*bmap oldoverflow *[]*bmap // nextOverflow holds a pointer to a free overflow bucket. nextOverflow *bmap&#125; ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªå¯ä»¥å¿½ç•¥ã€‚ 123456789101112// A bucket for a Go map.type bmap struct &#123; // tophash generally contains the top byte of the hash value // for each key in this bucket. If tophash[0] &lt; minTopHash, // tophash[0] is a bucket evacuation state instead. tophash [bucketCnt]uint8 // Followed by bucketCnt keys and then bucketCnt elems. // NOTE: packing all the keys together and then all the elems together makes the // code a bit more complicated than alternating key/elem/key/elem/... but it allows // us to eliminate padding which would be needed for, e.g., map[int64]int8. // Followed by an overflow pointer.&#125; bmapæœ‰2ä¸ªæ¨¡å—çš„å±æ€§æ˜¯åœ¨ç¼–è¯‘æ³¨å…¥çš„ï¼Œåœ¨æºç ä¸Šæ²¡åŠæ³•æµè§ˆã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚bmap â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚â”‚bmap â”‚ â”‚ â”‚â”‚ â”‚ â”‚ â”‚â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚ â”‚ â”‚ â”‚tohash[bucketCnt]uint8 â”‚ â”‚â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚â”‚ â”‚tohash[bucketCnt]uint8 â”‚ â”‚ â”‚ â”‚ â”‚ â”‚â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚ â”‚ â”‚ â”‚ â”‚ â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ ++++++++++++++++++++++++++++++++ â”‚â”‚ â”‚ â”‚ + byte-array + â”‚â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ + (save key-value) + â”‚â”‚ + byte-array + â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–ºâ”‚ + + â”‚â”‚ + (save key-value) + â”‚ â”‚ â”‚ ++++++++++++++++++++++++++++++++ â”‚â”‚ + + â”‚ â”‚ â”‚ â”‚â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ â”‚ ++++++++++++++++++++++++++++++++ â”‚â”‚ â”‚ â”‚ â”‚ + point to growed bucket + â”‚â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ â”‚ + + â”‚â”‚ + point to growed bucket + â”‚ â”‚ â”‚ + + â”‚â”‚ + + â”œâ”€â”€â”€â”€â”€â”˜ â”‚ +++++++++++++â”€â”+++++++++++++++++ â”‚â”‚ + + â”‚ â”‚ â”‚ â”‚â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ â”‚ â”‚â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚ â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â–¼ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚bmap â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚tohash[bucketCnt]uint8 â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ + byte-array + â”‚ â”‚ + (save key-value) + â”‚ â”‚ + + â”‚ â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ â”‚ â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ + point to growed bucket + â”‚ â”‚ + + â”‚ â”‚ + + â”‚ â”‚ ++++++++++++++++++++++++++++++++ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜s ç›¸æ¯”äºhmapï¼Œbucketçš„ç»“æ„æ˜¾å¾—ç®€å•ä¸€äº›ï¼Œbyte-arrayæ˜¯æˆ‘ä»¬ä½¿ç”¨çš„mapä¸­çš„keyå’Œvalueå°±å­˜å‚¨åœ¨è¿™é‡Œã€‚é«˜ä½å“ˆå¸Œå€¼æ•°ç»„è®°å½•çš„æ˜¯å½“å‰bucketä¸­keyç›¸å…³çš„ç´¢å¼• mapassign èµ‹å€¼è¿‡ç¨‹123456789101112131415161718192021222324252627282930313233343536373839// 1. åˆ¤æ–­ä¼šå¦å½“å‰å·²ç»è¿›è¡Œäº†å†™ä¿æŠ¤if h.flags&amp;hashWriting != 0 &#123; throw(\"concurrent map writes\")&#125;// 2. æ ¹æ®keyè®¡ç®—å“ˆå¸Œå€¼hash := t.hasher(key, uintptr(h.hash0))// 3. è¿›è¡Œå†™ä¿æŠ¤h.flags ^= hashWriting// 4. è®¡ç®—hashçš„ä½ä½éƒ¨åˆ†bucket := hash &amp; bucketMask(h.B)// 5. åˆ¤æ–­æ˜¯å¦æ­£åœ¨æ‰©å®¹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ•°æ®è¿ç§»if h.growing() &#123; growWork(t, h, bucket)&#125;// 6. æ ¹æ®ä½ä½hashæ‰¾åˆ°å¯¹åº”çš„bucketb := (*bmap)(add(h.buckets, bucket*uintptr(t.bucketsize)))// 7. è®¡ç®—é«˜ä½hashtop := tophash(hash)// 8. ä»å¯¹åº”çš„bucketä»¥åŠoverflow bucketsä¸­æ‰¾åˆ°å¯¹åº”çš„keyçš„ä½ç½®// 9. åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™é‡æ–°æ‰¾åˆ°keyçš„ä½ç½®if !h.growing() &amp;&amp; (overLoadFactor(h.count+1, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) &#123; hashGrow(t, h) goto again // Growing the table invalidates everything, so try again&#125;// 10. æ‹¿ç€å¯ä»¥æ’å…¥kvçš„å†…å­˜åœ°å€è¿›è¡Œèµ‹å€¼if t.indirectkey() &#123; kmem := newobject(t.key) *(*unsafe.Pointer)(insertk) = kmem insertk = kmem&#125;if t.indirectelem() &#123; vmem := newobject(t.elem) *(*unsafe.Pointer)(elem) = vmem&#125;// 11. å†™ä¿æŠ¤æ£€æŸ¥ï¼Œå¹¶ä¸”è§£é™¤å†™ä¿æŠ¤ if h.flags&amp;hashWriting == 0 &#123; throw(\"concurrent map writes\")&#125;h.flags &amp;^= hashWriting èµ‹å€¼è¿‡ç¨‹å°±æ˜¯ï¼š è¿›è¡Œå†™ä¿æŠ¤ æ ¹æ®keyè®¡ç®—å“ˆå¸Œå€¼ åœ¨ä½ä½å“ˆå¸Œä¸­æ‰¾åˆ°bucket è®¡ç®—é«˜ä½hash åœ¨bucketå’Œoverflow bucketæ¡¶ä¸­æ‰¾åˆ°èƒ½æ’å…¥key/valueçš„ä½ç½® æ‰¾åˆ°äº†å°±èµ‹å€¼ è§£é™¤é”ä¿æŠ¤ å…¶ä¸­æœ‰å¤šæ¬¡åˆ¤æ–­bucketæ˜¯å¦éœ€è¦æ‰©å®¹å’Œæ˜¯å¦æ­£åœ¨æ‰©å®¹","categories":[{"name":"Goæºç å‰–æç³»åˆ—","slug":"Goæºç å‰–æç³»åˆ—","permalink":"http://blog.crazylaw.cn/categories/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%B3%BB%E5%88%97/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"},{"name":"Goæºç å‰–æ","slug":"Goæºç å‰–æ","permalink":"http://blog.crazylaw.cn/tags/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"}]},{"title":"ã€Golangã€‘- go time.Sleepæºç é˜…è¯»","slug":"Golang/go time.Sleepæºç é˜…è¯»","date":"2022-03-10T07:55:51.000Z","updated":"2022-03-10T14:09:34.592Z","comments":true,"path":"2022/03/10/Golang/go time.Sleepæºç é˜…è¯»/","link":"","permalink":"http://blog.crazylaw.cn/2022/03/10/Golang/go%20time.Sleep%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/","excerpt":"å‰è¨€ç”±äºtime.Sleep()ä¼šæŒ‚èµ·æˆ‘ä»¬çš„åç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„åº•å±‚åŸç†ã€‚","text":"å‰è¨€ç”±äºtime.Sleep()ä¼šæŒ‚èµ·æˆ‘ä»¬çš„åç¨‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„åº•å±‚åŸç†ã€‚ sleep çš„å®ç°æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ time.Sleep(1 * time.Second) æ¥å°† goroutine æš‚æ—¶ä¼‘çœ ä¸€æ®µæ—¶é—´ã€‚sleep æ“ä½œåœ¨åº•å±‚å®ç°ä¹Ÿæ˜¯åŸºäº timer å®ç°çš„ã€‚ æœ‰ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼Œå•ç‹¬æ‹¿å‡ºæ¥è®²ä¸‹ã€‚ æˆ‘ä»¬å›ºç„¶ä¹Ÿå¯ä»¥è¿™ä¹ˆåšæ¥å®ç° goroutine çš„ä¼‘çœ : 12timer := time.NewTimer(2 * time.Seconds)&lt;-timer.C è¿™ä¹ˆåšå½“ç„¶å¯ä»¥ã€‚ä½† golang åº•å±‚æ˜¾ç„¶ä¸æ˜¯è¿™ä¹ˆåšçš„ï¼Œå› ä¸ºè¿™æ ·æœ‰ä¸¤ä¸ªæ˜æ˜¾çš„é¢å¤–æ€§èƒ½æŸè€—ã€‚ æ¯æ¬¡è°ƒç”¨ sleep çš„æ—¶å€™ï¼Œéƒ½è¦åˆ›å»ºä¸€ä¸ª timer å¯¹è±¡ éœ€è¦ä¸€ä¸ª channel æ¥ä¼ é€’äº‹ä»¶ æ—¢ç„¶éƒ½å¯ä»¥æ”¾åœ¨ runtime é‡Œé¢åšã€‚golang é‡Œé¢åšçš„æ›´åŠ å¹²å‡€ï¼š 123456789101112131415161718192021// timeSleep puts the current goroutine to sleep for at least ns nanoseconds.//go:linkname timeSleep time.Sleepfunc timeSleep(ns int64) &#123; if ns &lt;= 0 &#123; return &#125; gp := getg() t := gp.timer if t == nil &#123; t = new(timer) gp.timer = t &#125; t.f = goroutineReady t.arg = gp t.nextwhen = nanotime() + ns if t.nextwhen &lt; 0 &#123; // check for overflow. t.nextwhen = maxWhen &#125; gopark(resetForSleep, unsafe.Pointer(t), waitReasonSleep, traceEvGoSleep, 1)&#125; åœ¨Gå¯¹è±¡ä¸Šå­˜åœ¨ä¸€ä¸ªtimerå±æ€§ï¼Œåœ¨Gçš„ç”Ÿå‘½å‘¨æœŸé‡Œtimeréƒ½æ˜¯å”¯ä¸€å­˜åœ¨ï¼Œè§£å†³äº†é‡å¤æ–°å»ºå¯¹è±¡çš„é—®é¢˜ å¦‚æœä¸å­˜åœ¨timerï¼Œåˆ™åœ¨ç¬¬ä¸€æ¬¡çš„æ—¶å€™åˆ›å»ºtimer å¹¶ä¸”æŠŠt.fè®¾ç½®æˆgoroutineReay(è¿™ä¸ªæ„æ€æ˜¯timeåˆ°äº†æ—¶é—´ä¹‹åè®¾ç½®ä¸€ä¸ªè§¦å‘å‡½æ•°ï¼Œè¿™ä¸ªè§¦å‘å‡½æ•°å°±æ˜¯å”¤é†’æˆ‘ä»¬å½“å‰Gä»»åŠ¡)ã€‚ ç„¶åé€šè¿‡goparkæ¥æŒ‚èµ·å½“å‰çš„Gä»»åŠ¡ å®šæ—¶å™¨çš„è§¦å‘æœºåˆ¶å…±åˆ†ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸º è°ƒåº¦å™¨è§¦å‘ å’Œ ç›‘æ§çº¿ç¨‹sysmon è§¦å‘ï¼Œä¸¤è€…ä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨å‡½æ•° checkTimers() æ¥å®ç°çš„ã€‚ ä¸»è¦æœ‰ä¸¤ä¸ªåœ°æ–¹ä¼šæ£€æŸ¥è®¡æ—¶å™¨ï¼Œä¸€ä¸ªæ˜¯ runtime.scheduleï¼Œå¦ä¸€ä¸ªæ˜¯ findrunnableã€‚ 1234567891011121314// runtime/proc.gofunc schedule() &#123; _g_ := getg() top: pp := _g_.m.p.ptr() pp.preempt = false // å¤„ç†è°ƒåº¦æ—¶çš„è®¡æ—¶å™¨è§¦å‘ checkTimers(pp, 0) ... execute(gp, inheritTime) &#125; å¦å¤–ä¸€ç§æ˜¯å½“å‰å¤„ç†å™¨ P æ²¡æœ‰å¯æ‰§è¡Œçš„ Timerï¼Œä¸”æ²¡æœ‰å¯æ‰§è¡Œçš„ Gã€‚é‚£ä¹ˆæŒ‰ç…§è°ƒåº¦æ¨¡å‹ï¼Œå°±ä¼šå»çªƒå–å…¶ä»–è®¡æ—¶å™¨å’Œ Gï¼š 12345678910// runtime/proc.gofunc findrunnable() (gp *g, inheritTime bool) &#123; _g_ := getg() top: _p_ := _g_.m.p.ptr() ... now, pollUntil, _ := checkTimers(_p_, 0) ... &#125;","categories":[{"name":"Goæºç å‰–æç³»åˆ—","slug":"Goæºç å‰–æç³»åˆ—","permalink":"http://blog.crazylaw.cn/categories/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%B3%BB%E5%88%97/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"},{"name":"Goæºç å‰–æ","slug":"Goæºç å‰–æ","permalink":"http://blog.crazylaw.cn/tags/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"}]},{"title":"ã€Golangã€‘- go channelæºç é˜…è¯»","slug":"Golang/go channelæºç é˜…è¯»","date":"2022-03-03T16:43:51.000Z","updated":"2022-03-29T02:24:03.596Z","comments":true,"path":"2022/03/04/Golang/go channelæºç é˜…è¯»/","link":"","permalink":"http://blog.crazylaw.cn/2022/03/04/Golang/go%20channel%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/","excerpt":"å‰è¨€channel æ˜¯ Golang ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ Golang CSP å¹¶å‘æ¨¡å‹çš„ä¸€ä¸ªé‡è¦ä½“ç°ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œgoroutine ä¹‹é—´å¯ä»¥é€šè¿‡ channel è¿›è¡Œé€šä¿¡ã€‚ channel åœ¨ Golang å¦‚æ­¤é‡è¦ï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨é¢‘ç‡éå¸¸é«˜ï¼Œä»¥è‡³äºä¸å¾—ä¸å¥½å¥‡å…¶å†…éƒ¨å®ç°ã€‚æœ¬æ–‡å°†åŸºäº go 1.17 çš„æºç ï¼Œåˆ†æ channel çš„å†…éƒ¨å®ç°åŸç†ã€‚","text":"å‰è¨€channel æ˜¯ Golang ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯ Golang CSP å¹¶å‘æ¨¡å‹çš„ä¸€ä¸ªé‡è¦ä½“ç°ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼Œgoroutine ä¹‹é—´å¯ä»¥é€šè¿‡ channel è¿›è¡Œé€šä¿¡ã€‚ channel åœ¨ Golang å¦‚æ­¤é‡è¦ï¼Œåœ¨ä»£ç ä¸­ä½¿ç”¨é¢‘ç‡éå¸¸é«˜ï¼Œä»¥è‡³äºä¸å¾—ä¸å¥½å¥‡å…¶å†…éƒ¨å®ç°ã€‚æœ¬æ–‡å°†åŸºäº go 1.17 çš„æºç ï¼Œåˆ†æ channel çš„å†…éƒ¨å®ç°åŸç†ã€‚ channel çš„åŸºæœ¬ä½¿ç”¨åœ¨æ­£å¼åˆ†æ channel çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ channel çš„æœ€åŸºæœ¬ç”¨æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567891011121314package mainimport \"fmt\"func main() &#123; c := make(chan int) go func() &#123; c &lt;- 1 // send to channel &#125;() x := &lt;-c // recv from channel fmt.Println(x)&#125; åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ make(chan int) æ¥åˆ›å»ºäº†ä¸€ä¸ªç±»å‹ä¸º int çš„ channelã€‚åœ¨ä¸€ä¸ª goroutine ä¸­ä½¿ç”¨ c &lt;- 1 å°†æ•°æ®å‘é€åˆ° channel ä¸­ã€‚åœ¨ä¸» goroutine ä¸­é€šè¿‡ x := &lt;- c ä» channel ä¸­è¯»å–æ•°æ®å¹¶èµ‹å€¼ç»™ xã€‚ ä»¥ä¸Šä»£ç å¯¹åº”äº† channel çš„ä¸¤ç§åŸºæœ¬æ“ä½œï¼š send æ“ä½œ c &lt;- 1 è¡¨ç¤ºå‘é€æ•°æ®åˆ° channel recv æ“ä½œ x := &lt;- c è¡¨ç¤ºä» channel ä¸­æ¥æ”¶æ•°æ®ã€‚ æ­¤å¤–ï¼Œchannel è¿˜åˆ†ä¸ºæœ‰ç¼“å­˜ channel å’Œæ— ç¼“å­˜ channelã€‚ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æ— ç¼“å†²çš„ channelã€‚å¯¹äºæ— ç¼“å†²çš„ channelï¼Œå¦‚æœå½“å‰æ²¡æœ‰å…¶ä»– goroutine æ­£åœ¨æ¥æ”¶ channel æ•°æ®ï¼Œåˆ™å‘é€æ–¹ä¼šé˜»å¡åœ¨å‘é€è¯­å¥å¤„ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨ channel åˆå§‹åŒ–æ—¶æŒ‡å®šç¼“å†²åŒºå¤§å°ã€‚ä¾‹å¦‚ï¼Œmake(chan int, 2) åˆ™æŒ‡å®šç¼“å†²åŒºå¤§å°ä¸º 2ã€‚åœ¨ç¼“å†²åŒºæœªæ»¡ä¹‹å‰ï¼Œå‘é€æ–¹æ— é˜»å¡åœ°å¯ä»¥å¾€ channel å‘é€æ•°æ®ï¼Œæ— éœ€ç­‰å¾…æ¥æ”¶æ–¹å‡†å¤‡å¥½ã€‚è€Œå¦‚æœç¼“å†²åŒºå·²æ»¡ï¼Œåˆ™å‘é€æ–¹ä¾ç„¶ä¼šé˜»å¡ã€‚ channel å¯¹åº”çš„åº•å±‚å®ç°å‡½æ•°åœ¨æ¢ç©¶ channel æºç ä¹‹å‰ï¼Œæˆ‘ä»¬è‚¯å®šé¦–å…ˆéœ€è¦å…ˆæ‰¾åˆ° channel åœ¨ Golang çš„å…·ä½“å®ç°åœ¨å“ªã€‚å› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨ channel æ—¶ï¼Œç”¨çš„æ˜¯ &lt;- ç¬¦å·ï¼Œå¹¶ä¸èƒ½ç›´æ¥åœ¨ go æºç ä¸­æ‰¾åˆ°å…¶å®ç°ã€‚ä½†æ˜¯ Golang ç¼–è¯‘å™¨å¿…ç„¶ä¼šå°† &lt;- ç¬¦å·ç¿»è¯‘æˆåº•å±‚å¯¹åº”çš„å®ç°ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Go è‡ªå¸¦çš„å‘½ä»¤: go tool compile -N -l -S hello.go, å°†ä»£ç ç¿»è¯‘æˆå¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ã€‚ æˆ–è€…ï¼Œç›´æ¥å¯ä»¥ä½¿ç”¨ Compiler Explorer è¿™ä¸ªåœ¨çº¿å·¥å…·ã€‚å¯¹äºä¸Šè¿°ç¤ºä¾‹ä»£ç å¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªé“¾æ¥çœ‹å…¶æ±‡ç¼–ç»“æœ: go.godbolt.org/z/3xw5Cjã€‚å¦‚ä¸‹å›¾ï¼š chansend1 chanrevc1 é€šè¿‡ä»”ç»†æŸ¥çœ‹ä»¥ä¸Šç¤ºä¾‹ä»£ç å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå¯ä»¥å‘ç°ä»¥ä¸‹çš„å¯¹åº”å…³ç³»ï¼š channel çš„æ„é€ è¯­å¥ make(chan int), å¯¹åº”çš„æ˜¯ runtime.makechan å‡½æ•°å‘é€è¯­å¥ c &lt;- 1, å¯¹åº”çš„æ˜¯ runtime.chansend1 å‡½æ•°æ¥æ”¶è¯­å¥ x := &lt;- c, å¯¹åº”çš„æ˜¯ runtime.chanrecv1 å‡½æ•°ä»¥ä¸Šå‡ ä¸ªå‡½æ•°çš„å®ç°éƒ½ä½äº go æºç ä¸­çš„ runtime/chan.go ä»£ç æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥é’ˆå¯¹è¿™å‡ ä¸ªå‡½æ•°ï¼Œæ¢ç©¶ä¸‹ channel çš„å®ç°ã€‚ channel çš„æ„é€ channel çš„æ„é€ è¯­å¥ make(chan int)ï¼Œå°†ä¼šè¢« golang ç¼–è¯‘å™¨ç¿»è¯‘ä¸º runtime.makechan å‡½æ•°, å…¶å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š 1func makechan(t *chantype, size int) *hchan å…¶ä¸­ï¼Œt *chantype å³æ„é€  channel æ—¶ä¼ å…¥çš„å…ƒç´ ç±»å‹ã€‚size int å³ç”¨æˆ·æŒ‡å®šçš„ channel ç¼“å†²åŒºå¤§å°ï¼Œä¸æŒ‡å®šåˆ™ä¸º 0ã€‚è¯¥å‡½æ•°çš„è¿”å›å€¼æ˜¯ *hchanã€‚hchan åˆ™æ˜¯ channel åœ¨ golang ä¸­çš„å†…éƒ¨å®ç°ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011121314type hchan struct &#123; qcount uint // buffer ä¸­å·²æ”¾å…¥çš„å…ƒç´ ä¸ªæ•° dataqsiz uint // ç”¨æˆ·æ„é€  channel æ—¶æŒ‡å®šçš„ buf å¤§å° buf unsafe.Pointer // buffer elemsize uint16 // buffer ä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å° closed uint32 // channel æ˜¯å¦å…³é—­ï¼Œ== 0 ä»£è¡¨æœª closed elemtype *_type // channel å…ƒç´ çš„ç±»å‹ä¿¡æ¯ sendx uint // buffer ä¸­å·²å‘é€çš„ç´¢å¼•ä½ç½® send index recvx uint // buffer ä¸­å·²æ¥æ”¶çš„ç´¢å¼•ä½ç½® receive index recvq waitq // ç­‰å¾…æ¥æ”¶çš„ goroutine list of recv waiters sendq waitq // ç­‰å¾…å‘é€çš„ goroutine list of send waiters lock mutex&#125; hchan ä¸­çš„æ‰€æœ‰å±æ€§å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š buffer ç›¸å…³çš„å±æ€§ã€‚ä¾‹å¦‚ bufã€dataqsizã€qcount ç­‰ã€‚ å½“ channel çš„ç¼“å†²åŒºå¤§å°ä¸ä¸º 0 æ—¶ï¼Œbuffer ä¸­å­˜æ”¾äº†å¾…æ¥æ”¶çš„æ•°æ®ã€‚ä½¿ç”¨ ring buffer å®ç°ã€‚ waitq ç›¸å…³çš„å±æ€§ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ª FIFO çš„æ ‡å‡†é˜Ÿåˆ—ã€‚å…¶ä¸­ recvq ä¸­æ˜¯æ­£åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutineï¼Œsendq ä¸­æ˜¯ç­‰å¾…å‘é€æ•°æ®çš„ goroutineã€‚waitq ä½¿ç”¨åŒå‘é“¾è¡¨å®ç°ã€‚ å…¶ä»–å±æ€§ï¼Œä¾‹å¦‚ lockã€elemtypeã€closedã€‚ é€šè¿‡ç®€å•åˆ†æ hchan çš„å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å…¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„ç»„ä»¶ï¼Œbuffer å’Œ waitqã€‚hchan æ‰€æœ‰è¡Œä¸ºå’Œå®ç°éƒ½æ˜¯å›´ç»•è¿™ä¸¤ä¸ªç»„ä»¶è¿›è¡Œçš„ã€‚ å‘ channel ä¸­å‘é€æ•°æ®channel çš„å‘é€å’Œæ¥æ”¶æµç¨‹å¾ˆç›¸ä¼¼ï¼Œæˆ‘ä»¬å…ˆåˆ†æä¸‹ channel çš„å‘é€è¿‡ç¨‹ (å¦‚ c &lt;- 1), å¯¹åº”äº runtime.chansend å‡½æ•°çš„å®ç°ã€‚ åœ¨å°è¯•å‘ channel ä¸­å‘é€æ•°æ®æ—¶ï¼Œå¦‚æœ recvq é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™é¦–å…ˆä¼šä» recvq ä¸­å¤´éƒ¨å–å‡ºä¸€ä¸ªç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutine å‡ºæ¥ã€‚å¹¶å°†æ•°æ®ç›´æ¥å‘é€ç»™è¯¥ goroutineã€‚ä»£ç å¦‚ä¸‹ï¼š 1234567891011lock(&amp;c.lock)if c.closed != 0 &#123; unlock(&amp;c.lock) panic(plainError(\"send on closed channel\"))&#125;if sg := c.recvq.dequeue(); sg != nil &#123; send(c, sg, ep, func() &#123; unlock(&amp;c.lock) &#125;, 3) return true&#125; æˆ‘ä»¬çœ‹åˆ°å½“æˆ‘ä»¬æ•´ä¸ªsendçš„è¿‡ç¨‹æ˜¯éœ€è¦åŠ é”å¤„ç†çš„ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬è€ç”Ÿå¸¸è°ˆçš„ä¸€ä¸ªé—®é¢˜ï¼Œå½“å‘cloesdçš„channelæ•°æ®çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´panicäº§ç”Ÿ recvq ä¸­æ˜¯æ­£åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutineã€‚å½“æŸä¸ª goroutine ä½¿ç”¨ recv æ“ä½œ (ä¾‹å¦‚ï¼Œx := &lt;- c)ï¼Œå¦‚æœæ­¤æ—¶ channel çš„ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œä¸”æ²¡æœ‰å…¶ä»– goroutine æ­£åœ¨ç­‰å¾…å‘é€æ•°æ® (å³ sendq ä¸ºç©º)ï¼Œä¼šå°†è¯¥ goroutine ä»¥åŠè¦æ¥æ”¶çš„æ•°æ®åœ°å€æ‰“åŒ…æˆ sudog å¯¹è±¡ï¼Œå¹¶æ”¾å…¥åˆ° recvq ä¸­ã€‚ ç»§ç»­æ¥ç€è®²ä¸Šé¢çš„ä»£ç ï¼Œå¦‚æœæ­¤æ—¶ recvq ä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ send å‡½æ•°å°†æ•°æ®æ‹·è´åˆ°å¯¹åº”çš„ goroutine çš„å †æ ˆä¸Šã€‚ è¿™ä¸ªæ—¶å€™ä¸ç»è¿‡æˆ‘ä»¬çš„ç¯å½¢ç¼“å­˜ï¼ï¼ï¼ send å‡½æ•°çš„å®ç°ä¸»è¦åŒ…å«ä¸¤ç‚¹ï¼š memmove(dst, src, t.size) è¿›è¡Œæ•°æ®çš„è½¬ç§»ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå†…å­˜æ‹·è´ã€‚ goready(gp, skip+1) goready çš„ä½œç”¨æ˜¯å”¤é†’å¯¹åº”çš„ goroutineã€‚ è€Œå¦‚æœ recvq é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™è¯´æ˜æ­¤æ—¶æ²¡æœ‰ç­‰å¾…æ¥æ”¶æ•°æ®çš„ goroutineï¼Œé‚£ä¹ˆæ­¤æ—¶ channel ä¼šå°è¯•æŠŠæ•°æ®æ”¾åˆ°ç¼“å­˜ä¸­ã€‚ 123456789101112131415if c.qcount &lt; c.dataqsiz &#123; // Space is available in the channel buffer. Enqueue the element to send. qp := chanbuf(c, c.sendx) if raceenabled &#123; racenotify(c, c.sendx, nil) &#125; typedmemmove(c.elemtype, qp, ep) c.sendx++ if c.sendx == c.dataqsiz &#123; c.sendx = 0 &#125; c.qcount++ unlock(&amp;c.lock) return true&#125; ä»¥ä¸Šä»£ç çš„ä½œç”¨å…¶å®éå¸¸ç®€å•ï¼Œå°±æ˜¯æŠŠæ•°æ®æ”¾åˆ° buffer ä¸­è€Œå·²ã€‚æ­¤è¿‡ç¨‹æ¶‰åŠäº† ring buffer çš„æ“ä½œï¼Œå…¶ä¸­ dataqsiz ä»£è¡¨ç”¨æˆ·æŒ‡å®šçš„ channel çš„ buffer å¤§å°ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™é»˜è®¤ä¸º 0ã€‚ å¦‚æœç”¨æˆ·ä½¿ç”¨çš„æ˜¯æ— ç¼“å†² channel æˆ–è€…æ­¤æ—¶ buffer å·²æ»¡ï¼Œåˆ™ c.qcount &lt; c.dataqsiz æ¡ä»¶ä¸ä¼šæ»¡è¶³, ä»¥ä¸Šæµç¨‹ä¹Ÿå¹¶ä¸ä¼šæ‰§è¡Œåˆ°ã€‚æ­¤æ—¶ä¼šå°†å½“å‰çš„ goroutine ä»¥åŠè¦å‘é€çš„æ•°æ®æ”¾å…¥åˆ° sendq é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶ä¼šåˆ‡å‡ºè¯¥ goroutine 12345678910111213141516171819202122232425262728293031// Block on the channel. Some receiver will complete our operation for us.gp := getg()mysg := acquireSudog()mysg.releasetime = 0if t0 != 0 &#123; mysg.releasetime = -1&#125;// No stack splits between assigning elem and enqueuing mysg// on gp.waiting where copystack can find it.mysg.elem = epmysg.waitlink = nilmysg.g = gpmysg.isSelect = falsemysg.c = cgp.waiting = mysggp.param = nilc.sendq.enqueue(mysg)// Signal to anyone trying to shrink our stack that we're about// to park on a channel. The window between when this G's status// changes and when we set gp.activeStackChans is not safe for// stack shrinking.atomic.Store8(&amp;gp.parkingOnChan, 1)// å°† goroutine è½¬å…¥ waiting çŠ¶æ€gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, 2)// Ensure the value being sent is kept alive until the// receiver copies it out. The sudog has a pointer to the// stack object, but sudogs aren't considered as roots of the// stack tracer.KeepAlive(ep)// ç¡®ä¿æ­£åœ¨å‘é€çš„å€¼ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æ¥æ”¶è€…å°†å…¶å¤åˆ¶å‡ºæ¥ã€‚sudogæœ‰ä¸€ä¸ªæŒ‡å‘å †æ ˆå¯¹è±¡çš„æŒ‡é’ˆï¼Œä½†æ˜¯sudogä¸è¢«è®¤ä¸ºæ˜¯å †æ ˆè·Ÿè¸ªç¨‹åºçš„æ ¹ã€‚// æ€»è€Œè¨€ä¹‹ï¼šé˜²æ­¢è¢«GC è°ƒç”¨ gopark åï¼Œå¯¹äºç”¨æˆ·ä¾§æ¥çœ‹ï¼Œè¯¥å‘ channel å‘é€æ•°æ®çš„ä»£ç è¯­å¥ä¼šè¿›è¡Œé˜»å¡ã€‚ ä»¥ä¸Šè¿‡ç¨‹å°±æ˜¯ channel çš„å‘é€è¯­å¥ (å¦‚ï¼Œc &lt;- 1) çš„å†…éƒ¨å·¥ä½œæµç¨‹ï¼ŒåŒæ—¶æ•´ä¸ªå‘é€è¿‡ç¨‹éƒ½ä½¿ç”¨ c.lock è¿›è¡ŒåŠ é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨ã€‚ ç®€å•æ¥è¯´ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š æ£€æŸ¥ recvq æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä» recvq å¤´éƒ¨å–ä¸€ä¸ª goroutineï¼Œå°†æ•°æ®å‘é€è¿‡å»ï¼Œå¹¶å”¤é†’å¯¹åº”çš„ goroutine å³å¯ å¦‚æœ recvq ä¸ºç©ºï¼Œåˆ™å°†æ•°æ®æ”¾å…¥åˆ° buffer ä¸­ å¦‚æœ buffer å·²æ»¡ï¼Œåˆ™å°†è¦å‘é€çš„æ•°æ®å’Œå½“å‰ goroutine æ‰“åŒ…æˆ sudog å¯¹è±¡æ”¾å…¥åˆ° sendq ä¸­ã€‚å¹¶å°†å½“å‰ goroutine ç½®ä¸º waiting çŠ¶æ€ã€‚ ä» channel ä¸­æ¥æ”¶æ•°æ®çš„è¿‡ç¨‹åŸºæœ¬ä¸å‘é€è¿‡ç¨‹ç±»ä¼¼ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°äº†ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œchannel çš„æ•´ä¸ªå‘é€è¿‡ç¨‹å’Œæ¥æ”¶è¿‡ç¨‹éƒ½ä½¿ç”¨ runtime.mutex è¿›è¡ŒåŠ é”ã€‚runtime.mutex æ˜¯ runtime ç›¸å…³æºç ä¸­å¸¸ç”¨åˆ°çš„ä¸€ä¸ªè½»é‡çº§é”ã€‚æ•´ä¸ªè¿‡ç¨‹å¹¶ä¸æ˜¯æœ€é«˜æ•ˆçš„ lockfree çš„åšæ³•ã€‚ golang åœ¨è¿™é‡Œæœ‰ä¸ª issue:go/issues#8899ï¼Œç»™å‡ºäº† lockfree çš„ channel çš„æ–¹æ¡ˆã€‚","categories":[{"name":"Goæºç å‰–æç³»åˆ—","slug":"Goæºç å‰–æç³»åˆ—","permalink":"http://blog.crazylaw.cn/categories/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%B3%BB%E5%88%97/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"},{"name":"Goæºç å‰–æ","slug":"Goæºç å‰–æ","permalink":"http://blog.crazylaw.cn/tags/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"}]},{"title":"ã€Golangã€‘- SyncåŒ…è¯¦è§£","slug":"Golang/syncåŒ…è¯¦è§£","date":"2022-03-03T16:43:51.000Z","updated":"2022-04-15T07:40:12.764Z","comments":true,"path":"2022/03/04/Golang/syncåŒ…è¯¦è§£/","link":"","permalink":"http://blog.crazylaw.cn/2022/03/04/Golang/sync%E5%8C%85%E8%AF%A6%E8%A7%A3/","excerpt":"å‰è¨€æˆ‘ä»¬ç›´åˆ°syncåŒ…ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—å¹¶å‘å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚ä¹‹å‰æœ‰è§è¿‡ä¸€æ¬¡sync-mapï¼Œä½†æ˜¯è¿™ä¸€æ¬¡åˆšå¥½å¤ä¹ æ•´ç†ä¸€ä¸‹syncåŒ…çš„çŸ¥è¯†ç‚¹ã€‚","text":"å‰è¨€æˆ‘ä»¬ç›´åˆ°syncåŒ…ç»™æˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—å¹¶å‘å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚ä¹‹å‰æœ‰è§è¿‡ä¸€æ¬¡sync-mapï¼Œä½†æ˜¯è¿™ä¸€æ¬¡åˆšå¥½å¤ä¹ æ•´ç†ä¸€ä¸‹syncåŒ…çš„çŸ¥è¯†ç‚¹ã€‚ Sync Sync.Map Sync.Once Sync.Pool Sync.Cond Sync.WaitGroup sync.Map sync.Mapä¸»è¦é’ˆå¯¹äºMapå¯¹äºå¹¶å‘è¯»å†™ä¸æ”¯æŒçš„åœºæ™¯ä¸‹æå‡ºå®ç°çš„ï¼Œå…¶åŸç†æ˜¯é€šè¿‡å¯¹mapçš„å†™æ“ä½œè¿›è¡ŒåŠ é”ï¼šSync.RWMutex åŒæ—¶sync.Mapå®ç°äº†è¯»å†™åˆ†ç¦»ï¼Œå½“å¯¹mapè¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œé€šè¿‡è¯»read Map, å½“read Mapä¸­ä¸å­˜åœ¨æ˜¯å»dirty mapä¸­è¯»å– 123456789101112131415161718type Map struct &#123; me Mutex read atomic.Value // readOnly,è¯»æ•°æ® dirty map[interface&#123;&#125;]*entry // åŒ…å«æœ€æ–°çš„å†™å…¥æ•°æ®ï¼Œå½“missedè¾¾åˆ°ä¸€å®šçš„å€¼æ—¶ï¼Œå°†å€¼èµ‹ç»™read misses int // è®¡æ•°ä½œç”¨ï¼Œæ¯æ¬¡ä»readä¸­è¯»å¤±è´¥ï¼Œåˆ™missedåŠ ä¸€&#125;// readOnlyçš„æ•°æ®ç»“æ„type readOnly struct&#123; m map[interface&#123;&#125;]*entry amended bool // Map.dirtyä¸­çš„æ•°æ®å’Œè¿™é‡Œçš„mä¸­çš„æ•°æ®ä¸åŒæ—¶å€¼ä¸ºtrue&#125;// entryçš„æ•°æ®ç»“æ„ï¼štype entry struct &#123; p unsafe.Pointer // *interface&#123;&#125; // å¯è§valueæ˜¯ä¸€ä¸ªæŒ‡é’ˆå€¼ï¼Œè™½ç„¶readå’Œdirtyå­˜åœ¨å†—ä½™æƒ…å†µï¼Œä½†ç”±äºæ˜¯æŒ‡é’ˆç±»å‹ï¼Œå­˜å‚¨ç©ºé—´ä¸ä¼šå¤ªå¤š&#125; sync.Mapç›¸å…³é—®é¢˜ sync.Mapçš„æ ¸å¿ƒå®ç°ï¼šä¸¤ä¸ªmap,ä¸€ä¸ªç”¨äºå†™ï¼Œä¸€ä¸ªç”¨äºè¯»ï¼Œè¿™æ ·çš„è®¾è®¡æ€æƒ³å¯ä»¥ç±»æ¯”äºç¼“å­˜ä¸æ•°æ®åº“ sync.Mapçš„å±€é™æ€§ï¼šå¦‚æœå†™è¿œé«˜äºè¯»ï¼Œdirty -&gt; readOnlyè¿™ä¸ªç±»ä¼¼äºåˆ·æ–°æ•°æ®çš„é¢‘ç‡è¾ƒé«˜ï¼Œä¸å¦‚ç›´æ¥ä½¿ç”¨mutex + mapçš„æ•ˆç‡é«˜ sync.Mapçš„è®¾è®¡æ€æƒ³ï¼šä¿è¯é«˜é¢‘ç‡è¯»çš„æ— é”ç»“æ„ï¼Œç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³ sync.WaitGroup sync.WaitGroupå¸¸ç”¨äºé’ˆå¯¹goroutineçš„å¹¶å‘æ‰§è¡Œï¼Œé€šè¿‡WaitGroupå¯ä»¥ç­‰å¾…æ‰€æœ‰çš„goç¨‹åºæ‰§è¡Œç»“æŸä¹‹åå†æ‰§è¡Œä¹‹åçš„é€»è¾‘ WaitGroupå¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæœ€åˆé‡0å¼€å§‹ï¼Œæä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼šAdd(),Done(),Wait()ç”¨æ¥æ§åˆ¶è®¡æ•°å™¨çš„æ•°é‡ã€‚Add(n)æŠŠè®¡æ•°å™¨è®¾ç½®ä¸ºn,Done()æ¯æ¬¡æŠŠè®¡æ•°å™¨å‡ä¸€ï¼ŒWait()ä¼šé˜»å¡ä»£ç çš„æ‰§è¡Œï¼Œç›´åˆ°è®¡æ•°å™¨çš„å€¼å‡åˆ°0ä¸ºæ­¢ã€‚","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- åœ¨å…¬å¸ä»0åˆ°1è½åœ°flinkæµè®¡ç®—ä»»åŠ¡","slug":"å¤§æ•°æ®/åœ¨å…¬å¸ä»0åˆ°1è½åœ°flinkæµè®¡ç®—ä»»åŠ¡","date":"2022-02-15T03:10:40.000Z","updated":"2022-02-17T01:14:41.637Z","comments":true,"path":"2022/02/15/å¤§æ•°æ®/åœ¨å…¬å¸ä»0åˆ°1è½åœ°flinkæµè®¡ç®—ä»»åŠ¡/","link":"","permalink":"http://blog.crazylaw.cn/2022/02/15/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E5%9C%A8%E5%85%AC%E5%8F%B8%E4%BB%8E0%E5%88%B01%E8%90%BD%E5%9C%B0flink%E6%B5%81%E8%AE%A1%E7%AE%97%E4%BB%BB%E5%8A%A1/","excerpt":"å‰è¨€åœ¨å…¬å¸è½åœ°ä¸€å¥—flinkï¼Œæ€»ç»“åˆ°ç›®å‰ä¸ºæ­¢åšäº†çš„äº‹æƒ…ã€‚","text":"å‰è¨€åœ¨å…¬å¸è½åœ°ä¸€å¥—flinkï¼Œæ€»ç»“åˆ°ç›®å‰ä¸ºæ­¢åšäº†çš„äº‹æƒ…ã€‚ å¼€å‘ç¯å¢ƒçš„éƒ¨ç½²æˆ‘ä»¬é»˜è®¤åœºæ™¯ä¸‹ï¼Œflinkä½¿ç”¨hive-catalogï¼Œæ‰€ä»¥hiveå®‰è£…åœ¨è¿™é‡Œã€‚ Hiveä½¿ç”¨mysqlä½œä¸ºå¤–éƒ¨æ•°æ®å­˜å‚¨ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨mysql å¯¹äºflinkçš„å¼€å‘ï¼Œå¦‚æœæˆ‘æƒ³è¦ä¸€æ•´å¥—çš„æœ¬åœ°çš„dockerå¼€å‘ç¯å¢ƒã€‚ éœ€è¦é›†æˆå¦‚ä¸‹æœåŠ¡ï¼š hadoop hive flink kafka mysql æ‰€ä»¥åšäº†ä¸€ä¸ªflink-docker-compose åœ¨è¯¥é¡¹ç›®ä¸­ï¼Œç”±äºä¸æ˜¯é‡‡ç”¨CDHæ¥é›†æˆçš„ï¼Œéƒ½æ˜¯ä¸€ä¸ªä¸ªæºç åŒ…æ‰‹åŠ¨å®‰è£…çš„ã€‚æ‰€ä»¥éœ€è¦ä¸‹è½½æºç åŒ…ã€‚ ç›®å‰çš„ç‰ˆæœ¬ä¸ºï¼š flink: 1.12.0_2.11 mysql: 5.6 ï¼ˆ8.0-jdbcï¼‰ kafka: 2.12_2.11 maven: 3.6.3 jdk: 8/11 (é»˜è®¤jdk8) æœ¬åœ°ç¯å¢ƒçš„è¯ï¼Œjdkéœ€è¦è‡ªè¡Œå¤„ç†å¥½ hadoop: 3.1.1 hive: 3.1.0 ä¸€é”®ä¸‹è½½æºç åŒ…ä¸ºäº†æ–¹ä¾¿æ–¹ä¾¿å¤§å®¶ä¸‹è½½ï¼Œå¯¹åº”çš„é•œåƒé“¾æ¥ï¼Œä¹Ÿéƒ½é›†æˆåœ¨äº†download.shä¸­ï¼Œå¦‚æœéœ€è¦åˆ©ç”¨è¿…é›·ç­‰p2påŠ é€Ÿä¸‹è½½è½¯ä»¶ï¼Œå¯ä»¥é€šè¿‡ä»ä¸­æå–å‡ºæ¥ url è¿›è¡Œä¸‹è½½ã€‚ 1./download.sh all å¯è®¾ç½®çš„.envåˆ©ç”¨docker-composeå¯¹ .envçš„æ”¯æŒï¼Œå¯ä»¥åœ¨å½“ä¸­è®¾ç½®build imageçš„ä¸€äº›ç¯å¢ƒå˜é‡å’Œå‚æ•° 12345678910111213141516171819# HadoopHADOOP_VERSION=3.1.1# HiveHIVE_VERSION=3.1.0# ScalaSCALA_VERSION=2.11# FlinkFLINK_VERSION=1.12.0# KafkaKAFKA_VERSION=2.4.0# ZookeeperZOOKEEPER_VERSION=3.5.6# MysqlMYSQL_VERSION=5.6MYSQL_DATABASE=defaultMYSQL_PORT=3306MYSQL_ROOT_PASSWORD=lnhzjm/B4qrScMYSQL_ENTRYPOINT_INITDB=./deploy/mysql/docker-entrypoint-initdb.dMYSQL_TIMEZONE=UTC kafkaçš„ç½‘ç»œæˆ‘ä»¬çŸ¥é“kafkaçš„ç½‘ç»œåè®®æ˜¯æ”¯æŒå¤šç«¯å£çš„ï¼Œç”±äºæˆ‘ä»¬æœ‰æ—¶å€™flinkæ˜¯åœ¨æœ¬åœ°ï¼Œæœ‰æ—¶å€™æ˜¯åœ¨å®¹å™¨ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„kafkaé›†ç¾¤ï¼Œæ”¯æŒå®¹å™¨å†…çš„ç½‘ç»œï¼Œä¹Ÿæ”¯æŒå’Œæˆ‘ä»¬ç‰©ç†æœºçš„ç½‘ç»œã€‚ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®kafkaçš„2å¥—ç«¯å£åè®®ã€‚æ‰€ä»¥ä½ å¯ä»¥çœ‹åˆ° 123456789101112131415161718192021222324252627kafka1: build: context: ./deploy/kafka args: scala_version: $&#123;SCALA_VERSION&#125; kafka_version: $&#123;KAFKA_VERSION&#125; container_name: flink-kafka1 ports: - '19092:19092' environment: KAFKA_PORT: 19092 KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://kafka1:19092 KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL_PLAINTEXT:PLAINTEXT KAFKA_LISTENERS: PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://:19092 KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 KAFKA_DEFAULT_REPLICATION_FACTOR: 3 networks: flink-networks: ipv4_address: 192.168.6.211 extra_hosts: - 'zookeeper:192.168.6.215' - 'kafka1:192.168.6.211' - 'kafka2:192.168.6.212' - 'kafka3:192.168.6.213' - 'kafka4:192.168.6.214' depends_on: - zookeeper çœ‹åˆ°è¿™é‡Œçš„ 123KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://kafka1:19092KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL_PLAINTEXT:PLAINTEXTKAFKA_LISTENERS: PLAINTEXT://:9092,EXTERNAL_PLAINTEXT://:19092 è¿™ä¸ªå°±æ˜¯å†³å®šæˆ‘ä»¬çš„2å¥—åè®®çš„å…³é”®æ‰€åœ¨ï¼Œåˆ†åˆ«æ˜¯å¯¹9092ï¼ˆå®¹å™¨å†…ï¼‰å’Œ19092(å’Œç‰©ç†æœº)ç«¯å£çš„æ”¯æŒã€‚ ä½†æ˜¯è®¾ç½®å®Œäº†è¿™ä¸ªï¼Œç”±äºä¸€èˆ¬kafka-clientä¼šä»å¯æœ¬æœºçš„å¯è®¿é—®çš„dnsæœåŠ¡å™¨ä¸Šå¯»æ‰¾hostæ˜ å°„ï¼Œåœ¨è¿æ¥çš„æ—¶å€™å¿…å¤‡çš„æµç¨‹ã€‚ åœ¨æœ¬åœ°è¿æ¥çš„æ—¶å€™ï¼Œä¼šé€šè¿‡kafka1/kafka2ç­‰hostnameè¿”å›åˆ°clientï¼Œclientéœ€è¦åœ¨æœ¬æœºæ‰¾åˆ°æ‰€æœ‰çš„ipæ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸‹etc/hosts 1echo \"127.0.0.1 kafka1 kafka2 kafka3 kafka4\" &gt;&gt; /etc/hosts ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ‰€éœ€è¦çš„ç¯å¢ƒå˜é‡å·²ç»å¤„ç†å®Œäº†ã€‚ åŸºäºdatastream-apiçš„flinkå¼€å‘æˆ‘ä»¬çŸ¥é“flinkæä¾›äº†3ç§APIï¼Œåˆ†åˆ«æ˜¯datastream-api,table-api,sql-api datastreamï¼Œä¹Ÿæ˜¯flinkçš„æœ€åŸå§‹çš„apiï¼Œå’Œflinké›†æˆä¸€ä½“ï¼Œé€šè¿‡datastream-apiï¼Œæˆ‘ä»¬å¯ä»¥å®ç°å„ç§çµæ´»çš„æ•°æ®æµå¤„ç†ã€‚ æŒ‰ç…§æˆ‘ä»¬ä»¥å¾€å¯¹æµè®¡ç®—æ•°æ®çš„å¤„ç†ï¼Œåœ¨æ¸¸æˆå…¬å¸ä¸­ï¼Œä¸€ä¸ªæ¸¸æˆé¡¹ç›®éƒ¨ç½²ä¸€ä¸ªæµè®¡ç®—çš„ä»»åŠ¡å³ä¸ºåˆç†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149.â”œâ”€â”€ README.mdâ”œâ”€â”€ pom.xmlâ””â”€â”€ src â””â”€â”€ main â”œâ”€â”€ java â”‚ â”œâ”€â”€ deps â”‚ â”‚ â”œâ”€â”€ oaYdSdk â”‚ â”‚ â”‚ â”œâ”€â”€ Youdu.java â”‚ â”‚ â”‚ â””â”€â”€ test â”‚ â”‚ â”‚ â””â”€â”€ YouduTest.java â”‚ â”‚ â””â”€â”€ util â”‚ â”‚ â”œâ”€â”€ ParameterToolEnvironmentUtils.java â”‚ â”‚ â””â”€â”€ Util.java â”‚ â””â”€â”€ org â”‚ â””â”€â”€ cp â”‚ â””â”€â”€ flink â”‚ â”œâ”€â”€ Bootstrap.java â”‚ â”œâ”€â”€ async â”‚ â”‚ â””â”€â”€ AsyncOaYdHttpClient.java â”‚ â”œâ”€â”€ events â”‚ â”‚ â”œâ”€â”€ CommonEvent.java â”‚ â”‚ â”œâ”€â”€ CommonEventHeader.java â”‚ â”‚ â”œâ”€â”€ app_error â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â”œâ”€â”€ log_ban â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â”œâ”€â”€ log_client_loss â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â”œâ”€â”€ log_consume_gold â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â”œâ”€â”€ log_fcm_error â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â”œâ”€â”€ log_index_record â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â”œâ”€â”€ log_index_record_data â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â”œâ”€â”€ log_role_create â”‚ â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”‚ â””â”€â”€ t_log_market â”‚ â”‚ â”œâ”€â”€ Event.java â”‚ â”‚ â”œâ”€â”€ EventHeader.java â”‚ â”‚ â””â”€â”€ EventLog.java â”‚ â”œâ”€â”€ jobs â”‚ â”‚ â”œâ”€â”€ alarm â”‚ â”‚ â”‚ â”œâ”€â”€ ErrorReport_10008.java â”‚ â”‚ â”‚ â”œâ”€â”€ Job_10002.java â”‚ â”‚ â”‚ â”œâ”€â”€ Job_10008.java â”‚ â”‚ â”‚ â”œâ”€â”€ Job_19.java â”‚ â”‚ â”‚ â”œâ”€â”€ README.md â”‚ â”‚ â”‚ â””â”€â”€ handler â”‚ â”‚ â”‚ â”œâ”€â”€ AbstractHandler.java â”‚ â”‚ â”‚ â”œâ”€â”€ errorReport_10008 â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ Logic.java â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ Logic_10012.java â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ Logic_19.java â”‚ â”‚ â”‚ â”‚ â””â”€â”€ Logic_20.java â”‚ â”‚ â”‚ â”œâ”€â”€ job_10002 â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ LogIndexRecordDataHandler.java â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ LogIndexRecordHandler.java â”‚ â”‚ â”‚ â”‚ â””â”€â”€ model â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ log_index_record â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€ StatisticsMcfx2Model.java â”‚ â”‚ â”‚ â”‚ â””â”€â”€ log_index_record_data â”‚ â”‚ â”‚ â”‚ â””â”€â”€ StatisticsMcfx1Model.java â”‚ â”‚ â”‚ â”œâ”€â”€ job_10008 â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ AppErrorHandler.java â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ LogFcmErrorHandler.java â”‚ â”‚ â”‚ â”‚ â””â”€â”€ model â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ app_error â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€ StatisticsAppErrorModel.java â”‚ â”‚ â”‚ â”‚ â””â”€â”€ log_fcm_error â”‚ â”‚ â”‚ â”‚ â””â”€â”€ StatisticsFcmErrorModel.java â”‚ â”‚ â”‚ â””â”€â”€ job_19 â”‚ â”‚ â”‚ â”œâ”€â”€ LogBanHandler.java â”‚ â”‚ â”‚ â”œâ”€â”€ LogClientLossHandler.java â”‚ â”‚ â”‚ â”œâ”€â”€ LogConsumeGoldHandler.java â”‚ â”‚ â”‚ â”œâ”€â”€ LogRoleCreateHandler.java â”‚ â”‚ â”‚ â”œâ”€â”€ TLogMarketHandler.java â”‚ â”‚ â”‚ â””â”€â”€ model â”‚ â”‚ â”‚ â”œâ”€â”€ log_ban â”‚ â”‚ â”‚ â”‚ â””â”€â”€ StatisticsModel.java â”‚ â”‚ â”‚ â”œâ”€â”€ log_client_loss â”‚ â”‚ â”‚ â”‚ â””â”€â”€ IpMonitorModel.java â”‚ â”‚ â”‚ â”œâ”€â”€ log_consume_gold â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€ StatisticsBindGoldModel.java â”‚ â”‚ â”‚ â”‚ â””â”€â”€ StatisticsUnBindGoldModel.java â”‚ â”‚ â”‚ â”œâ”€â”€ log_role_create â”‚ â”‚ â”‚ â”‚ â””â”€â”€ SingleServerRoleCreateModel.java â”‚ â”‚ â”‚ â””â”€â”€ t_log_market â”‚ â”‚ â”‚ â”œâ”€â”€ MarketTransactionLogByBuyerModel.java â”‚ â”‚ â”‚ â””â”€â”€ MarketTransactionLogBySellerModel.java â”‚ â”‚ â””â”€â”€ stream â”‚ â”‚ â””â”€â”€ README.md â”‚ â”œâ”€â”€ mock â”‚ â”‚ â”œâ”€â”€ MockAppError.java â”‚ â”‚ â”œâ”€â”€ MockLogFcmError.java â”‚ â”‚ â””â”€â”€ README.md â”‚ â”œâ”€â”€ serializer â”‚ â”‚ â”œâ”€â”€ AbstractSerializer.java â”‚ â”‚ â””â”€â”€ log_role_create â”‚ â”‚ â””â”€â”€ LogRoleCreateDeSerializer.java â”‚ â””â”€â”€ sinks â”‚ â”œâ”€â”€ AsyncOaYdSdkHttpSink.java â”‚ â”œâ”€â”€ MysqlItem.java â”‚ â””â”€â”€ MysqlSink.java â””â”€â”€ resources â”œâ”€â”€ application-dev.properties â”œâ”€â”€ application-local.properties â”œâ”€â”€ application-pro.properties â”œâ”€â”€ application.properties â”œâ”€â”€ jobs â”‚ â”œâ”€â”€ org.cp.flink.jobs.alarm.ErrorReport_10008 â”‚ â”‚ â”œâ”€â”€ application-dev.properties â”‚ â”‚ â”œâ”€â”€ application-local.properties â”‚ â”‚ â”œâ”€â”€ application-pro.properties â”‚ â”‚ â””â”€â”€ application.properties â”‚ â”œâ”€â”€ org.cp.flink.jobs.alarm.Job_10002 â”‚ â”‚ â”œâ”€â”€ application-dev.properties â”‚ â”‚ â”œâ”€â”€ application-local.properties â”‚ â”‚ â”œâ”€â”€ application-pro.properties â”‚ â”‚ â””â”€â”€ application.properties â”‚ â”œâ”€â”€ org.cp.flink.jobs.alarm.Job_10008 â”‚ â”‚ â”œâ”€â”€ application-dev.properties â”‚ â”‚ â”œâ”€â”€ application-local.properties â”‚ â”‚ â”œâ”€â”€ application-pro.properties â”‚ â”‚ â””â”€â”€ application.properties â”‚ â””â”€â”€ org.cp.flink.jobs.alarm.Job_19 â”‚ â”œâ”€â”€ application-dev.properties â”‚ â”œâ”€â”€ application-local.properties â”‚ â”œâ”€â”€ application-pro.properties â”‚ â””â”€â”€ application.properties â””â”€â”€ log4j2.properties è¿™æ˜¯æˆ‘ä»¬æ—©æœŸçš„ä¸€ä¸ªä»£ç å±‚çº§ç»“æ„ï¼Œæ‰€æœ‰çš„æµè®¡ç®—ä»»åŠ¡åŸºäºä¸€ä¸ªflinké¡¹ç›®ä¸‹ï¼Œresourcesä¸‹çš„é…ç½®æ ¹æ®å½“å‰éœ€è¦æäº¤çš„é¡¹ç›®å’Œç¯å¢ƒæ¥è¿›è¡ŒåŒºåˆ†åŠ è½½å…·ä½“çš„é…ç½®ï¼Œå¯ä»¥åšåˆ°æ”¯æŒå¤šç¯å¢ƒ,å¤šé¡¹ç›®ä¸‹é…ç½®çµæ´»é…ç½®ã€‚ æˆ‘ä»¬çœ‹åˆ° org.cp.flinkç›®ä¸‹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„æ‰€æœ‰flinkä»£ç ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738âœ flinkjob git:(master) âœ— tree -d src/main/java/orgsrc/main/java/orgâ””â”€â”€ cp â””â”€â”€ flink â”œâ”€â”€ async â”œâ”€â”€ events â”‚ â”œâ”€â”€ app_error â”‚ â”œâ”€â”€ log_ban â”‚ â”œâ”€â”€ log_client_loss â”‚ â”œâ”€â”€ log_consume_gold â”‚ â”œâ”€â”€ log_fcm_error â”‚ â”œâ”€â”€ log_index_record â”‚ â”œâ”€â”€ log_index_record_data â”‚ â”œâ”€â”€ log_role_create â”‚ â””â”€â”€ t_log_market â”œâ”€â”€ jobs â”‚ â”œâ”€â”€ alarm â”‚ â”‚ â””â”€â”€ handler â”‚ â”‚ â”œâ”€â”€ job_10002 â”‚ â”‚ â”‚ â””â”€â”€ model â”‚ â”‚ â”‚ â”œâ”€â”€ log_index_record â”‚ â”‚ â”‚ â””â”€â”€ log_index_record_data â”‚ â”‚ â”œâ”€â”€ job_10008 â”‚ â”‚ â”‚ â””â”€â”€ model â”‚ â”‚ â”‚ â”œâ”€â”€ app_error â”‚ â”‚ â”‚ â””â”€â”€ log_fcm_error â”‚ â”‚ â””â”€â”€ job_19 â”‚ â”‚ â””â”€â”€ model â”‚ â”‚ â”œâ”€â”€ log_ban â”‚ â”‚ â”œâ”€â”€ log_client_loss â”‚ â”‚ â”œâ”€â”€ log_consume_gold â”‚ â”‚ â”œâ”€â”€ log_role_create â”‚ â”‚ â””â”€â”€ t_log_market â”‚ â””â”€â”€ stream â”œâ”€â”€ mock â”œâ”€â”€ serializer â”‚ â””â”€â”€ log_role_create â””â”€â”€ sinks æˆ‘ä»¬å…ˆçœ‹åˆ°ï¼Œjobsç›®å½•ä¸‹çš„ï¼Œåˆ†ä¸ºäº†2ç§ç±»å‹ï¼Œæˆ‘ä»¬å¹³æ—¶ç”¨çš„æµè®¡ç®—ä»»åŠ¡å¯ä»¥åˆ†ä¸º2ç§ï¼Œä¸€ç§æ˜¯å¸¸è§„çš„å‘Šè­¦å±æ€§ï¼Œå¦ä¸€ç§æ˜¯äº§å“å±æ€§(ç±»ä¼¼BIç³»ç»Ÿéœ€è¦çš„å®æ—¶æ•°æ®)ã€‚ æˆ‘ä»¬çœ‹åˆ°alarm/handler/job_xxxå°±æ˜¯æˆ‘ä»¬å…·ä½“çš„é¡¹ç›®ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647src/main/java/org/cp/flink/jobs/alarm/â”œâ”€â”€ Job_10002.javaâ”œâ”€â”€ Job_10008.javaâ”œâ”€â”€ Job_19.javaâ”œâ”€â”€ README.mdâ””â”€â”€ handler â”œâ”€â”€ AbstractHandler.java â”œâ”€â”€ errorReport_10008 â”‚ â”œâ”€â”€ Logic.java â”‚ â”œâ”€â”€ Logic_10012.java â”‚ â”œâ”€â”€ Logic_19.java â”‚ â””â”€â”€ Logic_20.java â”œâ”€â”€ job_10002 â”‚ â”œâ”€â”€ LogIndexRecordDataHandler.java â”‚ â”œâ”€â”€ LogIndexRecordHandler.java â”‚ â””â”€â”€ model â”‚ â”œâ”€â”€ log_index_record â”‚ â”‚ â””â”€â”€ StatisticsMcfx2Model.java â”‚ â””â”€â”€ log_index_record_data â”‚ â””â”€â”€ StatisticsMcfx1Model.java â”œâ”€â”€ job_10008 â”‚ â”œâ”€â”€ AppErrorHandler.java â”‚ â”œâ”€â”€ LogFcmErrorHandler.java â”‚ â””â”€â”€ model â”‚ â”œâ”€â”€ app_error â”‚ â”‚ â””â”€â”€ StatisticsAppErrorModel.java â”‚ â””â”€â”€ log_fcm_error â”‚ â””â”€â”€ StatisticsFcmErrorModel.java â””â”€â”€ job_19 â”œâ”€â”€ LogBanHandler.java â”œâ”€â”€ LogClientLossHandler.java â”œâ”€â”€ LogConsumeGoldHandler.java â”œâ”€â”€ LogRoleCreateHandler.java â”œâ”€â”€ TLogMarketHandler.java â””â”€â”€ model â”œâ”€â”€ log_ban â”‚ â””â”€â”€ StatisticsModel.java â”œâ”€â”€ log_client_loss â”‚ â””â”€â”€ IpMonitorModel.java â”œâ”€â”€ log_consume_gold â”‚ â”œâ”€â”€ StatisticsBindGoldModel.java â”‚ â””â”€â”€ StatisticsUnBindGoldModel.java â”œâ”€â”€ log_role_create â”‚ â””â”€â”€ SingleServerRoleCreateModel.java â””â”€â”€ t_log_market â”œâ”€â”€ MarketTransactionLogByBuyerModel.java â””â”€â”€ MarketTransactionLogBySellerModel.java å¯¹äºå„ä¸ªé¡¹ç›®çš„é”™è¯¯å‘Šè­¦ç›‘æ§ï¼Œè¿™é‡Œåˆ†ä¸ºäº†å¤šä¸ªjobã€‚ Job_10002.java Job_10008.java Job_19.java æˆ‘ä»¬ä»å…¥å£å¼€å§‹çœ‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101package org.cp.flink.jobs.alarm;import com.alibaba.fastjson.JSONObject;import deps.util.Util;import org.apache.flink.api.common.serialization.SimpleStringSchema;import org.apache.flink.api.java.utils.ParameterTool;import org.apache.flink.streaming.api.datastream.DataStream;import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;import org.apache.flink.streaming.api.functions.ProcessFunction;import org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;import org.apache.flink.util.Collector;import org.apache.flink.util.OutputTag;import org.cp.flink.Bootstrap;import org.cp.flink.jobs.alarm.handler.job_10008.AppErrorHandler;import org.cp.flink.jobs.alarm.handler.job_10008.LogFcmErrorHandler;import org.cp.flink.events.CommonEvent;import org.cp.flink.events.app_error.Event;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import java.util.Arrays;import java.util.Properties;public class Job_10008 extends Bootstrap &#123; private static final Logger logger = LoggerFactory.getLogger(Job_10008.class); public static void main(String[] args) throws Exception &#123; final StreamExecutionEnvironment env = getStreamExecutionEnvironment(args, Job_10008.class); env.enableCheckpointing(5000); // checkpoint every 5000 msecs ParameterTool parameterTool = (ParameterTool) env.getConfig().getGlobalJobParameters(); Properties props = new Properties(); props.setProperty(\"bootstrap.servers\", parameterTool.get(\"kafka.source.bootstrap.servers\")); props.setProperty(\"group.id\", parameterTool.get(\"kafka.source.group\")); props.put(\"enable.auto.commit\", parameterTool.get(\"kafka.source.enable.auto.commit\")); props.put(\"auto.commit.interval.ms\", parameterTool.get(\"kafka.source.auto.commit.interval.ms\")); props.put(\"session.timeout.ms\", parameterTool.get(\"kafka.source.session.timeout.ms\")); props.put(\"key.deserializer\", \"org.apache.kafka.common.serialization.StringDeserializer\"); props.put(\"value.deserializer\", \"org.apache.kafka.common.serialization.StringDeserializer\"); // è®¾ç½®kafkaå¹¶è¡Œåº¦ env.setParallelism(parameterTool.getInt(\"kafka.source.parallelism\", 1)); DataStream&lt;String&gt; stream = env .addSource(new FlinkKafkaConsumer&lt;&gt;(Arrays.asList(parameterTool.get(\"kafka.source.topic\").split(\",\")), new SimpleStringSchema(), props)); env.setParallelism(parameterTool.getInt(\"app.parallelism\", 1)); SingleOutputStreamOperator&lt;CommonEvent&gt; s0 = stream.filter((String json) -&gt; &#123; try &#123; JSONObject.parseObject(json, CommonEvent.class); return true; &#125; catch (Exception e) &#123; e.printStackTrace(); logger.error(json); &#125; return false; &#125;).map( (String json) -&gt; JSONObject.parseObject(json, CommonEvent.class).setOriginJson(json) ).returns(CommonEvent.class); final OutputTag&lt;CommonEvent&gt; outputTagAppError = new OutputTag&lt;CommonEvent&gt;(AppErrorHandler.class.getName()) &#123; &#125;; final OutputTag&lt;CommonEvent&gt; outputTagLogFcmError = new OutputTag&lt;CommonEvent&gt;(LogFcmErrorHandler.class.getName()) &#123; &#125;; // 1. ä¸»æµä¸éœ€è¦äº†, æ‰€ä»¥ä¸éœ€è¦è°ƒç”¨collector.collect() // 2. åªè¦æ—è·¯è¾“å‡ºæµï¼Œå› ä¸ºè¦åŒºåˆ†æ•°æ®è¿›è¡Œå¤„ç† // åˆ©ç”¨low-level-apiçš„processç®—å­å¤„ç†æ—è·¯è¾“å‡ºé‡‡é›†æ•°æ® SingleOutputStreamOperator&lt;CommonEvent&gt; s1 = s0.process(new ProcessFunction&lt;CommonEvent, CommonEvent&gt;() &#123; @Override public void processElement(CommonEvent event, Context context, Collector&lt;CommonEvent&gt; collector) &#123; switch (event.getHeaders().getLogName()) &#123; case \"app_error\": context.output(outputTagAppError, event); break; case \"log_fcm_error\": context.output(outputTagLogFcmError, event); break; &#125; &#125; &#125;); DataStream&lt;CommonEvent&gt; AppErrorSource = s1.getSideOutput(outputTagAppError); DataStream&lt;CommonEvent&gt; LogFcmErrorSource = s1.getSideOutput(outputTagLogFcmError); DataStream&lt;Event&gt; AppErrorSource_s0 = AppErrorSource.map((CommonEvent event) -&gt; JSONObject.parseObject(event.getOriginJson(), Event.class) ).returns(Event.class); DataStream&lt;org.cp.flink.events.log_fcm_error.Event&gt; LogFcmErrorSource_s0 = LogFcmErrorSource.map((CommonEvent event) -&gt; JSONObject.parseObject(event.getOriginJson(), org.cp.flink.events.log_fcm_error.Event.class) ).returns(org.cp.flink.events.log_fcm_error.Event.class); AppErrorHandler.build().handle(AppErrorSource_s0); LogFcmErrorHandler.build().handle(LogFcmErrorSource_s0); env.execute(Util.getCurrentJobName(((ParameterTool) env.getConfig().getGlobalJobParameters()))); &#125;&#125; ç”±äºæˆ‘ä»¬ä¸€ä¸ªtopicåªèƒ½å¤Ÿå¯èƒ½å­˜åœ¨å¤šç§æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œåˆ©ç”¨äº†æ—è·¯ç”±è¿›è¡Œäº†åˆ†æµã€‚æŠŠæ•°æ®æµåˆ†å‘åˆ°ä¸åŒçš„å­æµä¸­ï¼Œæˆ‘ä»¬å†æŠŠå­æµä¼ é€’ä¸åŒçš„Handlerè¿›è¡Œå¤„ç†ã€‚ è¿™é‡Œä¾‹å¦‚: AppErrorHandlerã€‚æˆ‘ä»¬ä»¥æ­¤ä¸ºä¾‹å­è¿›è¡Œè¯´æ˜ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package org.cp.flink.jobs.alarm.handler.job_10008;import lombok.NoArgsConstructor;import org.apache.flink.api.java.utils.ParameterTool;import org.apache.flink.streaming.api.datastream.DataStream;import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;import org.apache.flink.streaming.api.functions.ProcessFunction;import org.apache.flink.util.Collector;import org.apache.flink.util.OutputTag;import org.cp.flink.jobs.alarm.handler.AbstractHandler;import org.cp.flink.jobs.alarm.handler.job_10008.model.app_error.StatisticsAppErrorModel;import org.cp.flink.events.app_error.Event;@NoArgsConstructorpublic class AppErrorHandler extends AbstractHandler&lt;Event&gt; &#123; private static AppErrorHandler instance; public static AppErrorHandler build() &#123; if (instance == null) &#123; instance = new AppErrorHandler(); &#125; return instance; &#125; @Override public void handle(DataStream&lt;Event&gt; s0) &#123; ParameterTool parameterTool = this.getParameterTool(s0); // åˆ©ç”¨æ—è·¯è¾“å‡ºå¤šæµåˆ°å¯¹åº”åˆ°model // StatisticsAppErrorModel final OutputTag&lt;Event&gt; outputTagStatisticsAppError = new OutputTag&lt;Event&gt;(StatisticsAppErrorModel.class.getName()) &#123; &#125;; SingleOutputStreamOperator&lt;Event&gt; s1 = s0.process(new ProcessFunction&lt;Event, Event&gt;() &#123; @Override public void processElement(Event event, Context context, Collector&lt;Event&gt; collector) &#123; context.output(outputTagStatisticsAppError, event); &#125; &#125;); DataStream&lt;Event&gt; sideOutputStreamAppError = s1.getSideOutput(outputTagStatisticsAppError); StatisticsAppErrorModel.build().handle(sideOutputStreamAppError); if (parameterTool.getBoolean(\"app.handler.print.console\", false)) &#123; s0.print(AppErrorHandler.class.getName()); &#125; &#125;&#125; ç”±äºï¼Œæˆ‘ä»¬å¸Œæœ›åˆ°ä¸€æ¡æ•°æ®ä»kafkaè¢«pullä¸‹æ¥åˆ°æ—¶å€™ï¼Œå¯ä»¥ç”¨äºå¤šä¸ªä¸åŒçš„æµè®¡ç®—æ¨¡å‹modelï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦copyåˆ°å¤šä¸ªæ—è·¯è¾“å‡ºï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªstream-modelï¼Œæ‰€ä»¥æˆ‘ä»¬å°±åªç”¨ä¸€ä¸ªæ¥å¤„ç†å³å¯ï¼Œä»æ—è·¯è¾“å‡ºæ‹¿åˆ°datastreamä¹‹åï¼Œåœ¨å¯¹åº”çš„æ¨¡å‹ä¸­è¿›è¡Œæ ¸å¿ƒé€»è¾‘å¤„ç†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144package org.cp.flink.jobs.alarm.handler.job_10008.model.app_error;import deps.util.Util;import lombok.NoArgsConstructor;import org.apache.flink.api.java.functions.KeySelector;import org.apache.flink.api.java.tuple.Tuple3;import org.apache.flink.api.java.tuple.Tuple5;import org.apache.flink.api.java.utils.ParameterTool;import org.apache.flink.streaming.api.datastream.DataStream;import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;import org.apache.flink.streaming.api.datastream.WindowedStream;import org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor;import org.apache.flink.streaming.api.functions.windowing.WindowFunction;import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows;import org.apache.flink.streaming.api.windowing.time.Time;import org.apache.flink.streaming.api.windowing.windows.TimeWindow;import org.apache.flink.streaming.runtime.operators.util.AssignerWithPeriodicWatermarksAdapter;import org.apache.flink.util.Collector;import org.cp.flink.jobs.alarm.handler.AbstractHandler;import org.cp.flink.events.app_error.Event;import org.cp.flink.jobs.alarm.handler.job_19.model.log_ban.StatisticsModel;import org.cp.flink.sinks.MysqlItem;import org.cp.flink.sinks.MysqlSink;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import java.time.Duration;import java.util.HashMap;import java.util.concurrent.TimeUnit;/*/** * é”™è¯¯æ—¥å¿—ç»Ÿè®¡ * çª—å£ï¼šæ»šåŠ¨äº‹ä»¶çª—å£ï¼Œæ¯1åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ */@NoArgsConstructorpublic class StatisticsAppErrorModel extends AbstractHandler&lt;Event&gt; &#123; private static final String DEFAULT_SINK_DATABASE = \"db_app_log_alarm\"; private static final String DEFAULT_SINK_TABLE = \"t_log_app_error_alarm_164\"; private static final Logger logger = LoggerFactory.getLogger(StatisticsAppErrorModel.class); private static StatisticsAppErrorModel instance; public static StatisticsAppErrorModel build() &#123; if (instance == null) &#123; instance = new StatisticsAppErrorModel(); &#125; return instance; &#125; @Override public void handle(DataStream&lt;Event&gt; s0) &#123; s0.getExecutionConfig().setAutoWatermarkInterval(5000L); logger.debug(\"getAutoWatermarkInterval: &#123;&#125;\", s0.getExecutionConfig().getAutoWatermarkInterval()); ParameterTool parameterTool = this.getParameterTool(s0); SingleOutputStreamOperator&lt;Event&gt; s1 = s0.assignTimestampsAndWatermarks(new AssignerWithPeriodicWatermarksAdapter.Strategy&lt;&gt;( new BoundedOutOfOrdernessTimestampExtractor&lt;Event&gt;(Time.of(1, TimeUnit.SECONDS)) &#123; @Override public long extractTimestamp(Event event) &#123; Long ts = event.getLogs().getMtime() * 1000L; logger.debug( \"thread-id: &#123;&#125;, eventTime: [&#123;&#125;|&#123;&#125;], watermark: [&#123;&#125;|&#123;&#125;]\", Thread.currentThread().getId(), ts, sdf.format(ts), this.getCurrentWatermark().getTimestamp(), sdf.format(this.getCurrentWatermark().getTimestamp()) ); return ts; &#125; &#125; ) // å°½å¯èƒ½å’Œçª—å£å¤§å°ä¿æŒä¸€è‡´ï¼Œæ‰€ä»¥å¦‚æœå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œåº¦å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹ // æœ€å¤§çš„å»¶è¿Ÿè®¡ç®—ç»“æœæ˜¯ä¸€ä¸ªçª—å£å¤§å°çš„æ—¶é—´ .withIdleness(Duration.ofMinutes(1L)) ); WindowedStream&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt; s2 = s1.keyBy(new KeySelector&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;&gt;() &#123; @Override public Tuple5&lt;Integer, String, String, Integer, String&gt; getKey(Event event) &#123; return Tuple5.of( event.getLogs().getRelatedAppId(), event.getLogs().getChildApp(), event.getLogs().getSummary(), event.getLogs().getLevel(), event.getLogs().getIp() ); &#125; &#125;) .window(TumblingEventTimeWindows.of(Time.minutes(1L))); SingleOutputStreamOperator&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; s3 = s2.apply(new WindowFunction&lt;Event, Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt;() &#123; public void apply(Tuple5&lt;Integer, String, String, Integer, String&gt; key, TimeWindow timeWindow, Iterable&lt;Event&gt; iterable, Collector&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; collector) throws Exception &#123; int sum = 0; for (Event event : iterable) &#123; sum++; &#125; logger.debug(\"èšåˆçª—å£key: &#123;&#125;, çª—å£ä¸­çš„æ•°é‡:&#123;&#125;, æ­¤æ—¶çš„çª—å£èŒƒå›´æ˜¯[&#123;&#125;,&#123;&#125;)\", key, sum, sdf.format(timeWindow.getStart()), sdf.format(timeWindow.getEnd())); collector.collect(Tuple3.of(key, iterable.iterator().next(), sum)); &#125; &#125;); String sinkDatabase = parameterTool.get(StatisticsModel.class.getName() + \".sink_database\", DEFAULT_SINK_DATABASE); String sinkTable = parameterTool.get(StatisticsModel.class.getName() + \".sink_table\", DEFAULT_SINK_TABLE); SingleOutputStreamOperator&lt;MysqlItem&gt; s4 = s3.map(e -&gt; &#123; HashMap&lt;String, Object&gt; kv = new HashMap&lt;&gt;(); kv.put(\"related_app_id\", e.f1.getLogs().getRelatedAppId()); kv.put(\"child_app\", e.f1.getLogs().getChildApp()); kv.put(\"summary\", e.f1.getLogs().getSummary()); kv.put(\"level\", e.f1.getLogs().getLevel()); kv.put(\"ip\", e.f1.getLogs().getIp()); kv.put(\"mtime\", e.f1.getLogs().getMtime()); kv.put(\"mdate\", Util.timeStamp2Date(Integer.toString(e.f1.getLogs().getMtime()), \"yyyy-MM-dd\")); // æ¥è‡ªèšåˆçª—å£ç»Ÿè®¡çš„ç»“æœ kv.put(\"cnt\", e.f2); return MysqlItem.builder() .database(sinkDatabase) .table(sinkTable) .kv(kv) .build(); &#125; ).returns(MysqlItem.class); s4.addSink(new MysqlSink(parameterTool)) .setParallelism(parameterTool.getInt(\"mysql.sink.parallelism\", 1)) .name(\"MysqlSink\"); if (parameterTool.getBoolean(\"app.handler.print.console\", false)) &#123; s0.print(StatisticsAppErrorModel.class.getName()); &#125; &#125;&#125; ä»ä¸Šé¢çš„æ•´ä½“ä¸­ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆçœ‹åˆ°è®¾ç½®watermarkçš„é€»è¾‘ï¼Œè¿™ä¸ªwatermarkå†³å®šäº†æˆ‘ä»¬çš„flinkçš„æ•°æ®çš„æœ‰åºæ€§ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å¤„ç†ã€‚ 123456789101112131415161718192021222324252627282930// æ¯5s-flinkéœ€è¦è·å–æ–°çš„watermarks0.getExecutionConfig().setAutoWatermarkInterval(5000L);logger.debug(\"getAutoWatermarkInterval: &#123;&#125;\", s0.getExecutionConfig().getAutoWatermarkInterval());ParameterTool parameterTool = this.getParameterTool(s0);SingleOutputStreamOperator&lt;Event&gt; s1 = s0.assignTimestampsAndWatermarks(new AssignerWithPeriodicWatermarksAdapter.Strategy&lt;&gt;( new BoundedOutOfOrdernessTimestampExtractor&lt;Event&gt;(Time.of(1, TimeUnit.SECONDS)) &#123; @Override public long extractTimestamp(Event event) &#123; Long ts = event.getLogs().getMtime() * 1000L; logger.debug( \"thread-id: &#123;&#125;, eventTime: [&#123;&#125;|&#123;&#125;], watermark: [&#123;&#125;|&#123;&#125;]\", Thread.currentThread().getId(), ts, sdf.format(ts), this.getCurrentWatermark().getTimestamp(), sdf.format(this.getCurrentWatermark().getTimestamp()) ); return ts; &#125; &#125; ) // å°½å¯èƒ½å’Œçª—å£å¤§å°ä¿æŒä¸€è‡´ï¼Œæ‰€ä»¥å¦‚æœå…¶ä¸­ä¸€ä¸ªå¹¶è¡Œåº¦å‡ºç°é—®é¢˜çš„æƒ…å†µä¸‹ // æœ€å¤§çš„å»¶è¿Ÿè®¡ç®—ç»“æœæ˜¯ä¸€ä¸ªçª—å£å¤§å°çš„æ—¶é—´ .withIdleness(Duration.ofMinutes(1L))); æˆ‘ä»¬è¿™é‡Œé€šè¿‡AssignerWithPeriodicWatermarksAdapterè®¾ç½®ä¸€ä¸ªwatermarkç”Ÿæˆçš„ç­–ç•¥ã€‚ å½“æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œå…è®¸1ç§’å»¶è¿Ÿçš„æƒ…å†µä¸‹ï¼Œè§£ææ•°æ®çš„äº‹ä»¶æ—¶é—´(event-time)ä½œä¸ºæˆ‘ä»¬çš„watermarkï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä»event-timeæå–çš„æ—¶é—´çš„å•ä½éœ€è¦æ˜¯æ¯«ç§’çº§åˆ«ã€‚ å†é€šè¿‡.withIdlenessï¼Œè¿›è¡Œå½“æŸä¸ªçª—å£ä¸‹idleäº†ï¼Œé‚£ä¹ˆä¹Ÿä¼šåˆ·æ–°watermarkã€‚è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œåœ¨kafkaä¸­æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„é€»è¾‘ï¼Œç”±äºflinkåœ¨kafkaçš„topicåœ¨å¤špartitionä¸‹ï¼Œåœ¨partitionçš„æ•°æ®watermarkå¯¹é½çš„æƒ…å†µï¼Œæ‰ä¼šè¿›è¡Œï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢ï¼Œç”±äºé˜²æ­¢kafkaçš„partitionçš„æ•°æ®å€¾æ–œå¯¹æˆ‘ä»¬é€ æˆä¸šåŠ¡é€»è¾‘ä¸€ç›´æ— æ³•æ›´æ–°watermarkçš„é—®é¢˜ã€‚è¿™ä¸ªååˆ†å¿…è¦ã€‚ 12345678910111213WindowedStream&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt; s2 = s1.keyBy(new KeySelector&lt;Event, Tuple5&lt;Integer, String, String, Integer, String&gt;&gt;() &#123; @Override public Tuple5&lt;Integer, String, String, Integer, String&gt; getKey(Event event) &#123; return Tuple5.of( event.getLogs().getRelatedAppId(), event.getLogs().getChildApp(), event.getLogs().getSummary(), event.getLogs().getLevel(), event.getLogs().getIp() ); &#125;&#125;) .window(TumblingEventTimeWindows.of(Time.minutes(1L))); å¯¹äºwindowstreamï¼Œä¸»è¦æ˜¯å®šä¹‰çª—å£çš„æ—¶é—´å¤§å°ï¼Œ çª—å£æ•°æ®çš„å”¯ä¸€ä¸»é”®ã€‚ åœ¨è¿™é‡Œï¼Œç”±äºæˆ‘çš„éœ€æ±‚æ˜¯æ¯1åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘çš„çª—å£æ˜¯åŸºäºEventTimeï¼ˆäº‹ä»¶æ—¶é—´ï¼‰çš„çª—å£ï¼Œå¹¶ä¸”å¤§å°èŒƒå›´ä¸º1åˆ†é’Ÿã€‚è€Œæ•°æ®çš„å”¯ä¸€ä¸»é”®åˆ™æ˜¯é€šè¿‡getKet(Event event)æ–¹æ³•æ¥å¤„ç†ã€‚é€šè¿‡flinkå†…ç½®çš„ä¾¿æ·çš„Tuple5è¿™ä¸ªç±»æ¥å¤„ç†çš„åŸå› æ˜¯å› ä¸ºæˆ‘è¿™é‡Œæœ‰5ä¸ªå…ƒç´ ç»„æˆçš„keyã€‚ 1234567891011SingleOutputStreamOperator&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; s3 = s2.apply(new WindowFunction&lt;Event, Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;, Tuple5&lt;Integer, String, String, Integer, String&gt;, TimeWindow&gt;() &#123; public void apply(Tuple5&lt;Integer, String, String, Integer, String&gt; key, TimeWindow timeWindow, Iterable&lt;Event&gt; iterable, Collector&lt;Tuple3&lt;Tuple5&lt;Integer, String, String, Integer, String&gt;, Event, Integer&gt;&gt; collector) throws Exception &#123; int sum = 0; for (Event event : iterable) &#123; sum++; &#125; logger.debug(\"èšåˆçª—å£key: &#123;&#125;, çª—å£ä¸­çš„æ•°é‡:&#123;&#125;, æ­¤æ—¶çš„çª—å£èŒƒå›´æ˜¯[&#123;&#125;,&#123;&#125;)\", key, sum, sdf.format(timeWindow.getStart()), sdf.format(timeWindow.getEnd())); collector.collect(Tuple3.of(key, iterable.iterator().next(), sum)); &#125; &#125;); æ¥ä¸‹æ¥å°±æ˜¯èšåˆ(ç»Ÿè®¡)çš„é€»è¾‘äº†ï¼Œå½“window-trigger-conditionæ»¡è¶³æ¡ä»¶ä¹‹åï¼Œå°±ä¼šæŠŠå½“å‰çª—å£å†…çš„æ‰€æœ‰æ•°æ®æ¨åˆ°ä¸‹ä¸€ä¸ªç®—å­ï¼Œåœ¨è¿™ä¸ªç®—å­çš„apply()ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªæ˜¯ç®€å•çš„åšäº†ä¸€ä¸ªæ•°æ®ç»Ÿè®¡ï¼Œä¹Ÿå°±æ˜¯sum++ï¼Œç»è¿‡è¿™ä¸€æ“ä½œä¹‹åï¼Œç»è¿‡collectorå¯¹è¿›è¡Œè¿›è¡Œæ”¶é›†ï¼Œå‡†å¤‡ç”¨äºä¸‹ä¸€ä¸ªç®—å­ä¸­ã€‚ 12345678910111213141516171819202122232425SingleOutputStreamOperator&lt;MysqlItem&gt; s4 = s3.map(e -&gt; &#123; HashMap&lt;String, Object&gt; kv = new HashMap&lt;&gt;(); kv.put(\"related_app_id\", e.f1.getLogs().getRelatedAppId()); kv.put(\"child_app\", e.f1.getLogs().getChildApp()); kv.put(\"summary\", e.f1.getLogs().getSummary()); kv.put(\"level\", e.f1.getLogs().getLevel()); kv.put(\"ip\", e.f1.getLogs().getIp()); kv.put(\"mtime\", e.f1.getLogs().getMtime()); kv.put(\"mdate\", Util.timeStamp2Date(Integer.toString(e.f1.getLogs().getMtime()), \"yyyy-MM-dd\")); // æ¥è‡ªèšåˆçª—å£ç»Ÿè®¡çš„ç»“æœ kv.put(\"cnt\", e.f2); return MysqlItem.builder() .database(sinkDatabase) .table(sinkTable) .kv(kv) .build(); &#125; ).returns(MysqlItem.class);s4.addSink(new MysqlSink(parameterTool)) .setParallelism(parameterTool.getInt(\"mysql.sink.parallelism\", 1)) .name(\"MysqlSink\"); åœ¨è¿™ä¸ªå‰é¢åˆ°ç®—å­ä¸­ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†ä¸€äº›æˆ‘ä»¬æ‰€æœŸå¾…åˆ°æ•°æ®äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠæ•°æ®è½¬æ¢æˆä¸ºæˆ‘ä»¬éœ€è¦å…¥åº“çš„ä¸€ä¸ªç»“æ„ã€‚é€šè¿‡MysqlItemå¯¹è±¡ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„ç»“æ„åŒ–çš„å¯¹è±¡é€šè¿‡MysqlSinkæ–¹æ³•è¿›è¡Œå‘é€ç»™mysqlã€‚mysqlsinkæ˜¯æˆ‘ä»¬è‡ªå·±å°çš„ä¸€ä¸ªsinkerï¼Œå…¶ä¸­çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081package org.cp.flink.sinks;import lombok.Setter;import lombok.experimental.Accessors;import org.apache.flink.api.java.utils.ParameterTool;import org.apache.flink.configuration.Configuration;import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import java.nio.charset.StandardCharsets;import java.sql.Connection;import java.sql.DriverManager;import java.sql.PreparedStatement;import java.sql.SQLException;@Setter@Accessors(chain = true)public class MysqlSink extends RichSinkFunction&lt;MysqlItem&gt; &#123; private static final Logger logger = LoggerFactory.getLogger(MysqlSink.class); ParameterTool parameterTool; private Connection connection; public MysqlSink(ParameterTool parameterTool) &#123; this.parameterTool = parameterTool; &#125; @Override public void open(Configuration parameters) throws Exception &#123; super.open(parameters); if (connection == null) &#123; connection = this.getConnection(); &#125; &#125; @Override public void close() throws Exception &#123; super.close(); if (connection != null) &#123; connection.close(); &#125; &#125; /** * todo: å†è€ƒè™‘ä¸€ä¸‹å¦‚æœæ’å…¥å¤±è´¥çš„è¯æ˜¯å¦éœ€è¦é‡è¯•ä¹‹ç±»çš„ * * @param item * @param context */ public void invoke(MysqlItem item, Context context) &#123; logger.debug(\"mysql-item: &#123;&#125;\", item); MysqlItem.Sql sqlInfo = item.toInsertIgnoreSql(); String sql = sqlInfo.getPreSql(); try &#123; PreparedStatement ps = this.connection.prepareStatement(sql); for (int i = 1; i &lt;= sqlInfo.getValues().size(); i++) &#123; ps.setObject(i, sqlInfo.getValues().get(i-1)); &#125; logger.debug(ps.toString()); ps.execute(); &#125; catch (Exception e) &#123; e.printStackTrace(); logger.error(e.getMessage()); &#125; &#125; private Connection getConnection() throws ClassNotFoundException, SQLException &#123; Class.forName(\"com.mysql.cj.jdbc.Driver\"); return DriverManager.getConnection( String.format( \"jdbc:mysql://%s:%s/?useUnicode=true&amp;characterEncoding=%s&amp;useSSL=false&amp;autoReconnect=true\", this.parameterTool.get(\"mysql.sink.host\"), this.parameterTool.get(\"mysql.sink.port\"), this.parameterTool.get(\"mysql.sink.characterEncoding\", StandardCharsets.UTF_8.toString()) ), this.parameterTool.get(\"mysql.sink.user\"), this.parameterTool.get(\"mysql.sink.password\") ); &#125;&#125; åˆ°æ­¤ï¼Œä¸€ä¸ªåŸºäºdatastream-apiçš„jobï¼Œå°±å®Œæˆäº†ã€‚ ä½†æ˜¯ç”±äºè¿™æ˜¯javaæŠ€æœ¯æ ˆï¼Œå¯¹äºä¸æ˜¯javaæŠ€æœ¯æ ˆçš„å›¢é˜Ÿè€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä»¶æ¯”è¾ƒéº»çƒ¦çš„äº‹æƒ…ã€‚å°±ç®—æ˜¯javaæŠ€æœ¯æ ˆï¼Œä¹Ÿéœ€è¦å»å±äºäº†è§£flinkçš„åŸç†ï¼Œç„¶åå»ç¼–å†™å¯¹åº”çš„flinkä»£ç ï¼Œè¿™å¯¹äºä¸ç†Ÿæ‚‰datastream-apiçš„å°ä¼™ä¼´æ¥è¯´ï¼Œä¹Ÿæ˜¯ä¸€ç§å¤´ç—›çš„äº‹æƒ…ã€‚ æ‰€ä»¥å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è€ƒè™‘ä½¿ç”¨ä¸Šå±‚ä¸€äº›çš„apiï¼Œä¹Ÿå°±æ˜¯table-apiå’Œsql-apiã€‚ ä½†æ˜¯ç”±äºæ­¤ç±»apiè¿˜æ˜¯éœ€è¦ç†Ÿæ‚‰apiçš„ç»†èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°äº†flinkæä¾›äº†ä¸€ä¸ªå«sql-clientçš„ä¸œè¥¿ã€‚ä½†æ˜¯ç”±äºsql-clientçš„ä¸ç¨³å®šæ€§ï¼ˆæŸäº›ç‰ˆæœ¬ä¸‹å­˜åœ¨æ¯”è¾ƒä¸¥é‡çš„bugï¼‰ï¼Œä¸”æŸäº›éœ€æ±‚æ— æ³•æ»¡è¶³æˆ‘ä»¬ï¼Œä¸ºäº†çµæ´»å’Œå¯æ§æ€§ï¼Œæˆ‘ä»¬æœ€ç»ˆè§£å†³äº†è‡ªè¡Œå¼€å‘flink-sql-clientã€‚ åŸºäºè‡ªç ”sql-clientçš„flinkå¼€å‘å…·ä½“çš„å®ç°æ–¹å¼åœ¨ flink-sql-submit å®ç°åŸç†å…¶å®ä¹Ÿä¸å¤æ‚ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ä¸€ä¸ªflinké¡¹ç›®ï¼Œå°è£…æˆä¸ºä¸€ä¸ªç±»ä¼¼cmdçš„å‘½ä»¤ï¼Œç„¶åé€šè¿‡æ­¤æ–¹å¼æ¥æäº¤æˆ‘ä»¬çš„sqlæˆ–è€…sqlæ–‡ä»¶ 12345678910111213141516171819202122src/main/java/â”œâ”€â”€ depsâ”‚ â””â”€â”€ utilâ”‚ â”œâ”€â”€ ParameterToolEnvironmentUtils.javaâ”‚ â”œâ”€â”€ SqlCommandParser.javaâ”‚ â””â”€â”€ Util.javaâ””â”€â”€ org â””â”€â”€ client â””â”€â”€ flink â”œâ”€â”€ Bootstrap.java â”œâ”€â”€ SqlSubmit.java â”œâ”€â”€ cmds â”‚ â”œâ”€â”€ AbstractCommand.java â”‚ â”œâ”€â”€ HelpCommand.java â”‚ â”œâ”€â”€ HiveCatalogCommand.java â”‚ â”œâ”€â”€ ICommand.java â”‚ â”œâ”€â”€ JobCommand.java â”‚ â””â”€â”€ SqlParserCommand.java â”œâ”€â”€ enums â”‚ â””â”€â”€ PlanType.java â”œâ”€â”€ internals â””â”€â”€ udfs æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªé¡¹ç›®åªæœ‰å°‘é‡æ–‡ä»¶ã€‚æä¾›äº†å‡ ä¸ªå‘½ä»¤ï¼š help å¸®åŠ©å‘½ä»¤ hivecatalog ç®¡ç† å¢ åˆ  æŸ¥ job æäº¤ä»»åŠ¡ sql sql-file sql-parser è°ƒè¯•è§£æsql æˆ‘ä»¬ä»¥ä¸€ä¸ªsql-fileä¸ºä¾‹å­ï¼Œå…¶ä»–å¤§å®¶å¯ä»¥åœ¨githubä¸ŠæŸ¥çœ‹æºç ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778-- ä»¥\":\"ä¸ºåˆ†éš”ç¬¦ï¼Œåˆ†åˆ«ä»£è¡¨ï¼šcatalog_type, hive_conf_path, catalog_name-- \"-\" ä»£è¡¨ä½¿ç”¨é»˜è®¤å€¼CATALOG_INFO = hive:/opt/hadoopclient/Hive/config/:-;CREATE DATABASE mstream_alarm COMMENT 'å‘Šè­¦ç³»ç»Ÿæµè®¡ç®—';USE mstream_alarm;SET 'pipeline.name' = 'æ¯1åˆ†é’ŸåŸºç¡€æœåŠ¡å‘Šè­¦';SET 'table.exec.emit.early-fire.enabled' = 'true';SET 'table.exec.emit.early-fire.delay' = '10s';SET 'mc.local.time.zone' = 'Asia/Shanghai';SET 'table.exec.sink.not-null-enforcer' = 'drop';-- checkpointé…ç½®SET 'execution.checkpointing.mode' = 'EXACTLY_ONCE';SET 'execution.checkpointing.interval' = '2min';SET 'execution.checkpointing.timeout' = '1min';SET 'execution.checkpointing.prefer-checkpoint-for-recovery' = true;SET 'execution.checkpointing.externalized-checkpoint-retention' = 'RETAIN_ON_CANCELLATION';SET 'mc.state.backend.fs.checkpointdir' = 'hdfs:///flink/checkpoints/&#123;db&#125;/&#123;pipeline.name&#125;';SET 'mc.execution.savepoint.dir' = 'hdfs:///flink/savepoints/&#123;db&#125;/&#123;pipeline.name&#125;';-- é‡å¯ç­–ç•¥SET 'restart-strategy' = 'failure-rate';SET 'restart-strategy.failure-rate.delay' = '10s';SET 'restart-strategy.failure-rate.failure-rate-interval' = '5min';SET 'restart-strategy.failure-rate.max-failures-per-interval' = '10';CREATE TABLE app_error_To_t_log_app_error_alarm_164 ( headers ROW&lt;`app_id` int,`log_name` string&gt;, logs ROW&lt;`related_app_id` int, `child_app` varchar(200), `summary` string,`level` int,`ip` varchar(200),`detail` varchar(100), `mtime` int&gt;, etime as TO_TIMESTAMP(FROM_UNIXTIME(logs.`mtime`)), WATERMARK for etime AS etime -- defines watermark on ts column, marks ts as event-time attribute)WITH ( 'connector' = 'kafka', 'topic' = 'mfeilog_dsp_10008_app_error', 'properties.bootstrap.servers' = '127.0.0.1:9092', 'properties.group.id' = 'app_error_to_t_log_app_error_alarm_164', 'format' = 'json', 'scan.startup.mode' = 'latest-offset', 'json.fail-on-missing-field' = 'false', 'json.ignore-parse-errors' = 'false');CREATE TABLE `t_log_app_error_alarm_164` ( `related_app_id` int, `child_app` varchar(200), `summary` string, `level` int, `ip` varchar(200) , `cnt` varchar(200) COMMENT 'calculate the detail of count()', `mdate` string, `mtime` int, PRIMARY KEY (`related_app_id`,`child_app`,`summary`,`level`,`ip`) NOT ENFORCED) WITH ( 'connector' = 'jdbc', 'url' = 'jdbc:mysql://127.0.0.1:60701/db_app_log_alarm?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true', 'driver' = 'com.mysql.cj.jdbc.Driver', 'table-name' = 't_log_app_error_alarm_164', 'username' = 'flink_mstream_alarm', 'password' = 'xxxx');insert into t_log_app_error_alarm_164 ( select t1.`related_app_id`,t1.`child_app`,t1.`summary`,t1.`level`,t1.`ip`,cast(t1.`cnt` as VARCHAR(200)) as `cnt`,t1.`mdate`,cast (t1.`mtime` as INT) from ( select logs.`related_app_id` as `related_app_id`, logs.`child_app` as `child_app`, logs.`summary` as `summary`, logs.`level` as `level`, logs.`ip` as `ip`, DATE_FORMAT(TUMBLE_START(etime, INTERVAL '1' MINUTE), 'yyyy-MM-dd') as `mdate`, UNIX_TIMESTAMP(DATE_FORMAT(TUMBLE_START(etime, INTERVAL '1' MINUTE), 'yyyy-MM-dd HH:mm:ss')) as `mtime`, COUNT(logs.`detail`) as `cnt` FROM app_error_To_t_log_app_error_alarm_164 GROUP BY logs.`related_app_id`, logs.`child_app`,logs.`summary`,logs.`level`,logs.`ip`,TUMBLE(etime, INTERVAL '1' MINUTE) ) t1); æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªsql-fileï¼Œæ”¯æŒäº†ä¸€äº›å…³é”®å­—ï¼Œè¿™äº›å…³é”®å­—è¢«å¼€å‘åœ¨clientå½“ä¸­äº†ï¼Œæ‰€ä»¥å¯ä»¥è¢«æ­£å¸¸è§£æåˆ°ã€‚ é€šè¿‡è§£æåˆ°å…³é”®å­—ï¼Œå†è°ƒç”¨å¯¹åº”çš„APIï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¾ç½®å¯¹åº”çš„è¡Œä¸ºäº†ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä»ç¹æ‚çš„datastreamapiä¸­ï¼Œå·²ç»æŠŠå‰¥ç¦»äº†å‡ºæ¥ï¼Œé€šè¿‡sqlè¿™ç§DSLçš„æ–¹å¼ï¼Œè®©ä¸åŒè¯­è¨€æŠ€æœ¯æ ˆçš„åŒäº‹éƒ½å¯ä»¥å®šåˆ¶è‡ªå·±çš„jobã€‚ å¹¶ä¸”æ”¯æŒäº†è‡ªå®šä¹‰é‡å¯ç­–ç•¥ï¼Œä¿è¯æ¯ä¸€ä¸ªç®—å­åœ¨å¼‚å¸¸æˆ–è€…æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œéƒ½å¯ä»¥ä»æ­£ç¡®çš„æ•°æ®ä¸­è¿›è¡Œæ¢å¤é‡å¯ã€‚ è¿™ä¸€å¥—sqlç¼–å†™ä¸‹æ¥ï¼Œåšçš„äº‹æƒ…å’Œæˆ‘ä»¬ä¸Šé¢çš„datastreamåšçš„äº‹æƒ…æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å´æ— éœ€äº†è§£å¤ªå¤šå…¶ä¸­çš„ç»†èŠ‚ã€‚ UDFçš„è¿ç”¨ä¾‹å¦‚æˆ‘ä»¬éœ€è¦ipè½¬åœ°å€å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦udfæ¥ååŠ©æˆ‘ä»¬å®Œæˆè¿™ä»¶äº‹ã€‚ clienté¡¹ç›®å¯ä»¥å†…ç½®ä¸€äº›æˆ‘ä»¬æ‰€éœ€è¦çš„UDFï¼Œç„¶åè¿åŒjobä¸€èµ·ç”Ÿæ•ˆã€‚ ä¾‹å¦‚ï¼š 12345678[root@127.0,0.1_A ~]# flink run -yid `cat /data/flink-stream/mstream/mstream_xx/yid` /data/flink-stream/flink-sql-submit-1.0-SNAPSHOT.jar job --sql \"CATALOG_INFO = hive:/opt/hadoopclient/Hive/config/:-;USE mstream_alarm;SELECT ip2location('219.135.155.76');\" Interface ana-group-1byez.dad44e53-24e6-41be-bfd5-a4055f4c6604.com:32263 of application 'application_1641337362340_6699'.Job has been submitted with JobID 824af5a31aba88db6e0137f5e834f26b+----+--------------------------------+| op | EXPR$0 |+----+--------------------------------+| +I | ä¸­å›½,å¹¿ä¸œ,å¹¿å· |+----+--------------------------------+ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ip2localtion()ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ªudfï¼Œå¹¶ä¸”å¯ä»¥å®ç°åœ¨sqlçš„æ¨¡å¼ä¸Šã€‚ç”¨è¿‡ipåœ°å€è½¬ä¸ºä¸ºäº†åœ°å€ã€‚ è½åœ°å®æˆ˜ç”±äºèµ„æºçš„æœ‰é™ï¼Œæˆ‘ä»¬åœ¨flinkçš„æ¶æ„ä¸Šï¼Œé‡‡ç”¨çš„æ˜¯æ¯ä¸ªé¡¹ç›®å¯¹åº”ä¸€ä¸ªapplicationçš„æ–¹æ³•ï¼Œæ¯ä¸ªapplicationé€šè¿‡yarnæ¥åˆ†é…æ¥åˆ†é…èµ„æºå®¹å™¨ï¼Œç„¶åå†é€šè¿‡yarn-session(éper on job)çš„æ–¹å¼æ¥ç®¡ç†æˆ‘ä»¬çš„flinkåº”ç”¨ã€‚ ç”³è¯·èµ„æºåº”ç”¨1yarn-session.sh -jm 1024 -tm 1024 -s 16 -nm 'å‘Šè­¦æµè®¡ç®—åº”ç”¨' -yd client ä¾‹å­1234567891011121314151617181920212223242526272829303132333435363738# helproot@41c5967b5948:/www# flink run target/mc-flink-sql-submit-1.0-SNAPSHOT.jar helpå¸®åŠ©å‘½ä»¤Usage of \"flink run &lt;.jar&gt; help [options]\"Available Commands job æäº¤jobä½œä¸š sql-parser è§£æsqlæ–‡ä»¶ help å¸®åŠ©å‘½ä»¤ hive-catalog hive-catalogçš„ç›¸å…³Global Options: --app.force.remote bool æ˜¯å¦å¯åŠ¨è¿œç«¯ç¯å¢ƒå˜é‡: false --app.config.debug bool æ˜¯å¦æ‰“å°ç”¨æˆ·å‚æ•°: false# jobroot@41c5967b5948:/www# flink run target/mc-flink-sql-submit-1.0-SNAPSHOT.jar job helpæäº¤jobUsage of \"flink run &lt;.jar&gt; job [options]\" --sql string æ‰§è¡Œçš„sql (*) --plan string é€‰æ‹©æ‰§è¡Œè®¡åˆ’å™¨: flink-streaming flink-batch blink-streaming flink-batchGlobal Options: --app.force.remote bool æ˜¯å¦å¯åŠ¨è¿œç«¯ç¯å¢ƒå˜é‡: false --app.config.debug bool æ˜¯å¦æ‰“å°ç”¨æˆ·å‚æ•°: false flink-stream-sql-mctl ç”¨æ³•è¿™æ˜¯ä¸€ä¸ªé›†æˆè„šæœ¬ï¼Œæ‰€ä»¥å­˜åœ¨çº¦å®šçš„è§„åˆ™å’Œéƒ¨ç½²çš„æ¶æ„çº¦æŸã€‚ è¿™ä¾¿äºæˆ‘ä»¬ç®¡ç†æ‰€æœ‰çš„applitionå’Œflinkç§çš„æ‰€æœ‰flink-jobã€‚ 1234567891011121314151617181920212223242526flink-sql-submit git:(master) âœ— ./flink-stream-sql-mctl.sh flink-stream-sql-mctl.sh [OPTION] &lt;COMMAND&gt; Flinkæµè®¡ç®—SQL-Clientçš„æ‰§è¡Œè„šæœ¬ Command: run [FILE] è¿è¡Œ stop [FILE] åœæ­¢ list [FILE] åˆ—å‡ºFILEæ‰€åœ¨yidä¸‹çš„æ‰€æœ‰jobä»»åŠ¡åˆ—è¡¨ drop_table [FILE] åˆ é™¤æ‰€æœ‰è¡¨ rebuild_run [FILE] åˆ é™¤æ‰€æœ‰è¡¨ï¼Œç„¶åé‡è·‘(ç»§æ‰¿savepointï¼‰ Command-Common-Options: -c, --clientpath [LEVEL] flink-sql-submit.jarè·¯å¾„ (Default is '/data/tmp/mc-flink-sql-submit-1.0-SNAPSHOT.jar') -f æ˜¯å¦å¼ºåˆ¶è¿è¡Œï¼Œå¿½ç•¥ä»¥å¾€savepoint Common-Options: -h, --help Display this help and exit --loglevel [LEVEL] One of: FATAL, ERROR, WARN, INFO, NOTICE, DEBUG, ALL, OFF (Default is 'ERROR') --logfile [FILE] Full PATH to logfile. (Default is '/Users/caiwenhui/logs/flink-stream-sql-mctl.sh.log') -n, --dryrun Non-destructive. Makes no permanent changes. -q, --quiet Quiet (no output) -v, --verbose Output more information. (Items echoed to 'verbose') --force Skip all user interaction. Implied 'Yes' to all actions. çº¦å®šè§„åˆ™ï¼š æ¨¡å‹æ‰€åœ¨çˆ¶ç›®å½•çš„è‡³å°‘æœ‰ä¸€ä¸ªyidæ–‡ä»¶ï¼ˆå–æœ€è¿‘çš„ä¸€ä¸ªçˆ¶èŠ‚ç‚¹çš„yidï¼‰å¯¹åº”æ‰€åœ¨çš„åº”ç”¨id é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡å‹å¯åŠ¨çš„æ—¶å€™ä¼šå–æœ€è¿‘ä¸€æ¬¡savepointçš„æ•°æ®è¿›è¡Œæ¢å¤ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥å¯åŠ¨ åœæ­¢æ‰€æœ‰æ¨¡å‹1for i in $(find /data/flink-stream/mstream_alarm/ -type f -name \"*.sql\");do /data/flink-stream/flink-stream-sql-mctl stop $i;done å¯åŠ¨æ‰€æœ‰æ¨¡å‹1for i in $(find /data/flink-stream/mstream_alarm/ -type f -name \"*.sql\");do /data/flink-stream/flink-stream-sql-mctl run $i;done åˆ é™¤æ‰€æœ‰è¡¨1for i in $(find /data/flink-stream/mstream_alarm/ -type f -name \"*.sql\");do /data/flink-stream/flink-stream-sql-mctl drop_table $i;done ç›¸å…³çš„ä¸€äº›è½åœ°åæˆªå›¾ä¿¡æ¯ åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„flinkç›¸å…³çš„æµè®¡ç®—åº”ç”¨ï¼Œä»0åˆ°1çš„è¿‡ç¨‹æš‚æ—¶ç”»ä¸Šä¸€ä¸ªé‡Œç¨‹ç¢‘ã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"flink","slug":"flink","permalink":"http://blog.crazylaw.cn/tags/flink/"}]},{"title":"ã€Golangã€‘- åŸºäºgnetçš„ç«¯å£å¤ç”¨æ”¯æŒå¤šåè®®çš„å®¢æœèŠå¤©ç›‘æ§æœåŠ¡","slug":"Golang/åŸºäºgnetçš„å®¢æœèŠå¤©ç›‘æ§æœåŠ¡","date":"2022-02-11T16:46:51.000Z","updated":"2022-02-12T03:45:01.017Z","comments":true,"path":"2022/02/12/Golang/åŸºäºgnetçš„å®¢æœèŠå¤©ç›‘æ§æœåŠ¡/","link":"","permalink":"http://blog.crazylaw.cn/2022/02/12/Golang/%E5%9F%BA%E4%BA%8Egnet%E7%9A%84%E5%AE%A2%E6%9C%8D%E8%81%8A%E5%A4%A9%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1/","excerpt":"å‰è¨€æœ€è¿‘ï¼Œå…¬å¸ä»¥å‰æœ‰ä¸€äº›æ—§çš„æœåŠ¡ï¼Œç”±äºå„ç§åŸå› ï¼Œå¯¼è‡´å„ç§é—®é¢˜ï¼Œå¹¶ä¸”æ¶æ„è®¾è®¡è¡Œä¹Ÿä¸æ˜¯é‚£ä¹ˆå‹å¥½å’Œä¸åˆ©äºç»´æŠ¤ã€‚æ‰€ä»¥å‡†å¤‡é‡æ„è®¾è®¡ä¸€äº›æœåŠ¡ã€‚ åœ¨æ¸¸æˆå…¬å¸ä¸­ï¼ŒGMå®¢æœçš„å…¶ä¸­ä¸€ä¸ªèŒèƒ½å°±æ˜¯ç›‘ç£èˆ†è®ºï¼Œä»ç©å®¶å¹³æ—¥çš„èŠå¤©ä¸­è¿›è¡Œç›‘æ§ã€‚ æˆ‘ä»¬ä»ä¸šåŠ¡éœ€æ±‚+æŠ€æœ¯æ¶æ„å±‚é¢è¿›è¡Œæ•´ç†ã€‚","text":"å‰è¨€æœ€è¿‘ï¼Œå…¬å¸ä»¥å‰æœ‰ä¸€äº›æ—§çš„æœåŠ¡ï¼Œç”±äºå„ç§åŸå› ï¼Œå¯¼è‡´å„ç§é—®é¢˜ï¼Œå¹¶ä¸”æ¶æ„è®¾è®¡è¡Œä¹Ÿä¸æ˜¯é‚£ä¹ˆå‹å¥½å’Œä¸åˆ©äºç»´æŠ¤ã€‚æ‰€ä»¥å‡†å¤‡é‡æ„è®¾è®¡ä¸€äº›æœåŠ¡ã€‚ åœ¨æ¸¸æˆå…¬å¸ä¸­ï¼ŒGMå®¢æœçš„å…¶ä¸­ä¸€ä¸ªèŒèƒ½å°±æ˜¯ç›‘ç£èˆ†è®ºï¼Œä»ç©å®¶å¹³æ—¥çš„èŠå¤©ä¸­è¿›è¡Œç›‘æ§ã€‚ æˆ‘ä»¬ä»ä¸šåŠ¡éœ€æ±‚+æŠ€æœ¯æ¶æ„å±‚é¢è¿›è¡Œæ•´ç†ã€‚ å†å²åœ¨è¿‡å»ä¸­ï¼Œç”±äºå½“æ—¶phpè¿˜æ˜¯å¦‚æ—¥ä¸­å¤©ï¼Œæ—§çš„åˆ™æ˜¯é‡‡é›†çš„swoole1.xçš„ç‰ˆæœ¬è¿›è¡Œå¼€å‘çš„æœåŠ¡ã€‚å—é™äºphpä¸€ä¸ªè¯­è¨€ç‰¹æ€§ï¼Œæ³¨å®šæ— æ³•å®ç°ä¸€äº›é«˜æ€§èƒ½çš„ä¸­é—´ä»¶ï¼Œæˆ–è€…è¯´å¤§æ•°æ®ç”Ÿæ€ååˆ†æ¬ ç¼ºã€‚å½“æ—¶ç”¨phpé™¤äº†fastcgiçš„webç³»ç»Ÿå¤–ï¼Œæœ€å¤šå°±åªèƒ½åšä¸€äº›åŸºæœ¬çš„å¸¸é©»ä»»åŠ¡ã€‚ æ¶ˆæ¯ä¸­é—´ä»¶æœ€å¤šä¹Ÿå°±æ˜¯ç”¨åˆ°rabbitmqï¼Œrocketmqç­‰ç­‰ã€‚ è€Œå¸¸é©»ï¼Œä¸€èˆ¬æ— éå°±æ˜¯ç›´æ¥cliï¼Œå¤–åŠ ä¸€ä¸ªå¾ªç¯+sleepçš„ç»„åˆå¥—é¤ã€‚è€Œè¦å®ç°websocket-serverè¿™ç§å¸¸é©»æœåŠ¡ï¼Œä¸€èˆ¬æ˜¯å€ŸåŠ©swooleæ¥å¤„ç†ã€‚æ¯•ç«Ÿreactorçš„æ¨¡å¼ï¼Œæ€ä¹ˆéƒ½æ¯”å•è¿›ç¨‹çš„å®ç°å¥½ã€‚ åˆ†ä¸ºäº†3ä¸ªæ¨¡å—ï¼ˆæ¯ä¸ªæ¨¡å—=æ¯ä¸ªè§’è‰²=ä¸€ä¸ªè¿›ç¨‹=ä¸€ä¸ªæœåŠ¡ï¼‰ï¼š chat_record ï¼ˆèŠå¤©è®°å½•è§’è‰²ï¼‰ï¼ˆweboccket_client, tcp_clinetï¼‰ db_server ï¼ˆæ•°æ®å±‚è§’è‰²) (tcp_server) websocket_server (è¿æ¥å±‚è§’è‰²) (webocket_server) ç”±äºå½“æ—¶phpåŸºæœ¬æ— æ³•å¤šçº¿ç¨‹ç¼–ç¨‹(å¯ç”¨ï¼Œä½†æ˜¯ä¸å‹å¥½)ï¼Œåªèƒ½é‡‡ç”¨è¿™ç§å§”å©‰çš„ä¼ªå¤šè¿›ç¨‹çš„æ¨¡æ‹Ÿè¿›è¡Œä¸åŒä»»åŠ¡çš„å¤„ç†å’Œæ•°æ®çš„äº¤äº’ã€‚ æ–°æœåŠ¡ ä½†æ˜¯ç”±äºç§ç§åŸå› ï¼Œåé¢å¹¶æœªå¦‚æ­¤æ‹†åˆ†æ¶æ„ï¼Œè€Œæ˜¯å°†websocket-serverç½‘ç»œè¿æ¥å±‚çš„å’Œä¸šåŠ¡å±‚åˆå¹¶æˆä¸ºäº†ä¸€ä¸ªå•ä½“æœåŠ¡ æŠ€æœ¯é€‰å‹ä¸Š go gnet kafka ä¸ºä»€ä¹ˆæ ¸å¿ƒçš„ç½‘ç»œå±‚éœ€è¦é‡‡ç”¨gnetå‘¢ï¼Ÿä¸€èˆ¬Goè¯­è¨€çš„TCP(å’ŒHTTP)çš„å¤„ç†éƒ½æ˜¯æ¯ä¸€ä¸ªè¿æ¥å¯åŠ¨ä¸€ä¸ªgoroutineå»å¤„ç†ï¼Œå› ä¸ºæˆ‘ä»¬è¢«æ•™å¯¼goroutineçš„ä¸åƒthread, å®ƒæ˜¯å¾ˆä¾¿å®œçš„ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨æˆåƒä¸Šä¸‡çš„goroutineã€‚ ä½†æ˜¯å¯¹äºä¸€ç™¾ä¸‡çš„è¿æ¥ï¼Œè¿™ç§goroutine-per-connectionçš„æ¨¡å¼å°±è‡³å°‘è¦å¯åŠ¨ä¸€ç™¾ä¸‡ä¸ªgoroutineï¼Œè¿™å¯¹èµ„æºçš„æ¶ˆè€—ä¹Ÿæ˜¯æå¤§çš„ã€‚ é’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œä¸åŒçš„Goç‰ˆæœ¬ï¼Œä¸€ä¸ªgoroutineé”ä½¿ç”¨çš„æœ€å°çš„æ ˆå¤§å°æ˜¯2KB ~ 8 KB (go stack),å¦‚æœåœ¨æ¯ä¸ªgoroutineä¸­åœ¨åˆ†é…byte bufferç”¨ä»¥ä»è¿æ¥ä¸­è¯»å†™æ•°æ®ï¼Œå‡ åGçš„å†…å­˜è½»è½»æ¾æ¾å°±åˆ†é…å‡ºå»äº†ã€‚ ååç‡å’Œå»¶è¿Ÿéœ€è¦æ•°æ®æ¥æ”¯æ’‘ï¼Œä½†æ˜¯æ˜¾ç„¶è¿™ä¸ªå•goroutineå¤„ç†çš„æ¨¡å¼ä¸é€‚åˆè€—æ—¶è¾ƒé•¿çš„ä¸šåŠ¡å¤„ç†ï¼Œ&quot;hello world&quot;æˆ–è€…ç›´æ¥çš„ç®€å•çš„memoryæ“ä½œåº”è¯¥æ²¡æœ‰é—®é¢˜ã€‚ å¯¹äºç™¾ä¸‡è¿æ¥ä½†æ˜¯å¹¶å‘é‡å¾ˆå°çš„åœºæ™¯ï¼Œæ¯”å¦‚æ¶ˆæ¯æ¨é€ã€é¡µæ¸¸ç­‰åœºæ™¯ï¼Œè¿™ç§å®ç°åº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ ä½†æ˜¯å¯¹äºå¹¶å‘é‡å¾ˆå¤§ï¼Œå»¶è¿Ÿè¦æ±‚æ¯”è¾ƒä½çš„åœºæ™¯ï¼Œè¿™ç§å®ç°å¯èƒ½ä¼šå­˜åœ¨é—®é¢˜ã€‚ gneté‡‡ç”¨äº†ç±»ä¼¼nettyçš„reactoræ¨¡å¼ï¼ŒåŸºäºepollæˆ–è€…kqueueå®ç°ioå¤šè·¯å¤ç”¨ã€‚å¹¶ä¸”åŸºäºgolangçš„è¯­è¨€ç‰¹æ€§ï¼Œå…¶å®ç°åŸç†ä¸ºå¸¦çº¿ç¨‹/goç¨‹æ± çš„ä¸»ä» Reactors å¤šçº¿ç¨‹æ¨¡å¼ï¼Œåœ¨ç½‘ç»œå±‚ä¸Šæ€§èƒ½ä¸Šæœ‰æå¤§çš„ä¼˜åŒ–ã€‚ æˆ‘ä»¬é€šè¿‡gnetæä¾›çš„tcpç½‘ç»œå±‚ï¼Œåœ¨åº”ç”¨å±‚ï¼Œå®ç°äº†httpå’Œwebocketçš„ç«¯å£å¤ç”¨çš„å½¢å¼ã€‚ httpç”¨äºæä¾›prometheusçš„metricsæŒ‡æ ‡ï¼Œä¾‹å¦‚è¿æ¥æ•°/å„ç§ç±»å‹å¼•å‘çš„erroræ•°/æ¯æ¡æ•°æ®è¢«å¤šå°‘ä¸ªGMå®¢æœç›‘è§†ç€ç­‰ç­‰ websocketåˆ™æ˜¯ç”¨äºåœ¨æˆ‘ä»¬çš„GMå®¢æœä¸­ï¼Œæä¸€ä¸ªå®æ—¶çš„èŠå¤©æ•°æ®è·å– ä¸ºä»€ä¹ˆé‡‡ç”¨kafkaç”±äºæˆ‘ä»¬æ•´å¥—æ—¥å¿—æœåŠ¡éƒ½æ˜¯åŸºäºkafkaä½œä¸ºæ ¸å¿ƒç»„ä»¶çš„ï¼Œæ‰€ä»¥åœ¨æ•°æ®çš„å®æ—¶ä¸Šï¼Œå¯ä»¥ä¿è¯åˆ°æ•°æ®çš„å®æ•ˆæ€§ã€‚ ä»è€Œå–æ¶ˆäº†ä»¥å¾€ä»mysqlä¸­åˆ†åº“åˆ†è¡¨å»æŸ¥è¯¢æ•°æ®ã€‚ä¹Ÿä¸éœ€è¦é€šè¿‡å…¶ä»–OLAPçš„æœåŠ¡è¿›è¡Œå¤„ç†ã€‚ ç«¯å£å¤ç”¨å®ç°æ”¯æŒå¤šåè®®è¿™ä¸ªæ˜¯ç½‘ç»œè¿æ¥å±‚ï¼Œä¹Ÿæ˜¯é“¾æ¥çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œåœ¨gnetä¸­å½“æœ‰æ•°æ®åˆ°æ¥çš„æ—¶å€™ï¼Œç”±IOå¤šè·¯å¤ç”¨çš„epollæ¨¡å‹ï¼Œä¼šè§¦å‘OnTraffic(c gnet.Conn)çš„å›è°ƒå‡½æ•°ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç½‘ç»œå±‚ä¸­è·å–çš„æ•°æ®è¿›è¡ŒåŠ å·¥å¤„ç†ï¼Œå½¢æˆè‡ªå·±æƒ³è¦çš„åº”ç”¨åè®®ã€‚ ç”±äºåˆšæ‰ä»‹ç»åˆ°äº†ï¼Œæˆ‘ä»¬éœ€è¦å®ç°æ ¸å¿ƒéœ€æ±‚ï¼šç«¯å£å¤šåè®®å¤ç”¨ åœ¨è¿™é‡Œï¼Œå…ˆåˆ—å‡ºæ ¸å¿ƒçš„é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137type ApplicationLayerProto intfunc (alp ApplicationLayerProto) String() (s string) &#123; switch alp &#123; case HttpApplicationLayerProto: s = \"http\" case WebsocketApplicationLayerProto: s = \"websocket\" default: s = \"unknown\" &#125; return&#125;const ( HttpApplicationLayerProto ApplicationLayerProto = iota WebsocketApplicationLayerProto)type codec struct &#123; proto ApplicationLayerProto&#125;func (c *codec) isHttp() bool &#123; if c.proto == HttpApplicationLayerProto &#123; return true &#125; return false&#125;func (c *codec) isWebsocket() bool &#123; if c.proto == WebsocketApplicationLayerProto &#123; return true &#125; return false&#125;type httpCodec struct &#123; *codec parser *wildcat.HTTPParser&#125;type wsCodec struct &#123; *codec connected bool&#125;func (serv *server) OnOpen(c gnet.Conn) ([]byte, gnet.Action) &#123; c.SetContext(new(codec)) return nil, gnet.None&#125;func (serv *server) OnTraffic(c gnet.Conn) gnet.Action &#123; var buffer *bytes.Buffer var buff []bytepipeline: switch cdc := c.Context().(type) &#123; case *codec: buf, err := c.Next(-1) buff = make([]byte, len(buf)) copy(buff, buf) buffer = bytes.NewBuffer(buff) if err != nil &#123; return gnet.Close &#125; hc := &amp;httpCodec&#123;parser: wildcat.NewHTTPParser(), codec: cdc&#125; _, err = hc.parser.Parse(buf) if err != nil &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"http parser error: %v\", err)&#125;) return gnet.Close &#125; if upgrade := hc.parser.FindHeader([]byte(\"Upgrade\")); upgrade != nil &amp;&amp; bytes.Equal(upgrade, []byte(\"websocket\")) &#123; cdc.proto = WebsocketApplicationLayerProto wc := &amp;wsCodec&#123; codec: cdc, &#125; c.SetContext(wc) &#125; else &#123; cdc.proto = HttpApplicationLayerProto c.SetContext(hc) &#125; goto pipeline case *httpCodec: buf := bufio.NewReader(buffer) req, err := http.ReadRequest(buf) if err != nil &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"request from http error: %v\", err)&#125;) return gnet.Close &#125; metrics.TotalConnectedCounter.WithLabelValues(HttpApplicationLayerProto.String()).Inc() resp := route.NewResponse(c) h, _ := serv.serverMux.Handler(req) h.ServeHTTP(resp, req) if _, err = resp.Close(); err != nil &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"write to http error: %v\", err)&#125;) return gnet.Close &#125; return gnet.Close case *wsCodec: if !cdc.connected &#123; wcb := &amp;wsConnBridge&#123; buff: buffer, c: c, &#125; _, err := ws.Upgrade(wcb) if err != nil &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"upgrade[%s] to websocket error: %v\", c.RemoteAddr().String(), err)&#125;) &#125; log.Debugf(log.NetServerDebugCategory&#123;&#125;, \"conn[%v] upgrade websocket protocol\", c.RemoteAddr().String()) cdc.connected = true metrics.ConnectedGauge.Inc() metrics.TotalConnectedCounter.WithLabelValues(WebsocketApplicationLayerProto.String()).Inc() &#125; else &#123; msg, op, err := wsutil.ReadClientData(c) if err != nil &#123; if _, ok := err.(wsutil.ClosedError); !ok &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"[%s] receive ws message error: %v\", c.RemoteAddr().String(), err)&#125;) &#125; return gnet.Close &#125; log.Debugf(log.NetServerDebugCategory&#123;&#125;, \"conn[%v] receive [op=%v] [msg=%v]\", c.RemoteAddr().String(), op, string(msg)) if op == ws.OpText &#123; if rs := route.MatchRequestSpec(msg); rs == nil &#123; return route.GlobalWsRouter.DefaultHandler().ServeWebsocket(\"/\", msg, c, op) &#125; else &#123; return route.GlobalWsRouter.MatchHandler(rs.Path).ServeWebsocket(rs.Path, rs.Params, c, op) &#125; &#125; &#125; &#125; return gnet.None&#125; è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“å­˜åœ¨æ–°é“¾æ¥è¿›æ¥çš„å•¥æ—¶å€™ï¼Œé¦–å…ˆç»è¿‡OnOpen(c gnet.Conn)æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåœ¨gnet.Connä¸­è®¾ç½®ä¸€ä¸ªæˆ‘ä»¬ç”¨æˆ·çš„ä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒContextï¼Œåœ¨è¿™ä¸ªContextä¸‹ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªè¿æ¥éƒ½åˆå§‹åŒ–äº†codecçš„ç»“æ„ä½“å¯¹è±¡ï¼Œå½“å¼€å§‹æ¥æ”¶æ•°æ®çš„æ—¶å€™ï¼Œè§¦å‘åˆ°äº†OnTraffic(c gnet.Conn)æ–¹æ³•ï¼Œè¿™ä¸ªä»¥åï¼Œæˆ‘ä»¬éœ€è¦æŠŠç½‘ç»œå±‚æ¥æ”¶åˆ°çš„æ•°æ®æ‹¿å‡ºæ¥ï¼Œç”±äºæµçš„å­˜åœ¨ï¼Œä½¿å¾—æˆ‘ä»¬æ— æ³•é‡å¤åœ¨åŒä¸€ä¸ªè¿æ¥ä¸­ï¼Œå¤šæ¬¡é‡å¤è·å–æµï¼Œæ‰€ä»¥å¦‚æœåé¢éœ€è¦ç”¨åˆ°çš„è¯ï¼Œåˆ©ç”¨å–å‡ºæ¥çš„byte-bufferç”Ÿæˆä¸€ä¸ªæ–°çš„æµï¼Œä»¥ä¾›åç»­ä½¿ç”¨ã€‚ æ‰€ä»¥ä½ ä¼šå‘ç°æœ‰ä¸€æ®µä»£ç ä¸º: 1234buf, err := c.Next(-1)buff = make([]byte, len(buf))copy(buff, buf)buffer = bytes.NewBuffer(buff) æ¥ä¸‹æ¥ï¼Œéœ€è¦åšçš„äº‹æƒ…å°±æ˜¯è§£ææ•°æ®ä¸ºhttpåè®®å¯¹è±¡ï¼Œç”±äºæˆ‘è¿™é‡Œçš„ç«¯å£å¤ç”¨çš„é€»è¾‘æ˜¯http+webocketå¤ç”¨ï¼Œæ‰€ä»¥éƒ½æ˜¯åŸºäºhttpåè®®çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç®€å•ç²—æš´çš„å¤„ç†ï¼Œç„¶åé€šè¿‡åˆ¤æ–­httpåè®®ä¸­æ˜¯å¦åŒ…å«äº†éœ€è¦å‡çº§ä¸ºwebocketåè®®çš„å…³é”®å­—æ®µUpgrade:webocketï¼Œå¦‚æœåŒ…å«ï¼Œåˆ™è¡¨ç¤ºæœ¬æ¬¡è¯·æ±‚æ˜¯ä¸€ä¸ªwebsocketè¿æ¥ï¼Œå¦åˆ™å°±æ˜¯ä¸€ä¸ªå•çº¯httpè¿æ¥ã€‚ä»¥æ­¤æ¥è¾¾åˆ°å¤ç”¨çš„éœ€æ±‚ã€‚ åœ¨è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿæ›´æ–°äº†å½“å‰è¿æ¥çš„ä¸Šä¸‹æ–‡ç¯å¢ƒContextï¼Œå‡çº§ä¸ºäº†httpCodecå’ŒwsCodecï¼Œé€šè¿‡goto+æ–­è¨€è¯­æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ°ï¼Œæˆ‘ä»¬æ‰€éœ€è¦è¿›å…¥çš„é€»è¾‘é˜¶æ®µã€‚ä¸è¦è§‰å¾—è¿™å°±å®Œäº‹äº†ï¼Œéº»çƒ¦çš„äº‹æƒ…æ‰åˆšå¼€å§‹ï¼Œç°åœ¨ä½ åªæ˜¯çŸ¥é“äº†å¼€å¤´ã€‚ 123456789101112131415buf := bufio.NewReader(buffer)req, err := http.ReadRequest(buf)if err != nil &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"request from http error: %v\", err)&#125;) return gnet.Close&#125;metrics.TotalConnectedCounter.WithLabelValues(HttpApplicationLayerProto.String()).Inc()resp := route.NewResponse(c)h, _ := serv.serverMux.Handler(req)h.ServeHTTP(resp, req)if _, err = resp.Close(); err != nil &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"write to http error: %v\", err)&#125;) return gnet.Close&#125;return gnet.Close å¦‚æœæ˜¯httpåè®®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸éœ€è¦å‡çº§åè®®äº†ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œåœ¨golangçš„http/server.goä¸­ï¼Œæˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„æ¥å£ 123456789101112131415161718192021222324252627// A Handler responds to an HTTP request.//// ServeHTTP should write reply headers and data to the ResponseWriter// and then return. Returning signals that the request is finished; it// is not valid to use the ResponseWriter or read from the// Request.Body after or concurrently with the completion of the// ServeHTTP call.//// Depending on the HTTP client software, HTTP protocol version, and// any intermediaries between the client and the Go server, it may not// be possible to read from the Request.Body after writing to the// ResponseWriter. Cautious handlers should read the Request.Body// first, and then reply.//// Except for reading the body, handlers should not modify the// provided Request.//// If ServeHTTP panics, the server (the caller of ServeHTTP) assumes// that the effect of the panic was isolated to the active request.// It recovers the panic, logs a stack trace to the server error log,// and either closes the network connection or sends an HTTP/2// RST_STREAM, depending on the HTTP protocol. To abort a handler so// the client sees an interrupted response but the server doesn't log// an error, panic with the value ErrAbortHandler.type Handler interface &#123; ServeHTTP(ResponseWriter, *Request)&#125; æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªHandlerinterfaceï¼Œéœ€è¦å®ç°ServeHTTP(ResponseWriter, *Request)ï¼Œè€Œè¿™ä¸ªRequestï¼Œå¯¹äºæˆ‘ä»¬ç›®å‰æ¥æ˜¯ï¼Œæ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æƒ³åŠæ³•æ„é€ ä¸€ä¸ªRequestå¯¹è±¡å‡ºæ¥ã€‚ 123456789// ReadRequest reads and parses an incoming request from b.//// ReadRequest is a low-level function and should only be used for// specialized applications; most code should use the Server to read// requests and handle them via the Handler interface. ReadRequest// only supports HTTP/1.x requests. For HTTP/2, use golang.org/x/net/http2.func ReadRequest(b *bufio.Reader) (*Request, error) &#123; return readRequest(b, deleteHostHeader)&#125; å¥½åœ¨æ ‡å‡†åŒ…ä¸­æä¾›ä¸€ä¸ªReadRequest(b *bufio.Reader) (*Request, error)çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡bufio.Readerå»è¯»å–httpåè®®ï¼Œç„¶åæ„é€ å‡ºæˆ‘ä»¬æ‰€éœ€è¦çš„Requestå¯¹è±¡ï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ä¸€å¼€å§‹copy(buff, buf)çš„æ„ä¹‰å°±ä½“ç°åœ¨æ­¤äº†ã€‚è¿˜ä¼šé‚£å¥è¯ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªæµï¼Œæ— æ³•é‡å¤è¯»å–ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨[]byteæ„é€ ä¸€ä¸ªå…¨æ–°çš„å¯åº¦çš„å­—èŠ‚æµã€‚ è§£å†³äº†Requestçš„é—®é¢˜ä¹‹åï¼Œå¦å¤–ä¸€ä¸ªé—®é¢˜ä¹Ÿæ¥äº†ï¼ŒResponseWriteræ˜¯ä¸€ä¸ªå’ŒResponseç›¸å…³å¯å†™çš„å­—èŠ‚æµã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566// A ResponseWriter interface is used by an HTTP handler to// construct an HTTP response.//// A ResponseWriter may not be used after the Handler.ServeHTTP method// has returned.type ResponseWriter interface &#123; // Header returns the header map that will be sent by // WriteHeader. The Header map also is the mechanism with which // Handlers can set HTTP trailers. // // Changing the header map after a call to WriteHeader (or // Write) has no effect unless the modified headers are // trailers. // // There are two ways to set Trailers. The preferred way is to // predeclare in the headers which trailers you will later // send by setting the \"Trailer\" header to the names of the // trailer keys which will come later. In this case, those // keys of the Header map are treated as if they were // trailers. See the example. The second way, for trailer // keys not known to the Handler until after the first Write, // is to prefix the Header map keys with the TrailerPrefix // constant value. See TrailerPrefix. // // To suppress automatic response headers (such as \"Date\"), set // their value to nil. Header() Header // Write writes the data to the connection as part of an HTTP reply. // // If WriteHeader has not yet been called, Write calls // WriteHeader(http.StatusOK) before writing the data. If the Header // does not contain a Content-Type line, Write adds a Content-Type set // to the result of passing the initial 512 bytes of written data to // DetectContentType. Additionally, if the total size of all written // data is under a few KB and there are no Flush calls, the // Content-Length header is added automatically. // // Depending on the HTTP protocol version and the client, calling // Write or WriteHeader may prevent future reads on the // Request.Body. For HTTP/1.x requests, handlers should read any // needed request body data before writing the response. Once the // headers have been flushed (due to either an explicit Flusher.Flush // call or writing enough data to trigger a flush), the request body // may be unavailable. For HTTP/2 requests, the Go HTTP server permits // handlers to continue to read the request body while concurrently // writing the response. However, such behavior may not be supported // by all HTTP/2 clients. Handlers should read before writing if // possible to maximize compatibility. Write([]byte) (int, error) // WriteHeader sends an HTTP response header with the provided // status code. // // If WriteHeader is not called explicitly, the first call to Write // will trigger an implicit WriteHeader(http.StatusOK). // Thus explicit calls to WriteHeader are mainly used to // send error codes. // // The provided code must be a valid HTTP 1xx-5xx status code. // Only one header may be written. Go does not currently // support sending user-defined 1xx informational headers, // with the exception of 100-continue response header that the // Server sends automatically when the Request.Body is read. WriteHeader(statusCode int)&#125; ç§‰ç€é¢å‘æ¥å£å¼€å‘çš„åŸåˆ™ï¼Œå¹¶ä¸”ä¸ºäº†æ›´å¥½çš„å…¼å®¹ç¬¬ä¸‰æ–¹çš„APIï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„ResponseWriterå¯¹è±¡ï¼Œäºæ˜¯å°±æœ‰äº†route.NewResponse(c)ï¼Œè¿™ä¸ªrespå®ç°äº†ä¸Šè¿°çš„æ¥å£. å…¼å®¹äº†promhttpæä¾›çš„Handlerï¼Œä¹Ÿå…¼å®¹äº†è‡ªå·±çš„helloworldæ¥å£ã€‚ æ¥ç€æˆ‘ä»¬é€šè¿‡cmuxè¿›è¡Œä¸€ä¸ªè·¯ç”±åŒ¹é…ï¼Œç„¶åè°ƒç”¨åˆ°å¯¹åº”çš„ServeHTTP,å¤„ç†å®Œé€»è¾‘ä¹‹åï¼Œåœ¨respçš„Close()é˜¶æ®µï¼ŒæŠŠç¼“å­˜åŒºçš„æ‰€æœ‰[]byteï¼Œæ¨é€åˆ°è¿æ¥å±‚ï¼Œç„¶åé€šè¿‡è¿”å›gnet.Closeè¿›è¡Œç½‘ç»œå±‚çš„æ–­å¼€ï¼Œè‡³æ­¤ï¼Œä¸€ä¸ªç®€å•è€Œå®Œæ•´çš„httpäº¤äº’æµç¨‹å®Œæ¯•ã€‚ å¯¹äºWebsocketåè®®æ¥è¯´ï¼Œè¦åšçš„äº‹æƒ…ä¹Ÿæ˜¯ååˆ†ç¹çï¼ˆç”±äºç”¨äº†å¼€æºåè®®åº“ï¼Œç›¸å¯¹ç®€åŒ–äº†å¾ˆå¤šï¼‰ï¼Œè¯·å…ˆçœ‹ä¸‹é¢çš„åº”ç”¨å±‚åè®®å¤„ç†é€»è¾‘ã€‚ 12345678910111213141516171819202122232425262728293031if !cdc.connected &#123; wcb := &amp;wsConnBridge&#123; buff: buffer, c: c, &#125; _, err := ws.Upgrade(wcb) if err != nil &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"upgrade[%s] to websocket error: %v\", c.RemoteAddr().String(), err)&#125;) &#125; log.Debugf(log.NetServerDebugCategory&#123;&#125;, \"conn[%v] upgrade websocket protocol\", c.RemoteAddr().String()) cdc.connected = true metrics.ConnectedGauge.Inc() metrics.TotalConnectedCounter.WithLabelValues(WebsocketApplicationLayerProto.String()).Inc() &#125; else &#123; msg, op, err := wsutil.ReadClientData(c) if err != nil &#123; if _, ok := err.(wsutil.ClosedError); !ok &#123; log.Errorlog(log.NetServerErrorCategory&#123;Summary: fmt.Sprintf(\"[%s] receive ws message error: %v\", c.RemoteAddr().String(), err)&#125;) &#125; return gnet.Close &#125; log.Debugf(log.NetServerDebugCategory&#123;&#125;, \"conn[%v] receive [op=%v] [msg=%v]\", c.RemoteAddr().String(), op, string(msg)) if op == ws.OpText &#123; if rs := route.MatchRequestSpec(msg); rs == nil &#123; return route.GlobalWsRouter.DefaultHandler().ServeWebsocket(\"/\", msg, c, op) &#125; else &#123; return route.GlobalWsRouter.MatchHandler(rs.Path).ServeWebsocket(rs.Path, rs.Params, c, op) &#125; &#125; &#125;&#125; å‡çº§åè®®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°äº†github.com/gobwas/wsè¿™ä¸ªåè®®åº“ã€‚ æˆ‘ä»¬åœ¨æ¥å—åˆ°websocketå‰çš„æ—¶å€™éœ€è¦å…ˆå‡çº§ä¸ºwebsocketåè®®ï¼Œä½†æ˜¯è¿™é‡Œé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯åŒç†ï¼Œæˆ‘ä»¬çš„gnet.Connçš„æ•°æ®å·²ç»è¢«æˆ‘ä»¬å–å‡ºæ¥äº†ï¼Œè€Œå‡çº§çš„APIæ˜¾ç„¶å°±æ˜¯éœ€è¦æä¾›ä¸€ä¸ªå¯è¯»å¯å†™çš„IOã€‚ 1234// Upgrade is like Upgrader&#123;&#125;.Upgrade().func Upgrade(conn io.ReadWriter) (Handshake, error) &#123; return DefaultUpgrader.Upgrade(conn)&#125; 12345678910111213// ReadWriter is the interface that groups the basic Read and Write methods.type ReadWriter interface &#123; Reader Writer&#125;type Reader interface &#123; Read(p []byte) (n int, err error)&#125;type Writer interface &#123; Write(p []byte) (n int, err error)&#125; å› æ­¤ï¼Œæˆ‘ä»¬åˆéœ€è¦å®ç°ä¸€ä¸ªè‡ªå·±çš„wsConnBridgeå¯¹è±¡ï¼Œä¸»è¦æ˜¯å®ç°ä¸Šè¿°çš„æ¥å£ï¼Œä½†æ˜¯è¿™ä¸ªç»“æ„ä½“ç›¸å¯¹æ¥è¯´å°±æ¯”è¾ƒç®€å•äº†ï¼Œåˆ†åˆ«ä¿å­˜ä¹‹å‰æå‡ºæ¥çš„[]byteçš„bufferç”¨äºè¯»è¡Œä¸ºï¼Œå†ä¿å­˜ä¸€ä¸ªgnet.Connç”¨äºå†™è¡Œä¸ºå³å¯ã€‚ 123456789101112type wsConnBridge struct &#123; buff *bytes.Buffer c gnet.Conn&#125;func (w *wsConnBridge) Read(p []byte) (n int, err error) &#123; return w.buff.Read(p)&#125;func (w *wsConnBridge) Write(p []byte) (n int, err error) &#123; return w.c.Write(p)&#125; å‡çº§å®Œäº†ï¼Œæˆ‘ä»¬éœ€è¦ç»™å½“å‰çš„ä¸Šä¸‹æ–‡ç¯å¢ƒçš„Contextæ ‡è®°ä¸ºå·²ç»å‡çº§è¿æ¥å®Œæ¯•ã€‚ ç„¶åå°±æ˜¯è¿›å…¥åˆ°æ•°æ®çš„æ”¶å‘ç¯èŠ‚äº†ã€‚ github.com/gobwas/wsæä¾›äº†apiæ¥è¿›è¡Œæ•°æ®çš„æ”¶å‘ï¼Œåˆ†åˆ«æœ‰high-levelå’Œlow-levelï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬å¯ä¼˜å…ˆé€‰æ‹©high-level-apiï¼Œç„¶åè¯»å–æ•°æ®ã€‚ 123type WebsocketHandler interface &#123; ServeWebsocket(path string, data []byte, w io.Writer, op ws.OpCode) gnet.Action&#125; è¯»å–åˆ°æ•°æ®ä¹‹åï¼Œåˆå› ä¸ºæˆ‘éœ€è¦å’Œhttpçš„routeèƒ½æœ‰ä¸€ä¸ªé«˜åº¦åŒ¹é…çš„ä»£ç å†™æ³•ï¼Œæ‰€ä»¥åœ¨è·¯ç”±åŒ¹é…ä¸Šï¼Œä¹Ÿæ˜¯åšäº†ä¸€ä¸ªç±»ä¼¼çš„Matchçš„è¡Œä¸ºï¼Œç„¶åé€‰æ‹©åˆ°å¯¹åº”çš„Handlerï¼Œè§¦å‘ç»Ÿä¸€çš„ServeWebsocket()æ¥å£ï¼ˆä¸ºäº†å’Œhttpçš„ServeHttp()å¯¹åº”ï¼‰ã€‚ åˆ°æ­¤ï¼Œä»ç½‘ç»œå±‚åˆ°åº”ç”¨å±‚çš„ç«¯å£å¤ç”¨å®ç°å¤šåè®®åŸç†å°±åˆ°æ­¤ä¸ºæ­¢äº†ã€‚ æ¥ç€å°±æ˜¯å¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘æ•°æ®äº†ã€‚ ä¸šåŠ¡é€»è¾‘æ¦‚è¿° è®°å½•å®¢æœéœ€è¦ç›‘æ§çš„æ•°æ®è§„åˆ™å’Œè¿æ¥å…³è” kafka-clientä»ç›‘æ§è§„åˆ™ä¸­åŒ¹é…åˆé€‚çš„æ•°æ®ï¼Œæ¨é€åˆ°å¯¹åº”çš„fdä¸­ 123456789101112131415161718192021// ...var i int64 = 0var wg sync.WaitGroupListenChatRuleMap.Range(func(key, value interface&#123;&#125;) bool &#123; if Match(key.(string), kmsKey) &#123; wg.Add(1) go func(c gnet.Conn, wsp *WsSendPayload) &#123; defer wg.Done() err := wsutil.WriteServerMessage(c, ws.OpText, wsp.Json()) if err != nil &#123; log.Errorf(log.AppErrorCategory&#123;Summary: fmt.Sprintf(\"[wsWriteServerMessage failed] [err=%v]\", err)&#125;, \"[key=%s],[data=%s]\", key.(string), string(wsp.Json())) return &#125; atomic.AddInt64(&amp;i, 1) &#125;(value.(gnet.Conn), wsp) &#125; return true&#125;)wg.Wait()metrics.ChatLogCounterClientHistogram.WithLabelValues(strconv.FormatUint(uint64(lrc.Pid), 10), strconv.Itoa(wsp.ServerId), strconv.Itoa(wsp.AgentId)).Observe(float64(atomic.LoadInt64(&amp;i)))// ... è‡³æ­¤ï¼Œç½‘ç»œå±‚å’Œä¸šåŠ¡å±‚çš„æ‰€æœ‰éœ€æ±‚å¤§ä½“å·²ç»å®Œæ¯•äº†ã€‚ prometheus æŒ‡æ ‡éƒ¨åˆ†çš„æŒ‡æ ‡å¦‚ä¸‹ï¼Œåç»­å¯ä»¥é€šè¿‡ä¸€äº›æŒ‡æ ‡å¯¹æœåŠ¡çš„ç¨³å®šå’Œå¯é æ€§è¿›è¡Œä¼˜åŒ–å‡çº§å¤„ç†ã€‚ 12345678910111213141516171819202122232425262728293031323334# HELP chat_monitor_app_handle_chat_total Counter of handle.# TYPE chat_monitor_app_handle_chat_total counterchat_monitor_app_handle_chat_total&#123;agent_id=\"29\",app_id=\"19\",server_id=\"6558\"&#125; 3# HELP chat_monitor_net_client_recv_counter number of chat log for client# TYPE chat_monitor_net_client_recv_counter histogramchat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"1\"&#125; 0chat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"2\"&#125; 0chat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"4\"&#125; 2chat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"8\"&#125; 3chat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"16\"&#125; 3chat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"32\"&#125; 3chat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"64\"&#125; 3chat_monitor_net_client_recv_counter_bucket&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\",le=\"+Inf\"&#125; 3chat_monitor_net_client_recv_counter_sum&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\"&#125; 12chat_monitor_net_client_recv_counter_count&#123;agent_id=\"29\",pid=\"1643890670000002\",server_id=\"6558\"&#125; 3# HELP chat_monitor_net_current_connected Current Counter Gauge of ws-connected.# TYPE chat_monitor_net_current_connected gaugechat_monitor_net_current_connected 4# HELP chat_monitor_net_total_connected The Total Counter of connected.# TYPE chat_monitor_net_total_connected counterchat_monitor_net_total_connected&#123;type=\"http\"&#125; 15chat_monitor_net_total_connected&#123;type=\"websocket\"&#125; 5# HELP chat_monitor_server_error_total Counter of error.# TYPE chat_monitor_server_error_total counterchat_monitor_server_error_total&#123;type=\"network_server_error\"&#125; 1# HELP chat_monitor_server_gogc The value of GOGC# TYPE chat_monitor_server_gogc gaugechat_monitor_server_gogc 100# HELP chat_monitor_server_info Indicate the chat_monitor server info, and the value is the start timestamp (s).# TYPE chat_monitor_server_info gaugechat_monitor_server_info 1.644568978e+09# HELP chat_monitor_server_maxprocs The value of GOMAXPROCS.# TYPE chat_monitor_server_maxprocs gaugechat_monitor_server_maxprocs 6 åˆ°è¿™é‡Œï¼Œä¸€äº›åŸºç¡€è€Œæ ¸å¿ƒçš„é€»è¾‘ä¹Ÿä»‹ç»å®Œäº†ã€‚","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"TIDBæºç å‰–æï¼ˆä¸€ï¼‰","slug":"TIDB/TIDBæºç å‰–æï¼ˆä¸€ï¼‰","date":"2022-01-24T02:28:33.000Z","updated":"2022-01-25T03:01:50.165Z","comments":true,"path":"2022/01/24/TIDB/TIDBæºç å‰–æï¼ˆä¸€ï¼‰/","link":"","permalink":"http://blog.crazylaw.cn/2022/01/24/TIDB/TIDB%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/","excerpt":"ç®€ä»‹è¿™ä¸€ç« ï¼Œä½œä¸ºæˆ‘ä»¬çš„èµ·å§‹ç« èŠ‚ï¼Œè·Ÿç€æºç ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ç†Ÿæ‚‰TIDBçš„æ•´ä½“ä»£ç ç»“æ„","text":"ç®€ä»‹è¿™ä¸€ç« ï¼Œä½œä¸ºæˆ‘ä»¬çš„èµ·å§‹ç« èŠ‚ï¼Œè·Ÿç€æºç ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ç†Ÿæ‚‰TIDBçš„æ•´ä½“ä»£ç ç»“æ„ Selectå½“æˆ‘ä»¬æœ‰ä¸€æ¡åŸºæœ¬çš„sqlå¦‚ä¸‹ï¼š 1select * from mysql.user; æˆ‘ä»¬ä»æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¿æ¥å¼€å§‹ï¼Œæ‰§è¡Œï¼Œè§£æï¼Œé€»è¾‘ä¼˜åŒ–å™¨ï¼Œç‰©ç†ä¼˜åŒ–å™¨ï¼Œåˆ°æœ€ç»ˆç»“æœå¼€å§‹åˆ†æã€‚ 12345678910111213github.com&#x2F;pingcap&#x2F;tidb&#x2F;planner.optimize at optimize.go:335github.com&#x2F;pingcap&#x2F;tidb&#x2F;planner.Optimize at optimize.go:211github.com&#x2F;pingcap&#x2F;tidb&#x2F;executor.(*Compiler).Compile at compiler.go:77github.com&#x2F;pingcap&#x2F;tidb&#x2F;session.(*session).ExecuteStmt at session.go:1696github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*TiDBContext).ExecuteStmt at driver_tidb.go:220github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).handleStmt at conn.go:1977github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).handleQuery at conn.go:1846github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).dispatch at conn.go:1341github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*clientConn).Run at conn.go:1091github.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*Server).onConn at server.go:556runtime.goexit at asm_amd64.s:1371 - Async stack tracegithub.com&#x2F;pingcap&#x2F;tidb&#x2F;server.(*Server).startNetworkListener at server.go:453 ä¸Šé¢è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬è·Ÿç€è¿™ä¸€æ®µå †æ ˆæ¥è¿›è¡Œåˆ†æã€‚ github.com/pingcap/tidb/server.(*Server).onConn at server.go (è¿æ¥å¤„ç†é€»è¾‘)1conn.Run(ctx) è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¿™æ˜¯è¿›å…¥åˆ°äº†ä¸€ä¸ªclientConnçš„ Run æ–¹æ³•ã€‚ 1234567// Run reads client query and writes query result to client in for loop, if there is a panic during query handling,// it will be recovered and log the panic error.// This function returns and the connection is closed if there is an IO error or there is a panic.// åœ¨forå¾ªç¯ä¸­ï¼Œæ‰§è¡Œè¯»å–å®¢æˆ·ç«¯æŸ¥è¯¢ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœå†™å…¥å®¢æˆ·ç«¯ï¼Œå¦‚æœåœ¨å¤„ç†æŸ¥è¯¢æ—¶å‡ºç°panicï¼Œ// å®ƒå°†è¢«æ¢å¤å¹¶è®°å½•panicé”™è¯¯ã€‚// å¦‚æœå‡ºç°IOé”™è¯¯æˆ–panicï¼Œè¯¥å‡½æ•°è¿”å›å¹¶å…³é—­è¿æ¥ã€‚func (cc *clientConn) Run(ctx context.Context) è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†æœ‰ä¸€æ®µæ–‡å­—å¸®åŠ©æˆ‘ä»¬ç†è§£æ³¨æ„äº‹é¡¹ã€‚ æˆ‘ä»¬æŒ‰ç…§è¿‡ç¨‹å¼çš„é¡ºåºæ¥ä»ä¸Šå¾€ä¸‹çœ‹æºç  123456789101112131415161718192021 const size = 4096defer func() &#123; r := recover() if r != nil &#123; buf := make([]byte, size) stackSize := runtime.Stack(buf, false) buf = buf[:stackSize] logutil.Logger(ctx).Error(\"connection running loop panic\", zap.Stringer(\"lastSQL\", getLastStmtInConn&#123;cc&#125;), zap.String(\"err\", fmt.Sprintf(\"%v\", r)), zap.String(\"stack\", string(buf)), ) err := cc.writeError(ctx, errors.New(fmt.Sprintf(\"%v\", r))) terror.Log(err) metrics.PanicCounter.WithLabelValues(metrics.LabelSession).Inc() &#125; if atomic.LoadInt32(&amp;cc.status) != connStatusShutdown &#123; err := cc.Close() terror.Log(err) &#125;&#125;() è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å‡ ç‚¹ã€‚ é€šè¿‡ recover() æ–¹æ³•æ¥é˜»æ­¢panicå¼•èµ·çš„ç¨‹åºå¼‚å¸¸å´©æºƒï¼Œå¦‚æœæ˜¯panicçš„è¯ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰ä¸€æ®µç‰¹æ®Šçš„é€»è¾‘å¤„ç† 1.1 é€šè¿‡ runtime.Stack(buf,false) çš„ç¬¬äºŒä¸ªå‚æ•°æ¥æ§åˆ¶åªè·å–å½“å‰åç¨‹ä¸‹çš„å †æ ˆä¿¡æ¯ï¼Œå¹¶ä¸”å†™å…¥åˆ°bufå˜é‡ä¸­ 1.2 ç”±äº const size = 4096 çš„åŸå› ï¼Œæˆ‘ä»¬æ‹¿åˆ°çš„bufæœªå¿…æ˜¯é‚£ä¹ˆå¤šï¼Œå› æ­¤ï¼Œé€šè¿‡ buf[:stackSize] æ¥è¿›è¡Œåˆ‡ç‰‡å¤„ç†ï¼ŒæŠŠå˜é‡çš„æŒ‡é’ˆé‡æ–°æŒ‡å‘æ–°çš„æ•°æ®åŒºåŸŸ 1.3 é€šè¿‡æ—¥å¿—ç»„ä»¶æ¥è®°å½•è¯¦ç»†ä¿¡æ¯ï¼Œ æœ‰æ„æ€çš„æ˜¯ï¼Œè¿™é‡Œé€šè¿‡äº†getLastStmtInConnç»“æ„ä½“é‡Œé¢çš„String()æ–¹æ³•æ¥è¿›è¡Œåºåˆ—åŒ–è‡ªå·±æƒ³è¦çš„å†…å®¹ä¿¡æ¯ï¼Œå…¶ä»–çš„å°±æ˜¯åŸºæœ¬çš„err, stackçš„ä¿¡æ¯äº† 1.4 æˆ‘ä»¬ä¸å•å•éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šè®°å½•ä¿¡æ¯ï¼Œè¿˜è¦æŠŠå¯¹åº”çš„ç”¨æˆ·é”™è¯¯ä¿¡æ¯ä¹Ÿè®°å½•ä¸‹æ¥å¹¶ä¸”å‘é€ç»™å®¢æˆ·ç«¯ã€‚æ‰€ä»¥é€šè¿‡äº† err := cc.writeError(ctx, errors.New(fmt.Sprintf(&quot;%v&quot;, r))) æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ 1.5 ç„¶åå°±æ˜¯è®°å½•ç›¸å…³çš„metricsï¼Œå› ä¸ºå‘ç”Ÿäº†ä¸€æ¬¡ panicï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡PanicCounterè®°å½•ä¸‹æ¥ï¼Œç”¨äºç»Ÿè®¡ç”±äºsessionå¼•èµ·çš„panicæ€»å…±æœ‰å¤šå°‘æ¬¡ å¦‚æœæ˜¯épanicå¼•èµ·çš„å‡½æ•°ææ„ï¼Œé‚£ä¹ˆè¿˜è¦é€šè¿‡åŸå­æ€§è‰èµ°æ¥åˆ¤æ–­çŠ¶æ€æ˜¯å¦ä¸ºå…³é—­çŠ¶æ€ï¼Œå¦‚æœæ˜¯å…³é—­çŠ¶æ€ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°±éœ€è¦æŠŠè¿æ¥æ–­å¼€ï¼Œå¹¶ä¸”è®°å½•ä¸‹é”™è¯¯ä¿¡æ¯ 123456789101112131415161718// Usually, client connection status changes between [dispatching] &lt;=&gt; [reading].// When some event happens, server may notify this client connection by setting// the status to special values, for example: kill or graceful shutdown.// The client connection would detect the events when it fails to change status// by CAS operation, it would then take some actions accordingly.// é€šå¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯è¿æ¥çŠ¶æ€åœ¨[dispatching] &lt;=&gt; [reading]ä¹‹é—´å˜åŒ–ã€‚// å½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡è®¾ç½®æ¥é€šçŸ¥è¿™ä¸ªå®¢æˆ·ç«¯è¿æ¥// å°†çŠ¶æ€è®¾ç½®ä¸ºç‰¹æ®Šå€¼ï¼Œä¾‹å¦‚:killæˆ–graceful shutdownã€‚// å½“CASæ“ä½œæ”¹å˜çŠ¶æ€å¤±è´¥æ—¶ï¼Œå®¢æˆ·ç«¯è¿æ¥å°†æ£€æµ‹åˆ°äº‹ä»¶ï¼Œç„¶åé‡‡å–ç›¸åº”çš„åŠ¨ä½œã€‚for &#123; if !atomic.CompareAndSwapInt32(&amp;cc.status, connStatusDispatching, connStatusReading) || // The judge below will not be hit by all means, // But keep it stayed as a reminder and for the code reference for connStatusWaitShutdown. atomic.LoadInt32(&amp;cc.status) == connStatusWaitShutdown &#123; return &#125;...&#125; æˆ‘ä»¬çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªå¾ªç¯æ“ä½œï¼Œå¹¶ä¸”é€šè¿‡åŸå­æ€§æ“ä½œatomic.CompareAndSwapInt32ï¼ˆæ¯”è¾ƒç„¶åå†äº¤æ¢ï¼Œæ‰€ä»¥ç¬¦åˆCASåŸåˆ™ï¼Œä¹è§‚é”ï¼‰æ¥åˆ¤æ–­sessionè¿æ¥æ˜¯å¦èƒ½æ˜¯å¦èƒ½åˆ‡æ¢åˆ°connStatusDispatching =&gt; connStatusReading çŠ¶æ€ å¦‚æœä¸å¯ä»¥åˆ‡æ¢ï¼Œé‚£ä¹ˆåˆ™ç»“æŸè¯¥æ–¹æ³• å¦‚æœè¿æ¥çŠ¶æ€ä¸ºç­‰å¾…å…³é—­çŠ¶æ€ï¼Œé‚£ä¹ˆä¹Ÿç»“æŸè¯¥æ–¹æ³• å¯¹äºå…¶ä¸­çš„ ...ï¼Œç°åœ¨ä¼šåœ¨ä¸‹é¢è¿›ä¸€æ­¥è¯´æ˜ã€‚ 1234567891011121314151617181920212223242526cc.alloc.Reset()// close connection when idle time is more than wait_timeoutwaitTimeout := cc.getSessionVarsWaitTimeout(ctx)cc.pkt.setReadTimeout(time.Duration(waitTimeout) * time.Second)start := time.Now()data, err := cc.readPacket()if err != nil &#123; if terror.ErrorNotEqual(err, io.EOF) &#123; if netErr, isNetErr := errors.Cause(err).(net.Error); isNetErr &amp;&amp; netErr.Timeout() &#123; idleTime := time.Since(start) logutil.Logger(ctx).Info(\"read packet timeout, close this connection\", zap.Duration(\"idle\", idleTime), zap.Uint64(\"waitTimeout\", waitTimeout), zap.Error(err), ) &#125; else &#123; errStack := errors.ErrorStack(err) if !strings.Contains(errStack, \"use of closed network connection\") &#123; logutil.Logger(ctx).Warn(\"read packet failed, close this connection\", zap.Error(errors.SuspendStack(err))) &#125; &#125; &#125; disconnectByClientWithError.Inc() return&#125; cc.alloc.Reset()é‡ç½®å†…å­˜æ± å¤§å° å½“ç©ºé—²æ—¶é—´å¤§äºç­‰å¾…è¶…æ—¶æ—¶é—´çš„è¯é‚£ä¹ˆå°†ä¼šå…³é—­ä¸½è¿æ¥ã€‚cc.pkt.setReadTimeout(time.Duration(waitTimeout) * time.Second) ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼Œå¦‚æœå­˜åœ¨é”™è¯¯ï¼Œé‚£ä¹ˆå°†ä¼šè®°å½•ä¸‹æ¥ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚ä»è¯»å–æ•°æ®åˆ°æœ€åçš„æ—¶é—´ï¼Œæ¥ç»Ÿè®¡idletimeï¼Œé€šè¿‡metrics.DisconnectionCounter.WithLabelValues(metrics.LblError)æ¥è®°å½•å› ä¸ºerrå¯¼è‡´è¿æ¥æ–­å¼€çš„æ¬¡æ•° 123if !atomic.CompareAndSwapInt32(&amp;cc.status, connStatusReading, connStatusDispatching) &#123; return&#125; åŒç†ï¼Œç»è¿‡casä¹è§‚é”ï¼ŒæŠŠçŠ¶æ€ä» connStatusReading =&gt; connStatusDispatchingå¦‚æœï¼Œäº¤æ¢è®¾ç½®å¤±è´¥ï¼Œé‚£ä¹ˆå°±ç»“æŸå‡½æ•°ã€‚ 12startTime := time.Now()err = cc.dispatch(ctx, data) github.com/pingcap/tidb/server.(*clientConn).dispatch ï¼ˆåˆ†å‘é€»è¾‘ï¼‰1234567// dispatch handles client request based on command which is the first byte of the data.// It also gets a token from server which is used to limit the concurrently handling clients.// The most frequently used command is ComQuery.// dispatchæ ¹æ®å‘½ä»¤å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå‘½ä»¤æ˜¯æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚// å®ƒä¹Ÿä»æœåŠ¡å™¨è·å–ä¸€ä¸ªä»¤ç‰Œï¼Œç”¨äºé™åˆ¶å¹¶å‘å¤„ç†å®¢æˆ·ç«¯ã€‚// æœ€å¸¸ç”¨çš„å‘½ä»¤æ˜¯ComQueryã€‚func (cc *clientConn) dispatch(ctx context.Context, data []byte) error ä¸‹é¢çš„æ–¹æ³•éƒ½æ˜¯dispatchçš„è¿‡ç¨‹é¡ºåºé€»è¾‘ 12345678910defer func() &#123; // reset killed for each request atomic.StoreUint32(&amp;cc.ctx.GetSessionVars().Killed, 0)&#125;()t := time.Now()if (cc.ctx.Status() &amp; mysql.ServerStatusInTrans) &gt; 0 &#123; connIdleDurationHistogramInTxn.Observe(t.Sub(cc.lastActive).Seconds())&#125; else &#123; connIdleDurationHistogramNotInTxn.Observe(t.Sub(cc.lastActive).Seconds())&#125; è¿™é‡Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªdeferï¼Œå½“å‡½æ•°ç»“æŸçš„æ—¶å€™ï¼Œä¼šé‡ç½®sessionçš„Killedæ¬¡æ•° cc.ctx.Status() &amp; mysql.ServerStatusInTrans è¿™é‡Œå› ä¸ºå…¼å®¹äº†mysqlçš„æ— çŠ¶æ€åè®®ï¼Œæ‰€ä»¥é€šè¿‡ç¬¬ä¸€ä¸ªä½è¿ç®—æ¥åˆ¤æ–­å½“å‰çŠ¶æ€ å¦‚æœå½“å‰é“¾æ¥å¤„äºä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ä¸‹çš„è¯ï¼Œé‚£ä¹ˆé€šè¿‡connIdleDurationHistogramInTxn.Observe(t.Sub(cc.lastActive).Seconds()) ç”¨ç›´æ–¹å›¾ç›‘æ§ä»æœ€åä¸€æ¬¡æ´»è·ƒæ—¶é—´åˆ°å½“å‰åˆ†å‘æ—¶é—´ å¦åˆ™åˆ™ç”¨å¦ä¸€ä¸ªmetricsæ¥è®°å½• 1234567891011span := opentracing.StartSpan(\"server.dispatch\")cfg := config.GetGlobalConfig()if cfg.OpenTracing.Enable &#123; ctx = opentracing.ContextWithSpan(ctx, span)&#125;var cancelFunc context.CancelFuncctx, cancelFunc = context.WithCancel(ctx)cc.mu.Lock()cc.mu.cancelFunc = cancelFunccc.mu.Unlock() é€šè¿‡opentracingæ¥å¼€å§‹è¿›è¡Œåˆ†å¸ƒå¼è¿½è¸ªï¼Œcc.mu ä¸»è¦æ˜¯ç”¨æ¥åœ¨äº‹åŠ¡ä¸­å–æ¶ˆäº‹åŠ¡ç”¨çš„ã€‚ 1234567891011121314cc.lastPacket = datacmd := data[0]data = data[1:]if topsqlstate.TopSQLEnabled() &#123; defer pprof.SetGoroutineLabels(ctx)&#125;if variable.EnablePProfSQLCPU.Load() &#123; label := getLastStmtInConn&#123;cc&#125;.PProfLabel() if len(label) &gt; 0 &#123; defer pprof.SetGoroutineLabels(ctx) ctx = pprof.WithLabels(ctx, pprof.Labels(\"sql\", label)) pprof.SetGoroutineLabels(ctx) &#125;&#125; æŠŠå½“å‰sessionæ¥æ”¶åˆ°çš„æ•°æ®è®°å½•åœ¨lastPakcetä¸­ ç¬¬ä¸€ä¸ªå­—èŠ‚ä»£è¡¨å‘½ä»¤ åé¢çš„å­—èŠ‚ä»£è¡¨æ•°æ® 1234567891011token := cc.server.getToken()defer func() &#123; // if handleChangeUser failed, cc.ctx may be nil if cc.ctx != nil &#123; cc.ctx.SetProcessInfo(\"\", t, mysql.ComSleep, 0) &#125; cc.server.releaseToken(token) span.Finish() cc.lastActive = time.Now()&#125;() è¿™é‡Œéœ€è¦å…³æ³¨ä¸€ä¸‹deferé‡Œé¢çš„å†…å®¹ æ ¹æ®mysqlåè®®ï¼Œå½“å‘½ä»¤ä¸ºmysql.ComSleepçš„æ—¶å€™ï¼Œä»£è¡¨executeå·²ç»å®Œæˆäº†ã€‚æ‰€ä»¥å½“ç»“æŸçš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®ä¸€ä¸‹è¿™ä¸ªProcessInfo ç„¶åé‡Šæ”¾æœ¬æ¬¡tokenï¼Œå¹¶ä¸”spanä¹Ÿéœ€è¦æ ‡è®°ä¸ºå®Œæˆ æ›´æ–°æœ€åä¸€æ¬¡æ´»è·ƒæ—¶é—´ 123456vars := cc.ctx.GetSessionVars()// reset killed for each requestatomic.StoreUint32(&amp;vars.Killed, 0)if cmd &lt; mysql.ComEnd &#123; cc.ctx.SetCommandValue(cmd)&#125; è·å–å½“å‰sessionçš„å˜é‡ é‡ç½®å…¶ä¸­çš„killedå±æ€§ å¦‚æœcmdåœ¨èŒƒå›´å†…çš„ï¼Œæ›´æ–°å½“å‰å‘½ä»¤çš„å€¼ 12345678dataStr := string(hack.String(data))switch cmd &#123;case mysql.ComPing, mysql.ComStmtClose, mysql.ComStmtSendLongData, mysql.ComStmtReset, mysql.ComSetOption, mysql.ComChangeUser: cc.ctx.SetProcessInfo(\"\", t, cmd, 0)case mysql.ComInitDB: cc.ctx.SetProcessInfo(\"use \"+dataStr, t, cmd, 0)&#125; è¿™é‡Œåˆ©ç”¨äº†golangç§çš„hackï¼ˆé»‘ç§‘æŠ€ï¼‰çš„æ–¹å¼æ¥æŠŠbyteè½¬æ¢æˆstringï¼Œå…¶å®ä¸»è¦å°±æ˜¯å› ä¸ºåº•å±‚ç”¨çš„éƒ½æœ‰ä¸€æ ·çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡unsafe.pointeræ¥ç›´æ¥æ“ä½œå†…å®¹æŒ‡é’ˆï¼Œè¿›è¡Œzero-copy å¯¹cmdè¿›è¡Œprocessinfoçš„å¤„ç†ï¼Œå¦‚æœæ˜¯use dbçš„å‘½ä»¤çš„è¯ï¼Œåˆ™éœ€è¦ä¼ é€’æ•°æ®åº“ 12345678910111213141516171819202122232425switch cmd &#123; case mysql.ComSleep: // TODO: According to mysql document, this command is supposed to be used only internally. // So it's just a temp fix, not sure if it's done right. // Investigate this command and write test case later. return nil case mysql.ComQuit: return io.EOF case mysql.ComInitDB: if err := cc.useDB(ctx, dataStr); err != nil &#123; return err &#125; return cc.writeOK(ctx) case mysql.ComQuery: // Most frequently used command. // For issue 1989 // Input payload may end with byte '\\0', we didn't find related mysql document about it, but mysql // implementation accept that case. So trim the last '\\0' here as if the payload an EOF string. // See http://dev.mysql.com/doc/internals/en/com-query.html if len(data) &gt; 0 &amp;&amp; data[len(data)-1] == 0 &#123; data = data[:len(data)-1] dataStr = string(hack.String(data)) &#125; return cc.handleQuery(ctx, dataStr) ...&#125; è¿™é‡Œæˆ‘å¤åˆ¶äº†ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºæˆ‘ä»¬é‡ç‚¹å…³æ³¨mysql.ComQueryå‘½ä»¤ã€‚ æ ¹æ®æç¤ºï¼Œæˆ‘ä»¬å‘ç°å› ä¸ºmysqlåè®®è¯´æ˜äº†è¾“å…¥è½½ä½“å¯èƒ½ä»¥\\0ä½œä¸ºæœ€åå­—èŠ‚ï¼Œæ‰€ä»¥è¿™é‡Œä¸€å®šè¦å‡å»clientå‘é€çš„å¤šä½™çš„æœ€åä¸€ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥é•¿åº¦è¿›è¡Œäº†-1æ“ä½œ ç„¶åè¿›å…¥åˆ°cc.handleQuery(ctx, dataStr) github.com/pingcap/tidb/server.(*clientConn).handleQuery12345// handleQuery executes the sql query string and writes result set or result ok to the client.// As the execution time of this function represents the performance of TiDB, we do time log and metrics here.// There is a special query `load data` that does not return result, which is handled differently.// Query `load stats` does not return result either.func (cc *clientConn) handleQuery(ctx context.Context, sql string) (err error) è¿™ä¸ªæ–¹æ³•ï¼Œç»ˆäºå¼€å§‹æ­£å¼è¿›å…¥æˆ‘ä»¬çš„ä¸»é¢˜äº† 1234567891011defer trace.StartRegion(ctx, \"handleQuery\").End()sc := cc.ctx.GetSessionVars().StmtCtxprevWarns := sc.GetWarnings()stmts, err := cc.ctx.Parse(ctx, sql)if err != nil &#123; return err&#125;if len(stmts) == 0 &#123; return cc.writeOK(ctx)&#125; deferè¿›è¡Œäº†å½“å‡½æ•°ç»“æŸçš„æ—¶å€™ï¼Œæ ‡è®°handleQueryç»“æŸ æ‹¿åˆ°statementçš„ä¸Šä¸‹æ–‡ç¯å¢ƒ ä»ä¸Šä¸‹æ–‡ä¸­æ‹¿åˆ°æ‰€æœ‰çš„warinningè­¦å‘Š é€šè¿‡cc.ctx.Parse(ctx, sql)æ¥è¿›è¡Œè§£æsqlï¼Œè¿™é‡Œå±äºä¸€ä¸ªå¤§çš„ç¯‡ç« ï¼Œæš‚æ—¶ä¸å¼ å¼€è®²ï¼Œä¸»è¦æ¶‰åŠåˆ°çš„å†…å®¹æœ‰ç¼–è¯‘åŸç†,AST-Treeï¼ŒYaccã€‚æˆ‘ä»¬é€šè¿‡è¿™é‡Œå¯ä»¥æ‹¿åˆ°ä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘ï¼Œå®è´¨æ˜¯SelectStmtï¼Œå†…éƒ¨åŒ…å«äº†å¦‚ä¸‹å†…å®¹ï¼š dmlNodeï¼ˆå› ä¸ºselectè¯­å¥å±äºdmlè¯­å¥ï¼‰ å…¶ä»–çš„éƒ½æ˜¯å¸¸è§„çš„ä¾‹å¦‚FROM, WHERE, FIELDS, DISTINCT ç­‰ç­‰ å¦‚æœæ²¡æœ‰ä¸€ä¸ªå®Œæˆçš„æŠ½è±¡è¯­æ³•ä¹¦ï¼Œåˆ™ç›´æ¥è¿”å›å“åº”åè®®å’Œå¯¹åº”çš„å†…å®¹ 123456789101112131415161718192021222324252627282930var pointPlans []plannercore.Planif len(stmts) &gt; 1 &#123; // The client gets to choose if it allows multi-statements, and // probably defaults OFF. This helps prevent against SQL injection attacks // by early terminating the first statement, and then running an entirely // new statement. capabilities := cc.ctx.GetSessionVars().ClientCapability if capabilities&amp;mysql.ClientMultiStatements &lt; 1 &#123; // The client does not have multi-statement enabled. We now need to determine // how to handle an unsafe situation based on the multiStmt sysvar. switch cc.ctx.GetSessionVars().MultiStatementMode &#123; case variable.OffInt: err = errMultiStatementDisabled return err case variable.OnInt: // multi statement is fully permitted, do nothing default: warn := stmtctx.SQLWarn&#123;Level: stmtctx.WarnLevelWarning, Err: errMultiStatementDisabled&#125; parserWarns = append(parserWarns, warn) &#125; &#125; // Only pre-build point plans for multi-statement query pointPlans, err = cc.prefetchPointPlanKeys(ctx, stmts) if err != nil &#123; return err &#125;&#125; é€šè¿‡Sessionä¸­çš„varä¸­çš„ClientCapabilityçš„ä½è¿ç®—æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒmysql.ClientMultiStatementsï¼ˆå¤šsqlè¯­å¥ï¼‰ å¦‚æœsysvarä¹Ÿä¸æ”¯æŒMultiStatementMode,ä¹Ÿå°±æ˜¯variable.OffIntï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›err å¦‚æœæ²¡æœ‰èƒ½åŠ›æ”¯æŒclientå¤šstatementçš„è¯ï¼Œä½†æ˜¯varåˆå¼€å¯äº†çš„è¯ï¼Œç›®å‰å•¥äº‹ä¹Ÿæ²¡åš é»˜è®¤å°±æ˜¯ä¸æ”¯æŒï¼Œä½†æ˜¯ä¼šé€šè¿‡warnæ¥å±•ç¤ºç»™å®¢æˆ·ç«¯ åªæœ‰åœ¨å¤šstatementçš„åœºæ™¯ä¸‹é¢„å–ç›®æ ‡è®¡åˆ’å…³é”®å­— 12345678910111213141516171819202122232425for i, stmt := range stmts &#123; if len(pointPlans) &gt; 0 &#123; // Save the point plan in Session, so we don't need to build the point plan again. cc.ctx.SetValue(plannercore.PointPlanKey, plannercore.PointPlanVal&#123;Plan: pointPlans[i]&#125;) &#125; retryable, err = cc.handleStmt(ctx, stmt, parserWarns, i == len(stmts)-1) if err != nil &#123; if !retryable || !errors.ErrorEqual(err, storeerr.ErrTiFlashServerTimeout) &#123; break &#125; _, allowTiFlashFallback := cc.ctx.GetSessionVars().AllowFallbackToTiKV[kv.TiFlash] if !allowTiFlashFallback &#123; break &#125; // When the TiFlash server seems down, we append a warning to remind the user to check the status of the TiFlash // server and fallback to TiKV. warns := append(parserWarns, stmtctx.SQLWarn&#123;Level: stmtctx.WarnLevelError, Err: err&#125;) delete(cc.ctx.GetSessionVars().IsolationReadEngines, kv.TiFlash) _, err = cc.handleStmt(ctx, stmt, warns, i == len(stmts)-1) cc.ctx.GetSessionVars().IsolationReadEngines[kv.TiFlash] = struct&#123;&#125;&#123;&#125; if err != nil &#123; break &#125; &#125;&#125; å¦‚æœæœ‰ç›®æ ‡è®¡åˆ’çš„è¯ï¼Œé‚£ä¹ˆåªéœ€è¦åœ¨ä¸Šä¸‹æ–‡ä¸­è®¾ç½®valueå³å¯ï¼Œä¸éœ€è¦å†æ¬¡æ„å»ºç›®æ ‡è®¡åˆ’ cc.handleStmt(ctx, stmt, parserWarns, i == len(stmts)-1) è¿™æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼Œè¿™é‡Œé¢å°±æ˜¯å¤„ç†æŠ½è±¡è¯­æ³•æ ‘çš„é€»è¾‘ï¼ŒåŒ…å«äº†é€»è¾‘ä¼˜åŒ–, ç‰©ç†ä¼˜åŒ–, æ‰§è¡Œå™¨ï¼Œtikväº¤äº’ç­‰ç­‰ todoï¼šç•™ç€å›æ¥åˆ†æ github.com/pingcap/tidb/server.(*clientConn).handleStmt12345// The first return value indicates whether the call of handleStmt has no side effect and can be retried.// Currently, the first return value is used to fall back to TiKV when TiFlash is down.// ç¬¬ä¸€ä¸ªè¿”å›å€¼è¡¨ç¤ºè°ƒç”¨handleStmtæ˜¯å¦æ²¡æœ‰å‰¯ä½œç”¨ï¼Œæ˜¯å¦å¯ä»¥é‡è¯•// å½“å‰ï¼Œç¬¬ä¸€ä¸ªè¿”å›å€¼ç”¨äºåœ¨TiFlash downæ—¶å›è½åˆ°TiKVfunc (cc *clientConn) handleStmt(ctx context.Context, stmt ast.StmtNode, warns []stmtctx.SQLWarn, lastStmt bool) (bool, error) 12345ctx = context.WithValue(ctx, execdetails.StmtExecDetailKey, &amp;execdetails.StmtExecDetails&#123;&#125;)ctx = context.WithValue(ctx, util.ExecDetailsKey, &amp;util.ExecDetails&#123;&#125;)reg := trace.StartRegion(ctx, \"ExecuteStmt\")cc.audit(plugin.Starting)rs, err := cc.ctx.ExecuteStmt(ctx, stmt) ä¸Šä¸‹æ–‡å¸¦ä¸Švalueï¼Œè®¾ç½®ä¸»è¦æ˜¯StmtExecDetailsï¼Œé‡Œé¢è®°å½•äº†å†™å…¥sqlåˆ°å“åº”çš„æ—¶é—´ ä¸Šä¸‹æ–‡å¸¦ä¸Švalueï¼Œè®¾ç½®ä¸»è¦æ˜¯ExecDetailsï¼Œé‡Œé¢è®°å½•äº†executionçš„è¯¦æƒ…ä¿¡æ¯ï¼Œåˆ†åˆ«æœ‰","categories":[{"name":"TIDB","slug":"TIDB","permalink":"http://blog.crazylaw.cn/categories/TIDB/"}],"tags":[{"name":"TIDB","slug":"TIDB","permalink":"http://blog.crazylaw.cn/tags/TIDB/"}]},{"title":"2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“","slug":"2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“","date":"2022-01-19T06:38:06.000Z","updated":"2022-02-05T06:14:45.964Z","comments":true,"path":"2022/01/19/2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“/","link":"","permalink":"http://blog.crazylaw.cn/2022/01/19/2022%E6%9D%82%E4%B9%B1%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/","excerpt":"ç®€ä»‹è®°å½•ä¸€ä¸‹å¸¸è§„ä¸‹çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚","text":"ç®€ä»‹è®°å½•ä¸€ä¸‹å¸¸è§„ä¸‹çš„ä¸€äº›çŸ¥è¯†ç‚¹ã€‚ Gogo channel closeåè¯»çš„é—®é¢˜","categories":[{"name":"çŸ¥è¯†ç‚¹","slug":"çŸ¥è¯†ç‚¹","permalink":"http://blog.crazylaw.cn/categories/%E7%9F%A5%E8%AF%86%E7%82%B9/"}],"tags":[{"name":"2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“","slug":"2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“","permalink":"http://blog.crazylaw.cn/tags/2022%E6%9D%82%E4%B9%B1%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"}]},{"title":"ã€2021ã€‘ 2021å¹´ç»ˆæ€»ç»“","slug":"2021å¹´ç»ˆæ€»ç»“","date":"2022-01-02T15:54:00.000Z","updated":"2022-01-25T03:01:32.272Z","comments":true,"path":"2022/01/02/2021å¹´ç»ˆæ€»ç»“/","link":"","permalink":"http://blog.crazylaw.cn/2022/01/02/2021%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/","excerpt":"å‰è¨€2021å·²ç»è¿‡å»äº†ï¼Œåœ¨è¿™é‡Œå›å¿†ä¸€ä¸‹ï¼Œæˆ‘çš„2021çš„å¹´ç»ˆæ€»ç»“ã€‚","text":"å‰è¨€2021å·²ç»è¿‡å»äº†ï¼Œåœ¨è¿™é‡Œå›å¿†ä¸€ä¸‹ï¼Œæˆ‘çš„2021çš„å¹´ç»ˆæ€»ç»“ã€‚ å›°éš¾ä¸æŒ‘æˆ˜å·¥ä½œä¸­ï¼Œåœ¨è¿‡å»çš„ä¸€å¹´é‡Œï¼Œè¿æ¥äº†ä¸å°‘çš„æŒ‘æˆ˜ï¼Œåœ¨å…¬å¸ä¸­è½åœ°å¤§æ•°æ®ç›¸å…³çš„æœåŠ¡äº†ä»erlangåˆ°golangçš„è½¬æ¢ã€‚æˆ‘ä»¬æ•´å¥—æ–°çš„ä½“ç³»ç§°ä¸ºï¼šmfeilog åœ¨å…¬å¸ä¸­ï¼Œç§¯ç´¯äº†è®¸å¤šgoè¯­è¨€çš„ç»„ä»¶ï¼Œå¹¶ä¸”ä¸æ–­çš„å®Œå–„ä¿®å¤ç›¸å…³çš„bugï¼Œä¾‹å¦‚ï¼Œmfeilogçš„æ ¸å¿ƒæ•°æ®æºï¼šmsourceï¼Œmfeilogçš„åŸºç¡€ç»„ä»¶ï¼šdaemonç»„ä»¶/no-named-pipeç»„ä»¶ï¼Œlogbdevç»„ä»¶ï¼Œsink_mysql/sink_kafkaç­‰ç»„ä»¶ã€‚ è¯´åˆ°è¿™ä¸ªmsourceæœåŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäºrocksdbå®ç°çš„æ”¯æŒsqlè¯­æ³•çš„è½»é‡çº§å°å‹å®šåˆ¶æ•°æ®åº“æœåŠ¡ï¼Œå¯ä»¥è¯´æ˜¯ç»è¿‡äº†ä¸æ–­ä¼˜åŒ–ï¼Œå‡çº§ï¼Œä¿®å¤å†…éƒ¨å„ç§å†…ç½®åŠŸèƒ½ï¼Œæ‰å¾—ä»¥ç°åœ¨çš„ç¨³å®šå’Œé«˜æ•ˆã€‚ç»™åº”ç”¨å±‚æä¾›äº†ä¸€ä¸ªé«˜å¯é ï¼Œç¨³å®šï¼Œçš„æ•°æ®æºåŠŸèƒ½ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªbugï¼Œå°è±¡ç‰¹åˆ«æ·±åˆ»ï¼Œä¹Ÿæ˜¯æˆ‘å§‹æ–™æœªåŠçš„ä¸€ä¸ªbugï¼Œå› ä¸ºå‘å·å™¨æ˜¯é™„å±åœ¨Tableå½“ä¸­çš„ï¼Œæˆ‘éœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åå­˜å‚¨åœ¨åº•å±‚çš„rocksdbä¸­ï¼Œæ‰€ä»¥åœ¨æˆ‘ååºåˆ—åŒ–å‡ºæ¥çš„æ—¶å€™ï¼Œå¯åŠ¨äº†å¤šä¸ªå‘å·å™¨ï¼Œå¯¼è‡´æ¯ä¸ªfield-colunméƒ½å®ä¾‹åŒ–äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€ŒéåŒä¸€ä¸ªå¯¹è±¡ï¼Œå¼•å‘äº†å‘å·å™¨é”™ä¹±ï¼Œä»è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜(å†…å­˜è¢«è¦†ç›–ï¼Œé”™è¯¯ackæ‰äº†æ•°æ®)ã€‚è¿™ä¸ªé—®é¢˜æ’æŸ¥ä¹Ÿæ˜¯ååˆ†ä¸æ˜“ï¼ï¼ï¼æ‰€ä»¥å¯ä»¥è¯´æ˜¯è¡€çš„æ•™è®­ã€‚ å¹¶ä¸”ä¹Ÿä¸ºå…¬å¸æ¨å¹¿ â€œæœåŠ¡å™¨æ—¥å¿—æŸ¥è¯¢æ–¹æ¡ˆâ€ ä¸­ï¼Œç¡®å®šäº†ä»¥GPLï¼ˆgrafna+protomal+lokiï¼‰çš„æ—¥å¿—æŸ¥è¯¢æ¶æ„ï¼Œç»Ÿä¸€äº†æ—¥å¿—æŸ¥è¯¢çš„å…¥å£ï¼Œå¤§å¤§æé«˜äº†æ—¥å¿—æŸ¥è¯¢çš„æ•ˆç‡ã€‚ åœ¨ goæœåŠ¡æµé‡å½•åˆ¶å’Œå›æ”¾æ–¹æ¡ˆå’Œå®ç° ä¸­ï¼Œä¸ºäº†å®ç°æµé‡é—­ç¯ï¼Œç‰¹æ„å»è°ƒç ”æŸ¥çœ‹äº† æ»´æ»´çš„ ã€Šå†™è½®çœ¼ã€‹é¡¹ç›®ï¼Œå¹¶ä¸”çŸ¥é“äº†é€šè¿‡ç±»ä¼¼æ³¨å…¥çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨ç”¨æˆ·å±‚ç¼–è§£ç ä¸Šæ›¿æ¢åˆ°åŸæ¥çš„å‡½æ•°æŒ‡é’ˆï¼Œä»è€Œå®ç°åœ¨ç”¨æˆ·å±‚æ›¿æ¢goåº•å±‚æºç çš„æ–¹å¼ï¼Œä½†æ˜¯ç”±äºæ€§ä»·æ¯”é—®é¢˜ï¼Œåœ¨å…¬å¸ä¸­æœ€åå¹¶æœªæ¨å¹¿ï¼Œä¹Ÿæ²¡æœ‰è¿›è¡Œç ”å‘ã€‚è¯¥éœ€æ±‚åé¢è¢«æç½®äº†ã€‚ åœ¨ é…ç½®æœåŠ¡æ–¹æ¡ˆ ä¸­ï¼Œè¿™ä¸ªéœ€æ±‚åœ¨ä»¥å¾€å…¶å®å·²ç»è¯•è¿‡æ‰ç”¨consuleæ¥åšé…ç½®æœåŠ¡ä¸­å¿ƒï¼ŒåŸå› æ˜¯æ—©æœŸæˆ‘ä»¬æƒ³è¦å¯¹æœåŠ¡åšä¸€ä¸ªæœåŠ¡æ³¨å†Œå’Œå‘ç°ï¼Œåœ¨ php è¿™ç§fastcgiçš„æ–¹å¼æ¥è¯´ï¼Œconsuleçš„ä¸»åŠ¨å‘ç°æœåŠ¡ï¼Œå°±æ¯”å¾ˆå¤šç±»ä¼¼etcdè¢«åŠ¨å‘ç°æ³¨å†ŒæœåŠ¡å¥½ç”¨ã€‚ä½†æ˜¯ç”±äºæœ€ç»ˆå› ä¸ºæˆ‘ä»¬çš„æœåŠ¡ç›®å‰æ¥è¯´æ¯”è¾ƒé›¶æ•£ï¼Œå¹¶ä¸”éœ€æ±‚çš„ä»»åŠ¡ä¸æ˜¯ç€æ€¥ï¼Œè¿™ä»¶äº‹åé¢ä¹Ÿè¢«æç½®äº†ï¼Œåé¢ä»Šå¤©å†æ¬¡æäº†ä¸€ä¸ªè¿™æ ·å­çš„ç±»ä¼¼çš„éœ€æ±‚ï¼Œå®ç°äº†é€šè¿‡ goè¯­è¨€å†™çš„çš„å·¥å…·ï¼Œç±»ä¼¼äºk8sçš„kubectlçš„å·¥å…·ï¼Œè¿›è¡Œé…ç½®çš„åŒæ­¥å’Œç®¡ç†ï¼Œåˆ†åˆ«åˆ†ä¸ºäº†2ä¸ªæ¨¡å¼ï¼Œä¸€ä¸ªæ˜¯Cç«¯çš„å·¥å…·ï¼Œä¸€ä¸ªæ˜¯Sç«¯çš„åŒæ­¥æœåŠ¡ï¼Œä¸­é—´çš„æ¢çº½ï¼Œæœ€ç»ˆé€‰æ‹©äº†ä»¥etcdä¸ºé…ç½®åˆ†å¸ƒå¼å­˜å‚¨æœåŠ¡ã€‚æˆ‘ä»¬æœåŠ¡çš„éƒ¨ç½²ç‰¹ç‚¹ï¼Œåˆ©ç”¨jenkinsçš„å¤šé˜¶æ®µè‡ªå®šä¹‰ç¼–è¯‘çš„jenkins-shared-libraryå®ç°äº†çµæ´»ç¼–è¯‘ï¼Œæ ¹æ®ç°æœ‰çš„æœåŠ¡çµæ´»éƒ¨ç½²ï¼Œä»è€Œè¾¾åˆ°éåµŒå…¥å¼çš„é…ç½®åŒæ­¥æ–¹å¼ã€‚ å› ä¸ºå…¬å¸æˆç«‹å¾—æ¯”è¾ƒæ—©ï¼Œä»£ç ä»“åº“ä¸€ç›´ä»æœªè¿›è¡Œå˜æ›´ï¼Œæ‰€ä»¥å…¶ä¸­ä¸€ä¸ªéœ€æ±‚å°±æ˜¯ gitbucket åˆ° gitlab çš„ä»£ç ä»“åº“è¿ç§»ï¼Œå†™äº†ä¸€ä¸ªå°å·¥å…·ï¼Œä»è€Œå®ç°äº†ä» gitbucketåˆ° gitlabä¸€é”®è‡ªåŠ¨åŒ–æ— ç¼è¿ç§»ä»£ç ï¼ŒåŒ…æ‹¬é¡¹ç›®ç»„ï¼Œé¡¹ç›®çš„å†å²commitï¼Œtagï¼Œbranchç­‰ç­‰éƒ½è‡ªåŠ¨åŒ–å®Œæˆï¼Œå¤§å¤§å‡è½»äº†é¡¹ç›®è¿ç§»çš„è´Ÿæ‹…ã€‚ å¯¹ jenkins çš„shard-library æ¨¡å—è¿›è¡Œä¼˜åŒ–å‡çº§ï¼Œç¼–å†™äº†ä¸€ä¸ªpythonçš„æ”¯æŒå¤šå‡­æ®è®¤è¯çš„è„šæœ¬ï¼Œå¹¶ä¸”æ”¯æŒè‡ªå®šä¹‰ç¼–è¯‘ä»£ç ã€‚ é›†æˆäº†ä¸€å¥—ï¼Œæœ¬åœ°çš„å¤§æ•°æ®dockerç¯å¢ƒï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å¤§æ•°æ®ç¯å¢ƒååˆ†çš„ç¹æ‚ï¼Œå¹¶ä¸”è¿˜éœ€è¦å¤šå°æœºå™¨æ‰èƒ½å¤„ç†ï¼Œè¿™å¯¹æˆ‘ä»¬æœ¬åœ°å¼€å‘æ¥è¯´ååˆ†çš„ä¸å‹å¥½ï¼Œä½†æ˜¯ç½‘ä¸Šåˆæ²¡æœ‰é‚£äº›å¾ˆå¥½çš„å¼€ç®±å³ç”¨çš„docker-composeç¯å¢ƒï¼Œå› æ­¤æ•´ç†äº†ä¸€å¥—æœ¬åœ°çš„å¤§æ•°æ®dockerç¯å¢ƒ(éCDHç‰ˆæœ¬) ä¼˜åŒ–å‡çº§éƒ¨åˆ† mproxy çš„ä»£ç ï¼Œä»è€Œè®©æµ‹è¯•äººå‘˜æ›´å‹å¥½çš„åœ¨è¯¥é¡¹ç›®ä¸­å®Œæˆè‡ªåŠ¨åŒ–æµ‹è¯•çš„è„šæœ¬åŠŸèƒ½ã€‚ æ¨åŠ¨flinkçš„è½åœ°ï¼Œç”±äºæˆ‘ä»¬æ—©æœŸçš„æµè®¡ç®—ï¼Œæ˜¯å•æœºçš„ï¼Œå¹¶ä¸”å­˜åœ¨ä¸¥é‡çš„å¤–éƒ¨ä¾èµ–å±æ€§ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬æ¨åŠ¨äº†flinkçš„è½åœ°ï¼Œæ¢ç©¶äº†å‡ ç§å¼€å‘æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ç”¨çº¯java å†™çš„datastream-apiæ–¹å¼ï¼Œè¿™ä¸ªæ–¹å¼æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯ï¼Œæ‰€æœ‰çš„ä¸Šå±‚çš„apiéƒ½æ˜¯åŸºäºdatastreamçš„ï¼Œä¸€äº›ä¸Šå±‚çš„apiæ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬é€šè¿‡datastreamå¯ä»¥å¾ˆè½»æ¾çš„å®ç°å„ç±»éœ€æ±‚ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘è¸©äº†ä¸å°‘çš„å‘ï¼Œä¸»è¦æ˜¯æ¥è‡ªäºwatermarkå’Œwindowçš„æ¦‚å¿µï¼Œå’‹ä¸€çœ‹å…¶å®éƒ½æ˜¯ä¸€äº›æ¯”è¾ƒå¥½ç†è§£çš„æ¦‚å¿µï¼Œä½†æ˜¯å…¶å®åœ¨é…åˆå¤§æ•°æ®ä¸“ç”¨çš„kafkaæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œä¸€åˆ‡å°±å˜å¾—å¤æ‚èµ·æ¥ï¼Œç”±äºkafkaçš„partitionåªèƒ½æœ‰ä¸€ä¸ªclientå»æ¶ˆè´¹çš„åŸå› ï¼ŒåŠ ä¸Šflinkè‡ªèº«çš„æ¦‚å¿µå¹¶è¡Œåº¦ï¼Œè¿™ä¸€åˆ‡ç»“åˆåœ¨ä¸€èµ·ï¼Œå°±ä¼šå‡ºç°ä¸€äº›è®©ä½ ç–‘æƒ‘çš„ç‚¹ã€‚ç»è¿‡äº†å¤§é‡åå¤çš„æ‘¸ç´¢å’Œé’»ç ”ï¼Œæœ€ç»ˆæ‰æŒæ¡äº†åœ¨å¤špartitionä¸‹flinkçš„watermarkå’Œwindow-triggeræœºåˆ¶æ–¹å¼ï¼Œä½†æ˜¯ç”±äºè¯¥æ–¹å¼ä¸å¤Ÿç›´è§‚ï¼Œä¹Ÿä¸ç®¡çµæ´»ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€ç»ˆæ¨å¹¿äº†sql-apiã€‚å¥½å®¶ä¼™ï¼Œä½ ä»¥ä¸ºè¿™å°±å®Œäº†å—ï¼Œå¹¶æ²¡æœ‰ï¼Œç”±äºflinkè‡ªèº«å¸¦æœ‰sql-clientçš„åŸå› ï¼Œæˆ‘ä¸€å¼€å§‹å°è¯•äº†ç”¨sql-clientæ¥ç¼–å†™æµè®¡ç®—çš„æ¨¡å‹ï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªå·¥å…·æœ‰å¤ªå¤šé—®é¢˜äº†ï¼Œä¸åŒçš„ç‰ˆæœ¬æœ‰ä¸ç”¨çš„è°ƒç”¨æ–¹å¼ï¼Œä¸åŒç‰ˆæœ¬ä¸‹ï¼Œå¯¹äºSETæ”¯æŒçš„ç²’åº¦ä¹Ÿæ˜¯ä¸ä¸€è‡´çš„ï¼Œè¿™è®©æˆ‘å¾ˆå¤´ç–¼ã€‚æ‰€ä»¥æœ€ç»ˆé€‰æ‹©äº†ï¼ŒåŸºäºflinkç¼–å†™äº†ä¸€ä¸ªè‡ªç ”çš„flink-sql-clientï¼Œé€šè¿‡flink run flink-sql-client.jarçš„æ–¹å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½»æ¾çš„æäº¤sqlä»»åŠ¡æˆ–è€…åšå…¶ä»–çš„éœ€æ±‚ï¼ˆä¾‹å¦‚æŸ¥çœ‹hiveçš„cataglogç­‰ç­‰ï¼‰ã€‚ç„¶è€Œåˆ°äº†è¿™é‡Œè¿˜æ²¡æœ‰ç»“æŸï¼Œç”±äºsqlçš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ²¡åŠæ³•æ§åˆ¶ï¼Œæ˜¯ç”±flink-coreè‡ªèº«æ ‡å‡†åŒ–äº†æµç¨‹ï¼Œæ‰€ä»¥æœ‰ä¸€äº›bugæˆ‘ä»¬æ²¡åŠæ³•è§£å†³ï¼Œä¾‹å¦‚åœ¨ flink-1.12.0 ç§ï¼Œå°±ä¼šå› ä¸ºwatermarkåœ¨idleçš„æƒ…å†µä¸‹ï¼Œæ— æ³•æ¨è¿›watermarkï¼Œä»è€Œå¯¼è‡´çª—å£åœ¨å°‘é‡æ•°æ®æƒ…å†µä¸‹ï¼Œæ ¹æœ¬ä¸èƒ½åŠæ—¶çš„ç»Ÿè®¡å’Œè®¡ç®—ï¼ˆè¿™å’Œå·ç§°å®æ—¶åˆ†æçš„æµè®¡ç®—è¿èƒŒï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½æƒ³äº†ä¸€äº›ç‰ˆæœ¬åšäº†ä¸€äº›è¿‚å›çš„æ“ä½œã€‚ä»è€Œæœ€ç»ˆè§£å†³ç±»ä¼¼è¿™ç§ç”±äºåº•å±‚bugæ‰€å¸¦æ¥çš„é—®é¢˜ã€‚ è‡ªå·±çš„å­¦ä¹ ä¸Š å¯¹golangçš„protobufæœåŠ¡æœ‰ä¸€äº›çš„äº†è§£ï¼Œå¹¶ä¸”å­¦ä¼šäº†protobufçš„æ’ä»¶å¼€å‘ã€‚äº†è§£äº†protobufçš„åè®®ã€‚ å¯¹rustä¸Šçš„ç”Ÿæ€æ›´ä¸ºæ¸…æ™°äº†ï¼Œåˆ©ç”¨äº†å…¶ä¸­çš„ä¸€äº›actoræ¨¡å‹ï¼Œasync-ioç­‰åˆ†åˆ«å®ç°äº†ä¸€äº›åŸºç¡€çš„å·¥å…·ã€‚ å¯¹flutterä¹Ÿæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œåˆ©ç”¨dartç¼–å†™äº†ä¸€ä¸ªå¯ä»¥ç”¨äºè‡ªå®šä¹‰é€šä¿¡çš„åº“ã€‚s å¯¹linux ç§çš„ä¸€äº›ç£ç›˜ioï¼Œç½‘ç»œioï¼Œå·²ç»shellå‘½ä»¤çš„çµæ´»è¿ç”¨æ›´åŠ æ·±åˆ»ã€‚ æœªå®Œå¾…ç»­ï¼ï¼ (æ‚„å’ªå’ªçš„å‘Šè¯‰å¤§å®¶ï¼Œæˆ‘ä¹°æˆ¿äº†ã€‚å˜¿å˜¿)","categories":[{"name":"å¹´ç»ˆæ€»ç»“","slug":"å¹´ç»ˆæ€»ç»“","permalink":"http://blog.crazylaw.cn/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"}],"tags":[{"name":"å¹´ç»ˆæ€»ç»“","slug":"å¹´ç»ˆæ€»ç»“","permalink":"http://blog.crazylaw.cn/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- flinkå¼€å‘ç¯å¢ƒæ­å»º","slug":"å¤§æ•°æ®/flinkå¼€å‘ç¯å¢ƒæ­å»º","date":"2021-09-28T01:56:40.000Z","updated":"2021-09-28T09:10:18.184Z","comments":true,"path":"2021/09/28/å¤§æ•°æ®/flinkå¼€å‘ç¯å¢ƒæ­å»º/","link":"","permalink":"http://blog.crazylaw.cn/2021/09/28/%E5%A4%A7%E6%95%B0%E6%8D%AE/flink%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/","excerpt":"å‰è¨€ç”±äºæœ€è¿‘è¦æ¨åŠ¨flinkçš„æµè®¡ç®—ä»£æ›¿æˆ‘ä»¬çš„å†…éƒ¨çš„è‡ªè¡Œç ”å‘çš„mstreamæµè®¡ç®—æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦å¯¹flinkè¿›è¡Œå¼€å‘ã€‚","text":"å‰è¨€ç”±äºæœ€è¿‘è¦æ¨åŠ¨flinkçš„æµè®¡ç®—ä»£æ›¿æˆ‘ä»¬çš„å†…éƒ¨çš„è‡ªè¡Œç ”å‘çš„mstreamæµè®¡ç®—æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦å¯¹flinkè¿›è¡Œå¼€å‘ã€‚ ç¯å¢ƒæ­å»ºæˆ‘ä»¬çš„flinkçš„ç‰ˆæœ¬ä¸Š1.12.0 ç†è®ºä¸Šåªæ˜¯jdk8å’Œjdk11.æ‰€ä»¥æˆ‘ä»¬éœ€è¦å®‰è£…jdk8å’Œjdk8 å› ä¸ºæˆ‘çš„æ˜¯macOSï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘è¯´ä¸€ä¸‹macå®‰è£…çš„è¿‡ç¨‹ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…jdkã€‚ 123brew tap adoptopenjdk/openjdkbrew install adoptopenjdk8brew install adoptopenjdk11 ç½®äºè¦ç”¨jdk8è¿˜æ˜¯jdk11ï¼Œè‡ªè¡ŒæŠ‰æ‹©ï¼Œæˆ‘è¿™é‡Œ2ä¸ªéƒ½å®‰è£…äº†ã€‚ ä½†æ˜¯è¿™ä¸ªæ—¶å€™ä½ å¯èƒ½ä¼šæ‰¾ä¸åˆ°å®‰è£…è·¯å¾„ 12345âœ ~ /usr/libexec/java_home -VMatching Java Virtual Machines (3): 11.0.12 (x86_64) \"Oracle Corporation\" - \"Java SE 11.0.12\" /Library/Java/JavaVirtualMachines/jdk-11.0.12.jdk/Contents/Home 11.0.11 (x86_64) \"AdoptOpenJDK\" - \"AdoptOpenJDK 11\" /Library/Java/JavaVirtualMachines/adoptopenjdk-11.jdk/Contents/Home 1.8.0_292 (x86_64) \"AdoptOpenJDK\" - \"AdoptOpenJDK 8\" /Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home é€šè¿‡/usr/libexec/java_home -Vå†…ç½®çš„ä¸€ä¸ªç¨‹åºï¼Œå°±å¯ä»¥æ‰¾åˆ°æ‰€æœ‰ç›¸å…³çš„java_homeï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å¯¹åº”çš„java_homeï¼Œç„¶åæ‰¾åˆ°å¯¹åº”çš„javaè§£æå™¨ã€‚ IDEåˆå§‹åŒ–é¡¹ç›®æˆ‘è¿™é‡Œç”¨çš„æ˜¯IDEAï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œåˆ—ä¸€ä¸‹æˆ‘çš„æ“ä½œæ­¥éª¤ã€‚ New Projectå…ˆæŠŠMavenåŒ…çš„è·¯å¾„ç¡®å®šä¸‹æ¥ã€‚åé¢åˆ©ç”¨docker-mavenå·¥å…·çš„æ—¶å€™ï¼ŒæŒ‡å®šæŒ‚è½½ä»“åº“æœ‰ç”¨ã€‚ å¼€å§‹åˆ›å»ºé¡¹ç›® é€‰æ‹©ä½¿ç”¨Mavenæ¥åˆ›å»ºé¡¹ç›®ï¼Œå¹¶ä¸”é€‰æ‹©åˆšæ‰å®‰è£…å¥½çš„JDK8æˆ–è€…JDK11ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ä¸å¸¦archetypeçš„ï¼Œè¿™ä¸ªæ˜¯Mavenæ¨¡æ¿çš„ç±»å‹ã€‚æˆ‘ä»¬éœ€è¦å‹¾é€‰è¿™ä¸ªarchetypeï¼Œ æ¥ä¸‹æ¥æ·»åŠ flink-quickstart-javaçš„archetypeã€‚ GroupId = org.apache.flink AryofactId = flink-quickstart-java Version = 1.12.0 åˆ©ç”¨æ¨¡ç‰ˆåˆ›å»ºé¡¹ç›® å¯ä»¥æ ¹æ®è‡ªè¡Œçš„éœ€è¦ï¼Œå¡«å†™é¡¹ç›®çš„è·¯å¾„ä»¥åŠå¯¹åº”çš„GroupId, AryofactId, Version ç„¶åå°±æ˜¯Mavençš„ç›¸å…³é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„é»˜è®¤çš„å°±è¡Œï¼Œç›´æ¥ç‚¹å‡»Finishå®Œæˆé¡¹ç›®åˆå§‹åŒ–ï¼Œç„¶åé¡¹ç›®ä¼šè‡ªåŠ¨æ ¹æ®Mavençš„é…ç½®åŠ è½½å¯¹åº”çš„JaråŒ…ã€‚ ç­‰å¾…ä¸€åˆ‡åˆå§‹åŒ–å®Œæ¯•åï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹å›¾çš„æ¨¡æ¿ å…¶ä¸­åŒ…å«äº†2ä¸ªJobï¼Œåˆ†åˆ«æ˜¯BatchJobå’ŒStreamingJobã€‚ BatchJob ä»£è¡¨æ‰¹å¤„ç†ä»»åŠ¡ StreamingJob ä»£è¡¨æµå¤„ç†ä»»åŠ¡ ç¼–å†™æ‰¹å¤„ç†ä»£ç å¹¶æµ‹è¯•æ‰§è¡Œ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354/* * Licensed to the Apache Software Foundation (ASF) under one * or more contributor license agreements. See the NOTICE file * distributed with this work for additional information * regarding copyright ownership. The ASF licenses this file * to you under the Apache License, Version 2.0 (the * \"License\"); you may not use this file except in compliance * with the License. You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an \"AS IS\" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */package my.flink;import org.apache.flink.api.java.ExecutionEnvironment;import org.apache.flink.api.java.operators.DataSource;import org.apache.flink.util.Collector;import java.util.Arrays;/** * Skeleton for a Flink Batch Job. * * &lt;p&gt;For a tutorial how to write a Flink batch application, check the * tutorials and examples on the &lt;a href=\"https://flink.apache.org/docs/stable/\"&gt;Flink Website&lt;/a&gt;. * * &lt;p&gt;To package your application into a JAR file for execution, * change the main class in the POM.xml file to this class (simply search for 'mainClass') * and run 'mvn clean package' on the command line. */public class BatchJob &#123; public static void main(String[] args) throws Exception &#123; // set up the batch execution environment final ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment(); DataSource&lt;String&gt; el = env.fromElements(\"good good study\", \"day day up\"); el.flatMap( (String a, Collector&lt;String&gt; out) -&gt; Arrays.stream(a.split(\" \")).forEach(x -&gt; out.collect(x)) ).returns(String.class).print(); // ç”±äºprint()æ˜¯è°ƒè¯•æ¨¡å¼ï¼Œæ‰€ä»¥ä¸èƒ½æŒ‡å®šJobnameï¼Œprint()å†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨Execute() // æ‰€ä»¥ env.execute() å°†æ— æ³•è°ƒç”¨ï¼Œéœ€è¦æ³¨é‡Šæ‰ï¼Œå¦åˆ™ä¼šæœ‰æŠ¥é”™æŠ›å‡ºï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©å¿½ç•¥è¿™ä¸ªå¼‚å¸¸ // execute program // env.execute(\"Flink Batch Java API Skeleton\"); &#125;&#125; è¿™é‡Œæˆ‘ä»¬æŠŠBatchJobåŠ å…¥äº†å…·ä½“çš„ä»»åŠ¡ã€‚æˆ‘è¿™é‡Œçš„å†™æ³•æ˜¯Java8çš„lambaçš„å†™æ³•ï¼Œä½¿ç”¨lambaçš„å†™æ³•è®°å¾—éœ€è¦åœ¨åé¢åŠ ä¸Šreturnsçš„å‡½æ•°ï¼Œè¿™æ˜¯å› ä¸ºä½¿ç”¨lambaçš„æƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´éƒ¨åˆ†ä¿¡æ¯æ— æ³•è‡ªåŠ¨æ¨å¯¼ï¼Œéœ€è¦æ‰‹åŠ¨æ˜¾å¼æŒ‡å®šï¼Œä»è€Œå¯¼è‡´æˆ‘ä»¬éœ€è¦è°ƒç”¨å¤šè¿™ä¸ªå‡½æ•°ã€‚ æˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ªæ•°æ®æºé›†åˆï¼Œè¿™ä¸ªé›†åˆç±»å‹ä¸ºStringç±»å‹ï¼Œæˆ‘ä»¬æŒ‡å®šè¿™ä¸ªé›†åˆçš„å…ƒç´ æœ‰2ä¸ªï¼Œåˆ†åˆ«æ˜¯good good study, day day upã€‚ ç„¶åæˆ‘ä»¬é€šè¿‡flatMapçš„æ–¹æ³•è¿›è¡Œä¸€ä¸ªå½’å¹¶çš„æ“ä½œï¼ŒæŠŠæ¯ä¸ªå…ƒç´ é€šè¿‡ä¸€ä¸ªç©ºæ ¼è¿›è¡Œåˆ‡åˆ†ï¼Œåˆ‡åˆ†ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡Collectorçš„collect()è¿›è¡Œæ”¶é›†èµ·æ¥ã€‚æœ€ç»ˆè¾“å‡ºåœ¨ç»ˆç«¯ã€‚ \bå¹¶ä¸”è¿™ä¸ªJobçš„åå­—ï¼Œæˆ‘ä»¬å®šä¹‰ä¸ºFlink Batch Java API Skeletonã€‚ æˆ‘ä»¬è¿è¡Œè¿™ä¸ªJob.é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šé‡åˆ°å¦‚ä¸‹æŠ¥é”™ï¼š 1234567Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: org&#x2F;apache&#x2F;flink&#x2F;api&#x2F;java&#x2F;ExecutionEnvironment at my.flink.BatchJob.main(BatchJob.java:41)Caused by: java.lang.ClassNotFoundException: org.apache.flink.api.java.ExecutionEnvironment at java.base&#x2F;jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:581) at java.base&#x2F;jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:178) at java.base&#x2F;java.lang.ClassLoader.loadClass(ClassLoader.java:522) ... 1 more ä½ å¯èƒ½ä¼šè§‰å¾—å¾ˆå¥‡æ€ªï¼Œæ˜æ˜IDEAå·²ç»æŠŠFlinkçš„åŒ…åŠ è½½è¿›æ¥ï¼Œä¹Ÿèƒ½æ­£å¸¸è·³è½¬ï¼Œä¸ºä»€ä¹ˆåœ¨è¿è¡Œçš„æ—¶å€™å´å‡ºç°äº†è¿™ä¸ªï¼Œè¿™æ˜¯å› ä¸ºè¿™æ˜¯ç¼–è¯‘çš„è¡Œä¸ºï¼Œå’ŒIDEAåŠ è½½åŒ…æ²¡æœ‰ç›´æ¥çš„å…³ç³»ã€‚ æ‰“å¼€ä½ çš„pom.xmlï¼Œæ‰¾åˆ°dependenciesä¸‹çš„&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;çš„æ‰€æœ‰ä¾èµ–åŒ…ï¼Œä½ ä¼šå‘ç°æ¯ä¸ªä¾èµ–åŒ…ä¸‹é¢éƒ½æœ‰ä¸€ä¸ª&lt;scope /&gt;çš„å®šä¹‰ï¼Œé‡Œé¢çš„valueå†™çš„æ˜¯providedï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸€æ•´è¡Œæ³¨é‡Šæ‰å°±å¥½äº†ã€‚ 123456789101112131415161718&lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-java&lt;/artifactId&gt; &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-streaming-java_$&#123;scala.binary.version&#125;&lt;/artifactId&gt; &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-clients_$&#123;scala.binary.version&#125;&lt;/artifactId&gt; &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt;&lt;/dependency&gt; æ³¨é‡Šå 123456789101112131415161718&lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-java&lt;/artifactId&gt; &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt; &lt;!-- &lt;scope&gt;provided&lt;/scope&gt; --&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-streaming-java_$&#123;scala.binary.version&#125;&lt;/artifactId&gt; &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt; &lt;!-- &lt;scope&gt;provided&lt;/scope&gt; --&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.flink&lt;/groupId&gt; &lt;artifactId&gt;flink-clients_$&#123;scala.binary.version&#125;&lt;/artifactId&gt; &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt; &lt;!-- &lt;scope&gt;provided&lt;/scope&gt; --&gt;&lt;/dependency&gt; è¿™æ ·å­ï¼Œå°±ç­‰åŒäºå®šä¹‰ä¾èµ–åŒ…ï¼Œä½¿ç”¨é»˜è®¤çš„scopeèŒƒå›´ã€‚ æˆ‘ä»¬è¿™é‡Œéœ€è¦äº†è§£ä¸€ä¸‹scopeçš„ä¸€äº›ç»†èŠ‚ã€‚ å¯¹äºscope=compileçš„æƒ…å†µï¼ˆé»˜è®¤scope),ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªé¡¹ç›®åœ¨ç¼–è¯‘ï¼Œæµ‹è¯•ï¼Œè¿è¡Œé˜¶æ®µ``éƒ½éœ€è¦è¿™ä¸ªartifact(æ¨¡å—)å¯¹åº”çš„jaråŒ…åœ¨classpathä¸­ã€‚ è€Œå¯¹äºscope=providedçš„æƒ…å†µï¼Œåˆ™å¯ä»¥è®¤ä¸ºè¿™ä¸ªprovidedæ˜¯ç›®æ ‡å®¹å™¨å·²ç»provideè¿™ä¸ªartifactã€‚æ¢å¥è¯è¯´ï¼Œå®ƒåªå½±å“åˆ°ç¼–è¯‘ï¼Œæµ‹è¯•é˜¶æ®µã€‚åœ¨ç¼–è¯‘æµ‹è¯•é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸ªartifactå¯¹åº”çš„jaråŒ…åœ¨classpathä¸­ï¼Œè€Œåœ¨è¿è¡Œé˜¶æ®µï¼Œå‡å®šç›®æ ‡çš„å®¹å™¨ï¼ˆæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œçš„liferayå®¹å™¨ï¼‰å·²ç»æä¾›äº†è¿™ä¸ªjaråŒ…ï¼Œæ‰€ä»¥æ— éœ€æˆ‘ä»¬è¿™ä¸ªartifactå¯¹åº”çš„jaråŒ…äº†ã€‚ mavenä¸­ä¸‰ç§classpathç¼–è¯‘ï¼Œæµ‹è¯•ï¼Œè¿è¡Œ compileï¼šé»˜è®¤èŒƒå›´ï¼Œç¼–è¯‘æµ‹è¯•è¿è¡Œéƒ½æœ‰æ•ˆ providedï¼šåœ¨ç¼–è¯‘å’Œæµ‹è¯•æ—¶æœ‰æ•ˆ runtimeï¼šåœ¨æµ‹è¯•å’Œè¿è¡Œæ—¶æœ‰æ•ˆ testï¼šåªåœ¨æµ‹è¯•æ—¶æœ‰æ•ˆ systemï¼šåœ¨ç¼–è¯‘å’Œæµ‹è¯•æ—¶æœ‰æ•ˆï¼Œä¸æœ¬æœºç³»ç»Ÿå…³è”ï¼Œå¯ç§»æ¤æ€§å·® æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ”¹å˜çš„å°±æ˜¯è¿™ä¸ªscopeçš„èŒƒå›´ï¼Œè®©æŸæƒ…å†µä¸‹å¯ä»¥è¿è¡Œã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœ¬æœºä¸Šè¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ³¨é‡Šæ‰ï¼Œç„¶åå°±ä¼šä½¿ç”¨é»˜è®¤çš„compileã€‚ ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½ æ”¹åŠ¨äº†è¿™ä¸ªpom.xmlä¹‹åï¼Œideaæˆ‘ä¸çŸ¥é“æ˜¯ä¸æ˜¯bugï¼Œåæ­£æˆ‘çš„å½“å‰ç‰ˆæœ¬ä¸ä¼šè‡ªåŠ¨åˆ·æ–°ï¼Œæ€ä¹ˆç†è§£è¿™å¥è¯ï¼Ÿ é€šè¿‡File -&gt; Project Structureæ‰“å¼€é¡µé¢ï¼ˆå› ä¸ºæˆ‘æ˜¯macï¼‰ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å¿«æ·é”®Command + [:;]æ‰“å¼€ã€‚ç•Œé¢å¦‚ä¸‹ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒFlinkç›¸å…³çš„ä¾èµ–åŒ…å…¶å®å·²ç»å­˜åœ¨äº†ï¼Œè¿™é‡Œæ˜¾ç¤ºäº†æˆ‘ä»¬çš„MavenåŒ…ä¸‹çš„scopeæ˜¯Providedï¼Œé‚£å°±ä»£è¡¨IDEAå¹¶æœªè‡ªåŠ¨è¯†åˆ«æˆ‘åˆšæ‰çš„æ³¨é‡Šã€‚å› ä¸ºå¦‚æœæˆåŠŸè¯†åˆ«å‡ºæ¥äº†ï¼Œåº”è¯¥æ˜¯ä¼šå˜æˆCompileã€‚å½“ç„¶æˆ‘å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œè¿›è¡Œä¿®æ”¹ï¼Œä½†æ˜¯ä¸ºäº†ç»Ÿä¸€ç»´æŠ¤çš„é—®é¢˜ï¼Œä¸å»ºè®®åœ¨æ­¤å¤„ä¿®æ”¹ï¼Œè™½ç„¶ç›´æ¥ä¿®æ”¹å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯ä¸‹æ¬¡åŠ è½½è¿˜æ˜¯ä»pom.xmlåŠ è½½çš„ï¼Œå¹¶ä¸”é—´æ¥ä¾èµ–åŒ…ä¹Ÿç‰¹åˆ«å¤šï¼Œä½ æ— æ³•æŒæ¡é‚£ä¹ˆå¤šä¾èµ–åŒ…çš„å…³ç³»ã€‚ æ‰€ä»¥æ³¨é‡Šåï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨pom.xmlè¿›è¡Œmavençš„reload projectã€‚ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å‘ç°ä¸ç®¡æ˜¯ç›´æ¥è¿˜æ˜¯é—´æ¥çš„ä¾èµ–åŒ…éƒ½å˜æˆäº†Compileã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨è¿è¡Œä¸€æ¬¡æˆ‘ä»¬çš„ä»»åŠ¡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989910010110210310410510610710810911011111211311411511611711811912012112212312412512612712812913013113213313413513613713813914014114214314414514614714814915015115215315415515615715815916016116216316416516615:33:55,353 INFO org.apache.flink.api.java.utils.PlanGenerator [] - The job has 0 registered types and 0 default Kryo serializers15:33:55,523 INFO org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.cpu.cores required for local execution is not set, setting it to the maximal possible value.15:33:55,523 INFO org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.task.heap.size required for local execution is not set, setting it to the maximal possible value.15:33:55,523 INFO org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.task.off-heap.size required for local execution is not set, setting it to the maximal possible value.15:33:55,523 INFO org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.network.min required for local execution is not set, setting it to its default value 64 mb.15:33:55,524 INFO org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.network.max required for local execution is not set, setting it to its default value 64 mb.15:33:55,524 INFO org.apache.flink.runtime.taskexecutor.TaskExecutorResourceUtils [] - The configuration option taskmanager.memory.managed.size required for local execution is not set, setting it to its default value 128 mb.15:33:55,548 INFO org.apache.flink.runtime.minicluster.MiniCluster [] - Starting Flink Mini Cluster15:33:55,551 INFO org.apache.flink.runtime.minicluster.MiniCluster [] - Starting Metrics Registry15:33:55,627 INFO org.apache.flink.runtime.metrics.MetricRegistryImpl [] - No metrics reporter configured, no metrics will be exposed&#x2F;reported.15:33:55,627 INFO org.apache.flink.runtime.minicluster.MiniCluster [] - Starting RPC Service(s)15:33:55,780 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils [] - Trying to start local actor system15:33:56,203 INFO akka.event.slf4j.Slf4jLogger [] - Slf4jLogger started15:33:56,313 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils [] - Actor system started at akka:&#x2F;&#x2F;flink15:33:56,328 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils [] - Trying to start local actor system15:33:56,341 INFO akka.event.slf4j.Slf4jLogger [] - Slf4jLogger started15:33:56,356 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcServiceUtils [] - Actor system started at akka:&#x2F;&#x2F;flink-metrics15:33:56,373 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Starting RPC endpoint for org.apache.flink.runtime.metrics.dump.MetricQueryService at akka:&#x2F;&#x2F;flink-metrics&#x2F;user&#x2F;rpc&#x2F;MetricQueryService .15:33:56,399 INFO org.apache.flink.runtime.minicluster.MiniCluster [] - Starting high-availability services15:33:56,418 INFO org.apache.flink.runtime.blob.BlobServer [] - Created BLOB server storage directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;blobStore-4ec8c72e-36f6-4b8d-aba8-70bb3d443f9315:33:56,430 INFO org.apache.flink.runtime.blob.BlobServer [] - Started BLOB server at 0.0.0.0:58212 - max concurrent requests: 50 - max backlog: 100015:33:56,434 INFO org.apache.flink.runtime.blob.PermanentBlobCache [] - Created BLOB cache storage directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;blobStore-3433044e-b47e-445c-9df2-ceb5d1e8da6f15:33:56,436 INFO org.apache.flink.runtime.blob.TransientBlobCache [] - Created BLOB cache storage directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;blobStore-4d06675d-1b13-4fa2-87e9-0a1609934f0915:33:56,436 INFO org.apache.flink.runtime.minicluster.MiniCluster [] - Starting 1 TaskManger(s)15:33:56,441 INFO org.apache.flink.runtime.taskexecutor.TaskManagerRunner [] - Starting TaskManager with ResourceID: a7c681c7-48a2-4491-803a-535036a51fcb15:33:56,477 INFO org.apache.flink.runtime.taskexecutor.TaskManagerServices [] - Temporary file directory &#39;&#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#39;: total 233 GB, usable 25 GB (10.73% usable)15:33:56,482 INFO org.apache.flink.runtime.io.disk.FileChannelManagerImpl [] - FileChannelManager uses directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-io-dc01cff1-6b52-43ed-9d16-9085f49c732e for spill files.15:33:56,492 INFO org.apache.flink.runtime.io.disk.FileChannelManagerImpl [] - FileChannelManager uses directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-netty-shuffle-41571afb-b13e-494b-b937-0696d2c77ca1 for spill files.15:33:56,580 INFO org.apache.flink.runtime.io.network.buffer.NetworkBufferPool [] - Allocated 64 MB for network buffer pool (number of memory segments: 2048, bytes per segment: 32768).15:33:56,594 INFO org.apache.flink.runtime.io.network.NettyShuffleEnvironment [] - Starting the network environment and its components.15:33:56,596 INFO org.apache.flink.runtime.taskexecutor.KvStateService [] - Starting the kvState service and its components.15:33:56,631 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Starting RPC endpoint for org.apache.flink.runtime.taskexecutor.TaskExecutor at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0 .15:33:56,650 INFO org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Start job leader service.15:33:56,653 INFO org.apache.flink.runtime.filecache.FileCache [] - User file cache uses directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-dist-cache-fc4fd5a1-79fa-4a19-8d7d-f3072006c91e15:33:56,714 INFO org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint [] - Starting rest endpoint.15:33:56,717 INFO org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint [] - Failed to load web based job submission extension. Probable reason: flink-runtime-web is not in the classpath.15:33:57,089 WARN org.apache.flink.runtime.webmonitor.WebMonitorUtils [] - Log file environment variable &#39;log.file&#39; is not set.15:33:57,089 WARN org.apache.flink.runtime.webmonitor.WebMonitorUtils [] - JobManager log files are unavailable in the web dashboard. Log file location not found in environment variable &#39;log.file&#39; or configuration key &#39;web.log.path&#39;.15:33:57,300 INFO org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint [] - Rest endpoint listening at localhost:5822315:33:57,302 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender http:&#x2F;&#x2F;localhost:5822315:33:57,305 INFO org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint [] - http:&#x2F;&#x2F;localhost:58223 was granted leadership with leaderSessionID&#x3D;22a043f5-f263-4e6c-87e9-6e61beef307515:33:57,306 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader http:&#x2F;&#x2F;localhost:58223 , session&#x3D;22a043f5-f263-4e6c-87e9-6e61beef307515:33:57,327 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Starting RPC endpoint for org.apache.flink.runtime.resourcemanager.StandaloneResourceManager at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 .15:33:57,344 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender LeaderContender: DefaultDispatcherRunner15:33:57,345 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender LeaderContender: StandaloneResourceManager15:33:57,347 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - ResourceManager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 was granted leadership with fencing token 99793e5c3d8a81ced62f8a03bd21494c15:33:57,350 INFO org.apache.flink.runtime.minicluster.MiniCluster [] - Flink Mini Cluster started successfully15:33:57,350 INFO org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl [] - Starting the SlotManager.15:33:57,351 INFO org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Start SessionDispatcherLeaderProcess.15:33:57,353 INFO org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Recover all persisted job graphs.15:33:57,354 INFO org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Successfully recovered 0 persisted job graphs.15:33:57,355 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 , session&#x3D;d62f8a03-bd21-494c-9979-3e5c3d8a81ce15:33:57,357 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Connecting to ResourceManager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1(99793e5c3d8a81ced62f8a03bd21494c).15:33:57,365 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Starting RPC endpoint for org.apache.flink.runtime.dispatcher.StandaloneDispatcher at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2 .15:33:57,378 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2 , session&#x3D;0a8eb324-f6f9-44d7-a452-87c855415b0e15:33:57,387 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Resolved ResourceManager address, beginning registration15:33:57,393 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Registering TaskManager with ResourceID a7c681c7-48a2-4491-803a-535036a51fcb (akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0) at ResourceManager15:33:57,395 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Successful registration at resource manager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1 under registration id 3e9b649958365e1a080d0b1102807505.15:33:57,396 INFO org.apache.flink.runtime.dispatcher.StandaloneDispatcher [] - Received JobGraph submission c9c27c95a1e3b4a8bfd7250101fa1126 (Flink Java Job at Tue Sep 28 15:33:55 CST 2021).15:33:57,396 INFO org.apache.flink.runtime.dispatcher.StandaloneDispatcher [] - Submitting job c9c27c95a1e3b4a8bfd7250101fa1126 (Flink Java Job at Tue Sep 28 15:33:55 CST 2021).15:33:57,423 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Starting RPC endpoint for org.apache.flink.runtime.jobmaster.JobMaster at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 .15:33:57,433 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Initializing job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).15:33:57,452 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Using restart back off time strategy NoRestartBackoffTimeStrategy for Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).15:33:57,487 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Running initialization on master for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).15:33:57,490 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Successfully ran initialization on master in 3 ms.15:33:57,512 INFO org.apache.flink.runtime.scheduler.adapter.DefaultExecutionTopology [] - Built 1 pipelined regions in 3 ms15:33:57,518 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Using failover strategy org.apache.flink.runtime.executiongraph.failover.flip1.RestartPipelinedRegionFailoverStrategy@4fe83a40 for Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126).15:33:57,527 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Proposing leadership to contender akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_315:33:57,528 INFO org.apache.flink.runtime.jobmaster.JobManagerRunnerImpl [] - JobManager runner for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) was granted leadership with session id 00c173d1-6a96-47ad-a2d9-da1ebc4d6a41 at akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3.15:33:57,532 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Starting execution of job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) under job master id a2d9da1ebc4d6a4100c173d16a9647ad.15:33:57,533 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Starting scheduling with scheduling strategy [org.apache.flink.runtime.scheduler.strategy.PipelinedRegionSchedulingStrategy]15:33:57,533 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - Job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) switched from state CREATED to RUNNING.15:33:57,537 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from CREATED to SCHEDULED.15:33:57,537 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from CREATED to SCHEDULED.15:33:57,546 INFO org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl [] - Cannot serve slot request, no ResourceManager connected. Adding as pending request [SlotRequestId&#123;1e28fd68790f78b4b48f557e8ba4d92f&#125;]15:33:57,552 INFO org.apache.flink.runtime.highavailability.nonha.embedded.EmbeddedLeaderService [] - Received confirmation of leadership for leader akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 , session&#x3D;00c173d1-6a96-47ad-a2d9-da1ebc4d6a4115:33:57,552 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Connecting to ResourceManager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;resourcemanager_1(99793e5c3d8a81ced62f8a03bd21494c)15:33:57,554 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Resolved ResourceManager address, beginning registration15:33:57,555 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Registering job manager a2d9da1ebc4d6a4100c173d16a9647ad@akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126.15:33:57,559 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Registered job manager a2d9da1ebc4d6a4100c173d16a9647ad@akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126.15:33:57,561 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - JobManager successfully registered at ResourceManager, leader id: 99793e5c3d8a81ced62f8a03bd21494c.15:33:57,562 INFO org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl [] - Requesting new slot [SlotRequestId&#123;1e28fd68790f78b4b48f557e8ba4d92f&#125;] and profile ResourceProfile&#123;UNKNOWN&#125; with allocation id d73fe42189235dfaf22a937eb4556ee1 from resource manager.15:33:57,562 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Request slot with profile ResourceProfile&#123;UNKNOWN&#125; for job c9c27c95a1e3b4a8bfd7250101fa1126 with allocation id d73fe42189235dfaf22a937eb4556ee1.15:33:57,565 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Receive slot request d73fe42189235dfaf22a937eb4556ee1 for job c9c27c95a1e3b4a8bfd7250101fa1126 from resource manager with leader id 99793e5c3d8a81ced62f8a03bd21494c.15:33:57,570 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Allocated slot for d73fe42189235dfaf22a937eb4556ee1.15:33:57,571 INFO org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Add job c9c27c95a1e3b4a8bfd7250101fa1126 for job leader monitoring.15:33:57,573 INFO org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Try to register at job manager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 with leader id 00c173d1-6a96-47ad-a2d9-da1ebc4d6a41.15:33:57,574 INFO org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Resolved JobManager address, beginning registration15:33:57,577 INFO org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Successful registration at job manager akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126.15:33:57,578 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Establish JobManager connection for job c9c27c95a1e3b4a8bfd7250101fa1126.15:33:57,580 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Offer reserved slots to the leader of job c9c27c95a1e3b4a8bfd7250101fa1126.15:33:57,588 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from SCHEDULED to DEPLOYING.15:33:57,590 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - Deploying CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (attempt #0) with attempt id 2d0c18f32aaefecbd6f3d76a781d54b9 to a7c681c7-48a2-4491-803a-535036a51fcb @ localhost (dataPort&#x3D;-1) with allocation id d73fe42189235dfaf22a937eb4556ee115:33:57,595 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from SCHEDULED to DEPLOYING.15:33:57,595 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - Deploying DataSink (collect()) (1&#x2F;1) (attempt #0) with attempt id 1feb48784b233306f550eda82cf1b5e9 to a7c681c7-48a2-4491-803a-535036a51fcb @ localhost (dataPort&#x3D;-1) with allocation id d73fe42189235dfaf22a937eb4556ee115:33:57,595 INFO org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Activate slot d73fe42189235dfaf22a937eb4556ee1.15:33:57,627 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Received task CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9), deploy into slot with allocation id d73fe42189235dfaf22a937eb4556ee1.15:33:57,628 INFO org.apache.flink.runtime.taskmanager.Task [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) switched from CREATED to DEPLOYING.15:33:57,630 INFO org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Activate slot d73fe42189235dfaf22a937eb4556ee1.15:33:57,630 INFO org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Activate slot d73fe42189235dfaf22a937eb4556ee1.15:33:57,633 INFO org.apache.flink.runtime.taskmanager.Task [] - Loading JAR files for task CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) [DEPLOYING].15:33:57,634 INFO org.apache.flink.runtime.taskmanager.Task [] - Registering task at network: CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) [DEPLOYING].15:33:57,642 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Received task DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9), deploy into slot with allocation id d73fe42189235dfaf22a937eb4556ee1.15:33:57,642 INFO org.apache.flink.runtime.taskmanager.Task [] - DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) switched from CREATED to DEPLOYING.15:33:57,643 INFO org.apache.flink.runtime.taskmanager.Task [] - Loading JAR files for task DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) [DEPLOYING].15:33:57,644 INFO org.apache.flink.runtime.taskmanager.Task [] - Registering task at network: DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) [DEPLOYING].15:33:57,647 INFO org.apache.flink.runtime.taskmanager.Task [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) switched from DEPLOYING to RUNNING.15:33:57,648 INFO org.apache.flink.runtime.taskmanager.Task [] - DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) switched from DEPLOYING to RUNNING.15:33:57,648 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from DEPLOYING to RUNNING.15:33:57,649 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from DEPLOYING to RUNNING.15:33:57,659 WARN org.apache.flink.metrics.MetricGroup [] - The operator name DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) exceeded the 80 characters length limit and was truncated.15:33:57,667 INFO org.apache.flink.runtime.taskmanager.Task [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9) switched from RUNNING to FINISHED.15:33:57,667 INFO org.apache.flink.runtime.taskmanager.Task [] - Freeing task resources for CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 (2d0c18f32aaefecbd6f3d76a781d54b9).15:33:57,670 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Un-registering task and sending final execution state FINISHED to JobManager for task CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1)#0 2d0c18f32aaefecbd6f3d76a781d54b9.15:33:57,677 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - CHAIN DataSource (at main(BatchJob.java:43) (org.apache.flink.api.java.io.CollectionInputFormat)) -&gt; FlatMap (FlatMap at main(BatchJob.java:45)) (1&#x2F;1) (2d0c18f32aaefecbd6f3d76a781d54b9) switched from RUNNING to FINISHED.15:33:57,678 INFO org.apache.flink.runtime.taskmanager.Task [] - DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9) switched from RUNNING to FINISHED.15:33:57,678 INFO org.apache.flink.runtime.taskmanager.Task [] - Freeing task resources for DataSink (collect()) (1&#x2F;1)#0 (1feb48784b233306f550eda82cf1b5e9).15:33:57,679 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Un-registering task and sending final execution state FINISHED to JobManager for task DataSink (collect()) (1&#x2F;1)#0 1feb48784b233306f550eda82cf1b5e9.15:33:57,682 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - DataSink (collect()) (1&#x2F;1) (1feb48784b233306f550eda82cf1b5e9) switched from RUNNING to FINISHED.15:33:57,685 INFO org.apache.flink.runtime.executiongraph.ExecutionGraph [] - Job Flink Java Job at Tue Sep 28 15:33:55 CST 2021 (c9c27c95a1e3b4a8bfd7250101fa1126) switched from state RUNNING to FINISHED.15:33:57,691 INFO org.apache.flink.runtime.dispatcher.StandaloneDispatcher [] - Job c9c27c95a1e3b4a8bfd7250101fa1126 reached globally terminal state FINISHED.15:33:57,691 INFO org.apache.flink.runtime.minicluster.MiniCluster [] - Shutting down Flink Mini Cluster15:33:57,691 INFO org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint [] - Shutting down rest endpoint.15:33:57,691 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Stopping TaskExecutor akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0.15:33:57,692 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Close ResourceManager connection 01714233597d70de71bbfbda09ac665e.15:33:57,692 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Closing TaskExecutor connection a7c681c7-48a2-4491-803a-535036a51fcb because: The TaskExecutor is shutting down.15:33:57,693 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Close JobManager connection for job c9c27c95a1e3b4a8bfd7250101fa1126.15:33:57,694 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Stopping the JobMaster for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021(c9c27c95a1e3b4a8bfd7250101fa1126).15:33:57,695 INFO org.apache.flink.runtime.taskexecutor.slot.TaskSlotTableImpl [] - Free slot TaskSlot(index:0, state:ALLOCATED, resource profile: ResourceProfile&#123;managedMemory&#x3D;128.000mb (134217728 bytes), networkMemory&#x3D;64.000mb (67108864 bytes)&#125;, allocationId: d73fe42189235dfaf22a937eb4556ee1, jobId: c9c27c95a1e3b4a8bfd7250101fa1126).15:33:57,697 INFO org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl [] - Suspending SlotPool.15:33:57,697 INFO org.apache.flink.runtime.jobmaster.JobMaster [] - Close ResourceManager connection 01714233597d70de71bbfbda09ac665e: Stopping JobMaster for job Flink Java Job at Tue Sep 28 15:33:55 CST 2021(c9c27c95a1e3b4a8bfd7250101fa1126)..15:33:57,697 INFO org.apache.flink.runtime.jobmaster.slotpool.SlotPoolImpl [] - Stopping SlotPool.15:33:57,697 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Disconnect job manager a2d9da1ebc4d6a4100c173d16a9647ad@akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;jobmanager_3 for job c9c27c95a1e3b4a8bfd7250101fa1126 from the resource manager.15:33:57,699 INFO org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Stop job leader service.15:33:57,699 INFO org.apache.flink.runtime.state.TaskExecutorLocalStateStoresManager [] - Shutting down TaskExecutorLocalStateStoresManager.goodgoodstudydaydayup15:33:57,725 INFO org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint [] - Removing cache directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-web-ui15:33:57,727 INFO org.apache.flink.runtime.dispatcher.DispatcherRestEndpoint [] - Shut down complete.15:33:57,729 INFO org.apache.flink.runtime.resourcemanager.StandaloneResourceManager [] - Shut down cluster because application is in CANCELED, diagnostics DispatcherResourceManagerComponent has been closed..15:33:57,729 INFO org.apache.flink.runtime.io.disk.FileChannelManagerImpl [] - FileChannelManager removed spill file directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-io-dc01cff1-6b52-43ed-9d16-9085f49c732e15:33:57,730 INFO org.apache.flink.runtime.io.network.NettyShuffleEnvironment [] - Shutting down the network environment and its components.15:33:57,730 INFO org.apache.flink.runtime.entrypoint.component.DispatcherResourceManagerComponent [] - Closing components.15:33:57,730 INFO org.apache.flink.runtime.dispatcher.runner.SessionDispatcherLeaderProcess [] - Stopping SessionDispatcherLeaderProcess.15:33:57,730 INFO org.apache.flink.runtime.dispatcher.StandaloneDispatcher [] - Stopping dispatcher akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2.15:33:57,731 INFO org.apache.flink.runtime.dispatcher.StandaloneDispatcher [] - Stopping all currently running jobs of dispatcher akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2.15:33:57,731 INFO org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl [] - Closing the SlotManager.15:33:57,731 INFO org.apache.flink.runtime.resourcemanager.slotmanager.SlotManagerImpl [] - Suspending the SlotManager.15:33:57,731 INFO org.apache.flink.runtime.rest.handler.legacy.backpressure.BackPressureRequestCoordinator [] - Shutting down back pressure request coordinator.15:33:57,731 INFO org.apache.flink.runtime.io.disk.FileChannelManagerImpl [] - FileChannelManager removed spill file directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-netty-shuffle-41571afb-b13e-494b-b937-0696d2c77ca115:33:57,732 INFO org.apache.flink.runtime.taskexecutor.KvStateService [] - Shutting down the kvState service and its components.15:33:57,732 INFO org.apache.flink.runtime.dispatcher.StandaloneDispatcher [] - Stopped dispatcher akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;dispatcher_2.15:33:57,732 INFO org.apache.flink.runtime.taskexecutor.DefaultJobLeaderService [] - Stop job leader service.15:33:57,734 INFO org.apache.flink.runtime.filecache.FileCache [] - removed file cache directory &#x2F;var&#x2F;folders&#x2F;zq&#x2F;2b48w4_x5vq89_jrz3yns13h0000gn&#x2F;T&#x2F;flink-dist-cache-fc4fd5a1-79fa-4a19-8d7d-f3072006c91e15:33:57,735 INFO org.apache.flink.runtime.taskexecutor.TaskExecutor [] - Stopped TaskExecutor akka:&#x2F;&#x2F;flink&#x2F;user&#x2F;rpc&#x2F;taskmanager_0.15:33:57,735 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Stopping Akka RPC service.15:33:57,760 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Stopping Akka RPC service.15:33:57,760 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Stopped Akka RPC service.15:33:57,766 INFO org.apache.flink.runtime.blob.PermanentBlobCache [] - Shutting down BLOB cache15:33:57,768 INFO org.apache.flink.runtime.blob.TransientBlobCache [] - Shutting down BLOB cache15:33:57,772 INFO org.apache.flink.runtime.blob.BlobServer [] - Stopped BLOB server at 0.0.0.0:5821215:33:57,772 INFO org.apache.flink.runtime.rpc.akka.AkkaRpcService [] - Stopped Akka RPC service. å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„ä»£ç å·²ç»æ‰§è¡Œï¼Œå¹¶ä¸”ç”Ÿæ•ˆã€‚è¿™æ ·å­æˆ‘ä»¬çš„å¼€å‘ç¯å¢ƒå°±æ­å»ºå®Œæ¯•äº†ã€‚å…¶ä»–çš„åŸºæœ¬å¤§åŒå°å¼‚ï¼Œå¦‚éœ€è®°å½•ï¼Œåé¢ä¼šé¢å¤–çš„ç¯‡ç« è¿›è¡Œè®°å½•ã€‚ é¡¹ç›®æ‰“åŒ…å¹¶æäº¤Flinké›†ç¾¤æ‰§è¡Œç›´åˆ°åˆšæ‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬éƒ½æ˜¯æœ¬åœ°å¼€å‘çš„æ¨¡å¼ï¼Œä½†æ˜¯å¦‚æœè¦åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ‰“åŒ…æˆjarï¼Œç„¶åå€ŸåŠ©flink-clientæäº¤jobå›¾å¯¹è±¡ç»™flink-job-managerï¼Œç„¶åå†åˆ†å‘ç»™å„ä¸ªçš„taskManagerè¿›è¡Œæ‰§è¡Œã€‚ æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰“åŒ…å‡ºjaråŒ…ã€‚ æˆ‘ä»¬ä½¿ç”¨Mavençš„mvn clean packageå‘½ä»¤å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œæ‰“åŒ…ã€‚ å¦‚æœéœ€è¦é¢å¤–æŒ‡å®šä¸€äº›å†…å®¹çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨mvn clean package -Dfile.encoding=UTF-8 -DskipTests=trueï¼Œè¿™æ ·å­å¯ä»¥å¿½ç•¥æµ‹è¯•é˜¶æ®µã€‚ åˆ©ç”¨docker æ„æ¶ä¸€ä¸ªflink1.12çš„é›†ç¾¤ æ„å»ºä¸€ä¸ªmavenå·¥å…·ï¼Œç‰ˆæœ¬3.6.3ï¼ˆç”±äºideaé‡‡ç”¨çš„æ˜¯å†…ç½®çš„mavenï¼Œè¿™æ˜¯æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„jaråŒ…ï¼Œæ‰€ä»¥å¤–éƒ¨æ— æ³•ç›´æ¥å¼•ç”¨mvnå‘½ä»¤ï¼‰ 12docker pull flink:1.12-scala_2.11-java8docker pull maven:3.6.3 åœ¨ä»£ç ç›®å½•ä¸‹æ‰“åŒ…å‡ºjaråŒ… è®°å¾—æ‰“åŒ…æˆç”Ÿæˆç¯å¢ƒçš„jaråŒ…çš„æ—¶å€™ï¼ŒæŠŠ&lt;scope /&gt;æ”¹å› provided, ä¹Ÿå°±æ˜¯æŠŠæ³¨é‡Šå–æ¶ˆæ‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344âœ my-flink-jdk11 docker run --rm -it -v ~/.m2:/root/.m2 -v $(PWD):/www -w /www maven:3.6.3 mvn clean package[INFO] Scanning for projects...[INFO] [INFO] ----------------------&lt; my-flink:my-flink-jdk11 &gt;-----------------------[INFO] Building Flink Quickstart Job 1.0-SNAPSHOT[INFO] --------------------------------[ jar ]---------------------------------[INFO] [INFO] --- maven-clean-plugin:2.5:clean (default-clean) @ my-flink-jdk11 ---[INFO] Deleting /www/target[INFO] [INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ my-flink-jdk11 ---[INFO] Using 'UTF-8' encoding to copy filtered resources.[INFO] Copying 1 resource[INFO] [INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ my-flink-jdk11 ---[INFO] Changes detected - recompiling the module![INFO] Compiling 2 source files to /www/target/classes[INFO] [INFO] --- maven-resources-plugin:2.6:testResources (default-testResources) @ my-flink-jdk11 ---[INFO] Using 'UTF-8' encoding to copy filtered resources.[INFO] skip non existing resourceDirectory /www/src/test/resources[INFO] [INFO] --- maven-compiler-plugin:3.1:testCompile (default-testCompile) @ my-flink-jdk11 ---[INFO] No sources to compile[INFO] [INFO] --- maven-surefire-plugin:2.12.4:test (default-test) @ my-flink-jdk11 ---[INFO] No tests to run.[INFO] [INFO] --- maven-jar-plugin:2.4:jar (default-jar) @ my-flink-jdk11 ---[INFO] Building jar: /www/target/my-flink-jdk11-1.0-SNAPSHOT.jar[INFO] [INFO] --- maven-shade-plugin:3.1.1:shade (default) @ my-flink-jdk11 ---[INFO] Excluding org.slf4j:slf4j-api:jar:1.7.15 from the shaded jar.[INFO] Excluding org.apache.logging.log4j:log4j-slf4j-impl:jar:2.12.1 from the shaded jar.[INFO] Excluding org.apache.logging.log4j:log4j-api:jar:2.12.1 from the shaded jar.[INFO] Excluding org.apache.logging.log4j:log4j-core:jar:2.12.1 from the shaded jar.[INFO] Replacing original artifact with shaded artifact.[INFO] Replacing /www/target/my-flink-jdk11-1.0-SNAPSHOT.jar with /www/target/my-flink-jdk11-1.0-SNAPSHOT-shaded.jar[INFO] ------------------------------------------------------------------------[INFO] BUILD SUCCESS[INFO] ------------------------------------------------------------------------[INFO] Total time: 8.988 s[INFO] Finished at: 2021-09-28T08:30:35Z[INFO] ------------------------------------------------------------------------ è½¬ç§»å°±æ„å»ºæˆåŠŸäº†ã€‚ åœ¨targetç›®å½•ä¸‹æŸ¥çœ‹jaråŒ… 12âœ my-flink-jdk11 ll target/my-flink-jdk11-1.0-SNAPSHOT.jar -rw-r--r-- 1 caiwenhui staff 6.6K Sep 28 16:30 target/my-flink-jdk11-1.0-SNAPSHOT.jar åŒæ ·æŠŠä»£ç ç›®å½•æŒ‚è½½è¿›flinkå®¹å™¨ï¼Œç„¶åæ„å»ºflinkå®¹å™¨ï¼ˆæ­¤æ­¥éª¤åªè¦æ˜¯æ‹¿åˆ°targetç›®å½•ä¸‹çš„jaråŒ…ï¼Œå¦‚æœä½ æŒ‡å®šäº†å…¶ä»–è·¯å¾„æ¢ä¸ªæŒ‚è½½ç›®å½•ä¹Ÿå¯ä»¥ï¼‰ 1docker run -it --name flinkc --privileged -w /www -v$(PWD):/www -p 8081:8081 flink:1.12-scala_2.11-java8 bash 8081æ˜¯flink webuiçš„æœåŠ¡ï¼Œå…·ä½“çš„å†…å®¹åé¢å†è¯´ è¿›åˆ°å®¹å™¨åï¼Œå¯åŠ¨å•æœºç‰ˆflinké›†ç¾¤ 1234flink@ed5e7ea28514:/www$ start-cluster.shStarting cluster.Starting standalonesession daemon on host ed5e7ea28514.Starting taskexecutor daemon on host ed5e7ea28514 123456789101112131415flink@ed5e7ea28514:&#x2F;www$ flink run --class my.flink.BatchJob .&#x2F;target&#x2F;my-flink-jdk11-1.0-SNAPSHOT.jarJob has been submitted with JobID ca99d6d7ef6f913ac334d7123d63658bProgram execution finishedJob with JobID ca99d6d7ef6f913ac334d7123d63658b has finished.Job Runtime: 187 msAccumulator Results:- 40a6a5d6af948dba01cbb7bee71f2d4e (java.util.ArrayList) [6 elements]goodgoodstudydaydayup å¯ä»¥çœ‹åˆ°ï¼Œå¯ä»¥è¿™ä¸ªç»“æœå’Œæˆ‘ä»¬å†IDEAæ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œæ‰€ä»¥å¼€å‘ç¯å¢ƒæ­å»ºå®Œæ¯•ã€‚åé¢çš„ç¯‡ç« å°†ä¼šæ˜¯å…·ä½“çš„æµè®¡ç®—å†…å®¹ã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"flink","slug":"flink","permalink":"http://blog.crazylaw.cn/tags/flink/"}]},{"title":"ã€Golangã€‘- protobufæ’ä»¶æ‰©å±•å¼€å‘2","slug":"Golang/protobufæ’ä»¶æ‰©å±•å¼€å‘2","date":"2021-09-06T01:16:51.000Z","updated":"2021-09-06T01:57:29.825Z","comments":true,"path":"2021/09/06/Golang/protobufæ’ä»¶æ‰©å±•å¼€å‘2/","link":"","permalink":"http://blog.crazylaw.cn/2021/09/06/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%912/","excerpt":"å‰è¨€ä¸Šä¸€ç‰‡ï¼Œæˆ‘ä»¬è®²åˆ°äº†protobufæ‰©å±•å¼€å‘çš„å¤§ä½“æµç¨‹å’Œæ€è·¯ï¼Œè¿™ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥ç»§ç»­æ€»ç»“ä¸€ä¸‹ç›¸å…³çš„APIç»†èŠ‚ã€‚","text":"å‰è¨€ä¸Šä¸€ç‰‡ï¼Œæˆ‘ä»¬è®²åˆ°äº†protobufæ‰©å±•å¼€å‘çš„å¤§ä½“æµç¨‹å’Œæ€è·¯ï¼Œè¿™ä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥ç»§ç»­æ€»ç»“ä¸€ä¸‹ç›¸å…³çš„APIç»†èŠ‚ã€‚ APIç¬¬ä¸€ç‚¹1option go_package &#x3D; &quot;github.com&#x2F;xxxx&#x2F;pb&#x2F;go-pb&#x2F;api;pb&quot;; æˆ‘ä»¬ç»å¸¸å¯ä»¥çœ‹åˆ°è¿™ç§å®šä¹‰ï¼Œåˆ†å¥½å‰é¢çš„github.com/xxxx/pb/go-pb/apiï¼Œæˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ä¼šè¢«åŠ è½½åˆ°ï¼š 123456// æºç func (gen *Plugin) NewGeneratedFile(filename string, goImportPath GoImportPath) *GeneratedFile// æˆ‘ä»¬è‡ªå·±çš„ä»£ç filename := f.GeneratedFilenamePrefix + \".api.go\"g := plugin.NewGeneratedFile(strings.TrimPrefix(filename, strings.Trim(pbPkg.String(), \"\\\"\")), f.GoImportPath) è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Plugin.NewGeneratedFileæœ‰2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯filename,å¦å¤–ä¸€ä¸ªæ˜¯goImportPathï¼Œåˆ†åˆ«çš„å«ä¹‰æ˜¯ï¼š ç”Ÿæˆçš„æ–‡ä»¶åå’Œè¿™ä¸ªæ–‡ä»¶è¢«importçš„æ—¶å€™ï¼Œåº”è¯¥è¦æ€ä¹ˆimportã€‚ è¿™ä¸ªæ–‡ä»¶åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨è·¯å¾„æ–‡ä»¶åï¼Œå¦‚æœä½ çš„æ–‡ä»¶åç§å­˜åœ¨/ï¼Œé‚£ä¹ˆå‰é¢çš„éƒ½æ˜¯ç›®å½•ï¼Œç›´åˆ°æœ€åä¸€ä¸ªï¼Œæ‰æ˜¯æ–‡ä»¶åã€‚ ä¾‹å¦‚æˆ‘è¿™é‡Œçš„æ˜¯github.com/xxxx/pb/go-pb/apiï¼Œé‚£ä¹ˆç”Ÿæˆçš„æ–‡ä»¶è¢«å¼•ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šimport &quot;github.com/xxxx/pb/go-pb/api&quot;ã€‚ çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹åˆ†å·åé¢çš„pbï¼Œè¿™ä¸ªåœ¨å¤–é¢å†™ä»£ç çš„æ—¶å€™åˆ°ä½“ç°æ˜¯ï¼š 12// æˆ‘ä»¬è‡ªå·±çš„ä»£ç g.P(\"package \" + f.GoPackageName) çœ‹åˆ°å…¶å®è¿™ä¸ªpbä¼šè¢«åŠ è½½è¿›æ–‡ä»¶çš„GoPackageNameç§ï¼Œæ‰€ä»¥åˆ†å·å‰é¢çš„æ„ä¹‰æ˜¯ä¸åŒçš„ï¼Œå‰é¢çš„å¯¹åº”filenameå’ŒGoImportPath,åé¢å¯¹åº”çš„å°±æ˜¯GoPackageName ç¬¬äºŒç‚¹123var ( pbPkg = protogen.GoImportPath(\"github.com/xxx/pb/go-pb\")) åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¼šå®šä¹‰ä¸€äº›è¿™æ ·å­çš„xxxPkgçš„å˜é‡ï¼Œä»–ä»¬ç”±protogen.GoImportPathæ¥åŒ…è£…èµ·æ¥ï¼Œåœ¨ä½¿ç”¨ä¸Šå°±æ˜¯ï¼š 1g.P(\" \", method.GoName, \"Api = \", pbPkg.Ident(\"NewApi\"), \"(\\\"\", method.GoName, \"\\\", \\\"\", m, \"\\\", \\\"\", url, \"\\\")\") çœ‹åˆ°è¿™é‡Œçš„pbPkg.Ident(&quot;NewApi&quot;)ï¼Œæ„æ€å°±æ˜¯è¿™ä¸ªè¦è°ƒç”¨pbPkgåŒ…ä¸‹çš„NewApiçš„æ–¹æ³•ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œç”¨åˆ°çš„Ident()APIï¼Œé¡¾åæ€ä¹‰å°±æ˜¯.çš„æ„æ€ã€‚ ç¬¬ä¸‰ç‚¹æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è°ƒç”¨Plugin.NewGeneratedFileï¼Œåˆ›å»ºäº†ç”Ÿæˆæ–‡ä»¶å®ä¾‹å¹¶ä¸”å·²ç»é¢„å†™å…¥äº†ä¸€äº›å†…å®¹ï¼Œä½†æ˜¯å®é™…ä»£ç ä¸­ï¼Œå¹¶æ²¡æœ‰ä»»ä½•æœ‰æ„ä¹‰æœ‰ä»·å€¼çš„ä»£ç ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘å¸Œæœ›è¿™ä¸ªæ–‡ä»¶ä¸è¦ç”Ÿæˆï¼Œæˆ‘å°±å¯ä»¥è°ƒç”¨Skip()çš„APIã€‚ 123// æˆ‘ä»¬è‡ªå·±çš„ä»£ç g := plugin.NewGeneratedFile(strings.TrimPrefix(filename, strings.Trim(pbPkg.String(), \"\\\"\")), f.GoImportPath)g.Skip() é‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶åœ¨æœ€ç»ˆå°†ä¸ä¼šè¢«ç”Ÿæˆã€‚","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€Golangã€‘- protobufæ’ä»¶æ‰©å±•å¼€å‘","slug":"Golang/protobufæ’ä»¶æ‰©å±•å¼€å‘","date":"2021-09-04T06:16:51.000Z","updated":"2021-09-04T06:28:36.840Z","comments":true,"path":"2021/09/04/Golang/protobufæ’ä»¶æ‰©å±•å¼€å‘/","link":"","permalink":"http://blog.crazylaw.cn/2021/09/04/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/","excerpt":"å‰è¨€æœ€è¿‘ï¼Œé¡¹ç›®éœ€è¦ç”¨åˆ°protobufæ¥å®šä¹‰æ¶ˆæ¯ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´çµæ´»çš„ä»£ç ç‰‡æ®µï¼Œå¦‚ä½•é€šè¿‡protoæ–‡ä»¶æ¥åˆ›å»ºè‡ªå®šä¹‰çš„ä»£ç å‘¢ï¼Ÿå¯ä»¥é€šè¿‡protoçš„pluginå¯¹æ–¹å¼æ¥è‡ªå·±æ˜¯ä¸€ä¸ªproto-genã€‚\b åœ¨ç½‘ä¸Šçœ‹äº†ä¸€äº›æ•™ç¨‹ï¼Œå‘ç°æœ‰ä¸€äº›æ•™ç¨‹å·²ç»è¿‡æ—¶äº†ï¼Œè€Œä¸”è¿‡äºç‰‡é¢ï¼Œæ²¡æœ‰æŠŠæ•´å¥—æ€æƒ³å¾ˆå¥½çš„è¯´æ˜ã€‚å¹¶ä¸”ä¹Ÿæœ‰ä¸€äº›åŠŸèƒ½ç‚¹å¹¶æ²¡æœ‰å®Œå…¨å®ç°ã€‚è¿™é‡Œæ€»ç»“ä¸€ä¸‹ç›¸å…³çš„å†…å®¹ï¼Œå¹¶ä¸”è¯´ä¸€ä¸‹æœ€è¿‘å®ç°çš„ä¸€ä¸ªæ’ä»¶ã€‚ å¯¹äºå·²ç»äº†è§£å¤§æ¦‚protoçš„äººæ¥è¯´ï¼Œç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯å¦‚æœæ˜¯è‡ªå®šä¹‰optionå‘¢ï¼Ÿä½ åˆäº†è§£å—ï¼Ÿ","text":"å‰è¨€æœ€è¿‘ï¼Œé¡¹ç›®éœ€è¦ç”¨åˆ°protobufæ¥å®šä¹‰æ¶ˆæ¯ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´çµæ´»çš„ä»£ç ç‰‡æ®µï¼Œå¦‚ä½•é€šè¿‡protoæ–‡ä»¶æ¥åˆ›å»ºè‡ªå®šä¹‰çš„ä»£ç å‘¢ï¼Ÿå¯ä»¥é€šè¿‡protoçš„pluginå¯¹æ–¹å¼æ¥è‡ªå·±æ˜¯ä¸€ä¸ªproto-genã€‚\b åœ¨ç½‘ä¸Šçœ‹äº†ä¸€äº›æ•™ç¨‹ï¼Œå‘ç°æœ‰ä¸€äº›æ•™ç¨‹å·²ç»è¿‡æ—¶äº†ï¼Œè€Œä¸”è¿‡äºç‰‡é¢ï¼Œæ²¡æœ‰æŠŠæ•´å¥—æ€æƒ³å¾ˆå¥½çš„è¯´æ˜ã€‚å¹¶ä¸”ä¹Ÿæœ‰ä¸€äº›åŠŸèƒ½ç‚¹å¹¶æ²¡æœ‰å®Œå…¨å®ç°ã€‚è¿™é‡Œæ€»ç»“ä¸€ä¸‹ç›¸å…³çš„å†…å®¹ï¼Œå¹¶ä¸”è¯´ä¸€ä¸‹æœ€è¿‘å®ç°çš„ä¸€ä¸ªæ’ä»¶ã€‚ å¯¹äºå·²ç»äº†è§£å¤§æ¦‚protoçš„äººæ¥è¯´ï¼Œç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯å¦‚æœæ˜¯è‡ªå®šä¹‰optionå‘¢ï¼Ÿä½ åˆäº†è§£å—ï¼Ÿ éœ€æ±‚12345678910111213141516171819202122232425262728293031323334&#x2F;&#x2F; test.protosyntax &#x3D; &quot;proto3&quot;;package pb;option go_package &#x3D; &quot;&#x2F;;pb&quot;;import &quot;unknow.proto&quot;;service ApiIMService &#123; rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123; option (unknow.api.http) &#x3D; &#123; method: &quot;post&quot; url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot; &#125;; &#125;&#125;&#x2F;&#x2F; è®¾å¤‡ç±»å‹enum ApiIMDeviceType &#123; API_IM_UNKNOWN &#x3D; 0; API_IM_Android &#x3D; 1; API_IM_IOS &#x3D; 2; API_IM_Window &#x3D; 3; API_IM_MacOS &#x3D; 4; API_IM_Web &#x3D; 5;&#125;message ApiIMRegisterDeviceReq &#123; ApiIMDeviceType type &#x3D; 1; &#x2F;&#x2F; è®¾å¤‡ç±»å‹&#125;message ApiIMRegisterDeviceResp &#123; int64 device_id &#x3D; 1; &#x2F;&#x2F; è®¾å¤‡id&#125; æˆ‘ä»¬çœ‹åˆ°è¿™ä¸€ä¸ªprotoæ–‡ä»¶ï¼Œå¸¸è§„çš„æˆ‘å°±ä¸è¯´äº†ã€‚ä¸»è¦æ˜¯çœ‹åˆ°import &quot;unknow.proto&quot;, option (unknow.api.http) å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘è¿™é‡Œå¼•å…¥ä¸€ä¸ªunknow.protoçš„æ–‡ä»¶ã€‚ æˆ‘å¸Œæœ›æœ€ç»ˆç”Ÿæˆä¸€ä¸ªapi.unknow.goçš„æ–‡ä»¶ã€‚é‡Œé¢çš„å†…å®¹æœŸå¾…å¦‚ä¸‹ï¼š 123456789101112131415161718192021// Copyright (c) 2021, whiteCcinn Inc.// Code generated by protoc-gen-unknow. DO NOT EDIT.// source: test.protopackage pbtype Api struct &#123; Name string Method string Url string&#125;func newApi(name, method, url string) *Api &#123; return &amp;Api&#123; name, method, url, &#125;&#125;var ( RegisterDeviceApi = newApi(\"RegisterDevice\", \"post\", \"/v1/im/register_device\")) ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæˆ‘å¯ä»¥åœ¨é¡¹ç›®é€šè¿‡pb.RegisterDeviceApiæ‹¿åˆ°åœ¨protoå®šä¹‰å¥½çš„APIå†…å®¹ã€‚ 12345678910111213141516171819&#x2F;&#x2F; unknow.protosyntax &#x3D; &quot;proto3&quot;;package unknow.api;option go_package &#x3D; &quot;&#x2F;;pb&quot;;import &quot;google&#x2F;protobuf&#x2F;descriptor.proto&quot;;extend google.protobuf.MethodOptions &#123; &#x2F;&#x2F; See &#96;HttpRule&#96;. HttpRule http &#x3D; 72295728;&#125;message HttpRule &#123; string url &#x3D; 1; string method &#x3D; 2;&#125; google/api/annotations.proto google/api/http.proto google/protobuf/descriptor.proto å¦‚æœæœ‰äº†è§£è¿‡google/api/annotations.proto å’Œ google/api/http.protoçš„äººåº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œå½“ä½ éœ€è¦ç”¨åˆ°grpc-gatewayæˆ–è€…proto-gen-swaagerçš„æ—¶å€™ï¼Œéƒ½ä¼šæœ‰ä»‹ç»åˆ°option(goggle.api.http)çš„ç”¨æ³•ã€‚ è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°unknow.protoçš„ç»“æ„ä½“ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ã€‚ç”¨äºå®ç°è‡ªå®šä¹‰çš„optionç”¨çš„ã€‚ unknow.protoå¯¹äºåŸºç¡€çš„è¯­æ³•è§„åˆ™æ¥è¯´ï¼Œæˆ‘ä»¬æ¥çœ‹å‰–æä¸€ä¸‹unknow.protoï¼Œå¸¸è§„çš„å°±ä¸è¯´äº†ã€‚ 1234567891011package unknow.api;extend google.protobuf.MethodOptions &#123; &#x2F;&#x2F; See &#96;HttpRule&#96;. HttpRule http &#x3D; 72295728;&#125;message HttpRule &#123; string url &#x3D; 1; string method &#x3D; 2;&#125; å¯¹äºextendçš„ç”¨æ³•ï¼Œæˆ‘è¿™é‡Œåˆ—ä¸€ä¸‹å®˜æ–¹çš„é“¾æ¥ã€‚ Custom Options æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œï¼Œextend google.protobuf.MethodOptionsã€‚ ä»£è¡¨ç€ï¼Œæˆ‘è¿™é‡Œè‡ªå®šä¹‰ä¸ªä½œç”¨äºMethodçš„optionã€‚æ‰€ä»¥åœ¨çœŸæ­£çš„protoæ–‡ä»¶ä¸­ï¼Œæˆ‘å°±å¯ä»¥ä½¿ç”¨unknow.api.optionçš„æ ‡ç­¾ã€‚ä¹Ÿå°±æ˜¯option (unknow.api.http)ã€‚ æ¥ç€æˆ‘ä»¬çœ‹åˆ°ï¼Œè¿™ä¸ªoptionæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå…ƒç´ ï¼Œç±»å‹æ˜¯Message HttpRuleï¼Œå‘½åä¸ºhttpï¼Œå¹¶ä¸”ç»™å®ƒå®šä¹‰ä¸€ä¸ªå”¯ä¸€çš„Numberã€‚ æ¥ç€æˆ‘ä»¬çœ‹åˆ°HttpRuleï¼Œå†…éƒ¨å­˜åœ¨2ä¸ªå…ƒç´ ï¼Œä¸€ä¸ªæ˜¯string url å’Œ string methodï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç‹¬ç«‹è¡Œå†™æ³•ï¼šoption (unknow.api.http).url = &quot;/v1/im/register_device&quot;ï¼Œç„¶åå†ä¸‹ä¸€è¡Œä½¿ç”¨ option (unknow.api.http).method = &quot;post&quot;ï¼Œä¸€ä¸ªå®Œæ•´çš„ä¾‹å¦‚å¦‚ä¸‹ï¼š åˆšæ‰è¯´åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªmethodçš„optionï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™é‡Œå®šä¹‰çš„rpcä¸‹çš„ optionã€‚ 123456service ApiIMService &#123; rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123; option (unknow.api.http).method &#x3D; &quot;post&quot; option (unknow.api.http).url &#x3D; &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot; &#125;&#125; é™¤äº†è¿™ä¸ªå†™æ³•ï¼Œæˆ‘æ›´æ¨èå¦‚ä¸‹æ›´ç®€æ´çš„å†™æ³•ï¼Œç”¨mapçš„å†™æ³•ï¼š 12345678service ApiIMService &#123; rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123; option (unknow.api.http) &#x3D; &#123; method: &quot;post&quot; url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot; &#125;; &#125;&#125; è¿™æ ·å­ï¼Œæˆ‘ä»¬å°±çœ‹æ‡‚äº†test.protoçš„å†…å®¹äº†å¯¹å§ã€‚è¿è´¯èµ·æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è¿™ä¸ªunknow.protoå°±æ˜¯ç”¨äºå®ç°option(unknow.api.http)ã€‚è€Œoption(unknow.api.http)çš„ä½¿ç”¨åˆ™åœ¨test.protoè¿›è¡Œé‡‡ç”¨ã€‚ å¥½äº†ï¼Œæœ‰äº†å®šä¹‰çš„æ–‡ä»¶ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬çš„é‡ç‚¹äº†ï¼Œå¦‚ä½•ç¼–å†™ä¸€ä¸ªå®ç°è‡ªå®šä¹‰ä»£ç çš„protobufæ’ä»¶æ‰©å±• æ‰©å±•å®ç° protobufè§£ææ—§ç‰ˆçš„æµç¨‹å›¾ï¼Œä¾¿äºæˆ‘ä»¬ç†è§£ã€‚æ–°ç‰ˆçš„åç»­æˆ‘æŠ½ç©ºå†ç”»ç”» ä¸ç§‘å­¦çš„ä¾‹å­ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œä»¥golangæ—§ç‰ˆproto-gen-goä¸ºä¾‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package mainimport ( &quot;io&#x2F;ioutil&quot; &quot;os&quot; &quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;proto&quot; &quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;protoc-gen-go&#x2F;generator&quot;)func main() &#123; &#x2F;&#x2F; Begin by allocating a generator. The request and response structures are stored there &#x2F;&#x2F; so we can do error handling easily - the response structure contains the field to &#x2F;&#x2F; report failure. g :&#x3D; generator.New() data, err :&#x3D; ioutil.ReadAll(os.Stdin) if err !&#x3D; nil &#123; g.Error(err, &quot;reading input&quot;) &#125; if err :&#x3D; proto.Unmarshal(data, g.Request); err !&#x3D; nil &#123; g.Error(err, &quot;parsing input proto&quot;) &#125; if len(g.Request.FileToGenerate) &#x3D;&#x3D; 0 &#123; g.Fail(&quot;no files to generate&quot;) &#125; g.CommandLineParameters(g.Request.GetParameter()) &#x2F;&#x2F; Create a wrapped version of the Descriptors and EnumDescriptors that &#x2F;&#x2F; point to the file that defines them. g.WrapTypes() g.SetPackageNames() g.BuildTypeNameMap() g.GenerateAllFiles() &#x2F;&#x2F; Send back the results. data, err &#x3D; proto.Marshal(g.Response) if err !&#x3D; nil &#123; g.Error(err, &quot;failed to marshal output proto&quot;) &#125; _, err &#x3D; os.Stdout.Write(data) if err !&#x3D; nil &#123; g.Error(err, &quot;failed to write output proto&quot;) &#125;&#125; \bæˆ‘å‘ç°ç°åœ¨ç½‘ä¸Šå¾ˆå¤šæ•™ç¨‹éƒ½ä¼šä»¥æ—§ç‰ˆçš„ä¸ºä¸»ï¼Œå¹¶ä¸”éƒ½æ˜¯æ²¿ç”¨å‚è€ƒäº†proto-gen-goçš„è¿™ä¸ªæ—§ç‰ˆçš„å†™æ³•ï¼Œæ‰€ä»¥å¯¼è‡´ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ å†™çš„æ—¶å€™ï¼Œä¼šå‡ºç°ä¸€äº›é—®é¢˜ã€‚å¹¶ä¸”å…¶å®ä½ ç”¨äº†æ—§ç‰ˆçš„è¿™ä¸ªå†™æ³•ï¼Œå½“ä½ åœ¨ç”¨protocå»ç¼–è¯‘çš„æƒ…å†µä¸‹ï¼Œprotocä¹Ÿä¼šå‹å¥½çš„æç¤ºä½ ï¼Œè¯¥APIå·²ç»è¢«åºŸå¼ƒï¼Œå°†åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸‹ç§»é™¤ï¼Œè¯·ä½¿ç”¨æ–°çš„å†™æ³•ã€‚è™½ç„¶ä½ è¿˜æ˜¯èƒ½ç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯ä½ ä¸æ•¢ä¿è¯æœªæ¥å“ªä¸€ä¸ªç‰ˆæœ¬å°±ç›´æ¥ä¸å‘åå…¼å®¹äº†ã€‚ ç¬¬äºŒä¸ªä¾‹å­ã€‚ 12345678910input, _ := ioutil.ReadAll(os.Stdin)var req pluginpb.CodeGeneratorRequestproto.Unmarshal(input, &amp;req)// ä½¿ç”¨é»˜è®¤é€‰é¡¹åˆå§‹åŒ–æˆ‘ä»¬çš„æ’ä»¶opts := protogen.Options&#123;&#125;plugin, err := opts.New(&amp;req)if err != nil &#123; panic(err)... è¿™ç§æ–¹å¼å°±æ˜¯ä»å¤´åˆ°å°¾éƒ½è‡ªå·±å†™ï¼ŒæŠŠæ•´ä¸ªpipelineçš„æµç¨‹éƒ½è‡ªå·±å¤„ç†ã€‚ä½†æ˜¯å¤§å¯ä¸å¿…ï¼Œå› ä¸ºå…¶å®æœ‰å¾ˆå¤šæµç¨‹åŒ–çš„ä¸œè¥¿ï¼Œåœ¨æ–°ç‰ˆçš„genproä¸‹å·²ç»å°è£…æˆäº†ä¸€ä¸ªRunä¼ é€’å›è°ƒå‡½æ•°å³å¯ã€‚ æ­£ç¡®çš„ä¾‹å­å¦‚æœçœŸçš„è¦å‚è€ƒçš„è¯ï¼Œæ¨èå‚è€ƒæœ€æ–°ç‰ˆæœ¬çš„proto-gen-go é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸€ç‚¹ï¼Œæˆ‘ä»¬åœ¨é‡‡ç”¨protocå¯¹protoæ–‡ä»¶è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ï¼Œç»å¸¸æ˜¯æ‰§è¡Œç±»ä¼¼å¦‚ä¸‹ä»£ç ï¼š 12protoc -I.:$&#123;GOGO_PROTOBUF&#125; \\--gofast_out=plugins=grpc:./go-pb \bç”±äºè¿™é‡Œæˆ‘ç”¨çš„æ˜¯gogoprotobufï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°æˆ‘è¿™é‡Œçš„æ˜¯--gofast_out=plugins=grpc:./go-pbï¼Œå¦‚æœä½ æ˜¯protobufçš„å®˜æ–¹çš„proto-gençš„è¯ï¼Œé‚£ä¹ˆä½ è¿™é‡Œåº”è¯¥æ˜¯--go_out=plugins=grpc:./go-pb è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Œå°±æ˜¯æ’ä»¶äºŒè¿›åˆ¶æ–‡ä»¶åï¼Œè¿™æ˜¯æœ‰ä¸€å®šè§„åˆ™çš„ï¼Œè¿™æ˜¯æˆ‘ä¹‹å‰åœ¨è‡ªå®šä¹‰gitå‡­æ®æ–‡ç« ä¸­è¯´æ˜çš„ä¸€æ ·ï¼Œè¿™äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦åœ¨ä½ çš„ç¯å¢ƒå˜é‡ä¸­ï¼Œå¦åˆ™ä½ å°±éœ€è¦é€šè¿‡-Iæ¥æŒ‡å®šæ–‡ä»¶è·¯å¾„ã€‚ç„¶åå‘½åè§„åˆ™ä¸ºproto-gen-xxxï¼Œè€Œè¿™ä¸ªxxxå°±æ˜¯ä½ çš„è‡ªå®šä¹‰çš„åå­—ã€‚åœ¨æœ¬ä¾‹å­ä¸­ï¼Œæˆ‘çš„æ‰©å±•åå­—å°±æ˜¯proto-gen-unknowã€‚ å› æ­¤ï¼Œæœ€ç»ˆå¦‚æœæˆ‘è¦æ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 12protoc -I.:$&#123;GOGO_PROTOBUF&#125; \\--unknow_out=./go-pb å…¶å®å¦‚æœæœ‰æ¥è§¦è¿‡thrift æˆ–è€… Rustçš„å…ƒç¼–ç¨‹ ç”šè‡³æ˜¯ Pythonçš„ lark-parserè‡ªå®šä¹‰æŠ½è±¡è¯­æ³•æ ‘ï¼Œæˆ–è€…å…¶ä»–ç»ç”±ASTæŠ½è±¡è¯­æ³•æ ‘å†™ä»£ç çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ï¼Œè¿™å…¶å®æŠ½è±¡å‡ºæ¥å°±æ˜¯ä¸€ä¸ªASTçš„è§£æå¤„ç†è€Œå·²ã€‚æ‰€ä»¥æˆ‘é¦–å…ˆéœ€è¦äº†è§£ä»–çš„éƒ¨ç½²ã€‚ ä¸€ä¸ªç®€é™‹çš„ASTå®šä¹‰å¦‚ä¸‹ï¼ˆå“ˆå“ˆï¼Œç•¥æ˜¾ç®€é™‹ï¼Œä½†æ˜¯äº†è§£ASTæ˜¯å•¥çš„åº”è¯¥å¤šå°‘èƒ½çœ‹æ‡‚ä¸€äº›ï¼‰ï¼š 12345678910FileDescriptor -&gt; ServiceDescriptor -&gt; ServiceOptionDescriptor -&gt; MethodDescriptor -&gt; MethodOptionDescriptor -&gt; [MessageDescriptor] -&gt; MessageDescriptor -&gt; MessageOptionDescriptor -&gt; FieldDescriptor -&gt; FieldOptionDescriptor -&gt; FieldOptionDescriptor çŸ¥é“æ€ä¹ˆæ‰§è¡Œäº†ï¼Œå’ŒAST, æˆ‘ä»¬å°±æ¥çœ‹çœ‹æ€ä¹ˆç¼–å†™ä»£ç ã€‚ 12345678910111213âœ protoc-gen-unknow git:(main) tree.â”œâ”€â”€ README.mdâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ internalâ”‚ â””â”€â”€ unknow.goâ”œâ”€â”€ main.goâ”œâ”€â”€ outâ”‚ â””â”€â”€ unknow.pb.goâ””â”€â”€ proto â”œâ”€â”€ descriptor.proto â””â”€â”€ unknow.proto å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯æˆ‘çš„ä¸€ä¸ªä»£ç ç»“æ„ç›®å½• 1234567891011package mainimport ( \"internal\" \"google.golang.org/protobuf/compiler/protogen\")func main() &#123; u := internal.Unknow&#123;&#125; protogen.Options&#123;&#125;.Run(u.Generate)&#125; \bè¿™é‡Œï¼Œæˆ‘ä»¬å€ŸåŠ©protobuf ç¼–è¯‘åŒ…ä¸‹çš„ protogen å·¥å…·æ¥è§£æ proto æ–‡ä»¶ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ internal åŒ…ä¸‹å…·ä½“çš„å†™æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135package internalimport ( pb \"out\" \"google.golang.org/protobuf/compiler/protogen\" \"google.golang.org/protobuf/proto\" \"google.golang.org/protobuf/types/descriptorpb\")type Unknow struct &#123;&#125;func (u Unknow) Generate(plugin *protogen.Plugin) error &#123; if len(plugin.Files) &lt; 1 &#123; return nil &#125; // æŒ‡å®šç”Ÿæˆæ–‡ä»¶çš„æ–‡ä»¶å filename := \"/api.unknow.go\" // åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ç”Ÿæˆå™¨å¯¹è±¡ g := plugin.NewGeneratedFile(filename, plugin.Files[len(plugin.Files)-1].GoImportPath) // è°ƒç”¨g.På°±æ˜¯å¾€æ–‡ä»¶å¼€å§‹å†™å…¥è‡ªå·±æœŸå¾…çš„ä»£ç  g.P(`// Copyright (c) 2021, whiteCcinn Inc.`) g.P(\"// Code generated by protoc-gen-unknow. DO NOT EDIT.\") g.P(\"// source: all MethodOptions(unknow.api.http) in proto file\") g.P() g.P(\"package \", plugin.Files[len(plugin.Files)-1].GoPackageName) g.P(`type Api struct &#123; Name string Method string Url string&#125;func newApi(name, method, url string) *Api &#123; return &amp;Api&#123; name, method, url, &#125;&#125;`) g.P(\"var (\") //\b é€šè¿‡plugin.Fielsï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°æ‰€æœ‰çš„è¾“å…¥çš„protoæ–‡ä»¶ // å¦‚æœæˆ‘ä»¬éœ€è¦å¯¹è¿™ä¸ªæ–‡ä»¶ç”Ÿæˆä»£ç çš„è¯ï¼Œé‚£ä¹ˆå°±è¿›å…¥åˆ°generateFile()é€»è¾‘ // å¹¶ä¸”æŠŠgå’Œfä¸€èµ·ä¼ é€’è¿‡å» for _, f := range plugin.Files &#123; if f.Generate &#123; if _, err := u.generateFile(g, f); err != nil &#123; return err &#125; &#125; &#125; g.P(\")\") return nil&#125;func (u Unknow) generateFile(g *protogen.GeneratedFile, file *protogen.File) (*protogen.GeneratedFile, error) &#123; // è¿™ä¸€æ®µä»£ç ä»…ä»…åªæ˜¯ä¸ºäº†å¿½ç•¥åŒ…å«protoæ–‡ä»¶ä¸­åŒ…å«äº†streamClientå’ŒstreamServerçš„ä»£ç  isGenerated := false for _, srv := range file.Services &#123; for _, method := range srv.Methods &#123; if method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123; continue &#125; isGenerated = true &#125; &#125; if !isGenerated &#123; return nil, nil &#125; // file çš„ä¸‹ä¸€å±‚çº§å°±æ˜¯ services å±‚çº§ for _, srv := range file.Services &#123; if err := u.genService(g, srv); err != nil &#123; return nil, err &#125; &#125; return g, nil&#125;func (u Unknow) genService(g *protogen.GeneratedFile, srv *protogen.Service) error &#123; // service å†…éƒ¨æœ‰å¾ˆå¤š rpc å…³é”®å­—çš„æ–¹æ³• for _, method := range srv.Methods &#123; if method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123; continue &#125; // ç”±äºæˆ‘ä»¬è‡ªå®šä¹‰çš„æ˜¯å°±æ˜¯MethodOptionsï¼Œæ‰€ä»¥å°±æ¥åˆ°äº†è¿™é‡Œæ¥è¿›è¡Œåˆ¤æ–­ if err := u.genMethodHTTPRule(g, method); err != nil &#123; return err &#125; &#125; return nil&#125;func (u Unknow) genMethodHTTPRule(g *protogen.GeneratedFile, method *protogen.Method) error &#123; // å› ä¸ºæˆ‘ä»¬é€šè¿‡method.Desc.Options() æ‹¿åˆ°çš„æ•°æ®ç±»å‹æ˜¯`interface&#123;&#125;` ç±»å‹ // æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å¯¹Optionsï¼Œæ˜ç¡®æŒ‡å®šè½¬æ¢ä¸º *descriptorpb.MethodOptions ç±»å‹ // è¿™æ ·å­å°±èƒ½æ‹¿åˆ°æˆ‘ä»¬çš„MethodOptionå¯¹è±¡ options, ok := method.Desc.Options().(*descriptorpb.MethodOptions) if !ok &#123; return nil &#125; // PSï¼šé‡ç‚¹ // è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å€ŸåŠ©äº†ä¸€ä¸ªéprotogenä¸‹çš„åŒ…çš„å†…å®¹ // åŸå› å°±æ˜¯ï¼Œprotobufç¼–è¯‘å™¨ä¼šæŠŠè‡ªå®šä¹‰çš„Optionå…¨éƒ¨æŒ‡å®šä¸ºExtensionï¼Œç”±äºå¹¶éå†…ç½®çš„å±æ€§å’Œå€¼ // protobufå®˜æ–¹æ˜¯æ²¡åŠæ³•æ‹¿åˆ°å’Œä½ å¯¹åº”çš„å¯è¯»çš„å†…å®¹çš„ï¼Œåªèƒ½é€šè¿‡æ‹¿åˆ°ç»è¿‡åºåˆ—åŒ–ä¹‹åçš„æ•°æ®ã€‚ // å› æ­¤ï¼Œæˆ‘ä»¬è¿™é‡Œé€šè¿‡ proto.GetExtensionçš„æ–¹æ³•ï¼ŒæŠŠåˆšæ‰unknow.protoå•ç‹¬ç¼–è¯‘å¥½çš„ unknow.pb.proto æ–‡ä»¶ä¸‹çš„ pb. E_HTTP åŠ è½½è¿›æ¥ï¼ŒæŒ‡å®šäº†æˆ‘éœ€è¦åœ¨è‡ªå®šä¹‰æ‰©å±•çš„MethodOptionsä¸­ï¼Œæ‹¿åˆ°è¯¥Httpä¸‹é‡Œé¢çš„value // ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å†ç»è¿‡ä¸€æ¬¡ç±»å‹è½¬æ¢ï¼Œå°±å¯ä»¥æ‹¿åˆ°äº†å…·ä½“çš„httpRule httpRule, ok := proto.GetExtension(options, pb.E_Http).(*pb.HttpRule) if !ok &#123; return nil &#125; // æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡GetXxxçš„æ–¹å¼ï¼Œæ¥è·å–æˆ‘ä»¬è®¾ç½®åœ¨å…¶Messageå†…éƒ¨filed m := httpRule.GetMethod() url := httpRule.GetUrl() if len(m) == 0 &amp;&amp; len(url) == 0 &#123; return nil &#125; g.P(\" \", method.GoName, \"Api = \", \"newApi(\\\"\", method.GoName, \"\\\", \\\"\", m, \"\\\", \\\"\", url, \"\\\")\") return nil&#125; è¯·è·Ÿç€è¯´æ˜ä¸­æ³¨é‡Šä¸€æ­¥æ­¥æŸ¥çœ‹è¯¦è§£ æŸ¥çœ‹è¿™æ®µä»£ç é€»è¾‘ï¼Œä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œå› ä¸ºæ²¡æœ‰ç‰¹åˆ«å¤æ‚çš„é€»è¾‘ï¼Œå°½é‡ä¸è¦è·³è¿‡ï¼Œå› ä¸ºé‡Œé¢æ¶‰åŠåˆ°å¦‚ä½•è¯»å–è‡ªå®šä¹‰çš„Optionçš„é—®é¢˜ã€‚ä»£ç å¤§è‡´å®šä½åœ¨ proto.GetExtensionæ–¹æ³•é™„è¿‘ã€‚ å› ä¸ºè¿™é‡Œçš„demoç”Ÿæˆçš„ä»£ç æ¯”è¾ƒç®€å•ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬ç”Ÿæˆçš„ä»£ç å°±æ˜¯ï¼š 123456789101112131415161718192021// Copyright (c) 2021, whiteCcinn Inc.// Code generated by protoc-gen-unknow. DO NOT EDIT.// source: source: all MethodOptions(unknow.api.http) in proto filepackage pbtype Api struct &#123; Name string Method string Url string&#125;func newApi(name, method, url string) *Api &#123; return &amp;Api&#123; name, method, url, &#125;&#125;var ( RegisterDeviceApi = newApi(\"RegisterDevice\", \"post\", \"/v1/im/register_device\")) æ”¾ä¸€ä¸‹å®Œæ•´çš„æµ‹è¯•å‘½ä»¤: 1go install . &amp;&amp; protoc --proto_path proto/ -I=. test.proto test2.proto --unknow_out=./out --go_out=./out æœ€åç”Ÿæˆçš„æ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 123456789101112131415161718âœ protoc-gen-unknow git:(main) tree.â”œâ”€â”€ README.mdâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ internalâ”‚ â””â”€â”€ unknow.goâ”œâ”€â”€ main.goâ”œâ”€â”€ outâ”‚ â”œâ”€â”€ api.unknow.goâ”‚ â”œâ”€â”€ test.pb.goâ”‚ â”œâ”€â”€ test2.pb.goâ”‚ â””â”€â”€ unknow.pb.goâ””â”€â”€ proto â”œâ”€â”€ descriptor.proto â”œâ”€â”€ test.proto â”œâ”€â”€ test2.proto â””â”€â”€ unknow.protos æœ€åæ¨èå‡ ä¸ªæ‰©å±•åº“å†™å¾—ä¸é”™çš„æ‰©å±•æ’ä»¶: protoc-gen-grpc-gateway protoc-gen-grpc-openapiv2 protoc-gen-grpc-gohttp","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€Golangã€‘- []byteåœ¨ç»“æ„ä½“çš„å‹å¥½å¯è¯»æ€§å¤„ç†","slug":"Golang/[]byteåœ¨ç»“æ„ä½“çš„å‹å¥½å¯è¯»æ€§å¤„ç†","date":"2021-09-03T03:16:51.000Z","updated":"2021-09-03T05:55:43.831Z","comments":true,"path":"2021/09/03/Golang/[]byteåœ¨ç»“æ„ä½“çš„å‹å¥½å¯è¯»æ€§å¤„ç†/","link":"","permalink":"http://blog.crazylaw.cn/2021/09/03/Golang/[]byte%E5%9C%A8%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%8F%8B%E5%A5%BD%E5%8F%AF%E8%AF%BB%E6%80%A7%E5%A4%84%E7%90%86/","excerpt":"å‰è¨€æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œ[]byte ç±»å‹åœ¨ struct ä¸­ï¼Œæ˜¯å¿…ä¸å¯å°‘çš„ç»“æ„ä½“ï¼Œå› ä¸ºç”¨äº†[]byte\u001cä»£è¡¨å¯ä»¥å­˜å‚¨å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå¯ä»¥å«åšäºŒè¿›åˆ¶å®‰å…¨çš„å­˜å‚¨ã€‚ä»£è¡¨å¯ä»¥å­˜å‚¨ä»»ä½•æ•°æ®ã€‚ å¦‚ä½•æ‰èƒ½åšåˆ°åœ¨åºåˆ—åŒ–jsonçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥Printlnå‡ºä¸€ä¸ªå¯è¯»æ€§çš„åœ¨structçš„[]byteå‘¢ï¼Ÿ","text":"å‰è¨€æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œ[]byte ç±»å‹åœ¨ struct ä¸­ï¼Œæ˜¯å¿…ä¸å¯å°‘çš„ç»“æ„ä½“ï¼Œå› ä¸ºç”¨äº†[]byte\u001cä»£è¡¨å¯ä»¥å­˜å‚¨å­—èŠ‚æ•°æ®ï¼Œä¹Ÿå¯ä»¥å«åšäºŒè¿›åˆ¶å®‰å…¨çš„å­˜å‚¨ã€‚ä»£è¡¨å¯ä»¥å­˜å‚¨ä»»ä½•æ•°æ®ã€‚ å¦‚ä½•æ‰èƒ½åšåˆ°åœ¨åºåˆ—åŒ–jsonçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥Printlnå‡ºä¸€ä¸ªå¯è¯»æ€§çš„åœ¨structçš„[]byteå‘¢ï¼Ÿ å®ç°æœ€è¿‘æˆ‘åœ¨å¼€å‘æˆ‘ä»¬çš„éƒ¨é—¨çš„é…ç½®æœåŠ¡ï¼Œéœ€è¦æä¾›ä¸€ä¸ªé…ç½®å·¥å…·ã€‚é‡Œé¢è®¾è®¡çš„ä¸€ä¸ªstructï¼Œæœ‰ä¸€ä¸ª[]byteç±»å‹ï¼Œå°±æ˜¯ç”¨æ¥å­˜å‚¨å®é™…æ•°æ®çš„ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæŸ¥çœ‹åŸå§‹æ•°æ®çš„éœ€æ±‚ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ç»è¿‡äº†åŠ å¯†ï¼Œå’Œå‹ç¼©ï¼Œæœ€ç»ˆæ‰ä¼šæ”¾åˆ°è¯¥ç»“æ„ä½“ã€‚ ç®€åŒ–ç»“æ„ä½“ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ä¸‹ä¾‹å­ï¼š 1234567type V []bytetype Value struct &#123; PublishTime int64 PublishDateTime string Value V&#125; è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™é‡Œçš„Value\bå®é™…å°±æ˜¯ä¸€ä¸ª[]byteï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªç»“æ„ä½“ç»è¿‡json.Marshalä¹‹åæ¨é€åˆ°è¿œç«¯kvæœåŠ¡ä¸­ï¼Œä¸€åˆ‡éƒ½æ­£å¸¸ã€‚ ä½†æ˜¯å½“æˆ‘ä»¬éœ€è¦æŸ¥çœ‹çš„æ—¶å€™ï¼Œå°±éœ€è¦ä»è¿œç«¯çš„kvæ‹‰å›æ¥ï¼Œç»è¿‡json.Unmarshaå¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼š 1&#123;\"PublishTime\":1630636657,\"PublishDateTime\":\"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101\",\"Value\":\"MTIzCg==\"&#125; è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°Valueæ˜¯ä¸€ä¸ªç»è¿‡base64åŠ å¯†è¿‡çš„æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºé»˜è®¤æƒ…å†µä¸‹[]byteå°†ä¼šæŠŠæ•°æ®ç»è¿‡base64å˜æˆå­—ç¬¦ä¸²æ¥ç¬¦åˆjsonæ•°æ®ç±»å‹ã€‚é‚£ä¹ˆæˆ‘ä»¬æœ‰ä»€ä¹ˆç‰ˆæœ¬è®©ä»–æ˜¾ç¤ºå‡ºåŸæ¥çœŸæ˜¯çš„æ•°æ®å‘¢ï¼Ÿ è¿™é‡Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªæ–¹æ¡ˆï¼Œå€ŸåŠ©å¤šä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå¯¹T Vè¿›è¡Œä¸€ä¸ªé‡ç»„ã€‚ 12345678910111213141516type VO []bytetype ValueReadable struct &#123; PublishTime int64 PublishDateTime string Value VO&#125;func (b *VO) MarshalJSON() ([]byte, error) &#123; return *b, nil&#125;func (b *VO) UnmarshalJSON(input []byte) error &#123; *b = input return nil&#125; å®šä¹‰å¤šä¸€ä¸ªå¤§ä½“ä¸Šä¸€è‡´çš„ç»“æ„ä½“ï¼Œæ³¨æ„æ­¤æ—¶çš„Valueä¸å†æ˜¯Vï¼Œè€Œæ˜¯VOï¼Œæˆ‘ä»¬å¯¹VOè‡ªå®šä¹‰jsonåºåˆ—åŒ–çš„è¡Œä¸ºï¼Œé‚£å°±æ˜¯æŠŠbase64çš„è¡Œä¸ºç»™å»æ‰ã€‚ è¿™æ ·å­ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ•°æ®å°±ä¼šæ˜¯ 1&#123;\"PublishTime\":1630636657,\"PublishDateTime\":\"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101\",\"Value\":123&#125; ç»†å¿ƒçš„æœ‹å‹ä¸€å®šå‘ç°äº†é—®é¢˜æ‰€åœ¨ï¼Œé‚£å°±æ˜¯Valueå’ŒValueReadableæ€ä¹ˆè¿›è¡Œè½¬æ¢ã€‚ å› ä¸ºä½ å­˜çš„æ—¶å€™æ˜¯é€šè¿‡Valueè¿›è¡Œmarshalçš„ï¼Œé‚£ä¹ˆä½ çš„unmarshaè¡Œä¸ºä¸€å®šè¦å¯¹åº”æ‰èƒ½è§£åˆ°æ­£ç¡®çš„æ•°æ®ã€‚ æ‰€ä»¥è¿™é‡Œï¼Œå°±æ˜¯æˆ‘ä»¬çš„ä¸€ä¸ªé‡ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©unsafe.Pointer 1234567891011 // because []byte in struct will be base64encode// so you will see such as \"Ik1USXpDZz09Ig==\"// we should base64decode, so we custom a struct do not base64encode// struct type transform use unsafe.Pointerp := unsafe.Pointer(&amp;persistenceValue)vr := (*config_sync.ValueReadable)(p)tv, err := json.Marshal(vr)if err != nil &#123; log.Fatal(err)&#125;fmt.Println(string(tv)) æˆ‘ä»¬åˆ©ç”¨unsafeçš„æŒ‡é’ˆæ•°æ®ç±»å‹ï¼Œè¿›è¡Œä¸€ä¸ªå¼ºåˆ¶è½¬æ¢ï¼Œä¸ºä»€ä¹ˆä¼šæˆåŠŸå‘¢ï¼Œå› ä¸ºåœ¨å†…å­˜å¯¹é½çš„ç»“æ„ä¸Šï¼Œè¿™2ä¸ªå¯¹è±¡çš„å†…å­˜æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œå¼ºåˆ¶è½¬æ¢ï¼Œè€Œä¸ç”¨æ‹…å¿ƒæœ‰panicçš„äº§ç”Ÿã€‚è¿™åªæ˜¯unsafeæŒ‡é’ˆçš„ä¸€ä¸ªçµæ´»è¿ç”¨ã€‚ä½†æ˜¯å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ï¼Œååˆ†çš„æœ‰æ•ˆæœã€‚ 1&#123;\"PublishTime\":1630636657,\"PublishDateTime\":\"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101\",\"Value\":123&#125; è½¬æ¢åï¼Œå°±å¯ä»¥çœ‹åˆ°æˆ‘åŸæœ¬çš„æ•°æ®äº† 123.","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€kubernetesã€‘k8s-docker-for-mac-ç£ç›˜æŒ‚è½½","slug":"k8s/k8s-docker-for-mac-ç£ç›˜æŒ‚è½½","date":"2021-08-18T09:47:30.000Z","updated":"2021-08-18T14:45:43.337Z","comments":true,"path":"2021/08/18/k8s/k8s-docker-for-mac-ç£ç›˜æŒ‚è½½/","link":"","permalink":"http://blog.crazylaw.cn/2021/08/18/k8s/k8s-docker-for-mac-%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/","excerpt":"å‰è¨€ä¸Šä¸€æ¬¡ï¼Œæˆ‘ä»¬è¯´åˆ°äº†docker-for-mac å·²ç»å†…ç½®äº†æœ€å°åŒ–çš„k8sã€‚æˆ‘ä»¬åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™ï¼Œæˆ–å¤šæˆ–å°‘å¸Œæœ›yamlé…ç½®æ˜¯æœ€æ¥è¿‘çº¿ä¸Šç¯å¢ƒçš„é…ç½®ã€‚ å› æ­¤ï¼Œä¸Šä¸€æ¬¡ï¼Œæ•™ä¼šäº†å¤§å®¶ï¼Œå¦‚ä½•åœ¨macä¸Šå¼€å¯nfs,æŠŠæˆ‘ä»¬çš„pvå’Œæœ¬åœ°macçš„nfsè¿›è¡Œä¸€ä¸ªé€šä¿¡ã€‚ è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ¥èŠèŠdocker-for-macç£ç›˜æŒ‚åœ¨çš„ç›¸å…³å†…å®¹ã€‚","text":"å‰è¨€ä¸Šä¸€æ¬¡ï¼Œæˆ‘ä»¬è¯´åˆ°äº†docker-for-mac å·²ç»å†…ç½®äº†æœ€å°åŒ–çš„k8sã€‚æˆ‘ä»¬åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™ï¼Œæˆ–å¤šæˆ–å°‘å¸Œæœ›yamlé…ç½®æ˜¯æœ€æ¥è¿‘çº¿ä¸Šç¯å¢ƒçš„é…ç½®ã€‚ å› æ­¤ï¼Œä¸Šä¸€æ¬¡ï¼Œæ•™ä¼šäº†å¤§å®¶ï¼Œå¦‚ä½•åœ¨macä¸Šå¼€å¯nfs,æŠŠæˆ‘ä»¬çš„pvå’Œæœ¬åœ°macçš„nfsè¿›è¡Œä¸€ä¸ªé€šä¿¡ã€‚ è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬æ¥èŠèŠdocker-for-macç£ç›˜æŒ‚åœ¨çš„ç›¸å…³å†…å®¹ã€‚ è™šæ‹ŸæœºDocker for Macæ˜¯ä¸€ä¸ªåŸç”Ÿçš„è‹¹æœåº”ç”¨ç¨‹åºï¼Œè¢«å®‰è£…åˆ° /Application ç›®å½•ï¼Œå®‰è£…æ—¶ä¼šåˆ›å»º /usr/local/bin ç›®å½•ä¸‹çš„ dockerã€docker-compose ç¬¦å·é“¾æ¥ã€‚ Docker for Mac ä½¿ç”¨é€šè¿‡ Hypervisor.framework æä¾›çš„è½»é‡çº§çš„ xhyve è™šæ‹ŸåŒ–æŠ€æœ¯Docker for Mac ä¸ä½¿ç”¨ docker-machine ç®¡ç†è™šæ‹ŸæœºDocker for Mac ä¸é€šè¿‡ TCP ç«¯å£é€šä¿¡ï¼Œåè€Œä½¿ç”¨ docker.sock å¥—æ¥å­—æ–‡ä»¶é€šä¿¡ï¼ˆå®é™…ä¸Šæ˜¯å°† /var/tmp ç›®å½•æŒ‚è½½åˆ°äº†è™šæ‹Ÿæœºä¸­ï¼Œè™šæ‹Ÿæœºåœ¨å…¶ä¸­ç”Ÿæˆå¥—æ¥å­—æ–‡ä»¶ï¼‰ ä½†æ˜¯å°½ç®¡å¦‚æ­¤ï¼Œä½ å¯ä»¥ç†è§£ä¸ºè¿˜æ˜¯å­˜åœ¨è™šæ‹Ÿæœºçš„ã€‚è¿™ä¸ªè™šæ‹Ÿæœºçš„ä½œç”¨å°±æ˜¯å…è®¸åœ¨macosä¸Šè¿è¡Œdockerã€‚ docker for mac è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„docker-for-macçš„æ¡Œé¢ç‰ˆå®¢æˆ·ç«¯ã€‚ æ ¹æ®ä¸Šé¢è¿™ä¸ªå›¾ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ‰€æœ‰çš„é•œåƒéƒ½å­˜å‚¨åœ¨ã€‚ /Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data (è®°å¾—ä¿®æ”¹ä¸ºè‡ªå·±çš„è·¯å¾„ï¼Œå°±æ˜¯æˆ‘è¿™é‡Œçš„caiwenhui) 123456789101112131415161718192021222324252627âœ ~ ll /Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/datatotal 103652496-rw-r--r-- 1 caiwenhui staff 96G 8 18 20:21 Docker.rawâœ ~ head -n 10 /Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.rawï¿½Dï¿½ï¿½?ï¿½ï¿½ï¿½ Uï¿½`ï¿½&amp;3ï¿½Ñº`1Oï¿½ï¿½ ï¿½haï¿½haï¿½ï¿½Sï¿½Jï¿½#` &lt;ï¿½kD*ï¿½&lt;O5Kï¿½VSï¿½~~ï¿½/var/libï¿½ï¿½Bï¿½uKï¿½ï¿½ï¿½ï¿½Jï¿½1ï¿½@ ]ï¿½#`ï¿½ï¿½ï¿½pï¿½ï¿½q Zï¿½]J, )NLï¿½ï¿½ï¿½ï¿½ï¿½ï¿½w)ï¿½ï¿½%ï¿½z?fw G/ï¿½%|gCÔ¬?fï¿½u ))ï¿½% ï¿½.?f ï¿½% |?f) ï¿½% ï¿½ï¿½?f)ï¿½ (L ï¿½ X %X i;ï¿½F!)D0 M %@ï¿½\")ï¿½ ï¿½ï¿½ Ö‘ @#)ï¿½ ï¿½ ï¿½fï¿½H$)\" - :,ï¿½%)ï¿½ ï¿½e LEï¿½ï¿½()\"h ï¿½a ï¿½ï¿½Snî±ªU&amp;43ï¿½%ï¿½C4kï¿½?f ï¿½% &#123; ï¿½% ï¿½D WA T Ò› ï¿½ï¿½ ï¿½ï¿½v&amp;)ï¿½\" tï¿½ FWï¿½D') &#125;ï¿½1 &amp;ï¿½ ï¿½ ï¿½ (A ï¿½ï¿½ =ï¿½97 ï¿½; ï¿½&amp;N ï¿½ _ZË­ï¿½ ï¿½ ï¿½ï¿½ ï¿½% F?f ï¿½0 ï¿½Vï¿½ï¿½ s ï¿½% Ô‡ ï¿½% Xï¿½ ï¿½% sï¿½?f ï¿½RiDX0ï¿½mï¿½&#125;ï¿½u ï¿½ ï¿½@$ï¿½ï¿½ï¿½w?ï¿½ ï¿½% ï¿½ï¿½?f ï¿½% ï¿½ï¿½?f. ï¿½ Õ‡ï¿½ ï¿½% MS?f W s ï¿½wï¿½ ï¿½ ! ï¿½oï¿½ ï¿½% Eï¿½?f ï¿½% nï¿½?f æˆ‘ä»¬è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–‡ä»¶ï¼Œå ç”¨äº†96Gï¼Œå°±æ˜¯æˆ‘æ‰€åˆ†é…çš„ç£ç›˜å¤§å°ã€‚å¹¶ä¸”è¿™æ˜¯ä¸€ä¸ªç»è¿‡äº†å­—èŠ‚å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ è¿™å¼ å›¾ï¼Œç®—å¾—ä¸Šæ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹ã€‚ ä½¿ç”¨æ–‡ä»¶å…±äº«å…è®¸ Mac ä¸Šçš„æœ¬åœ°ç›®å½•ä¸ Linux å®¹å™¨å…±äº«ã€‚é»˜è®¤æƒ…å†µä¸‹/Usersï¼Œ/Volumeã€/privateã€/tmpå’Œ/var/foldersç›®å½•æ˜¯å…±äº«çš„ã€‚å¦‚æœæ‚¨çš„é¡¹ç›®åœ¨æ­¤ç›®å½•ä¹‹å¤–ï¼Œåˆ™å¿…é¡»å°†å…¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚å¦åˆ™ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶å¾—åˆ°Mounts deniedæˆ–cannot start serviceå‡ºé”™ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ‰å‡ ä¸ªç›®å½•æ˜¯å·²ç»è¢«å…±äº«çš„äº†ã€‚æˆ‘ä»¬é‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯/Usersç›®å½•ï¼Œå› ä¸ºæˆ‘ä»¬å¸¸å¸¸æŠŠæˆ‘ä»¬çš„æ‰€æœ‰ä¸ªäººç”¨æˆ·ç›¸å…³çš„ä¸œè¥¿ï¼Œéƒ½ä¼šæ”¾åœ¨å¯¹åº”ç”¨æˆ·ä¸‹ï¼Œå°±æˆ‘è€Œè¨€ï¼Œæˆ‘ä¼šæŠŠæ‰€æœ‰çš„ä»£ç éƒ½åœ¨ /Users/caiwenhui/www ä¸‹ï¼Œè¿™ä¹Ÿæ„å‘³ç€ï¼Œæˆ‘çš„æ‰€æœ‰ä»£ç ï¼Œéƒ½å°†ä¼šè¢«è™šæ‹ŸæœºåŒæ­¥åˆ°linuxç³»ç»Ÿä¸­ï¼Œä¹Ÿæ­£æ˜¯å› æ­¤ï¼Œå½“ä½ åœ¨MACç³»ç»Ÿä¸‹ï¼Œæ‰§è¡Œdocker run -v $(PWD):/www xxxä¹‹ç±»çš„å‘½ä»¤çš„æ—¶å€™ï¼Œä½ å¯ä»¥æˆåŠŸçš„æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚å¦‚æœä½ æŠŠæŒ‚è½½çš„ç›®å½•æ”¾åœ¨ä¸Šè¿°çš„å‡ ä¸ªç›®å½•ä¹‹å¤–ï¼Œdockerå‘½ä»¤å°†ä¼šæŒ‚è½½å¤±è´¥ã€‚ ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œä½ ä¼šå‘ç°ï¼Œå½“ä½ çš„ä»£ç ï¼Œåœ¨ä¸‹è½½å¤§é‡ä¾èµ–ï¼Œæˆ–è€…åœ¨æ„å»ºä¸€å †ç´¢å¼•çš„æ—¶å€™ï¼Œæˆ–è€…ä½ çš„/Usersç›®å½•ä¸‹æœ‰å¾ˆå¤šæ–‡ä»¶åœ¨å˜åŠ¨çš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°ä½ çš„CPUå˜æˆå¼‚å¸¸çš„é«˜ï¼Œè€Œä¸”ä¼šç‰¹åˆ«å¡ï¼Œå¯èƒ½ä½ ä¼šè§‰å¾—æ€ä¹ˆé‚£ä¹ˆå¡ã€‚å¦‚æœä½ ä¸å»æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹å ç”¨é‚£ä¹ˆå¤šcpuçš„è¯ï¼Œä½ æ°¸è¿œä¸ä¼šçŸ¥é“ï¼Œå…¶å®å¤§å¤šæ•°ï¼Œæ˜¾ç¤ºå‡ºæ¥éƒ½æ˜¯dockerçš„è™šæ‹Ÿæœºå ç”¨çš„cpuä¸ºå¤§å¤´å°±æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ã€‚ è·å–è™šæ‹Ÿæœºshellæ—¢ç„¶ï¼Œæˆ‘ä»¬çŸ¥é“äº†ä¸Šè¿°çš„å…±äº«æ–‡ä»¶äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šæƒ³çŸ¥é“ï¼Œæˆ‘è¦æ€ä¹ˆå»çœ‹ï¼Œæ€ä¹ˆå»è°ƒè¯•ï¼Œæˆ–è€…æˆ‘æœ‰ä»€ä¹ˆæ›´æ·±çš„ç†è§£å‘¢ï¼Ÿ å…¶å®æ˜¯æœ‰çš„ï¼Œä¾‹å¦‚ï¼Œæˆ‘æƒ³çœ‹çœ‹ï¼Œæ•´ä¸ªè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œéƒ½æŒ‚è½½äº†ä»€ä¹ˆæ•°æ®å·æ„æˆæˆ‘ä»¬çš„æ–‡ä»¶ç³»ç»Ÿã€‚ æˆ‘ä»¬çŸ¥é“MacOSä¸Šçš„Docker Desktop for macå®é™…ä¸Šæ˜¯åœ¨Linuxè™šæ‹Ÿæœºä¸­è¿è¡Œçš„Dockerå®¹å™¨ï¼Œè¿™å¯¹äºmacOSä¸»æœºä¸Šä½¿ç”¨Dockerå¤šäº†ä¸€å±‚è™šæ‹ŸåŒ–ã€‚æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦èƒ½å¤Ÿè®¿é—®è¿™ä¸ªLinuxè™šæ‹Ÿæœºï¼Œä»¥ä¾¿å®ç°ä¸€äº›hackæ“ä½œã€‚ netcat12âœ ~ ll ~/Library/Containers/com.docker.docker/Data/debug-shell.socksrwxr-xr-x 1 caiwenhui staff 0B 8 16 21:31 /Users/caiwenhui/Library/Containers/com.docker.docker/Data/debug-shell.sock æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªåå­—å«debug-shell.sockçš„æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„sockæ–‡ä»¶ã€‚ ä½¿ç”¨ nc å‘½ä»¤è¿æ¥Dockerçš„debug-shell socketæ–‡ä»¶: 12âœ ~ nc -U ~/Library/Containers/com.docker.docker/Data/debug-shell.sock/ # ^[[49;5R æ˜¾ç¤ºçš„æç¤ºç¬¦æ¯”è¾ƒå¥‡æ€ªï¼Œä¸è¿‡ä¸å½±å“ä½¿ç”¨ æˆ‘ä»¬ä½¿ç”¨ df -h å‘½ä»¤å¯ä»¥çœ‹åˆ°Dockerè™šæ‹Ÿæœºçš„å­˜å‚¨æŒ‚è½½: 12345678910111213141516171819202122232425262728293031323334353637383940/ # ^[[49;5Rdf -hdf -hFilesystem Size Used Available Use% Mounted onoverlay 3.9G 4.0K 3.9G 0% /tmpfs 3.9G 8.0K 3.9G 0% /containers/onboot/000-dhcpcd/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/001-sysfs/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/002-sysctl/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/003-format/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/004-extend/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/005-mount/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/006-metadata/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/007-services0/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/008-services1/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/009-swap/tmptmpfs 3.9G 0 3.9G 0% /containers/onboot/010-mount-docker/tmp/dev/vda1 94.2G 48.2G 41.2G 54% /containers/services/dev/vda1 94.2G 48.2G 41.2G 54% /containers/services/dockertmpfs 3.9G 4.0K 3.9G 0% /containers/services/acpid/tmpoverlay 3.9G 4.0K 3.9G 0% /containers/services/acpid/rootfstmpfs 3.9G 0 3.9G 0% /containers/services/binfmt/tmpoverlay 3.9G 0 3.9G 0% /containers/services/binfmt/rootfstmpfs 3.9G 8.0K 3.9G 0% /containers/services/dhcpcd/tmpoverlay 3.9G 8.0K 3.9G 0% /containers/services/dhcpcd/rootfstmpfs 3.9G 4.0K 3.9G 0% /containers/services/diagnose/tmpoverlay 3.9G 4.0K 3.9G 0% /containers/services/diagnose/rootfsoverlay 3.9G 4.0K 3.9G 0% /containers/services/diagnose/rootfstmpfs 3.9G 0 3.9G 0% /containers/onboot/011-bridge/tmptmpfs 64.0M 0 64.0M 0% /devtmpfs 796.2M 528.0K 795.7M 0% /run/resolvconf/resolv.conftmpfs 796.2M 528.0K 795.7M 0% /run/configtmpfs 796.2M 528.0K 795.7M 0% /run/containerdtmpfs 796.2M 528.0K 795.7M 0% /run/guest-servicestmpfs 796.2M 528.0K 795.7M 0% /run/host-servicestmpfs 796.2M 528.0K 795.7M 0% /run/resolvconf/resolv.conftmpfs 3.9G 0 3.9G 0% /sys/fs/cgroup/dev/vda1 94.2G 48.2G 41.2G 54% /var/lib/containerd/dev/vda1 94.2G 48.2G 41.2G 54% /var/lib/dockertmpfs 796.2M 528.0K 795.7M 0% /var/runtmpfs 796.2M 528.0K 795.7M 0% /var/run/linuxkit-containerd/containerd.sock... ä½¿ç”¨å‘½ä»¤ exit æˆ–è€…^C å¯ä»¥é€€å‡ºè¿™ä¸ªshell è¿›å…¥shellï¼Œå¯ä»¥æ‰§è¡Œ . /etc/profile è·å¾—ç¯å¢ƒ nsenterä½¿ç”¨nsenterä»å®¹å™¨å†…éƒ¨è¿›å…¥hostä¸»æœºçš„åå­—ç©ºé—´(namespace)ï¼Œä½†æ˜¯å¯¹æ–‡ä»¶ç³»ç»Ÿæ˜¯åªè¯» å¦å¤–ä¸€ç§å·§å¦™çš„æ–¹æ³•æ˜¯è¿è¡Œä¸€ä¸ªdebianå®¹å™¨ï¼Œç„¶ååœ¨è¿™ä¸ªdebianå®¹å™¨ä¸­æ‰§è¡Œ nsenter é€šè¿‡ pid=host æ¥å®ç°è¿›å…¥åˆ°è¿è¡Œ Docker4Mac çš„mini VMçš„è¿›ç¨‹ç©ºé—´ï¼Œè¿™æ ·å°±ç›¸å½“äºè¿›å…¥äº†macOSçš„Dockerè™šæ‹Ÿæœº åœ¨è¿™ä¸ªè¿è¡Œçš„debianå®¹å™¨ä¸­é€šè¿‡ nsenter è¿›å…¥åˆ°hostä¸»æœºï¼Œä¹Ÿå°±æ˜¯Docker VMåå­—ç©ºé—´ä»¥åï¼Œå°±å¯ä»¥çœ‹åˆ°è™šæ‹Ÿæœºçš„æç¤ºç¬¦: 12âœ ~ docker run -it --rm --privileged --pid=host debian nsenter -t 1 -m -u -n -i bashbash-5.0# æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªDocker VMä¸­æ‰§è¡Œç½‘ç»œæ£€æŸ¥ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546bash-5.0# ip addr1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 brd 127.255.255.255 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 02:50:00:00:00:01 brd ff:ff:ff:ff:ff:ff inet 192.168.65.3/24 brd 192.168.65.255 scope global dynamic noprefixroute eth0 valid_lft 1576sec preferred_lft 136sec inet6 fe80::50:ff:fe00:1/64 scope link valid_lft forever preferred_lft forever3: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000 link/ipip 0.0.0.0 brd 0.0.0.04: ip6tnl0@NONE: &lt;NOARP&gt; mtu 1452 qdisc noop state DOWN group default qlen 1000 link/tunnel6 :: brd ::5: services1@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default link/ether 42:2f:8d:45:a3:03 brd ff:ff:ff:ff:ff:ff link-netns services inet 192.168.65.4 peer 192.168.65.5/32 scope global services1 valid_lft forever preferred_lft forever inet6 fe80::402f:8dff:fe45:a303/64 scope link valid_lft forever preferred_lft forever7: br-3a4b2ff7a5cb: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:11:9a:3a:8f brd ff:ff:ff:ff:ff:ff inet 192.168.7.1/24 brd 192.168.7.255 scope global br-3a4b2ff7a5cb valid_lft forever preferred_lft forever8: br-ef48d4809428: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:10:cb:22:b6 brd ff:ff:ff:ff:ff:ff inet 172.18.0.1/16 brd 172.18.255.255 scope global br-ef48d4809428 valid_lft forever preferred_lft forever9: br-f6b05f844262: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:f4:ec:b5:c4 brd ff:ff:ff:ff:ff:ff inet 172.19.0.1/16 brd 172.19.255.255 scope global br-f6b05f844262 valid_lft forever preferred_lft forever10: br-ff0c8e959ac0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:48:7f:f8:bb brd ff:ff:ff:ff:ff:ff inet 192.168.110.1/24 brd 192.168.110.255 scope global br-ff0c8e959ac0 valid_lft forever preferred_lft forever11: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default link/ether 02:42:b9:db:7e:59 brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:b9ff:fedb:7e59/64 scope link valid_lft forever preferred_lft forever... å› ä¸ºä¿¡æ¯æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨å‡ ä¸ªç½‘å¡ä¿¡æ¯ 1234567891011122: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 02:50:00:00:00:01 brd ff:ff:ff:ff:ff:ff inet 192.168.65.3/24 brd 192.168.65.255 scope global dynamic noprefixroute eth0 valid_lft 1576sec preferred_lft 136sec inet6 fe80::50:ff:fe00:1/64 scope link valid_lft forever preferred_lft forever11: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default link/ether 02:42:b9:db:7e:59 brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:b9ff:fedb:7e59/64 scope link valid_lft forever preferred_lft forever ä¸Šé¢çš„ä¿¡æ¯ï¼Œç»“åˆæ¥çœ‹ï¼Œæˆ‘ä»¬åœ¨docker-for-macå®¢æˆ·ç«¯è®¾ç½®äº†æˆ‘ä»¬çš„è™šæ‹Ÿæœºçš„ç½‘æ®µ 192.168.65.0/24ï¼Œç»“åˆeth0å’Œdocker0è¿™2ä¸ªç½‘å¡ä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œeth0 çš„ 192.168.65.3, å°±æ˜¯æˆ‘ä»¬è¿™æ˜¯çš„ç½‘æ®µçš„ä¿¡æ¯ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªè™šæ‹Ÿæœºå’ŒmacOSç‰©ç†ä¸»æœºä¸Šå¯¹åº”çš„IPåœ°å€ 192.168.65.1 å¯¹åº”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ NFS æ–¹å¼æŒ‚è½½ç‰©ç†ä¸»æœºä¸Šçš„NFSå·ï¼Œè®¿é—®çš„NFSæœåŠ¡å™¨ç«¯åœ°å€å°±æ˜¯è¿™æ ·è·å¾—çš„ã€‚ è¿™é‡Œè¿˜å¯ä»¥çœ‹åˆ°åœ¨Docker VMä¸Šè¿è¡Œçš„Dockerç½‘ç»œæ˜¯ 172.17.xx.xx/16 ï¼Œæ˜¯ä¸€ä¸ªNATç½‘ç»œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨Docker VMç«¯åˆ†é…çš„IPåœ°å€æ˜¯ 172.17.0.1 ã€‚è¿™ä¹ŸéªŒè¯äº†æˆ‘ä»¬çš„Docker VMä¸Šå®é™…ä¸Šæœ‰2ä¸ªç½‘ç»œã€‚ 192.168.65.x/24 =&gt; å’Œç‰©ç†ä¸»æœºmacOSè¿æ¥çš„NATç½‘ç»œï¼Œç”¨äºè™šæ‹Ÿæœº 172.17.x.x/16 =&gt; å’ŒDocker0è¿æ¥çš„NATç½‘ç»œï¼Œç”¨äºå®¹å™¨ åœ¨Dockerå®¹å™¨ä¸­ï¼Œé€šè¿‡ä¸¤å±‚NATï¼Œä¾ç„¶å¯ä»¥è®¿é—®å¤–ç•ŒInternetã€‚ä¸è¿‡ï¼Œåè¿‡æ¥ï¼Œå¤–éƒ¨éœ€è¦è®¿é—®Dockerå®¹å™¨å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œéœ€è¦åšç«¯å£æ˜ å°„ã€‚ æŒ‚è½½æˆ‘ä»¬å‰é¢è¯´åˆ°äº†ï¼Œå½“ä½ é€šè¿‡ docker run -vçš„æ—¶å€™ï¼Œä½ å¯ä»¥æŒ‡å®šåœ¨å…±äº«ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¸‹ï¼Œè¿›è¡ŒæŒ‚è½½è¿›å»ã€‚é‚£ä¹ˆæˆ‘ä»¬åè¿‡æ¥æƒ³ä¸€ä¸‹ï¼Œæ—¢ç„¶æ˜¯å…±äº«ç›®å½•çš„è¯ï¼Œé‚£ä¹ˆå®¹å™¨æ˜¯å¦‚ä½•åšåˆ°æŸ¥æ‰¾è¿™äº›ç›®å½•çš„å‘¢ï¼Ÿ é€šè¿‡mount -lï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æŒ‚è½½ç‚¹ã€‚ 12345678910111213141516171819202122232425262728293031bash-5.0# mount -lrootfs on / type tmpfs (ro,relatime)proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)tmpfs on /run type tmpfs (rw,nosuid,nodev,noexec,relatime,size=815300k,mode=755)tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noexec,relatime,size=815300k)tmpfs on /var type tmpfs (rw,nosuid,nodev,noexec,relatime,mode=755)dev on /dev type devtmpfs (rw,nosuid,noexec,relatime,size=4008488k,nr_inodes=1002122,mode=755)mqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime)shm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime)devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime)debugfs on /sys/kernel/debug type debugfs (rw,nosuid,nodev,noexec,relatime)fusectl on /sys/fs/fuse/connections type fusectl (rw,nosuid,nodev,noexec,relatime)pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime)none on /sys/fs/bpf type bpf (rw,nodev,relatime)binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,nosuid,nodev,noexec,relatime)cgroup_root on /sys/fs/cgroup type tmpfs (rw,nosuid,nodev,noexec,relatime,size=10240k,mode=755)cpuset on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)cpu on /sys/fs/cgroup/cpu type cgroup (rw,nosuid,nodev,noexec,relatime,cpu)cpuacct on /sys/fs/cgroup/cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)blkio on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)memory on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)devices on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)freezer on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)net_cls on /sys/fs/cgroup/net_cls type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls)perf_event on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)net_prio on /sys/fs/cgroup/net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio)hugetlb on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)pids on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)... å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™é‡Œæœ‰å¤§é‡çš„æŒ‚è½½ç‚¹ï¼Œè¿™äº›æŒ‚è½½ç‚¹ï¼Œç»„åˆæˆäº†ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…å„ç§å‘½åç©ºé—´ã€‚ ç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ä½¿ç”¨k8sçš„æ—¶å€™ï¼Œå½“æˆ‘ä»¬ç”¨pvçš„typeä¸ºhostPathçš„æ—¶å€™ï¼Œæ˜¯å¯ä»¥åšåˆ°æŒä¹…åŒ–æ•°æ®ç£ç›˜çš„ï¼Œé‚£ä¹ˆæˆ‘èƒ½ä¸èƒ½åšåˆ°ï¼Œæ•°æ®å­˜æ”¾åœ¨Docker VM éå…±äº«ç›®å½•ä¸­å‘¢ï¼Ÿ å°±æ˜¯æˆ‘çš„ç‰©ç†ä¸»æœºï¼Œå¹¶ä¸å¸Œæœ›åŒæ­¥è¿™äº›æ•°æ®ã€‚è¿™äº›æ•°æ®ä»…ä»…åªéœ€è¦å­˜åœ¨Docker VMä¸­å°±å¥½äº†ã€‚ å½“ç„¶ï¼Œè¿™ä¸ªåœºæ™¯å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´ï¼Œæˆ‘ä»¬æƒ³è¦çœ‹ä¸€äº›å®¹å™¨çš„é…ç½®æˆ–è€…ç›®å½•çš„æ—¶å€™ï¼Œä¼šå‘ç°è¾“å‡ºçš„è·¯å¾„ï¼Œåœ¨æˆ‘ä»¬çš„å®¿ä¸»æœºä¸Šæ‰¾ä¸åˆ°ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å­ï¼Ÿéš¾é“æ˜¯å‡ºé”™äº†å—ï¼Ÿå…¶å®åªæ˜¯è¿™äº›æ–‡ä»¶éƒ½åœ¨Docker VMä¸­ï¼Œå…¶å®å°±æ˜¯å› ä¸ºè¿™ä¸ªåŸå› å¯¼è‡´çš„ã€‚åªè¦æˆ‘ä»¬è¿›å…¥åˆ° Docker VMå°±å¯ä»¥çœ‹åˆ°è¿™äº›æ–‡ä»¶ã€‚ ä¾‹å¦‚ï¼Œä»¥æˆ‘ç›®å‰çš„ä¾‹å­ä¸ºä¾‹å­ï¼Œæˆ‘éœ€è¦é‡‡é›†æˆ‘æœ¬åœ°æ‰€æœ‰k8s-podsçš„è¾“å‡ºåœ¨ç»ˆç«¯çš„æ—¥å¿—ä¿¡æ¯ï¼Œæˆ‘æƒ³é€šè¿‡promtailæ¥è¿›è¡Œæ—¥å¿—é‡‡é›†ï¼Œç„¶åé€šè¿‡lokiä½œä¸ºå­˜å‚¨å’ŒæŸ¥è¯¢æœåŠ¡å™¨ï¼Œå†é€šè¿‡grafnaæ¥è¿›è¡Œå±•ç¤ºã€‚æˆ‘ä»¬çš„æœåŠ¡ä»¥å‰å°çš„æ–¹å¼è¿›è¡Œå¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬é‚£ä¹ˆé¦–å…ˆæˆ‘éœ€è¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯podsçš„æ ‡å‡†è¾“å‡ºåˆ°å“ªé‡Œï¼Ÿåæ¥å‘ç°/var/log/pods/ã€‚ 123456789101112131415bash-5.0# ls -l /var/log/pods/total 0drwxr-xr-x 3 root root 60 Aug 18 09:05 default_dev-grafana-7cd4c89fd4-wdkpb_cf869741-be0d-44d2-b776-3239dd276069drwxr-xr-x 3 root root 60 Aug 18 09:05 default_dev-loki-statefulset-0_1d34dcac-a763-478a-b17b-addb082462efdrwxr-xr-x 3 root root 60 Aug 18 09:05 default_dev-loki-statefulset-1_c82d61e9-c66f-4b6a-960a-a8f7a1d5a8e2drwxr-xr-x 3 root root 60 Aug 18 09:05 default_dev-promtail-n6jgs_51afda31-be9c-4377-8167-8e29e991d9b0drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_coredns-558bd4d5db-g2m9h_67ec7c7f-2e48-4cd7-8298-86295073072bdrwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_coredns-558bd4d5db-jk9bp_b9d8b64f-dda8-426a-8f55-029298828333drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_etcd-docker-desktop_5d9d97b8d8daed31d6fd5c6d386c29c5drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_kube-apiserver-docker-desktop_6fcd2fd42808f86960df2a06a72d6dc0drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_kube-controller-manager-docker-desktop_bed77ee1871d9eabd1710836ad671f32drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_kube-proxy-4wbs6_8bece9c8-e5fb-41f5-8869-2d408e71ba31drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_kube-scheduler-docker-desktop_a52842863dff28cb2f7d4171a9f614a0drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_storage-provisioner_79a3e8e5-6a93-43c1-abf3-c916384a4018drwxr-xr-x 3 root root 60 Aug 16 13:32 kube-system_vpnkit-controller_3742d607-ea8f-43df-aecf-4f925accbc3e æˆ‘ä»¬éšä¾¿æ‰¾ä¸€ä¸ªpodsï¼Œå»æŸ¥çœ‹æ—¥å¿—ã€‚ 1234567891011bash-5.0# tail -n 10 /var/log/pods/default_dev-grafana-7cd4c89fd4-wdkpb_cf869741-be0d-44d2-b776-3239dd276069/grafana/0.log&#123;\"log\":\"&#123;\\\"@level\\\":\\\"debug\\\",\\\"@message\\\":\\\"datasource: registering query type handler\\\",\\\"@timestamp\\\":\\\"2021-08-18T09:05:05.385825Z\\\",\\\"queryType\\\":\\\"node_graph\\\"&#125;\\n\",\"stream\":\"stderr\",\"time\":\"2021-08-18T09:05:05.3860495Z\"&#125;&#123;\"log\":\"&#123;\\\"@level\\\":\\\"debug\\\",\\\"@message\\\":\\\"datasource: registering query type fallback handler\\\",\\\"@timestamp\\\":\\\"2021-08-18T09:05:05.385855Z\\\"&#125;\\n\",\"stream\":\"stderr\",\"time\":\"2021-08-18T09:05:05.3860803Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:05:05+0000 lvl=info msg=\\\"HTTP Server Listen\\\" logger=http.server address=[::]:3000 protocol=http subUrl= socket=\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:05:05.3939314Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:07:52+0000 lvl=eror msg=\\\"Failed to look up user based on cookie\\\" logger=context error=\\\"user token not found\\\"\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:07:52.5402974Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:07:52+0000 lvl=info msg=\\\"Request Completed\\\" logger=context userId=0 orgId=0 uname= method=GET path=/dashboard/new status=302 remote_addr=192.168.65.3 time_ms=0 size=29 referer=\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:07:52.5403468Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:07:56+0000 lvl=info msg=\\\"Successful Login\\\" logger=http.server User=admin@localhost\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:07:56.6167821Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:08:00+0000 lvl=info msg=\\\"Request Completed\\\" logger=context userId=1 orgId=1 uname=admin method=GET path=/login status=302 remote_addr=192.168.65.3 time_ms=11 size=24 referer=\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:08:00.7292107Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:09:50+0000 lvl=info msg=\\\"Request Completed\\\" logger=context userId=1 orgId=1 uname=admin method=GET path=/api/datasources/proxy/1/loki/api/v1/query_range status=400 remote_addr=192.168.65.3 time_ms=2 size=57 referer=\\\"http://localhost:3000/dashboard/new?editPanel=2\\u0026orgId=1\\\"\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:09:50.7530735Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:14:53+0000 lvl=eror msg=\\\"Data proxy error\\\" logger=data-proxy-log userId=1 orgId=1 uname=admin path=/api/datasources/proxy/1/loki/api/v1/label/filename/values remote_addr=192.168.65.3 referer=\\\"http://localhost:3000/d/UWO8RT7nk/new-dashboard-copy?editPanel=2\\u0026viewPanel=2\\u0026orgId=1\\\" error=\\\"http: proxy error: EOF\\\"\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:14:53.0497419Z\"&#125;&#123;\"log\":\"t=2021-08-18T09:14:53+0000 lvl=eror msg=\\\"Request Completed\\\" logger=context userId=1 orgId=1 uname=admin method=GET path=/api/datasources/proxy/1/loki/api/v1/label/filename/values status=502 remote_addr=192.168.65.3 time_ms=79695 size=0 referer=\\\"http://localhost:3000/d/UWO8RT7nk/new-dashboard-copy?editPanel=2\\u0026viewPanel=2\\u0026orgId=1\\\"\\n\",\"stream\":\"stdout\",\"time\":\"2021-08-18T09:14:53.0502414Z\"&#125; ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ—¥å¿—æ˜¯å­˜å‚¨åœ¨è¿™é‡Œäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼Œåœ¨Docker VMä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‚è½½/var/log/podsåˆ°æˆ‘ä»¬çš„å®¹å™¨promtailä¸­ï¼Œç„¶åè¿›è¡Œé‡‡é›†å†æ¨é€åˆ°lokiï¼Œå°±å¯ä»¥é€šè¿‡grafnaæŸ¥è¯¢äº†ã€‚ è¿™ä¸ªæ€è·¯æ˜¯æ²¡é—®é¢˜çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†å¾€æ·±ç¨‹åº¦çš„è§’åº¦æƒ³ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çš„k8s-pv-typeåº”è¯¥å¡«ä»€ä¹ˆå‘¢ï¼Ÿåˆšæ‰ä¸æ˜¯è¯´äº†hostPathæ˜¯å¯ä»¥æŒä¹…åŒ–åˆ°æœ¬åœ°å—ï¼Ÿä½†æ˜¯é‚£æ˜¯é’ˆå¯¹ç‰©ç†ä¸»æœºmacosæ¥è¯´çš„ï¼Œå†µä¸”è¿™ä¸ªç›®å½•ï¼Œæˆ‘ä»¬å¹¶éåœ¨Docker VMä¹‹ä¸‹ï¼Œè¿™å°±å›åˆ°äº†æˆ‘ä»¬ä¸Šé¢è¯´çš„ï¼Œåœ¨Docker VMå­˜åœ¨ï¼Œåœ¨ç‰©ç†ä¸»æœºä¸å­˜åœ¨çš„éœ€æ±‚ã€‚ é‚£ä¹ˆæˆ‘ä»¬è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®è¿˜æ˜¯å¯ä»¥ä½¿ç”¨hostPathçš„ï¼Œç†ç”±å¾ˆç®€å•ï¼Œå› ä¸ºk8sä¼šè¯†åˆ«è·¯å¾„ï¼Œå¦‚æœæ˜¯åœ¨å…±äº«ç›®å½•ä¸‹çš„è¯ï¼Œé‚£ä¹ˆä»–ä¼šä»å…±äº«ç›®å½•çš„æ•°æ®å·ä¸­æ‰¾åˆ°å¯¹åº”çš„ç£ç›˜è·¯å¾„ï¼Œå¦‚æœä¸åœ¨å…±äº«ç›®å½•ä¸‹çš„ï¼Œåˆ™ä»Docker VMä¸­æŸ¥æ‰¾ï¼Œå› æ­¤ï¼Œè¿™å°±æ˜¯è§£å¼€äº†æˆ‘ä»¬è¿™ä¸ªç–‘æƒ‘äº†ã€‚å¯ä»¥å¤§èƒ†çš„æ”¾å¿ƒä½¿ç”¨hostPathæ¥åˆ›å»ºpvèµ„æºã€‚ æœ€åï¼Œé™„ä¸Šä¸€å¼ æœ€ç»ˆçš„æ•ˆæœå›¾ï¼š","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"}]},{"title":"ã€kubernetesã€‘k8s-glp","slug":"k8s/k8s-glp","date":"2021-08-16T14:45:30.000Z","updated":"2021-08-19T02:58:22.026Z","comments":true,"path":"2021/08/16/k8s/k8s-glp/","link":"","permalink":"http://blog.crazylaw.cn/2021/08/16/k8s/k8s-glp/","excerpt":"å‰è¨€æˆ‘ä»¬ç»å¸¸æœ‰ä¸€äº›æ—¥å¿—é‡‡é›†çš„éœ€æ±‚ï¼Œé‡‡é›†å®Œæ¯•ä¹‹åï¼Œå¸Œæœ›æœ‰ä¸€ä¸ªä¸­å¿ƒWebUiæ¥æ–¹ä¾¿çš„æŸ¥çœ‹å¾ˆå¤šä¸åŒèŠ‚ç‚¹ï¼Œä¸åŒæœåŠ¡çš„æ—¥å¿—ã€‚ æŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼šé‡‡ç”¨ELK,å°±æ˜¯elasticsearch+logstash+kibanaï¼Œä½†æ˜¯ç”±äºJVMå¯¹èµ„æºçš„æ¶ˆè€—å¤ªå¤§ï¼ŒåŠ ä¸ŠESæ˜¯é€šè¿‡å…¨æ–‡æœç´¢çš„æ–¹å¼éœ€è¦è¿›è¡Œå€’æ’ç´¢å¼•çš„åˆ†è¯ï¼Œæ‰€ä»¥è¿™äº›åŠŸèƒ½å‡ ä¹æ˜¯ç”¨ä¸ä¸Šï¼Œæˆ‘ä»¬æŸ¥è¯¢æ—¥å¿—ä¸€èˆ¬éƒ½å¯ä»¥é€šè¿‡å®šåˆ¶å¸¸è§„çš„labelä¿¡æ¯ï¼Œç„¶åæœç´¢å³å¯ï¼Œå¤§å¯ä¸å¿…è¿›è¡Œåˆ†è¯çš„è¡Œä¸ºã€‚å°½ç®¡åç»­åˆç”±äºlogstashçš„èµ„æºå ç”¨è¿‡å¤§é—®é¢˜ï¼Œä½œè€…åˆåˆ©ç”¨goè¯­è¨€å¼€å‘å‡ºäº†filebeatï¼Œæ¥è¾…åŠ©æ—¥å¿—é‡‡é›†ä½“ç³»ï¼Œåç»­åŠ å…¥äº†æŸå…¬å¸ä¹‹åï¼Œè¢«é›†æˆåˆ°äº†beatsçš„é¡¹ç›®ä¸­ï¼Œå› ä¸ºä¹Ÿå¯ä»¥äº¤efk/ebkï¼Œéƒ½å¯ä»¥ã€‚ é‰´äºè¿™ä¸€ç‚¹ï¼Œéšä¹‹è€Œæ¥çš„å°±æ˜¯GLPï¼Œå°±æ˜¯grafna+loki+promtailã€‚è¿™æ˜¯ä¸€å¥—å®Œå…¨åŸºäºgoè¯­è¨€ç”Ÿæ€å†™çš„ï¼Œæ›´è´´è¿‘äº‘åŸç”Ÿã€‚ä¸€å¥—ä½“ç³»éƒ½æ˜¯ç»è¿‡grafna labäº‘åŸç”Ÿå­•è‚²è€Œç”Ÿã€‚èµ„æºå ç”¨å°‘ï¼Œæ•ˆç‡é«˜ï¼Œèƒ½å¤Ÿè§£å†³ç—›ç‚¹ï¼Œå¤©ç”Ÿæ”¯æŒk8sç­‰ç­‰ç‰¹æ€§ã€‚éƒ½è®©ä»–æˆä¸ºæ–°çš„å´›èµ·ä¹‹ç§€ã€‚","text":"å‰è¨€æˆ‘ä»¬ç»å¸¸æœ‰ä¸€äº›æ—¥å¿—é‡‡é›†çš„éœ€æ±‚ï¼Œé‡‡é›†å®Œæ¯•ä¹‹åï¼Œå¸Œæœ›æœ‰ä¸€ä¸ªä¸­å¿ƒWebUiæ¥æ–¹ä¾¿çš„æŸ¥çœ‹å¾ˆå¤šä¸åŒèŠ‚ç‚¹ï¼Œä¸åŒæœåŠ¡çš„æ—¥å¿—ã€‚ æŒ‰ç…§ä¼ ç»Ÿçš„æ–¹å¼ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼šé‡‡ç”¨ELK,å°±æ˜¯elasticsearch+logstash+kibanaï¼Œä½†æ˜¯ç”±äºJVMå¯¹èµ„æºçš„æ¶ˆè€—å¤ªå¤§ï¼ŒåŠ ä¸ŠESæ˜¯é€šè¿‡å…¨æ–‡æœç´¢çš„æ–¹å¼éœ€è¦è¿›è¡Œå€’æ’ç´¢å¼•çš„åˆ†è¯ï¼Œæ‰€ä»¥è¿™äº›åŠŸèƒ½å‡ ä¹æ˜¯ç”¨ä¸ä¸Šï¼Œæˆ‘ä»¬æŸ¥è¯¢æ—¥å¿—ä¸€èˆ¬éƒ½å¯ä»¥é€šè¿‡å®šåˆ¶å¸¸è§„çš„labelä¿¡æ¯ï¼Œç„¶åæœç´¢å³å¯ï¼Œå¤§å¯ä¸å¿…è¿›è¡Œåˆ†è¯çš„è¡Œä¸ºã€‚å°½ç®¡åç»­åˆç”±äºlogstashçš„èµ„æºå ç”¨è¿‡å¤§é—®é¢˜ï¼Œä½œè€…åˆåˆ©ç”¨goè¯­è¨€å¼€å‘å‡ºäº†filebeatï¼Œæ¥è¾…åŠ©æ—¥å¿—é‡‡é›†ä½“ç³»ï¼Œåç»­åŠ å…¥äº†æŸå…¬å¸ä¹‹åï¼Œè¢«é›†æˆåˆ°äº†beatsçš„é¡¹ç›®ä¸­ï¼Œå› ä¸ºä¹Ÿå¯ä»¥äº¤efk/ebkï¼Œéƒ½å¯ä»¥ã€‚ é‰´äºè¿™ä¸€ç‚¹ï¼Œéšä¹‹è€Œæ¥çš„å°±æ˜¯GLPï¼Œå°±æ˜¯grafna+loki+promtailã€‚è¿™æ˜¯ä¸€å¥—å®Œå…¨åŸºäºgoè¯­è¨€ç”Ÿæ€å†™çš„ï¼Œæ›´è´´è¿‘äº‘åŸç”Ÿã€‚ä¸€å¥—ä½“ç³»éƒ½æ˜¯ç»è¿‡grafna labäº‘åŸç”Ÿå­•è‚²è€Œç”Ÿã€‚èµ„æºå ç”¨å°‘ï¼Œæ•ˆç‡é«˜ï¼Œèƒ½å¤Ÿè§£å†³ç—›ç‚¹ï¼Œå¤©ç”Ÿæ”¯æŒk8sç­‰ç­‰ç‰¹æ€§ã€‚éƒ½è®©ä»–æˆä¸ºæ–°çš„å´›èµ·ä¹‹ç§€ã€‚ Kubernetes Logs é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨æ—¥å¿—ä¼šå­˜å‚¨åœ¨ /var/log/pods è·¯å¾„ä¸‹ã€‚ æ¯ä¸ªæ–‡ä»¶å¤¹å¯¹åº”ä¸€ä¸ª Podï¼ŒPod ä¸‹çº§ç›®å½•ä¸ºå®¹å™¨åï¼Œå†ä¸‹çº§å³ä¸ºå®¹å™¨æ—¥å¿—ã€‚ 12345678tree kube-system_kube-flannel-ds-amd64-9x66j_28e71490-d614-4cd8-9ea7-af23cc7b9bff/kube-system_kube-flannel-ds-amd64-9x66j_28e71490-d614-4cd8-9ea7-af23cc7b9bff/â”œâ”€â”€ install-cniâ”‚ â””â”€â”€ 3.log -&gt; /data/docker/containers/6accaa2d6890df8ca05d1f40aaa9b8da69ea0a00a8e4b07a0949cdc067843e37/6accaa2d6890df8ca05d1f40aaa9b8da69ea0a00a8e4b07a0949cdc067843e37-json.logâ””â”€â”€ kube-flannel â”œâ”€â”€ 2.log -&gt; /data/docker/containers/9e8eea717cc3efd0804900a53244a32286d9e04767f76d9c8a8cc3701c83ece5/9e8eea717cc3efd0804900a53244a32286d9e04767f76d9c8a8cc3701c83ece5-json.log â””â”€â”€ 3.log -&gt; /data/docker/containers/06389981d26cbe60328cd5a46af7b003c8d687d1c411704784aa12d4d82672b8/06389981d26cbe60328cd5a46af7b003c8d687d1c411704784aa12d4d82672b8-json.log æ—¥å¿—æ–‡ä»¶ kube-flannel/3.log åªæ˜¯å¯¹ /var/lib/docker/containers/***/***.log æ–‡ä»¶çš„è½¯é“¾æ¥ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ Docker ç»´æŠ¤æ—¥å¿—ï¼Œ k8s å¯¹å…¶å¼•ç”¨è€Œå·²ã€‚ æ—¥å¿—æ˜¯ JSON æ ¼å¼çš„ï¼Œæ¯ä¸€è¡ŒåŒ…å«å¦‚ä¸‹ä¸‰ä¸ªä¿¡æ¯ï¼š logï¼šæ—¥å¿—å†…å®¹ streamï¼šstderr(å¼‚å¸¸è¾“å‡º)ã€stdout(æ­£å¸¸è¾“å‡º) timeï¼šæ—¶é—´ /var/lib/docker/containers æ˜¯é€šè¿‡ /etc/docker/daemon.json é…ç½®çš„ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯é»˜è®¤è·¯å¾„ã€‚ grafnaç”±äºk8sçš„ç½‘ç»œæ¶æ„çš„åŸå› ï¼Œæˆ‘ä»¬è®¿é—®çš„æ—¶å€™éƒ½æ˜¯é€šè¿‡è®¿é—®serviceçš„åå­—çš„ï¼Œå’Œdocker-composeä¸‹çš„è®¿é—®æ–¹å¼ä¸å¤ªä¸€æ ·ã€‚ ä¾‹å¦‚. 123456âœ whiteccinn.github.io git:(master) âœ— kubectl get svcNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEdev-grafana LoadBalancer 10.102.248.247 localhost 3000:32695/TCP 17hdev-loki ClusterIP 10.106.32.224 &lt;none&gt; 3100/TCP 17hdev-promtail ClusterIP 10.108.116.190 &lt;none&gt; 9080/TCP 17hkubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 3d9h é‚£ä¹ˆï¼Œå®¹å™¨ä¸­çš„è®¿é—®æ–¹å¼å°±æ˜¯é€šè¿‡dev-loki, dev-promtail, dev-grafnaæ¥å¯¹podè¿›è¡Œè®¿é—®ï¼Œserviceçš„portå†æ˜ å°„åˆ°å¯¹åº”çš„å®¹å™¨çš„portä¸Š depployment1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556apiVersion: apps/v1kind: Deploymentmetadata: labels: app: grafana name: grafanaspec: selector: matchLabels: app: grafana template: metadata: labels: app: grafana spec: securityContext: fsGroup: 472 supplementalGroups: - 0 containers: - name: grafana image: grafana/grafana:7.5.2 imagePullPolicy: IfNotPresent ports: - containerPort: 3000 name: http-grafana protocol: TCP readinessProbe: failureThreshold: 3 httpGet: path: /robots.txt port: 3000 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 30 successThreshold: 1 timeoutSeconds: 2 livenessProbe: failureThreshold: 3 initialDelaySeconds: 30 periodSeconds: 10 successThreshold: 1 tcpSocket: port: 3000 timeoutSeconds: 1 resources: requests: cpu: 250m memory: 750Mi volumeMounts: - mountPath: /var/lib/grafana name: grafana-pv volumes: - name: grafana-pv persistentVolumeClaim: claimName: grafana-pvc pvc12345678910apiVersion: v1kind: PersistentVolumeClaimmetadata: name: grafana-pvcspec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi service12345678910111213apiVersion: v1kind: Servicemetadata: name: grafanaspec: ports: - port: 3000 protocol: TCP targetPort: http-grafana selector: app: grafana sessionAffinity: None type: LoadBalancer lokiconfig-map12345678910111213141516171819202122232425262728293031323334353637383940414243apiVersion: v1kind: ConfigMapmetadata: name: loki-configdata: loki-config.yml: | auth_enabled: false server: http_listen_port: 3100 ingester: lifecycler: address: 127.0.0.1 ring: kvstore: store: inmemory replication_factor: 1 final_sleep: 0s chunk_idle_period: 5m chunk_retain_period: 30s schema_config: configs: - from: 2020-05-15 store: boltdb object_store: filesystem schema: v11 index: prefix: index_ period: 168h storage_config: boltdb: directory: /tmp/loki/index filesystem: directory: /tmp/loki/chunks limits_config: enforce_metric_name: false reject_old_samples: true reject_old_samples_max_age: 168h pvc12345678910apiVersion: v1kind: PersistentVolumeClaimmetadata: name: loki-pvcspec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi service12345678910kind: ServiceapiVersion: v1metadata: name: lokispec: ports: - port: 3100 targetPort: http-loki selector: app: loki statefulet123456789101112131415161718192021222324252627282930313233343536373839404142apiVersion: apps/v1kind: StatefulSetmetadata: name: loki-statefulsetspec: selector: matchLabels: app: loki replicas: 2 serviceName: loki template: metadata: labels: app: loki spec: containers: - name: loki image: grafana/loki:2.3.0 imagePullPolicy: IfNotPresent args: - -config.file=/mnt/config/loki-config.yml ports: - containerPort: 3100 name: http-loki volumeMounts: - mountPath: /tmp/loki name: storage-volume - mountPath: /mnt/config name: config-volume securityContext: runAsUser: 0 runAsGroup: 0 volumes: - name: storage-volume persistentVolumeClaim: claimName: loki-pvc - name: config-volume configMap: name: loki-config items: - key: loki-config.yml path: loki-config.yml promtailconfig-map1234567891011121314151617181920212223242526272829303132333435363738394041apiVersion: v1kind: ConfigMapmetadata: name: promtail-config namespace: defaultdata: promtail-config.yml: | server: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml # clients: # - url: http://dev-loki:3100/loki/api/v1/push scrape_configs: - job_name: containers static_configs: - targets: - localhost labels: log_from: static_pods __path__: /var/log/pods/*/*/*.log pipeline_stages: - docker: &#123;&#125; - match: selector: '&#123;log_from=\"static_pods\"&#125;' stages: - regex: source: filename expression: \"(?:pods)/(?P&lt;namespace&gt;\\\\S+?)_(?P&lt;pod&gt;\\\\S+)-\\\\S+?-\\\\S+?_\\\\S+?/(?P&lt;container&gt;\\\\S+?)/\" - labels: namespace: pod: container: - match: selector: '&#123;namespace!~\"(default|kube-system)\"&#125;' action: drop drop_counter_reason: no_use daemonest1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556apiVersion: apps/v1kind: DaemonSetmetadata: name: promtailspec: selector: matchLabels: app: promtail template: metadata: labels: app: promtail spec: containers: - name: promtail image: grafana/promtail:2.3.0 imagePullPolicy: IfNotPresent args: - -config.file=/mnt/config/promtail-config.yml - -client.url=http://dev-loki:3100/loki/api/v1/push - -client.external-labels=hostname=$(NODE_NAME) ports: - containerPort: 9080 name: http-promtail volumeMounts: - mountPath: /var/lib/docker/containers name: containers-volume - mountPath: /var/log/pods name: pods-volume - mountPath: /mnt/config name: config-volume env: - name: NODE_NAME valueFrom: fieldRef: fieldPath: spec.nodeName securityContext: runAsUser: 0 runAsGroup: 0 volumes: - name: containers-volume hostPath: path: /var/lib/docker/containers - name: pods-volume hostPath: path: /var/log/pods - name: config-volume configMap: name: promtail-config items: - key: promtail-config.yml path: promtail-config.yml tolerations: - key: node-role.kubernetes.io/master operator: Exists effect: NoSchedule æ³¨æ„ï¼šä¸Šè¿°æåˆ° /var/log/pods ä¸‹çš„æ—¥å¿—åªæ˜¯å¯¹ /var/lib/docker/containers ä¸‹æ—¥å¿—çš„è½¯é“¾æ¥ï¼Œæ‰€ä»¥ Promtail éƒ¨ç½²æ—¶éœ€è¦åŒæ—¶æŒ‚è½½è¿™ä¸¤ä¸ªç›®å½•ã€‚ service12345678910kind: ServiceapiVersion: v1metadata: name: promtailspec: ports: - port: 9080 targetPort: http-promtail selector: app: promtail è¿™äº›è¯¦æƒ…çš„å‚æ•°å°±ä¸è§£é‡Šçš„ï¼Œè¿™å°±æ˜¯ä¸€æ•´å¥—GLP\u001dçš„k8sçš„éƒ¨ç½²æ–‡ä»¶ã€‚ç”±äºæˆ‘è¿™é‡Œæ˜¯é‡‡ç”¨kustomizeæ¥éƒ¨ç½²çš„ã€‚æ‰€ä»¥ä¼šæœ‰å¤šå±‚ç»“æ„ã€‚ 123456789101112131415161718192021222324252627âœ kustomize git:(main) tree.â”œâ”€â”€ baseâ”‚ â”œâ”€â”€ grafnaâ”‚ â”‚ â”œâ”€â”€ deployment.yamlâ”‚ â”‚ â”œâ”€â”€ kustomization.ymlâ”‚ â”‚ â”œâ”€â”€ pvc.yamlâ”‚ â”‚ â””â”€â”€ service.yamlâ”‚ â”œâ”€â”€ kustomization.ymlâ”‚ â”œâ”€â”€ lokiâ”‚ â”‚ â”œâ”€â”€ config-map.yamlâ”‚ â”‚ â”œâ”€â”€ kustomization.ymlâ”‚ â”‚ â”œâ”€â”€ pvc.yamlâ”‚ â”‚ â”œâ”€â”€ service.yamlâ”‚ â”‚ â””â”€â”€ statefulset.yamlâ”‚ â””â”€â”€ promtailâ”‚ â”œâ”€â”€ config-map.yamlâ”‚ â”œâ”€â”€ daemonset.yamlâ”‚ â”œâ”€â”€ kustomization.ymlâ”‚ â””â”€â”€ service.yamlâ””â”€â”€ overlays â”œâ”€â”€ dev â”‚ â”œâ”€â”€ kustomization.yml â”‚ â””â”€â”€ patch.yaml â””â”€â”€ prod â”œâ”€â”€ kustomization.yml â””â”€â”€ patch.yaml ä¸€æ•´å¥—çš„è¿è¡Œå°±æ˜¯: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383âœ kustomize git:(main) kustomize build overlays/devapiVersion: v1data: promtail-config.yml: | server: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml # clients: # - url: http://dev-loki:3100/loki/api/v1/push scrape_configs: - job_name: containers static_configs: - targets: - localhost labels: log_from: static_pods __path__: /var/log/pods/*/*/*.log pipeline_stages: - docker: &#123;&#125; - match: selector: '&#123;log_from=\"static_pods\"&#125;' stages: - regex: source: filename expression: \"(?:pods)/(?P&lt;namespace&gt;\\\\S+?)_(?P&lt;pod&gt;\\\\S+)-\\\\S+?-\\\\S+?_\\\\S+?/(?P&lt;container&gt;\\\\S+?)/\" - labels: namespace: pod: container: - match: selector: '&#123;namespace!~\"(default|kube-system)\"&#125;' action: drop drop_counter_reason: no_usekind: ConfigMapmetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-promtail-config namespace: default---apiVersion: v1data: loki-config.yml: | auth_enabled: false server: http_listen_port: 3100 ingester: lifecycler: address: 127.0.0.1 ring: kvstore: store: inmemory replication_factor: 1 final_sleep: 0s chunk_idle_period: 5m chunk_retain_period: 30s schema_config: configs: - from: 2020-05-15 store: boltdb object_store: filesystem schema: v11 index: prefix: index_ period: 168h storage_config: boltdb: directory: /tmp/loki/index filesystem: directory: /tmp/loki/chunks limits_config: enforce_metric_name: false reject_old_samples: true reject_old_samples_max_age: 168hkind: ConfigMapmetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-loki-config---apiVersion: v1kind: Servicemetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-grafanaspec: ports: - port: 3000 protocol: TCP targetPort: http-grafana selector: app: amyris org: unknow-x variant: dev sessionAffinity: None type: LoadBalancer---apiVersion: v1kind: Servicemetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-lokispec: ports: - port: 3100 targetPort: http-loki selector: app: amyris org: unknow-x variant: dev---apiVersion: v1kind: Servicemetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-promtailspec: ports: - port: 9080 targetPort: http-promtail selector: app: amyris org: unknow-x variant: dev---apiVersion: v1kind: PersistentVolumeClaimmetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-grafana-pvcspec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi---apiVersion: v1kind: PersistentVolumeClaimmetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-loki-pvcspec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi---apiVersion: apps/v1kind: Deploymentmetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-grafanaspec: selector: matchLabels: app: amyris org: unknow-x variant: dev template: metadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev spec: containers: - image: grafana/grafana:7.5.2 imagePullPolicy: IfNotPresent livenessProbe: failureThreshold: 3 initialDelaySeconds: 30 periodSeconds: 10 successThreshold: 1 tcpSocket: port: 3000 timeoutSeconds: 1 name: grafana ports: - containerPort: 3000 name: http-grafana protocol: TCP readinessProbe: failureThreshold: 3 httpGet: path: /robots.txt port: 3000 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 30 successThreshold: 1 timeoutSeconds: 2 resources: requests: cpu: 250m memory: 750Mi volumeMounts: - mountPath: /var/lib/grafana name: grafana-pv securityContext: fsGroup: 472 supplementalGroups: - 0 volumes: - name: grafana-pv persistentVolumeClaim: claimName: dev-grafana-pvc---apiVersion: apps/v1kind: StatefulSetmetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-loki-statefulsetspec: replicas: 2 selector: matchLabels: app: amyris org: unknow-x variant: dev serviceName: dev-loki template: metadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev spec: containers: - args: - -config.file=/mnt/config/loki-config.yml image: grafana/loki:2.3.0 imagePullPolicy: IfNotPresent name: loki ports: - containerPort: 3100 name: http-loki securityContext: runAsGroup: 0 runAsUser: 0 volumeMounts: - mountPath: /tmp/loki name: storage-volume - mountPath: /mnt/config name: config-volume volumes: - name: storage-volume persistentVolumeClaim: claimName: dev-loki-pvc - configMap: items: - key: loki-config.yml path: loki-config.yml name: dev-loki-config name: config-volume---apiVersion: apps/v1kind: DaemonSetmetadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev name: dev-promtailspec: selector: matchLabels: app: amyris org: unknow-x variant: dev template: metadata: annotations: note: Hello, I am dev! labels: app: amyris org: unknow-x variant: dev spec: containers: - args: - -config.file=/mnt/config/promtail-config.yml - -client.url=http://dev-loki:3100/loki/api/v1/push - -client.external-labels=hostname=$(NODE_NAME) env: - name: NODE_NAME valueFrom: fieldRef: fieldPath: spec.nodeName image: grafana/promtail:2.3.0 imagePullPolicy: IfNotPresent name: promtail ports: - containerPort: 9080 name: http-promtail securityContext: runAsGroup: 0 runAsUser: 0 volumeMounts: - mountPath: /var/lib/docker/containers name: containers-volume - mountPath: /var/log/pods name: pods-volume - mountPath: /mnt/config name: config-volume tolerations: - effect: NoSchedule key: node-role.kubernetes.io/master operator: Exists volumes: - hostPath: path: /var/lib/docker/containers name: containers-volume - hostPath: path: /var/log/pods name: pods-volume - configMap: items: - key: promtail-config.yml path: promtail-config.yml name: dev-promtail-config name: config-volume é‡‡ç”¨ kustomize build overlays/dev | kubectl apply -f - æ¥è¿è¡Œæˆ‘ä»¬çš„devç¯å¢ƒçš„k8sæ‰€æœ‰çš„æœåŠ¡ã€‚ é€šè¿‡kubectl port-forward deployment.apps/dev-grafana 3000:3000 æ¥åšç«¯å£çš„è½¬å‘ã€‚ 123âœ whiteccinn.github.io git:(master) âœ— kubectl port-forward deployment.apps/dev-grafana 3000:3000Forwarding from 127.0.0.1:3000 -&gt; 3000Forwarding from [::1]:3000 -&gt; 3000 é€šè¿‡ kubectl get svc æŸ¥çœ‹ç«¯å£è½¬å‘æƒ…å†µã€‚ 123456âœ whiteccinn.github.io git:(master) âœ— kubectl get svcNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEdev-grafana LoadBalancer 10.102.248.247 localhost 3000:32695/TCP 17hdev-loki ClusterIP 10.106.32.224 &lt;none&gt; 3100/TCP 17hdev-promtail ClusterIP 10.108.116.190 &lt;none&gt; 9080/TCP 17hkubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 3d10h æœ€ç»ˆé€šè¿‡å‘½ä»¤ kubectl get pods -o wide çœ‹åˆ°æ‰€æœ‰çš„podséƒ½åœ¨æ­£å¸¸è¿ä½œäº†ã€‚ 123456âœ whiteccinn.github.io git:(master) âœ— kubectl get pods -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATESdev-grafana-7cd4c89fd4-wdkpb 1/1 Running 0 17h 10.1.0.16 docker-desktop &lt;none&gt; &lt;none&gt;dev-loki-statefulset-0 1/1 Running 0 17h 10.1.0.18 docker-desktop &lt;none&gt; &lt;none&gt;dev-loki-statefulset-1 1/1 Running 0 17h 10.1.0.19 docker-desktop &lt;none&gt; &lt;none&gt;dev-promtail-n6jgs 1/1 Running 0 17h 10.1.0.17 docker-desktop &lt;none&gt; &lt;none&gt; ç„¶ååœ¨æµè§ˆå™¨æ‰“å¼€localhost:3000ï¼Œå³å¯è®¿é—®åˆ°grafnaäº†ã€‚ grafnaé»˜è®¤çš„è´¦å·å¯†ç å°±æ˜¯adminã€‚ 1.æˆ‘ä»¬å…ˆæ¥é…ç½®grafnaçš„Dashboardã€‚ 2.å¯¹æ—¥å¿—è¿›è¡Œå¯è§†åŒ–é…ç½®ã€‚ 3.é…ç½®æœç´¢æ ã€‚ 4.å¯ä»¥çœ‹åˆ°æœç´¢æ äº†ï¼Œå¹¶ä¸”éœ€è¦æ›´æ–°ä¸€ä¸‹æŸ¥è¯¢çš„å…¬å¼ è¿™é‡Œå°±æ˜¯æˆ‘å¸Œæœ›åˆ©ç”¨k8sçš„glpæ¥é‡‡é›†æˆ‘çš„æ‰€æœ‰çš„podsåœ¨æ ‡å‡†è¾“å‡ºçš„æ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯ï¼Œåšä¸€ä¸ªæ±‡æ€»å’Œæ—¥å¿—ä¸­å¿ƒæŸ¥è¯¢çš„web-uiã€‚","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"}]},{"title":"ã€kubernetesã€‘k8s-pv-nfs-for-mac","slug":"k8s/k8s-mac-pv-nfs","date":"2021-08-16T06:18:30.000Z","updated":"2021-08-16T07:06:32.263Z","comments":true,"path":"2021/08/16/k8s/k8s-mac-pv-nfs/","link":"","permalink":"http://blog.crazylaw.cn/2021/08/16/k8s/k8s-mac-pv-nfs/","excerpt":"å‰è¨€docker-for-mac ç°åœ¨å·²ç»å†…ç½®äº†k8sï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾çš„å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡kubectlæ¥æ‰§è¡Œæˆ‘ä»¬çš„k8sçš„å‘½ä»¤æ¥å¯¹å®¹å™¨èµ„æºè¿›è¡Œç®¡ç†ã€‚ ä½†æ˜¯æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤´ç–¼çš„ç‚¹ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬çš„pvèµ„æºã€‚æˆ‘ä»¬å¹³æ—¶ç”¨dockerçš„æ—¶å€™ï¼Œæœ‰ä¸€äº›ä¿¡æ¯ä¾‹å¦‚ï¼Œæ—¥å¿—ä¹‹ç±»çš„ï¼Œéœ€è¦æŒä¹…åŒ–ä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªæ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–ä¼šå’Œå®¹å™¨æ‰€åœ¨çš„ç‰©ç†æœºåœ¨åŒä¸€ä¸ªæœºå™¨ä¸‹ï¼Œå› æ­¤ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„åšåˆ°â€œå­˜â€ï¼Œâ€œç®—â€åˆ†ç¦»çš„ç›®çš„ã€‚å¹¶ä¸”æ²¡åŠæ³•åˆ©ç”¨äº†ç½‘ç»œä¸Šçš„å…¶ä»–èµ„æºã€‚ å†è€…å°±æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œæˆ‘éœ€è¦åˆ©ç”¨k8séƒ¨ç½²ä¸€äº›åŸºç¡€æœåŠ¡ï¼Œä¾‹å¦‚mysqlï¼Œä¾‹å¦‚redisï¼Œè¿™äº›åŸºç¡€æ•°æ®éƒ½æ˜¯éœ€è¦æŒä¹…åŒ–çš„ï¼Œå› æ­¤ï¼Œå’Œç‰©ç†æœºå™¨å¼ºè¡Œç»‘å®šåœ¨ä¸€èµ·çš„è¯ï¼Œä¸‹æ¬¡æ•°æ®åœ¨å“ªä¸ªæ•°æ®å·éƒ½ä¸æ¸…æ¥šäº†ï¼Œæ›´æ²¡åŠæ³•é‡æ–°å›å¤æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚ æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„pvï¼Œä¸èƒ½ç®€å•çš„ä½¿ç”¨hostPathæˆ–è€…localç±»å‹ï¼Œæ ¹æ®æœåŠ¡å™¨ä¸Šç”¨çš„æ¯”è¾ƒå¤šçš„æˆ–è®¸æ˜¯è‡ªå·±æ­å»ºä¸€ä¸ªnfs æœåŠ¡å™¨ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™å®šä¹‰èµ„æºæ–‡ä»¶çš„yamlä¹Ÿæ˜¯ç”¨nfsæ¥ä½œä¸ºæˆ‘ä»¬çš„pv-typeã€‚ ä½†æ˜¯ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨macä¸Šå¼€å¯ä¸€ä¸ªnfs-serverã€‚å°è¯•è¿‡docker-nfs-serverï¼Œä½†æ˜¯ç”±äºmacç³»ç»Ÿçš„æ¶æ„é—®é¢˜ï¼Œæ— æ³•é¡ºåˆ©çš„è¿è¡Œèµ·æ¥ï¼Œéœ€è¦å¤„ç†modpreæ¨¡å—ï¼Œå¤„ç†é‚£ä¹ˆå¤šå†…æ ¸çš„ä¸œè¥¿ä¸å¤ªåˆç†ã€‚","text":"å‰è¨€docker-for-mac ç°åœ¨å·²ç»å†…ç½®äº†k8sï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾çš„å¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡kubectlæ¥æ‰§è¡Œæˆ‘ä»¬çš„k8sçš„å‘½ä»¤æ¥å¯¹å®¹å™¨èµ„æºè¿›è¡Œç®¡ç†ã€‚ ä½†æ˜¯æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤´ç–¼çš„ç‚¹ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬çš„pvèµ„æºã€‚æˆ‘ä»¬å¹³æ—¶ç”¨dockerçš„æ—¶å€™ï¼Œæœ‰ä¸€äº›ä¿¡æ¯ä¾‹å¦‚ï¼Œæ—¥å¿—ä¹‹ç±»çš„ï¼Œéœ€è¦æŒä¹…åŒ–ä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªæ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–ä¼šå’Œå®¹å™¨æ‰€åœ¨çš„ç‰©ç†æœºåœ¨åŒä¸€ä¸ªæœºå™¨ä¸‹ï¼Œå› æ­¤ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„åšåˆ°â€œå­˜â€ï¼Œâ€œç®—â€åˆ†ç¦»çš„ç›®çš„ã€‚å¹¶ä¸”æ²¡åŠæ³•åˆ©ç”¨äº†ç½‘ç»œä¸Šçš„å…¶ä»–èµ„æºã€‚ å†è€…å°±æ˜¯è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œæˆ‘éœ€è¦åˆ©ç”¨k8séƒ¨ç½²ä¸€äº›åŸºç¡€æœåŠ¡ï¼Œä¾‹å¦‚mysqlï¼Œä¾‹å¦‚redisï¼Œè¿™äº›åŸºç¡€æ•°æ®éƒ½æ˜¯éœ€è¦æŒä¹…åŒ–çš„ï¼Œå› æ­¤ï¼Œå’Œç‰©ç†æœºå™¨å¼ºè¡Œç»‘å®šåœ¨ä¸€èµ·çš„è¯ï¼Œä¸‹æ¬¡æ•°æ®åœ¨å“ªä¸ªæ•°æ®å·éƒ½ä¸æ¸…æ¥šäº†ï¼Œæ›´æ²¡åŠæ³•é‡æ–°å›å¤æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚ æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„pvï¼Œä¸èƒ½ç®€å•çš„ä½¿ç”¨hostPathæˆ–è€…localç±»å‹ï¼Œæ ¹æ®æœåŠ¡å™¨ä¸Šç”¨çš„æ¯”è¾ƒå¤šçš„æˆ–è®¸æ˜¯è‡ªå·±æ­å»ºä¸€ä¸ªnfs æœåŠ¡å™¨ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›åœ¨æœ¬åœ°å¼€å‘çš„æ—¶å€™å®šä¹‰èµ„æºæ–‡ä»¶çš„yamlä¹Ÿæ˜¯ç”¨nfsæ¥ä½œä¸ºæˆ‘ä»¬çš„pv-typeã€‚ ä½†æ˜¯ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨macä¸Šå¼€å¯ä¸€ä¸ªnfs-serverã€‚å°è¯•è¿‡docker-nfs-serverï¼Œä½†æ˜¯ç”±äºmacç³»ç»Ÿçš„æ¶æ„é—®é¢˜ï¼Œæ— æ³•é¡ºåˆ©çš„è¿è¡Œèµ·æ¥ï¼Œéœ€è¦å¤„ç†modpreæ¨¡å—ï¼Œå¤„ç†é‚£ä¹ˆå¤šå†…æ ¸çš„ä¸œè¥¿ä¸å¤ªåˆç†ã€‚ built-in-nfsåæ¥æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°äº†åŸæ¥æˆ‘ä»¬çš„macosï¼Œå†…ç½®äº†nfsï¼Œæˆ‘ä»¬åªéœ€è¦æ·»åŠ å¯¹åº”çš„é…ç½®å’Œå¼€å¯æœåŠ¡å³å¯ï¼Œååˆ†çš„æ–¹ä¾¿ã€‚ é…ç½®æ–‡ä»¶è¿™ä¸ªæ–‡ä»¶é»˜è®¤æ˜¯ä¸å­˜åœ¨çš„ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»åˆ›å»ºå’Œæ·»åŠ é‡Œé¢çš„å†…å®¹ï¼Œä¸ç†Ÿæ‚‰nfsçš„æœ‹å‹éœ€è¦å»çœ‹ä¸€ä¸‹nfsçš„é…ç½®æ–‡ä»¶ã€‚ 123sudo vim /etc/exports## è¿½åŠ ä»¥ä¸‹æ–‡ä»¶åˆ°æ–‡ä»¶ä¸­/Users/caiwenhui/nas_a -alldirs -maproot=caiwenhui:staff å…¶ä¸­çš„å«ä¹‰æ˜¯: /Users/caiwenhui/nas_a æŒ‡å®šå…±äº«ç›®å½• -alldirs å…±äº«ç›®å½•ä¸‹çš„æ‰€æœ‰ç›®å½• -maproot æŠŠclientç«¯çš„caiwenhuiç”¨æˆ·æ˜ å°„ä¸ºMacOSä¸Šçš„rootï¼Œclientç«¯çš„staffç»„æ˜ å°„ä¸ºMacOSä¸Šçš„wheel (gid=0) ç»„ æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®1sudo nfsd checkexports å¦‚æœéƒ½æ­£ç¡®çš„è¯ï¼Œé»˜è®¤ä»€ä¹ˆéƒ½ä¸ä¼šè¾“å‡ºã€‚å¦‚æœå­˜åœ¨é—®é¢˜çš„è¯ï¼Œåˆ™ä¼šå¼¹å‡ºé”™è¯¯é…ç½®ä¿¡æ¯ã€‚ /etc/nfs.confå¦‚æœk8séœ€è¦è¿ç”¨nfsï¼Œè¿˜éœ€è¦æ·»åŠ ä¸€è¡Œï¼š 1nfs.server.mount.require_resv_port &#x3D; 0 æœåŠ¡å‘½ä»¤123456sudo nfsd start # å¯åŠ¨æœåŠ¡sudo nfsd stop # åœæ­¢æœåŠ¡sudo nfsd restart # é‡å¯æœåŠ¡sudo nfsd status # æŸ¥çœ‹çŠ¶æ€sudo nfsd enable # å¼€æœºè‡ªå¯sudo nfsd disable # ç¦æ­¢å¼€æœºè‡ªå¯ æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆshowmount -e 123âœ ~ showmount -eExports list on localhost:&#x2F;Users&#x2F;caiwenhui&#x2F;nas_a Everyone è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æŒ‚åœ¨çš„æ•°æ®å·å·²ç»ç”Ÿæ•ˆï¼Œå¹¶ä¸”æ˜¯everyone(ä»»ä½•ç½‘æ®µï¼Œä»»ä½•ç”¨æˆ·)éƒ½å¯ä»¥è¿›è¡Œè¯»å†™ã€‚å› ä¸ºæ˜¯æœ¬åœ°å¼€å‘ï¼Œæ‰€ä»¥è¿™ä¹ˆè®¾ç½®æœ€æ–¹ä¾¿ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨ä¸Šçš„ï¼Œå°±éœ€è¦é’ˆå¯¹ç‰¹å®šçš„ç½‘æ®µæˆ–è€…ipä»¥åŠuseräº†ã€‚è¯¦æƒ…æŸ¥çœ‹nfsé…ç½®ã€‚ æœ¬åœ°æµ‹è¯• è¿™ä¸€æ­¥ä½ å¤§å¯ä¸å¿…æµ‹è¯•ï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆ‘æƒ³å…ˆç¡®ä¿nfsçš„æœåŠ¡çš„æ­£å¸¸ã€‚ 12345## åˆ›å»ºclientè§’è‰²çš„ç›®å½•ï¼Œå°±æ˜¯è¢«æŒ‚è½½çš„ç›®å½•mkdir /Users/caiwenhui/nas_a2## æ¨¡æ‹ŸclientæŒ‚è½½nfsæ•°æ®å·å‘½ä»¤sudo mount -t nfs -o nolock,nfsvers=3,vers=3 127.0.0.1:/Users/caiwenhui/nas_a /Users/caiwenhui/nas_a2 è¿™é‡Œçš„æ„æ€æ˜¯ï¼š æŒ‚è½½ç±»å‹ï¼šnfs é‡‡ç”¨nfs-v3åè®®: nfsvers=3,vers=3 nfs-serverçš„ç›®å½•: 127.0.0.1:/Users/caiwenhui/nas_a ï¼ˆè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬showmount -eæŸ¥çœ‹åˆ°çš„è·¯å¾„ï¼‰ nfs-clientçš„ç›®å½•ï¼š/Users/caiwenhui/nas_a2 æŒ‚è½½æˆåŠŸä¹‹åï¼Œå°è¯•åœ¨clientç›®å½•æ·»åŠ æ–‡ä»¶ 1touch /Users/caiwenhui/nas_a2/hello æŸ¥çœ‹serverç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶åŒæ­¥ 12ls /Users/caiwenhui/nas_ahello è¿™ä¸ªæ—¶å€™ä¼šå‘ç°nas_aç›®å½•ä¸‹ï¼Œè‡ªåŠ¨å¤šäº†ä¸€ä¸ªhelloçš„æ–‡ä»¶ å–æ¶ˆæŒ‚åœ¨ï¼Œå¯ä»¥åœ¨finderä¸­ç›´æ¥å¼¹å‡ºæŒ‚è½½ï¼Œæˆ–è€…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯ã€‚ 1umount /Users/caiwenhui/nas_a2 è¿™ä¸ªæ—¶å€™ä½ å†å»çœ‹ /Users/caiwenhui/nas_a2 ç›®å½•ä¸‹ï¼Œhelloæ–‡ä»¶ä¸è§äº†ï¼Œä½†æ˜¯/Users/caiwenhui/nas_a/helloä¾æ—§å­˜åœ¨ã€‚ k8sä¸­æµ‹è¯•nfsNFS PersistentVolumeå‰é¢æˆ‘ä»¬å·²ç»åœ¨macä¸Šå¯åŠ¨äº†ä¸€ä¸ªNFSæœåŠ¡ï¼Œç°åœ¨é€šè¿‡åœ¨k8sä¸Šåˆ›å»ºä¸€ä¸ªPersistentVolumeæ¥ä½¿ç”¨NFSã€‚ åˆ›å»ºä¸€ä¸ªPVï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶nfs-pv-1.yamlï¼Œå†…å®¹å¦‚ä¸‹ï¼š 123456789101112131415161718âœ ~ cat nfs-pv-1.yamlapiVersion: v1kind: PersistentVolumemetadata: name: nfspv1spec: mountOptions: - nfsvers=3 - nolock capacity: storage: 2Gi accessModes: - ReadWriteOnce persistentVolumeReclaimPolicy: Recycle storageClassName: nfs nfs: path: /Users/caiwenhui/nas_a server: docker.for.mac.host.internal nfsç›¸å…³çš„é…ç½®ï¼š nfsvers=3 ä½¿ç”¨v3åè®® è·¯å¾„å°±æ˜¯nfsä¸Šçš„ç›®å½• æ³¨æ„è¿™é‡Œï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨ipï¼Œå¦‚æœä¸èƒ½æ˜ç¡®çš„ç›®å‰ç°åœ¨çš„ç½‘ç»œé€šä¿¡æƒ…å†µçš„ä¸‹ï¼Œè¯·ä½¿ç”¨docker.for.mac.host.internal \bç”³è¯·èµ„æºPVã€‚ 1kubectl apply -f nfs-pv-1.yaml æŸ¥çœ‹èµ„æºçŠ¶æ€ã€‚ 123âœ ~ kubectl get pvNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEnfspv1 2Gi RWO Recycle Available nfs 13h STATUSä¸ºAvailableè¡¨ç¤ºnfspv1å°±ç»ªï¼Œå¯ä»¥è¢«PVCç”³è¯·ã€‚ PersistentVolumeClaimä¸‹é¢åˆ›å»ºPVCï¼Œç¼–è¾‘nfs-pvc-1.yamlæ–‡ä»¶ 123456789101112âœ ~ cat nfs-pvc-1.yamlapiVersion: v1kind: PersistentVolumeClaimmetadata: name: nfspvc1 spec: accessModes: - ReadWriteOnce resources: requests: storage: 1Gi storageClassName: nfs ç”³è¯·èµ„æºPVCã€‚ 1kubectl apply -f nfs-pvc-1.yaml æŸ¥çœ‹pvcçŠ¶æ€/æŸ¥çœ‹pvçŠ¶æ€ã€‚ 1234567âœ ~ kubectl get pvcNAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGEnfspvc1 Bound nfspv1 10Gi RWO nfs 85sâœ ~ kubectl get pvNAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGEnfspv1 2Gi RWO Recycle Bound default/nfspvc1 nfs 13h è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° status = boundï¼Œä»£è¡¨æ­¤æ—¶pvå’Œpvcå·²ç»ç»‘å®šåœ¨ä¸€èµ·äº†ã€‚è¿™æ ·å­æˆ‘ä»¬å°±å¯ä»¥æŠŠpodå’Œpvcç»‘å®šã€‚ Podç¼–è¾‘pod1.yaml 1234567891011121314151617181920âœ ~ cat pod1.yamlapiVersion: v1kind: Podmetadata: name: mypod1spec: containers: - name: mypod1 image: busybox args: - /bin/sh - -c - sleep 30000 volumeMounts: - mountPath: \"/mydata\" name: mydata volumes: - name: mydata persistentVolumeClaim: claimName: nfspvc1 ç”³è¯·èµ„æºpod 1kubectl apply -f pod1.yaml æŸ¥çœ‹podçŠ¶æ€ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253âœ ~ kubectl describe podName: mypod1Namespace: defaultPriority: 0Node: docker-desktop&#x2F;192.168.65.4Start Time: Mon, 16 Aug 2021 01:07:01 +0800Labels: &lt;none&gt;Annotations: &lt;none&gt;Status: RunningIP: 10.1.0.6IPs: IP: 10.1.0.6Containers: mypod1: Container ID: docker:&#x2F;&#x2F;0351e0c89fb94a3a1c8888939c641fc7b9b48d1f915f3653ca0ac188c50ae242 Image: busybox Image ID: docker-pullable:&#x2F;&#x2F;busybox@sha256:0f354ec1728d9ff32edcd7d1b8bbdfc798277ad36120dc3dc683be44524c8b60 Port: &lt;none&gt; Host Port: &lt;none&gt; Args: &#x2F;bin&#x2F;sh -c sleep 30000 State: Running Started: Mon, 16 Aug 2021 01:07:08 +0800 Ready: True Restart Count: 0 Environment: &lt;none&gt; Mounts: &#x2F;mydata from mydata (rw) &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount from kube-api-access-pftwg (ro)Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled TrueVolumes: mydata: Type: PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace) ClaimName: nfspvc1 ReadOnly: false kube-api-access-pftwg: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: &lt;nil&gt; DownwardAPI: trueQoS Class: BestEffortNode-Selectors: &lt;none&gt;Tolerations: node.kubernetes.io&#x2F;not-ready:NoExecute op&#x3D;Exists for 300s node.kubernetes.io&#x2F;unreachable:NoExecute op&#x3D;Exists for 300sEvents: &lt;none&gt; æˆ‘ä»¬çœ‹åˆ°Mountsç›¸å…³çš„å†…å®¹å·²ç»æŒ‚è½½æ­£ç¡®ï¼Œå¹¶ä¸”å®¹å™¨ä¹Ÿæ­£ç¡®åœ¨è¿è¡Œäº†ã€‚æˆ‘ä»¬å¯¹æŒ‚è½½å¥½çš„æ•°æ®å·æ“ä½œã€‚ 1kubectl exec mypod1 touch /mydata/hello2 è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨æœ¬åœ°çš„nfs-serverçš„ç›®å½•/Users/caiwenhui/nas_a æŸ¥çœ‹ä¸€ä¸‹æ˜¯å¦å¤šäº†hello2çš„æ–‡ä»¶ 12ls /Users/caiwenhui/nas_ahello hello2 è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œhello2è¢«æˆåŠŸåˆ›å»ºï¼Œpodèƒ½æ­£ç¡®çš„è®¿é—®çš„pvæŒ‚è½½é“¾æ¥æœ¬åœ°nfs-serveräº†ã€‚","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"}]},{"title":"ã€DevOpsã€‘è‡ªå®šä¹‰gitå‡­æ®å­˜å–å™¨","slug":"DevOps/è‡ªå®šä¹‰gitå‡­æ®å­˜å–å™¨","date":"2021-08-02T06:35:30.000Z","updated":"2021-08-02T07:09:57.437Z","comments":true,"path":"2021/08/02/DevOps/è‡ªå®šä¹‰gitå‡­æ®å­˜å–å™¨/","link":"","permalink":"http://blog.crazylaw.cn/2021/08/02/DevOps/%E8%87%AA%E5%AE%9A%E4%B9%89git%E5%87%AD%E6%8D%AE%E5%AD%98%E5%8F%96%E5%99%A8/","excerpt":"å‰è¨€æœ€è¿‘ï¼Œåœ¨å¤„ç†å…¬å¸åˆ°ä»£ç ä»“åº“ï¼Œå…¬å¸ç”±gitbucketè¿ç§»åˆ°gitlabåï¼Œä¸šåŠ¡é¡¹ç›®æ‹‰å–ç§æœ‰vcsçš„ä»£ç ä¾èµ–åŒ…çš„æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ã€‚ ä»¥å‰å¯èƒ½æ˜¯ä¸€ä¸ªâ€œæƒé™è¾ƒå¤§â€çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰å¤šä¸ªé¡¹ç›®ç»„çš„è®¿é—®æƒé™ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—®ç§æœ‰çš„vcsçš„ä»£ç ã€‚ ä½†æ˜¯è¿ç§»åˆ°gitlabä¹‹åï¼Œæ¯ä¸ªgroupä¸‹ï¼Œowneréƒ½å¯ä»¥é’ˆå¯¹è¿™ä¸ªgroupç”Ÿæˆå¯¹åº”éƒ½deploy-keyï¼Œæ‰€ä»¥å˜æˆäº†ä¸€ä¸ªgroupä¸‹ä¸€ä¸ªdeploy-keyã€‚ è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬éƒ½go/php/nodeé¡¹ç›®ï¼Œåœ¨æ‹‰å–ä¸åŒé¡¹ç›®éƒ½ä¾èµ–åŒ…éƒ½æ—¶å€™ï¼Œéœ€è¦æŠŠgit-credentialçš„è´¦å·ä¿¡æ¯åˆ‡æ¢ã€‚","text":"å‰è¨€æœ€è¿‘ï¼Œåœ¨å¤„ç†å…¬å¸åˆ°ä»£ç ä»“åº“ï¼Œå…¬å¸ç”±gitbucketè¿ç§»åˆ°gitlabåï¼Œä¸šåŠ¡é¡¹ç›®æ‹‰å–ç§æœ‰vcsçš„ä»£ç ä¾èµ–åŒ…çš„æ–¹å¼å‘ç”Ÿäº†æ”¹å˜ã€‚ ä»¥å‰å¯èƒ½æ˜¯ä¸€ä¸ªâ€œæƒé™è¾ƒå¤§â€çš„ç”¨æˆ·ï¼Œæ‹¥æœ‰å¤šä¸ªé¡¹ç›®ç»„çš„è®¿é—®æƒé™ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—®ç§æœ‰çš„vcsçš„ä»£ç ã€‚ ä½†æ˜¯è¿ç§»åˆ°gitlabä¹‹åï¼Œæ¯ä¸ªgroupä¸‹ï¼Œowneréƒ½å¯ä»¥é’ˆå¯¹è¿™ä¸ªgroupç”Ÿæˆå¯¹åº”éƒ½deploy-keyï¼Œæ‰€ä»¥å˜æˆäº†ä¸€ä¸ªgroupä¸‹ä¸€ä¸ªdeploy-keyã€‚ è¿™å°±æ„å‘³ç€ï¼Œæˆ‘ä»¬éƒ½go/php/nodeé¡¹ç›®ï¼Œåœ¨æ‹‰å–ä¸åŒé¡¹ç›®éƒ½ä¾èµ–åŒ…éƒ½æ—¶å€™ï¼Œéœ€è¦æŠŠgit-credentialçš„è´¦å·ä¿¡æ¯åˆ‡æ¢ã€‚ git-build-inGit æœ‰ä¸€ä¸ªå†…éƒ¨æ¥å£,ç”¨äºå­˜å‚¨å’Œæ£€ç´¢ç³»ç»Ÿç‰¹å®šåŠ©æ‰‹çš„è¯ä¹¦,ä»¥åŠæç¤ºç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚git-credential å‘½ä»¤å‘è„šæœ¬å¼€æ”¾äº†è¿™ä¸ªæ¥å£,è„šæœ¬å¯ä»¥åƒ Git ä¸€æ ·æ£€ç´¢ã€å­˜å‚¨æˆ–æç¤ºç”¨æˆ·è¾“å…¥å‡­è¯ã€‚è¿™ä¸ªå¯è„šæœ¬æ¥å£çš„è®¾è®¡ä¸å†…éƒ¨çš„ C API ä¸€æ ·,è¯·å‚è§ credential.h ä»¥äº†è§£æ›´å¤šçš„æ¦‚å¿µèƒŒæ™¯ã€‚ git-credentialåœ¨å‘½ä»¤è¡Œä¸Šä½¿ç”¨â€œæ“ä½œâ€é€‰é¡¹ï¼ˆ fill ï¼Œ approve æˆ– reject ä¹‹ä¸€ï¼‰ï¼Œå¹¶åœ¨stdinä¸Šè¯»å–å‡­æ®æè¿°ï¼ˆè¯·å‚é˜…INPUT / OUTPUT FORMATï¼‰ã€‚ å¦‚æœæ“ä½œä¸º fill ï¼Œåˆ™git-credentialå°†å°è¯•é€šè¿‡è¯»å–é…ç½®æ–‡ä»¶ï¼Œè”ç³»ä»»ä½•å·²é…ç½®çš„å‡­æ®å¸®åŠ©ç¨‹åºæˆ–æç¤ºç”¨æˆ·æ¥å‘æè¿°ä¸­æ·»åŠ â€œç”¨æˆ·åâ€å’Œâ€œå¯†ç â€å±æ€§ã€‚ç„¶åå°†å‡­è¯æè¿°çš„ç”¨æˆ·åå’Œå¯†ç å±æ€§ä¸å·²ç»æä¾›çš„å±æ€§ä¸€èµ·æ‰“å°åˆ°stdoutã€‚ å¦‚æœæ“ä½œè¢« approve ï¼Œåˆ™git-credentialä¼šå°†æè¿°å‘é€ç»™ä»»ä½•å·²é…ç½®çš„å‡­æ®å¸®åŠ©å™¨ï¼Œè¯¥å¸®åŠ©å™¨å¯ä»¥å­˜å‚¨è¯¥å‡­æ®ä»¥ä¾›ä»¥åä½¿ç”¨ã€‚ å¦‚æœè¯¥æ“ä½œè¢« reject ï¼Œåˆ™git-credentialä¼šå°†æè¿°å‘é€ç»™ä»»ä½•å·²é…ç½®çš„å‡­æ®å¸®åŠ©å™¨ï¼Œè¿™äº›å¸®åŠ©å™¨å¯èƒ½ä¼šåˆ é™¤æ‰€æœ‰ä¸è¯¥æè¿°åŒ¹é…çš„å­˜å‚¨å‡­æ®ã€‚ å¦‚æœæ“ä½œæ˜¯ approve æˆ– reject ï¼Œåˆ™ä¸åº”å‘å‡ºä»»ä½•è¾“å‡ºã€‚ Gitæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨windowå’Œmacä¸‹ï¼Œåˆ†åˆ«å¯¹åº”çš„å¤šå‡­æ®ç®¡ç†å™¨ï¼Œåˆ†åˆ«æ˜¯git credential for window å’Œ oschinakeyï¼Œå¯ä»¥åšåˆ°ç²¾ç¡®çš„è®°å½•ä¸‹æˆ‘ä»¬çš„æ‰€æœ‰å‡­æ®ã€‚ä½†æ˜¯åœ¨linuxä¸‹å°±åªæœ‰build-in(å†…ç½®)çš„å­˜å–å™¨ï¼Œåˆ†åˆ«æ˜¯ cache, store ã€‚ ç»è¿‡å®ç°ï¼Œåœ¨.gitconfigé»˜è®¤çš„é…ç½®çš„æƒ…å†µä¸‹ï¼Œæ¯æ¬¡éƒ½ä¼šåªè¯»å– .git-credential çš„ç¬¬ä¸€è¡Œæ•°æ®ï¼Œå¦‚æœä¸æ­£ç¡®ï¼Œåˆ™è§¦å‘ git çš„ build-in çš„ reject æ–¹æ³•ï¼Œæ¸…ç†æ‰è¿™ä¸€è¡Œçš„å‡­æ®ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨å¤šå‡­æ®ä¸‹æ— æ³•æ­£å¸¸çš„å·¥ä½œã€‚æˆ‘ä»¬éœ€è¦.git-credentitalèƒ½æ ¹æ®vcsçš„åœ°å€ç‰¹ç‚¹ï¼Œä¾‹å¦‚æ ¹æ®groupæ¥è¯†åˆ«å‡­æ®ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±éœ€è¦å€ŸåŠ©è‡ªå®šä¹‰å­˜å–å™¨ã€‚ è‡ªå®šä¹‰å­˜å‚¨å™¨è¦å®ç°è‡ªå®šä¹‰å­˜å‚¨å™¨ï¼Œå°±éœ€è¦çŸ¥é“ä»–æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå’Œæ€ä¹ˆå®ç°ã€‚ è‡ªå®šä¹‰å­˜å‚¨å™¨å…è®¸ä½ ç”¨ä»»ä½•è¯­è¨€æ¥ç¼–å†™ï¼Œä½ ç”¨c/c++/python/php/java/go/rust/erlangç­‰ç­‰çš„è¯­è¨€å†™éƒ½æ˜¯å¯ä»¥çš„ï¼Œåªéœ€è¦ç¨‹åºèƒ½ç›´æ¥è¿è¡Œï¼Œå¹¶ä¸”ç¬¦åˆè¾“å…¥/è¾“å‡ºæ ¼å¼å’Œåœ¨PATHçš„ç³»ç»Ÿç¯å¢ƒä¸‹èƒ½æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯å¯è¡Œçš„ã€‚æˆ‘è®°å¾—git-scmçš„ä¾‹å­é‡‡ç”¨çš„æ˜¯rubyçš„å†™æ³•ï¼Œä½†æ˜¯ç”±äºè€ƒè™‘åˆ°python2ä¸€èˆ¬æ˜¯æ¯ä¸ªç³»ç»Ÿéƒ½è‡ªå¸¦çš„ï¼Œæˆ‘ä»¬ä¹Ÿé‡‡ç”¨äº†python2çš„å†™æ³•æ¥å®ç°ä¸€ä¸ªæ ¹æ®ç»„ç»‡æ¥æ™ºèƒ½åŒºåˆ†gitè´¦å·å’Œå¯†ç çš„è‡ªå®šä¹‰å­˜å–å™¨ è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥è®°ä½ï¼ŒæŠŠè‡ªå®šä¹‰å­˜å‚¨å™¨æƒ³åƒæˆä¸€ä¸ªç®¡é“(pipe)çš„æ¦‚å¿µï¼Œæœ‰è¾“å…¥ç«¯ï¼Œä¹Ÿæœ‰è¾“å‡ºç«¯ï¼Œä»–ä»¬éƒ½æœ‰è‡ªå·±å¯¹åº”çš„è§„åˆ™ï¼ˆåè®®/æ ¼å¼ï¼‰ã€‚ è¾“å…¥/è¾“å‡ºæ ¼å¼git credential åœ¨å…¶æ ‡å‡†è¾“å…¥/è¾“å‡ºä¸­è¯»å–æˆ–å†™å…¥ï¼ˆå–å†³äºä½¿ç”¨çš„æ“ä½œï¼‰å‡­è¯ä¿¡æ¯ã€‚æ­¤ä¿¡æ¯å¯ä»¥å¯¹åº”äº git credential å°†ä¸ºå…¶è·å–ç™»å½•ä¿¡æ¯çš„å¯†é’¥ï¼ˆä¾‹å¦‚ä¸»æœºï¼Œåè®®ï¼Œè·¯å¾„ï¼‰ï¼Œä¹Ÿå¯ä»¥å¯¹åº”äºå°†è¦è·å–çš„å®é™…å‡­è¯æ•°æ®ï¼ˆç”¨æˆ·å/å¯†ç ï¼‰ã€‚ å‡­è¯åˆ†ä¸ºä¸€ç»„å‘½åå±æ€§ï¼Œæ¯è¡Œä¸€ä¸ªå±æ€§ã€‚æ¯ä¸ªå±æ€§å‡ç”±é”®å€¼å¯¹æŒ‡å®šï¼Œå¹¶ä»¥ = ï¼ˆç­‰å·ï¼‰åˆ†éš”ï¼Œåè·Ÿæ¢è¡Œç¬¦ã€‚ å¯†é’¥å¯ä»¥åŒ…å«é™¤ = ï¼Œæ¢è¡Œç¬¦æˆ–NULä¹‹å¤–çš„ä»»ä½•å­—èŠ‚ã€‚è¯¥å€¼å¯ä»¥åŒ…å«é™¤æ¢è¡Œç¬¦æˆ–NULä¹‹å¤–çš„ä»»ä½•å­—èŠ‚ã€‚ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹,æ‰€æœ‰çš„å­—èŠ‚éƒ½æŒ‰åŸæ ·å¤„ç†(å³æ²¡æœ‰å¼•å·,ä¹Ÿä¸èƒ½ä¼ è¾“å¸¦æœ‰æ¢è¡Œæˆ–NULçš„å€¼)ã€‚å±æ€§åˆ—è¡¨ä»¥ç©ºè¡Œæˆ–æ–‡ä»¶æœ«å°¾ç»“æŸã€‚ Gitäº†è§£ä»¥ä¸‹å±æ€§ã€‚ protocol å°†ä½¿ç”¨å‡­è¯çš„åè®®ï¼ˆä¾‹å¦‚ https ï¼‰ã€‚ host ç½‘ç»œå‡­è¯çš„è¿œç¨‹ä¸»æœºå,åŒ…æ‹¬æŒ‡å®šçš„ç«¯å£å·(å¦‚ â€œexample.com:8088â€)ã€‚å¦‚æœæŒ‡å®šäº†ç«¯å£å·,åˆ™åŒ…æ‹¬ç«¯å£å·(ä¾‹å¦‚ â€œexample.com:8088â€)ã€‚ path å‡­æ®å°†ä½¿ç”¨çš„è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œå¯¹äºè®¿é—®è¿œç¨‹httpsèµ„æºåº“ï¼Œè¿™å°†æ˜¯æœåŠ¡å™¨ä¸Šèµ„æºåº“çš„è·¯å¾„ã€‚(åªæœ‰å¼€å¯äº†useHttpPath=trueçš„æƒ…å†µä¸‹ï¼Œè¾“å…¥æ ¼å¼æ‰ä¼šæºå¸¦è¿™ä¸ªå‚æ•°) username å‡­æ®çš„ç”¨æˆ·åï¼ˆå¦‚æœå·²ç»æœ‰ï¼‰ï¼ˆä¾‹å¦‚ï¼Œæ¥è‡ªURLï¼Œé…ç½®ï¼Œç”¨æˆ·æˆ–å…ˆå‰è¿è¡Œçš„å¸®åŠ©ç¨‹åºï¼‰ã€‚ password å‡­æ®çš„å¯†ç ï¼ˆå¦‚æœæˆ‘ä»¬è¦æ±‚å°†å…¶å­˜å‚¨ï¼‰ã€‚ url å½“ git credential è¯»å–æ­¤ç‰¹æ®Šå±æ€§æ—¶ï¼Œè¯¥å€¼å°†è§£æä¸ºURLï¼Œå¹¶è¢«è§†ä¸ºå·²è¯»å–å…¶ç»„æˆéƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œ url=https://example.com çš„è¡Œä¸ºå°±å¥½åƒ protocol=https å’Œ host=example.com å·²æä¾›ï¼‰ã€‚è¿™å¯ä»¥å¸®åŠ©å‘¼å«è€…é¿å…è‡ªå·±è§£æURLã€‚ è¯·æ³¨æ„ï¼ŒæŒ‡å®šåè®®æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œå¹¶ä¸”å¦‚æœURLæœªæŒ‡å®šä¸»æœºåï¼ˆä¾‹å¦‚ï¼Œâ€œ certï¼š/// path / to / fileâ€ï¼‰ï¼Œåˆ™å‡­è¯å°†åŒ…å«å…¶ä¸»æœºåå±æ€§ï¼Œå…¶å€¼ä¸ºç©ºå­—ç¬¦ä¸²ã€‚ å®æˆ˜äº†è§£äº†è¾“å…¥/è¾“å‡ºæ ¼å¼åã€‚æˆ‘ä»¬é€šè¿‡å®æˆ˜ä¾‹å­æ¥è¯´æ˜ã€‚ 1234# git-credential.examplehttps://caiwenhui:testpass@gitlab.mingchao.com/group1https://caiwenhui:testpass2@gitlab.mingchao.com/group2https://caiwenhui:testpass3@gitlab.mingchao.com/group3 ä»¥ä¸‹æ–‡ä»¶ï¼Œå‘½åä¸º git-credential-mc 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172#!/usr/bin/env python# -*- coding: utf-8 -*-# @Date : 2021-07-30 10:58:53# @Author : caiwenhui# @Version : 1.0import osimport reimport sysimport argparseparser = argparse.ArgumentParser(description=\"get credentials by https://gitlab.mimgchao.com/&#123;group&#125;\", prog='git-credential-mc', usage='%(prog)s [options] &lt;action&gt;')parser.add_argument('-f', '--file', help='Specify path for backing store', required=True, default=\"~/.git-credentials\", type=str)parser.add_argument('action', metavar=\"action\", help='just support &lt;get&gt;')class CredentialsHelper: def __init__(self, credential_file=''): self.inputs = dict() self.file = credential_file def _input(self): while True: line = sys.stdin.readline() if line.strip() == '': break k, v = line.strip().split('=', 2) self.inputs[k] = v # éœ€è¦å¼€å¯useHttpPath = true if self.inputs['path'] is None: sys.exit(1) # è§£æpathå‚æ•° self.inputs['group'] = self.inputs['path'].split('/')[0] def _output(self): with open(self.file, 'r') as f: lines = f.readlines() for line in lines: m = re.match(r'^(?P&lt;protocol&gt;.*?)://(?P&lt;username&gt;.*?):(?P&lt;password&gt;.*?)@(?P&lt;host&gt;.*)/(?P&lt;group&gt;.*)$', line) gd = m.groupdict() if self.inputs['protocol'] == gd['protocol'] and self.inputs['host'] == gd['host'] and self.inputs[ 'group'] == gd['group']: sys.stdout.write('protocol=&#123;protocol&#125;\\n'.format(protocol=gd['protocol'])) sys.stdout.write('host=&#123;host&#125;\\n'.format(host=gd['host'])) sys.stdout.write('username=&#123;username&#125;\\n'.format(username=gd['username'])) sys.stdout.write('password=&#123;password&#125;\\n'.format(password=gd['password'])) break sys.stdout.flush() def execute(self): self._input() self._output()if __name__ == '__main__': if len(sys.argv) &lt;= 1: parser.print_help() sys.exit(0) args = parser.parse_args() if args.action != \"get\": sys.exit(0) if not os.path.exists(args.file): sys.exit(0) credentialsHelper = CredentialsHelper(credential_file=args.file) credentialsHelper.execute() ç›´æ¥è¿è¡Œä¸‹ï¼Œè„šæœ¬è¾“å‡ºå¦‚ä¸‹ï¼š 1234567891011âœ python git:(master) ./git-credential-mcusage: git-credential-mc [options] &lt;action&gt;get credentials by https://gitlab.mimgchao.com/&#123;group&#125;positional arguments: action just support &lt;get&gt;optional arguments: -h, --help show this help message and exit -f FILE, --file FILE Specify path for backing store æˆ‘ä»¬æ¥æ¨¡æ‹Ÿgitçš„ä¸€ä¸ªè¾“å…¥è¿‡ç¨‹ï¼Œç„¶åè®©è‡ªå®šä¹‰å­˜å‚¨å™¨è¾“å‡ºæ­£ç¡®çš„è¾“å‡ºæ ¼å¼å‘Šè¯‰gitå‡­æ®è¦ç”¨çš„è´¦å·å¯†ç ï¼š 12345678910111213141516171819âœ python git-credential-mc -f git-credential.example getprotocol=httpshost=gitlab.mingchao.compath=group1/repo1.gitprotocol=httpshost=gitlab.mingchao.comusername=caiwenhuipassword=testpassâœ python git-credential-mc -f git-credential.example getprotocol=httpshost=gitlab.mingchao.compath=group2/repo1.gitprotocol=httpshost=gitlab.mingchao.comusername=caiwenhuipassword=testpass2 è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œæˆ‘ä»¬æ ¹æ®ä¸åŒçš„groupï¼Œå·²ç»è¿”å›äº†ä¸åŒçš„è´¦å·å¯†ç äº†ã€‚è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼Œæˆ‘ä»¬çš„è‡ªå®šä¹‰è¯»å–å™¨å°±ç®—æ˜¯å®Œæˆäº†ã€‚ä½†æ˜¯ç³»ç»ŸåŒ–çš„æ•´ç†èµ·æ¥ï¼Œè¿˜éœ€è¦æŠŠè¿™ä¸ªè„šæœ¬ï¼Œæ”¾åœ¨PATHè·¯å¾„ä¸‹ï¼Œå¹¶ä¸”ï¼Œå¹¶ä¸”è®°å¾—å¿…é¡»ä»¥git-credential-*æ¥å‘½ä»¤ç¨‹åºçš„æ–‡ä»¶åã€‚å› ä¸ºgitæºç çš„credentialæ¨¡å—ä¸­çš„æºç è¯»å–è‡ªå®šä¹‰è§„åˆ™å­˜å‚¨å™¨å°±æ˜¯è¿™æ ·å­è°ƒç”¨å¤–éƒ¨ç¨‹åºçš„ã€‚ é…ç½®git12git config --global credential.https:&#x2F;&#x2F;gitlab.mingchao.com.useHttpPath truegit config --global credential.https:&#x2F;&#x2F;gitlab.mingchao.com.helper &quot;mc --file ~&#x2F;.git-credential.example&quot; è¿™æ ·å­ï¼Œgitå°±å¯ä»¥é’ˆå¯¹https://gitlab.mingchao.comçš„æ—¶å€™ï¼Œé‡‡ç”¨git-credential-mcçš„ç¨‹åºæ¥è¯»å–å‡­æ®ã€‚è¾¾åˆ°æˆ‘ä»¬çš„å¤šç»„/å¤šå‡­æ®çš„æƒ…å†µä¸‹æ­£ç¡®çš„è¯»å–è´¦å·å’Œå¯†ç ã€‚ è¿™é‡Œåªæ˜¯ä¸€ä¸ªç®€å•çš„ç”¨æ³•ï¼Œåç»­å¦‚æœæœ‰å¤æ‚çš„ç”¨æ³•ï¼Œéƒ½å¯ä»¥æ‰©å±•è¿™ä¸ªè‡ªå®šä¹‰å­˜å–å™¨ï¼Œååˆ†çš„çµæ´»ã€‚ å‚è€ƒèµ„æ–™ï¼š https://github.com/git/git https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8 https://revs.runtime-revolution.com/extending-git-with-ruby-874fddffd069","categories":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/categories/DevOps/"}],"tags":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/tags/DevOps/"}]},{"title":"ã€rustã€‘åºåˆ—åŒ–æ¡†æ¶serde","slug":"Rustè¯­è¨€/rust-åºåˆ—åŒ–æ¡†æ¶serde","date":"2021-04-13T02:43:43.000Z","updated":"2021-04-22T07:44:11.893Z","comments":true,"path":"2021/04/13/Rustè¯­è¨€/rust-åºåˆ—åŒ–æ¡†æ¶serde/","link":"","permalink":"http://blog.crazylaw.cn/2021/04/13/Rust%E8%AF%AD%E8%A8%80/rust-%E5%BA%8F%E5%88%97%E5%8C%96%E6%A1%86%E6%9E%B6serde/","excerpt":"å‰è¨€Rust ä¸­æœ‰ä¸€ä¸ª 99%çš„ç¨‹åºå‘˜æˆ–è®¸éƒ½ä¼šç”¨åˆ°çš„ç»„ä»¶ï¼Œé‚£å°±æ˜¯åºåˆ—åŒ–ç»„ä»¶: serdeã€‚ ä¼—æ‰€å‘¨çŸ¥ï¼Œrustçš„é™æ€è¯­è¨€ï¼Œæ‰€ä»¥è¿™è®©æˆ‘ä»¬åœ¨åºåˆ—åŒ–ä¸Šç¹çäº†å¾ˆå¤šï¼Œä½†æ˜¯æœ‰äº†serdeï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„åºåˆ—åŒ–ç»“æ„ä½“ï¼Œç”Ÿäº§å¯¹åº”çš„æ•°æ®ã€‚å®ƒå®ç°äº†å„ç§å£°æ˜å® ä»¥åŠ è¿‡ç¨‹å® æ¥ååŠ©æˆ‘ä»¬åºåˆ—åŒ–ã€‚ å›´ç»•ç€serdeï¼Œä¹Ÿæœ‰å¾ˆå¤šè¡ç”Ÿçš„å­ç»„ä»¶ï¼Œä¾‹å¦‚serde-json, serde-yaml, serde-qs ç­‰ç­‰ã€‚ ç”±äºæˆ‘ç›®å‰åœ¨å¼€å‘ gitlab-rsï¼Œåœ¨ç”Ÿæˆå¯¹åº”çš„query_string ä»¥åŠformçš„æ•°æ®çš„æ—¶å€™ï¼Œå°±æ¯”è¾ƒæ£˜æ‰‹ã€‚ æ‰€ä»¥æˆ‘åœ¨gitlab-rs ç”Ÿæˆçš„è¿‡ç¨‹å®ä¸­ï¼Œå€ŸåŠ©äº† seder å‡ºè‰²çš„åºåˆ—åŒ–ç”Ÿæ€æ¥å®ŒæˆåŠŸèƒ½ã€‚","text":"å‰è¨€Rust ä¸­æœ‰ä¸€ä¸ª 99%çš„ç¨‹åºå‘˜æˆ–è®¸éƒ½ä¼šç”¨åˆ°çš„ç»„ä»¶ï¼Œé‚£å°±æ˜¯åºåˆ—åŒ–ç»„ä»¶: serdeã€‚ ä¼—æ‰€å‘¨çŸ¥ï¼Œrustçš„é™æ€è¯­è¨€ï¼Œæ‰€ä»¥è¿™è®©æˆ‘ä»¬åœ¨åºåˆ—åŒ–ä¸Šç¹çäº†å¾ˆå¤šï¼Œä½†æ˜¯æœ‰äº†serdeï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„åºåˆ—åŒ–ç»“æ„ä½“ï¼Œç”Ÿäº§å¯¹åº”çš„æ•°æ®ã€‚å®ƒå®ç°äº†å„ç§å£°æ˜å® ä»¥åŠ è¿‡ç¨‹å® æ¥ååŠ©æˆ‘ä»¬åºåˆ—åŒ–ã€‚ å›´ç»•ç€serdeï¼Œä¹Ÿæœ‰å¾ˆå¤šè¡ç”Ÿçš„å­ç»„ä»¶ï¼Œä¾‹å¦‚serde-json, serde-yaml, serde-qs ç­‰ç­‰ã€‚ ç”±äºæˆ‘ç›®å‰åœ¨å¼€å‘ gitlab-rsï¼Œåœ¨ç”Ÿæˆå¯¹åº”çš„query_string ä»¥åŠformçš„æ•°æ®çš„æ—¶å€™ï¼Œå°±æ¯”è¾ƒæ£˜æ‰‹ã€‚ æ‰€ä»¥æˆ‘åœ¨gitlab-rs ç”Ÿæˆçš„è¿‡ç¨‹å®ä¸­ï¼Œå€ŸåŠ©äº† seder å‡ºè‰²çš„åºåˆ—åŒ–ç”Ÿæ€æ¥å®ŒæˆåŠŸèƒ½ã€‚ ç›®å‰å›´ç»•serdeæ”¯æŒçš„åºåˆ—åŒ–çš„æ•°æ®æ ¼å¼ç»„ä»¶æœ‰ï¼š JSONï¼Œè®¸å¤šHTTP apiéƒ½ä½¿ç”¨çš„JavaScriptå¯¹è±¡ç¬¦å·ã€‚ Bincodeï¼Œä¸€ä¸ªç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œç”¨äºä¼ºæœæ¸²æŸ“çš„IPCå¼•æ“ã€‚ CBORï¼Œä¸€ç§ç®€æ´çš„äºŒè¿›åˆ¶å¯¹è±¡è¡¨ç¤ºï¼Œä¸“ä¸ºå°æ¶ˆæ¯å¤§å°è®¾è®¡è€Œä¸éœ€è¦ç‰ˆæœ¬åå•†ã€‚ YAMLï¼Œä¸€ä¸ªè‡ªç§°å¯¹äººç±»å‹å¥½çš„é…ç½®è¯­è¨€ï¼Œå…¶å®ä¸æ˜¯æ ‡è®°è¯­è¨€ã€‚ MessagePackï¼Œä¸€ä¸ªé«˜æ•ˆçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œç±»ä¼¼äºä¸€ä¸ªç´§å‡‘çš„JSONã€‚ TOMLï¼Œ Cargoä½¿ç”¨çš„æœ€å°é…ç½®æ ¼å¼ã€‚ Pickleï¼Œ Pythonä¸–ç•Œä¸­å¸¸è§çš„æ ¼å¼ã€‚ [ç½—æ©]ï¼Œä¸€ä¸ªç”Ÿé”ˆçš„ç¬¦å·ã€‚â€”BSONï¼Œ MongoDBä½¿ç”¨çš„æ•°æ®å­˜å‚¨å’Œç½‘ç»œä¼ è¾“æ ¼å¼ã€‚ Avroï¼Œåœ¨Apache Hadoopä¸­ä½¿ç”¨çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ”¯æŒschemaå®šä¹‰ã€‚ JSON5ï¼Œä¸€ä¸ªJSONçš„è¶…é›†ï¼ŒåŒ…æ‹¬ä¸€äº›æ¥è‡ªES5çš„äº§å“ã€‚ [æ˜ä¿¡ç‰‡]ï¼Œä¸€ä¸ªä¸_stdå’ŒåµŒå…¥å¼ç³»ç»Ÿå‹å¥½çš„ç´§å‡‘äºŒè¿›åˆ¶æ ¼å¼ã€‚â€”URLæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ºx-www-form-urlencodedã€‚ Envyï¼Œä¸€ç§å°†ç¯å¢ƒå˜é‡ååºåˆ—åŒ–ä¸ºé”ˆèš€ç»“æ„çš„æ–¹æ³•ã€‚ (ååºåˆ—åŒ–) Envy Storeï¼Œä¸€ç§ååºåˆ—åŒ–AWS Parameter Storeå‚æ•°åˆ°Rustçš„æ–¹æ³•ç»“æ„ä½“ã€‚(ååºåˆ—åŒ–) S-expressionsï¼Œ Lispä½¿ç”¨çš„ä»£ç å’Œæ•°æ®çš„æ–‡æœ¬è¡¨ç¤ºå½¢å¼è¯­è¨€çš„å®¶åº­ã€‚ D-Busçš„äºŒè¿›åˆ¶çº¿æ ¼å¼ã€‚ FlexBuffersï¼Œè°·æ­Œçš„FlatBuffers 0 -copyçš„æ— æ¨¡å¼è¡¨å…„å¼Ÿåºåˆ—åŒ–æ ¼å¼ã€‚ Bencodeï¼Œåœ¨BitTorrentåè®®ä¸­ä½¿ç”¨çš„ä¸€ä¸ªç®€å•çš„äºŒè¿›åˆ¶æ ¼å¼ã€‚â€”DynamoDB Itemsï¼Œ rusoto_dynamodbç”¨æ¥ä¼ è¾“æ•°æ®çš„æ ¼å¼å’ŒDynamoDBã€‚ Hjsonï¼Œä¸€ä¸ªJSONçš„è¯­æ³•æ‰©å±•ï¼Œå›´ç»•äººç±»é˜…è¯»å’Œç¼–è¾‘è€Œè®¾è®¡ã€‚(ååºåˆ—åŒ–) æœ€ç®€å•çš„ä¸€ä¸ªå®ä¾‹1234567891011121314151617181920212223use serde::&#123;Serialize, Deserialize&#125;;#[derive(Serialize, Deserialize, Debug)]struct Point &#123; x: i32, y: i32,&#125;fn main() &#123; let point = Point &#123; x: 1, y: 2 &#125;; // Convert the Point to a JSON string. let serialized = serde_json::to_string(&amp;point).unwrap(); // Prints serialized = &#123;\"x\":1,\"y\":2&#125; println!(\"serialized = &#123;&#125;\", serialized); // Convert the JSON string back to a Point. let deserialized: Point = serde_json::from_str(&amp;serialized).unwrap(); // Prints deserialized = Point &#123; x: 1, y: 2 &#125; println!(\"deserialized = &#123;:?&#125;\", deserialized);&#125; 12345/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test Finished dev [unoptimized + debuginfo] target(s) in 0.01s Running `target/debug/serde_test`serialized = &#123;\"x\":1,\"y\":2&#125;deserialized = Point &#123; x: 1, y: 2 &#125; å±æ€§serde-deviceç§æ”¯æŒ 3ç§ å±æ€§ï¼Œåˆ†åˆ«æ˜¯: å®¹å™¨å±æ€§ ç”¨äºç»“æ„ä½“æˆ–è€…æšä¸¾ å­—ä½“å±æ€§ ç”¨äºæšä¸¾çš„å˜ä½“ å­—æ®µå±æ€§ ç”¨äºç»“æ„ä½“æˆ–è€…æšä¸¾ç§çš„å­—æ®µ å­—ä½“å±æ€§ ä»… ç”¨äºæšä¸¾ 123456789101112131415161718192021222324252627282930use serde::&#123;Serialize, Deserialize&#125;;#[derive(Serialize, Deserialize, Debug)]#[serde(deny_unknown_fields)] // &lt;-- this is a container attributestruct S &#123; #[serde(default)] // &lt;-- this is a field attribute f: i32, s_e: E&#125;#[derive(Serialize, Deserialize, Debug)]#[serde(rename = \"e\")] // &lt;-- this is also a container attributeenum E &#123; #[serde(rename = \"a\")] // &lt;-- this is a variant attribute A(String),&#125;fn main() &#123; let point_s = S &#123; f: 1 , s_e: E::A(String::from(\"inner-enum\"))&#125;; // Convert the Point to a JSON string. let serialized_a = serde_json::to_string(&amp;point_s).unwrap(); println!(\"serialized_a: &#123;&#125;\", serialized_a); let point_e = E::A(String::from(\"my-enum\")); // Convert the Point to a JSON string. let serialized_e = serde_json::to_string(&amp;point_e).unwrap(); println!(\"serialized_e: &#123;&#125;\", serialized_e)&#125; 12345/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test Finished dev [unoptimized + debuginfo] target(s) in 0.01s Running `target/debug/serde_test`serialized_a: &#123;\"f\":1,\"s_e\":&#123;\"a\":\"inner-enum\"&#125;&#125;serialized_e: &#123;\"a\":\"my-enum\"&#125; æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†serdeæœ‰ç§ç±»å‹çš„å±æ€§ï¼Œå…·ä½“éƒ½æœ‰å“ªäº›å±æ€§ï¼Œå¤§å®¶ä¸€å®šä¹Ÿæ„Ÿå…´è¶£ã€‚ å®¹å™¨å±æ€§(Container attributes)#[serde(rename = â€œnameâ€)]#[serde(rename = &quot;name&quot;)] åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ—¶å€™ç”¨ä¸€ä¸ªåå­—æ¥ä»£æ›¿Rustç»“æ„ä½“çš„åå­— å½“ç„¶ï¼Œä¹Ÿå…è®¸ç‹¬ç«‹è®¾ç½®å’Œåˆ†åˆ«è®¾ç½®: #[serde(rename(serialize = &quot;ser_name&quot;))] #[serde(rename(deserialize = &quot;de_name&quot;))] #[serde(rename(serialize = &quot;ser_name&quot;, deserialize = &quot;de_name&quot;))] #[serde(rename_all = â€œâ€¦â€)]#[serde(rename_all = &quot;...&quot;)] æ ¹æ®ç»™å®šçš„å¤§å°å†™çº¦å®šé‡å‘½åæ‰€æœ‰å­—æ®µï¼ˆå¦‚æœè¿™æ˜¯ä¸€ä¸ªç»“æ„ï¼‰æˆ–å˜é‡ï¼ˆå¦‚æœè¿™æ˜¯ä¸€ä¸ªæšä¸¾ï¼‰ã€‚å¯èƒ½çš„å€¼æ˜¯&quot;lowercase&quot;, &quot;UPPERCASE&quot;, &quot;PascalCase&quot;, &quot;camelCase&quot;, &quot;snake_case&quot;, &quot;SCREAMING_SNAKE_CASE&quot;, &quot;kebab-case&quot;, &quot;SCREAMING-KEBAB-CASE&quot;ã€‚ é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå®¹å™¨å±æ€§ä¸»è¦æ˜¯å…è®¸ä½ å®šä¹‰é©¼å³°ï¼Œè›‡å½¢ç­‰åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–çš„å­—æ®µ 1234567891011121314151617181920212223242526use serde::&#123;Serialize, Deserialize&#125;;#[derive(Serialize, Deserialize, Debug)]#[serde(deny_unknown_fields)] // &lt;-- this is a container attribute#[serde(rename_all = \"UPPERCASE\")]struct S &#123; #[serde(default)] // &lt;-- this is a field attribute f: i32, hello_world: E&#125;#[derive(Serialize, Deserialize, Debug)]#[serde(rename = \"e\")] // &lt;-- this is also a container attributeenum E &#123; #[serde(rename = \"a\")] // &lt;-- this is a variant attribute A(String),&#125;fn main() &#123; let point_s = S &#123; f: 1 , hello_world: E::A(String::from(\"inner-enum\"))&#125;; // Convert the Point to a JSON string. let serialized_a = serde_json::to_string(&amp;point_s).unwrap(); // normal output =&gt; serialized_a: &#123;\"f\":1,\"hello_world\":&#123;\"a\":\"inner-enum\"&#125;&#125; println!(\"serialized_a: &#123;&#125;\", serialized_a);&#125; 1234/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test Finished dev [unoptimized + debuginfo] target(s) in 0.02s Running `target/debug/serde_test`serialized_a: &#123;\"F\":1,\"HELLO_WORLD\":&#123;\"a\":\"inner-enum\"&#125;&#125; #[serde(deny_unknown_fields)]é‡åˆ°æœªçŸ¥å­—æ®µæ—¶ï¼Œåœ¨ååºåˆ—åŒ–æœŸé—´å§‹ç»ˆä¼šå‡ºé”™ã€‚å½“æ­¤å±æ€§ä¸å­˜åœ¨æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹äºè¯¸å¦‚JSONä¹‹ç±»çš„è‡ªæè¿°æ ¼å¼ï¼ŒæœªçŸ¥å­—æ®µå°†è¢«å¿½ç•¥ã€‚ 1234567891011121314151617use serde::&#123;Serialize, Deserialize&#125;;#[derive(Serialize, Deserialize, Debug)]struct S &#123; #[serde(default)] f: i32,&#125;fn main() &#123; let s = r#\" &#123;\"f\":1,\"s_e\":&#123;\"a\":\"inner-enum\"&#125;&#125; \"#; let uns: S = serde_json::from_str(&amp;s).unwrap(); println!(\"un: &#123;:?&#125;\", uns);&#125; 1234/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test Finished dev [unoptimized + debuginfo] target(s) in 0.02s Running `target/debug/serde_test`un: S &#123; f: 1&#125; å¯ä»¥çœ‹åˆ°æˆåŠŸè¾“å‡ºã€‚å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å­—æ®µåˆ°è¯ä¼šè‡ªåŠ¨å¿½ç•¥ã€‚ä½†æ˜¯å¦‚æœä½ å¸Œæœ›ä¸¥æ ¼åˆ°åŒ¹é…çš„è¯ã€‚é‚£ä¹ˆå°±å¯ä»¥åŠ ä¸Šæ­¤å®¹å™¨å±æ€§. 123456789101112131415161718use serde::&#123;Serialize, Deserialize&#125;;#[derive(Serialize, Deserialize, Debug)]#[serde(deny_unknown_fields)]struct S &#123; #[serde(default)] f: i32,&#125;fn main() &#123; let s = r#\" &#123;\"f\":1,\"s_e\":&#123;\"a\":\"inner-enum\"&#125;&#125; \"#; let uns: S = serde_json::from_str(&amp;s).unwrap(); println!(\"un: &#123;:?&#125;\", uns);&#125; 123456789101112131415161718/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test Finished dev [unoptimized + debuginfo] target(s) in 0.02s Running `target/debug/serde_test`thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Error(\"unknown field `s_e`, expected `f` or `s_e`\", line: 2, column: 44)', src/main.rs:34:43stack backtrace: 0: rust_begin_unwind at /rustc/e1884a8e3c3e813aada8254edfa120e85bf5ffca/library/std/src/panicking.rs:495:5 1: core::panicking::panic_fmt at /rustc/e1884a8e3c3e813aada8254edfa120e85bf5ffca/library/core/src/panicking.rs:92:14 2: core::option::expect_none_failed at /rustc/e1884a8e3c3e813aada8254edfa120e85bf5ffca/library/core/src/option.rs:1268:5 3: core::result::Result&lt;T,E&gt;::unwrap at /Users/caiwenhui/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/result.rs:973:23 4: serde_test::main at ./src/main.rs:34:18 5: core::ops::function::FnOnce::call_once at /Users/caiwenhui/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/ops/function.rs:227:5note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace. å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šæŠ¥é”™. #[serde(tag = â€œtypeâ€)]è¯¥å±æ€§åªé€‚ç”¨äºæšä¸¾ä½“ï¼Œå…·ä½“ç”¨æ³•è¯¦è§:[ enum representations ](\bhttps://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md) #[serde(tag = â€œtâ€, content = â€œcâ€)]è¯¥å±æ€§åªé€‚ç”¨äºæšä¸¾ä½“ï¼Œå…·ä½“ç”¨æ³•è¯¦è§:[ enum representations ](\bhttps://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md) #[serde(untagged)]è¯¥å±æ€§åªé€‚ç”¨äºæšä¸¾ä½“ï¼Œå…·ä½“ç”¨æ³•è¯¦è§:[ enum representations ](\bhttps://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md) serdeserde-qs","categories":[{"name":"rust","slug":"rust","permalink":"http://blog.crazylaw.cn/categories/rust/"}],"tags":[{"name":"rust","slug":"rust","permalink":"http://blog.crazylaw.cn/tags/rust/"}]},{"title":"ã€æ•°æ®åº“å¼€å‘ã€‘msource","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†/msource","date":"2021-03-26T17:16:43.000Z","updated":"2021-03-31T09:00:10.369Z","comments":true,"path":"2021/03/27/æ•°æ®åº“å¼€å‘çŸ¥è¯†/msource/","link":"","permalink":"http://blog.crazylaw.cn/2021/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/msource/","excerpt":"å‰è¨€CAPåŸåˆ™åˆç§°CAPå®šç†ï¼ŒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ã€åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ã€‚CAP åŸåˆ™æŒ‡çš„æ˜¯ï¼Œè¿™ä¸‰ä¸ªè¦ç´ æœ€å¤šåªèƒ½åŒæ—¶å®ç°ä¸¤ç‚¹ï¼Œä¸å¯èƒ½ä¸‰è€…å…¼é¡¾ã€‚ msource æ˜¯æˆ‘ä»¬çš„ä¸€ä¸ª æ•°æ®æºç»„ä»¶ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„å¤§æ•°æ®ETLæœåŠ¡éƒ½æ„å»ºåœ¨æ­¤ä¹‹ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬msourceå¯ä»¥è¯´æ˜¯æ‰€æœ‰ä¸šåŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒã€‚ä»–ç»´æŠ¤ç€ä¸€ä¸ªç¨³å®šï¼Œå¯é ï¼Œé«˜æ€§èƒ½çš„æ•°æ®ä¼ è¾“æœºåˆ¶ã€‚è®©æˆ‘ä»¬ ä¸šåŠ¡å±‚ ä¸­å¯ä»¥åšå„ç§æ“ä½œï¼ŒåŒæ­¥ï¼Œå¼‚æ­¥ç­‰ç­‰ã€‚ msource çš„è§’è‰²æˆ‘å¤§ä½“åˆ†ä¸ºäº†2ç§ï¼š spout ï¼ˆæ•°æ®æ¨é€ç»„ä»¶) db ï¼ˆæ•°æ®å­˜å‚¨ç»„ä»¶ï¼‰","text":"å‰è¨€CAPåŸåˆ™åˆç§°CAPå®šç†ï¼ŒæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ã€åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ã€‚CAP åŸåˆ™æŒ‡çš„æ˜¯ï¼Œè¿™ä¸‰ä¸ªè¦ç´ æœ€å¤šåªèƒ½åŒæ—¶å®ç°ä¸¤ç‚¹ï¼Œä¸å¯èƒ½ä¸‰è€…å…¼é¡¾ã€‚ msource æ˜¯æˆ‘ä»¬çš„ä¸€ä¸ª æ•°æ®æºç»„ä»¶ï¼Œæˆ‘ä»¬æ‰€æœ‰çš„å¤§æ•°æ®ETLæœåŠ¡éƒ½æ„å»ºåœ¨æ­¤ä¹‹ä¸Šï¼Œæ‰€ä»¥æˆ‘ä»¬msourceå¯ä»¥è¯´æ˜¯æ‰€æœ‰ä¸šåŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒã€‚ä»–ç»´æŠ¤ç€ä¸€ä¸ªç¨³å®šï¼Œå¯é ï¼Œé«˜æ€§èƒ½çš„æ•°æ®ä¼ è¾“æœºåˆ¶ã€‚è®©æˆ‘ä»¬ ä¸šåŠ¡å±‚ ä¸­å¯ä»¥åšå„ç§æ“ä½œï¼ŒåŒæ­¥ï¼Œå¼‚æ­¥ç­‰ç­‰ã€‚ msource çš„è§’è‰²æˆ‘å¤§ä½“åˆ†ä¸ºäº†2ç§ï¼š spout ï¼ˆæ•°æ®æ¨é€ç»„ä»¶) db ï¼ˆæ•°æ®å­˜å‚¨ç»„ä»¶ï¼‰ åœ¨è¿™ä¸ªå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œdbå¯ä»¥ç‹¬ç«‹å‡ºæ¥åº”ç”¨ï¼Œä»–ä¸ä¾èµ–äºspoutã€‚spouté»˜è®¤çš„ä¼ è¾“æœºåˆ¶æ˜¯æˆ‘ä»¬golangä¸­çš„channelæ¨¡å¼ï¼Œä½†æ˜¯å®ƒå¯ä»¥é€‰æ‹©ä½¿ç”¨dbæ¨¡å¼ã€‚ MSOURCE_DBRockesDBçš„åŸºç¡€çŸ¥è¯†rocksdb æˆ‘ä»¬çŸ¥é“ä»–æ˜¯æ”¯æŒWALï¼ˆWrite Ahead Logï¼‰çš„ï¼Œä¸€èˆ¬çš„logæ–‡ä»¶ä¸­é€šå¸¸åŒ…æ‹¬ redo log å’Œ undo logã€‚å…¶å®è¿™ä¸ä»…ä»…æ˜¯rocksdbç‹¬æœ‰çš„ï¼Œè¿™æ˜¯ä¸€ç§å¯é æ€§çš„ä¿è¯ï¼Œåƒmysqlä¸€æ ·æœ‰è¿™ç§æœºåˆ¶ï¼Œä¹Ÿæ˜¯åˆ†ä¸ºredo log, undo log, binlogï¼ŒåŒºåˆ«å°±åœ¨äº binlog å±äºé€»è¾‘æ—¥å¿—ï¼Œredo logå’Œundo logå±äºç‰©ç†æ—¥å¿—ã€‚ rocksdbæ˜¯facebookå¼€å‘çš„ä¸€ä¸ªkvå­˜å‚¨å¼•æ“ã€‚ä»–çš„æœºæ„æ¨¡å¼æ˜¯åŸºäºLSMçš„ã€‚åŸºäºLSMçš„æ¶æ„éƒ½éœ€è¦ç»è¿‡ä¸€ä¸ªå« Compaction è¿‡ç¨‹ï¼Œé€šå¸¸Compactionæ¶‰åŠåˆ°ä¸‰ä¸ªæ”¾å¤§å› å­ã€‚ Compactionéœ€è¦åœ¨ä¸‰è€…ä¹‹é—´åšå–èˆã€‚ å†™æ”¾å¤§ ï¼ˆWrite Amplificationï¼‰ è¯»æ”¾å¤§ï¼ˆRead Amplificationï¼‰ ç©ºé—´æ”¾å¤§ ï¼ˆSpace Amplificationï¼‰ åå°çš„ compaction æ¥å‡å°‘è¯»æ”¾å¤§ï¼ˆå‡å°‘ SST æ–‡ä»¶æ•°é‡ï¼‰å’Œç©ºé—´æ”¾å¤§ï¼ˆæ¸…ç†è¿‡æœŸæ•°æ®ï¼‰ï¼Œä½†ä¹Ÿå› æ­¤å¸¦æ¥äº†å†™æ”¾å¤§ï¼ˆWrite Amplificationï¼‰çš„é—®é¢˜ã€‚ Compactionå†™æ”¾å¤§å‡è®¾æ¯ç§’å†™å…¥10MBçš„æ•°æ®ï¼Œä½†è§‚å¯Ÿåˆ°ç¡¬ç›˜çš„å†™å…¥æ˜¯30MB/sï¼Œé‚£ä¹ˆå†™æ”¾å¤§å°±æ˜¯3ã€‚å†™åˆ†ä¸ºç«‹å³å†™å’Œå»¶è¿Ÿå†™ï¼Œæ¯”å¦‚redo logæ˜¯ç«‹å³å†™ï¼Œä¼ ç»ŸåŸºäºB-Treeæ•°æ®åº“åˆ·è„é¡µå’ŒLSM Compactionæ˜¯å»¶è¿Ÿå†™ã€‚redo logä½¿ç”¨direct IOå†™æ—¶è‡³å°‘ä»¥512å­—èŠ‚å¯¹é½ï¼Œå‡å¦‚logè®°å½•ä¸º100å­—èŠ‚ï¼Œç£ç›˜éœ€è¦å†™å…¥512å­—èŠ‚ï¼Œå†™æ”¾å¤§ä¸º5ã€‚ DirectIOæ˜¯ç›´æ¥æ“ä½œIOï¼Œä¸ç»è¿‡BufferIOã€‚BufferIOä¹Ÿç§°ä¸ºæ ‡å‡†IOï¼Œä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å®ç°çš„ï¼šread() å’Œ write()ã€‚BufferIOç”¨äº†æ“ä½œç³»ç»Ÿå†…æ ¸çš„é¡µç¼“å­˜ï¼Œä¿æŠ¤äº†ç£ç›˜ï¼Œå‡å°‘è¯»ç›˜çš„æ¬¡æ•°ï¼Œæé«˜äº†è¯»å–é€Ÿåº¦ã€‚ä½†æ˜¯ç”±äºä½¿ç”¨äº†é¡µç¼“å­˜ï¼Œå®ƒæ˜¯å¤„äºå†…æ ¸ç©ºé—´çš„ï¼Œæ— æ³•è¢«ç”¨æˆ·ç›´æ¥æ“ä½œï¼Œæ‰€ä»¥éœ€è¦ç»å†ä¸€æ¬¡æ•°æ®æ‹·è´å¤åˆ¶ã€‚DirectIO æ•°æ®å‡ç›´æ¥åœ¨ç”¨æˆ·åœ°å€ç©ºé—´çš„ç¼“å†²åŒºå’Œç£ç›˜ä¹‹é—´ç›´æ¥è¿›è¡Œä¼ è¾“ï¼Œä¸­é—´å°‘äº†é¡µç¼“å­˜çš„æ”¯æŒã€‚è¯»å†™æ•°æ®çš„æ—¶å€™è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚ä½¿ç”¨ç›´æ¥ I/O è¯»å†™æ•°æ®å¿…é¡»è¦æ³¨æ„ç¼“å†²åŒºå¯¹é½ã€‚ è¯»æ”¾å¤§å¯¹åº”äºä¸€ä¸ªç®€å•queryéœ€è¦è¯»å–ç¡¬ç›˜çš„æ¬¡æ•°ã€‚æ¯”å¦‚ä¸€ä¸ªç®€å•queryè¯»å–äº†5ä¸ªé¡µé¢ï¼Œå‘ç”Ÿäº†5æ¬¡IOï¼Œé‚£ä¹ˆè¯»æ”¾å¤§å°±æ˜¯ 5ã€‚å‡å¦‚B-Treeçš„éå¶å­èŠ‚ç‚¹éƒ½ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œpoint read-amp ä¸º1ï¼Œä¸€æ¬¡ç£ç›˜è¯»å–å°±å¯ä»¥è·å–åˆ°Leaf Blockï¼›short range read-amp ä¸º12ï¼Œ12æ¬¡ç£ç›˜è¯»å–å¯ä»¥è·å–åˆ°æ‰€éœ€çš„Leaf Blockã€‚ æ“ä½œéœ€è¦ä»æ–°åˆ°æ—§ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰ä¸€å±‚ä¸€å±‚æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æƒ³è¦çš„æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦ä¸æ­¢ä¸€æ¬¡ I/Oã€‚ç‰¹åˆ«æ˜¯ range query çš„æƒ…å†µï¼Œå½±å“å¾ˆæ˜æ˜¾ã€‚ ç©ºé—´æ”¾å¤§å‡è®¾æˆ‘éœ€è¦å­˜å‚¨10MBæ•°æ®ï¼Œä½†å®é™…ç¡¬ç›˜å ç”¨äº†30MBï¼Œé‚£ä¹ˆç©ºé—´æ”¾å¤§å°±æ˜¯3ã€‚æœ‰æ¯”è¾ƒå¤šçš„å› ç´ ä¼šå½±å“ç©ºé—´æ”¾å¤§ï¼Œæ¯”å¦‚åœ¨Compactionè¿‡ç¨‹ä¸­éœ€è¦ä¸´æ—¶å­˜å‚¨ç©ºé—´ï¼Œç©ºé—´ç¢ç‰‡ï¼ŒBlockä¸­æœ‰æ•ˆæ•°æ®çš„æ¯”ä¾‹å°ï¼Œæ—§ç‰ˆæœ¬æ•°æ®æœªåŠæ—¶åˆ é™¤ç­‰ç­‰ã€‚ æ‰€æœ‰çš„å†™å…¥éƒ½æ˜¯é¡ºåºå†™ append-only çš„ï¼Œä¸æ˜¯ in-place updateï¼Œæ‰€ä»¥è¿‡æœŸæ•°æ®ä¸ä¼šé©¬ä¸Šè¢«æ¸…ç†æ‰ã€‚ LSM æ ‘LSM æ ‘çš„è®¾è®¡æ€æƒ³éå¸¸æœ´ç´ , å®ƒçš„åŸç†æ˜¯æŠŠä¸€é¢—å¤§æ ‘æ‹†åˆ†æˆNæ£µå°æ ‘ï¼Œ å®ƒé¦–å…ˆå†™å…¥åˆ°å†…å­˜ä¸­ï¼ˆå†…å­˜æ²¡æœ‰å¯»é“é€Ÿåº¦çš„é—®é¢˜ï¼Œéšæœºå†™çš„æ€§èƒ½å¾—åˆ°å¤§å¹…æå‡ï¼‰ï¼Œåœ¨å†…å­˜ä¸­æ„å»ºä¸€é¢—æœ‰åºå°æ ‘ï¼Œéšç€å°æ ‘è¶Šæ¥è¶Šå¤§ï¼Œå†…å­˜çš„å°æ ‘ä¼šflushåˆ°ç£ç›˜ä¸Šã€‚ç£ç›˜ä¸­çš„æ ‘å®šæœŸå¯ä»¥åš merge æ“ä½œï¼Œåˆå¹¶æˆä¸€æ£µå¤§æ ‘ï¼Œä»¥ä¼˜åŒ–è¯»æ€§èƒ½ã€è¯»æ•°æ®çš„è¿‡ç¨‹å¯èƒ½éœ€è¦ä»å†…å­˜ memtable åˆ°ç£ç›˜ sstfile è¯»å–å¤šæ¬¡ï¼Œç§°ä¹‹ä¸ºè¯»æ”¾å¤§ã€‘ã€‚RocksDB çš„ LSM ä½“ç°åœ¨å¤š level æ–‡ä»¶æ ¼å¼ä¸Šï¼Œæœ€çƒ­æœ€æ–°çš„æ•°æ®å°½åœ¨ L0 å±‚ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæœ€å†·æœ€è€çš„æ•°æ®å°½åœ¨ LN å±‚ï¼Œæ•°æ®åœ¨ç£ç›˜æˆ–è€…å›ºæ€ç›˜ä¸Šã€‚ RocksdbRocksDBçš„ä¸‰ç§åŸºæœ¬æ–‡ä»¶æ ¼å¼æ˜¯ memtable / sstfile / logfileï¼Œmemtable æ˜¯ä¸€ç§å†…å­˜æ–‡ä»¶æ•°æ®ç³»ç»Ÿï¼Œæ–°å†™æ•°æ®ä¼šè¢«å†™è¿› memtableï¼Œéƒ¨åˆ†è¯·æ±‚å†…å®¹ä¼šè¢«å†™è¿› logfileã€‚logfile æ˜¯ä¸€ç§æœ‰åˆ©äºé¡ºåºå†™çš„æ–‡ä»¶ç³»ç»Ÿã€‚memtable çš„å†…å­˜ç©ºé—´è¢«å¡«æ»¡ä¹‹åï¼Œä¼šæœ‰ä¸€éƒ¨åˆ†è€æ•°æ®è¢«è½¬ç§»åˆ° sstfile é‡Œé¢ï¼Œè¿™äº›æ•°æ®å¯¹åº”çš„ logfile é‡Œçš„ log å°±ä¼šè¢«å®‰å…¨åˆ é™¤ å•ç‹¬çš„ Get/Put/Delete æ˜¯åŸå­æ“ä½œï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ï¼Œä¸å­˜åœ¨ä¸­é—´çŠ¶æ€ã€‚ å¦‚æœéœ€è¦è¿›è¡Œæ‰¹é‡çš„ Get/Put/Delete æ“ä½œä¸”éœ€è¦æ“ä½œä¿æŒåŸå­å±æ€§ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ WriteBatchã€‚ L0 -&gt; L1 L1 -&gt; L2 L1 -&gt; L2 å¯ä»¥çœ‹åˆ°ä¸»è¦çš„ä¸‰ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå†…å­˜ç»“æ„memtableï¼Œç±»ä¼¼äº‹åŠ¡æ—¥å¿—è§’è‰²çš„WALæ–‡ä»¶ï¼ŒæŒä¹…åŒ–çš„SSTæ–‡ä»¶ã€‚ æ•°æ®ä¼šæ”¾åˆ°å†…å­˜ç»“æ„memtableï¼Œå½“memtableçš„æ•°æ®å¤§å°è¶…è¿‡é˜ˆå€¼(write_buffer_size)åï¼Œä¼šæ–°ç”Ÿæˆä¸€ä¸ªmemtableç»§ç»­å†™ï¼Œå°†å‰ä¸€ä¸ªmemtableä¿å­˜ä¸ºåªè¯»memtableã€‚å½“åªè¯»memtableçš„æ•°é‡è¶…è¿‡é˜ˆå€¼åï¼Œä¼šå°†æ‰€æœ‰çš„åªè¯»memtableåˆå¹¶å¹¶flushåˆ°ç£ç›˜ç”Ÿæˆä¸€ä¸ªSSTæ–‡ä»¶ã€‚ è¿™é‡Œçš„SSTå±äºlevel0ï¼Œ level0ä¸­çš„æ¯ä¸ªSSTæœ‰åºï¼Œå¯èƒ½ä¼šæœ‰äº¤å‰ã€‚å†™å…¥WALæ–‡ä»¶æ˜¯å¯é€‰çš„ï¼Œç”¨æ¥æ¢å¤æœªå†™å…¥åˆ°ç£ç›˜çš„memtableã€‚ memtableå¦‚å…¶åä¸ºä¸€ç§å†…å­˜çš„æ•°æ®ç»“æ„ã€‚é€šè¿‡è®¾ç½®memtableçš„å¤§å°ã€æ€»å¤§å°æ¥æ§åˆ¶ä½•æ—¶flushåˆ°SSTæ–‡ä»¶ã€‚å¤§éƒ¨åˆ†æ ¼å¼çš„memtableä¸æ”¯æŒå¹¶å‘å†™å…¥ï¼Œå¹¶å‘è°ƒç”¨ä¾ç„¶ä¼šä¾æ¬¡å†™å…¥ã€‚ç›®å‰ä»…æ”¯æŒskiplistã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245rocksdb: options: # å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨æ˜¯å¦è‡ªåŠ¨å»ºç«‹ # default: false create.if.missing: true # å¦‚æœæ•°æ®åº“å·²ç»å­˜åœ¨æ˜¯å¦ç›´æ¥æŠ›å‡ºå¼‚å¸¸ # default: false error.if.exists: false # default: false paranoid.checks: false # æ—¥å¿—ç­‰çº§ # Debug = 0/Info = 1/Warn = 2/Error = 3/Fatal = 4 info.log.level: 3 # æœ€ä½³å€¼æ˜¯å†…æ ¸ï¼ˆcpuï¼‰æ•° # é»˜è®¤RocksDBåªä½¿ç”¨ä¸€ä¸ªåå°çº¿ç¨‹è¿›è¡Œflushå’Œcompaction # default: 1 increase.parallelism: 4 # æ˜¯å¦å…è®¸å¹¶å‘å†™å…¥memtabeï¼Œç›®å‰ä»…æ”¯æŒskiplist # default: false allow.concurrent.memtable.writes: false # æ›´å¤§çš„å€¼å¯ä»¥æé«˜æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨æ‰¹é‡åŠ è½½æ—¶ # æ­¤å¤–ï¼Œæ›´å¤§çš„å†™ç¼“å†²åŒºåœ¨ä¸‹æ¬¡æ‰“å¼€æ•°æ®åº“æ—¶å°†å¯¼è‡´æ›´é•¿çš„æ¢å¤æ—¶é—´ write.buffer.size: 64 * 1024 * 1024 # æœ€å¤§å†™ç¼“å†²åŒºæ•°, å½“ä¸€ä¸ªå†™ç¼“å†²åŒºè¢«åˆ·æ–°åˆ°å­˜å‚¨æ—¶ï¼Œæ–°çš„å†™æ“ä½œå¯ä»¥ç»§ç»­åˆ°å¦ä¸€ä¸ªå†™ç¼“å†²åŒº # default: 2 max.write.buffer.number: 4 min.write.buffer.number.to.merge: 1 max.open.files: 1000 max.file.opening.threads: 16 # æ•°æ®å‹ç¼©æ–¹å¼ # No = 0/ Snappy = 1 / ZLib = 2 / Bz2 = 3 / LZ4 = 4 / LZ4HC = 5 / Xpress = 6 / ZSTD = 7 compression: 1 # è®¾ç½®æ•°æ®åº“çš„levelçš„æ•°é‡ # é»˜è®¤å€¼ä¸º7å±‚ num.levels: 7 # level-0 è§¦å‘åˆå¹¶çš„çš„æ–‡ä»¶æ•°æ¡ä»¶ level0.file.num.compaction.trigger: 4 # level-0 æ”¾æ…¢å†™å…¥é€Ÿåº¦çš„æ–‡ä»¶æ•°æ¡ä»¶ level0.slowdown.writes.trigger: 8 # level-0 åœæ­¢å†™å…¥çš„æ–‡ä»¶æ•°æ¡ä»¶ level0.stop.writes.trigger: 12 # å°è¯•ä»memåˆ°sstçš„æœ€å¤§çº§åˆ« max.mem.compaction.level: 2 # ç›®æ ‡æ–‡ä»¶åŸºç¡€å¤§å° # å¦‚æœ target_file_size_baseæ˜¯2MB, # target_file_size_multiplieræ˜¯10ï¼Œ # é‚£ä¹ˆç¬¬1çº§çš„æ¯ä¸ªæ–‡ä»¶éƒ½æ˜¯2MB # ç¬¬2çº§çš„æ¯ä¸ªæ–‡ä»¶æ˜¯20MB # ç¬¬3çº§çš„æ¯ä¸ªæ–‡ä»¶æ˜¯200MB target.file.size.base: &amp;target_file_size_base 2 * 1024 * 1024 # ç›®æ ‡åŸºç¡€æ–‡ä»¶å€æ•° target.file.size.multiplier: 1 # æ‰€åœ¨levelæ‰€æœ‰æ–‡ä»¶æ€»å¤§å° # ä¾‹å¦‚ï¼Œmax_bytes_for_level_baseä¸º20MB, # max_bytes_for_level_multiplierä¸º10ï¼Œåˆ™ç¬¬1çº§çš„æ€»æ•°æ®å¤§å°ä¸º20MB # ç¬¬2çº§çš„æ€»æ–‡ä»¶å¤§å°ä¸º200MB # ç¬¬3çº§çš„æ€»æ–‡ä»¶å¤§å°ä¸º2GB # default: 10M max.bytes.for.level.base: 10 * 1024 * 1024 # ç›®æ ‡æ‰€åœ¨levelæ€»æ–‡ä»¶å¤§å° # default: 10 max.bytes.for.level.multiplier: 10.0 level.compaction.dynamic.level.bytes: false # ä¸€æ¬¡æ€§æœ€å¤§æ‰“å‹ç¼©å­—èŠ‚ # Default: target.file.size.base * 25 max.compaction.bytes: *target_file_size_base * 25 # è½¯é™åˆ¶ï¼šå½“éœ€è¦å‹ç¼©çš„ä¼°è®¡å­—èŠ‚æ•°è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶ï¼Œæ‰€æœ‰çš„å†™éƒ½ä¼šè¢«å‡é€Ÿåˆ°è‡³å°‘ delayed_write_rate # default: 64GB soft.pending.compaction.bytes.limit: 64 * 1024 * 1024 * 1024 # ç¡¬é™åˆ¶ï¼šå½“éœ€è¦å‹ç¼©çš„ä¼°è®¡å­—èŠ‚æ•°è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶ï¼Œæ‰€æœ‰çš„å†™éƒ½åœæ­¢ # default: 256GB hard.pending.compaction.bytes.limit: 256 * 1024 * 1024 * 1024 # æ˜¯å¦ä½¿ç”¨fsyncåˆ·ç›˜ # default: false use.fsync: false # æŒ‡å®šæ•°æ®åº“çš„æ—¥å¿—ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™å’Œæ•°æ®æ”¾åœ¨åŒä¸€ä¸ªç›®å½• # default: empty db.log.dir: \"\" # æŒ‡å®šæ•°æ®åº“çš„WAL(é¢„å†™å…¥æ—¥å¿—)çš„ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºåˆ™å’Œæ•°æ®æ”¾åœ¨åŒä¸€ä¸ªç›®å½• wal.dir: \"\" # è®¾ç½®è¿‡æœŸæ–‡ä»¶è¢«åˆ é™¤çš„å‘¨æœŸ # é€šè¿‡å‹ç¼©è¿‡ç¨‹è¶…å‡ºä½œç”¨åŸŸçš„æ–‡ä»¶åœ¨æ¯æ¬¡å‹ç¼©æ—¶ä»ç„¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œä¸ç®¡è¿™ä¸ªè®¾ç½®æ˜¯ä»€ä¹ˆ # default: 6 hours delete.obsolete.files.period.micros: 6 * 60 * 60 * 1000 * 1000 # è®¾ç½®åå°ä»»åŠ¡çš„æœ€å¤§å¹¶å‘æ•°ï¼Œä½œç”¨ä¸ä½ä¼˜å…ˆçº§çº¿ç¨‹æ±  # default: 1 max.background.compactions: 2 # é«˜ä¼˜å…ˆçº§çº¿ç¨‹æ± çš„åå° memtable çš„ flush ä»»åŠ¡çš„æœ€å¤§å¹¶å‘æ•° # é»˜è®¤æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨ä½ä¼˜å…ˆçº§æ±  # default: 0 max.background.flushes: 0 # è®¾ç½®æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼Œå¦‚æœæ—¥å¿—æ–‡ä»¶å¤§äºè¿™ä¸ªå€¼å°†ä¼šè¢«åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ # å¦‚æœç­‰äº0ï¼Œåˆ™æ—¥å¿—åªä¼šå†™å…¥ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ # default: 0 max.log.file.size: 0 # æ—¥å¿—æ–‡ä»¶æ»šåŠ¨çš„æ—¶é—´(ä»¥ç§’ä¸ºå•ä½)ï¼Œæ—¥å¿—æŒ‰ä¸€å®šæ—¶é—´è½®è½¬ # default: 0 (ç¦ç”¨çŠ¶æ€) log.file.time.to.roll: 24 * 60 * 60 # æœ€å¤šä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•° # default: 1000 keep.log.file.num: 30 # è½¯é€Ÿç‡é™åˆ¶ # å½“ä»»ä½•levelçš„å‹ç¼©åˆ†æ•°è¶…è¿‡soft_rate_limitæ—¶ï¼Œputè¢«å»¶è¿Ÿ0-1æ¯«ç§’ã€‚å½“ ç­‰äº 0.0æ—¶ï¼Œæ­¤å‚æ•°å°†è¢«å¿½ç•¥ # soft_rate_limit &lt;= hard_rate_limitã€‚å¦‚æœæ­¤çº¦æŸä¸å­˜åœ¨ï¼ŒRocksDBå°†è®¾ç½®soft_rate_limit = hard_rate_limit # default: 0.0(ç¦ç”¨çŠ¶æ€) soft.rate.limit: 0.0 # ç¡¬é€Ÿç‡é™åˆ¶ # å½“ä»»ä½•levelçš„å‹ç¼©åˆ†æ•°è¶…è¿‡hard_rate_limitæ—¶ï¼Œputæ¯æ¬¡å»¶è¿Ÿ1msã€‚å½“ å°äºç­‰äº 1.0 æ—¶ï¼Œæ­¤å‚æ•°è¢«å¿½ç•¥ # default: 0.0(ç¦ç”¨çŠ¶æ€) hard.rate.limit: 0.0 # è®¾ç½®å½“å¼ºåˆ¶æ‰§è¡Œhard_rate_limitæ—¶ï¼Œputè¢«åœæ­¢çš„æœ€å¤§æ—¶é—´, 0 = æ²¡æœ‰é™åˆ¶ # default: 1000 rate.limit.delay.max.milliseconds: 1000 # è®¾ç½®æœ€å¤§æ¸…å•æ–‡ä»¶å¤§å°ï¼Œç›´åˆ°æ»šåŠ¨ä¸ºæ­¢, ä¼šåˆ é™¤æ—§çš„æ¸…å•æ–‡ä»¶ # é»˜è®¤å€¼:MAX_INTï¼Œè¿™æ ·æ»šåŠ¨å°±ä¸ä¼šå‘ç”Ÿ max.manifest.file.size: 1&lt;&lt;64 - 1 # è®¾ç½®è¡¨ç¼“å­˜ä½¿ç”¨çš„åˆ†ç‰‡æ•°é‡ # default: 4 table.cache.numshardbits: 4 # è®¾ç½®æ‰«æè¿‡ç¨‹ä¸­çš„è®¡æ•°é™åˆ¶ # åœ¨è¡¨çš„LRUç¼“å­˜æ•°æ®å›æ”¶æ—¶ï¼Œä¸¥æ ¼éµå¾ªLRUæ˜¯ä½æ•ˆçš„ï¼Œå› ä¸ºè¿™å—å†…å­˜ä¸ä¼šçœŸæ­£è¢«é‡Šæ”¾ï¼Œé™¤éå®ƒçš„refcounté™åˆ°é›¶ã€‚ # ç›¸åï¼Œè¿›è¡Œä¸¤æ¬¡ä¼ é€’:ç¬¬ä¸€æ¬¡ä¼ é€’å°†é‡Šæ”¾refcount = 1çš„é¡¹ï¼Œå¦‚æœåœ¨æ‰«æè¯¥å‚æ•°æŒ‡å®šçš„å…ƒç´ æ•°é‡åæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´é‡Šæ”¾ï¼Œå°†æŒ‰LRUé¡ºåºåˆ é™¤é¡¹ # default: 16 table.cache.remove.scan.count.limit: 16 # default: 0 (è‡ªåŠ¨è®¡ç®—ä¸€ä¸ªåˆé€‚çš„å€¼) arena.block.size: 0 # å¯ç”¨/ç¦ç”¨è‡ªåŠ¨å‹ç¼© # default: false disable.auto.compactions: false # è®¾ç½® Wal çš„æ¢å¤æ¨¡å¼ # TolerateCorruptedTailRecordsRecovery = 0 / AbsoluteConsistencyRecovery = 1 # PointInTimeRecovery = 2 / SkipAnyCorruptedRecordsRecovery = 3 # default: 0 w.a.l.recovery.mode: 0 # è®¾ç½®walçš„ttlæ—¶é—´ # æœ‰2ä¸ªå€¼å½±å“ å½’æ¡£çš„ wal æ˜¯å¦ä¼šè¢«åˆ é™¤ # 1ã€‚å¦‚æœä¸¤è€…éƒ½è®¾ç½®ä¸º0ï¼Œæ—¥å¿—å°†è¢«å°½å¿«åˆ é™¤ï¼Œå¹¶ä¸”ä¸ä¼šè¿›å…¥å­˜æ¡£ã€‚ # 2ã€‚å¦‚æœwal_ttl_secondsä¸º0,wal_size_limit_mbä¸ä¸º0ï¼Œåˆ™æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡WALæ–‡ä»¶ï¼Œå¦‚æœæ€»å¤§å°å¤§äºwal_size_limit_mbï¼Œåˆ™ä»æœ€æ—©çš„æ–‡ä»¶å¼€å§‹åˆ é™¤ï¼Œç›´åˆ°æ»¡è¶³size_limitã€‚æ‰€æœ‰çš„ç©ºæ–‡ä»¶å°†è¢«åˆ é™¤ã€‚ # 3ã€‚å¦‚æœwal_ttl_secondsä¸ä¸º0,wall_size_limit_mbä¸º0ï¼Œé‚£ä¹ˆæ¯ä¸ªwal_ttl_seconds / 2éƒ½ä¼šæ£€æŸ¥WALæ–‡ä»¶ï¼Œæ¯”wal_ttl_secondsè€çš„æ–‡ä»¶ä¼šè¢«åˆ é™¤ã€‚ # 4ã€‚å¦‚æœä¸¤ä¸ªéƒ½ä¸æ˜¯0ï¼Œåˆ™æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡WALæ–‡ä»¶ï¼Œå¹¶ä¸”ä¸¤ä¸ªæ£€æŸ¥éƒ½å°†åœ¨ttlä¼˜å…ˆçš„æƒ…å†µä¸‹æ‰§è¡Œã€‚ # default: 0 w.a.l.ttl.seconds: 0 # è®¾ç½®WALå¤§å°é™åˆ¶ï¼Œå•ä½ä¸ºMB # å¦‚æœWALæ–‡ä»¶çš„æ€»å¤§å°å¤§äºwal_size_limit_mbï¼Œåˆ™ä»æœ€æ—©çš„æ–‡ä»¶å¼€å§‹åˆ é™¤ï¼Œç›´åˆ°æ»¡è¶³size_limitå€¼ä¸ºæ­¢ # default: 0 wal.size.limit.mb: 0 # å…è®¸ç®¡é“å†™å…¥ # default: false enable.pipelined.write: false # è®¾ç½®é¢„åˆ†é…(é€šè¿‡fallocate) manifestæ–‡ä»¶çš„å­—èŠ‚æ•° # é»˜è®¤å€¼æ˜¯4mbï¼Œè¿™å¯¹äºå‡å°‘éšæœºIOä»¥åŠé˜²æ­¢é¢„åˆ†é…å¤§é‡æ•°æ®çš„æŒ‚è½½(ä¾‹å¦‚xfsçš„allocsizeé€‰é¡¹)è¿‡åº¦åˆ†é…æ˜¯åˆç†çš„ # default: 4mb manifest.preallocation.size: 1024 * 1024 * 4 # å½“memtableè¢«åˆ·æ–°åˆ°å­˜å‚¨ä¸­æ—¶[å¯ç”¨|ç¦ç”¨] æ¸…é™¤ [é‡å¤\\è¢«åˆ é™¤]çš„ é”® # default: true purge.redundant.kvs.while.flush: true # å¼€å¯/å…³é—­sstè¡¨çš„mmapè¯»åŠŸèƒ½ # default: false allow.mmap.reads: false # å¼€å¯/å…³é—­sstè¡¨çš„mmapå†™åŠŸèƒ½ # default: false allow.mmap.writes: false # å¯ç”¨/ç¦ç”¨è¯»æ“ä½œçš„ç›´æ¥I/Oæ¨¡å¼(O_DIRECT) # default: false use.direct.reads: false # å¯ç”¨/ç¦ç”¨åå°flushå’Œcompactionçš„ç›´æ¥I/Oæ¨¡å¼(O_DIRECT) # å½“ä¸ºtrueæ—¶ï¼Œnew_table_reader_for_compaction_inputsè¢«å¼ºåˆ¶ä¸ºtrueã€‚ # default: false use.direct.i.o.for.flush.and.compaction: false # [å¼€å¯|ç¦ç”¨] å­è¿›ç¨‹ç»§æ‰¿æ‰“å¼€çš„æ–‡ä»¶ # default: true is.fd.close.on.exec: true # [å¯ç”¨|ç¦ç”¨]åœ¨æ¢å¤æ—¶è·³è¿‡æ—¥å¿—æŸåé”™è¯¯(å¦‚æœå®¢æˆ·ç«¯å¯ä»¥ä¸¢å¤±æœ€è¿‘çš„æ›´æ”¹) # default: false skip.log.error.on.recovery: false # è®¾ç½®ç»Ÿè®¡è½¬å‚¨å‘¨æœŸï¼Œä»¥ç§’ä¸ºå•ä½ # default: 3600 (1 hour) stats.dump.period.sec: 3600 # å½“æ‰“å¼€sstæ–‡ä»¶æ—¶ï¼Œæ˜¯å¦ä¼šæç¤ºåº•å±‚æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶è®¿é—®æ¨¡å¼æ˜¯éšæœºçš„ # default: true advise.random.on.open: true # è®¾ç½®æ‰€æœ‰åˆ—æ—å†™å…¥ç£ç›˜ä¹‹å‰åœ¨memtablesä¸­å»ºç«‹çš„æ•°æ®é‡ã€‚ # è¿™ä¸write_buffer_sizeä¸åŒï¼Œåè€…å¼ºåˆ¶å¯¹å•ä¸ªmemtableè¿›è¡Œé™åˆ¶ # default: 0(ç¦ç”¨) db.write.buffer.size: 0 # å‹ç¼©å¯åŠ¨åçš„æ–‡ä»¶è®¿é—®æ¨¡å¼ # NoneCompactionAccessPattern = 0, NormalCompactionAccessPattern = 1 # SequentialCompactionAccessPattern = 2, WillneedCompactionAccessPattern = 3 # default: NormalCompactionAccessPattern access.hint.on.compaction.start: 1 # å¯ç”¨/ç¦ç”¨è‡ªé€‚åº”äº’æ–¥é”ï¼Œå®ƒåœ¨æ±‚åŠ©äºå†…æ ¸ä¹‹å‰åœ¨ç”¨æˆ·ç©ºé—´æ—‹è½¬ # å½“äº’æ–¥é”ä¸æ˜¯ä¸¥é‡ç«äº‰æ—¶ï¼Œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä½†æ˜¯ï¼Œå¦‚æœäº’æ–¥å¯¹è±¡æ˜¯çƒ­çš„ï¼Œæœ€ç»ˆå¯èƒ½ä¼šæµªè´¹æ—‹è½¬æ—¶é—´ # default: false use.adaptive.mutex: false # å…è®¸æ“ä½œç³»ç»Ÿåœ¨åå°å¼‚æ­¥å†™å…¥æ–‡ä»¶æ—¶å¢é‡åŒæ­¥æ–‡ä»¶åˆ°ç£ç›˜ # å¯¹æ¯å†™ä¸€ä¸ªbytes_per_syncå‘å‡ºä¸€ä¸ªè¯·æ±‚ã€‚ # default: 0(ç¦ç”¨) bytes.per.sync: 0 # è®¾ç½®å‹ç¼©æ ·å¼ # LevelCompactionStyle = 0 / UniversalCompactionStyle = 1 / FIFOCompactionStyle = 2 # default: LevelCompactionStyle compaction.style: 0 # æŒ‡å®šè¿­ä»£-&gt;Next()æ˜¯å¦æŒ‰é¡ºåºè·³è¿‡å…·æœ‰ç›¸åŒuser-keyçš„é”® # è¿™ä¸ªæ•°å­—æŒ‡å®šåœ¨é‡å¯»ä¹‹å‰å°†è¢«è¿ç»­è·³è¿‡çš„é”®æ•°(ä¸userkeyç›¸åŒ) # default: 8 max.sequential.skip.in.iterations: 8 #[å¯ç”¨|ç¦ç”¨]çº¿ç¨‹å®‰å…¨çš„å°±åœ°æ›´æ–° # default: false inplace.update.support: false # ç”¨äºå°±åœ°æ›´æ–°çš„é”çš„æ•°é‡ # default: 0, ï¼Œå¦‚æœ inplace_update_support = true ï¼Œåˆ™ä¸º 10000 inplace.update.num.locks: 0 # è®¾ç½®memtableä½¿ç”¨çš„arenaçš„å¤§é¡µå¤§å° # å¦‚æœ&lt;=0ï¼Œå®ƒä¸ä¼šä»å¤§é¡µåˆ†é…ï¼Œè€Œæ˜¯ä»mallocåˆ†é…ã€‚ç”¨æˆ·æœ‰è´£ä»»ä¸ºå®ƒé¢„ç•™å·¨å¤§çš„é¡µé¢ä»¥ä¾›åˆ†é…ã€‚ # ä¾‹å¦‚:sysctl -w vm.nr_hugepages=20 # å‚è§linux doc Documentation/vm/hugetlbpage.txt # å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—²å¤§é¡µï¼Œå®ƒä¼šé€€å›åˆ°malloc # é€šè¿‡SetOptions() APIåŠ¨æ€æ›´æ”¹ memtable.huge.page.size: 0 # è®¾ç½®å¸ƒéš†è¿‡æ»¤å™¨çš„æŒ‡é’ˆä½ç½® # æ§åˆ¶bloom filteræ¢é’ˆçš„ä½ç½®ï¼Œä»¥æé«˜ç¼“å­˜é—æ¼ç‡ã€‚ # è¯¥é€‰é¡¹ä»…é€‚ç”¨äºmemtableå‰ç¼€bloomå’Œplainå‰ç¼€bloomã€‚ # å®ƒæœ¬è´¨ä¸Šé™åˆ¶äº†æ¯ä¸ªbloom filteræ£€æŸ¥å¯ä»¥è§¦åŠçš„ç¼“å­˜çº¿çš„æœ€å¤§æ•°é‡ã€‚ # è®¾ç½®ä¸º0æ—¶ï¼Œæ­¤ä¼˜åŒ–è¢«å…³é—­ã€‚è¿™ä¸ªæ•°ç›®ä¸åº”è¯¥å¤§äºæ¢æµ‹çš„æ•°ç›®ã€‚ # è¿™ä¸ªé€‰é¡¹å¯ä»¥æé«˜å†…å­˜å·¥ä½œè´Ÿè½½çš„æ€§èƒ½ï¼Œä½†åº”è¯¥å°å¿ƒä½¿ç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šå¯¼è‡´æ›´é«˜çš„è¯¯æŠ¥ç‡ã€‚ # default: 0 bloom.locality: 0 # è®¾ç½®memtableä¸­ä¸€ä¸ªé”®çš„æœ€å¤§è¿ç»­åˆå¹¶æ“ä½œæ•° # default: 0 (ç¦ç”¨çŠ¶æ€) max.successive.merges: 0 # å¼€å¯ç»Ÿè®¡ # default: æ— å‚æ•°ï¼Œfalseä»£è¡¨ä¸å¯åŠ¨ï¼Œtrueåˆ™ä¼šè°ƒç”¨å¯¹åº”çš„api enable.statistics: false # é¢„åŠ è½½æ•°æ®åº“ä¸ºäº†æ‰¹é‡åŠ è½½ # æ‰€æœ‰æ•°æ®å°†åœ¨0çº§æ²¡æœ‰ä»»ä½•è‡ªåŠ¨å‹ç¼© # å»ºè®®åœ¨ä»æ•°æ®åº“è¯»å–æ•°æ®ä¹‹å‰æ‰‹åŠ¨è°ƒç”¨CompactRange(NULL, NULL)ï¼Œå¦åˆ™è¯»å–é€Ÿåº¦ä¼šéå¸¸æ…¢ # default: æ— å‚æ•°ï¼Œfalseä»£è¡¨ä¸å¯åŠ¨ï¼Œtrueåˆ™ä¼šè°ƒç”¨å¯¹åº”çš„api prepare.for.bulk.load: false # è®¾ç½®ä¸€ä¸ªMemTableRepï¼Œå®ƒç”±ä¸€ä¸ªå‘é‡æ”¯æŒ # åœ¨è¿­ä»£æ—¶ï¼Œå‘é‡è¢«æ’åºï¼Œè¿™å¯¹äºè¿­ä»£éå¸¸å°‘ä¸”è¯»æ“ä½œå¼€å§‹åé€šå¸¸ä¸æ‰§è¡Œå†™æ“ä½œçš„å·¥ä½œè´Ÿè½½éå¸¸æœ‰ç”¨ # default: æ— å‚æ•°ï¼Œfalseä»£è¡¨ä¸å¯åŠ¨ï¼Œtrueåˆ™ä¼šè°ƒç”¨å¯¹åº”çš„api memtable.vector.rep: false # å¦‚æœä¸å­˜åœ¨åˆ—æ—æ˜¯å¦è‡ªåŠ¨å»ºç«‹ # default: true create.if.missing.column.families: true SQL-ASTçš„æ”¯æŒæˆ‘ä»¬çš„dbå¸Œæœ›èƒ½åšåˆ°ä¸è¯­è¨€æ— å…³ï¼Œä¸ä»…ä»…æ˜¯æˆ‘ä»¬çš„ç›®å‰çš„golangï¼Œå°±ç®—æ˜¯phpä¹Ÿå¯ä»¥ç”¨åˆ°æœ¬åœ°æŒä¹…åŒ–çš„æ–¹å¼çš„è¯ï¼Œå°±éœ€è¦å€ŸåŠ©RPCåè®®æˆ–è€…ç‰¹å®šDSLæ¥å®ç°ï¼Œä½†æ˜¯æ—¢ç„¶æ˜¯æ•°æ®åº“ï¼Œè¿™é‡Œä¼˜å…ˆé€‰æ‹©äº†ä»¥sqlè¯­æ³•æ¥ç®¡ç†æ•°æ®ã€‚ é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ‹¿åˆ°sqlçš„æŠ½è±¡è¯­æ³•æ ‘(sql-ast)ï¼Œæ‹¿åˆ°sql-astä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„ä¿¡æ¯å»hit dataã€‚ Pingcap-parser è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°äº†pingcapå…¬å¸çš„parseråº“ï¼Œè¯¥åº“åŒæ ·æ˜¯TiDBçš„sqlè§£æåº“ï¼Œå€ŸåŠ©è¯¥åº“ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ‹¿åˆ°sql-ast 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071package mainimport ( \"fmt\" \"github.com/pingcap/parser\" _ \"github.com/pingcap/parser/test_driver\")type visitor struct &#123; table string fields []string&#125;func (v *visitor) Enter(in ast.Node) (out ast.Node, skipChildren bool) &#123; //fmt.Printf(\"Enter: %T\\n\", in) switch n := in.(type) &#123; case *ast.SelectStmt: case *ast.FieldList: case *ast.SelectField: case *ast.ColumnNameExpr: //fmt.Printf(\"Enter: %v\\n\", n.Name) case *ast.ColumnName: //v.fields = append(v.fields, n.Name.L) case *ast.TableName: //v.table = n.Name.L case *ast.BinaryOperationExpr: //fmt.Printf(\"Enter: %v\\n\", n.Op) case *ast.Join: //fmt.Printf(\"Enter: %v\\n\", n.Left) &#125; return in, false&#125;func (v *visitor) Leave(in ast.Node) (out ast.Node, ok bool) &#123; fmt.Printf(\"Leave: %T\\n\", in) switch n := in.(type) &#123; case *ast.SelectStmt: case *ast.FieldList: case *ast.SelectField: case *ast.ColumnNameExpr: case *ast.ColumnName: case *ast.TableName: v.table = n.Name.L case *ast.BinaryOperationExpr: //fmt.Printf(\"Leave: %v\\n\", n.L) &#125; return in, true&#125;func main() &#123; p := parser.New() sql := \"SELECT emp_no, first_name, last_name \" + \"FROM employees \" + \"where id='Aamodt' and (create_time &gt; 0 or last_name ='caiwenhui')\" stmtNodes, _, err := p.Parse(sql, \"\", \"\") if err != nil &#123; fmt.Printf(\"parse error:\\n%v\\n%s\", err, sql) return &#125; for _, stmtNode := range stmtNodes &#123; v := visitor&#123;&#125; stmtNode.Accept(&amp;v) fmt.Printf(\"%v\\n\", v) &#125;&#125; è¿™é‡Œç”¨åˆ°äº†github.com/pingcap/parser/test_driver çš„åŸå› æ˜¯å› ä¸ºè¯¥åº“å’Œtidbçš„driverå­˜åœ¨ä¾èµ–å…³ç³»ï¼Œtidbåœ¨è®¾è®¡çš„æ—¶å€™ï¼Œå¹¶æœªåšåˆ°å¾ˆå¥½çš„åˆ†ç¦»ï¼Œæ‰€ä»¥å½“å…¶ä»–é¡¹ç›®éœ€è¦ä½¿ç”¨è¯¥åº“çš„æ—¶å€™ï¼Œéœ€è¦å¼•å…¥è¿™ä¸ªé©±åŠ¨ã€‚ 12345678910111213// Visitor visits a Node.type Visitor interface &#123; // Enter is called before children nodes are visited. // The returned node must be the same type as the input node n. // skipChildren returns true means children nodes should be skipped, // this is useful when work is done in Enter and there is no need to visit children. Enter(n Node) (node Node, skipChildren bool) // Leave is called after children nodes have been visited. // The returned node's type can be different from the input node if it is a ExprNode, // Non-expression node must be the same type as the input node n. // ok returns false to stop visiting. Leave(n Node) (node Node, ok bool)&#125; å¹¶ä¸”è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ä¸€ä¸ªç»“æ„ä½“visitorï¼Œè¯¥ç»“æ„ä½“å°±æ˜¯ç”¨æ¥è®¿é—®astç”¨çš„ï¼Œå› ä¸º tidbçš„parseråº“ å’Œé˜¿é‡Œå·´å·´ çš„ druid sql ç±»ä¼¼ï¼Œéƒ½æ˜¯é‡‡ç”¨ è®¿é—®å™¨çš„æ–¹å¼æ¥éå† astçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å®šä¹‰å¥½æˆ‘ä»¬çš„è®¿é—®å™¨ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¿é—®å¯¹åº”çš„ç»“æ„æ•°æ®ã€‚è‡³äºè®¿é—®å™¨çš„æ¥å£å¦‚ä¸Šå›¾ï¼Œåªæœ‰2ä¸ªAPIï¼Œä¸€ä¸ªæ˜¯ Enter(n Node) (node Node, skipChildren bool)ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ Leave(n Node) (node Node, ok bool) ã€‚2ä¸ªæ¥å£è¿”å›çš„ç¬¬äºŒä¸ªå‚æ•°åˆ†åˆ«å®šä¹‰ä¸º æ˜¯å¦è·³è¿‡å‰©ä¸‹çš„èŠ‚ç‚¹, æ˜¯å¦æˆåŠŸé€€å‡ºèŠ‚ç‚¹ã€‚ interfaceåœ¨è¿™é‡Œçš„åº”ç”¨åœ¨parserä¸­ï¼Œå¤§é‡è¿ç”¨äº†interface, å……åˆ†çš„ç»™æˆ‘ä»¬çš„å±•ç¤ºäº†golangçš„ç»„åˆç‰¹æ€§ã€‚ ä¾‹å¦‚ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778// Node is the basic element of the AST.// Interfaces embed Node should have 'Node' name suffix.type Node interface &#123; // Restore returns the sql text from ast tree Restore(ctx *format.RestoreCtx) error // Accept accepts Visitor to visit itself. // The returned node should replace original node. // ok returns false to stop visiting. // // Implementation of this method should first call visitor.Enter, // assign the returned node to its method receiver, if skipChildren returns true, // children should be skipped. Otherwise, call its children in particular order that // later elements depends on former elements. Finally, return visitor.Leave. Accept(v Visitor) (node Node, ok bool) // Text returns the original text of the element. Text() string // SetText sets original text to the Node. SetText(text string)&#125;// SelectStmt represents the select query node.// See https://dev.mysql.com/doc/refman/5.7/en/select.htmltype SelectStmt struct &#123; dmlNode resultSetNode // SelectStmtOpts wraps around select hints and switches. *SelectStmtOpts // Distinct represents whether the select has distinct option. Distinct bool // From is the from clause of the query. From *TableRefsClause // Where is the where clause in select statement. Where ExprNode // Fields is the select expression list. Fields *FieldList // GroupBy is the group by expression list. GroupBy *GroupByClause // Having is the having condition. Having *HavingClause // WindowSpecs is the window specification list. WindowSpecs []WindowSpec // OrderBy is the ordering expression list. OrderBy *OrderByClause // Limit is the limit clause. Limit *Limit // LockTp is the lock type LockTp SelectLockType // TableHints represents the table level Optimizer Hint for join type TableHints []*TableOptimizerHint // IsAfterUnionDistinct indicates whether it's a stmt after \"union distinct\". IsAfterUnionDistinct bool // IsInBraces indicates whether it's a stmt in brace. IsInBraces bool // QueryBlockOffset indicates the order of this SelectStmt if counted from left to right in the sql text. QueryBlockOffset int // SelectIntoOpt is the select-into option. SelectIntoOpt *SelectIntoOption&#125;func splitWhere(where ast.ExprNode) []ast.ExprNode &#123; var conditions []ast.ExprNode switch x := where.(type) &#123; case nil: case *ast.BinaryOperationExpr: if x.Op == opcode.LogicAnd &#123; conditions = append(conditions, splitWhere(x.L)...) conditions = append(conditions, splitWhere(x.R)...) &#125; else &#123; conditions = append(conditions, x) &#125; case *ast.ParenthesesExpr: conditions = append(conditions, splitWhere(x.Expr)...) default: conditions = append(conditions, where) &#125; return conditions&#125; ast.Node æ˜¯astçš„åŸºç¡€æ¥å£ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½éœ€è¦åœ¨æ­¤ä¹‹ä¸Šå®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚å…¶ä»–æ¥å£åŒç†ï¼Œä¸€ç¯æ‰£ä¸€ç¯ï¼Œè®¾è®¡å¾—ååˆ†å·§å¦™ã€‚ KEY-VALUEçš„ç¼–ç è§„åˆ™DB å¯¹æ¯ä¸ªè¡¨åˆ†é…ä¸€ä¸ª TableIDï¼Œæ¯ä¸€ä¸ªç´¢å¼•éƒ½ä¼šåˆ†é…ä¸€ä¸ª IndexIDï¼Œæ¯ä¸€è¡Œåˆ†é…ä¸€ä¸ª RowIDï¼Œ å…¶ä¸­ DbId/TableID åœ¨æ•´ä¸ªé›†ç¾¤å†…å”¯ä¸€ï¼ŒIndexID/RowID åœ¨è¡¨å†…å”¯ä¸€ï¼Œè¿™äº› ID éƒ½æ˜¯ int64 ç±»å‹ã€‚ å…¶ä¸­ç»†èŠ‚å¦‚ä¸‹ï¼š database ç¼–ç æˆ Key-Value pairï¼š 12Key: metaPrefix(+)databasePrefix&#123;dbID&#125;Value: database struct json marshal database indexed ç¼–ç æˆ Key-Value pairï¼š 12Key: metaPrefix(+)databasePrefix_indexPrefix&#123;database_name&#125;Value: dbID table ç¼–ç æˆ Key-Value pairï¼š 12Key: metaPrefix(+)tablePrefix&#123;dbID&#125;_recordPrefixSep&#123;tableID&#125;Value: table struct json marshal table indexed ç¼–ç æˆ Key-Value pairï¼š 12Key: metaPrefix(+)tablePrefix&#123;dbID&#125;_indexPrefix&#123;databaseId&#125;&#123;table_name&#125;Value: tableID æ¯è¡Œæ•°æ®æŒ‰ç…§å¦‚ä¸‹è§„åˆ™è¿›è¡Œç¼–ç æˆ Key-Value pairï¼š 12Key: databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_recordPrefixSep&#123;rowID&#125;Value: [col1, col2, col3, col4] å¯¹äº Unique Index æ•°æ®ï¼Œä¼šæŒ‰ç…§å¦‚ä¸‹è§„åˆ™ç¼–ç æˆ Key-Value pairï¼š 12Key: databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_indexPrefixSep&#123;indexID&#125;_indexedColumnsValueValue: rowID Index æ•°æ®è¿˜éœ€è¦è€ƒè™‘ Unique Index å’Œé Unique Index ä¸¤ç§æƒ…å†µï¼Œå¯¹äº Unique Indexï¼Œå¯ä»¥æŒ‰ç…§ä¸Šè¿°ç¼–ç è§„åˆ™ã€‚ ä½†æ˜¯å¯¹äºé Unique Indexï¼Œé€šè¿‡è¿™ç§ç¼–ç å¹¶ä¸èƒ½æ„é€ å‡ºå”¯ä¸€çš„ Keyï¼Œå› ä¸ºåŒä¸€ä¸ªIndex çš„ databasePrefix{dbID}_tablePrefix{tableID}_indexPrefixSep{indexID}éƒ½ä¸€æ ·ï¼Œå¯èƒ½æœ‰å¤šè¡Œæ•°æ®çš„ ColumnsValue æ˜¯ä¸€æ ·çš„. å¯¹äº â€œéâ€ Unique Index çš„ç¼–ç åšäº†ä¸€ç‚¹è°ƒæ•´ï¼š 12Key: databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_indexPrefixSep&#123;indexID&#125;_indexedColumnsValue_&#123;rowID&#125;Value: null å¯¹åº”çš„æ ‡è¯†ç¬¦å¦‚ä¸‹å®šä¹‰ï¼š 123456789101112131415161718192021222324252627282930313233var ( databasePrefix = []byte&#123;'d'&#125; tablePrefix = []byte&#123;'t'&#125; recordPrefixSep = []byte(\"_r\") indexPrefixSep = []byte(\"_i\") metaPrefix = []byte&#123;'m'&#125; sepPrefix = []byte&#123;'_'&#125; mdPrefix = append(metaPrefix, databasePrefix...) mdiPrefix = append(append(metaPrefix, databasePrefix...), indexPrefixSep...) mtPrefix = append(metaPrefix, tablePrefix...) mtiPrefix = append(append(metaPrefix, tablePrefix...), indexPrefixSep...))const ( idLen = 8 sepPrefixLen = 1 prefixLen = databasePrefixLength + idLen /*dbID*/ + sepPrefixLen + tablePrefixLength + idLen /*tableID*/ + recordPrefixSepLength uniqPrefixLen = databasePrefixLength + idLen /*dbID*/ + sepPrefixLen + tablePrefixLength + idLen /*tableID*/ + indexPrefixSepLength + idLen /*indexID*/ + sepPrefixLen /* +indexedColumnsValue */ indexPrefixLen = databasePrefixLength + idLen /*dbID*/ + sepPrefixLen + tablePrefixLength + idLen /*tableID*/ + indexPrefixSepLength + idLen /*indexID*/ + sepPrefixLen + sepPrefixLen indexPrefixLenWithID = databasePrefixLength + idLen /*dbID*/ + sepPrefixLen + tablePrefixLength + idLen /*tableID*/ + indexPrefixSepLength + idLen /*indexID*/ + sepPrefixLen + sepPrefixLen + idLen // RecordRowKeyLen is public for calculating avgerage row size. RecordRowKeyLen = prefixLen + idLen /*handle*/ tablePrefixLength = 1 databasePrefixLength = 1 recordPrefixSepLength = 2 indexPrefixSepLength = 2 metaPrefixLength = 1 mdPrefixLen = metaPrefixLength + databasePrefixLength mdiPrefixLen = mdPrefixLen + indexPrefixSepLength mtPrefixLen = metaPrefixLength + tablePrefixLength mtiPrefixLen = mtPrefixLen + indexPrefixSepLength) æˆ‘ä»¬æŠŠrowkeyçš„ç¼–ç è§„åˆ™æ¥çœ‹ 12345678910111213141516171819202122232425// EncodeRowKey encodes the table id and record handle into a kv.Key// EncodeRowKey databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_recordPrefixSep&#123;rowID&#125;func EncodeRowKey(databaseId, tableID, rowId int64) kv.Key &#123; buf := make([]byte, 0, prefixLen+idLen /*rowId*/) buf = append(buf, databasePrefix...) buf = append(buf, EncodeIdBuf(databaseId)...) buf = append(buf, sepPrefix...) buf = append(buf, tablePrefix...) buf = append(buf, EncodeIdBuf(tableID)...) buf = append(buf, recordPrefixSep...) buf = append(buf, EncodeIdBuf(rowId)...) return buf&#125;func EncodeIdBuf(id int64) kv.Key &#123; var buf = make([]byte, 8) binary.BigEndian.PutUint64(buf[:], uint64(id)) return buf&#125;func DecodeIdBuf(b []byte) int64 &#123; return int64(binary.BigEndian.Uint64(b))&#125; è¿™é‡Œæˆ‘ä»¬é€šè¿‡EncodeRowKey(databaseId, tableID, rowId int64) kv.Key æ¥ç”Ÿæˆæ•°æ®çš„row-keyï¼Œæˆ‘ä»¬åˆ©ç”¨make([]byte,0, len) çš„æ–¹å¼é¢„ç”³è¯·å†…å­˜çš„æ–¹å¼ï¼Œåé¢å†é€šè¿‡appendçš„æ–¹å¼å¾€ slice ä¸­ä¸æ–­è¿½åŠ å­—èŠ‚ï¼Œå½“é‡åˆ°int64çš„æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨EncodeIdBuf(id int64) kv.Key æ¥æŠŠint64è½¬æ¢ä¸º å¤§ç«¯(ç½‘ç»œå­—èŠ‚åº) çš„äºŒè¿›åˆ¶å­—èŠ‚ã€‚æœ€åä¸€ä¸ªrow-keyå°±ç”Ÿæˆäº†ã€‚ database ç¼–ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465type database struct &#123; Id int64 Name string&#125;// createDatabaseHandle Create databasefunc (s *Store) createDatabaseHandle(result *Result, stmt *ast.CreateDatabaseStmt) &#123; indexedKey := etccodec.EncodeDatabaseMetaIndexedKey([]byte(stmt.Name)) rdb := rocksdb.Load().(*Rocksdb) slice, err := rdb.Get(rdb.NewDefaultReadOptions(), indexedKey) if err != nil &#123; errorlog(UnexpectErrorCategory&#123;&#125;, UnknowRCode) result.Record(UnknowRCode, nil) return &#125; if slice.Exists() &#123; if !stmt.IfNotExists &#123; errorlog(UnexpectErrorCategory&#123;&#125;, DatabaseExistsRCode) result.Record(DatabaseExistsRCode, nil) &#125; else &#123; result.Success() &#125; return &#125; dbId, err := getDatabaseId() if err != nil &#123; msg := fmt.Sprintf(\"get database id failed, err: %s\", err) errorlog(UnexpectErrorCategory&#123;&#125;, msg) result.Record(CreateDatabaseFailedRCode, &amp;msg) return &#125; db := &amp;database&#123; Id: dbId, Name: stmt.Name, &#125; var buf = etccodec.EncodeIdBuf(dbId) key := etccodec.EncodeDatabaseMetaKey(dbId) value, err := json.Marshal(db) if err != nil &#123; msg := fmt.Sprintf(\"marshal database error, err: %s\", err) errorlog(UnexpectErrorCategory&#123;&#125;, msg) result.Record(CreateDatabaseFailedRCode, &amp;msg) return &#125; err = rdb.Put(key, value) if err != nil &#123; msg := fmt.Sprintf(\"rocksdb put metadata failed, err: %s\", err) errorlog(UnexpectErrorCategory&#123;&#125;, msg) result.Record(CreateDatabaseFailedRCode, &amp;msg) return &#125; err = rdb.Put(indexedKey, buf) if err != nil &#123; msg := fmt.Sprintf(\"rocksdb put indexed failed, err: %s\", err) errorlog(UnexpectErrorCategory&#123;&#125;, msg) result.Record(CreateDatabaseFailedRCode, &amp;msg) return &#125; debugf(NormalDebugCategory&#123;&#125;, \"create database [%s]\", db) result.Success()&#125; è¿™é‡Œï¼Œæˆ‘ä»¬å€ŸåŠ© create database stmt æ¥çš„å¤„ç†æ–¹æ³•æ¥çœ‹çœ‹ db Key-Value pair çš„å¤„ç†é€»è¾‘ã€‚æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªstmt.Name æ¥æ‹¿åˆ°æ•°æ®åº“çš„åï¼Œå¹¶ä¸”è°ƒç”¨etccodec.EncodeDatabaseMetaIndexedKey([]byte(stmt.Name)) æ–¹æ³•æ¥åˆ›å»ºç¬¦åˆmetaPrefix(+)databasePrefix_indexPrefix{database_name} ç´¢å¼•çš„keyï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å­˜åœ¨æ‰€ä»¥ç´¢å¼•æ¥åˆ¤æ–­åç»­çš„é€»è¾‘ã€‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª getDatabaseId() æ–¹æ³•æ¥è·å–ä¸€ä¸ªå…¨å±€çš„æ•°æ®åº“idï¼Œå¹¶ä¸”åˆå§‹åŒ–type database structï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº† etccodec.EncodeDatabaseMetaKey(dbid) æ¥å¯¹keyè¿›è¡Œç”Ÿæˆï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€åˆ—å‡ºæ¥çš„ metaPrefix(+)databasePrefix{dbID}, æ¥ä¸‹æ¥å°±æ˜¯valueçš„ç”Ÿæˆï¼Œè¿™é‡Œçš„valueæ¯”è¾ƒç›´æ¥ï¼Œå°±æ˜¯json.marshalæ¥å¤„ç†åçš„å­—èŠ‚ã€‚ç„¶åæˆ‘ä»¬æŠŠæ•°æ®put åˆ°rocksdbå°±ç»“æŸäº†ï¼Œç´¢å¼•æ•°æ®ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸è¿‡ç´¢å¼•å­˜å‚¨çš„dbidã€‚ tableçš„ç¼–ç ä¹Ÿç±»ä¼¼ å¦‚æœå¯¹å…¶ä»–çš„stmtï¼Œä¾‹å¦‚insert stmt/delete stmtå…·ä½“çš„é€»è¾‘æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥æŸ¥é˜…æºç ï¼Œä½†æ˜¯ç±»ä¼¼å·®ä¸å¤šã€‚ COUNTERè®¡æ•°å™¨-å‘å·å™¨è¿™é‡Œæˆ‘ä»¬éœ€è¦è®²ä¸€ä¸‹counterï¼Œå› ä¸ºæˆ‘ä»¬æ‰€æœ‰çš„æ•°æ®éƒ½ä¼šæœ‰row_idï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨create tableçš„æ—¶å€™ä¹Ÿæœ‰AUTO_INCREMENTçš„åˆ—ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ªIDå‘å·å™¨ã€‚ ç›®å‰å¸¸è§çš„å‘å·å™¨å®ç°æ–¹æ¡ˆå¦‚ä¸‹ï¼š UUID snowflake æ•°æ®åº“ç”Ÿæˆ ç¾å›¢çš„Leafï¼ˆåŸºäºæ•°æ®åº“ï¼‰ UUIDUUID(Universally Unique Identifier)çš„æ ‡å‡†å‹å¼åŒ…å«32ä¸ª16è¿›åˆ¶æ•°å­—ï¼Œä»¥è¿å­—å·åˆ†ä¸ºäº”æ®µï¼Œå½¢å¼ä¸º8-4-4-4-12çš„36ä¸ªå­—ç¬¦ï¼Œç¤ºä¾‹ï¼š550e8400-e29b-41d4-a716-446655440000ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ä¸šç•Œä¸€å…±æœ‰5ç§æ–¹å¼ç”ŸæˆUUIDï¼Œè¯¦æƒ…è§IETFå‘å¸ƒçš„UUIDè§„èŒƒ A Universally Unique IDentifier (UUID) URN Namespace ç”±äºä»–çš„æ— åºæ€§ï¼Œä¸ç¬¦åˆæˆ‘ä»¬æ‰€æœŸå¾…çš„å¢é•¿åºåˆ—ï¼Œæ‰€ä»¥æŠ›å¼ƒ ç±»snowflakeæ–¹æ¡ˆè¿™ç§æ–¹æ¡ˆå¤§è‡´æ¥è¯´æ˜¯ä¸€ç§ä»¥åˆ’åˆ†å‘½åç©ºé—´ï¼ˆUUIDä¹Ÿç®—ï¼Œç”±äºæ¯”è¾ƒå¸¸è§ï¼Œæ‰€ä»¥å•ç‹¬åˆ†æï¼‰æ¥ç”ŸæˆIDçš„ä¸€ç§ç®—æ³•ï¼Œè¿™ç§æ–¹æ¡ˆæŠŠ64-bitåˆ†åˆ«åˆ’åˆ†æˆå¤šæ®µï¼Œåˆ†å¼€æ¥æ ‡ç¤ºæœºå™¨ã€æ—¶é—´ç­‰ï¼Œæ¯”å¦‚åœ¨snowflakeä¸­çš„64-bitåˆ†åˆ«è¡¨ç¤ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ç”Ÿæˆç¹çï¼Œç”±å¤šä¸ªæŒ‡ä»¤ç ç»„æˆï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸éœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼ï¼Œè¿™ä¸ªè¿˜å¯¹æœ¬åœ°çš„æ—¶é—´æœ‰å¼ºä¾èµ–ï¼Œä¸å¤Ÿç®€æ´ åŸºäºæ•°æ®åº“çš„åŸºäºæ•°æ®åº“çš„å…¶å®å°±æ˜¯åˆ©ç”¨è‡ªå¢çš„è‡ªå¢æœºåˆ¶+å‘å·æœºåˆ¶çš„ç»„åˆï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬è¿™é‡Œä¸åŸºäºæ•°æ®åº“ï¼Œæ‰€ä»¥ç»™äºˆæ•°æ®åº“çš„åŸºæœ¬ä¹Ÿä¸è€ƒè™‘ï¼Œä½†æ˜¯å…¶ä¸­çš„å‘å·æœºåˆ¶å¯ä»¥å‚è€ƒã€‚ä¾‹å¦‚ï¼šé¢„åˆ†é…æœºåˆ¶ã€‚ è‡ªå·±çš„å‘å·å™¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168package msourceimport ( \"fmt\" \"gitlab.mingchao.com/basedev-deps/gorocksdb\" \"os\" \"os/signal\" \"reflect\" \"strconv\" \"syscall\" \"time\")type counter struct &#123; *gorocksdb.ReadOptions IdKey []byte GroupId string idChan chan int64 sig chan os.Signal&#125;func (c *counter) UnmarshalJSON(data []byte) (err error) &#123; c.IdKey = data[1 : len(data)-1] turboNew(c) return&#125;func (c *counter) MarshalJSON() ([]byte, error) &#123; b := make([]byte, 0, len(c.IdKey)+2) b = append(b, '\"') b = append(b, c.IdKey...) b = append(b, '\"') return b, nil&#125;func (c *counter) String() string &#123; t := reflect.TypeOf(c).Elem() v := reflect.ValueOf(c).Elem() p := fmt.Sprintf(\"%s &#123;\", t.Name()) for i := 0; i &lt; v.NumField(); i++ &#123; if v.Field(i).CanInterface() &#123; if v.Field(i).Kind() == reflect.Slice &#123; p += fmt.Sprintf(\"\\n\\t %s(%s): %s\", t.Field(i).Name, t.Field(i).Type, string(v.Field(i).Bytes())) &#125; else &#123; p += fmt.Sprintf(\"\\n\\t %s(%s): %v\", t.Field(i).Name, t.Field(i).Type, v.Field(i).Interface()) &#125; &#125; &#125; p += \"\\n&#125;\" return p&#125;func NewCounter(prefix string) *counter &#123; return newCounter(prefix)&#125;func newCounter(prefix string, args ...interface&#123;&#125;) *counter &#123; c := new(counter) if len(args) &gt; 0 &#123; c.GroupId = args[0].(string) &#125; c.IdKey = []byte(fmt.Sprintf(\"%s:%s\", prefix, c.GroupId)) turboNew(c) return c&#125;func turboNew(c *counter) &#123; ct := custom.Load().(*Custom) c.idChan = make(chan int64, ct.IdStep) c.sig = make(chan os.Signal, 1) c.ReadOptions = gorocksdb.NewDefaultReadOptions() signal.Notify(c.sig, syscall.SIGINT, syscall.SIGTERM) c.sender()&#125;func (c *counter) sender() &#123; go func() &#123; ct := custom.Load().(*Custom) for &#123; select &#123; case &lt;-c.sig: close(c.idChan) return default: if len(c.idChan) &lt; ct.IdStep/10 &#123; rdb := rocksdb.Load().(*Rocksdb) if c.ReadOptions == nil &#123; c.ReadOptions = gorocksdb.NewDefaultReadOptions() &#125; slice, err := rdb.Get(c.ReadOptions, c.getIdKey()) if err != nil &#123; fatal(UnexpectErrorCategory&#123;\"counter sender error\"&#125;, err) &#125; else &#123; var idStr string if slice.Exists() &amp;&amp; slice.Size() &gt; 0 &#123; idStr = string(slice.Data()) &#125; else &#123; idStr = \"0\" &#125; cid, err := strconv.ParseInt(idStr, 10, 64) if err != nil &#123; fatal(UnexpectErrorCategory&#123;\"counter sender error\"&#125;, err) &#125; else &#123; ct := custom.Load().(*Custom) // idå›æ»š if ((1&lt;&lt;63-1)/2)-ct.IdStep &lt; ct.IdStep &#123; cid = 0 &#125; nextId := cid + int64(ct.IdStep) err = c.ackId(nextId) if err != nil &#123; fatal(UnexpectErrorCategory&#123;\"counter sender error\"&#125;, err) &#125; for cid &lt; nextId &#123; cid++ c.idChan &lt;- cid &#125; &#125; &#125; &#125; else &#123; time.Sleep(50 * time.Millisecond) &#125; &#125; &#125; &#125;()&#125;// Rocksdb to get a globally unique self increment IDfunc (c *counter) getId() (int64, error) &#123; id := &lt;-c.idChan return id, nil //return -1, GetIdError&#123;bytes2string(c.IdKey)&#125;&#125;func (c *counter) GetId() (int64, error) &#123; return c.getId()&#125;func (c *counter) ackId(id int64) error &#123; rdb := rocksdb.Load().(*Rocksdb) err := rdb.Put(c.getIdKey(), []byte(strconv.FormatInt(id, 10))) if err != nil &#123; return err &#125; return nil&#125;func (c *counter) AckId(id int64) error &#123; return c.ackId(id)&#125;// Gets the key of the IDfunc (c *counter) getIdKey() []byte &#123; return c.IdKey&#125; è¿™é‡Œæˆ‘ä»¬ä¼˜å…ˆè€ƒè™‘å¯ä»¥é€šè¿‡å†…å­˜ç›´æ¥é€šè¿‡++æˆ–è€…+1æ“ä½œç¬¦åˆ†é…çš„æ–¹å¼ã€‚æˆ‘ä»¬é‡ç‚¹çœ‹åˆ°ï¼š 123456nextId := cid + int64(ct.IdStep)err = c.ackId(nextId)for cid &lt; nextId &#123; cid++ c.idChan &lt;- cid&#125; å¯ä»¥å†è¿™é‡Œçœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡æ‹¿åˆ°å½“å‰cidçš„æ•°å€¼ï¼Œé€šè¿‡idStepæ¥å¢åŠ å›ºå®šçš„æ­¥é•¿ï¼Œç„¶åå…ˆé€šè¿‡å›å†™nextIdçš„å€¼åˆ°rocksdbè¿›è¡ŒæŒä¹…åŒ–ï¼Œå†é€šè¿‡forå¾ªç¯æ¥å¯¹cidè¿›è¡Œå åŠ ï¼Œæ¯æ¬¡éƒ½æ¨é€åˆ°æœ‰ç¼“å†²åŒºçš„idChanä¸­ã€‚ 123456789// Rocksdb to get a globally unique self increment IDfunc (c *counter) getId() (int64, error) &#123; id := &lt;-c.idChan return id, nil&#125;func (c *counter) GetId() (int64, error) &#123; return c.getId()&#125; é€šè¿‡ func (c *counter) getId() (int64, error) æ¥æ¶ˆè´¹idChanä¸­çš„idï¼Œè¾¾åˆ°ä¸€ä¸ªè·å–idçš„æ•ˆæœã€‚ 1234// idå›æ»šif ((1&lt;&lt;63-1)/2)-ct.IdStep &lt; ct.IdStep &#123; cid = 0&#125; æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œæœ‰ä¸€è¡Œä»£ç ï¼Œå½“int64çš„cidå·²ç»åˆ°è¾¾åˆ†é…çš„æé™äº†ï¼Œé‚£ä¹ˆcidå°±ä¼šè¿›è¡Œå›æ»šï¼ŒåŸºæœ¬ä¿è¯äº†å‘å·çš„å¯é‡å¤åˆ©ç”¨æ€§ã€‚ æ‰©å±•é—®é¢˜ï¼šidå›æº¯äº†ï¼Œæ€ä¹ˆåšé€’å¢åˆ¤æ–­ï¼Ÿ è¿™ä¸ªé—®é¢˜å…¶å®æœ‰ç‚¹ç±»ä¼¼tcpçš„synå›æº¯çš„é—®é¢˜ã€‚å› ä¸ºsynä¸€å¼€å§‹æ˜¯éšæœºç”Ÿæˆçš„ï¼Œå¹¶ä¸”è¿™ä¸ªè¿‡ç¨‹äº†synæ˜¯ä¼šä¸æ–­å¢åŠ çš„ã€‚å½“synåˆ°è¾¾åˆ†é…çš„æé™è¿›è¡Œäº†å›æº¯çš„æ—¶å€™ï¼Œå¦‚ä½•æ¯”è¾ƒå¤§å°ï¼Ÿ æˆ‘ä»¬æŸ¥çœ‹åˆ°å†…æ ¸çš„tcpæºç ï¼Œå¯ä»¥çœ‹åˆ°æä¾›çš„åˆ¤æ–­æ–¹å¼ååˆ†å·§å¦™ï¼Œå¦‚ä¸‹ï¼š 123456789/** The next routines deal with comparing 32 bit unsigned ints* and worry about wraparound (automatic with unsigned arithmetic).*/static inline int before(__u32 seq1, __u32 seq2)&#123;return (__s32)(seq1-seq2) &lt; 0;&#125;#define after(seq2, seq1) before(seq1, seq2) ä¸ºä»€ä¹ˆï¼ˆ__s32ï¼‰(seq1-seq2)&lt;0å°±å¯ä»¥åˆ¤æ–­seq1&lt;seq2å‘¢ï¼Ÿè¿™é‡Œçš„__s32æ˜¯æœ‰ç¬¦å·æ•´å‹çš„æ„æ€ï¼Œè€Œ__u32åˆ™æ˜¯æ— ç¬¦å·æ•´å‹ã€‚ä¸ºäº†æ–¹ä¾¿è¯´æ˜ï¼Œæˆ‘ä»¬ä»¥unsigned charå’Œcharä¸ºä¾‹æ¥è¯´æ˜ï¼š å‡è®¾seq1=255ï¼Œ seq2=1ï¼ˆå‘ç”Ÿäº†å›ç»•ï¼‰seq1 = 1111 1111 seq2 = 0000 0001æˆ‘ä»¬å¸Œæœ›æ¯”è¾ƒç»“æœæ˜¯ seq1&lt;seq2 12345 seq1 - seq2&#x3D; 1111 1111-0000 0001----------- 1111 1110 ç”±äºæˆ‘ä»¬å°†ç»“æœè½¬åŒ–æˆäº†æœ‰ç¬¦å·æ•°ï¼Œç”±äºæœ€é«˜ä½æ˜¯1ï¼Œå› æ­¤ç»“æœæ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œè´Ÿæ•°çš„ç»å¯¹å€¼ä¸º 0000 0001 + 1 = 0000 0010 = 2 (è¡¥ç ï¼šå–å+1) å› æ­¤ seq1 - seq2 &lt; 0 æ³¨æ„ï¼š å¦‚æœseq2=128çš„è¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼š 12345 seq1 - seq2&#x3D; 1111 1111-1000 0000----------- 0111 1111 æ­¤æ—¶ç»“æœå°¤ä¸ºæ­£äº†ï¼Œåˆ¤æ–­çš„ç»“æœæ˜¯seq1&gt;seq2ã€‚å› æ­¤ï¼Œä¸Šè¿°ç®—æ³•æ­£ç¡®çš„å‰ææ˜¯ï¼Œå›ç»•åçš„å¢é‡å°äº2^(n-1)-1ã€‚ ç”±äºtcpåºåˆ—å·ç”¨çš„32ä½æ— ç¬¦å·æ•°ï¼Œå› æ­¤å¯ä»¥æ”¯æŒçš„å›ç»•å¹…åº¦æ˜¯2^31-1ï¼Œæ»¡è¶³è¦æ±‚äº†ã€‚ ä½†æ˜¯ç”±äºæˆ‘ä»¬è¿™é‡Œä¸éœ€è¦æ¯”è¾ƒå‘å·çš„å…ˆåæ¬¡åºï¼Œåªéœ€è¦ä¿è¯å…¶å”¯ä¸€æ€§ï¼Œæ‰€ä»¥è¿™ä¸ªå›æº¯çš„å¤§å°æ¯”è¾ƒé—®é¢˜ï¼Œå¹¶ä¸éœ€è¦è¿‡å¤šçš„å…³æ³¨ è¡Œçº§é”çš„å®ç°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495var ( // dbID:tblID // dbID:tblID:rowID rowLockLock sync.RWMutex rowLock rl ttlTime = int64(30 * 60))type ( rl map[string]*lock lock struct &#123; ttl int64 lock sync.RWMutex &#125;&#125;func init() &#123; // clean row lock, release memory go func() &#123; t := time.NewTicker(10 * time.Minute) for &#123; select &#123; case &lt;-t.C: ct := time.Now().Unix() rowLockLock.Lock() for key, lock := range rowLock &#123; if ct &gt; lock.ttl &#123; delete(rowLock, key) &#125; &#125; rowLockLock.Unlock() &#125; &#125; &#125;() rowLock = make(rl, 10)&#125;func rowLockKey(dbId, tblId, rowId int64) string &#123; return fmt.Sprintf(\"%d:%d:%d\", dbId, tblId, rowId)&#125;func (r *rl) Lock(lockKey string) &#123; rowLockLock.Lock() m, ok := (*r)[lockKey] if !ok &#123; m = new(lock) (*r)[lockKey] = m m.ttl = time.Now().Unix() + ttlTime &#125; rowLockLock.Unlock() m.lock.Lock()&#125;func (r *rl) UnLock(lockKey string) &#123; rowLockLock.Lock() m, ok := (*r)[lockKey] if !ok &#123; m = new(lock) (*r)[lockKey] = m m.ttl = time.Now().Unix() + ttlTime &#125; rowLockLock.Unlock() m.lock.Unlock()&#125;func (r *rl) RLock(lockKey string) &#123; rowLockLock.Lock() m, ok := (*r)[lockKey] if !ok &#123; m = new(lock) (*r)[lockKey] = m m.ttl = time.Now().Unix() + ttlTime &#125; rowLockLock.Unlock() m.lock.RLock()&#125;func (r *rl) RUnlock(lockKey string) &#123; rowLockLock.Lock() m, ok := (*r)[lockKey] if !ok &#123; m = new(lock) (*r)[lockKey] = m m.ttl = time.Now().Unix() + ttlTime &#125; rowLockLock.Unlock() m.lock.RUnlock()&#125; ä»¥ä¸Šæ˜¯è¡Œçº§é”çš„å®ç°æ–¹å¼ï¼Œä¸»è¦æ˜¯åˆ©ç”¨sync.RWMutexæ¥å®ç°è¯»å†™é”ï¼Œå¹¶ä¸”å¸¦æœ‰ttlçš„æœºåˆ¶ï¼Œæ¯æ¬¡åŠ é”çš„æ—¶å€™ï¼Œéƒ½ä¼šæ›´æ–°ttlçš„æ—¶é—´ã€‚å…¶ä¸­åœ¨inité˜¶æ®µï¼Œæˆ‘ä»¬åˆ©ç”¨çš„tickeræ¥å®ç°å¯¹é”è¿›è¡Œä¸€ä¸ªç±»ä¼¼LRUçš„æœºåˆ¶ï¼Œå¯¹äºä¸æ´»è·ƒçš„é”å¯¹è±¡è¿›è¡Œé‡Šæ”¾ï¼Œé˜²æ­¢åœ¨è¿™é‡Œé€ æˆå†…å­˜åªå¢ä¸å‡ã€‚ 1234567891011121314151617func (s *Store) updateHandle(result *Result, stmt *ast.UpdateStmt) &#123; // é€šè¿‡astè·å–oldæ•°æ® .... // è¡Œçº§é”é”å®š rowID, _ := item[0].(json2.Number).Int64() rowlockKey := rowLockKey(db.Id, tbl.Id, rowID) rowLock.Lock(rowlockKey) defer rowLock.UnLock(rowlockKey) // æ›´æ–°ç´¢å¼•æ•°æ® for _, index := range indexs &#123; ... &#125; // æ›´æ–°ä¸ºnewæ•°æ® ...&#125; é€†æ³¢å…°è¡¨è¾¾å¼ &amp;&amp; æ³¢å…°è¡¨è¾¾å¼è¿™ä¸€å—å…¶å®æš‚æ—¶è¿˜æ²¡å®ç°ï¼Œä½†æ˜¯ä»–çš„åŸç†æœ‰å¿…è¦å’Œå¤§å®¶è¯´ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„dbå®ç°ï¼Œéƒ½æ˜¯åŸºäºsql æ¥å®ç°çš„ï¼Œæˆ‘ä»¬çŸ¥é“ sql ä¸­ä¹Ÿæœ‰è¡¨è¾¾å¼è®¡ç®—ï¼Œå¹¶ä¸”æ˜¯æœ‰ä¼˜å…ˆçº§ä¹‹åˆ†çš„ã€‚ å‰/ä¸­/ååºéå†ï¼Œç›¸ä¿¡å¤§å®¶åŸºæœ¬éƒ½å¬è¯´è¿‡ï¼Œä½†æ˜¯å®é™…è¿ç”¨ä¸­å°‘ä¹‹åˆå°‘ï¼Œè¿™æ˜¯å› ä¸ºå¤§å®¶å¯èƒ½åœ¨å®é™…ä¸­æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ¨¡å¼å’Œå¥—ç”¨è¿™äº›æ ‘çš„éå†æ–¹å¼ã€‚ å‰åºéå†ï¼šæ ¹ç»“ç‚¹ â€”&gt; å·¦å­æ ‘ â€”&gt; å³å­æ ‘ ä¸­åºéå†ï¼šå·¦å­æ ‘â€”&gt; æ ¹ç»“ç‚¹ â€”&gt; å³å­æ ‘ ååºéå†ï¼šå·¦å­æ ‘ â€”&gt; å³å­æ ‘ â€”&gt; æ ¹ç»“ç‚¹ ä¾‹å¦‚ï¼š 1SELECT (count * price) AS sum FROM orders WHERE order_id &lt; 100 å…¶ä¸­ order_id &lt; 10 å°±æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒæœ‰ä¸€ä¸ªåˆ—è¾“å…¥å‚æ•°ï¼š order_idï¼Œè¾“å‡ºï¼šBool RPN è¡¨è¾¾å¼(é€†æ³¢å…°è¡¨ç¤ºæ³•)RPN æ˜¯æ ‘çš„ååºéå†ï¼Œååºéå†åœ¨æ¯ä¸ªèŠ‚ç‚¹çŸ¥é“è‡ªå·±æœ‰å‡ ä¸ªå­èŠ‚ç‚¹çš„æ—¶å€™ç­‰ä»·äºåŸæœ¬çš„æ ‘ç»“æ„ã€‚ æ‰€ä»¥ä½ æ³¢æ¾œæ˜¯ååºéå†ï¼šå·¦å³ä¸­ æ¯”å¦‚è¯´æˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°å­¦ç®—å¼ 2 *ï¼ˆ3 + 4ï¼‰+ 5ï¼š ç”±äºæ•°å­¦ä¸Šä¹ æƒ¯å†™æ³•æ˜¯ä¸­åºéå†ï¼Œæˆ‘ä»¬é€šå¸¸è¦åŠ ä¸Šæ‹¬å·æ¶ˆé™¤æ­§ä¹‰ï¼ˆæ¯”å¦‚åŠ å‡å’Œä¹˜é™¤çš„é¡ºåºï¼‰ã€‚é€šè¿‡æŠŠæ“ä½œç¬¦åç§» æˆ‘ä»¬å¾—åˆ° RPNï¼š2 3 4 + * 5 +ï¼Œè¿™æ ·æˆ‘ä»¬æ— éœ€æ‹¬å·å°±èƒ½æ— æ­§ä¹‰åœ°éå†è¿™ä¸ªè¡¨è¾¾å¼ï¼š ä¸­åºè¡¨è¾¾å¼è½¬ååºè¡¨è¾¾å¼ï¼š 1234åŸå¼ï¼ša+b*(c+d&#x2F;e)è¡¥å…¨æ‹¬å·ï¼š(a+(b*(c+(d&#x2F;e))))æ“ä½œç¬¦å³ç§»ï¼š(a(b(c(de)&#x2F;)+)*)+å»æ‰æ‹¬å·ï¼šabcde&#x2F;+*+ æ‰€ä»¥æ³¢å…°è¡¨è¾¾å¼æ˜¯ä¸­åºéå†ï¼šå·¦å³ä¸­ æ‰§è¡Œ RPN çš„è¿‡ç¨‹éœ€è¦ä¸€ä¸ªæ ˆæ¥ç¼“å­˜ä¸­é—´ç»“æœï¼Œæ¯”å¦‚è¯´å¯¹äº 2 3 4 + * 5 +ï¼Œæˆ‘ä»¬ä»å·¦åˆ°å³éå†è¡¨è¾¾å¼ï¼Œé‡åˆ°å€¼å°±å‹å…¥æ ˆä¸­ã€‚ç›´åˆ° + æ“ä½œç¬¦ï¼Œæ ˆä¸­å·²ç»å‹å…¥äº† 2 3 4ã€‚ å› ä¸º + æ˜¯äºŒå…ƒæ“ä½œç¬¦ï¼Œéœ€è¦ä»æ ˆä¸­å¼¹å‡ºä¸¤ä¸ªå€¼ 3 4ï¼Œç»“æœä¸º 7ï¼Œé‡æ–°å‹å…¥æ ˆä¸­ï¼š æ­¤æ—¶æ ˆä¸­çš„å€¼ä¸º 2 7ã€‚ ä¸‹ä¸€ä¸ªæ˜¯ * è¿ç®—ç¬¦ï¼Œä¹Ÿéœ€è¦å¼¹å‡ºä¸¤ä¸ªå€¼ 2 7ï¼Œç»“æœä¸º 14 å‹å…¥æ ˆä¸­ã€‚ æ¥ç€å‹å…¥ 5 ã€‚ æœ€å + è¿ç®—ç¬¦å¼¹å‡º 14 5ï¼Œç»“æœä¸º 19 ï¼Œå‹å…¥æ ˆã€‚ æœ€åç•™åœ¨æ ˆé‡Œçš„å°±æ˜¯è¡¨è¾¾å¼çš„ç»“æœï¼Œå› æ­¤ï¼Œå¦‚æœéœ€è¦è®¡ç®—è¡¨è¾¾å¼ä¼˜å…ˆçº§çš„è¯ï¼Œå¯ä»¥é‡‡ç”¨RPNçš„æ–¹å¼æ¥è¯»å–treeç»“æ„æ¥è¿›è¡Œé¡ºåºè®¡ç®—ã€‚ å•ç‹¬ä½¿ç”¨DBä¾‹å­ï¼š è¿™é‡Œæœ‰ä¸€ä¸ªç±»ä¼¼äºmysql-client çš„ä¸€ä¸ª bin ç¨‹åº 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071package mainimport ( \"flag\" \"github.com/pingcap/parser\" \"github.com/pingcap/parser/ast\" \"gitlab.mingchao.com/basedev-deps/logbdev\" \"gitlab.mingchao.com/basedev-deps/msource/v2\" \"os\")var sql = flag.String(\"sql\", \"\", \"Input Your Sql\")func init() &#123; flag.Parse()&#125;func main() &#123; if os.Getenv(\"DEBUG\") == \"true\" &#123; logbdev.SetLevel(logbdev.DebugLevel) &#125; msource.PreparePhase() store := msource.NewStore() p := parser.New() stmtNode, err := p.ParseOneStmt(*sql, \"\", \"\") if err != nil &#123; logbdev.Error(err) return &#125; _, ok := stmtNode.(*ast.SelectStmt) var r *msource.Result if ok &#123; r, err = store.Query(*sql) if err != nil &#123; logbdev.Error(err) return &#125; &#125; else &#123; r, err = store.Execute(*sql) if err != nil &#123; logbdev.Error(err) return &#125; &#125; if r != nil &#123; if r.Data != nil &#123; switch ar := r.Data.(type) &#123; case *msource.InsertResultData: logbdev.Info(ar.GetSliceInt64()) logbdev.Info(ar.Raw()) case *msource.ShowDatabasesResultData: logbdev.Info(ar.GetSliceString()) case *msource.ShowTablesResultData: logbdev.Info(ar.GetSliceString()) case *msource.SelectResultSetData: logbdev.Info(ar.GetFields()) logbdev.Info(ar.GetValues()) logbdev.Info(ar.Count()) case *msource.DeleteResultData: logbdev.Info(ar.GetAffected()) case *msource.UpdateResultData: logbdev.Info(ar.GetAffected()) &#125; &#125; logbdev.Info(r) &#125;&#125; å…·ä½“ç”¨æ³•ï¼š 12345go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;INSERT INTO users(\\&#96;name\\&#96;,\\&#96;age\\&#96;,\\&#96;last_login\\&#96;) VALUES (\\&quot;caiwenhui\\&quot;, 18, 1614776101)&quot;go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;show databases;&quot;go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;show tables;&quot;go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;INSERT INTO mingchao.users2(\\&#96;name\\&#96;,\\&#96;age\\&#96;) VALUES (\\&quot;caiwenhui\\&quot;, 18),(\\&quot;caiwenhui\\&quot;, 19)&quot;go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;INSERT INTO mingchao.users2 VALUES (1000,\\&quot;caiwenhui\\&quot;, 18)&quot; æˆ‘ä»¬å¯ä»¥ç”¨å¯¹å¤–æš´éœ²ä¸€ä¸ªmsource.NewStore()æ¥åˆ›å»ºä¸€ä¸ªå­˜å‚¨å™¨å¯¹è±¡ï¼Œç„¶åé€šè¿‡APIè¿›è¡Œæ•°æ®åº“çš„æ“ä½œã€‚ NewStoreæˆ‘ä»¬ç”¨äº†sync.Poolå°è£…ï¼Œå¯¹è±¡å¯ä»¥åšåˆ°å°½å¯èƒ½çš„å¤ç”¨ã€‚ å¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯SELECT STMTçš„è¯ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯QUERYAPIï¼Œå¦‚æœæ˜¯éSELECT STMTçš„è¯ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯EXECUTEAPIã€‚ TODOåŸºäºç›®å‰å°šæœªå®ç°ï¼Œæ‰€ä»¥æš‚æ—¶ä¸å†å±•å¼€è®²å™ï¼Œåç»­å¯ä»¥å‡çº§å¤„ç†çš„ç‚¹ä¸ºï¼š äº‹åŠ¡å¤„ç†ï¼Œä¾‹å¦‚å‰é¢æ‰€è¯´çš„redologå’Œundologå¯å®ç°ã€‚ orderbyï¼Œ æ•°æ®æ’åºã€‚ å…¨åŒå·¥çš„é€šä¿¡è·å–æ•°æ®ï¼Œæ— éœ€ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰æ•°æ®ã€‚ Explainæ‰§è¡Œè®¡åˆ’çš„å®ç°ï¼Œé€»è¾‘æ ¹æ®æ‰§è¡Œè®¡åˆ’èµ°ã€‚ SPOUTå¦å¤–ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œè®°å½•äº†æˆ‘ä»¬çš„spoutçš„ä½œç”¨ï¼Œåœ¨è¿™é‡Œï¼Œå†ç®€å•è¯´ä¸€ä¸‹ï¼Œspout æ˜¯æˆ‘ä»¬msourceç»„ä»¶çš„æ ¸å¿ƒè§’è‰²ï¼Œå®ƒæ˜¯ç”¨äºæŠŠæ•°æ®æ¨é€åˆ°ä¸Šå±‚ä¸šåŠ¡çš„æ‰€ä½¿ç”¨ã€‚ä¸Šå±‚ä¸šåŠ¡é€šè¿‡spoutè§’è‰²æä¾›çš„APIï¼Œå¯ä»¥è·å–åˆ°ä»æ•°æ®æºæ‹¿åˆ°çš„æ•°æ®ã€‚ spout è‡ªèº«ä¿æŒäº†ä¸€å¥— é«˜å¯é , é«˜æ€§èƒ½, å¯å®¹é”™ çš„æ•°æ®æœºåˆ¶ï¼Œä¸»è¦ç”¨äºåŒºåˆ«å‡ºACK, NACKï¼Œå¹¶ä¸”è‡ªå¸¦æœ‰ å¤±è´¥é‡ä¼ , å¤šé˜¶æ®µçŠ¶æ€æœºçš„checkpointç­‰æœºåˆ¶ã€‚ channel-mode å¤§ä½“æ•°æ®æµç¨‹å›¾ ä¹‹å‰æœ‰ä¸€ç¯‡æ–‡ç« ï¼Œä¸“é—¨è®²è§£channel-modeä¸‹ï¼Œæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè¯¦ç»†çš„è¯´æ˜ã€‚ç®€å•å¤è¿°ä¸€ä¸‹ã€‚ channelæ¨¡å¼ä¸‹ï¼Œæ˜¯ç›´æ¥æŠŠæ•°æ®æ¨é€åˆ°æˆ‘ä»¬çš„golangçš„channel å½“ä¸­ï¼Œä¸Šå±‚ä¸šåŠ¡ç›´æ¥ç”¨è¿‡channelæ‹¿åˆ°æ•°æ®ï¼Œæ‹¿åˆ°æ•°æ®åæ ¹æ®è‡ªèº«ä¸šåŠ¡å¤„ç†æ•°æ®æ¥åˆ¤æ–­å¯ä»¥ackæˆ–è€…nackæ‰æ•°æ®ï¼ŒåŒæ—¶ä¿å­˜offsetã€‚ è¿™é‡Œçš„é—®é¢˜å°±åœ¨äºï¼š ç”±äºæˆ‘ä»¬æ˜¯æœ¬åœ°å­˜å‚¨çš„offsetï¼Œå› ä¸ºä¸ä¿¡ä»» kafka-clientçš„auto-commitæœºåˆ¶ï¼Œå½“ç¨‹åºåœ¨æŸä¸ªèŠ‚ç‚¹crashçš„æ—¶å€™ï¼Œè¿™ä¼šè®©æˆ‘ä»¬çš„ç¨‹åºåœ¨ä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™ï¼Œé‡å¤æ¶ˆè´¹åˆ°æ•°æ®æˆ–è€…é—æ¼æ•°æ® ç¼ºç‚¹ï¼šæ¯ä¸ªpartitionçš„offsetéƒ½éœ€è¦é¡ºåºæ¶ˆè´¹ï¼Œåœ¨ä¸Šå±‚ä¸šåŠ¡æ— æ³•å¹¶å‘å¤„ç†ï¼Œè¿™æå¤§ç¨‹åº¦çš„é™ä½äº†æˆ‘ä»¬çš„æ¶ˆè´¹æ•ˆç‡ æœŸæœ›ï¼šå¦‚æœæˆ‘ä»¬æå‰æŠŠoffsetå­˜å‚¨èµ·æ¥äº†ï¼Œè€Œä¸éœ€è¦ACKä¹‹åå†å­˜å‚¨offsetçš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†ä¸Šå±‚ä¸šåŠ¡å¹¶å‘çš„å¤„ç†æ¶ˆæ¯ï¼Œè€Œæ— éœ€å…³æ³¨offsetçš„é—®é¢˜ db-demo å¤§ä½“æ•°æ®æµç¨‹å›¾ é‰´äºchannel-modeä¸‹çš„ç¼ºç‚¹ï¼Œç”±æ­¤è¯ç”Ÿäº†æˆ‘ä»¬çš„db-modeï¼Œå…¶åŸç†æ˜¯æŠŠæ•°æ®å…ˆå­˜å‚¨åœ¨æœ¬åœ°çš„æ•°æ®åº“ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„dbï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå…³ç³»spout &lt;- dbï¼Œ dbè§’è‰² å¯ä»¥è¢« spoutè§’è‰²æ‰€ä¾èµ–ã€‚ æˆ‘ä»¬åˆ›å»ºäº†4ä¸ªè¡¨æ¥å­˜å‚¨ä¸åŒçš„æ•°æ®ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455const ( DefaultDatabase = \"default\" DefaultDatabaseSql = \"CREATE DATABASE IF NOT EXISTS `\" + DefaultDatabase + \"`\" UseDefaultDatabase = \"USE `\" + DefaultDatabase + \"`\" // æ¨é€æ¶ˆæ¯çš„æ—¶å€™ä½¿ç”¨ // å› ä¸ºæ­£å¸¸æ¶ˆæ¯è¿‡æ¥çš„æ—¶å€™æ˜¯æ²¡æœ‰row_idçš„ï¼Œæ‰€ä»¥è¿™ä¸ªpayload_marshalå†…çš„row_idæ²¡æ„ä¹‰ // è¯¥è¡¨ä»…ä»…éå†æ•°æ®åˆ°Runnerè¡¨ï¼Œåˆ°äº†Runnerè¡¨å’ŒLoserè¡¨ï¼ŒRow_idæ‰æœ‰ç”¨ SpoutStoreStorageTable = \"storage\" SpoutStoreStorageBuildTableSql = \"create table if not exists \" + SpoutStoreStorageTable + \"(\" + \" `payload_marshal` varchar(255) not null comment \\\"åºåˆ—åŒ–åçš„payload\\\",\" + \" `is_multi_phase` int(11) not null default 0 comment \\\"æ˜¯å¦å¤šé˜¶æ®µï¼Œ0=å¦, 1=æ˜¯\\\",\" + \" `cur_state` int(11) not null default 0 comment \\\"å½“å‰çŠ¶æ€\\\",\" + \" `fin_state` int(11) not null default 0 comment \\\"æœ€ç»ˆçŠ¶æ€\\\"\" + \")\" // Storage -&gt; Runner ä½¿ç”¨ // åˆšå¯åŠ¨æœåŠ¡çš„æ—¶å€™Runner-&gt;Storageæœ‰ç”¨ // Ackçš„æ—¶å€™æœ‰ç”¨ SpoutStoreRunningTable = \"runner\" SpoutStoreRunningBuildTableSql = \"create table if not exists \" + SpoutStoreRunningTable + \"(\" + \" `payload_marshal` varchar(255) not null comment \\\"åºåˆ—åŒ–åçš„payload\\\",\" + \" `is_multi_phase` int(11) not null default 0 comment \\\"æ˜¯å¦å¤šé˜¶æ®µï¼Œ0=å¦, 1=æ˜¯\\\",\" + \" `cur_state` int(11) not null default 0 comment \\\"å½“å‰çŠ¶æ€\\\",\" + \" `fin_state` int(11) not null default 0 comment \\\"æœ€ç»ˆçŠ¶æ€\\\"\" + \")\" // Runner -&gt; Loser ä½¿ç”¨ // Nackçš„æ—¶å€™æœ‰ç”¨ // å¤±è´¥é‡ä¼ çš„æ—¶å€™ç”¨/åˆšå¯åŠ¨æœåŠ¡çš„æ—¶å€™Loser-&gt;Storageæœ‰ç”¨ SpoutStoreLoserTable = \"loser\" SpoutStoreLoserBuildTableSql = \"create table if not exists \" + SpoutStoreLoserTable + \"(\" + \" `payload_marshal` varchar(255) not null comment \\\"åºåˆ—åŒ–åçš„payload\\\",\" + \" `is_multi_phase` int(11) not null default 0 comment \\\"æ˜¯å¦å¤šé˜¶æ®µï¼Œ0=å¦, 1=æ˜¯\\\",\" + \" `cur_state` int(11) not null default 0 comment \\\"å½“å‰çŠ¶æ€\\\",\" + \" `fin_state` int(11) not null default 0 comment \\\"æœ€ç»ˆçŠ¶æ€\\\"\" + \")\" SpoutStoreDefaultOffsetTable = \"offset\" SpoutStoreDefaultOffsetBuildTableSql = \"create table if not exists \" + SpoutStoreDefaultOffsetTable + \"(\" + \" `group_id` varchar(255) not null comment \\\"æ¶ˆè´¹ç»„\\\",\" + \" `topic` varchar(255) not null comment \\\"æ¶ˆè´¹çš„topic\\\",\" + \" `partition` int(11) not null comment \\\"topicçš„partition\\\",\" + \" `offset` int(11) not null comment \\\"å½“å‰æ¶ˆè´¹çš„offset\\\",\" + \" UNIQUE KEY `uniq_idx` (`group_id`,`topic`,`partition`)\" + \")\") DBæ¨¡å¼ä¸‹çš„ç”¨æ³•ä¾‹å­ï¼š channel-modeä¸‹çš„ä¾‹å­å’Œdbæ¨¡å¼çš„å·®ä¸å¤šï¼Œä½†æ˜¯æ›´åŠ ç®€å•ï¼Œè¿™é‡Œå°±ä¸åˆ—å‡ºæ¥äº†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768package commonimport ( \"context\" \"gitlab.mingchao.com/basedev-deps/logbdev\" \"gitlab.mingchao.com/basedev-deps/msource/v2\" \"os\" \"os/signal\" \"sync\" \"syscall\")func PreparePhase() &#123; logbdev.SetLevel(logbdev.DebugLevel) S = msource.PreparePhase()&#125;var S *msource.Spoutfunc CoreStart(function func(payload *msource.Payload)) &#123; wg := new(sync.WaitGroup) // åˆ›å»ºä¸»åç¨‹ä¸Šä¸‹æ–‡ ctx, cannel := context.WithCancel(context.Background()) // å¯åŠ¨msourceï¼Œå¹¶ä¸”ä¼ é€’ä¸»åç¨‹ä¸Šä¸‹æ–‡ï¼Œç”¨äºä»»åŠ¡é—´çš„é€šä¿¡æ§åˆ¶ S.Start(ctx) // æ³¨å†Œä¿¡å·é‡ sig := make(chan os.Signal, 1) signal.Notify(sig, syscall.SIGINT, syscall.SIGTERM) wg.Add(1) go func() &#123; defer wg.Done() for &#123; select &#123; case &lt;-sig: cannel() return &#125; &#125; &#125;() // è¿™é‡Œæˆ‘ä»¬å¯ä»¥å†åˆ›å»ºæ›´å¤šçš„workerååŠ©æˆ‘ä»¬çš„æ¶ˆè´¹æ•°æ® // ä½¿ç”¨æ–¹å¼åŸºæœ¬å‘åå…¼å®¹ innerWorker := 3 logbdev.Infof(\"total chan: %d\\n\", S.ChanSize()) // ä¸»åç¨‹ä¸­åˆ›å»ºå­åç¨‹ï¼ˆworkerï¼‰å·¥ä½œ for i := 0; i &lt; S.ChanSize(); i++ &#123; for ii := 0; ii &lt; innerWorker; ii++ &#123; wg.Add(1) go func(idx, idx2 int) &#123; defer wg.Done() logbdev.Infof(\"start chan[%d-%d]\\n\", idx, idx2) payloadCh := S.GetPayloadChanById(idx) for payload := range payloadCh.GetCh() &#123; function(payload) &#125; &#125;(i, ii) &#125; &#125; // ç­‰å¾…å­åç¨‹ç»“æŸ wg.Wait() // ç­‰å¾…msourceé€€å‡º S.Stop()&#125; ACK123456789101112131415package mainimport ( \"gitlab.mingchao.com/basedev-deps/logbdev\" \"gitlab.mingchao.com/basedev-deps/msource/v2\" \"gitlab.mingchao.com/basedev-deps/msource/v2/example/spout/db/common\")func main() &#123; common.CoreStart(func(payload *msource.Payload) &#123; if err := common.S.Ack(payload); err != nil &#123; logbdev.Error(err) &#125; &#125;)&#125; NACK12345678910111213141516package mainimport ( \"gitlab.mingchao.com/basedev-deps/logbdev\" \"gitlab.mingchao.com/basedev-deps/msource/v2\" \"gitlab.mingchao.com/basedev-deps/msource/v2/example/spout/db/common\")func main() &#123; common.PreparePhase() common.CoreStart(func(payload *msource.Payload) &#123; if err := common.S.MarkFailure(payload); err != nil &#123; logbdev.Error(err) &#125; &#125;)&#125; STATE-MACHINE123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121package mainimport ( \"context\" \"fmt\" \"gitlab.mingchao.com/basedev-deps/logbdev\" \"gitlab.mingchao.com/basedev-deps/msource/v2/example/spout/db/common\" \"os\" \"os/signal\" \"sync\" \"syscall\")type MyStateMachine struct &#123; phases []string&#125;func (msm *MyStateMachine) AddPhase(name string) error &#123; msm.phases = append(msm.phases, name) return nil&#125;// get all phasefunc (msm *MyStateMachine) GetPhases() []string &#123; return msm.phases&#125;func main() &#123; common.PreparePhase() wg := new(sync.WaitGroup) // åˆ›å»ºä¸»åç¨‹ä¸Šä¸‹æ–‡ ctx, cannel := context.WithCancel(context.Background()) // å¯åŠ¨msourceï¼Œå¹¶ä¸”ä¼ é€’ä¸»åç¨‹ä¸Šä¸‹æ–‡ï¼Œç”¨äºä»»åŠ¡é—´çš„é€šä¿¡æ§åˆ¶ // éœ€è¦è®¾ç½®ä¸ºå¤šé˜¶æ®µçš„è¯ï¼Œå¿…é¡»è®¾ç½®çŠ¶æ€æœºï¼Œå¹¶ä¸”åœ¨msourceæœåŠ¡Startä¹‹å‰è®¾ç½® sms := &amp;MyStateMachine&#123;&#125; _ = sms.AddPhase(\"step1\") _ = sms.AddPhase(\"step2\") _ = sms.AddPhase(\"step3\") common.S.SetStateMachine(sms) common.S.Start(ctx) // æ³¨å†Œä¿¡å·é‡ sig := make(chan os.Signal, 1) signal.Notify(sig, syscall.SIGINT, syscall.SIGTERM) wg.Add(1) go func() &#123; defer wg.Done() for &#123; select &#123; case &lt;-sig: cannel() return &#125; &#125; &#125;() logbdev.Infof(\"total chan: %d\\n\", common.S.ChanSize()) // ä¸»åç¨‹ä¸­åˆ›å»ºå­åç¨‹ï¼ˆworkerï¼‰å·¥ä½œ for i := 0; i &lt; common.S.ChanSize(); i++ &#123; wg.Add(1) chCtx, _ := context.WithCancel(ctx) go func(idx int, childCtx context.Context) &#123; defer wg.Done() logbdev.Infof(\"start chan[%d]\\n\", idx) payloadCh := common.S.GetPayloadChanById(idx) for &#123; select &#123; case payload := &lt;-payloadCh.GetCh(): // ä¸åŒé˜¶æ®µä¹‹é—´å¦‚æœç›¸äº’æ— ä¾èµ–çš„è¯ï¼Œåˆ™å¯ä»¥å¹¶å‘å¤„ç† // å¦åˆ™è¯·ä½¿ç”¨åŒæ­¥çš„æ–¹å¼ var wg sync.WaitGroup wg.Add(1) go func() &#123; defer wg.Done() phase := \"step1\" if common.S.CanTransition(payload, phase) &#123; fmt.Println(\"Do Step 1 something\") _ = common.S.Transition(payload, phase) &#125; &#125;() wg.Add(1) go func() &#123; defer wg.Done() phase := \"step2\" if common.S.CanTransition(payload, phase) &#123; fmt.Println(\"Do Step 2 something\") _ = common.S.Transition(payload, phase) &#125; &#125;() wg.Add(1) go func() &#123; defer wg.Done() phase := \"step3\" if common.S.CanTransition(payload, phase) &#123; fmt.Println(\"Do Step 3 something\") _ = common.S.Transition(payload, phase) &#125; &#125;() wg.Wait() // å¤šé˜¶æ®µçš„è¯·çœ‹ä¸‹ï¼ŒAckéå¿…é¡»è¦ï¼Œå¦‚æœæ‰‹åŠ¨è°ƒç”¨ackçš„è¯ï¼Œé‚£ä¹ˆç­‰äºä¸€æ¡æ¡åŒæ­¥åˆ é™¤ // msource åœ¨åå°ä¼šå®šæœŸæ£€æµ‹runnerä¸­çš„çŠ¶æ€æœºæ•°æ® //if err := common.S.Ack(payload); err != nil &#123; // logbdev.Error(err) //&#125; case &lt;-ctx.Done(): fmt.Println(\"Done\") return &#125; &#125; &#125;(i, chCtx) &#125; // ç­‰å¾…å­åç¨‹ç»“æŸ wg.Wait() // ç­‰å¾…msourceé€€å‡º common.S.Stop()&#125; å°çŸ¥è¯†æ€»ç»“timeç»„ä»¶åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œtimeç»„ä»¶ç”¨å¾—è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œå› ä¸ºæœ‰å„ç§å¼‚æ­¥ä»»åŠ¡åœ¨åå°è¿è¡Œï¼Œå¸¸è§„çš„ç”¨æ³•å°±ä¸è®°å½•è®²è¿°äº†ï¼Œè¿™é‡Œè¯´ä¸€ä¸‹ä¸€äº›æ³¨æ„çš„ç‚¹ã€‚ 123456789&#x2F;&#x2F; After waits for the duration to elapse and then sends the current time&#x2F;&#x2F; on the returned channel.&#x2F;&#x2F; It is equivalent to NewTimer(d).C.&#x2F;&#x2F; The underlying Timer is not recovered by the garbage collector&#x2F;&#x2F; until the timer fires. If efficiency is a concern, use NewTimer&#x2F;&#x2F; instead and call Timer.Stop if the timer is no longer needed.func After(d Duration) &lt;-chan Time &#123; return NewTimer(d).C&#125; æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªAPIï¼Œå¦‚æœæƒ³è¦ç”¨ 12345678for &#123; select &#123; case &lt;-time.After(1*time.Second)): fmt.Println(\"æ—¶é—´åˆ°äº†\") default: fmt.Println(\"go on\") &#125;&#125; çœ‹åˆ°è¿™ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬è¿™ä¹ˆç”¨çš„è¯ï¼Œæ¯1ç§’éƒ½ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªTimerå¯¹è±¡ï¼Œä¸æ–­åœ¨å †ç©ºé—´ç”³è¯·å†…å­˜ï¼Œç„¶ågc-workerå†å¤§é‡å›æ”¶æ²¡æœ‰å†ä½¿ç”¨çš„å¯¹è±¡å†…å­˜ã€‚è¿™å°±å¯¼è‡´cpuåšäº†é¢å¤–çš„ä¸€äº›æ— æ•ˆå·¥ä½œã€‚ æ‰€ä»¥è¿™ç§ç”¨æ³•æˆ‘æ˜¯ä¸æ¨èçš„ã€‚ 1234567func (t *Timer) Reset(d Duration) bool &#123; if t.r.f == nil &#123; panic(\"time: Reset called on uninitialized Timer\") &#125; w := when(d) return resetTimer(&amp;t.r, w)&#125; æˆ‘ä»¬çœ‹åˆ°å…¶å®Timer å…¶å®æœ‰ä¸€ä¸ªResetçš„APIï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åŒä¸€ä¸ªtimerè¿›è¡ŒResetçš„æ“ä½œï¼Œä¸æ–­æ˜¯é‡ç½®æ—¶é—´å³å¯ã€‚ 12345678910d := 1*time.Secondt:= NewTimer(d)for &#123; select &#123; case &lt;-t.C: t.Reset(d) default: fmt.Println(\"go on\") &#125;&#125; makeå‡½æ•°makeå‡½æ•°æ˜¯ä¸€ä¸ªå¾ˆå¼ºå¤§çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ä½¿ç”¨åˆ°ï¼Œä½†æ˜¯æœ‰ä¸€äº›ç»†èŠ‚ï¼Œéœ€è¦å¤§å®¶çŸ¥é“çš„ã€‚ make([]byte,0,10) ä¸ make([]byte,10) è¿™æ˜¯2ä¸­ä¸åŒçš„åˆ‡ç‰‡ï¼Œå¯¹äºå¯èƒ½åˆšå­¦ä¹ golangçš„å°ä¼™ä¼´æ¥è¯´ï¼Œä¼šæœ‰ç‚¹ç–‘æƒ‘ï¼Œä½†æ˜¯è¿™æ˜¯éœ€è¦äº†è§£çš„ï¼Œå¦‚æœæ˜¯ä¸‰ä¸ªå‚æ•°çš„æ—¶å€™ï¼Œä¸€ä¸ªæ˜¯cap,ä¸€ä¸ªæ˜¯lenï¼Œä»–ä»¬æ˜¯æœ‰åŒºåˆ«çš„ã€‚å¦‚æœæ˜¯ä¸‰ä¸ªå‚æ•°çš„è¯ï¼Œé‚£ä»£è¡¨å½“å‰å¤§å°cap = len æˆ‘ä»¬ç»å¸¸ä¼šç”¨ä¸‰ä¸ªå‚æ•°æ¥è¿›è¡Œé¢„åˆ†é…ç©ºé—´ï¼Œç¬¬äºŒä¸ªå‚æ•°é»˜è®¤éƒ½æ˜¯å¡«å†™0æ¥è¿›è¡Œä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬åœ¨å†™DBçš„æ—¶å€™ï¼Œç”¨åˆ°äº†å¤§é‡[]byteç±»å‹ï¼Œåœ¨ç»„è£…ç¼–ç å­—èŠ‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨è¿™ç§æ–¹å¼æ¥å¤„ç†ï¼Œå¦åˆ™ã€‚ 12345a := make([]byte, 0, 5)a = append(a, []byte&#123;'a'&#125;) // a = [97]a := make([]byte, 5)a = append(a, []byte&#123;'a'&#125;) // a = [0,0,0,0,0,97] çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶å°±ä¼šæ˜ç™½åŒºåˆ«ã€‚ onceå‡½æ•°æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³è¦ä¿è¯åªè¿è¡Œä¸€æ¬¡ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬å°±éœ€è¦å€ŸåŠ© sync.Onceï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ ä¸€ä¸ªsync.Onceåªèƒ½ä¸ä¸€ä¸ªå‡½æ•°ç»‘å®šï¼ 1234567once := new(sync.Once)callback:= func() &#123; fmt.Println(\"æˆ‘åªæƒ³è¿è¡Œä¸€æ¬¡\")&#125;once.Do(callback) // ä¼š è¾“å‡ºonce.Do(callback) // æ—  è¾“å‡ºonce.Do(callback) // æ—  è¾“å‡ºonce.Do(callback) // æ—  è¾“å‡º è‡ªå®šä¹‰marshalå’Œunmarshalæœ‰æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³è¦è‡ªå·±å®šä¹‰jsonçš„marshal å’Œ unmarshalï¼Œè¿™é‡Œæˆ‘ä»¬çš„å‘å·è®¡æ•°å™¨ å°±ç”¨åˆ°äº†ï¼Œç”¨å®ƒçš„åŸå› å…¶å®æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬çš„å‘å·è®¡æ•°å™¨åœ¨å‘å·çš„è¿‡ç¨‹ä¸­ï¼Œå…¶å®æ˜¯åå°è·‘ç€ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡åœ¨å‘å·ï¼Œæ‰€ä»¥åœ¨è¢«åç¼–ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡ã€‚ 1234567891011121314151617181920212223242526272829303132func (c *counter) UnmarshalJSON(data []byte) (err error) &#123; c.IdKey = data[1 : len(data)-1] // é‡ç‚¹å…³æ³¨è¿™é‡Œ turboNew(c) return&#125;func (c *counter) MarshalJSON() ([]byte, error) &#123; b := make([]byte, 0, len(c.IdKey)+2) b = append(b, '\"') b = append(b, c.IdKey...) b = append(b, '\"') return b, nil&#125;func turboNew(c *counter) &#123; ct := custom.Load().(*Custom) c.idChan = make(chan int64, ct.IdStep) c.sig = make(chan os.Signal, 1) c.ReadOptions = gorocksdb.NewDefaultReadOptions() signal.Notify(c.sig, syscall.SIGINT, syscall.SIGTERM) // è¿™é‡Œä¼šå¯åŠ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ c.sender()&#125;func (c *counter) sender() &#123; // å¼‚æ­¥ä»»åŠ¡ ...&#125; lockfree-queueå’Œlockfree-stackæˆ‘ä»¬çŸ¥é“å¦‚æœæƒ³è¦åšåˆ°å¹¶å‘å®‰å…¨çš„è¯ï¼Œæ™®éåšæ³•å°±æ˜¯2ç§ æ— é”åŒ–ç»“æ„çš„è®¾è®¡ï¼ˆéœ€è¦é’ˆå¯¹ç‰¹å®šçš„ä¸šåŠ¡å¸¸ç”¨ï¼Œå¹¶ä¸”ä¸å…è®¸ä¹±ç”¨ï¼‰ æœ‰é”ç»“æ„ æ— é”åŒ–(lock-free)çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œåœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¹Ÿæœ‰æƒ³è¿‡åˆ©ç”¨lock-free-stackä»¥åŠlock-free-queueï¼Œåˆ†åˆ«æƒ³è¦è¿ç”¨åœ¨RPNçš„å®ç°ä»¥åŠå‘å·å™¨å½“ä¸­ï¼Œè™½ç„¶åæ¥å‘ç°ç”¨ä¸åˆ°ï¼Œä½†æ˜¯å¯ä»¥æ‹¿åˆ°è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990// inrInt64 Increasefunc inrInt64(i *int64) &#123; t := int64(+1) for &#123; value := atomic.LoadInt64(i) if atomic.CompareAndSwapInt64(i, value, value+t) &#123; return &#125; time.Sleep(time.Nanosecond) &#125;&#125;// dcrInt64 Decreasefunc dcrInt64(i *int64) &#123; t := int64(-1) for &#123; value := atomic.LoadInt64(i) if atomic.CompareAndSwapInt64(i, value, value+t) &#123; return &#125; time.Sleep(time.Nanosecond) &#125;&#125;// LKStack returns an empty queue.func NewLKStack() *LKStack &#123; n := unsafe.Pointer(&amp;node&#123;&#125;) return &amp;LKStack&#123;head: n&#125;&#125;// LKStack is a lock-free unbounded stack.type LKStack struct &#123; len int64 head unsafe.Pointer&#125;func (q *LKStack) IsEmpty() bool &#123; return q.Len() == 0&#125;func (q *LKStack) Len() int64 &#123; return q.len&#125;// LKStack puts the given value v at the tail of the stack.func (q *LKStack) Push(v interface&#123;&#125;) &#123; n := &amp;node&#123;value: v&#125; for &#123; head := load(&amp;q.head) next := load(&amp;n.next) cas(&amp;n.next, next, head) if cas(&amp;q.head, head, n) &#123; inrInt64(&amp;q.len) return &#125; time.Sleep(time.Nanosecond) &#125;&#125;// Pop removes and returns the value at the head of the stack.// It returns nil if the stack is empty.func (q *LKStack) Pop() interface&#123;&#125; &#123; for &#123; head := load(&amp;q.head) next := load(&amp;head.next) if next == nil &#123; // is stack empty? return nil &#125; else &#123; // read value before CAS otherwise another pop might free the next node v := head.value if cas(&amp;q.head, head, next) &#123; dcrInt64(&amp;q.len) return v // Pop is done. return &#125; &#125; time.Sleep(time.Nanosecond) &#125;&#125;// load from atomic load pointer nodefunc load(p *unsafe.Pointer) (n *node) &#123; return (*node)(atomic.LoadPointer(p))&#125;// cas swap setfunc cas(p *unsafe.Pointer, old, new *node) (ok bool) &#123; return atomic.CompareAndSwapPointer( p, unsafe.Pointer(old), unsafe.Pointer(new))&#125; è¿™é‡Œä¹Ÿä¸è¿‡å¤šåœ¨è¿™é‡Œæè¿°äº†ï¼Œæˆ‘ä»¬å¤§å®¶æŸ¥çœ‹æºç å§ï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨äº†atomicåŒ…ä¸­çš„åŸå­æ€§æ“ä½œCompareAndSwapXxx, å› ä¸ºè¿™æ˜¯ä¸€ä¸ªåŸå­æ€§çš„æŒ‡ä»¤ï¼Œåˆç†çš„è¿ç”¨å³å¯åšåˆ°æ— é”åŒ–å¹¶å‘å®‰å…¨çš„ç»“æ„ã€‚ atomicåŒ…çš„CompareAndSwapXxxå…¶å®å°±æ˜¯ä¸€ä¸ªCASçš„ç†å¿µï¼Œç”¨ä¹è§‚é”(é€»è¾‘é”)æ¥åšæ•°æ®å¤„ç†ã€‚ unsafaåŒ…ä¸­çš„æŒ‡é’ˆçš„ä½œç”¨ï¼šé›¶æ‹·è´stringå’Œbyteçš„è½¬æ¢é›¶æ‹·è´(zero-copy)ï¼Œä¼ ç»Ÿè¾ƒå¤šçš„è¯´æ³•å°±æ˜¯æ— éœ€ç»è¿‡ç”¨æˆ·æ€åˆ°å†…æ ¸æ€åˆ°æ•°æ®copyï¼Œå³å¯åšåˆ°æƒ³åšçš„äº‹æƒ…ã€‚ é€šä¿—ä¸€ç‚¹å°±æ˜¯ä¸ç»è¿‡copyå°±èƒ½è½¬æ¢æ•°æ®ã€‚ 12345678910type StringHeader struct &#123; Data uintptr Len int&#125;type SliceHeader struct &#123; Data uintptr Len int Cap int&#125; è¿™æ˜¯Stringå’Œsliceçš„åº•å±‚æ•°æ®ç»“æ„ï¼Œä»–ä»¬åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼ŒåŒºåˆ«å…¶å®å°±æ˜¯åœ¨äºä¸€ä¸ªæœ‰Capï¼Œä¸€ä¸ªæ˜¯å›ºå®šçš„Lenã€‚ åªéœ€è¦å…±äº«åº•å±‚ Data å’Œ Len å°±å¯ä»¥å®ç° zero-copyã€‚ 1234567func string2bytes(s string) []byte &#123; return *(*[]byte)(unsafe.Pointer(&amp;s))&#125;func bytes2string(b []byte) string &#123; return *(*string)(unsafe.Pointer(&amp;b))&#125; contextæ§åˆ¶ä¸Šä¸‹æ–‡ä¹Ÿè®²è§£ä¸€ä¸‹æˆ‘ä»¬è¿™é‡Œç”¨åˆ°äº†å¤§é‡åç¨‹ï¼Œä»–ä»¬ä¹‹é—´æœ‰ä¸€äº›æˆ–è®¸æ˜¯æœ‰ä¸Šä¸‹æ–‡å…³ç³»çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿™é‡Œå°±éœ€è¦ç”¨åˆ°contextæ¥å¯¹åç¨‹è¿›è¡Œä¸€ä¸ªä¸Šä¸‹æ–‡çš„ç®¡ç†ï¼Œåšåˆ°ååŠ©çš„ä½œç”¨ã€‚ ç‰¹åˆ«æ˜¯æˆ‘ä»¬åœ¨é€€å‡ºç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³è¦æŸä¸€äº›å¼‚æ­¥ä»»åŠ¡ä¼˜é›…,å¯é ,å®‰å…¨çš„é€€å‡ºç¨‹åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°contextæ¥æ§åˆ¶æ¯ä¸ªåå°è¿è¡Œçš„ç¨‹åºã€‚ æˆ‘ä»¬è¿™é‡Œç”¨åˆ°æ¯”è¾ƒå¤šçš„å…¶å®å°±æ˜¯ context.WithCancel(ctx)ï¼Œ æˆ‘ä»¬éœ€è¦ç®¡ç†æ¯ä¸ªåç¨‹çš„é€€å‡ºéœ€è¦åšçš„äº‹æƒ…ï¼Œä¾‹å¦‚ï¼šæˆ‘éœ€è¦msourceåœ¨é€€å‡ºçš„æ—¶å€™ï¼Œä¿å­˜ä¸€ä¸‹å½“å‰åœ¨å†…å­˜ä¸­æœ€æ–°çš„æ•°æ®åˆ°rocksdbä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™contextçš„ä½œç”¨å°±ååˆ†æœ‰æ•ˆäº†ã€‚ pprofçš„æŸ¥çœ‹è¦åˆ©ç”¨pprofç²—ç•¥æŸ¥çœ‹æ€§èƒ½ï¼ŒåŠæ—¶å®ƒä¸èƒ½å‡†ç¡®çš„åé¦ˆå‡ºæ‰€æœ‰çš„é—®é¢˜ï¼Œèµ·ç å®ƒèƒ½å¸®åŠ©æˆ‘ä»¬åœ¨å‰é¢çš„å¤§é—®é¢˜ä¸Šæ›´å®¹æ˜“å‘ç°é—®é¢˜ã€‚ sync.Poolå¦‚ä½•åšåˆ°ä¼˜åŒ– å¯¹STWæš‚åœæ—¶é—´åšäº†ä¼˜åŒ–, é¿å…å¤§çš„sync.Poolä¸¥é‡å½±å“STWæ—¶é—´ ç¬¬äºŒä¸ªä¼˜åŒ–æ˜¯GCæ—¶å…¥å¯¹sync.Poolè¿›è¡Œå›æ”¶ï¼Œä¸ä¼šä¸€æ¬¡å°†æ± åŒ–å¯¹è±¡å…¨éƒ¨å›æ”¶ï¼Œè¿™å°±é¿å…äº†sync.Poolé‡Šæ”¾å¯¹è±¡å’Œé‡å»ºå¯¹è±¡å¯¼è‡´çš„æ€§èƒ½å°–åˆºï¼Œé€ ç¦äºsync.Poolé‡åº¦ç”¨æˆ·ã€‚ ç¬¬ä¸‰ä¸ªå°±æ˜¯å¯¹æ€§èƒ½çš„ä¼˜åŒ–ã€‚ å¯¹ä»¥ä¸Šçš„æ”¹è¿›ä¸»è¦æ˜¯ä¸¤æ¬¡æäº¤ï¼šsync: use lock-free structure for Pool stealingsync: smooth out Pool behavior over GC with a victim cache åˆ†åˆ«æ˜¯ç”¨åˆ°äº†æ— é”åŒ–ç»“æ„ ä»¥åŠç¨‹åºGCçš„è¡Œä¸ºçš„ä¼˜åŒ–","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®ç»“æ„/æ•°æ®åº“","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93/"}],"tags":[{"name":"Kafka","slug":"Kafka","permalink":"http://blog.crazylaw.cn/tags/Kafka/"},{"name":"TiDB","slug":"TiDB","permalink":"http://blog.crazylaw.cn/tags/TiDB/"},{"name":"RocketDB","slug":"RocketDB","permalink":"http://blog.crazylaw.cn/tags/RocketDB/"},{"name":"SQL","slug":"SQL","permalink":"http://blog.crazylaw.cn/tags/SQL/"}]},{"title":"ã€Golangã€‘- unsafe Pointer","slug":"Golang/unsafe-Pointer","date":"2021-01-14T03:37:12.000Z","updated":"2021-03-20T16:25:01.799Z","comments":true,"path":"2021/01/14/Golang/unsafe-Pointer/","link":"","permalink":"http://blog.crazylaw.cn/2021/01/14/Golang/unsafe-Pointer/","excerpt":"å‰è¨€ç”±äºç›®å‰åœ¨ä½¿ç”¨ä½¿ç”¨ä¸€äº›goå†™çš„odbcåº“ï¼Œé‡Œé¢æ¶‰åŠåˆ°ä¸€äº›cgoçš„å†…å®¹ï¼Œé‚£å°±é¿ä¸å¼€å†…å­˜å’ŒæŒ‡é’ˆç­‰é—®é¢˜ï¼Œåœ¨è¿™è¾¹æ–‡ç« ä¸­è®°å½•ä¸€ä¸‹unsafe Pointer å’Œ uintptr çš„ç›¸å…³å†…å®¹ã€‚ Goè¯­è¨€åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œä¸ºäº†ç¼–å†™æ–¹ä¾¿ã€æ•ˆç‡é«˜ä»¥åŠé™ä½å¤æ‚åº¦ï¼Œè¢«è®¾è®¡æˆä¸ºä¸€é—¨å¼ºç±»å‹çš„é™æ€è¯­è¨€ã€‚å¼ºç±»å‹æ„å‘³ç€ä¸€æ—¦å®šä¹‰äº†ï¼Œå®ƒçš„ç±»å‹å°±ä¸èƒ½æ”¹å˜äº†ï¼›é™æ€æ„å‘³ç€ç±»å‹æ£€æŸ¥åœ¨è¿è¡Œå‰å°±åšäº†ã€‚ åŒæ—¶ä¸ºäº†å®‰å…¨çš„è€ƒè™‘ï¼ŒGoè¯­è¨€æ˜¯ä¸å…è®¸ä¸¤ä¸ªæŒ‡é’ˆç±»å‹è¿›è¡Œè½¬æ¢çš„ã€‚","text":"å‰è¨€ç”±äºç›®å‰åœ¨ä½¿ç”¨ä½¿ç”¨ä¸€äº›goå†™çš„odbcåº“ï¼Œé‡Œé¢æ¶‰åŠåˆ°ä¸€äº›cgoçš„å†…å®¹ï¼Œé‚£å°±é¿ä¸å¼€å†…å­˜å’ŒæŒ‡é’ˆç­‰é—®é¢˜ï¼Œåœ¨è¿™è¾¹æ–‡ç« ä¸­è®°å½•ä¸€ä¸‹unsafe Pointer å’Œ uintptr çš„ç›¸å…³å†…å®¹ã€‚ Goè¯­è¨€åœ¨è®¾è®¡çš„æ—¶å€™ï¼Œä¸ºäº†ç¼–å†™æ–¹ä¾¿ã€æ•ˆç‡é«˜ä»¥åŠé™ä½å¤æ‚åº¦ï¼Œè¢«è®¾è®¡æˆä¸ºä¸€é—¨å¼ºç±»å‹çš„é™æ€è¯­è¨€ã€‚å¼ºç±»å‹æ„å‘³ç€ä¸€æ—¦å®šä¹‰äº†ï¼Œå®ƒçš„ç±»å‹å°±ä¸èƒ½æ”¹å˜äº†ï¼›é™æ€æ„å‘³ç€ç±»å‹æ£€æŸ¥åœ¨è¿è¡Œå‰å°±åšäº†ã€‚ åŒæ—¶ä¸ºäº†å®‰å…¨çš„è€ƒè™‘ï¼ŒGoè¯­è¨€æ˜¯ä¸å…è®¸ä¸¤ä¸ªæŒ‡é’ˆç±»å‹è¿›è¡Œè½¬æ¢çš„ã€‚ æŒ‡é’ˆç±»å‹è½¬æ¢æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨*Tä½œä¸ºä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œè¡¨ç¤ºä¸€ä¸ªæŒ‡å‘ç±»å‹Tå˜é‡çš„æŒ‡é’ˆã€‚ä¸ºäº†å®‰å…¨çš„è€ƒè™‘ï¼Œä¸¤ä¸ªä¸åŒçš„æŒ‡é’ˆç±»å‹ä¸èƒ½ç›¸äº’è½¬æ¢ï¼Œæ¯”å¦‚*intä¸èƒ½è½¬ä¸º*float64ã€‚ 12345678func main() &#123; i:= 10 ip:=&amp;i var fp *float64 = (*float64)(ip) fmt.Println(fp)&#125; ä»¥ä¸Šä»£ç æˆ‘ä»¬åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œä¼šæç¤º cannot convert ip (type *int) to type *float64ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è¿›è¡Œå¼ºåˆ¶è½¬å‹ã€‚é‚£å¦‚æœæˆ‘ä»¬è¿˜æ˜¯éœ€è¦è¿›è¡Œè½¬æ¢æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬ä½¿ç”¨ unsafeåŒ… é‡Œçš„ Pointer äº†ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆçœ‹çœ‹ unsafe.Pointer æ˜¯ä»€ä¹ˆï¼Œç„¶åå†ä»‹ç»å¦‚ä½•è½¬æ¢ã€‚ unsafe.Pointerunsafe.Pointer æ˜¯ä¸€ç§ç‰¹æ®Šæ„ä¹‰çš„æŒ‡é’ˆï¼Œå®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹çš„åœ°å€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Cè¯­è¨€ é‡Œçš„ void* æŒ‡é’ˆï¼Œå…¨èƒ½å‹çš„ã€‚ 12345678910func main() &#123; i:= 10 ip:=&amp;i var fp *float64 = (*float64)(unsafe.Pointer(ip)) *fp = *fp * 3 fmt.Println(i)&#125; ä»¥ä¸Šç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ *int è½¬ä¸º *float64 ,å¹¶ä¸”æˆ‘ä»¬å°è¯•äº†å¯¹æ–°çš„ *float64 è¿›è¡Œæ“ä½œï¼Œæ‰“å°è¾“å‡ºiï¼Œå°±ä¼šå‘ç°içš„å€åŒæ ·è¢«æ”¹å˜ã€‚ ä»¥ä¸Šè¿™ä¸ªä¾‹å­æ²¡æœ‰ä»»ä½•å®é™…çš„æ„ä¹‰ï¼Œä½†æ˜¯æˆ‘ä»¬è¯´æ˜äº†ï¼Œé€šè¿‡ unsafe.Pointer è¿™ä¸ªä¸‡èƒ½çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ *T ä¹‹é—´åšä»»ä½•è½¬æ¢ã€‚ 123type ArbitraryType inttype Pointer *ArbitraryType å¯ä»¥çœ‹åˆ° unsafe.Pointer å…¶å®å°±æ˜¯ä¸€ä¸ª *int,ä¸€ä¸ªé€šç”¨å‹çš„æŒ‡é’ˆã€‚ æˆ‘ä»¬çœ‹ä¸‹å…³äº unsafe.Pointer çš„4ä¸ªè§„åˆ™ã€‚ ä»»ä½•æŒ‡é’ˆ éƒ½å¯ä»¥è½¬æ¢ä¸º unsafe.Pointer unsafe.Pointer å¯ä»¥è½¬æ¢ä¸º ä»»ä½•æŒ‡é’ˆ uintptr å¯ä»¥è½¬æ¢ä¸º unsafe.Pointer unsafe.Pointer å¯ä»¥è½¬æ¢ä¸º uintptr å‰é¢ä¸¤ä¸ªè§„åˆ™æˆ‘ä»¬åˆšåˆšå·²ç»æ¼”ç¤ºäº†ï¼Œä¸»è¦ç”¨äº *T1 å’Œ *T2 ä¹‹é—´çš„è½¬æ¢ï¼Œé‚£ä¹ˆæœ€åä¸¤ä¸ªè§„åˆ™æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ *T æ˜¯ ä¸èƒ½è®¡ç®—åç§»é‡ çš„ï¼Œä¹Ÿä¸èƒ½è¿›è¡Œè®¡ç®—ï¼Œä½†æ˜¯uintptrå¯ä»¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠæŒ‡é’ˆè½¬ä¸ºuintptrå†è¿›è¡Œåç§»è®¡ç®—ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è®¿é—®ç‰¹å®šçš„å†…å­˜äº†ï¼Œè¾¾åˆ°å¯¹ä¸åŒçš„å†…å­˜è¯»å†™çš„ç›®çš„ã€‚ ä¸‹é¢æˆ‘ä»¬ä»¥é€šè¿‡æŒ‡é’ˆåç§» ä¿®æ”¹Structç»“æ„ä½“å†…çš„å­—æ®µä¸ºä¾‹ï¼Œæ¥æ¼”ç¤º uintptr çš„ç”¨æ³•ã€‚ 1234567891011121314151617func main() &#123; u:=new(user) fmt.Println(*u) pName:=(*string)(unsafe.Pointer(u)) *pName=\"å¼ ä¸‰\" pAge:=(*int)(unsafe.Pointer(uintptr(unsafe.Pointer(u))+unsafe.Offsetof(u.age))) *pAge = 20 fmt.Println(*u)&#125;type user struct &#123; name string age int&#125; ä»¥ä¸Šæˆ‘ä»¬é€šè¿‡å†…å­˜åç§»çš„æ–¹å¼ï¼Œå®šä½åˆ°æˆ‘ä»¬éœ€è¦æ“ä½œçš„å­—æ®µï¼Œç„¶åæ”¹å˜ä»–ä»¬çš„å€¼ã€‚ ç¬¬ä¸€ä¸ªä¿®æ”¹userçš„nameå€¼çš„æ—¶å€™ï¼Œå› ä¸ºnameæ˜¯ç¬¬ä¸€ä¸ªå­—æ®µï¼Œæ‰€ä»¥ä¸ç”¨åç§»ï¼Œæˆ‘ä»¬è·å–userçš„æŒ‡é’ˆï¼Œç„¶åé€šè¿‡ unsafe.Pointer è½¬ä¸º*string è¿›è¡Œèµ‹å€¼æ“ä½œå³å¯ã€‚ ç¬¬äºŒä¸ªä¿®æ”¹userçš„ageå€¼çš„æ—¶å€™ï¼Œå› ä¸ºageä¸æ˜¯ç¬¬ä¸€ä¸ªå­—æ®µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†…å­˜åç§»ï¼Œå†…å­˜åç§»ç‰µæ¶‰åˆ°çš„è®¡ç®—åªèƒ½é€šè¿‡uintptrï¼Œæ‰€æˆ‘ä»¬è¦å…ˆæŠŠuserçš„æŒ‡é’ˆåœ°å€è½¬ä¸ºuintptrï¼Œç„¶åæˆ‘ä»¬å†é€šè¿‡unsafe.Offsetof(u.age)è·å–éœ€è¦åç§»çš„å€¼ï¼Œè¿›è¡Œåœ°å€è¿ç®—(+)åç§»å³å¯ã€‚ ç°åœ¨åç§»åï¼Œåœ°å€å·²ç»æ˜¯userçš„ageå­—æ®µäº†ï¼Œå¦‚æœè¦ç»™å®ƒèµ‹å€¼ï¼Œæˆ‘ä»¬éœ€è¦æŠŠuintptrè½¬ä¸º*intæ‰å¯ä»¥ã€‚æ‰€ä»¥æˆ‘ä»¬é€šè¿‡æŠŠuintptrè½¬ä¸ºunsafe.Pointer,å†è½¬ä¸º*intå°±å¯ä»¥æ“ä½œäº†ã€‚ è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç¬¬äºŒä¸ªåç§»çš„è¡¨è¾¾å¼éå¸¸é•¿ï¼Œä½†æ˜¯ä¹Ÿåƒä¸‡ä¸è¦æŠŠä»–ä»¬åˆ†æ®µï¼Œä¸èƒ½åƒä¸‹é¢è¿™æ ·ã€‚ 123temp:=uintptr(unsafe.Pointer(u))+unsafe.Offsetof(u.age)pAge:=(*int)(unsafe.Pointer(temp))*pAge = 20 æ ˆå†…æŒ‡é’ˆåœ¨æ ˆæ‰©å®¹çš„æ—¶å€™ï¼Œæœ‰äº†æ–°çš„åœ°å€ï¼Œå› æ­¤uintptråªèƒ½ä½œä¸ºæŒ‡é’ˆè®¡ç®—çš„ä¸­é—´æ€ï¼Œä¸å…è®¸ä½¿ç”¨å˜é‡ä¿å­˜uintptrçš„å€¼ã€‚ å°ç»“unsafeæ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°½å¯èƒ½å°‘çš„ä½¿ç”¨å®ƒï¼Œæ¯”å¦‚å†…å­˜çš„æ“çºµï¼Œè¿™æ˜¯ç»•è¿‡Goæœ¬èº«è®¾è®¡çš„å®‰å…¨æœºåˆ¶çš„ï¼Œä¸å½“çš„æ“ä½œï¼Œå¯èƒ½ä¼šç ´åä¸€å—å†…å­˜ï¼Œè€Œä¸”è¿™ç§é—®é¢˜éå¸¸ä¸å¥½å®šä½ã€‚ å½“ç„¶å¿…é¡»çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒï¼Œæ¯”å¦‚åº•å±‚ç±»å‹ç›¸åŒçš„æ•°ç»„ä¹‹é—´çš„è½¬æ¢ï¼›æ¯”å¦‚ä½¿ç”¨sync/atomicåŒ…ä¸­çš„ä¸€äº›å‡½æ•°æ—¶ï¼›è¿˜æœ‰è®¿é—®Structçš„ç§æœ‰å­—æ®µæ—¶ï¼Œè¯¥ç”¨è¿˜æ˜¯è¦ç”¨ï¼Œä¸è¿‡ä¸€å®šè¦æ…ä¹‹åˆæ…ã€‚ æ•´ä¸ªunsafeåŒ…éƒ½æ˜¯ç”¨äºGoç¼–è¯‘å™¨çš„ï¼Œä¸ç”¨è¿è¡Œæ—¶ï¼Œåœ¨æˆ‘ä»¬ç¼–è¯‘çš„æ—¶å€™ï¼ŒGoç¼–è¯‘å™¨å·²ç»æŠŠä»–ä»¬éƒ½å¤„ç†äº†ã€‚","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- flume + kudu æ“ä½œæŒ‡å—","slug":"å¤§æ•°æ®/flume+kudu","date":"2021-01-05T01:56:40.000Z","updated":"2021-03-20T16:25:01.815Z","comments":true,"path":"2021/01/05/å¤§æ•°æ®/flume+kudu/","link":"","permalink":"http://blog.crazylaw.cn/2021/01/05/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume+kudu/","excerpt":"å‰è¨€ç”±äºæˆ‘ä»¬è¦å°è¯•ä½¿ç”¨kuduï¼Œæ¶æ„æ˜¯ç”±flume-&gt;kudu","text":"å‰è¨€ç”±äºæˆ‘ä»¬è¦å°è¯•ä½¿ç”¨kuduï¼Œæ¶æ„æ˜¯ç”±flume-&gt;kudu [kudu-flume-sink(v1.9)] (https://github.com/apache/kudu/blob/1.9.0/java/kudu-flume-sink/src/main/java/org/apache/kudu/flume/sink/KuduSink.java) 1.9 Configuration of KuDu Sink: Property Name Default Required Description channel - Yes è¦ç»‘å®šè¯»å–çš„channel type - Yes ç»„ä»¶åï¼Œå¿…é¡»å¡«å†™org.apache.kudu.flume.sink.KuduSink masterAddresses - Yes é€—å·åˆ†éš”kudu masteråœ°å€ï¼Œä¾‹å­: host1:port1,host2:port2,å…¶ä¸­ç«¯å£æ˜¯é€‰å¡« tableName - Yes è¦å†™å…¥çš„kuduè¡¨å batchSize 1000 No sinkæ¯æ‰¹æ¬¡å¤„ç†æœ€å¤§æ•° ignoreDuplicateRows true No æ˜¯å¦å¿½ç•¥æ’å…¥å¯¼è‡´çš„é‡å¤ä¸»é”®é”™è¯¯ã€‚ timeoutMillis 10000 No Kuduå†™æ“ä½œçš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ producer SimpleKuduOperationsProducer No æ¥æ”¶å™¨åº”è¯¥ä½¿ç”¨å®ç°äº†çš„KuduOperationsProducer æ¥å£çš„çš„å®Œå…¨é™å®šç±»åã€‚ producer.* - (Varies by operations producer) è¦ä¼ é€’ç»™æ“ä½œç”Ÿäº§è€…å®ç°çš„é…ç½®å±æ€§ã€‚ ç”±äºè¿™ç§æ–¹å¼å¿…é¡»ä¸€ä¸ªsinkå¯¹åº”ä¸€ä¸ªtableï¼Œä¸ç¬¦åˆæˆ‘ä»¬çš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬è¯¥ç”¨äº†å…¶ä»–æ–¹æ¡ˆã€‚æ–‡ç« å¾…å®šã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"flume","slug":"flume","permalink":"http://blog.crazylaw.cn/tags/flume/"},{"name":"kudu","slug":"kudu","permalink":"http://blog.crazylaw.cn/tags/kudu/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- è®°ä¸€æ¬¡åä¸ºäº‘å¤§æ•°æ®æœåŠ¡å¯¹æ¥é—®é¢˜è®°å½•","slug":"å¤§æ•°æ®/è®°ä¸€æ¬¡åä¸ºäº‘å¤§æ•°æ®æœåŠ¡å¯¹æ¥é—®é¢˜è®°å½•","date":"2021-01-05T01:56:40.000Z","updated":"2021-05-14T09:05:22.942Z","comments":true,"path":"2021/01/05/å¤§æ•°æ®/è®°ä¸€æ¬¡åä¸ºäº‘å¤§æ•°æ®æœåŠ¡å¯¹æ¥é—®é¢˜è®°å½•/","link":"","permalink":"http://blog.crazylaw.cn/2021/01/05/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%AF%B9%E6%8E%A5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/","excerpt":"å‰è¨€ç”±äºæˆ‘ä»¬åœ¨è°ƒç ”æ˜¯å¦è®©è‡ªå»ºIDCå¤§æ•°æ®æœºæˆ¿ä¸Šäº‘æœåŠ¡ï¼Œæ‰€ä»¥åä¸ºäº‘è¿›è¡Œä¸€ä¸‹æµ‹è¯•ã€‚","text":"å‰è¨€ç”±äºæˆ‘ä»¬åœ¨è°ƒç ”æ˜¯å¦è®©è‡ªå»ºIDCå¤§æ•°æ®æœºæˆ¿ä¸Šäº‘æœåŠ¡ï¼Œæ‰€ä»¥åä¸ºäº‘è¿›è¡Œä¸€ä¸‹æµ‹è¯•ã€‚ é—®é¢˜ä¸€ï¼šimpalaçš„è¿æ¥é—®é¢˜ç”±äºæˆ‘ä»¬å¼€å¯äº†Kerberosï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç»ˆç«¯æ‰§è¡Œimpala-shellçš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯è¿ä¸ä¸Šçš„ã€‚éœ€è¦é€šè¿‡Kerberosè¿›è¡Œèº«ä»½æ ¡éªŒå’Œæˆæƒæ‰å¯ä»¥è®¿é—®ã€‚ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåå­—å«hiveuserçš„è´¦å·ï¼Œç›®å‰æ‰€æœ‰çš„ç»„ä»¶æœåŠ¡éƒ½é€šè¿‡è¯¥è´¦å·è¿›è¡Œè®¿é—®ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆå§‹åŒ–å’Œç»­æœŸå‡­æ® 12345678910111213141516[root@node-str-coreoVpr ~]# impala-shellStarting Impala Shell without Kerberos authenticationError connecting: TTransportException, Could not connect to node-str-coreoVpr:21000Kerberos ticket found in the credentials cache, retrying the connection with a secure transport.Error connecting: TTransportException, Could not connect to node-str-coreoVpr:21000***********************************************************************************Welcome to the Impala shell.(Impala Shell v3.2.0 (f63543a) built on Wed Nov 6 11:46:33 CST 2019)Want to know what version of Impala you&#39;re connected to? Run the VERSION command tofind out!***********************************************************************************[Not connected] &gt; quit;Connection lost, reconnecting...Error connecting: TTransportException, Could not connect to node-str-coreoVpr:21000Goodbye root å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ˜¯è¿ä¸ä¸Šçš„ã€‚ 123456789[root@node-str-coreoVpr ~]# kinit hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COMPassword for hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM:[root@node-str-coreoVpr ~]# klistTicket cache: FILE:&#x2F;tmp&#x2F;krb5cc_0Default principal: hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COMValid starting Expires Service principal01&#x2F;05&#x2F;2021 17:05:25 01&#x2F;06&#x2F;2021 17:05:21 krbtgt&#x2F;122451B2_394D_494B_9FCA_B045F596D6D4.COM@122451B2_394D_494B_9FCA_B045F596D6D4.COM å†æ¬¡å°è¯•è¿æ¥ 123456789101112131415[root@node-str-coreoVpr ~]# impala-shell -i node-ana-coretXnLStarting Impala Shell without Kerberos authenticationOpened TCP connection to node-ana-coretXnL:21000Error connecting: TTransportException, TSocket read 0 bytesKerberos ticket found in the credentials cache, retrying the connection with a secure transport.Opened TCP connection to node-ana-coretXnL:21000Connected to node-ana-coretXnL:21000Server version: impalad version 3.2.0 RELEASE (build 83150778f5d85f48878f611da47face9328e9e6a)***********************************************************************************Welcome to the Impala shell.(Impala Shell v3.2.0 (f63543a) built on Wed Nov 6 11:46:33 CST 2019)Press TAB twice to see a list of available commands.***********************************************************************************[node-ana-coretXnL:21000] default&gt; å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»å¯ä»¥è¿æ¥ä¸Šäº†ã€‚ é—®é¢˜ä¸€ï¼šflume &amp;&amp; kuduç›®å‰ï¼Œæˆ‘ä»¬å¯¹åŸºæœ¬é…ç½®å¦‚ä¸‹ï¼š æœåŠ¡ ç‰ˆæœ¬ flume 1.6 kudu 1.9 Kerberos ç”±äºflumeå®˜æ–¹æ²¡æœ‰æä¾›å¯¹åº”çš„sinkã€‚ä½†æ˜¯kuduæœ‰æä¾›ï¼Œæ‰€ä»¥æˆ‘å»æ‰¾äº†kuduçš„sinkçš„jaråº“ä¸‹æ¥ã€‚è€Œç‰ˆæœ¬å¯¹åº”å˜›ï¼Œä¸€å¼€å§‹æˆ‘ä»¬ä½¿ç”¨å’Œkuduä¸€æ ·çš„1.9ç‰ˆæœ¬ï¼Œå‘ç°apiå¯¹åº”ä¸ä¸Šã€‚æŸ¥é˜…äº†èµ„æ–™ä¹‹åï¼Œé€‰æ‹©äº†1.4ç‰ˆæœ¬ã€‚ kudu-flume-sink-1.4.jar éœ€è¦æŠŠjaråŒ…æ”¾åœ¨ javaè¿è¡Œç¨‹åºçš„ classpathç›®å½•ä¸‹ï¼Œä¹Ÿå°±æ˜¯ -cp å‚æ•°çš„ç›®å½•ä¸‹ã€‚ç”±äºä¸æƒ³é€šè¿‡ä¿®æ”¹GC_OPTSæ¥æŒ‡å®šç›®å½•ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©äº†æ”¾åœ¨ /opt/Bigdata/MRS_2.1.0/install/FusionInsight-Flume-1.6.0/flume/lib/* ç›®å½•ä¸‹ã€‚ å¯æ˜¯è°æ›¾æƒ³æœ€åè¿˜è¦æ˜¯åŠ¨åˆ° GC_OPTSåˆ°å‚æ•°é…ç½® è¿˜æ˜¯ç±»ä¼¼çš„é—®é¢˜ï¼Œç›®å‰é‡åˆ°çš„é—®é¢˜å‡ ä¹éƒ½æ˜¯ Kerberos å¼•èµ·çš„ã€‚å› ä¸ºä»¥å¾€æˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨ Kerberos ä½œä¸ºèº«ä»½è®¤è¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# &#x3D; å®šä¹‰ä¿¡æ¯ &#x3D;# &#x3D; åä¸ºäº‘Agentå¿…å¡«: &#x3D;# &#x3D; - server &#x3D;# &#x3D; Agentä¸­å­˜åœ¨çš„sources: &#x3D;# &#x3D; - src_http_41600 &#x3D;# &#x3D; Agentä¸­å­˜åœ¨çš„channels: &#x3D;# &#x3D; - ch_kudu_table &#x3D;# &#x3D; Agentä¸­å­˜åœ¨çš„sinks: &#x3D;# &#x3D; - sink_kudu_table &#x3D;# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;server.sources &#x3D; src_http_41600server.channels &#x3D; ch_kudu_tableserver.sinks &#x3D; sink_kudu_table# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# &#x3D; Http Source &#x3D;# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;server.sources.src_http_41600.type &#x3D; httpserver.sources.src_http_41600.port &#x3D; 41600server.sources.src_http_41600.channels &#x3D; ch_kudu_table# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# &#x3D; Http-Kudu&#39;s Channel &#x3D;# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;server.channels.ch_kudu_table.type &#x3D; memoryserver.channels.ch_kudu_table.capacity &#x3D; 1000server.channels.ch_kudu_table.transactionCapacity &#x3D; 100# server.sinks.sink_kudu_table.type &#x3D; logger# server.sinks.sink_kudu_table.channel &#x3D; ch_kudu_table# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# &#x3D; Kudu Sink &#x3D;# &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;# ç»„ä»¶åï¼Œå¿…é¡»å¡«å†™&#96;org.apache.kudu.flume.sink.KuduSink&#96;server.sinks.sink_kudu_table.type &#x3D; org.apache.kudu.flume.sink.KuduSink# è¦ç»‘å®šè¯»å–çš„channelserver.sinks.sink_kudu_table.channel &#x3D; ch_kudu_tableserver.sinks.sink_kudu_table.masterAddresses &#x3D; node-master1rfFB,node-ana-corezDdi,node-master2RSDtserver.sinks.sink_kudu_table.tableName &#x3D; impala::kudu_test.my_first_table æµ‹è¯•çš„æ—¶å€™æ‰€é‡‡ç”¨çš„é…ç½®å¦‚ä¸Š 1omm 17051 1 0 11:31 ? 00:00:09 &#x2F;opt&#x2F;Bigdata&#x2F;jdk1.8.0_212&#x2F;&#x2F;bin&#x2F;java -XX:OnOutOfMemoryError&#x3D;bash &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;bin&#x2F;out_memory_error.sh &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc %p -Xms2G -Xmx4G -XX:CMSFullGCsBeforeCompaction&#x3D;1 -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -Djava.security.krb5.conf&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;krb5.conf -Djava.security.auth.login.config&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf -Dzookeeper.request.timeout&#x3D;120000 -Djavax.security.auth.useSubjectCredsOnly&#x3D;false -verbose:gc -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles&#x3D;10 -XX:GCLogFileSize&#x3D;1M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:&#x2F;var&#x2F;log&#x2F;Bigdata&#x2F;flume&#x2F;&#x2F;flume&#x2F;flume-omm-20210106113125-%p-gc.log -Djava.security.krb5.conf&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_5_KerberosClient&#x2F;etc&#x2F;kdc.conf -Djava.security.auth.login.config&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf -Dzookeeper.server.principal&#x3D;zookeeper&#x2F;hadoop.122451b2_394d_494b_9fca_b045f596d6d4.com -Dzookeeper.request.timeout&#x3D;120000 -Dsolrclient.token.enabled&#x3D;false -Dcom.amazonaws.sdk.disableCertChecking&#x3D;true -Dnet.sf.ehcache.skipUpdateCheck&#x3D;true -Dflume.instance.id&#x3D;1000 -Dflume.role&#x3D;server -Dlog4j.configuration.watch&#x3D;true -Dlog4j.configuration&#x3D;log4j.properties -Dflume_log_dir&#x3D;&#x2F;var&#x2F;log&#x2F;Bigdata&#x2F;flume&#x2F;&#x2F;flume&#x2F; -Dflume.monitoring.type&#x3D;http -Dflume.monitoring.port&#x3D;21150 -Dbeetle.application.home.path&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;conf&#x2F;service -Dflume.called.from.service -Dflume.conf.dir&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc -Dflume.metric.conf.dir&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;conf -Dflume.script.home&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;bin -cp &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;*:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;conf&#x2F;service&#x2F; -Djava.library.path&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;plugins.d&#x2F;native&#x2F;native org.apache.flume.node.Application --conf-file &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;properties.properties --name server å¯åŠ¨çš„å‚æ•°å¦‚ä¸Šï¼Œå…¶ä¸­æœ‰å‡ ä¸ªå‚æ•°æ˜¯æˆ‘åé¢åŠ çš„ï¼š -Djava.security.krb5.conf=/opt/Bigdata/MRS_2.1.0/1_7_Flume/etc/krb5.conf ï¼ˆæŒ‡å®škrb5çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼‰ -Djava.security.auth.login.config=/opt/Bigdata/MRS_2.1.0/1_7_Flume/etc/jaas.conf (è·å–jassçš„è®¤è¯é…ç½®æ–‡ä»¶è·¯å¾„) -Dzookeeper.request.timeout=120000 -Djavax.security.auth.useSubjectCredsOnly=false (é€šè¿‡åº•å±‚è·å–å‡­æ®) 123456789101112131415161718192021222324252627282930[root@node-str-coreoVpr ~]# cat &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.confKafkaClient &#123;com.sun.security.auth.module.Krb5LoginModule requireduseKeyTab&#x3D;truekeyTab&#x3D;&quot;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;user.keytab&quot;principal&#x3D;&quot;hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM&quot;storeKey&#x3D;trueuseTicketCache&#x3D;false;&#125;;Client &#123;com.sun.security.auth.module.Krb5LoginModule requiredstoreKey&#x3D;trueprincipal&#x3D;&quot;hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM&quot;useTicketCache&#x3D;falsekeyTab&#x3D;&quot;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;user.keytab&quot;debug&#x3D;trueuseKeyTab&#x3D;true;&#125;;com.sun.security.jgss.initiate &#123;com.sun.security.auth.module.Krb5LoginModule requireduseKeyTab&#x3D;trueuseTicketCache&#x3D;falsedoNotPrompt&#x3D;truestoreKey&#x3D;trueprincipal&#x3D;&quot;hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM&quot;keyTab&#x3D;&quot;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;user.keytab&quot;debug&#x3D;true;&#125;; ç”±äºåä¸ºäº‘è‡ªå·±ä¿®æ”¹è¿‡éƒ¨åˆ†ç»„ä»¶ï¼Œæ‰€ä»¥ä¸å¤ªç¡®å®šä¸ºä»€ä¹ˆå‡­æ®ä¸€ç›´å¤±è´¥ï¼Œæ‰€ä»¥æˆ‘åŠ äº† -Djavax.security.auth.useSubjectCredsOnly=false å‚æ•°ï¼Œè¿™æ˜¯è®©æˆ‘ä»¬ä»åº•å±‚å»æ‹¿å‡­æ®ï¼Œè€Œé»˜è®¤æ‹¿çš„sectionéƒ¨åˆ†å°±æ˜¯ com.sun.security.jgss.initiateè¯¦è§æºç ,æ‰€ä»¥åŠ ä¸Šäº† com.sun.security.jgss.initiate ä¹‹åï¼Œflumeå°±å¯ä»¥è¿æ¥ä¸Šäº†kudu. ä»¥ä¸‹æ˜¯æˆ‘è°ƒè¯•çš„æ—¶å€™é‡åˆ°çš„é—®é¢˜ã€‚ GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos Ticket) Cause: This may occur if no valid Kerberos credentials are obtained. In particular, this occurs if you want the underlying mechanism to obtain credentials but you forgot to indicate this by setting the javax.security.auth.useSubjectCredsOnly system property value to false (for example via -Djavax.security.auth.useSubjectCredsOnly=false in your execution command). GSSException: No valid credentials provided (Mechanism level: Attempt to obtain new INITIATE credentials failed! (null)) . . . Caused by: javax.security.auth.login.LoginException: Clock skew too great Cause: Kerberos requires the time on the KDC and on the client to be loosely synchronized. (The default is within 5 minutes.) If thatâ€™s not the case, you will get this error. é™„ä¸Š jgss çš„å¼‚å¸¸å°è¯•è§£å†³æ–¹æ¡ˆå®˜æ–¹æ–‡æ¡£, PSï¼šåæ­£æˆ‘æ ¹æ®æ–‡æ¡£æ²¡è§£å†³ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯åè¿è‡ªå·±ä¿®æ”¹çš„éƒ¨åˆ†æœ‰ä»€ä¹ˆæ½œè§„åˆ™ã€‚æ‰€ä»¥æˆ‘æ‰é‡‡ç”¨é»˜è®¤çš„jassé…ç½®ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748492021-01-06 11:31:26,235 | INFO | [lifecycleSupervisor-1-0] | Configuration provider starting | org.apache.flume.node.PollingPropertiesFileConfigurationProvider.start(PollingPropertiesFileConfigurationProvider.java:61)2021-01-06 11:31:26,239 | INFO | [conf-file-poller-0] | Reloading configuration file:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;properties.properties | org.apache.flume.node.PollingPropertiesFileConfigurationProvider$FileWatcherRunnable.run(PollingPropertiesFileConfigurationProvider.java:133)2021-01-06 11:31:26,236 | INFO | [main] | starting taskCounter | org.apache.flume.tools.FlumeMetricsMgr.start(FlumeMetricsMgr.java:230)2021-01-06 11:31:26,250 | INFO | [conf-file-poller-0] | Processing:sink_kudu_table | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)2021-01-06 11:31:26,250 | INFO | [conf-file-poller-0] | Processing:sink_kudu_table | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)2021-01-06 11:31:26,250 | INFO | [conf-file-poller-0] | Processing:sink_kudu_table | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)2021-01-06 11:31:26,251 | INFO | [conf-file-poller-0] | Processing:sink_kudu_table | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)2021-01-06 11:31:26,251 | INFO | [conf-file-poller-0] | Added sinks: sink_kudu_table Agent: server | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:931)2021-01-06 11:31:26,262 | INFO | [conf-file-poller-0] | Post-validation flume configuration contains configuration for agents: [server] | org.apache.flume.conf.FlumeConfiguration.validateConfiguration(FlumeConfiguration.java:141)2021-01-06 11:31:26,263 | INFO | [conf-file-poller-0] | Creating channels | org.apache.flume.node.AbstractConfigurationProvider.loadChannels(AbstractConfigurationProvider.java:155)2021-01-06 11:31:26,270 | INFO | [conf-file-poller-0] | Creating instance of channel ch_kudu_table type memory | org.apache.flume.channel.DefaultChannelFactory.create(DefaultChannelFactory.java:42)2021-01-06 11:31:26,274 | INFO | [conf-file-poller-0] | Created channel ch_kudu_table | org.apache.flume.node.AbstractConfigurationProvider.loadChannels(AbstractConfigurationProvider.java:210)2021-01-06 11:31:26,274 | INFO | [conf-file-poller-0] | Creating instance of source src_http_41600, type http | org.apache.flume.source.DefaultSourceFactory.create(DefaultSourceFactory.java:41)2021-01-06 11:31:26,289 | INFO | [main] | Monitored counter group for type: OTHER, name: taskcount: Successfully registered new MBean. | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132)2021-01-06 11:31:26,290 | INFO | [main] | Component type: OTHER, name: taskcount started | org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:105)2021-01-06 11:31:26,323 | INFO | [conf-file-poller-0] | Creating instance of sink: sink_kudu_table, type: org.apache.kudu.flume.sink.KuduSink | org.apache.flume.sink.DefaultSinkFactory.create(DefaultSinkFactory.java:42)2021-01-06 11:31:26,328 | WARN | [conf-file-poller-0] | No Kudu operations producer provided, using default | org.apache.kudu.flume.sink.KuduSink.configure(KuduSink.java:202)2021-01-06 11:31:26,330 | INFO | [conf-file-poller-0] | Channel ch_kudu_table connected to [src_http_41600, sink_kudu_table] | org.apache.flume.node.AbstractConfigurationProvider.getConfiguration(AbstractConfigurationProvider.java:124)2021-01-06 11:31:26,413 | INFO | [main] | ServiceServer started (at port[21151]) | org.wcc.framework.business.service.server.ServiceServer.start(ServiceServer.java:260)2021-01-06 11:31:26,413 | INFO | [main] | flume meric server startred ip:192.168.0.222,port:21151. | org.apache.flume.tools.FlumeMetricsMgr.initMetricsRpcServer(FlumeMetricsMgr.java:84)2021-01-06 11:31:26,413 | INFO | [main] | current role is server | org.apache.flume.tools.FlumeMetricsMgr.start(FlumeMetricsMgr.java:237)2021-01-06 11:31:26,429 | INFO | [main] | Logging to org.slf4j.impl.Log4jLoggerAdapter(org.mortbay.log) via org.mortbay.log.Slf4jLog | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)2021-01-06 11:31:26,430 | INFO | [main] | jetty-6.1.26 | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)2021-01-06 11:31:26,441 | INFO | [main] | Started SelectChannelConnector@localhost:21150 | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)2021-01-06 11:31:26,442 | INFO | [main] | starting compment mon | org.apache.flume.node.Application.startCompMon(Application.java:543)2021-01-06 11:31:26,443 | INFO | [main] | started compment mon success | org.apache.flume.node.Application.startCompMon(Application.java:582)2021-01-06 11:31:26,443 | INFO | [main] | log4j dynamic load is start. | org.apache.flume.tools.LogDynamicLoad.start(LogDynamicLoad.java:59)2021-01-06 11:31:26,444 | INFO | [conf-file-poller-0] | stopping compment mon | org.apache.flume.node.Application.stopCompMon(Application.java:587)2021-01-06 11:31:26,444 | INFO | [conf-file-poller-0] | stopped compment mon success | org.apache.flume.node.Application.stopCompMon(Application.java:608)2021-01-06 11:31:26,444 | INFO | [conf-file-poller-0] | Starting new configuration:&#123; sourceRunners:&#123;src_http_41600&#x3D;EventDrivenSourceRunner: &#123; source:org.apache.flume.source.http.HTTPSource&#123;name:src_http_41600,state:IDLE&#125; &#125;&#125; sinkRunners:&#123;sink_kudu_table&#x3D;SinkRunner: &#123; policy:org.apache.flume.sink.DefaultSinkProcessor@1e1f84ee counterGroup:&#123; name:null counters:&#123;&#125; &#125; &#125;&#125; channels:&#123;ch_kudu_table&#x3D;org.apache.flume.channel.MemoryChannel&#123;name: ch_kudu_table&#125;&#125; &#125; | org.apache.flume.node.Application.startAllComponents(Application.java:206)2021-01-06 11:31:26,498 | INFO | [conf-file-poller-0] | current role is server | org.apache.flume.tools.FlumeSendAlarmMgr.start(FlumeSendAlarmMgr.java:173)2021-01-06 11:31:26,505 | INFO | [conf-file-poller-0] | Starting Channel ch_kudu_table | org.apache.flume.node.Application.startAllComponents(Application.java:217)2021-01-06 11:31:26,508 | INFO | [lifecycleSupervisor-1-0] | Monitored counter group for type: CHANNEL, name: ch_kudu_table: Successfully registered new MBean. | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132)2021-01-06 11:31:26,508 | INFO | [lifecycleSupervisor-1-0] | Component type: CHANNEL, name: ch_kudu_table started | org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:105)2021-01-06 11:31:26,508 | INFO | [conf-file-poller-0] | Starting Sink sink_kudu_table | org.apache.flume.node.Application.startAllComponents(Application.java:245)2021-01-06 11:31:26,508 | INFO | [conf-file-poller-0] | Starting Source src_http_41600 | org.apache.flume.node.Application.startAllComponents(Application.java:256)2021-01-06 11:31:26,510 | INFO | [conf-file-poller-0] | Begin start init plugins. | com.huawei.flume.PluginManager.PluginManager.&lt;init&gt;(PluginManager.java:39)2021-01-06 11:31:26,510 | INFO | [conf-file-poller-0] | Set plugins configuration file dir successful. | com.huawei.flume.PluginManager.PluginManager.&lt;init&gt;(PluginManager.java:46)2021-01-06 11:31:26,511 | INFO | [conf-file-poller-0] | Reading monitor server configuration from: &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;flume-check.properties | com.huawei.flume.configuration.AbstractPluginsConfiguration.loadConfig(AbstractPluginsConfiguration.java:75)2021-01-06 11:31:26,517 | WARN | [conf-file-poller-0] | Needn&#39;t to create PluginsManager, plugins is empty. | com.huawei.flume.PluginManager.PluginManager.&lt;init&gt;(PluginManager.java:55)2021-01-06 11:31:26,517 | WARN | [conf-file-poller-0] | Have not set any plugins | com.huawei.flume.PluginManager.PluginManager.start(PluginManager.java:98)2021-01-06 11:31:26,517 | INFO | [conf-file-poller-0] | starting compment mon | org.apache.flume.node.Application.startCompMon(Application.java:543)2021-01-06 11:31:26,517 | INFO | [conf-file-poller-0] | started compment mon success | org.apache.flume.node.Application.startCompMon(Application.java:582)2021-01-06 11:31:26,542 | INFO | [lifecycleSupervisor-1-0] | jetty-6.1.26 | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)2021-01-06 11:31:26,577 | INFO | [lifecycleSupervisor-1-0] | Started SelectChannelConnector@0.0.0.0:41600 | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)2021-01-06 11:31:26,578 | INFO | [lifecycleSupervisor-1-0] | Monitored counter group for type: SOURCE, name: src_http_41600: Successfully registered new MBean. | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132)2021-01-06 11:31:26,578 | INFO | [lifecycleSupervisor-1-0] | Component type: SOURCE, name: src_http_41600 started | org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:105)2021-01-06 11:31:27,187 | INFO | [lifecycleSupervisor-1-3] | Monitored counter group for type: SINK, name: sink_kudu_table: Successfully registered new MBean. | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132) å¯ä»¥çœ‹åˆ°ï¼Œsinkå¯åŠ¨æˆåŠŸã€‚ è®°å½•å‡ ä¸ªéœ€è¦ç”¨åˆ°çš„å‘½ä»¤ï¼š åŒæ­¥kudu-flume-sinkåˆ°å„flumeèŠ‚ç‚¹1str_nodes&#x3D;&quot;node-str-corelgoh node-str-corenydJ node-str-coreoVpr&quot;;for ip in $(echo $&#123;str_nodes&#125;);do scp &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;kudu-flume-sink-1.4.0.jar $&#123;ip&#125;:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;;ssh $&#123;ip&#125; &#39;chmod 751 &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;kudu-flume-sink-1.4.0.jar &amp;&amp; chown omm:ficommon &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;kudu-flume-sink-1.4.0.jar&#39;;done ä¿®æ”¹å¯¹åº”çš„jassé…ç½® å’Œ å‡­æ®ä¿¡æ¯åŒæ­¥1str_nodes&#x3D;&quot;node-str-corelgoh node-str-corenydJ node-str-coreoVpr&quot;;for ip in $(echo $&#123;str_nodes&#125;);do scp &#x2F;tmp&#x2F;krb5.conf $&#123;ip&#125;:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;; scp &#x2F;tmp&#x2F;user.keytab $&#123;ip&#125;:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;;ssh $&#123;ip&#125; &quot;sed -i -e &#39;&#x2F;principal&#x2F;s&#x2F;flume&#x2F;hiveuser&#x2F;g&#39; -e &#39;&#x2F;keyTab&#x2F;s&#x2F;\\&#x2F;opt\\&#x2F;Bigdata\\&#x2F;MRS_2.1.0\\&#x2F;install\\&#x2F;FusionInsight-Flume-1.6.0\\&#x2F;flume\\&#x2F;conf\\&#x2F;flume.keytab&#x2F;\\&#x2F;opt\\&#x2F;Bigdata\\&#x2F;MRS_2.1.0\\&#x2F;1_7_Flume\\&#x2F;etc\\&#x2F;user.keytab&#x2F;g&#39; -e &#39;&#x2F;^Client&#x2F;s&#x2F;Client&#x2F;com.sun.security.jgss.initiate&#x2F;g&#39; &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf;chown omm:wheel &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf;chown -R omm:wheel &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;&quot;;done è¿™ä¸ªä¸æ˜¯å‘½ä»¤ï¼Œä½†æ˜¯æ˜¯è®°å¾—æœ€æ–°çš„GC_OPTSå‚æ•°1-Xms2G -Xmx4G -XX:CMSFullGCsBeforeCompaction&#x3D;1 -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -Djava.security.krb5.conf&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;krb5.conf -Djava.security.auth.login.config&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf -Dzookeeper.request.timeout&#x3D;120000","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"flume","slug":"flume","permalink":"http://blog.crazylaw.cn/tags/flume/"},{"name":"kudu","slug":"kudu","permalink":"http://blog.crazylaw.cn/tags/kudu/"}]},{"title":"ã€æ•°æ®åº“å¼€å‘çŸ¥è¯†ã€‘Rocksdb","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†/Rocksdb","date":"2020-12-29T03:16:43.000Z","updated":"2021-03-20T16:25:01.817Z","comments":true,"path":"2020/12/29/æ•°æ®åº“å¼€å‘çŸ¥è¯†/Rocksdb/","link":"","permalink":"http://blog.crazylaw.cn/2020/12/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/Rocksdb/","excerpt":"å‰æ²¿è¿‘æ—¥å·¥ä½œä¸­ä½¿ç”¨äº† RocksDBã€‚RocksDB çš„ä¼˜ç‚¹æ­¤å¤„æ— éœ€å¤šè¯´ï¼Œå®ƒçš„ä¸€ä¸ª feature æ˜¯å…¶æœ‰å¾ˆå¤šä¼˜åŒ–é€‰é¡¹ç”¨äºå¯¹ RocksDB è¿›è¡Œè°ƒä¼˜ã€‚æ¬²ç†Ÿæ‚‰è¿™äº›å‚æ•°ï¼Œå¿…é¡»å¯¹å…¶èƒŒåçš„åŸç†æœ‰æ‰€äº†è§£ï¼Œæœ¬æ–‡ä¸»è¦æ•´ç†ä¸€äº› RocksDB çš„ wiki æ–‡æ¡£ï¼Œä»¥å¤‡è‡ªå·±å‚è€ƒä¹‹ç”¨ã€‚","text":"å‰æ²¿è¿‘æ—¥å·¥ä½œä¸­ä½¿ç”¨äº† RocksDBã€‚RocksDB çš„ä¼˜ç‚¹æ­¤å¤„æ— éœ€å¤šè¯´ï¼Œå®ƒçš„ä¸€ä¸ª feature æ˜¯å…¶æœ‰å¾ˆå¤šä¼˜åŒ–é€‰é¡¹ç”¨äºå¯¹ RocksDB è¿›è¡Œè°ƒä¼˜ã€‚æ¬²ç†Ÿæ‚‰è¿™äº›å‚æ•°ï¼Œå¿…é¡»å¯¹å…¶èƒŒåçš„åŸç†æœ‰æ‰€äº†è§£ï¼Œæœ¬æ–‡ä¸»è¦æ•´ç†ä¸€äº› RocksDB çš„ wiki æ–‡æ¡£ï¼Œä»¥å¤‡è‡ªå·±å‚è€ƒä¹‹ç”¨ã€‚ 1 Basic Operations å…ˆä»‹ç»ä¸€äº› RocksDB çš„åŸºæœ¬æ“ä½œå’ŒåŸºæœ¬æ¶æ„ã€‚ 1.1 LSM ä¸ WriteBatch å‚è€ƒæ–‡æ¡£5æåˆ°RocksDB æ˜¯ä¸€ä¸ªå¿«é€Ÿå­˜å‚¨ç³»ç»Ÿï¼Œå®ƒä¼šå……åˆ†æŒ–æ˜ Flash or RAM ç¡¬ä»¶çš„è¯»å†™ç‰¹æ€§ï¼Œæ”¯æŒå•ä¸ª KV çš„è¯»å†™ä»¥åŠæ‰¹é‡è¯»å†™ã€‚RocksDB è‡ªèº«é‡‡ç”¨çš„ä¸€äº›æ•°æ®ç»“æ„å¦‚ LSM/SKIPLIST ç­‰ç»“æ„ä½¿å¾—å…¶æœ‰è¯»æ”¾å¤§ã€å†™æ”¾å¤§å’Œç©ºé—´ä½¿ç”¨æ”¾å¤§çš„é—®é¢˜ã€‚ LSM å¤§è‡´ç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚LSM æ ‘è€Œä¸”é€šè¿‡æ‰¹é‡å­˜å‚¨æŠ€æœ¯è§„é¿ç£ç›˜éšæœºå†™å…¥é—®é¢˜ã€‚ LSM æ ‘çš„è®¾è®¡æ€æƒ³éå¸¸æœ´ç´ , å®ƒçš„åŸç†æ˜¯æŠŠä¸€é¢—å¤§æ ‘æ‹†åˆ†æˆNæ£µå°æ ‘ï¼Œ å®ƒé¦–å…ˆå†™å…¥åˆ°å†…å­˜ä¸­ï¼ˆå†…å­˜æ²¡æœ‰å¯»é“é€Ÿåº¦çš„é—®é¢˜ï¼Œéšæœºå†™çš„æ€§èƒ½å¾—åˆ°å¤§å¹…æå‡ï¼‰ï¼Œåœ¨å†…å­˜ä¸­æ„å»ºä¸€é¢—æœ‰åºå°æ ‘ï¼Œéšç€å°æ ‘è¶Šæ¥è¶Šå¤§ï¼Œå†…å­˜çš„å°æ ‘ä¼šflushåˆ°ç£ç›˜ä¸Šã€‚ç£ç›˜ä¸­çš„æ ‘å®šæœŸå¯ä»¥åš merge æ“ä½œï¼Œåˆå¹¶æˆä¸€æ£µå¤§æ ‘ï¼Œä»¥ä¼˜åŒ–è¯»æ€§èƒ½ã€è¯»æ•°æ®çš„è¿‡ç¨‹å¯èƒ½éœ€è¦ä»å†…å­˜ memtable åˆ°ç£ç›˜ sstfile è¯»å–å¤šæ¬¡ï¼Œç§°ä¹‹ä¸ºè¯»æ”¾å¤§ã€‘ã€‚RocksDB çš„ LSM ä½“ç°åœ¨å¤š level æ–‡ä»¶æ ¼å¼ä¸Šï¼Œæœ€çƒ­æœ€æ–°çš„æ•°æ®å°½åœ¨ L0 å±‚ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæœ€å†·æœ€è€çš„æ•°æ®å°½åœ¨ LN å±‚ï¼Œæ•°æ®åœ¨ç£ç›˜æˆ–è€…å›ºæ€ç›˜ä¸Šã€‚RocksDB è¿˜æœ‰ä¸€ç§æ—¥å¿—æ–‡ä»¶å«åš manifestï¼Œç”¨äºè®°å½•å¯¹ sstfile çš„æ›´æ”¹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ RocksDB çš„ GIFï¼Œåé¢å°†ä¼šè¯¦è¿°ã€‚ LSM-Tree(Log-Structured-Merge-Tree)LSMä»å‘½åä¸Šçœ‹ï¼Œå®¹æ˜“æœ›æ–‡ç”Ÿä¹‰æˆä¸€ä¸ªå…·ä½“çš„æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªtreeã€‚ä½†LSMå¹¶ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªtreeã€‚LSMæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„çš„æ¦‚å¿µï¼Œæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„çš„è®¾è®¡æ€æƒ³ã€‚å®é™…ä¸Šï¼Œè¦æ˜¯ç»™LSMçš„å‘½åæ–­å¥ï¼ŒLogå’ŒStructuredè¿™ä¸¤ä¸ªè¯æ˜¯åˆå¹¶åœ¨ä¸€èµ·çš„ï¼ŒLSM-Treeåº”è¯¥æ–­å¥æˆLog-Structuredã€Mergeã€Treeä¸‰ä¸ªè¯æ±‡ï¼Œè¿™ä¸‰ä¸ªè¯æ±‡åˆ†åˆ«å¯¹åº”ä»¥ä¸‹ä¸‰ç‚¹LSMçš„å…³é”®æ€§è´¨ï¼š å°†æ•°æ®å½¢æˆLog-Structuredï¼šåœ¨å°†æ•°æ®å†™å…¥LSMå†…å­˜ç»“æ„ä¹‹å‰ï¼Œå…ˆè®°å½•logã€‚è¿™æ ·LSMå°±å¯ä»¥å°†æœ‰æ˜“å¤±æ€§çš„å†…å­˜çœ‹åšæ°¸ä¹…æ€§å­˜å‚¨å™¨ã€‚å¹¶ä¸”ä¿¡ä»»å†…å­˜ä¸Šçš„æ•°æ®ï¼Œç­‰åˆ°å†…å­˜å®¹é‡è¾¾åˆ°thresholdå†é›†ä½“å†™å…¥ç£ç›˜ã€‚å°†æ•°æ®å½¢æˆLog-Structuredï¼Œä¹Ÿæ˜¯å°†æ•´ä½“å­˜å‚¨ç»“æ„è½¬æ¢æˆäº†â€œå†…å­˜(in-memory)â€å­˜å‚¨ç»“æ„ã€‚ å°†æ‰€æœ‰ç£ç›˜ä¸Šæ•°æ®ä¸ç»„ç»‡æˆä¸€ä¸ªæ•´ä½“ç´¢å¼•ç»“æ„ï¼Œè€Œç»„ç»‡æˆæœ‰åºçš„æ–‡ä»¶é›†ï¼šå› ä¸ºç£ç›˜éšæœºè¯»å†™æ¯”é¡ºåºè¯»å†™æ…¢3ä¸ªæ•°é‡çº§ï¼ŒLSMå°½é‡å°†ç£ç›˜è¯»å†™è½¬æ¢æˆé¡ºåºè¯»å†™ã€‚å°†ç£ç›˜ä¸Šçš„æ•°æ®ç»„ç»‡æˆBæ ‘è¿™æ ·çš„ä¸€ä¸ªæ•´ä½“ç´¢å¼•ç»“æ„ï¼Œè™½ç„¶æŸ¥æ‰¾å¾ˆé«˜æ•ˆï¼Œä½†æ˜¯é¢å¯¹éšæœºè¯»å†™ï¼Œç”±äºå¤§é‡å¯»é“å¯¼è‡´å…¶æ€§èƒ½ä¸ä½³ã€‚è€ŒLSMç”¨äº†ä¸€ç§å¾ˆæœ‰è¶£çš„æ–¹æ³•ï¼Œå°†æ‰€æœ‰æ•°æ®ä¸ç»„ç»‡æˆä¸€ä¸ªæ•´ä½“ç´¢å¼•ç»“æ„ï¼Œè€Œç»„ç»‡æˆæœ‰åºçš„æ–‡ä»¶é›†ã€‚æ¯æ¬¡LSMé¢å¯¹ç£ç›˜å†™ï¼Œå°†æ•°æ®å†™å…¥ä¸€ä¸ªæˆ–å‡ ä¸ªæ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼Œé¡ºåºå†™å…¥ä¸”ä¸èƒ½ä¿®æ”¹å…¶ä»–æ–‡ä»¶ï¼Œè¿™æ ·å°±å°†éšæœºè¯»å†™è½¬æ¢æˆäº†é¡ºåºè¯»å†™ã€‚LSMå°†ä¸€æ¬¡æ€§é›†ä½“å†™å…¥çš„æ–‡ä»¶ä½œä¸ºä¸€ä¸ªlevelï¼Œç£ç›˜ä¸Šåˆ’åˆ†å¤šlevelï¼Œlevelä¸levelä¹‹é—´äº’ç›¸éš”ç¦»ã€‚è¿™å°±å½¢æˆäº†ï¼Œä»¥å†™å…¥æ•°æ®æ—¶é—´çº¿å½¢æˆçš„é€»è¾‘ä¸Šã€è€Œéç‰©ç†ä¸Šçš„å±‚çº§ç»“æ„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆLSMè¢«å‘½åä¸ºâ€treeâ€œï¼Œä½†ä¸æ˜¯â€œtreeâ€ã€‚ å°†æ•°æ®æŒ‰keyæ’åºï¼Œåœ¨åˆå¹¶ä¸åŒfileã€levelä¸Šçš„æ•°æ®æ—¶ç±»ä¼¼merge-joinï¼šå¦‚æœä¸€ç›´ä¿æŒç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼Œä¸ä»…å†™å…¥ä¼šé€ æˆå†—ä½™ç©ºé—´ï¼Œè€Œä¸”ä¹Ÿä¼šå¤§é‡é™ä½è¯»çš„æ€§èƒ½ã€‚æ‰€ä»¥è¦é«˜æ•ˆçš„ã€å‘¨æœŸæ€§åˆå¹¶ä¸åŒfileã€levelã€‚è€Œå¦‚æœæ•°æ®æ˜¯ä¹±åºçš„ï¼Œæ ¹æœ¬åšä¸åˆ°é«˜æ•ˆåˆå¹¶ã€‚æ‰€ä»¥LSMè¦å°†æ•°æ®æŒ‰keyæ’åºï¼Œåœ¨åˆå¹¶ä¸åŒfileã€levelä¸Šçš„æ•°æ®æ—¶ç±»ä¼¼ merge-joinã€‚ å¾ˆæ˜æ˜¾ï¼ŒLSMç‰ºç‰²äº†ä¸€éƒ¨åˆ†è¯»çš„æ€§èƒ½å’Œå¢åŠ äº†åˆå¹¶çš„å¼€é”€ï¼Œæ¢å–äº†é«˜æ•ˆçš„å†™æ€§èƒ½ã€‚é‚£LSMä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿå®é™…ä¸Šï¼Œè¿™å°±å…³ç³»åˆ°å¯¹äºç£ç›˜å†™å·²ç»æ²¡æœ‰ä»€ä¹ˆä¼˜åŒ–æ‰‹æ®µäº†ï¼Œè€Œå¯¹äºç£ç›˜è¯»ï¼Œä¸è®ºç¡¬ä»¶è¿˜æ˜¯è½¯ä»¶ä¸Šéƒ½æœ‰ä¼˜åŒ–çš„ç©ºé—´ã€‚é€šè¿‡å¤šç§ä¼˜åŒ–åï¼Œè¯»æ€§èƒ½è™½ç„¶ä»æ˜¯ä¸‹é™ï¼Œä½†å¯ä»¥æ§åˆ¶åœ¨å¯æ¥å—èŒƒå›´å†…ã€‚å®é™…ä¸Šï¼Œç”¨äºç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„ä¸åŒäºç”¨äºå†…å­˜ä¸Šçš„æ•°æ®ç»“æ„ï¼Œç”¨äºå†…å­˜ä¸Šçš„æ•°æ®ç»“æ„æ€§èƒ½çš„ç“¶é¢ˆå°±åœ¨æœç´¢å¤æ‚åº¦ï¼Œè€Œç”¨äºç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„æ€§èƒ½çš„ç“¶é¢ˆåœ¨ç£ç›˜IOï¼Œç”šè‡³æ˜¯ç£ç›˜IOçš„æ¨¡å¼ã€‚ ä»¥ä¸Šä¸‰æ®µæ‘˜æŠ„è‡ªå‚è€ƒæ–‡æ¡£20ã€‚ä¸ªäººä»¥ä¸ºï¼Œé™¤äº†å°†éšæœºå†™åˆå¹¶ä¹‹åè½¬åŒ–ä¸ºé¡ºå†™ä¹‹å¤–ï¼ŒLSM çš„å¦å¤–ä¸€ä¸ªå…³é”®ç‰¹æ€§å°±åœ¨äºå…¶æ˜¯ä¸€ç§è‡ªå¸¦æ•°æ® Garbage Collect çš„æœ‰åºæ•°æ®é›†åˆï¼Œå¯¹å¤–åªæä¾›äº† Add/Get æ¥å£ï¼Œå…¶å†…éƒ¨çš„ Compaction å°±æ˜¯å…¶ GC çš„å…³é”®ï¼Œé€šè¿‡ Compaction å®ç°äº†å¯¹æ•°æ®çš„åˆ é™¤ã€é™„å¸¦äº† TTL çš„è¿‡æœŸæ•°æ®åœ°æ·˜æ±°ã€åŒä¸€ä¸ª Key çš„å¤šä¸ªç‰ˆæœ¬ Value åœ°åˆå¹¶ã€‚RocksDB åŸºäº LSM å¯¹å¤–æä¾›äº† Add/Delete/Get ä¸‰ä¸ªæ¥å£ï¼Œç”¨æˆ·åˆ™åŸºäº RocksDB æä¾›çš„ transaction è¿˜å¯ä»¥å®ç° Update è¯­ä¹‰ã€‚ RocksDBçš„ä¸‰ç§åŸºæœ¬æ–‡ä»¶æ ¼å¼æ˜¯ memtable/sstfile/logfileï¼Œmemtable æ˜¯ä¸€ç§å†…å­˜æ–‡ä»¶æ•°æ®ç³»ç»Ÿï¼Œæ–°å†™æ•°æ®ä¼šè¢«å†™è¿› memtableï¼Œéƒ¨åˆ†è¯·æ±‚å†…å®¹ä¼šè¢«å†™è¿› logfileã€‚logfile æ˜¯ä¸€ç§æœ‰åˆ©äºé¡ºåºå†™çš„æ–‡ä»¶ç³»ç»Ÿã€‚memtable çš„å†…å­˜ç©ºé—´è¢«å¡«æ»¡ä¹‹åï¼Œä¼šæœ‰ä¸€éƒ¨åˆ†è€æ•°æ®è¢«è½¬ç§»åˆ° sstfile é‡Œé¢ï¼Œè¿™äº›æ•°æ®å¯¹åº”çš„ logfile é‡Œçš„ log å°±ä¼šè¢«å®‰å…¨åˆ é™¤ã€‚sstfile ä¸­çš„å†…å®¹æ˜¯æœ‰åºçš„ã€‚ ä¸Šå›¾æ‰€ç¤ºï¼Œæ‰€æœ‰ Column Family å…±äº«ä¸€ä¸ª WAL æ–‡ä»¶ï¼Œä½†æ˜¯æ¯ä¸ª Column Family æœ‰è‡ªå·±å•ç‹¬çš„ memtable &amp; ssttable(sstfile)ï¼Œå³ log å…±äº«è€Œæ•°æ®åˆ†ç¦»ã€‚ ä¸€ä¸ªè¿›ç¨‹å¯¹ä¸€ä¸ª DB åŒæ—¶åªèƒ½åˆ›å»ºä¸€ä¸ª rocksdb::DB å¯¹è±¡ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«ä¹‹ã€‚è¿™ä¸ªå¯¹è±¡å†…éƒ¨æœ‰é”æœºåˆ¶ä¿è¯è®¿é—®å®‰å…¨ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œ Get/Put/Fetch Iteration éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœç›´æ¥ Iteration æˆ–è€… WriteBatch åˆ™éœ€è¦é¢å¤–çš„é”åŒæ­¥æœºåˆ¶ä¿æŠ¤ Iterator æˆ–è€… WriteBatch å¯¹è±¡ã€‚ åŸºäº RocksDB è®¾è®¡å­˜å‚¨ç³»ç»Ÿï¼Œè¦è€ƒè™‘åˆ°åº”ç”¨åœºæ™¯è¿›è¡Œå„ç§ tradeoff è®¾ç½®ç›¸å…³å‚æ•°ã€‚è­¬å¦‚ï¼Œå¦‚æœ RocksDB è¿›è¡Œ compaction æ¯”è¾ƒé¢‘ç¹ï¼Œè™½ç„¶æœ‰åˆ©äºç©ºé—´å’Œè¯»ï¼Œä½†æ˜¯ä¼šé€ æˆè¯»æ”¾å¤§ï¼›compaction è¿‡ä½åˆ™ä¼šé€ æˆè¯»æ”¾å¤§å’Œç©ºé—´æ”¾å¤§ï¼›å¢å¤§æ¯ä¸ª level çš„ comparession éš¾åº¦å¯ä»¥å‡å°ç©ºé—´æ”¾å¤§ï¼Œä½†æ˜¯ä¼šå¢åŠ  cpu è´Ÿæ‹…ï¼Œæ˜¯è¿ç®—æ—¶é—´å¢åŠ æ¢å–ä½¿ç”¨ç©ºé—´å‡å°ï¼›å¢å¤§ SSTfile çš„ data block sizeï¼Œåˆ™æ˜¯å¢å¤§å†…å­˜ä½¿ç”¨é‡æ¥åŠ å¿«è¯»å–æ•°æ®çš„é€Ÿåº¦ï¼Œå‡å°è¯»æ”¾å¤§ã€‚ å•ç‹¬çš„ Get/Put/Delete æ˜¯åŸå­æ“ä½œï¼Œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå¤±è´¥ï¼Œä¸å­˜åœ¨ä¸­é—´çŠ¶æ€ã€‚ å¦‚æœéœ€è¦è¿›è¡Œæ‰¹é‡çš„ Get/Put/Delete æ“ä½œä¸”éœ€è¦æ“ä½œä¿æŒåŸå­å±æ€§ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ WriteBatchã€‚ WriteBatch è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯ä¿æŒåŠ å¿«ååç‡ã€‚ 1.2 åŒæ­¥å†™ ä¸ å¼‚æ­¥å†™ é»˜è®¤æƒ…å†µä¸‹ï¼ŒRocksDB çš„å†™æ˜¯å¼‚æ­¥çš„ï¼šä»…ä»…æŠŠæ•°æ®å†™è¿›äº†æ“ä½œç³»ç»Ÿçš„ç¼“å­˜åŒºå°±è¿”å›äº†ï¼Œè€Œè¿™äº›æ•°æ®è¢«å†™è¿›ç£ç›˜æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ã€‚å¦‚æœä¸ºäº†æ•°æ®å®‰å…¨ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹ä»£ç æŠŠå†™è¿‡ç¨‹æ”¹ä¸ºåŒæ­¥å†™ï¼š 123rocksdb::WriteOptions write_options; write_options.sync = true; db-&gt;Put(write_options, â€¦); è¿™ä¸ªé€‰é¡¹ä¼šå¯ç”¨ Posix ç³»ç»Ÿçš„ fsync(...) or fdatasync(...) or msync(..., MS_SYNC) ç­‰å‡½æ•°ã€‚ å¼‚æ­¥å†™çš„ååç‡æ˜¯åŒæ­¥å†™çš„ä¸€åƒå¤šå€ã€‚å¼‚æ­¥å†™çš„ç¼ºç‚¹æ˜¯æœºå™¨æˆ–è€…æ“ä½œç³»ç»Ÿå´©æºƒæ—¶å¯èƒ½ä¸¢æ‰æœ€è¿‘ä¸€æ‰¹å†™è¯·æ±‚å‘å‡ºçš„ç”±æ“ä½œç³»ç»Ÿç¼“å­˜çš„æ•°æ®ï¼Œä½†æ˜¯ RocksDB è‡ªèº«å´©æºƒå¹¶ä¸ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚è€Œæœºå™¨æˆ–è€…æ“ä½œç³»ç»Ÿå´©æºƒçš„æ¦‚ç‡æ¯”è¾ƒä½ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥è®¤ä¸ºå¼‚æ­¥å†™æ˜¯å®‰å…¨çš„ã€‚ RocksDB ç”±äºæœ‰ WAL æœºåˆ¶ä¿è¯ï¼Œæ‰€ä»¥å³ä½¿å´©æºƒï¼Œå…¶é‡å¯åä¼šè¿›è¡Œå†™é‡æ”¾ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚å¦‚æœä¸åœ¨ä¹æ•°æ®å®‰å…¨æ€§ï¼Œå¯ä»¥æŠŠ write_option.disableWAL è®¾ç½®ä¸º trueï¼ŒåŠ å¿«å†™ååç‡ã€‚ RocksDB è°ƒç”¨ Posix API fdatasync() å¯¹æ•°æ®è¿›è¡Œå¼‚æ­¥å†™ã€‚å¦‚æœæƒ³ç”¨ fsync() è¿›è¡ŒåŒæ­¥å†™ï¼Œå¯ä»¥è®¾ç½® Options::use_fsync ä¸º trueã€‚ 1.3 Snapshots RocksDB èƒ½å¤Ÿä¿å­˜æŸä¸ªç‰ˆæœ¬çš„æ‰€æœ‰æ•°æ®ï¼ˆå¯ç§°ä¹‹ä¸ºä¸€ä¸ª Snapshotï¼‰ä»¥æ–¹ä¾¿è¯»å–æ“ä½œï¼Œåˆ›å»ºå¹¶è¯»å– Snapshot æ–¹æ³•å¦‚ä¸‹ï¼š 1234567rocksdb::ReadOptions options; options.snapshot = db-&gt;GetSnapshot(); â€¦ apply some updates to db â€¦. rocksdb::Iterator* iter = db-&gt;NewIterator(options); â€¦ read using iter to view the state when the snapshot was created â€¦. delete iter; db-&gt;ReleaseSnapshot(options.snapshot); å¦‚æœ ReadOptions::snapshot ä¸º nullï¼Œåˆ™è¯»å–çš„ snapshot ä¸º RocksDB å½“å‰ç‰ˆæœ¬æ•°æ®çš„ snapshotã€‚ 1.4 Slice &amp; PinnableSlice ä¸ç®¡æ˜¯ it-&gt;key() è¿˜æ˜¯ it-&gt;value()ï¼Œå…¶å€¼ç±»å‹éƒ½æ˜¯ rocksdb::Sliceã€‚ Slice è‡ªèº«ç”±ä¸€ä¸ªé•¿åº¦å­—æ®µ[ size_t size_ ]ä»¥åŠä¸€ä¸ªæŒ‡å‘å¤–éƒ¨ä¸€ä¸ªå†…å­˜åŒºåŸŸçš„æŒ‡é’ˆ[ const char* data_ ]æ„æˆï¼Œè¿”å› Slice æ¯”è¿”å›ä¸€ä¸ª string å»‰ä»·ï¼Œå¹¶ä¸å­˜åœ¨å†…å­˜æ‹·è´çš„é—®é¢˜ã€‚RocksDB è‡ªèº«ä¼šç»™ key å’Œ value æ·»åŠ ä¸€ä¸ª C-style çš„ â€˜\\0â€™ï¼Œæ‰€ä»¥ slice çš„æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åŒºåŸŸè‡ªèº«ä½œä¸ºå­—ç¬¦ä¸²è¾“å‡ºæ²¡æœ‰é—®é¢˜ã€‚ Slice ä¸ string ä¹‹é—´çš„è½¬æ¢ä»£ç å¦‚ä¸‹ï¼š 12345678rocksdb::Slice s1 = â€œhelloâ€;std::string str(â€œworldâ€);rocksdb::Slice s2 = str;OR: std::string str = s1.ToString(); assert(str == std::string(â€œhelloâ€)); ä½†æ˜¯è¯·æ³¨æ„ Slice çš„å®‰å…¨æ€§ï¼Œæœ‰ä»£ç å¦‚ä¸‹ï¼š 123456rocksdb::Slice slice; if (â€¦) &#123; std::string str = â€¦; slice = str; &#125; Use(slice); å½“é€€å‡º if è¯­å¥å—åï¼Œslice å†…éƒ¨æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜åŒºåŸŸå·²ç»ä¸å­˜åœ¨ï¼Œæ­¤æ—¶å†ä½¿ç”¨å¯¼è‡´ç¨‹åºå‡ºé—®é¢˜ã€‚ Slice è‡ªèº«è™½ç„¶èƒ½å¤Ÿå‡å°‘å†…å­˜æ‹·è´ï¼Œä½†æ˜¯åœ¨ç¦»å¼€ç›¸åº”çš„ scope ä¹‹åï¼Œå…¶å€¼å°±ä¼šè¢«é‡Šæ”¾ï¼Œrocksdb v5.4.5 ç‰ˆæœ¬å¼•å…¥ä¸€ä¸ª PinnableSliceï¼Œå…¶ç»§æ‰¿è‡ª Sliceï¼Œå¯æ›¿æ¢ä¹‹å‰ Get æ¥å£çš„å‡ºå‚ï¼š 1234567Status Get(const ReadOptions&amp; options, ColumnFamilyHandle* column_family, const Slice&amp; key, std::string* value)virtual Status Get(const ReadOptions&amp; options, ColumnFamilyHandle* column_family, const Slice&amp; key, PinnableSlice* value) è¿™é‡Œçš„ PinnableSlice å¦‚åŒ Slice ä¸€æ ·å¯ä»¥å‡å°‘å†…å­˜æ‹·è´ï¼Œæé«˜è¯»æ€§èƒ½ï¼Œä½†æ˜¯ PinnableSlice å†…éƒ¨æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°åŠŸèƒ½ï¼Œå¯ä»¥å®ç°æ•°æ®å†…å­˜çš„å»¶è¿Ÿé‡Šæ”¾ï¼Œå»¶é•¿ç›¸å…³æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸï¼Œç›¸å…³è¯¦ç»†åˆ†æè¯¦è§ å‚è€ƒæ–‡æ¡£15ã€‚ å‚è€ƒæ–‡æ¡£16 æåˆ° PinnableSlice, as its name suggests, has the data pinned in memory. The pinned data are released when PinnableSlice object is destructed or when ::Reset is invoked explicitly on it.ã€‚æ‰€è°“çš„ pinned in memory å³ä¸ºå¼•ç”¨è®¡æ•°ä¹‹æ„ï¼Œæ–‡ä¸­æåˆ°å†…å­˜æ•°æ®é‡Šæ”¾æ˜¯åœ¨ PinnableSlice ææ„æˆ–è€…è°ƒç”¨ ::Reset ä¹‹åã€‚ ç”¨æˆ·ä¹Ÿå¯ä»¥æŠŠä¸€ä¸ª std::string å¯¹è±¡ä½œä¸º PinnableSlice æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œ æŠŠè¿™ä¸ª std::string æŒ‡å®šä¸º PinnableSlice çš„åˆå§‹å†…éƒ¨ buffer [ rocksdb/slice.h:PinnableSlice::buf_ ]ï¼Œä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒ ç”¨æ–° Get å®ç°çš„æ—§ç‰ˆæœ¬çš„ Getï¼š 123456789101112virtual inline Status Get(const ReadOptions&amp; options, ColumnFamilyHandle* column_family, const Slice&amp; key, std::string* value) &#123; assert(value != nullptr); PinnableSlice pinnable_val(value); assert(!pinnable_val.IsPinned()); auto s = Get(options, column_family, key, &amp;pinnable_val); if (s.ok() &amp;&amp; pinnable_val.IsPinned()) &#123; value-&gt;assign(pinnable_val.data(), pinnable_val.size()); &#125; // else value is already assigned return s; &#125; é€šè¿‡ rocksdb/slice.h:PinnableSlice::PinSlice å®ç°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰åœ¨è¿™ä¸ªå‡½æ•°é‡Œ PinnableSlice::pinned_ è¢«èµ‹å€¼ä¸º trueï¼Œ åŒæ—¶å†…å­˜åŒºåŸŸå­˜æ”¾åœ¨ PinnableSlice::data_ æŒ‡å‘çš„å†…å­˜åŒºåŸŸï¼Œæ•…è€Œ PinnableSlice::IsPinned ä¸º trueï¼Œåˆ™ å†…éƒ¨ buffer [ rocksdb/slice.h:PinnableSlice::buf_ ] å¿…å®šä¸ºç©ºã€‚ å…·ä½“çš„ç¼–ç¨‹ç”¨ä¾‹å¯å‚è€ƒ pinnalble_slice.ccã€‚ 1.5 Transactions å½“ä½¿ç”¨ TransactionDB æˆ–è€… OptimisticTransactionDB çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ RocksDB çš„ BEGIN/COMMIT/ROLLBACK ç­‰äº‹åŠ¡ APIã€‚RocksDB æ”¯æŒæ´»é”æˆ–è€…æ­»ç­‰ä¸¤ç§äº‹åŠ¡ã€‚ WriteBatch é»˜è®¤ä½¿ç”¨äº†äº‹åŠ¡ï¼Œç¡®ä¿æ‰¹é‡å†™æˆåŠŸã€‚ å½“æ‰“å¼€ä¸€ä¸ª TransactionDB çš„æ—¶å€™ï¼Œå¦‚æœ RocksDB æ£€æµ‹åˆ°æŸä¸ª key å·²ç»è¢«åˆ«çš„äº‹åŠ¡é”ä½ï¼Œåˆ™ RocksDB ä¼šè¿”å›ä¸€ä¸ª errorã€‚å¦‚æœæ‰“å¼€æˆåŠŸï¼Œåˆ™æ‰€æœ‰ç›¸å…³ key éƒ½ä¼šè¢« lock ä½ï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸã€‚TransactionDB çš„å¹¶å‘ç‰¹æ€§è¡¨ç°è¦æ¯” OptimisticTransactionDB å¥½ï¼Œä½†æ˜¯ TransactionDB çš„ä¸€ä¸ªå°é—®é¢˜å°±æ˜¯ä¸ç®¡å†™å‘ç”Ÿåœ¨äº‹åŠ¡é‡Œæˆ–è€…äº‹åŠ¡å¤–ï¼Œä»–éƒ½ä¼šè¿›è¡Œå†™å†²çªæ£€æµ‹ã€‚TransactionDB ä½¿ç”¨ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 12345678TransactionDB* txn_db;Status s = TransactionDB::Open(options, path, &amp;txn_db);Transaction* txn = txn_db-&gt;BeginTransaction(write_options, txn_options);s = txn-&gt;Put(â€œkeyâ€, â€œvalueâ€);s = txn-&gt;Delete(â€œkey2â€);s = txn-&gt;Merge(â€œkey3â€, â€œvalueâ€);s = txn-&gt;Commit();delete txn; OptimisticTransactionDB æä¾›äº†ä¸€ä¸ªæ›´è½»é‡çš„äº‹åŠ¡å®ç°ï¼Œå®ƒåœ¨è¿›è¡Œå†™ä¹‹å‰ä¸ä¼šè¿›è¡Œå†™å†²çªæ£€æµ‹ï¼Œå½“å¯¹å†™æ“ä½œè¿›è¡Œ commit çš„æ—¶å€™å¦‚æœå‘ç”Ÿäº† lock å†²çªå¯¼è‡´å†™æ“ä½œå¤±è´¥ï¼Œåˆ™ RocksDB ä¼šè¿”å›ä¸€ä¸ª errorã€‚è¿™ç§äº‹åŠ¡ä½¿ç”¨äº†æ´»é”ç­–ç•¥ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘è¿™ç§å†™å†²çªæ¦‚ç‡æ¯”è¾ƒä½çš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 1234567891011DB* db;OptimisticTransactionDB* txn_db;Status s = OptimisticTransactionDB::Open(options, path, &amp;txn_db);db = txn_db-&gt;GetBaseDB();OptimisticTransaction* txn = txn_db-&gt;BeginTransaction(write_options, txn_options);txn-&gt;Put(â€œkeyâ€, â€œvalueâ€);txn-&gt;Delete(â€œkey2â€);txn-&gt;Merge(â€œkey3â€, â€œvalueâ€);s = txn-&gt;Commit();delete txn; å‚è€ƒæ–‡æ¡£ 6 è¯¦ç»†æè¿°äº† RocksDB çš„ Transactionsã€‚ 1.6 Column Family CF æä¾›äº†å¯¹ DB è¿›è¡Œé€»è¾‘åˆ’åˆ†å¼€æ¥çš„æ–¹æ³•ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ CF åŒæ—¶å¯¹å¤šä¸ª CF çš„ KV è¿›è¡Œå¹¶è¡Œè¯»å†™çš„æ–¹æ³•ï¼Œæé«˜äº†å¹¶è¡Œåº¦ã€‚ 1.7 MemTable and Table factories RocksDB å†…å­˜ä¸­çš„æ•°æ®æ ¼å¼æ˜¯ skiplistï¼Œç£ç›˜åˆ™æ˜¯ä»¥ table å½¢å¼å­˜å‚¨çš„ SST æ–‡ä»¶æ ¼å¼ã€‚ table æ ¼å¼æœ‰ä¸¤ç§ï¼šç»§æ‰¿è‡ª leveldb çš„æ–‡ä»¶æ ¼å¼ã€è¯¦è§å‚è€ƒæ–‡æ¡£2ã€‘å’Œ PlainTable æ ¼å¼ã€è¯¦è§å‚è€ƒæ–‡æ¡£3ã€‘ã€‚PlainTable æ ¼å¼æ˜¯é’ˆå¯¹ ä½æŸ¥è¯¢å»¶è¿Ÿ æˆ–è€…ä½å»¶è¿Ÿå­˜å‚¨åª’ä»‹å¦‚ SSD ç‰¹åˆ«åˆ«ä¼˜åŒ–çš„ä¸€ç§æ–‡ä»¶æ ¼å¼ã€‚ 1.8 Block size RocksDB æŠŠç›¸é‚»çš„ key æ”¾åˆ°åŒä¸€ä¸ª block ä¸­ï¼Œblock æ˜¯æ•°æ®å­˜å‚¨å’Œä¼ é€’çš„åŸºæœ¬å•å…ƒã€‚é»˜è®¤ Block çš„å¤§å°æ˜¯ 4096Bï¼Œæ•°æ®æœªç»å‹ç¼©ã€‚ ç»å¸¸è¿›è¡Œ bulk scan æ“ä½œçš„ç”¨æˆ·å¯èƒ½å¸Œæœ›å¢å¤§ block sizeï¼Œè€Œç»å¸¸è¿›è¡Œå• key è¯»å†™çš„ç”¨æˆ·åˆ™å¯èƒ½å¸Œæœ›å‡å°å…¶å€¼ï¼Œå®˜æ–¹å»ºè®®è¿™ä¸ªå€¼å‡å°ä¸è¦ä½äº 1KB çš„ä¸‹é™ï¼Œå˜å¤§ä¹Ÿä¸è¦è¶…è¿‡ a few megabytesã€‚å¯ç”¨å‹ç¼©ä¹Ÿå¯ä»¥èµ·åˆ°å¢å¤§ block size çš„å¥½å¤„ã€‚ ä¿®æ”¹ Block size çš„æ–¹æ³•æ˜¯ä¿®æ”¹ Options::block_sizeã€‚ 1.9 Writer Buffer Options::write_buffer_size æŒ‡å®šäº†ä¸€ä¸ªå†™å†…å­˜ buffer çš„å¤§å°ï¼Œå½“è¿™ä¸ª buffer å†™æ»¡ä¹‹åæ•°æ®ä¼šè¢«å›ºåŒ–åˆ°ç£ç›˜ä¸Šã€‚è¿™ä¸ªå€¼è¶Šå¤§æ‰¹é‡å†™å…¥çš„æ€§èƒ½è¶Šå¥½ã€‚ RocksDB æ§åˆ¶å†™å†…å­˜ buffer æ•°ç›®çš„å‚æ•°æ˜¯ Options::max_write_buffer_numberã€‚è¿™ä¸ªå€¼é»˜è®¤æ˜¯ 2ï¼Œå½“ä¸€ä¸ª buffer çš„æ•°æ®è¢« flush åˆ°ç£ç›˜ä¸Šçš„æ—¶å€™ï¼ŒRocksDB å°±ç”¨å¦ä¸€ä¸ª buffer ä½œä¸ºæ•°æ®è¯»å†™ç¼“å†²åŒºã€‚ â€˜Options::min_write_buffer_number_to_mergeâ€™ è®¾å®šäº†æŠŠå†™ buffer çš„æ•°æ®å›ºåŒ–åˆ°ç£ç›˜ä¸Šæ—¶å¯¹å¤šå°‘ä¸ª buffer çš„æ•°æ®è¿›è¡Œåˆå¹¶ç„¶åå†å›ºåŒ–åˆ°ç£ç›˜ä¸Šã€‚è¿™ä¸ªå€¼å¦‚æœä¸º 1ï¼Œåˆ™ L0 å±‚æ–‡ä»¶åªæœ‰ä¸€ä¸ªï¼Œè¿™ä¼šå¯¼è‡´è¯»æ”¾å¤§ï¼Œè¿™ä¸ªå€¼å¤ªå°ä¼šå¯¼è‡´æ•°æ®å›ºåŒ–åˆ°ç£ç›˜ä¸Šä¹‹å‰æ•°æ®å»é‡æ•ˆæœå¤ªå·®åŠ²ã€‚ è¿™ä¸¤ä¸ªå€¼å¹¶ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå¤ªå¤§ä¼šå»¶è¿Ÿä¸€ä¸ª DB è¢«é‡æ–°æ‰“å¼€æ—¶çš„æ•°æ®åŠ è½½æ—¶é—´ã€‚ 1.10 Key Layout åœ¨ 1.8 ç« èŠ‚é‡Œæåˆ° â€œblock æ˜¯æ•°æ®å­˜å‚¨å’Œä¼ é€’çš„åŸºæœ¬å•å…ƒâ€ï¼ŒRocksDB çš„æ•°æ®æ˜¯ä¸€ä¸ª range çš„ key-value æ„æˆä¸€ä¸ª Regionï¼Œæ ¹æ®å±€éƒ¨æ€§åŸç†æ¯æ¬¡è®¿é—®ä¸€ä¸ª Region çš„ key çš„æ—¶å€™ï¼Œæœ‰å¾ˆå¤šæ¦‚ç‡ä¼šè®¿é—®å…¶ç›¸é‚»çš„ keyï¼Œæ¯ä¸ª Region çš„ keys æ”¾åœ¨ä¸€ä¸ª block é‡Œï¼Œå¤šä¸ª Region çš„ keys æ”¾åœ¨å¤šä¸ª block é‡Œã€‚ ä¸‹é¢ä»¥æ–‡ä»¶ç³»ç»Ÿä½œä¸ºç±»æ¯”ï¼Œè¯¦ç»†è§£é‡Šä¸‹ RocksDB çš„æ–‡ä»¶ç³»ç»Ÿï¼šâ€‹â€‹ filename -&gt; permission-bits, length, list of file_block_idsâ€‹ file_block_id -&gt; data ä»¥å¤šä¸ªç»´åº¦ç»„ç»‡ key çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ› filename çš„å‰ç¼€éƒ½æ˜¯ â€˜/â€˜ï¼Œ è€Œ file_block_id çš„å‰ç¼€éƒ½æ˜¯ â€˜0â€™ï¼Œè¿™æ ·å¯ä»¥æŠŠä»–ä»¬åˆ†åˆ«æ”¾åœ¨ä¸åŒçš„ block é‡Œï¼Œä»¥æ–¹ä¾¿å¿«é€ŸæŸ¥è¯¢ã€‚ 1.11 Checksums Rocksdb å¯¹æ¯ä¸ª kv ä»¥åŠæ•´ä½“æ•°æ®æ–‡ä»¶éƒ½åˆ†åˆ«è®¡ç®—äº† checksumï¼Œä»¥è¿›è¡Œæ•°æ®æ­£ç¡®æ€§æ ¡éªŒã€‚ä¸‹é¢æœ‰ä¸¤ä¸ªé€‰é¡¹å¯¹ checksum çš„è¡Œä¸ºè¿›è¡Œæ§åˆ¶ã€‚ ReadOptions::verify_checksums å¼ºåˆ¶å¯¹æ¯æ¬¡ä»ç£ç›˜è¯»å–çš„æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œè¿™ä¸ªé€‰é¡¹é»˜è®¤ä¸º trueã€‚ Options::paranoid_checks è¿™ä¸ªé€‰é¡¹ä¸º true çš„æ—¶å€™ï¼Œå¦‚æœ RocksDB æ‰“å¼€ä¸€ä¸ªæ•°æ®æ£€æµ‹åˆ°å†…éƒ¨æ•°æ®éƒ¨åˆ†é”™ä¹±ï¼Œé©¬ä¸ŠæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚è¿™ä¸ªé€‰æ‹©é»˜è®¤ä¸º falseã€‚ å¦‚æœ RocksDB çš„æ•°æ®é”™ä¹±ï¼ŒRocksDB ä¼šå°½é‡æŠŠå®ƒéš”ç¦»å‡ºæ¥ï¼Œä¿è¯å¤§éƒ¨åˆ†æ•°æ®çš„å¯ç”¨æ€§å’Œæ­£ç¡®æ€§ã€‚ 1.12 Approximate Sizes GetApproximateSizes æ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ª key range çš„ç£ç›˜å ç”¨ç©ºé—´å¤§è‡´ä½¿ç”¨é‡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 12345rocksdb::Range ranges[2]; ranges[0] = rocksdb::Range(â€œaâ€, â€œcâ€); ranges[1] = rocksdb::Range(â€œxâ€, â€œzâ€); uint64_t sizes[2]; rocksdb::Status s = db-&gt;GetApproximateSizes(ranges, 2, sizes); ä¸Šé¢çš„ sizes[0] è¿”å› [a..c) key range çš„ç£ç›˜ä½¿ç”¨é‡ï¼Œè€Œ sizes[1] è¿”å› [x..z) key range çš„ç£ç›˜ä½¿ç”¨é‡ã€‚ 1.13 Purging WAL files ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒRocksDB ä¼šåˆ é™¤ä¸€äº›è¿‡æ—¶çš„ WAL æ–‡ä»¶ï¼Œæ‰€è°“è¿‡æ—¶å°±æ˜¯ WAL æ–‡ä»¶é‡Œé¢å¯¹åº”çš„ä¸€äº› key çš„æ•°æ®å·²ç»è¢«å›ºåŒ–åˆ°ç£ç›˜äº†ã€‚ä½†æ˜¯ RocksDB æä¾›äº†ä¸¤ä¸ªé€‰é¡¹ä»¥å®è®©ç”¨æˆ·æ§åˆ¶ WAL ä½•æ—¶åˆ é™¤ï¼šOptions::WAL_ttl_seconds å’Œ Options::WAL_size_limit_MBï¼Œè¿™ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ§åˆ¶ WAL æ–‡ä»¶çš„è¶…æ—¶æ—¶é—´ å’Œ æœ€å¤§æ–‡ä»¶ sizeã€‚ å¦‚æœè¿™ä¸¤ä¸ªå€¼éƒ½è¢«è®¾ç½®ä¸º 0ï¼Œåˆ™ log ä¸ä¼šè¢«å›ºåŒ–åˆ°æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚ å¦‚æœ Options::WAL_ttl_seconds ä¸º 0 è€Œ Options::WAL_size_limit_MB ä¸ä¸º 0ï¼Œ RocksDB ä¼šæ¯ 10 åˆ†é’Ÿæ£€æµ‹æ‰€æœ‰çš„ WAL æ–‡ä»¶ï¼Œå¦‚æœå…¶æ€»ä½“ size è¶…è¿‡ Options::WAL_size_limit_MBï¼Œåˆ™ RocksDB ä¼šåˆ é™¤æœ€æ—©çš„æ—¥å¿—ç›´åˆ°æ»¡è¶³è¿™ä¸ªå€¼ä½ç½®ã€‚ä¸€åˆ‡ç©ºæ–‡ä»¶éƒ½ä¼šè¢«åˆ é™¤ã€‚ å¦‚æœ Options::WAL_ttl_seconds ä¸ä¸º 0 è€Œ Options::WAL_size_limit_MB ä¸º 0ï¼ŒRocksDB ä¼šæ¯ Options::WAL_ttl_seconds / 2 æ£€æµ‹ä¸€æ¬¡ WAL æ–‡ä»¶ï¼Œ æ‰€æœ‰ TTL è¶…è¿‡ Options::WAL_ttl_seconds çš„ WAL æ–‡ä»¶éƒ½ä¼šè¢«åˆ é™¤ã€‚ å¦‚æœä¸¤ä¸ªå€¼éƒ½ä¸ä¸º 0ï¼ŒRocksDB ä¼šæ¯ 10 åˆ†é’Ÿæ£€æµ‹æ‰€æœ‰çš„ WAL æ–‡ä»¶ï¼Œæ‰€æœ‰ä¸æ»¡è¶³æ¡ä»¶çš„ WAL æ–‡ä»¶éƒ½ä¼šè¢«åˆ é™¤ï¼Œå…¶ä¸­ ttl å‚æ•°ä¼˜å…ˆã€‚ 1.14 Prefix Iterators è®¸å¤š LSM å¼•æ“ä¸æ”¯æŒé«˜æ•ˆçš„ RangeScan æ“ä½œï¼Œå› ä¸º Range æ“ä½œéœ€è¦æ‰«ææ‰€æœ‰çš„æ•°æ®æ–‡ä»¶ã€‚ä¸€èˆ¬æƒ…å†µä¸‹å¸¸è§„çš„æŠ€æœ¯æ‰‹æ®µæ˜¯ç»™ key å»ºç«‹ç´¢å¼•ï¼Œåªç”¨éå† key å°±å¯ä»¥äº†ã€‚åº”ç”¨å¯ä»¥é€šè¿‡ç¡®è®¤ prefix_extractor æŒ‡å®šä¸€ä¸ªå¯ä»¥çš„å‰ç¼€ï¼ŒRocksDB å¯ä»¥ä¸ºè¿™äº› key prefix å»ºç«‹ Bloom ç´¢å¼•ï¼Œä»¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚ 1.15 Multi-Threaded Compactions å‚è€ƒæ–‡æ¡£ 5 çš„ Compaction Styles ä¸€èŠ‚æåˆ°ï¼Œå¦‚æœå¯ç”¨ Level Style Compaction, L0 å­˜å‚¨ç€ RocksDB æœ€æ–°çš„æ•°æ®ï¼ŒLmax å­˜å‚¨ç€æ¯”è¾ƒè€çš„æ•°æ®ï¼ŒL0 é‡Œå¯èƒ½å­˜ç€é‡å¤ keysï¼Œä½†æ˜¯å…¶ä»–å±‚æ–‡ä»¶åˆ™ä¸å¯èƒ½å­˜åœ¨é‡å¤ keyã€‚æ¯ä¸ª compaction ä»»åŠ¡éƒ½ä¼šé€‰æ‹© Ln å±‚çš„ä¸€ä¸ªæ–‡ä»¶ä»¥åŠä¸å…¶ç›¸é‚»çš„ Ln+1 å±‚çš„å¤šä¸ªæ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œåˆ é™¤è¿‡æœŸ æˆ–è€… æ ‡è®°ä¸ºåˆ é™¤ æˆ–è€… é‡å¤ çš„ keyï¼Œç„¶åæŠŠåˆå¹¶åçš„æ–‡ä»¶æ”¾å…¥ Ln+1 å±‚ã€‚Compaction è¿‡ç¨‹ä¼šå¯¼è‡´å†™æ”¾å¤§ã€å¦‚å†™qpsæ˜¯10MB/sï¼Œä½†æ˜¯å®é™…ç£ç›˜ioæ˜¯50MB/sã€‘æ•ˆåº”ï¼Œä½†æ˜¯å¯ä»¥èŠ‚çœç©ºé—´å¹¶å‡å°‘è¯»æ”¾å¤§ã€‚ å¦‚æœå¯ç”¨ Universal Style Compactionï¼Œåˆ™åªå‹ç¼© L0 çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåˆå¹¶åå†æ”¾å…¥ L0 å±‚é‡Œã€‚ RocksDB çš„ compaction ä»»åŠ¡çº¿ç¨‹ä¸å®œè¿‡å¤šï¼Œè¿‡å¤šå®¹æ˜“å¯¼è‡´å†™è¯·æ±‚è¢« hang ä½ã€‚ 1.16 Incremental Backups and Replication RocksDB çš„ API GetUpdatesSince å¯ä»¥è®©è°ƒç”¨è€…ä» transaction log è·çŸ¥æœ€è¿‘è¢«æ›´æ–°çš„ keyï¼ˆåŸæ–‡æ„ä¸ºç”¨ tail æ–¹å¼è¯»å– transaction logï¼‰ï¼Œé€šè¿‡è¿™ä¸ª API å¯ä»¥è¿›è¡Œæ•°æ®çš„å¢é‡å¤‡ä»½ã€‚ RocksDB åœ¨è¿›è¡Œæ•°æ®å¤‡ä»½æ—¶å€™ï¼Œå¯ä»¥è°ƒç”¨ API DisableFileDeletions åœæ­¢åˆ é™¤æ–‡ä»¶æ“ä½œï¼Œè°ƒç”¨ API GetLiveFiles/GetSortedWalFiles ä»¥æ£€ç´¢æ´»è·ƒæ–‡ä»¶åˆ—è¡¨ï¼Œç„¶åè¿›è¡Œæ•°æ®å¤‡ä»½ã€‚å¤‡ä»½å·¥ä½œå®Œæˆä»¥ååœ¨è°ƒç”¨ API EnableFileDeletions è®© RocksDB å†å¯åŠ¨è¿‡æœŸæ–‡ä»¶æ·˜æ±°å·¥ä½œã€‚ 1.17 Thread Pool RocksDB ä¼šåˆ›å»ºä¸€ä¸ª thread pool ä¸ Env å¯¹è±¡è¿›è¡Œå…³è”ï¼Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°ç›®å¯ä»¥é€šè¿‡ Env::SetBackgroundThreads() è®¾å®šã€‚é€šè¿‡è¿™ä¸ªçº¿ç¨‹æ± å¯ä»¥æ‰§è¡Œ compaction ä¸ memtable flush ä»»åŠ¡ã€‚ å½“ memtable flush å’Œ compaction ä¸¤ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå¯¼è‡´å†™è¯·æ±‚è¢« hang ä½ã€‚RocksDB å»ºè®®åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œåˆ†åˆ«æŒ‡å®š HIGH å’Œ LOW ä¸¤ä¸ªä¼˜å…ˆçº§ã€‚é»˜è®¤æƒ…å†µä¸‹ HIGH çº¿ç¨‹æ± æ‰§è¡Œ memtable flush ä»»åŠ¡ï¼ŒLOW çº¿ç¨‹æ± æ‰§è¡Œ compaction ä»»åŠ¡ã€‚ ç›¸å…³ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š 12345678910111213#include â€œrocksdb/env.hâ€#include â€œrocksdb/db.hâ€auto env = rocksdb::Env::Default();env-&gt;SetBackgroundThreads(2, rocksdb::Env::LOW);env-&gt;SetBackgroundThreads(1, rocksdb::Env::HIGH);rocksdb::DB* db;rocksdb::Options options;options.env = env;options.max_background_compactions = 2;options.max_background_flushes = 1;rocksdb::Status status = rocksdb::DB::Open(options, â€œ/tmp/testdbâ€, &amp;db);assert(status.ok()); è¿˜æœ‰å…¶ä»–ä¸€äº›å‚æ•°ï¼Œå¯è¯¦ç»†é˜…è¯»å‚è€ƒæ–‡æ¡£4ã€‚â€‹ 1.18 Bloom Filter RocksDB çš„æ¯ä¸ª SST æ–‡ä»¶éƒ½åŒ…å«ä¸€ä¸ª Bloom filterã€‚Bloom Filter åªå¯¹ç‰¹å®šçš„ä¸€ç»„ keys æœ‰æ•ˆï¼Œæ‰€ä»¥åªæœ‰æ–°çš„ SST æ–‡ä»¶åˆ›å»ºçš„æ—¶å€™æ‰ä¼šç”Ÿæˆè¿™ä¸ª filterã€‚å½“ä¸¤ä¸ª SST æ–‡ä»¶åˆå¹¶çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆæ–°çš„ filter æ•°æ®ã€‚ å½“ SST æ–‡ä»¶åŠ è½½è¿›å†…å­˜çš„æ—¶å€™ï¼Œfilter ä¹Ÿä¼šè¢«åŠ è½½è¿›å†…å­˜ï¼Œå½“å…³é—­ SST æ–‡ä»¶çš„æ—¶å€™ï¼Œfilter ä¹Ÿä¼šè¢«å…³é—­ã€‚å¦‚æœæƒ³è®© filter å¸¸é©»å†…å­˜ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹ä»£ç è®¾ç½®ï¼š 1BlockBasedTableOptions::cache_index_and_filter_blocks=true ä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦ä¿®æ”¹ filter ç›¸å…³å‚æ•°ã€‚å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œç›¸å…³è®¾ç½®ä¸Šé¢å·²ç»è¯´è¿‡ï¼Œæ­¤å¤„ä¸å†å¤šè°ˆï¼Œè¯¦ç»†å†…å®¹è§å‚è€ƒæ–‡æ¡£ 7ã€‚ 1.19 Time to Live RocksDB åœ¨è¿›è¡Œ compact çš„æ—¶å€™ï¼Œä¼šåˆ é™¤è¢«æ ‡è®°ä¸ºåˆ é™¤çš„æ•°æ®ï¼Œä¼šåˆ é™¤é‡å¤ key çš„è€ç‰ˆæœ¬çš„æ•°æ®ï¼Œä¹Ÿä¼šåˆ é™¤è¿‡æœŸçš„æ•°æ®ã€‚æ•°æ®è¿‡æœŸæ—¶é—´ç”± API DBWithTTL::Open(const Options&amp; options, const std::string&amp; name, StackableDB** dbptr, int32_t ttl = 0, bool read_only = false) çš„ ttl å‚æ•°è®¾å®šã€‚ TTL çš„ä½¿ç”¨æœ‰ä»¥ä¸‹æ³¨æ„äº‹é¡¹ï¼š 1 TTL å…¶å€¼å•ä½æ˜¯ç§’ï¼Œå¦‚æœ TTL å€¼ä¸º 0 æˆ–è€…è´Ÿæ•°ï¼Œåˆ™ TTL å€¼ä¸º infinityï¼Œå³æ°¸ä¸è¿‡æœŸï¼› 2 æ¯ä¸ª kv è¢«æ’å…¥æ•°æ®æ–‡ä»¶ä¸­çš„æ—¶å€™ä¼šå¸¦ä¸Šåˆ›å»ºæ—¶çš„æœºå™¨ (int32_t)Timestamp æ—¶é—´å€¼ï¼› 3 compaction æ—¶å¦‚æœ kv æ»¡è¶³æ¡ä»¶ Timestamp+ttl&lt;time_nowï¼Œåˆ™ä¼šè¢«æ·˜æ±°æ‰ï¼› 4 Get/Iterator çš„æ—¶å€™å¯èƒ½è¿”å›è¿‡æœŸçš„ kvï¼ˆcompact ä»»åŠ¡è¿˜æœªæ‰§è¡Œï¼‰ï¼› 5 ä¸åŒçš„ DBWithTTL::Open å¯èƒ½ä¼šå¸¦ä¸Šä¸åŒçš„ TTL å€¼ï¼Œæ­¤æ—¶ kv ä»¥æœ€å¤§çš„ TTL å€¼ä¸ºå‡†ï¼› 6 å¦‚æœ DBWithTTL::Open çš„å‚æ•° read_only ä¸º trueï¼Œåˆ™ä¸ä¼šè§¦å‘ compact ä»»åŠ¡ï¼Œä¸ä¼šæœ‰è¿‡æœŸæ•°æ®è¢«åˆ é™¤ã€‚ 2 RocksDB Memory RocksDBçš„å†…å­˜å¤§è‡´æœ‰å¦‚ä¸‹å››ä¸ªåŒºï¼š Block Cache Indexes and bloom filters Memtables Blocked pinned by iterators 2.1 Block Cache ç¬¬ä¸‰èŠ‚è¯¦è¿°äº† Block Cacheï¼Œè¿™é‡Œåªç»™å‡ºæ€»ç»“æ€§æè¿°ï¼šå®ƒå­˜å‚¨ä¸€äº›è¯»ç¼“å­˜æ•°æ®ï¼Œå®ƒçš„ä¸‹ä¸€å±‚æ˜¯æ“ä½œç³»ç»Ÿçš„ Page Cacheã€‚ 2.2 Indexes and bloom filters Index ç”± keyã€offset å’Œ size ä¸‰éƒ¨åˆ†æ„æˆï¼Œå½“ Block Cache å¢å¤§ Block Size æ—¶ï¼Œblock ä¸ªæ•°å¿…ä¼šå‡å°ï¼Œindex ä¸ªæ•°ä¹Ÿä¼šéšä¹‹é™ä½ï¼Œå¦‚æœå‡å° key sizeï¼Œindex å ç”¨å†…å­˜ç©ºé—´çš„é‡ä¹Ÿä¼šéšä¹‹é™ä½ã€‚ filteræ˜¯ bloom filter çš„å®ç°ï¼Œå¦‚æœå‡é˜³ç‡æ˜¯ 1%ï¼Œæ¯ä¸ªkeyå ç”¨ 10 bitsï¼Œåˆ™æ€»å ç”¨ç©ºé—´å°±æ˜¯ num_of_keys * 10 bitsï¼Œå¦‚æœç¼©å° bloom å ç”¨çš„ç©ºé—´ï¼Œå¯ä»¥è®¾ç½® options.optimize_filters_for_hits = trueï¼Œåˆ™æœ€åä¸€ä¸ª level çš„ filter ä¼šè¢«å…³é—­ï¼Œbloom å ç”¨ç‡åªä¼šç”¨åˆ°åŸæ¥çš„ 10% ã€‚ ç»“åˆ block cache æ‰€è¿°ï¼Œindex &amp; filter æœ‰å¦‚ä¸‹ä¼˜åŒ–é€‰é¡¹ï¼š cache_index_and_filter_blocks è¿™ä¸ª option å¦‚æœä¸º trueï¼Œåˆ™ index &amp; filter ä¼šè¢«å­˜å…¥ block cacheï¼Œè€Œ block cache ä¸­çš„å†…å®¹ä¼šéšç€ page cache è¢«äº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œè¿™å°±ä¼šå¤§å¤§é™ä½ RocksDBçš„æ€§èƒ½ï¼ŒæŠŠè¿™ä¸ª option è®¾ä¸º true çš„åŒæ—¶ä¹ŸæŠŠ pin_l0_filter_and_index_blocks_in_cache è®¾ä¸º trueï¼Œä»¥å‡å°å¯¹æ€§èƒ½çš„å½±å“ã€‚ å¦‚æœ cache_index_and_filter_blocks è¢«è®¾ç½®ä¸º false ï¼ˆå…¶å€¼é»˜è®¤å°±æ˜¯ falseï¼‰ï¼Œindex/filter ä¸ªæ•°å°±ä¼šå— max_open_files å½±å“ï¼Œå®˜æ–¹å»ºè®®æŠŠè¿™ä¸ªé€‰é¡¹è®¾ç½®ä¸º -1ï¼Œä»¥æ–¹ä¾¿ RocksDB åŠ è½½æ‰€æœ‰çš„ index å’Œ filter æ–‡ä»¶ï¼Œæœ€å¤§åŒ–ç¨‹åºæ€§èƒ½ã€‚ å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç è·å– index &amp; filter å†…å­˜é‡å¤§å°ï¼šâ€‹ 12std::string out;db-&gt;GetProperty(â€œrocksdb.estimate-table-readers-memâ€, &amp;out); 2.3 Indexes and bloom filters block cacheã€index &amp; filter éƒ½æ˜¯è¯» bufferï¼Œè€Œ memtable åˆ™æ˜¯å†™ bufferï¼Œæ‰€æœ‰ kv é¦–å…ˆéƒ½ä¼šè¢«å†™è¿› memtableï¼Œå…¶ size æ˜¯ write_buffer_sizeã€‚ memtable å ç”¨çš„ç©ºé—´è¶Šå¤§ï¼Œåˆ™å†™æ”¾å¤§æ•ˆåº”è¶Šå°ï¼Œå› ä¸ºæ•°æ®åœ¨å†…å­˜è¢«æ•´ç†å¥½ï¼Œç£ç›˜ä¸Šå°±è¶Šå°‘çš„å†…å®¹ä¼šè¢« compactionã€‚å¦‚æœ memtable ç£ç›˜ç©ºé—´å¢å¤§ï¼Œåˆ™ L1 size ä¹Ÿå°±éšä¹‹å¢å¤§ï¼ŒL1 ç©ºé—´å¤§å°å— max_bytes_for_level_base option æ§åˆ¶ã€‚ å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç è·å– memtable å†…å­˜é‡å¤§å°ï¼š 12std::string out;db-&gt;GetProperty(â€œrocksdb.cur-size-all-mem-tablesâ€, &amp;out); 2.4 Blocks pinned by iterators è¿™éƒ¨åˆ†å†…å­˜ç©ºé—´ä¸€èˆ¬å ç”¨æ€»é‡ä¸å¤šï¼Œä½†æ˜¯å¦‚æœæœ‰ 100k ä¹‹å¤šçš„transactions å‘ç”Ÿï¼Œæ¯ä¸ª iterator ä¸ä¸€ä¸ª data block å¤–åŠ ä¸€ä¸ª L1 çš„ data blockï¼Œæ‰€ä»¥å†…å­˜ä½¿ç”¨é‡å¤§çº¦ä¸º num_iterators * block_size * ((num_levels-1) + num_l0_files)ã€‚ å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç è·å– Pin Blocks å†…å­˜é‡å¤§å°ï¼šâ€‹ 1table_options.block_cache-&gt;GetPinnedUsage(); 2.5 è¯»æµç¨‹ RocksDB çš„è¯»æµç¨‹åˆ†ä¸ºé€»è¾‘è¯»(logical read)å’Œç‰©ç†è¯»(physical read)ã€‚é€»è¾‘è¯»é€šå¸¸æ˜¯å¯¹ cacheã€Block Cache &amp; Table Cacheã€‘è¿›è¡Œè¯»å–ï¼Œç‰©ç†è¯»å°±æ˜¯ç›´æ¥è¯»ç£ç›˜ã€‚ å‚è€ƒæ–‡æ¡£ 12 è¯¦ç»†æè¿°äº† LeveDBï¼ˆRocksDBï¼‰çš„è¯»æµç¨‹ï¼Œè½¬è¿°å¦‚ä¸‹ï¼š åœ¨MemTableä¸­æŸ¥æ‰¾ï¼Œæ— æ³•å‘½ä¸­è½¬åˆ°ä¸‹ä¸€æµç¨‹ï¼› åœ¨immutable_memtableä¸­æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸ä¸­è½¬åˆ°ä¸‹ä¸€æµç¨‹ï¼› åœ¨ç¬¬0å±‚SSTableä¸­æŸ¥æ‰¾ï¼Œæ— æ³•å‘½ä¸­è½¬åˆ°ä¸‹ä¸€æµç¨‹ï¼› å¯¹äºL0 çš„æ–‡ä»¶ï¼ŒRocksDB é‡‡ç”¨éå†çš„æ–¹æ³•æŸ¥æ‰¾ï¼Œæ‰€ä»¥ä¸ºäº†æŸ¥æ‰¾æ•ˆç‡ RocksDB ä¼šæ§åˆ¶ L0 çš„æ–‡ä»¶ä¸ªæ•°ã€‚ åœ¨å‰©ä½™SSTableä¸­æŸ¥æ‰¾ã€‚ å¯¹äº L1 å±‚ä»¥åŠ L1 å±‚ä»¥ä¸Šå±‚çº§çš„æ–‡ä»¶ï¼Œæ¯ä¸ª SSTable æ²¡æœ‰äº¤å ï¼Œå¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾å¿«é€Ÿæ‰¾åˆ° key æ‰€åœ¨çš„ Level ä»¥åŠ SSTfileã€‚ è‡³äºå†™æµç¨‹ï¼Œè¯·å‚é˜… ### 5 Flush &amp; Compaction ç« èŠ‚å†…å®¹ã€‚ 2.6 memory pool ä¸ç®¡ RocksDB æœ‰å¤šå°‘ column familyï¼Œä¸€ä¸ª DB åªæœ‰ä¸€ä¸ª WriteControllerï¼Œä¸€æ—¦ DB ä¸­ä¸€ä¸ª column family å‘ç”Ÿå µå¡ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡å…¶ä»– column family çš„å†™ã€‚RocksDB å†™å…¥æ—¶é—´é•¿äº†ä»¥åï¼Œå¯èƒ½ä¼šä¸å®šæ—¶å‡ºç°è¾ƒå¤§çš„å†™æ¯›åˆºï¼Œå¯èƒ½æœ‰ä¸¤ä¸ªåœ°æ–¹å¯¼è‡´ RocksDB ä¼šå‡ºç°è¾ƒå¤§çš„å†™å»¶æ—¶ï¼šè·å– mutex æ—¶å¯èƒ½å‡ºç°å‡ åæ¯«ç§’å»¶è¿Ÿ å’Œ å°†æ•°æ®å†™å…¥ memtable æ—¶å€™å¯èƒ½å‡ºç°å‡ ç™¾æ¯«ç§’å»¶æ—¶ã€‚ è·å– mutex å‡ºç°çš„å»¶è¿Ÿæ˜¯å› ä¸º flush/compact çº¿ç¨‹ä¸è¯»å†™çº¿ç¨‹ç«äº‰å¯¼è‡´çš„ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´çº¿ç¨‹æ•°é‡é™ä½æ¯›åˆºæ—¶é—´ã€‚ è‡³äºå†™å…¥ memtable æ—¶å€™å‡ºç°çš„å†™æ¯›åˆºæ—¶é—´ï¼Œè§£å†³æ–¹æ³•ä¸€å°±æ˜¯ä½¿ç”¨å¤§çš„ page cacheï¼Œç¦ç”¨ç³»ç»Ÿ swap ä»¥åŠé…ç½® min_free_kbytesã€dirty_ratioã€dirty_background_ratio ç­‰å‚æ•°æ¥è°ƒæ•´ç³»ç»Ÿçš„å†…å­˜å›æ”¶ç­–ç•¥ï¼Œæ›´åŸºç¡€çš„æ–¹æ³•æ˜¯ä½¿ç”¨å†…å­˜æ± ã€‚ é‡‡ç”¨å†…å­˜æ± æ—¶ï¼Œmemtable çš„å†…å­˜åˆ†é…å’Œå›æ”¶æµç¨‹å›¾å¦‚ä¸‹ï¼š ä½¿ç”¨å†…å­˜æ± æ—¶ï¼ŒRocksDB çš„å†…å®¹åˆ†é…ä»£ç æ¨¡å—å¦‚ä¸‹ï¼š 3 Block Cache Block Cache æ˜¯ RocksDB çš„æ•°æ®çš„ç¼“å­˜ï¼Œè¿™ä¸ªç¼“å­˜å¯ä»¥åœ¨å¤šä¸ª RocksDB çš„å®ä¾‹ä¸‹ç¼“å­˜ã€‚ä¸€èˆ¬é»˜è®¤çš„Block Cache ä¸­å­˜å‚¨çš„å€¼æ˜¯æœªå‹ç¼©çš„ï¼Œè€Œç”¨æˆ·å¯ä»¥å†æŒ‡å®šä¸€ä¸ª Block Cacheï¼Œé‡Œé¢çš„æ•°æ®å¯ä»¥æ˜¯å‹ç¼©çš„ã€‚ç”¨æˆ·è®¿é—®æ•°æ®å…ˆè®¿é—®é»˜è®¤çš„ Block Cacheï¼Œå¾…æ— æ³•è·å–åå†è®¿é—®ç”¨æˆ· Cacheï¼Œç”¨æˆ· Cache çš„æ•°æ®å¯ä»¥ç›´æ¥å­˜å…¥ page cache ä¸­ã€‚ Cache æœ‰ä¸¤ç§ï¼šLRUCache å’Œ BlockCacheã€‚Block åˆ†ä¸ºå¾ˆå¤š Shardï¼Œä»¥å‡å°ç«äº‰ï¼Œæ‰€ä»¥ shard å¤§å°å‡åŒ€ä¸€è‡´ç›¸ç­‰ï¼Œé»˜è®¤ Cache æœ€å¤šæœ‰ 64 ä¸ª shardsï¼Œæ¯ä¸ª shard çš„ æœ€å° size ä¸º 512kï¼Œæ€»å¤§å°æ˜¯ 8Mï¼Œç±»åˆ«æ˜¯ LRUã€‚ 12345std::shared_ptr&lt;Cache&gt; cache = NewLRUCache(capacity); BlockedBasedTableOptions table_options; table_options.block_cache = cache; Options options; options.table_factory.reset(new BlockedBasedTableFactory(table_options)); è¿™ä¸ª Cache æ˜¯ä¸å‹ç¼©æ•°æ®çš„ï¼Œç”¨æˆ·å¯ä»¥è®¾ç½®å‹ç¼©æ•°æ® BlockCacheï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š 1table_options.block_cache_compressed = cache; å¦‚æœ Cache ä¸º nullptrï¼Œåˆ™RocksDBä¼šåˆ›å»ºä¸€ä¸ªï¼Œå¦‚æœæƒ³ç¦ç”¨ Cacheï¼Œå¯ä»¥è®¾ç½®å¦‚ä¸‹ Optionï¼š 1table_options.no_block_cache = true; é»˜è®¤æƒ…å†µä¸‹RocksDBç”¨çš„æ˜¯ LRUCacheï¼Œå¤§å°æ˜¯ 8MBï¼Œ æ¯ä¸ª shard å•ç‹¬ç»´æŠ¤è‡ªå·±çš„ LRU list å’Œç‹¬ç«‹çš„ hash tableï¼Œä»¥åŠè‡ªå·±çš„ Mutexã€‚ RocksDBè¿˜æä¾›äº†ä¸€ä¸ª ClockCacheï¼Œæ¯ä¸ª shard æœ‰è‡ªå·±çš„ä¸€ä¸ª circular listï¼Œæœ‰ä¸€ä¸ª clock handle ä¼šè½®è¯¢è¿™ä¸ª circular listï¼Œå¯»æ‰¾è¿‡æ—¶çš„ kvï¼Œå¦‚æœ entry ä¸­çš„ kv å·²ç»è¢«è®¿é—®è¿‡åˆ™å¯ä»¥ç»§ç»­å­˜ç•™ï¼Œç›¸å¯¹äº LRU å¥½å¤„æ˜¯æ—  mutex lockï¼Œcircular list æœ¬è´¨æ˜¯ tbb::concurrent_hash_mapï¼Œä» benchmark æ¥çœ‹ï¼ŒäºŒè€…å‘½ä¸­ç‡ç›¸ä¼¼ï¼Œä½†ååç‡ Clock æ¯” LRU ç¨é«˜ã€‚ Block Cacheåˆå§‹åŒ–ä¹‹æ—¶ç›¸å…³å‚æ•°ï¼š capacity æ€»çš„å†…å­˜ä½¿ç”¨é‡ num_shards_bits æŠŠ key çš„å‰ n bits ä½œä¸º shard idï¼Œåˆ™æ€» shard çš„æ•°ç›®ä¸º 2 ^ num_shards_bitsï¼› strict_capacity_limit åœ¨ä¸€äº›æç«¯æƒ…å†µä¸‹ block cache çš„æ€»ä½“ä½¿ç”¨é‡å¯èƒ½è¶…è¿‡ capacityï¼Œå¦‚åœ¨å¯¹ block è¿›è¡Œè¯»æˆ–è€…è¿­ä»£è¯»å–çš„æ—¶å€™å¯èƒ½æœ‰æ’å…¥æ•°æ®çš„æ“ä½œï¼Œæ­¤æ—¶å¯èƒ½å› ä¸ºåŠ é”å¯¼è‡´æœ‰äº›æ•°æ®æ— æ³•åŠæ—¶æ·˜æ±°ï¼Œä½¿å¾—æ€»ä½“capacityè¶…æ ‡ã€‚å¦‚æœè¿™ä¸ªé€‰é¡¹è®¾ç½®ä¸º trueï¼Œåˆ™æ­¤æ—¶æ’å…¥æ“ä½œæ˜¯è¢«å…è®¸çš„ï¼Œä½†æœ‰å¯èƒ½å¯¼è‡´è¿›ç¨‹ OOMã€‚å¦‚æœè®¾ç½®ä¸º falseï¼Œåˆ™æ’å…¥æ“ä½œä¼šè¢« refuseï¼ŒåŒæ—¶è¯»å–ä»¥åŠéå†æ“ä½œæœ‰å¯èƒ½å¤±è´¥ã€‚è¿™ä¸ªé€‰é¡¹å¯¹æ¯ä¸ª shard éƒ½æœ‰æ•ˆï¼Œè¿™å°±æ„å‘³ç€æœ‰çš„ shard å¯èƒ½å†…å­˜å·²æ»¡ï¼Œ åˆ«çš„ shard å´æœ‰å¾ˆå¤šç©ºé—²ã€‚ high_pri_pool_ratio blockä¸­ä¸ºé«˜ä¼˜å…ˆçº§çš„ block ä¿ç•™å¤šå°‘æ¯”ä¾‹çš„ç©ºé—´ï¼Œè¿™ä¸ªé€‰é¡¹åªæœ‰ LRU Cache æœ‰ã€‚ é»˜è®¤æƒ…å†µä¸‹ index å’Œfilter block ä¸ block cache æ˜¯ç‹¬ç«‹çš„ï¼Œç”¨æˆ·ä¸èƒ½è®¾å®šäºŒè€…çš„å†…å­˜ç©ºé—´ä½¿ç”¨é‡ï¼Œä½†ä¸ºäº†æ§åˆ¶ RocksDB çš„å†…å­˜ç©ºé—´ä½¿ç”¨é‡ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹ä»£ç æŠŠ index å’Œ filter ä¹Ÿæ”¾åœ¨ block cache ä¸­ï¼š 12BlockBasedTableOptions table_options;table_options.cache_index_and_filter_blocks = true; index ä¸ filter ä¸€èˆ¬è®¿é—®é¢‘æ¬¡æ¯” data é«˜ï¼Œæ‰€ä»¥æŠŠä»–ä»¬æ”¾åˆ°ä¸€èµ·ä¼šå¯¼è‡´å†…å­˜ç©ºé—´ä¸ cpu èµ„æºç«äº‰ï¼Œè¿›è€Œå¯¼è‡´ cache æ€§èƒ½æŠ–åŠ¨å‰å®³ã€‚æœ‰å¦‚ä¸‹ä¸¤ä¸ªå‚æ•°éœ€è¦æ³¨æ„ï¼šcache_index_filter_blocks_with_high_priority å’Œ high_pri_pool_ratio ä¸€æ ·ï¼Œè¿™ä¸ªå‚æ•°åªå¯¹ LRU Cache æœ‰æ•ˆï¼Œä¸¤è€…é¡»åŒæ—¶ç”Ÿæ•ˆã€‚è¿™ä¸ªé€‰é¡¹ä¼šæŠŠ LRU Cache åˆ’åˆ†ä¸ºé«˜ prio å’Œä½ prio åŒºï¼Œdata æ”¾åœ¨ low åŒºï¼Œindex å’Œ filter æ”¾åœ¨ high åŒºï¼Œå¦‚æœé«˜åŒºå ç”¨çš„å†…å­˜ç©ºé—´è¶…è¿‡äº† capacity * high_pri_pool_ratioï¼Œåˆ™ä¼šä¾µå  low åŒºçš„å°¾éƒ¨æ•°æ®ç©ºé—´ã€‚ pin_l0_filter_and_index_blocks_in_cache æŠŠ level0 çš„ index ä»¥åŠ filter block æ”¾åˆ° Block Cache ä¸­ï¼Œå› ä¸º l0 è®¿é—®é¢‘æ¬¡æœ€é«˜ï¼Œä¸€èˆ¬å†…å­˜å®¹é‡ä¸å¤§ï¼Œå ç”¨ä¸äº†å¤šå¤§å†…å­˜ç©ºé—´ã€‚ SimCache ç”¨äºè¯„æµ‹ Cache çš„å‘½ä¸­ç‡ï¼Œå®ƒå°è£…äº†ä¸€ä¸ªçœŸæ­£çš„ Cacheï¼Œç„¶åç”¨ç»™å®šçš„ capacity è¿›è¡Œ LRU æµ‹ç®—ï¼Œä»£ç å¦‚ä¸‹:â€‹â€‹```c++â€‹// This cache is the actual cache use by the DB.â€‹std::shared_ptr cache = NewLRUCache(capacity);â€‹// This is the simulated cache.â€‹std::shared_ptr sim_cache = NewSimCache(cache, sim_capacity, sim_num_shard_bits);â€‹BlockBasedTableOptions table_options;â€‹table_options.block_cache = sim_cache; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647å¤§æ¦‚åªæœ‰å®¹é‡çš„ 2% ä¼šè¢«ç”¨äºæµ‹ç®—ã€‚### 4 [Column Families](https:&#x2F;&#x2F;github.com&#x2F;facebook&#x2F;rocksdb&#x2F;wiki&#x2F;Column-Families)---RocksDB 3.0 ä»¥åæ·»åŠ äº†ä¸€ä¸ª Column Familyã€åé¢ç®€ç§° CFã€‘ çš„featureï¼Œæ¯ä¸ª kv å­˜å‚¨ä¹‹æ—¶éƒ½å¿…é¡»æŒ‡å®šå…¶æ‰€åœ¨çš„ CFã€‚RocksDBä¸ºäº†å…¼å®¹ä»¥å¾€ç‰ˆæœ¬ï¼Œé»˜è®¤åˆ›å»ºä¸€ä¸ª â€œdefaultâ€ çš„CFã€‚å­˜å‚¨ kv æ—¶å¦‚æœä¸æŒ‡å®š CFï¼ŒRocksDB ä¼šæŠŠå…¶å­˜å…¥ â€œdefaultâ€ CF ä¸­ã€‚#### 4.1 Option---RocksDB çš„ Option æœ‰ Options, ColumnFamilyOptions, DBOptions ä¸‰ç§ã€‚ColumnFamilyOptions æ˜¯ table çº§çš„ï¼Œè€Œ Options æ˜¯ DB çº§çš„ï¼ŒOptions ç»§æ‰¿è‡ª ColumnFamilyOptions å’Œ DBOptionsï¼Œå®ƒä¸€èˆ¬å½±å“åªæœ‰ä¸€ä¸ª CF çš„ DBï¼Œå¦‚ â€œdefaultâ€ã€‚æ¯ä¸ª CF éƒ½æœ‰ä¸€ä¸ª Handleï¼šColumnFamilyHandleï¼Œåœ¨ DB æŒ‡é’ˆè¢« delete å‰ï¼Œåº”è¯¥å…ˆ delete ColumnFamilyHandleã€‚å¦‚æœ ColumnFamilyHandle æŒ‡å‘çš„ CF è¢«åˆ«çš„ä½¿ç”¨è€…é€šè¿‡ DropColumnFamily åˆ é™¤æ‰ï¼Œè¿™ä¸ª CF ä»ç„¶å¯ä»¥è¢«è®¿é—®ï¼Œå› ä¸ºå…¶å¼•ç”¨è®¡æ•°ä¸ä¸º 0.åœ¨ä»¥ Read&#x2F;Write æ–¹å¼æ‰“å¼€ä¸€ä¸ª DB çš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªç”±æ‰€æœ‰å°†è¦ç”¨åˆ°çš„ CF string name æ„æˆçš„ ColumnFamilyDescriptor arrayã€‚ä¸ç®¡ â€œdefaultâ€ CF ä½¿ç”¨ä¸å¦ï¼Œéƒ½å¿…é¡»è¢«å¸¦ä¸Šã€‚CF å­˜åœ¨çš„æ„ä¹‰æ˜¯æ‰€æœ‰ table å…±äº« WALï¼Œä½†ä¸å…±äº« memtable å’Œ table æ–‡ä»¶ï¼Œé€šè¿‡ WAL ä¿è¯åŸå­å†™ï¼Œé€šè¿‡åˆ†ç¦» table å¯å¿«è¯»å¿«å†™å¿«åˆ é™¤ã€‚æ¯æ¬¡ flush ä¸€ä¸ª CF åï¼Œéƒ½ä¼šæ–°å»ºä¸€ä¸ª WALï¼Œéƒ½è¿™å¹¶ä¸æ„å‘³ç€æ—§çš„ WAL ä¼šè¢«åˆ é™¤ï¼Œå› ä¸ºåˆ«çš„ CF æ•°æ®å¯èƒ½è¿˜æ²¡æœ‰è½ç›˜ï¼Œåªæœ‰æ‰€æœ‰çš„ CF æ•°æ®éƒ½è¢« flush ä¸”æ‰€æœ‰çš„ WAL æœ‰å…³çš„ data éƒ½è½ç›˜ï¼Œç›¸å…³çš„ WAL æ‰ä¼šè¢«åˆ é™¤ã€‚RocksDB ä¼šå®šæ—¶æ‰§è¡Œ CF flush ä»»åŠ¡ï¼Œå¯ä»¥é€šè¿‡ &#96;Options::max_total_wal_size&#96; æŸ¥çœ‹å·²æœ‰å¤šå°‘æ—§çš„ CF æ–‡ä»¶å·²ç»è¢« flush äº†ã€‚RocksDB ä¼šåœ¨ç£ç›˜ä¸Šä¾æ® LSM ç®—æ³•å¯¹å¤šçº§ç£ç›˜æ–‡ä»¶è¿›è¡Œ compactionï¼Œè¿™ä¼šå½±å“å†™æ€§èƒ½ï¼Œæ‹–æ…¢ç¨‹åºæ€§èƒ½ï¼Œå¯ä»¥é€šè¿‡ &#96;WriteOptions.low_pri &#x3D; true&#96; é™ä½ compaction çš„ä¼˜å…ˆçº§ã€‚#### 4.2 [Set Up Option](https:&#x2F;&#x2F;github.com&#x2F;facebook&#x2F;rocksdb&#x2F;wiki&#x2F;Set-Up-Options)---RocksDB æœ‰å¾ˆå¤šé€‰é¡¹ä»¥ä¸“é—¨çš„ç›®çš„è¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸éœ€è¦è¿›è¡Œç‰¹æ®Šçš„ä¼˜åŒ–ã€‚è¿™é‡Œåªåˆ—å‡ºä¸€ä¸ªå¸¸ç”¨çš„ä¼˜åŒ–é€‰é¡¹ã€‚* &#96;cf_options.write_buffer_size&#96;CF çš„ write buffer çš„æœ€å¤§ sizeã€‚æœ€å·®æƒ…å†µä¸‹ RocksDB ä½¿ç”¨çš„å†…å­˜é‡ä¼šç¿»å€ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦è½»æ˜“ä¿®æ”¹å…¶å€¼ã€‚* Set block cache sizeè¿™ä¸ªå€¼ä¸€èˆ¬è®¾ç½®ä¸º RocksDB æƒ³è¦ä½¿ç”¨çš„å†…å­˜æ€»é‡çš„ 1&#x2F;3ï¼Œå…¶ä½™çš„ç•™ç»™ OS çš„ page cacheã€‚&#96;&#96;&#96;C++ BlockBasedTableOptions table_options; â€¦ \\\\ set options in table_options options.table_factory.reset(new std::shared_ptr&lt;Cache&gt; cache &#x3D; NewLRUCache(&lt;your_cache_size&gt;); table_options.block_cache &#x3D; cache; BlockBasedTableFactory(table_options)); æœ¬è¿›ç¨‹çš„æ‰€æœ‰çš„ DB æ‰€æœ‰çš„ CF æ‰€æœ‰çš„ table_options éƒ½å¿…é¡»ä½¿ç”¨åŒä¸€ä¸ª cahce å¯¹è±¡ï¼Œæˆ–è€…è®©æ‰€æœ‰çš„ DB æ‰€æœ‰çš„ CF ä½¿ç”¨åŒä¸€ä¸ª table_optionsã€‚ cf_options.compression, cf_options.bottonmost_compression é€‰æ‹©å‹ç¼©æ–¹æ³•è·Ÿä½ çš„æœºå™¨ã€CPU èƒ½åŠ›ä»¥åŠå†…å­˜ç£ç›˜ç©ºé—´å¤§å°æœ‰å…³ï¼Œå®˜æ–¹æ¨è cf_options.compression ä½¿ç”¨ kLZ4Compressionï¼Œcf_options.bottonmost_compression ä½¿ç”¨ kZSTDï¼Œé€‰ç”¨çš„æ—¶å€™è¦ç¡®è®¤ä½ çš„æœºå™¨æœ‰è¿™ä¸¤ä¸ªåº“ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹ä¹Ÿå¯ä»¥åˆ†åˆ«ä½¿ç”¨ Snappy å’Œ Zlibã€‚ Bloom filter å®˜æ–¹çœŸæ­£å»ºè®®ä¿®æ”¹çš„å‚æ•°åªæœ‰è¿™ä¸ª filter å‚æ•°ã€‚å¦‚æœå¤§é‡ä½¿ç”¨è¿­ä»£æ–¹æ³•ï¼Œä¸è¦ä¿®æ”¹è¿™ä¸ªå‚æ•°ï¼Œå¦‚æœå¤§é‡è°ƒç”¨ Get() æ¥å£ï¼Œå»ºè®®ä¿®æ”¹è¿™ä¸ªå‚æ•°ã€‚ä¿®æ”¹æ–¹æ³•å¦‚ä¸‹ï¼š 1table_options.filter_policy.reset(NewBloomFilterPolicy(10, false)); ä¸€ä¸ªå¯èƒ½çš„ä¼˜åŒ–è®¾å®šå¦‚ä¸‹ï¼š 1234567cf_options.level_compaction_dynamic_level_bytes &#x3D; true;options.max_background_compactions &#x3D; 4;options.max_background_flushes &#x3D; 2;options.bytes_per_sync &#x3D; 1048576;table_options.block_size &#x3D; 16 * 1024;table_options.cache_index_and_filter_blocks &#x3D; true;table_options.pin_l0_filter_and_index_blocks_in_cache &#x3D; true; ä¸Šé¢åªæ˜¯ç½—åˆ—äº†ä¸€äº›ä¼˜åŒ–é€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹ä¹Ÿåªèƒ½åœ¨è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™è®¾å®šã€‚æ›´å¤šçš„é€‰é¡¹è¯·è¯¦ç»†é˜…è¯»å‚è€ƒæ–‡æ¡£1ã€‚ 4.3 WriteOption &amp; Persistence å‚è€ƒæ–‡æ¡£ 5 çš„ Persistence ä¸€èŠ‚æåˆ°ï¼ŒRocksDB æ¯æ¬¡æ¥æ”¶å†™è¯·æ±‚çš„æ—¶å€™ï¼Œè¯·æ±‚å†…å®¹ä¼šå…ˆè¢«å†™å…¥ WAL transaction logï¼Œç„¶åå†æŠŠæ•°æ®å†™å…¥ memfile é‡Œé¢ã€‚ Put å‡½æ•°çš„å‚æ•° WriteOptions é‡Œæœ‰ä¸€ä¸ªé€‰é¡¹å¯ä»¥æŒ‡æ˜æ˜¯å¦éœ€è¦æŠŠå†™è¯·æ±‚çš„å†…å®¹å†™å…¥ WAL log é‡Œé¢ã€‚ RocksDB å†…éƒ¨æœ‰ä¸€ä¸ª batch-commit æœºåˆ¶ï¼Œé€šè¿‡ä¸€æ¬¡ commit æ‰¹é‡åœ°åœ¨ä¸€æ¬¡ sync æ“ä½œé‡ŒæŠŠæ‰€æœ‰ transactions log å†™å…¥ç£ç›˜ã€‚ 5 Flush &amp; Compaction &amp; Merge RocksDB çš„å†…å­˜æ•°æ®åœ¨ memtable ä¸­å­˜ç€ï¼Œæœ‰ active-memtable å’Œ immutable-memtable ä¸¤ç§ã€‚active-memtable æ˜¯å½“å‰è¢«å†™æ“ä½œä½¿ç”¨çš„ memtableï¼Œå½“ active-memtable ç©ºé—´å†™æ»¡ä¹‹å( Options.write_buffer_size æ§åˆ¶å…¶å†…å­˜ç©ºé—´å¤§å° )è¿™ä¸ªç©ºé—´ä¼šè¢«æ ‡è®°ä¸º readonly æˆä¸º immutable-memtableã€‚memtable å®è´¨ä¸Šæ˜¯ä¸€ç§æœ‰åº SkipListï¼Œæ‰€ä»¥å†™è¿‡ç¨‹å…¶å®æ˜¯å†™ WAL æ—¥å¿—å’Œæ•°æ®æ’å…¥ SkipList çš„è¿‡ç¨‹ã€‚ RocksDB çš„æ•°æ®åˆ é™¤è¿‡ç¨‹è·Ÿå†™è¿‡ç¨‹ç›¸åŒï¼Œåªä¸è¿‡ æ’å…¥çš„æ•°æ®æ˜¯ â€œkey:åˆ é™¤æ ‡è®°â€ã€‚ immutable-memtable è¢«å†™å…¥ L0 çš„è¿‡ç¨‹è¢«ç§°ä¸º flush æˆ–è€… minor compactionã€‚flush çš„è§¦å‘æ¡ä»¶æ˜¯ immutable memtableæ•°é‡è¶…è¿‡ min_write_buffer_number_to_mergeã€‚flush è¿‡ç¨‹ä»¥ column family ä¸ºå•ä½ï¼Œä¸€ä¸ª column family ä¼šä½¿ç”¨ä¸€ä¸ªæˆ–è€…å¤šä¸ª immutable-memtableï¼Œflush ä¼šä¸€æ¬¡æŠŠæ‰€æœ‰è¿™äº›æ–‡ä»¶åˆå¹¶åå†™å…¥ç£ç›˜çš„ L0 sstfile ä¸­ã€‚ åœ¨ compaction è¿‡ç¨‹ä¸­å¦‚æœæŸä¸ªè¢«æ ‡è®°ä¸ºåˆ é™¤çš„ key åœ¨æŸä¸ª snapshot ä¸­å­˜åœ¨ï¼Œåˆ™ä¼šè¢«ä¸€ç›´ä¿ç•™ï¼Œç›´åˆ° snapshot ä¸å­˜åœ¨æ‰ä¼šè¢«åˆ é™¤ã€‚ RocksDB çš„ compaction ç­–ç•¥åˆ†ä¸º Universal Compaction å’Œ Leveled Compaction ä¸¤ç§ã€‚ä¸¤ç§ç­–ç•¥åˆ†åˆ«æœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œä¸‹é¢åˆ†ä¸¤ä¸ªç« èŠ‚è¯¦è¿°ã€‚ç»¼è¿°å°±æ˜¯ Leveled Compaction æœ‰åˆ©äºå‡å°ç©ºé—´æ”¾å¤§å´ä¼šå¢åŠ è¯»æ”¾å¤§ï¼ŒUniversal Compaction æœ‰åˆ©äºå‡å°‘è¯»æ”¾å¤§å´ä¼šå¢å¤§ç©ºé—´æ”¾å¤§ã€‚ 5.1 Leveled Compaction compaction çš„è§¦å‘æ¡ä»¶æ˜¯æ–‡ä»¶ä¸ªæ•°å’Œæ–‡ä»¶å¤§å°ã€‚L0 çš„è§¦å‘æ¡ä»¶æ˜¯ sst æ–‡ä»¶ä¸ªæ•°ï¼ˆlevel0_file_num_compaction_trigger æ§åˆ¶ï¼‰ï¼Œè§¦å‘ compaction score æ˜¯ L0 sst æ–‡ä»¶ä¸ªæ•°ä¸ level0_file_num_compaction_trigger çš„æ¯”å€¼æˆ–è€…æ‰€æœ‰æ–‡ä»¶çš„ size è¶…è¿‡ max_bytes_for_level_baseã€‚L1 ~ LN çš„è§¦å‘æ¡ä»¶åˆ™æ˜¯ sst æ–‡ä»¶çš„å¤§å°ã€‚ å¦‚æœ level_compaction_dynamic_level_bytes ä¸º falseï¼ŒL1 ~ LN æ¯ä¸ª level çš„æœ€å¤§å®¹é‡ç”± max_bytes_for_level_base å’Œ max_bytes_for_level_multiplier å†³å®šï¼Œå…¶ compaction score å°±æ˜¯å½“å‰æ€»å®¹é‡ä¸è®¾å®šçš„æœ€å¤§å®¹é‡ä¹‹æ¯”ï¼Œå¦‚æœæŸ level æ»¡è¶³ compaction çš„æ¡ä»¶åˆ™ä¼šè¢«åŠ å…¥ compaction é˜Ÿåˆ—ã€‚ å¦‚æœ level_compaction_dynamic_level_bytes ä¸º trueï¼Œåˆ™ Target_Size(Ln-1) = Target_Size(Ln) / max_bytes_for_level_multiplierï¼Œæ­¤æ—¶å¦‚æœæŸ level è®¡ç®—å‡ºæ¥çš„ target å€¼å°äº max_bytes_for_level_base / max_bytes_for_level_multiplierï¼Œåˆ™ RocksDB ä¸ä¼šå†è¿™ä¸ª level å­˜å‚¨ä»»ä½• sst æ•°æ®ã€‚ 5.1.1 Compaction Score compact æµç¨‹çš„ Compaction Scoreï¼Œä¸åŒ level çš„è®¡ç®—æ–¹æ³•ä¸ä¸€æ ·ï¼Œä¸‹é¢å…ˆåˆ—å‡º L0 çš„è®¡ç®—æ–¹æ³•ã€‚å…¶ä¸­ num ä»£è¡¨æœª compact æ–‡ä»¶çš„æ•°ç›®ã€‚ Param Value Description Score level0_file_num_compaction_trigger 4 num ä¸º 4 æ—¶ï¼Œè¾¾åˆ° compact æ¡ä»¶ num &lt; 20 æ—¶ Score = num / 4 level0_slowdown_writes_trigger 20 num ä¸º 20 æ—¶ï¼ŒRocksDB ä¼šå‡æ…¢å†™å…¥é€Ÿåº¦ 20 &lt;= num &amp;&amp; num &lt; 24 æ—¶ Score = 10000 level0_stop_writes_trigger 24 num ä¸º 24 æ—¶ï¼ŒRocksDB åœæ­¢å†™å…¥æ–‡ä»¶ï¼Œå°½å¿«å¯¹ L0 è¿›è¡Œ compact 24 &lt;= num æ—¶ Score = 1000000 å¯¹äº L1+ å±‚ï¼Œscore = Level_Bytes / Target_Sizeã€‚ 5.1.2 Level Max Bytes æ¯ä¸ª level å®¹é‡æ€»å¤§å°çš„è®¡ç®—å‰æ–‡å·²ç»æè¿‡ï¼Œ Param Value Description max_bytes_for_level_base 10485760 L1 æ€»å¤§å° max_bytes_for_level_multiplier 10 æœ€å¤§ä¹˜æ³•å› å­ max_bytes_for_level_multiplier_addtl[2â€¦6] 1 L2 ~ L6 æ€»å¤§å°è°ƒæ•´å‚æ•° æ¯ä¸ª level çš„æ€»å¤§å°è®¡ç®—å…¬å¼ä¸º Level_max_bytes[N] = Level_max_bytes[N-1] * max_bytes_for_level_multiplier^(N-1)*max_bytes_for_level_multiplier_additional[N-1]ã€‚ 5.1.3 compact file ä¸Šé¢è¯¦è¿°äº† compact level çš„é€‰æ‹©ï¼Œä½†æ˜¯æ¯ä¸ª level å…·ä½“çš„ compact æ–‡ä»¶å¯¹è±¡ï¼Œ L0 å±‚æ‰€æœ‰æ–‡ä»¶ä¼šè¢«é€‰åš compact å¯¹è±¡ï¼Œå› ä¸ºå®ƒä»¬æœ‰å¾ˆé«˜çš„æ¦‚ç‡æ‰€æœ‰æ–‡ä»¶çš„ key range å‘ç”Ÿé‡å ã€‚ å¯¹äº L1+ å±‚çš„æ–‡ä»¶ï¼Œå…ˆå¯¹æ‰€æœ‰æ–‡ä»¶çš„å¤§å°è¿›è¡Œæ’åºä»¥é€‰å‡ºæœ€å¤§æ–‡ä»¶ã€‚ LevelDB çš„æ–‡ä»¶é€‰å–è¿‡ç¨‹å¦‚ä¸‹ï¼š LN ä¸­æ¯ä¸ªæ–‡ä»¶éƒ½ä¸€ä¸ª seek æ•°å€¼ï¼Œå…¶é»˜è®¤å€¼éé›¶ï¼Œæ¯æ¬¡è®¿é—®åè¿™ä¸ªæ•°å€¼å‡ 1ï¼Œå…¶å€¼è¶Šå°è¯´æ˜è®¿é—®è¶Šé¢‘ç¹ã€‚sst æ–‡ä»¶çš„ç­–ç•¥å¦‚ä¸‹ï¼š 1 é€‰æ‹© seek æ¬¡æ•°ä¸º 0 çš„æ–‡ä»¶è¿›è¡Œ mergeï¼Œå¦‚æœæ²¡æœ‰ seek æ¬¡æ•°ä¸º 0 çš„æ–‡ä»¶ï¼Œåˆ™ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶å¼€å§‹è¿›è¡Œ compactï¼› 2 ä¸€æ¬¡ compact åè®°å½•æœ¬æ¬¡ç»“æŸçš„ keyï¼Œä¸‹æ¬¡ compact å¼€å§‹æ—¶ä»¥è¿™ä¸ª key ä¸ºèµ·å§‹ç»§ç»­è¿›è¡Œ compactã€‚ 5.1.4 compaction å¤§è‡´çš„ compaction æµç¨‹å¤§è‡´ä¸ºï¼š 1 æ‰¾åˆ° score æœ€é«˜çš„ levelï¼› 2 æ ¹æ®ä¸€å®šç­–ç•¥ä» level ä¸­é€‰æ‹©ä¸€ä¸ª sst æ–‡ä»¶è¿›è¡Œ compactï¼ŒL0 çš„å„ä¸ª sst æ–‡ä»¶ä¹‹é—´ key range ã€minkeyï¼Œ maxkeyã€‘ æœ‰é‡å ï¼Œæ‰€ä»¥å¯èƒ½ä¸€æ¬¡é€‰å–å¤šä¸ªï¼› 3 è·å– sst æ–‡ä»¶çš„ minkey å’Œ maxkey; 4 ä» level + 1 ä¸­é€‰å–å‡ºäº (minkey, maxkey) ç”¨é‡å çš„ sst æ–‡ä»¶ï¼Œæœ‰é‡å çš„æ–‡ä»¶åˆ™æŠŠæ–‡ä»¶ä¸ level ä¸­çš„æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼ˆmerge - sortï¼‰ä½œä¸ºç›®æ ‡æ–‡ä»¶ï¼Œæ²¡æœ‰é‡å æ–‡ä»¶åˆ™æŠŠåŸå§‹æ–‡ä»¶ä½œä¸ºç›®æ ‡æ–‡ä»¶ï¼› 5 å¯¹ç›®æ ‡æ–‡ä»¶è¿›è¡Œå‹ç¼©åæ”¾å…¥ level + 1 ä¸­ã€‚ 5.1.5 å¹¶è¡Œ Compact ä¸ sub-compact å‚æ•° max_background_compactions å¤§äº 1 æ—¶ï¼ŒRocksDB ä¼šè¿›è¡Œå¹¶è¡Œ Compactï¼Œä½† L0 å’Œ L1 å±‚çš„ Compaction ä»»åŠ¡ä¸èƒ½è¿›è¡Œå¹¶è¡Œã€‚ ä¸€æ¬¡ compaction åªèƒ½ compact ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ–‡ä»¶ï¼Œè¿™ä¼šçº¦æŸæ•´ä½“ compaction é€Ÿåº¦ã€‚ç”¨æˆ·å¯ä»¥è®¾ç½® max_subcompactions å‚æ•°å¤§äº 1ï¼ŒRocksDB å¦‚ä¸Šå›¾ä¸€æ ·å°è¯•æŠŠä¸€ä¸ªæ–‡ä»¶æ‹†ä¸ºå¤šä¸ª subï¼Œç„¶åå¯åŠ¨å¤šä¸ªçº¿ç¨‹æ‰§è¡Œ sub-compactã€‚ 5.2 Universal Compaction Univesal Compaction ä¸»è¦é’ˆå¯¹ L0ã€‚å½“ L0 ä¸­çš„æ–‡ä»¶ä¸ªæ•°å¤šäº level0_file_num_compaction_triggerï¼Œåˆ™å¯åŠ¨ compactã€‚ L0 ä¸­æ‰€æœ‰çš„ sst æ–‡ä»¶éƒ½å¯èƒ½å­˜åœ¨é‡å çš„ key rangeï¼Œå‡è®¾æ‰€æœ‰çš„ sst æ–‡ä»¶ç»„æˆäº†æ–‡ä»¶é˜Ÿåˆ— R1,R2,R3,â€¦,Rnï¼ŒR1 æ–‡ä»¶çš„æ•°æ®æ˜¯æœ€æ–°çš„ï¼ŒR2 å…¶æ¬¡ï¼ŒRn åˆ™åŒ…å«äº†æœ€è€çš„æ•°æ®ï¼Œå…¶ compact æµç¨‹å¦‚ä¸‹ï¼š 1 å¦‚æœç©ºé—´æ”¾å¤§è¶…è¿‡ max_size_amplification_percentï¼Œåˆ™å¯¹æ‰€æœ‰çš„ sst è¿›è¡Œ compactionï¼ˆå°±æ˜¯æ‰€è°“çš„ full compactionï¼‰ï¼› 2 å¦‚æœå‰size(R1)å°äºsize(R2)åœ¨ä¸€å®šæ¯”ä¾‹ï¼Œé»˜è®¤1%ï¼Œåˆ™ä¸R1ä¸R2ä¸€èµ·è¿›è¡Œcompactionï¼Œå¦‚æœï¼ˆR1+R2)*(100+ratio)%100&lt;R3ï¼Œåˆ™å°†R3ä¹ŸåŠ å…¥åˆ°compactionä»»åŠ¡ä¸­ï¼Œä¾æ¬¡é¡ºåºåŠ å…¥sstæ–‡ä»¶ï¼› å¦‚æœç¬¬1å’Œç¬¬2ç§æƒ…å†µéƒ½æ²¡æœ‰compactionï¼Œåˆ™å¼ºåˆ¶é€‰æ‹©å‰Nä¸ªæ–‡ä»¶è¿›è¡Œåˆå¹¶ã€‚ Universal Compaction ä¸»è¦é’ˆå¯¹ä½å†™æ”¾å¤§åœºæ™¯ï¼Œè·Ÿ Leveled Compaction ç›¸æ¯”ä¸€æ¬¡åˆå¹¶æ–‡ä»¶è¾ƒå¤šä½†å› ä¸ºä¸€æ¬¡åªå¤„ç† L0 æ‰€ä»¥å†™æ”¾å¤§æ•´ä½“è¾ƒä½ï¼Œä½†æ˜¯ç©ºé—´æ”¾å¤§æ•ˆåº”æ¯”è¾ƒå¤§ã€‚ RocksDB è¿˜æ”¯æŒä¸€ç§ FIFO çš„ compactionã€‚FIFO é¡¾åæ€ä¹‰å°±æ˜¯å…ˆè¿›å…ˆå‡ºï¼Œè¿™ç§æ¨¡å¼å‘¨æœŸæ€§åœ°åˆ é™¤æ—§æ•°æ®ã€‚åœ¨ FIFO æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½åœ¨ L0ï¼Œå½“ sst æ–‡ä»¶æ€»å¤§å°è¶…è¿‡é˜€å€¼ max_table_files_sizeï¼Œåˆ™åˆ é™¤æœ€è€çš„ sst æ–‡ä»¶ã€‚å‚è€ƒæ–‡æ¡£21ä¸­æåˆ°å¯ä»¥åŸºäº FIFO compaction æœºåˆ¶æŠŠ RocksDB å½“åšä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼šå¯¹äº FIFO æ¥è¯´ï¼Œå®ƒçš„ç­–ç•¥éå¸¸çš„ç®€å•ï¼Œæ‰€æœ‰çš„ SST éƒ½åœ¨ Level 0ï¼Œå¦‚æœè¶…è¿‡äº†é˜ˆå€¼ï¼Œå°±ä»æœ€è€çš„ SST å¼€å§‹åˆ é™¤ï¼Œå…¶å®å¯ä»¥çœ‹åˆ°ï¼Œè¿™å¥—æœºåˆ¶éå¸¸é€‚åˆäºå­˜å‚¨æ—¶åºæ•°æ®ã€‚ æ•´ä¸ª compaction æ˜¯ LSM-tree æ•°æ®ç»“æ„çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯rocksDBçš„æ ¸å¿ƒï¼Œè¯¦ç»†å†…å®¹è¯·é˜…è¯» å‚è€ƒæ–‡æ¡£8 å’Œ å‚è€ƒæ–‡æ¡£9ã€‚ 5.4 Merge RocksDB è‡ªèº«ä¹‹æä¾›äº† Put/Delete/Get ç­‰æ¥å£ï¼Œè‹¥éœ€è¦åœ¨ç°æœ‰å€¼ä¸Šè¿›è¡Œä¿®æ”¹æ“ä½œã€æˆ–è€…æˆä¸ºå¢é‡æ›´æ–°ã€‘ï¼Œå¯ä»¥å€ŸåŠ©è¿™ä¸‰ä¸ªæ“ä½œè¿›è¡Œä»¥ä¸‹æ“ä½œå®ç°ä¹‹ï¼š è°ƒç”¨ Get æ¥å£ç„¶åè·å–å…¶å€¼ï¼› åœ¨å†…å­˜ä¸­ä¿®æ”¹è¿™ä¸ªå€¼ï¼› è°ƒç”¨ Put æ¥å£å†™å› RocksDBã€‚ å¦‚æœå¸Œæœ›æ•´ä¸ªè¿‡ç¨‹æ˜¯åŸå­æ“ä½œï¼Œå°±éœ€è¦å€ŸåŠ© RocksDB çš„ Merge æ¥å£äº†ã€‚å‚è€ƒæ–‡æ¡£14 ç»™å‡ºäº† RocksDB Merge æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š 1 å°è£…äº†read - modify - writeè¯­ä¹‰ï¼Œå¯¹å¤–ç»Ÿä¸€æä¾›ç®€å•çš„æŠ½è±¡æ¥å£ï¼› 2 å‡å°‘ç”¨æˆ·é‡å¤è§¦å‘Getæ“ä½œå¼•å…¥çš„æ€§èƒ½æŸè€—ï¼› 3 é€šè¿‡å†³å®šåˆå¹¶æ“ä½œçš„æ—¶é—´å’Œæ–¹å¼ï¼Œæ¥ä¼˜åŒ–åç«¯æ€§èƒ½ï¼Œå¹¶è¾¾åˆ°å¹¶ä¸æ”¹å˜åº•å±‚æ›´æ–°çš„è¯­ä¹‰ï¼› 4 æ¸è¿›å¼çš„æ›´æ–°ï¼Œæ¥å‡æ‘Šæ›´æ–°å¸¦æ¥å¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼Œä»¥å¾—åˆ°æ¸è¿›å¼çš„æ€§èƒ½æå‡ã€‚ RocksDB æä¾›äº†ä¸€ä¸ª MergeOperator ä½œä¸º Merge æ¥å£ï¼Œå…¶ä¸­ä¸€ä¸ªå­ç±» AssociativeMergeOperator å¯åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334// The simpler, associative merge operator.class AssociativeMergeOperator : public MergeOperator &#123; public: virtual ~AssociativeMergeOperator() &#123;&#125; // Gives the client a way to express the read -&gt; modify -&gt; write semantics // key: (IN) æ“ä½œå¯¹è±¡ KV çš„ key // existing_value:(IN) æ“ä½œå¯¹è±¡ KV çš„ valueï¼Œå¦‚æœä¸º null åˆ™æ„å‘³ç€ KV ä¸å­˜åœ¨ // value: (IN) æ–°å€¼ï¼Œç”¨äºæ›¿æ¢/æ›´æ–° @existing_value // new_value: (OUT) å®¢æˆ·ç«¯è´Ÿè´£æŠŠ merge åçš„æ–°å€¼å¡«å…¥è¿™ä¸ªå˜é‡ // logger: (IN) Client could use this to log errors during merge. // // Return true on success. // All values passed in will be client-specific values. So if this method // returns false, it is because client specified bad data or there was // internal corruption. The client should assume that this will be treated // as an error by the library. virtual bool Merge(const Slice&amp; key, const Slice* existing_value, const Slice&amp; value, std::string* new_value, Logger* logger) const = 0; private: // Default implementations of the MergeOperator functions virtual bool FullMergeV2(const MergeOperationInput&amp; merge_in, MergeOperationOutput* merge_out) const override; virtual bool PartialMerge(const Slice&amp; key, const Slice&amp; left_operand, const Slice&amp; right_operand, std::string* new_value, Logger* logger) const override;&#125;; RocksDB AssociativeMergeOperator è¢«ç§°ä¸ºå…³è”æ€§ Merge Operatorï¼Œå‚è€ƒæ–‡æ¡£14 ç»™å‡ºäº†å…³è”æ€§çš„å®šä¹‰ï¼š è°ƒç”¨Putæ¥å£å†™å…¥RocksDBçš„æ•°æ®çš„æ ¼å¼å’ŒMergeæ¥å£æ˜¯ç›¸åŒçš„ ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„mergeæ“ä½œï¼Œå¯ä»¥å°†å¤šä¸ªmergeæ“ä½œæ•°åˆå¹¶æˆä¸€ä¸ª **MergeOperatorè¿˜å¯ä»¥ç”¨äºéå…³è”å‹æ•°æ®ç±»å‹çš„æ›´æ–°ã€‚** ä¾‹å¦‚ï¼Œåœ¨RocksDBä¸­ä¿å­˜jsonå­—ç¬¦ä¸²ï¼Œå³Putæ¥å£å†™å…¥dataçš„æ ¼å¼ä¸ºåˆæ³•çš„jsonå­—ç¬¦ä¸²ã€‚è€ŒMergeæ¥å£åªå¸Œæœ›æ›´æ–°jsonä¸­çš„æŸä¸ªå­—æ®µã€‚æ‰€ä»¥ä»£ç å¯èƒ½æ˜¯è¿™æ ·ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950 // Put/store the json string into to the database db_-&gt;Put(put_option_, \"json_obj_key\", \"&#123; employees: [ &#123;first_name: john, last_name: doe&#125;, &#123;first_name: adam, last_name: smith&#125;] &#125;\"); // Use a pre-defined \"merge operator\" to incrementally update the value of the json string db_-&gt;Merge(merge_option_, \"json_obj_key\", \"employees[1].first_name = lucy\"); db_-&gt;Merge(merge_option_, \"json_obj_key\", \"employees[0].last_name = dow\");`AssociativeMergeOperatoræ— æ³•å¤„ç†è¿™ç§åœºæ™¯ï¼Œå› ä¸ºå®ƒå‡è®¾Putå’ŒMergeçš„æ•°æ®æ ¼å¼æ˜¯å…³è”çš„ã€‚æˆ‘ä»¬éœ€è¦åŒºåˆ†Putå’ŒMergeçš„æ•°æ®æ ¼å¼ï¼Œä¹Ÿæ— æ³•æŠŠå¤šä¸ªmergeæ“ä½œæ•°åˆå¹¶æˆä¸€ä¸ªã€‚è¿™æ—¶å€™å°±éœ€è¦Generic MergeOperatorã€‚` // The Merge Operator // // Essentially, a MergeOperator specifies the SEMANTICS of a merge, which only // client knows. It could be numeric addition, list append, string // concatenation, edit data structure, ... , anything. // The library, on the other hand, is concerned with the exercise of this // interface, at the right time (during get, iteration, compaction...) class MergeOperator &#123; public: virtual ~MergeOperator() &#123;&#125; // Gives the client a way to express the read -&gt; modify -&gt; write semantics // key: (IN) The key that's associated with this merge operation. // existing: (IN) null indicates that the key does not exist before this op // operand_list:(IN) the sequence of merge operations to apply, front() first. // new_value: (OUT) Client is responsible for filling the merge result here // logger: (IN) Client could use this to log errors during merge. // // Return true on success. Return false failure / error / corruption. // ç”¨äºå¯¹å·²æœ‰çš„å€¼åšPutæˆ–Deleteæ“ä½œ virtual bool FullMerge(const Slice&amp; key, const Slice* existing_value, const std::deque&lt;std::string&gt;&amp; operand_list, std::string* new_value, Logger* logger) const = 0; // This function performs merge(left_op, right_op) // when both the operands are themselves merge operation types. // Save the result in *new_value and return true. If it is impossible // or infeasible to combine the two operations, return false instead. // å¦‚æœè¿ç»­å¤šæ¬¡å¯¹ä¸€ä¸ª key è¿›è¡Œæ“ä½œï¼Œåˆ™å¯ä»¥å¯ä»¥å€ŸåŠ© PartialMerge å°†ä¸¤ä¸ªæ“ä½œæ•°åˆå¹¶. virtual bool PartialMerge(const Slice&amp; key, const Slice&amp; left_operand, const Slice&amp; right_operand, std::string* new_value, Logger* logger) const = 0; // The name of the MergeOperator. Used to check for MergeOperator // mismatches (i.e., a DB created with one MergeOperator is // accessed using a different MergeOperator) virtual const char* Name() const = 0; &#125;; å·¥ä½œåŸç† å½“è°ƒç”¨DB::Put()å’ŒDB:Merge()æ¥å£æ—¶, å¹¶ä¸éœ€è¦ç«‹åˆ»è®¡ç®—æœ€åçš„ç»“æœ. RocksDBå°†è®¡ç®—çš„åŠ¨ä½œå»¶åè§¦å‘, ä¾‹å¦‚åœ¨ä¸‹ä¸€æ¬¡ç”¨æˆ·è°ƒç”¨Get, æˆ–è€…RocksDBå†³å®šåšCompactionæ—¶. æ‰€ä»¥, å½“mergeçš„åŠ¨ä½œçœŸæ­£å¼€å§‹åšçš„æ—¶å€™, å¯èƒ½ç§¯å‹(stack)äº†å¤šä¸ªæ“ä½œæ•°éœ€è¦å¤„ç†. è¿™ç§æƒ…å†µå°±éœ€è¦MergeOperator::FullMergeæ¥å¯¹existing_valueå’Œä¸€ä¸ªæ“ä½œæ•°åºåˆ—è¿›è¡Œè®¡ç®—, å¾—åˆ°æœ€ç»ˆçš„å€¼. PartialMerge å’Œ Stacking æœ‰æ—¶å€™, åœ¨è°ƒç”¨FullMergeä¹‹å‰, å¯ä»¥å…ˆå¯¹æŸäº›mergeæ“ä½œæ•°è¿›è¡Œåˆå¹¶å¤„ç†, è€Œä¸æ˜¯å°†å®ƒä»¬ä¿å­˜èµ·æ¥, è¿™å°±æ˜¯PartialMergeçš„ä½œç”¨: å°†ä¸¤ä¸ªæ“ä½œæ•°åˆå¹¶ä¸ºä¸€ä¸ª, å‡å°‘FullMergeçš„å·¥ä½œé‡.å½“é‡åˆ°ä¸¤ä¸ªmergeæ“ä½œæ•°æ—¶, RocksDBæ€»æ˜¯å…ˆä¼šå°è¯•è°ƒç”¨ç”¨æˆ·çš„PartialMergeæ–¹æ³•æ¥åšåˆå¹¶, å¦‚æœPartialMergeè¿”å›falseæ‰ä¼šä¿å­˜æ“ä½œæ•°. å½“é‡åˆ°Put/Deleteæ“ä½œ, å°±ä¼šè°ƒç”¨FullMergeå°†å·²å­˜åœ¨çš„å€¼å’Œæ“ä½œæ•°åºåˆ—ä¼ å…¥, è®¡ç®—å‡ºæœ€ç»ˆçš„å€¼. ä½¿ç”¨Associative Mergeçš„åœºæ™¯ merge æ“ä½œæ•°çš„æ ¼å¼å’ŒPutç›¸åŒå¤šä¸ªé¡ºåºçš„mergeæ“ä½œæ•°å¯ä»¥åˆå¹¶æˆä¸€ä¸ª ä½¿ç”¨Generic Mergeçš„åœºæ™¯ merge æ“ä½œæ•°çš„æ ¼å¼å’ŒPutä¸åŒå½“å¤šä¸ªmergeæ“ä½œæ•°å¯ä»¥åˆå¹¶æ—¶ï¼ŒPartialMerge()æ–¹æ³•è¿”å›true *!!!: æœ¬èŠ‚æ–‡å­—æ‘˜æŠ„è‡ª å‚è€ƒæ–‡æ¡£14 ã€‚ 6 ç£ç›˜æ–‡ä»¶ å‚è€ƒæ–‡æ¡£ 12 åˆ—ä¸¾äº† RocksDB ç£ç›˜ä¸Šæ•°æ®æ–‡ä»¶çš„ç§ç±»ï¼š * dbçš„æ“ä½œæ—¥å¿— * å­˜å‚¨å®é™…æ•°æ®çš„ SSTable æ–‡ä»¶ * DBçš„å…ƒä¿¡æ¯ Manifest æ–‡ä»¶ * è®°å½•å½“å‰æ­£åœ¨ä½¿ç”¨çš„ Manifest æ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹å°±æ˜¯å½“å‰çš„ manifest æ–‡ä»¶å * ç³»ç»Ÿçš„è¿è¡Œæ—¥å¿—ï¼Œè®°å½•ç³»ç»Ÿçš„è¿è¡Œä¿¡æ¯æˆ–è€…é”™è¯¯æ—¥å¿—ã€‚ * ä¸´æ—¶æ•°æ®åº“æ–‡ä»¶ï¼Œrepair æ—¶ä¸´æ—¶ç”Ÿæˆçš„ã€‚manifest æ–‡ä»¶è®°è½½äº†æ‰€æœ‰ SSTable æ–‡ä»¶çš„ key çš„èŒƒå›´ã€level çº§åˆ«ç­‰æ•°æ®ã€‚ ä¸Šé¢æ˜¯ leveldb çš„æ¶æ„å›¾ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒï¼Œæ˜ç™½å„ç§æ–‡ä»¶çš„ä½œç”¨ã€‚ 6.1 log æ–‡ä»¶ log æ–‡ä»¶å°±æ˜¯ WALã€‚ å¦‚ä¸Šå›¾ï¼Œlog æ–‡ä»¶çš„é€»è¾‘å•ä½æ˜¯ Recordï¼Œç‰©ç†å•ä½æ˜¯ blockï¼Œæ¯ä¸ª Record å¯ä»¥å­˜åœ¨äºä¸€ä¸ª block ä¸­ï¼Œä¹Ÿå¯ä»¥å ç”¨å¤šä¸ª blockã€‚Record çš„è¯¦ç»†ç»“æ„è§ä¸Šå›¾æ–‡å­—éƒ¨åˆ†ï¼Œå…¶ type å­—æ®µçš„æ„ä¹‰è§ä¸‹å›¾ã€‚ ä»ä¸Šå›¾å¯è§ Record typeçš„æ„ä¹‰ï¼šå¦‚æœæŸ KV è¿‡é•¿åˆ™å¯ä»¥ç”¨å¤š Record å­˜å‚¨ã€‚ 6.2 Manifest æ–‡ä»¶ RocksDB æ•´ä¸ª LSM æ ‘çš„ä¿¡æ¯éœ€è¦å¸¸é©»å†…å­˜ï¼Œä»¥è®© RocksDB å¿«é€Ÿè¿›è¡Œ kv æŸ¥æ‰¾æˆ–è€…è¿›è¡Œ compaction ä»»åŠ¡ï¼ŒRocksDB ä¼šç”¨æ–‡ä»¶æŠŠè¿™äº›ä¿¡æ¯å›ºåŒ–ä¸‹æ¥ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ Manifest æ–‡ä»¶ã€‚RocksDB ç§° Manifest æ–‡ä»¶è®°å½•äº† DB çŠ¶æ€å˜åŒ–çš„äº‹åŠ¡æ€§æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒè®°å½•äº†æ‰€æœ‰æ”¹å˜ DB çŠ¶æ€çš„æ“ä½œã€‚ä¸»è¦å†…å®¹æœ‰äº‹åŠ¡æ€§æ—¥å¿—å’Œæ•°æ®åº“çŠ¶æ€çš„å˜åŒ–ã€‚ RocksDB çš„å‡½æ•° VersionSet::LogAndApply æ˜¯å¯¹ Manifest æ–‡ä»¶çš„æ›´æ–°æ“ä½œï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å®šä½è¿™ä¸ªå‡½æ•°å‡ºç°çš„ä½ç½®æ¥è·Ÿè¸ª Manifest çš„è®°å½•å†…å®¹ã€‚ Manifest æ–‡ä»¶ä½œä¸ºäº‹åŠ¡æ€§æ—¥å¿—æ–‡ä»¶ï¼Œåªè¦æ•°æ®åº“æœ‰å˜åŒ–ï¼ŒManifestéƒ½ä¼šè®°å½•ã€‚å…¶å†…å®¹ size è¶…è¿‡è®¾å®šå€¼åä¼šè¢« VersionSet::WriteSnapShot é‡å†™ã€‚ RocksDB è¿›ç¨‹ Crash å Reboot çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé¦–å…ˆè¯»å– Manifest æ–‡ä»¶åœ¨å†…å­˜ä¸­é‡å»º LSM æ ‘ï¼Œç„¶åæ ¹æ® WAL æ—¥å¿—æ–‡ä»¶æ¢å¤ memtable å†…å®¹ã€‚ ä¸Šå›¾æ˜¯ leveldb çš„ Manifest æ–‡ä»¶ç»“æ„ï¼Œè¿™ä¸ª Manifest æ–‡ä»¶æœ‰ä»¥ä¸‹æ–‡ä»¶å†…å®¹ï¼š coparatoråã€logç¼–å·ã€å‰ä¸€ä¸ªlogç¼–å·ã€ä¸‹ä¸€ä¸ªæ–‡ä»¶ç¼–å·ã€ä¸Šä¸€ä¸ªåºåˆ—å·ï¼Œè¿™äº›éƒ½æ˜¯æ—¥å¿—ã€sstableæ–‡ä»¶ä½¿ç”¨åˆ°çš„é‡è¦ä¿¡æ¯ï¼Œè¿™äº›å­—æ®µä¸ä¸€å®šå¿…ç„¶å­˜åœ¨ï¼› å…¶æ¬¡æ˜¯compactç‚¹ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼Œå†™å…¥æ ¼å¼ä¸º{kCompactPointer, level, internal key} å…¶åæ˜¯åˆ é™¤æ–‡ä»¶ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼Œæ ¼å¼ä¸º{kDeletedFile, level, file number}ã€‚ æœ€åæ˜¯æ–°æ–‡ä»¶ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼Œæ ¼å¼ä¸º{kNewFile, level, file number, file size, min key, max key}ã€‚ RocksDB MANIFESTæ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åŸºæœ¬æ˜¯æ¥è‡ªäºVersionEditè¿™ä¸ªç»“æ„ï¼ŒMANIFESTåŒ…å«äº†ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªlogæ–‡ä»¶ä¸€ä¸ªåŒ…å«æœ€æ–°MANIFESTæ–‡ä»¶åçš„æ–‡ä»¶ï¼ŒManifestçš„logæ–‡ä»¶åæ˜¯è¿™æ · MANIFEST-(seqnumber)ï¼Œè¿™ä¸ªseqä¼šä¸€ç›´å¢é•¿ï¼Œåªæœ‰å½“ è¶…è¿‡äº†æŒ‡å®šçš„å¤§å°ä¹‹åï¼ŒMANIFESTä¼šåˆ·æ–°ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå½“æ–°çš„æ–‡ä»¶åˆ·æ–°åˆ°ç£ç›˜(å¹¶ä¸”æ–‡ä»¶åæ›´æ–°)ä¹‹åï¼Œè€çš„æ–‡ä»¶ä¼šè¢«åˆ é™¤æ‰ï¼Œè¿™é‡Œå¯ä»¥è®¤ä¸ºæ¯ä¸€æ¬¡MANIFESTçš„æ›´æ–°éƒ½ä»£è¡¨ä¸€æ¬¡snapshotï¼Œå…¶ç»“æ„æè¿°å¦‚ä¸‹ï¼š MANIFEST = { CURRENT, MANIFEST-&lt;seq-no&gt;* } CURRENT = File pointer to the latest manifest log MANIFEST-&lt;seq no&gt; = Contains snapshot of RocksDB state and subsequent modificationsåœ¨RocksDBä¸­ä»»æ„æ—¶é—´å­˜å‚¨å¼•æ“çš„çŠ¶æ€éƒ½ä¼šä¿å­˜ä¸ºä¸€ä¸ªVersion(ä¹Ÿå°±æ˜¯SSTçš„é›†åˆ)ï¼Œè€Œæ¯æ¬¡å¯¹Versionçš„ä¿®æ”¹éƒ½æ˜¯ä¸€ä¸ªVersionEdit,è€Œæœ€ç»ˆè¿™äº›VersionEditå°±æ˜¯ ç»„æˆmanifest-logæ–‡ä»¶çš„å†…å®¹ã€‚ ä¸‹é¢å°±æ˜¯MANIFESTçš„logæ–‡ä»¶çš„åŸºæœ¬æ„æˆ: version-edit = Any RocksDB state change version = { version-edit* } manifest-log-file = { version, version-edit* } = { version-edit* }å…³äº VersionSet ç›¸å…³ä»£ç åˆ†æè§å‚è€ƒæ–‡æ¡£13ã€‚ 6.3 SSTfile SSTfile ç»“æ„å¦‚ä¸‹ï¼š &lt;beginning_of_file&gt; [data block 1] [data block 2] â€¦ [data block N] [meta block 1: filter block] [meta block 2: stats block] [meta block 3: compression dictionary block] â€¦ [meta block K: future extended block] [metaindex block] [index block] [Footer] &lt;end_of_file&gt;LevelDB çš„ SSTfile ç»“æ„å¦‚ä¸‹ï¼š è§å‚è€ƒæ–‡æ¡£12ï¼ŒSSTtable å¤§è‡´åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š æ•°æ®å— Data Blockï¼Œç›´æ¥å­˜å‚¨æœ‰åºé”®å€¼å¯¹ï¼Œæ˜¯ SSTfile çš„æ•°æ®å®ä½“ï¼› Meta Blockï¼Œå­˜å‚¨Filterç›¸å…³ä¿¡æ¯ï¼› Meta Index Blockï¼Œå¯¹Meta Blockçš„ç´¢å¼•ï¼Œå®ƒåªæœ‰ä¸€æ¡è®°å½•ï¼Œkeyæ˜¯meta indexçš„åå­—ï¼ˆä¹Ÿå°±æ˜¯Filterçš„åå­—ï¼‰ï¼Œvalueä¸ºæŒ‡å‘meta indexçš„ä½ç½®ï¼› Index Blockï¼Œæ˜¯å¯¹Data Blockçš„ç´¢å¼•ï¼Œå¯¹äºå…¶ä¸­çš„æ¯ä¸ªè®°å½•ï¼Œå…¶key &gt;=Data Blockæœ€åä¸€æ¡è®°å½•çš„keyï¼ŒåŒæ—¶&lt;å…¶åData Blockçš„ç¬¬ä¸€æ¡è®°å½•çš„keyï¼›valueæ˜¯æŒ‡å‘data indexçš„ä½ç½®ä¿¡æ¯ï¼› Footerï¼ŒæŒ‡å‘å„ä¸ªåˆ†åŒºçš„ä½ç½®å’Œå¤§å°ã€‚ block ç»“æ„å¦‚ä¸‹å›¾ï¼š record ç»“æ„å¦‚ä¸‹å›¾ï¼š Footer ç»“æ„å¦‚ä¸‹å›¾ï¼š 6.4 memtable memtable ä¸­å­˜å‚¨äº†ä¸€äº› metadata å’Œ dataï¼Œdata åœ¨ skiplist ä¸­å­˜å‚¨ã€‚metadata æ•°æ®å¦‚ä¸‹ï¼ˆæºè‡ªå‚è€ƒæ–‡æ¡£ 12ï¼‰ï¼š å½“å‰æ—¥å¿—å¥æŸ„ï¼› ç‰ˆæœ¬ç®¡ç†å™¨ã€å½“å‰çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¯¹åº” compactionï¼‰å’Œå¯¹åº”çš„æŒä¹…åŒ–æ–‡ä»¶æ ‡ç¤ºï¼› å½“å‰çš„å…¨éƒ¨dbé…ç½®ä¿¡æ¯æ¯”å¦‚ comparator åŠå…¶å¯¹åº”çš„ memtable æŒ‡é’ˆï¼› å½“å‰çš„çŠ¶æ€ä¿¡æ¯ä»¥å†³å®šæ˜¯å¦éœ€è¦æŒä¹…åŒ– memtable å’Œåˆå¹¶ sstableï¼› sstable æ–‡ä»¶é›†åˆçš„ä¿¡æ¯ã€‚ 6.5 VersionSet RocksDB çš„ Version è¡¨ç¤ºä¸€ä¸ªç‰ˆæœ¬çš„ metadataï¼Œå…¶ä¸»è¦å†…å®¹æ˜¯ FileMetaData æŒ‡é’ˆçš„äºŒç»´æ•°ç»„ï¼Œåˆ†å±‚è®°å½•äº†æ‰€æœ‰çš„SSTæ–‡ä»¶ä¿¡æ¯ã€‚ FileMetaData æ•°æ®ç»“æ„ç”¨æ¥ç»´æŠ¤ä¸€ä¸ªæ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¤§å°ï¼Œæ–‡ä»¶ç¼–å·ï¼Œæœ€å¤§æœ€å°å€¼ï¼Œå¼•ç”¨è®¡æ•°ç­‰ä¿¡æ¯ï¼Œå…¶ä¸­å¼•ç”¨è®¡æ•°è®°å½•äº†è¢«ä¸åŒçš„Versionå¼•ç”¨çš„ä¸ªæ•°ï¼Œä¿è¯è¢«å¼•ç”¨ä¸­çš„æ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ã€‚ Versionä¸­è¿˜è®°å½•äº†è§¦å‘ Compaction ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¼šåœ¨è¯»å†™è¯·æ±‚æˆ– Compaction è¿‡ç¨‹ä¸­è¢«æ›´æ–°ã€‚åœ¨ CompactMemTable å’Œ BackgroundCompaction è¿‡ç¨‹ä¸­ä¼šå¯¼è‡´æ–°æ–‡ä»¶çš„äº§ç”Ÿå’Œæ—§æ–‡ä»¶çš„åˆ é™¤ï¼Œæ¯å½“è¿™ä¸ªæ—¶å€™éƒ½ä¼šæœ‰ä¸€ä¸ªæ–°çš„å¯¹åº”çš„Versionç”Ÿæˆï¼Œå¹¶æ’å…¥ VersionSet é“¾è¡¨å¤´éƒ¨ï¼ŒLevelDB ç”¨ VersionEdit æ¥è¡¨ç¤ºè¿™ç§ç›¸é‚» Version çš„å·®å€¼ã€‚ VersionSet ç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå®ƒæ˜¯ä¸€ä¸ª Version æ„æˆçš„åŒå‘é“¾è¡¨ï¼Œè¿™äº›VersionæŒ‰æ—¶é—´é¡ºåºå…ˆåäº§ç”Ÿï¼Œè®°å½•äº†å½“æ—¶çš„å…ƒä¿¡æ¯ï¼Œé“¾è¡¨å¤´æŒ‡å‘å½“å‰æœ€æ–°çš„Versionï¼ŒåŒæ—¶ç»´æŠ¤äº†æ¯ä¸ªVersionçš„å¼•ç”¨è®¡æ•°ï¼Œè¢«å¼•ç”¨ä¸­çš„Versionä¸ä¼šè¢«åˆ é™¤ï¼Œå…¶å¯¹åº”çš„SSTæ–‡ä»¶ä¹Ÿå› æ­¤å¾—ä»¥ä¿ç•™ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½¿å¾—LevelDBå¯ä»¥åœ¨ä¸€ä¸ªç¨³å®šçš„å¿«ç…§è§†å›¾ä¸Šè®¿é—®æ–‡ä»¶ã€‚ VersionSetä¸­é™¤äº†Versionçš„åŒå‘é“¾è¡¨å¤–è¿˜ä¼šè®°å½•ä¸€äº›å¦‚LogNumberï¼ŒSequenceï¼Œä¸‹ä¸€ä¸ªSSTæ–‡ä»¶ç¼–å·çš„çŠ¶æ€ä¿¡æ¯ã€‚ 6.6 MetaData Restore æœ¬èŠ‚å†…å®¹èŠ‚é€‰è‡ªå‚è€ƒæ–‡æ¡£ 12ã€‚ ä¸ºäº†é¿å…è¿›ç¨‹å´©æºƒæˆ–æœºå™¨å®•æœºå¯¼è‡´çš„æ•°æ®ä¸¢å¤±ï¼ŒLevelDB éœ€è¦å°†å…ƒä¿¡æ¯æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ‰¿æ‹…è¿™ä¸ªä»»åŠ¡çš„å°±æ˜¯ Manifest æ–‡ä»¶ï¼Œæ¯å½“æœ‰æ–°çš„Versionäº§ç”Ÿéƒ½éœ€è¦æ›´æ–° Manifestã€‚ æ–°å¢æ•°æ®æ­£å¥½å¯¹åº”äºVersionEditå†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´Manifestæ–‡ä»¶è®°å½•çš„æ˜¯ä¸€ç»„VersionEditå€¼ï¼Œåœ¨Manifestä¸­çš„ä¸€æ¬¡å¢é‡å†…å®¹ç§°ä½œä¸€ä¸ªBlockã€‚ Manifest Block çš„è¯¦ç»†ç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚ ä¸Šå›¾æœ€ä¸Šé¢çš„æµç¨‹æ˜¾ç¤ºäº†æ¢å¤å…ƒä¿¡æ¯çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡åº”ç”¨ VersionEdit çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæœ‰å¤§é‡çš„ä¸´æ—¶ Version äº§ç”Ÿï¼Œä½†è¿™ç§æ–¹æ³•æ˜¾ç„¶å¤ªè¿‡äºè€—è´¹èµ„æºï¼ŒLevelDB å¼•å…¥ VersionSet::Builder æ¥é¿å…è¿™ç§ä¸­é—´å˜é‡ï¼Œæ–¹æ³•æ˜¯å…ˆå°†æ‰€æœ‰çš„VersoinEditå†…å®¹æ•´ç†åˆ°VersionBuilderä¸­ï¼Œç„¶åä¸€æ¬¡åº”ç”¨äº§ç”Ÿæœ€ç»ˆçš„Versionï¼Œè¯¦ç»†æµç¨‹å¦‚ä¸Šå›¾ä¸‹è¾¹æµç¨‹æ‰€ç¤ºã€‚ æ•°æ®æ¢å¤çš„è¯¦ç»†æµç¨‹å¦‚ä¸‹ï¼š ä¾æ¬¡è¯»å–Manifestæ–‡ä»¶ä¸­çš„æ¯ä¸€ä¸ªBlockï¼Œ å°†ä»æ–‡ä»¶ä¸­è¯»å‡ºçš„Recordååºåˆ—åŒ–ä¸ºVersionEditï¼› å°†æ¯ä¸€ä¸ªçš„VersionEdit Applyåˆ°VersionSet::Builderä¸­ï¼Œä¹‹åä»VersionSet::Builderçš„ä¿¡æ¯ä¸­ç”ŸæˆVersionï¼› è®¡ç®—compaction_level_ã€compaction_score_ï¼› å°†æ–°ç”Ÿæˆçš„VersionæŒ‚åˆ°VersionSetä¸­ï¼Œå¹¶åˆå§‹åŒ–VersionSetçš„manifest_file_number_ï¼Œ next_file_number_ï¼Œlast_sequence_ï¼Œlog_number_ï¼Œprev_log_number_ ä¿¡æ¯ï¼› 6.7 Snapshot RocksDB æ¯æ¬¡è¿›è¡Œæ›´æ–°æ“ä½œå°±ä¼šæŠŠæ›´æ–°å†…å®¹å†™å…¥ Manifest æ–‡ä»¶ï¼ŒåŒæ—¶å®ƒä¼šæ›´æ–°ç‰ˆæœ¬å·ã€‚ ç‰ˆæœ¬å·æ˜¯ä¸€ä¸ª 8 å­—èŠ‚çš„è¯ä¹¦ï¼Œæ¯ä¸ª key æ›´æ–°æ—¶ï¼Œé™¤äº†æ–°æ•°æ®è¢«å†™å…¥æ•°æ®æ–‡ä»¶ï¼ŒåŒæ—¶è®°å½•ä¸‹ RocksDB çš„ç‰ˆæœ¬å·ã€‚RocksDB çš„ Snapshot æ•°æ®ä»…ä»…æ˜¯é€»è¾‘æ•°æ®ï¼Œå¹¶æ²¡æœ‰å¯¹åº”çš„çœŸå®å­˜åœ¨çš„ç‰©ç†æ•°æ®ï¼Œä»…ä»…å¯¹åº”ä¸€ä¸‹å½“å‰ RocksDB çš„å…¨å±€ç‰ˆæœ¬å·è€Œå·²ï¼Œåªè¦ Snapshot å­˜åœ¨ï¼Œæ¯ä¸ª key å¯¹åº”ç‰ˆæœ¬å·çš„æ•°æ®åœ¨åé¢çš„æ›´æ–°ã€åˆ é™¤ã€åˆå¹¶æ—¶ä¼šä¸€å¹¶å­˜åœ¨ï¼Œä¸ä¼šè¢«åˆ é™¤ï¼Œä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ 6.7.1 Checkpoints Checkpoints æ˜¯ RocksDB æä¾›çš„ä¸€ç§ snapshotï¼Œç‹¬ç«‹çš„å­˜åœ¨ä¸€ä¸ªå•ç‹¬çš„ä¸åŒäº RocksDB è‡ªèº«æ•°æ®ç›®å½•çš„ç›®å½•ä¸­ï¼Œæ—¢å¯ä»¥ ReadOnly æ¨¡å¼æ‰“å¼€ï¼Œä¹Ÿå¯ä»¥ Read-Write æ¨¡å¼æ‰“å¼€ã€‚Checkpoints è¢«ç”¨äºå…¨é‡æˆ–è€…å¢é‡ Backup æœºåˆ¶ä¸­ã€‚ å¦‚æœ Checkpoints ç›®å½•å’Œ RocksDB æ•°æ®ç›®å½•åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œåˆ™ Checkpoints ç›®å½•ä¸‹çš„ SST æ˜¯ä¸€ä¸ª hard linkã€SST æ–‡ä»¶æ˜¯ Read-Onlyçš„ã€‘ï¼Œè€Œ manifest å’Œ CURRENT ä¸¤ä¸ªæ–‡ä»¶åˆ™ä¼šè¢«æ‹·è´å‡ºæ¥ã€‚å¦‚æœ DB æœ‰å¤šä¸ª Column Familyï¼Œwal æ–‡ä»¶ä¹Ÿä¼šè¢«å¤åˆ¶ï¼Œå…¶æ—¶é—´èŒƒå›´è¶³ä»¥è¦†ç›– Checkpoints çš„èµ·å§‹å’Œç»“æŸï¼Œä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ å¦‚æœä»¥ Read-Write æ¨¡å¼æ‰“å¼€ Checkpoints æ–‡ä»¶ï¼Œåˆ™å…¶ä¸­è¿‡æ—¶çš„ SST æ–‡ä»¶ä¼šè¢«åˆ é™¤æ‰ã€‚ 6.8 Backup RocksDB æä¾›äº† point-of-time æ•°æ®å¤‡ä»½åŠŸèƒ½ï¼Œå¯ä»¥è°ƒç”¨ BackupEngine::CreateNewBackup(db, flush_before_backup = false) æ¥å£è¿›è¡Œæ•°æ®å¤‡ä»½ï¼Œ å…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š ç¦æ­¢åˆ é™¤æ–‡ä»¶ï¼ˆsst æ–‡ä»¶å’Œ log æ–‡ä»¶ï¼‰ï¼› è°ƒç”¨ GetLiveFiles() è·å–å½“å‰çš„æœ‰æ•ˆæ–‡ä»¶ï¼Œå¦‚ table files, current, options and manifest file; å°† RocksDB ä¸­çš„æ‰€æœ‰çš„ sst/Manifest/é…ç½®/CURRENT ç­‰æœ‰æ•ˆæ–‡ä»¶å¤‡ä»½åˆ°æŒ‡å®šç›®å½•ï¼› GetLiveFiles() æ¥å£è¿”å›çš„ SST æ–‡ä»¶å¦‚æœå·²ç»è¢«å¤‡ä»½è¿‡ï¼Œåˆ™è¿™ä¸ªæ–‡ä»¶ä¸ä¼šè¢«é‡æ–°å¤åˆ¶åˆ°ç›®æ ‡å¤‡ä»½ç›®å½•ï¼Œä½†æ˜¯ BackupEngine ä¼šå¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œ checksum æ ¡éªŒï¼Œå¦‚æœæ ¡éªŒå¤±è´¥åˆ™ä¼šä¸­æ­¢å¤‡ä»½è¿‡ç¨‹ã€‚ å¦‚æœ flush_before_backup ä¸º falseï¼Œåˆ™BackupEngine ä¼šè°ƒç”¨ GetSortedWalFiles() æ¥å£æŠŠå½“å‰æœ‰æ•ˆçš„ wal æ–‡ä»¶ä¹Ÿæ‹·è´åˆ°å¤‡ä»½ç›®å½•ï¼› é‡æ–°å…è®¸åˆ é™¤æ–‡ä»¶ã€‚ sst æ–‡ä»¶åªæœ‰åœ¨ compact æ—¶æ‰ä¼šè¢«åˆ é™¤ï¼Œæ‰€ä»¥ç¦æ­¢åˆ é™¤å°±ç›¸å½“äºç¦æ­¢äº† compactionã€‚åˆ«çš„ RocksDB åœ¨è·å–è¿™äº›å¤‡ä»½æ•°æ®æ–‡ä»¶åä¼šä¾æ® Manifest æ–‡ä»¶é‡æ„ LSM ç»“æ„çš„åŒæ—¶ï¼Œä¹Ÿèƒ½æ¢å¤å‡º WAL æ–‡ä»¶ï¼Œè¿›è€Œé‡æ„å‡ºå½“æ—¶çš„ memtable æ–‡ä»¶ã€‚ åœ¨è¿›è¡Œ Backup çš„è¿‡ç¨‹ä¸­ï¼Œå†™æ“ä½œæ˜¯ä¸ä¼šè¢«é˜»å¡çš„ï¼Œæ‰€ä»¥ WAL æ–‡ä»¶å†…å®¹ä¼šåœ¨ backup è¿‡ç¨‹ä¸­å‘ç”Ÿæ”¹å˜ã€‚RocksDB çš„ flush_before_backup é€‰é¡¹ç”¨æ¥æ§åˆ¶åœ¨ backup æ—¶æ˜¯å¦ä¹Ÿæ‹·è´ WALï¼Œå…¶å€¼ä¸º true åˆ™ä¸æ‹·è´ã€‚ 6.8.1 Backup ç¼–ç¨‹æ¥å£ RocksDB æä¾›çš„ Backup æ¥å£ä½¿ç”¨æ–¹æ³•è¯¦è§ å‚è€ƒæ–‡æ¡£17ã€‚include/rocksdb/utilities/backupable_db.h ä¸»è¦æä¾›äº† BackupEngine å’Œ BackupEngineReadOnlyï¼Œåˆ†åˆ«ç”¨äºå¤‡ä»½æ•°æ®å’Œæ¢å¤æ•°æ®ã€‚ BackupEngineå¤‡ä»½æ•°æ®æ˜¯å¢é‡å¼å¤‡ä»½ã€è®¾ç½®é€‰é¡¹ BackupableDBOptions::share_table_files ã€‘ï¼Œè°ƒç”¨ BackupEngine::CreateNewBackup() æ¥å£è¿›è¡Œå¤‡ä»½åï¼Œå¯ä»¥è°ƒç”¨æ¥å£ BackupEngine::GetBackupInfo()è·å–å¤‡ä»½æ–‡ä»¶çš„ä¿¡æ¯ï¼šIDã€timestampã€sizeã€file number å’Œ metadataã€ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®ã€‘ã€‚ å¤‡ä»½ DB ç›®å½•è§ä¸Šå›¾ï¼Œå„ä¸ªå¤‡ä»½æ–‡ä»¶çš„ size æ˜¯å…¶ private ç›®å½•ä¸‹æ•°æ®ä¸ shared ç›®å½•ä¸‹æ•°æ®ä¹‹å’Œï¼Œshared ä¸‹é¢å­˜å‚¨çš„æ•°æ®æ˜¯å„ä¸ªå¤‡ä»½å…¬å…±çš„æ•°æ®ï¼Œæ‰€ä»¥æ‰€æœ‰å¤‡ä»½æ–‡ä»¶çš„ size ä¹‹å’Œå¯èƒ½å¤§äºå®é™…å ç”¨çš„ç£ç›˜ç©ºé—´å¤§å°ã€‚meta ç›®å½•ä¸‹å„ä¸ªæ–‡ä»¶çš„æ ¼å¼è¯¦è§ utilities/backupable/backupable_db.ccï¼Œä¸Šå›¾ä¸­ meta/1å†…å®¹å¦‚ä¸‹ï¼š 12345671536821592 # checksum1 # backup ID4 # private file numberprivate/1/MANIFEST-000008 crc32 272357318private/1/OPTIONS-000011 crc32 3039312718private/1/CURRENT crc32 1581506767private/1/000009.log crc32 3494278128 Private ç›®å½•åˆ™åŒ…å«ä¸€äº›é SST æ–‡ä»¶ï¼šoptions, current, manifest, WALsã€‚å¦‚æœ Options::share_table_files ä¸ºfalseï¼Œåˆ™ private ç›®å½•ä¼šå­˜å‚¨ SST æ–‡ä»¶ã€‚å¦‚æœ Options::share_table_files ä¸º true ä¸” Options::share_files_with_checksum ä¸º falseï¼Œshared ç›®å½•åŒ…å«ä¸€äº› SST æ–‡ä»¶ï¼ŒSST æ–‡ä»¶å‘½åä¸åŸ RocksDB ç›®å½•ä¸‹å‘½åä¸€è‡´ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªå¤‡ä»½ç›®å½•ä¸‹åªèƒ½å¤‡ä»½ä¸€ä¸ª RocksDB å®ä¾‹çš„æ•°æ®ã€‚ æ¥å£ BackupEngine::VerifyBackups() ç”¨äºå¯¹å¤‡ä»½æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œä½†æ˜¯ä»…ä»…æ ¹æ® meta ç›®å½•ä¸‹å„ä¸ª ID æ–‡ä»¶è®°å½•çš„æ–‡ä»¶ size ä¸ ç›¸åº”çš„ private ç›®å½•ä¸‹çš„æ–‡ä»¶çš„ size æ˜¯å¦ç›¸ç­‰ï¼Œå¹¶ä¸ä¼šè¿›è¡Œ checksum æ ¡éªŒï¼Œ æ ¡éªŒ checksum éœ€è¦è¯»å–æ•°æ®æ–‡ä»¶ï¼Œæ¯”è¾ƒè´¹æ—¶ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ¥å£ç›¸åº”çš„ BackupEngine å¥æŸ„åªèƒ½ç”±BackupEngine::CreateNewBackup() åˆ›å»ºï¼Œä¹Ÿå³åªèƒ½åœ¨è¿›è¡Œæ–‡ä»¶å¤‡ä»½ä¸”å¥æŸ„æœªå¤±æ•ˆå‰è¿›è¡Œæ•°æ®æ ¡éªŒï¼Œå› ä¸ºæ ¡éªŒæ—¶æ‰€ä¾æ®çš„æ•°æ®æ˜¯åœ¨å¤‡ä»½è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ã€‚ æ¥å£ BackupEngineReadOnly::RestoreDBFromBackup(backup_id, db_dir, wal_dir,restore_options) ç”¨äºå¤‡ä»½æ•°æ®æ¢å¤ï¼Œå‚æ•° db_dir å’Œwal_dirå¤§éƒ¨åˆ†åœºæ™¯ä¸‹éƒ½æ˜¯åŒä¸€ä¸ªç›®å½•ï¼Œä½†åœ¨ å‚è€ƒæ–‡æ¡£18 æ‰€æä¾›çš„æŠŠ RocksDB å½“åšçº¯å†…å­˜æ•°æ®åº“çš„ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œ db_dir åœ¨å†…å­˜è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œè€Œ wal_dir åˆ™æ˜¯ä¸€ä¸ªç£ç›˜æ–‡ä»¶ç›®å½•ã€‚è¿›è¡Œæ•°æ®æ¢å¤æ—¶ï¼Œè¿™ä¸ªæ¥å£è¿˜ä¼šæ ¹æ® meta ä¸‹ç›¸åº” ID è®°å½•çš„ å¤‡ä»½æ•°æ® checksum å¯¹ private ç›®å½•ä¸‹çš„æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œå‘é”™é”™è¯¯æ—¶è¿”å› Status::Corruption é”™è¯¯ã€‚ 6.8.2 Backup æ€§èƒ½ä¼˜åŒ– BackupEngine::Open() å¯ç”¨æ—¶éœ€è¦è¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œæ‰€ä»¥å®ƒä¼šæ¶ˆè€—ä¸€äº›æ—¶é—´ã€‚ä¾‹å¦‚éœ€è¦æŠŠæœ¬åœ° RocksDB æ•°æ®å¤‡ä»½åˆ°è¿œç«¯çš„ HDFS ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å¯èƒ½æ¶ˆè€—å¤šä¸ª network round-tripï¼Œæ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ä¸­ä¸è¦é¢‘ç¹åˆ›å»º BackupEngine å¯¹è±¡ã€‚ åŠ å¿« BackupEngine å¯¹è±¡çš„æ–¹å¼ä¹‹ä¸€æ˜¯é€šè¿‡è°ƒç”¨ PurgeOldBackups(N)æ¥åˆ é™¤éå¿…è¦çš„å¤‡ä»½æ–‡ä»¶ï¼Œæ¥å£ PurgeOldBackups(N) æœ¬èº«ä¹‹æ„å°±æ˜¯åªä¿ç•™æœ€è¿‘çš„ N ä¸ªå¤‡ä»½ï¼Œå¤šä½™çš„ä¼šè¢«åˆ é™¤æ‰ã€‚ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ DeleteBackup(id) æ¥å£æ ¹æ®å¤‡ä»½ ID åˆ é™¤æŸä¸ªç¡®å®šçš„å¤‡ä»½ã€‚ åˆå§‹åŒ– BackupEngine å¯¹è±¡è¿‡åï¼Œå¤‡ä»½çš„é€Ÿåº¦å°±å–å†³äºæœ¬åœ°ä¸è¿œç«¯çš„åª’ä»‹è¿è¡Œé€Ÿåº¦äº†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ¬åœ°åª’ä»‹æ˜¯ HDDï¼Œåœ¨å…¶è‡ªèº«é¥±å’Œè¿è½¬ä¹‹åå°±ç®—æ˜¯æ‰“å¼€å†å¤šçš„çº¿ç¨‹ä¹Ÿæ— æµäºäº‹ã€‚å¦‚æœåª’ä»‹æ˜¯ä¸€ä¸ªå°çš„ HDFS é›†ç¾¤ï¼Œå…¶è¡¨ç°ä¹Ÿä¸ä¼šå¾ˆå¥½ã€‚å¦‚æœæœ¬åœ°æ˜¯ SSD è€Œè¿œç«¯æ˜¯ä¸€ä¸ªå¤§çš„ HDFS é›†ç¾¤ï¼Œåˆ™ç›¸è¾ƒäºå•çº¿ç¨‹ï¼Œ 16 ä¸ªå¤‡ä»½çº¿ç¨‹ä¼šè¢«å¤‡ä»½æ—¶é—´ç¼©çŸ­ 2/3ã€‚ 6.8.3 é«˜çº§ç¼–ç¨‹æ¥å£ BackupEngine::CreateNewBackupWithMetadata() ç”¨äºè®¾ç½® metadataï¼Œä¾‹å¦‚è®¾ç½®ä½ èƒ½è¾¨è¯†çš„å¤‡ä»½ IDï¼Œmetadata å¯ä»¥é€šè¿‡ BackupEngine::GetBackupInfo() è·å–ï¼› rocksdb::LoadLatestOptions() or rocksdb:: LoadOptionsFromFile() RocksDB ç°åœ¨ä¹Ÿèƒ½å¯¹ RocksDB çš„ options è¿›è¡Œå¤‡ä»½ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªæ¥å£è·å–ç›¸åº”å¤‡ä»½çš„ Optionsï¼› BackupableDBOptions::backup_env ç”¨äºè®¾ç½®å¤‡ä»½ç›®å½•çš„ ENVï¼› BackupableDBOptions::backup_dir ç”¨äºè®¾ç½®å¤‡ä»½æ–‡ä»¶çš„æ ¹ç›®å½•ï¼› BackupableDBOptions::share_table_files å¦‚æœè¿™ä¸ªé€‰é¡¹ä¸º trueï¼Œåˆ™ BackupEngine ä¼šè¿›è¡Œå¢é‡å¤‡ä»½ï¼ŒæŠŠæ‰€æœ‰çš„ SST æ–‡ä»¶å­˜å‚¨åˆ° â€œshared/â€œ å­ç›®å½•ï¼Œå…¶å±é™©æ˜¯ SST æ–‡ä»¶åå­—å¯èƒ½ç›¸åŒã€åœ¨å¤šä¸ª RocksDB å¯¹è±¡å…±ç”¨åŒä¸€å¤‡ä»½ç›®å½•çš„åœºæ™¯ä¸‹ã€‘ï¼› BackupableDBOptions::share_files_with_checksum åœ¨å¤šä¸ª RocksDB å¯¹è±¡å…±ç”¨åŒä¸€å¤‡ä»½ç›®å½•çš„åœºæ™¯ä¸‹ï¼ŒSST æ–‡ä»¶åå­—å¯èƒ½ç›¸åŒï¼ŒæŠŠè¿™ä¸ªé€‰é¡¹è®¾ç½®ä¸º true å¯ä»¥å¤„ç†è¿™ä¸ªå†²çªï¼ŒSST æ–‡ä»¶ä¼šè¢« BackupEngine é€šè¿‡ checksum/size/seqnum ä¸‰ä¸ªå‚æ•°è¿›è¡Œæ ¡éªŒï¼› BackupableDBOptions::max_background_operations è¿™ä¸ªå‚æ•°ç”¨äºè®¾ç½®å¤‡ä»½å’Œæ¢å¤æ•°æ®çš„çº¿ç¨‹æ•°ï¼Œåœ¨ä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå¦‚ HDFS åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªå‚æ•°ä¼šå¤§å¤§æé«˜å¤‡ä»½å’Œæ¢å¤çš„æ•ˆç‡ï¼› BackupableDBOptions::info_log ç”¨äºè®¾ç½® LOG å¯¹è±¡ï¼Œå¯ä»¥åœ¨å¤‡ä»½å’Œæ¢å¤æ•°æ®æ—¶è¿›è¡Œæ—¥å¿—è¾“å‡ºï¼› BackupableDBOptions::sync å¦‚æœè®¾ç½®ä¸º trueï¼ŒBackupEngine ä¼šè°ƒç”¨ fsync ç³»ç»Ÿæ¥å£è¿›è¡Œæ–‡ä»¶æ•°æ®å’Œ metadata çš„æ•°æ®å†™å…¥ï¼Œä»¥é˜²å¤‡ç³»ç»Ÿé‡å¯æˆ–è€…å´©æºƒæ—¶çš„æ•°æ®ä¸ä¸€è‡´ç°è±¡ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹å¦‚æœä¸ºè¿½æ±‚æ€§èƒ½ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è®¾ç½®ä¸º falseï¼› BackupableDBOptions::destroy_old_data å¦‚æœè¿™ä¸ªé€‰é¡¹ä¸º trueï¼Œæ–°çš„ BackupEngine è¢«åˆ›å»ºå‡ºæ¥ä¹‹åå¤‡ä»½ç›®å½•ä¸‹æ—§çš„å¤‡ä»½æ•°æ®ä¼šè¢«æ¸…ç©ºï¼› BackupEngine::CreateNewBackup(db, flush_before_backup = false) flush_before_backup è¢«è®¾ç½®ä¸º true æ—¶ï¼ŒBackupEngine é¦–å…ˆ flush memtableï¼Œç„¶åå†è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œè€Œ WAL log æ–‡ä»¶ä¸ä¼šè¢«å¤åˆ¶ï¼Œå› ä¸º flush æ—¶å€™å®ƒä¼šè¢«åˆ æ‰ï¼Œå¦‚æœè¿™ä¸ªä¸º false åˆ™ç›¸åº”çš„ WAL æ—¥å¿—æ–‡ä»¶ä¹Ÿä¼šè¢«å¤åˆ¶ä»¥ä¿è¯å¤‡ä»½æ•°æ®ä¸å½“å‰ RocksDB çŠ¶æ€ä¸€è‡´ï¼› 7 FAQ å®˜æ–¹ wiki ã€å‚è€ƒæ–‡æ¡£ 11ã€‘æä¾›äº†ä¸€ä»½ FAQï¼Œä¸‹é¢èŠ‚é€‰ä¸€äº›æ¯”è¾ƒæœ‰æ„ä¹‰çš„å»ºè®®ï¼Œå…¶ä»–å†…å®¹è¯·ç§»æ­¥å®˜æ–¹æ–‡æ¡£ã€‚ 1 å¦‚æœæœºå™¨å´©æºƒåé‡å¯ï¼Œåˆ™ RocksDB èƒ½å¤Ÿæ¢å¤çš„æ•°æ®æ˜¯åŒæ­¥å†™ã€WriteOptions.sync=trueã€‘è°ƒç”¨ DB::SyncWAL() ä¹‹å‰çš„æ•°æ® æˆ–è€…å·²ç»è¢«å†™å…¥ L0 çš„ memtable çš„æ•°æ®éƒ½æ˜¯å®‰å…¨çš„ï¼› 2 å¯ä»¥é€šè¿‡ GetIntProperty(cf_handle, â€œrocksdb.estimate-num-keys&quot;) è·å–ä¸€ä¸ª column family ä¸­å¤§æ¦‚çš„ key çš„ä¸ªæ•°ï¼› 3 å¯ä»¥é€šè¿‡ GetAggregatedIntProperty(â€œrocksdb.estimate-num-keys&quot;, &amp;num_keys) è·å–æ•´ä¸ª RocksDB ä¸­å¤§æ¦‚çš„ key çš„æ€»æ•°ï¼Œä¹‹æ‰€ä»¥åªèƒ½è·å–ä¸€ä¸ªå¤§æ¦‚æ•°å€¼æ˜¯å› ä¸º RocksDB çš„ç£ç›˜æ–‡ä»¶æœ‰é‡å¤ keyï¼Œè€Œä¸” compact çš„æ—¶å€™ä¼šè¿›è¡Œ key çš„æ·˜æ±°ï¼Œæ‰€ä»¥æ— æ³•ç²¾ç¡®è·å–ï¼› 4 Put()/Write()/Get()/NewIterator() è¿™å‡ ä¸ª API éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼› 5 å¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ‰“å¼€åŒä¸€ä¸ª RocksDB æ–‡ä»¶ï¼Œä½†æ˜¯å…¶ä¸­åªèƒ½æœ‰ä¸€ä¸ªå†™è¿›ç¨‹ï¼Œå…¶ä»–çš„éƒ½åªèƒ½é€šè¿‡ DB::OpenForReadOnly() å¯¹ RocksDB è¿›è¡Œåªè¯»è®¿é—®ï¼› 6 å½“è¿›ç¨‹ä¸­è¿˜æœ‰çº¿ç¨‹åœ¨å¯¹ RocksDB è¿›è¡Œ è¯»ã€å†™æˆ–è€…æ‰‹å·¥ compaction çš„æ—¶å€™ï¼Œä¸èƒ½å¼ºè¡Œå…³é—­å®ƒï¼› 7 RocksDB æœ¬èº«ä¸å»ºè®®ä½¿ç”¨å¤§ keyï¼Œä½†æ˜¯å®ƒæ”¯æŒçš„ key çš„æœ€å¤§é•¿åº¦æ˜¯ 8MBï¼Œvalue çš„æœ€å¤§é•¿åº¦æ˜¯ 3GBï¼› 8 RocksDB æœ€ä½³å®è·µï¼šä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå†™ï¼Œä¸”ä»¥é¡ºåºæ–¹å¼å†™ï¼›ä»¥ batch æ–¹å¼æŠŠæ•°æ®å†™å…¥ RocksDBï¼›ä½¿ç”¨ vector memtableï¼›ç¡®ä¿ options.max_background_flushes æœ€å°‘ä¸º 4ï¼›æ’å…¥æ•°æ®ä¹‹å‰è®¾ç½®å…³é—­è‡ªåŠ¨ compactï¼ŒæŠŠ options.level0_file_num_compaction_trigger/options.level0_slowdown_writes_trigger/options.level0_stop_writes_trigger ä¸‰ä¸ªå€¼æ”¾å¤§ï¼Œæ•°æ®æ’å…¥åå†å¯åŠ¨è°ƒç”¨ compact å‡½æ•°è¿›è¡Œ compaction æ“ä½œã€‚ å¦‚æœè°ƒç”¨äº†Options::PrepareForBulkLoad()ï¼Œåé¢ä¸‰ä¸ªæ–¹æ³•ä¼šè¢«è‡ªåŠ¨å¯ç”¨ï¼› 9 å…³é—­ RocksDB å¯¹è±¡æ—¶ï¼Œå¦‚æœæ˜¯é€šè¿‡ DestroyDB() å»å…³é—­æ—¶ï¼Œè¿™ä¸ª RocksDB è¿˜æ­£è¢«å¦ä¸€ä¸ªè¿›ç¨‹è®¿é—®ï¼Œåˆ™ä¼šé€ æˆä¸å¯é¢„æ–™çš„åæœï¼› 10 å¯ä»¥é€šè¿‡ DBOptions::db_paths/DBOptions::db_log_dir/DBOptions::wal_dir ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å­˜å‚¨ RocksDB çš„æ•°æ®ï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚æœè¦é‡Šæ”¾ RocksDB çš„æ•°æ®å¯ä»¥é€šè¿‡ DestroyDB() è¿™ä¸ª API å»æ‰§è¡Œåˆ é™¤ä»»åŠ¡ï¼› 11 å½“ BackupOptions::backup_log_files æˆ–è€… flush_before_backup çš„å€¼ä¸º true çš„æ—¶å€™ï¼Œå¦‚æœç¨‹åºè°ƒç”¨ CreateNewBackup() åˆ™ RocksDB ä¼šåˆ›å»º point-in-time snapshotï¼ŒRocksDBè¿›è¡Œæ•°æ®å¤‡ä»½çš„æ—¶å€™ä¸ä¼šå½±å“æ­£å¸¸çš„è¯»å†™é€»è¾‘ï¼› 12 RocksDB å¯åŠ¨ä¹‹åä¸èƒ½ä¿®æ”¹ prefix extractorï¼› 13 SstFileWriter API å¯ä»¥ç”¨æ¥åˆ›å»º SST æ–‡ä»¶ï¼Œå¦‚æœè¿™äº› SST æ–‡ä»¶è¢«æ·»åŠ åˆ°åˆ«çš„ RocksDB æ•°æ®åº“å‘ç”Ÿ key range é‡å ï¼Œåˆ™ä¼šå¯¼è‡´æ•°æ®é”™ä¹±ï¼› 14 ç¼–è¯‘ RocksDB çš„ gcc ç‰ˆæœ¬ æœ€ä½æ˜¯ 4.7ï¼Œæ¨è 4.8 ä»¥ä¸Šï¼› 15 å•ä¸ªæ–‡ä»¶ç³»ç»Ÿå¦‚ ext3 æˆ–è€… xfs å¯ä»¥ä½¿ç”¨å¤šä¸ªç£ç›˜ï¼Œç„¶åè®© RocksDB åœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸Šè¿è¡Œè¿›è€Œä½¿ç”¨å¤šä¸ªç£ç›˜ï¼› 16 ä½¿ç”¨å¤šç£ç›˜æ—¶ï¼ŒRAID çš„ stripe size ä¸èƒ½å°äº 64kbï¼Œæ¨èä½¿ç”¨1MBï¼› 17 RocksDB å¯ä»¥é’ˆå¯¹æ¯ä¸ª SST æ–‡ä»¶é€šè¿‡ ColumnFamilyOptions::bottommost_compression ä½¿ç”¨ä¸åŒçš„å‹ç¼©çš„æ–¹æ³•ï¼› 18 å½“å¤šä¸ª Handle æŒ‡å‘åŒä¸€ä¸ª Column Family æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹é€šè¿‡ DropColumnFamily() åˆ é™¤ä¸€ä¸ª CF çš„æ—¶å€™ï¼Œå…¶å¼•ç”¨è®¡æ•°ä¼šå‡ä¸€ï¼Œç›´è‡³ä¸º 0 æ—¶æ•´ä¸ª CF ä¼šè¢«åˆ é™¤ï¼› 19 RocksDB æ¥å—ä¸€ä¸ªå†™è¯·æ±‚çš„æ—¶å€™ï¼Œå¯èƒ½å› ä¸º compact ä¼šå¯¼è‡´ RocksDB å¤šæ¬¡è¯»å–æ•°æ®æ–‡ä»¶è¿›è¡Œæ•°æ®åˆå¹¶æ“ä½œï¼› 20 RocksDB ä¸ç›´æ¥æ”¯æŒæ•°æ®çš„å¤åˆ¶ï¼Œä½†æ˜¯æä¾›äº† API GetUpdatesSince() ä¾›ç”¨æˆ·è°ƒç”¨ä»¥è·å–æŸä¸ªæ—¶é—´ç‚¹ä»¥åæ›´æ–°çš„ kvï¼› 21 Options çš„ block_size æ˜¯æŒ‡ block çš„å†…å­˜ç©ºé—´å¤§å°ï¼Œä¸æ•°æ®æ˜¯å¦å‹ç¼©æ— å…³ï¼› 22 options.prefix_extractor ä¸€æ—¦å¯ç”¨ï¼Œå°±æ— æ³•ç»§ç»­ä½¿ç”¨ Prev() å’Œ SeekToLast() ä¸¤ä¸ª APIï¼Œå¯ä»¥æŠŠ ReadOptions.total_order_seek è®¾ç½®ä¸º trueï¼Œä»¥ç¦ç”¨ prefix iteratingï¼› 23 å½“ BlockBaseTableOptions::cache_index_and_filter_blocks çš„å€¼ä¸º true æ—¶ï¼Œåœ¨è¿›è¡Œ Get() è°ƒç”¨çš„æ—¶å€™ç›¸åº”æ•°æ®çš„ bloom filter å’Œ index block ä¼šè¢«æ”¾è¿› LRU cache ä¸­ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°ä¸º false åˆ™åªæœ‰ memtable çš„ index å’Œ bloom filter ä¼šè¢«æ”¾è¿›å†…å­˜ä¸­ï¼› 24 å½“è°ƒç”¨ Put() æˆ–è€… Write() æ—¶å‚æ•° WriteOptions.sync çš„å€¼ä¸º trueï¼Œåˆ™æœ¬æ¬¡å†™ä»¥å‰çš„æ‰€æœ‰ WriteOptions.disableWAL ä¸º false çš„å†™çš„å†…å®¹éƒ½ä¼šè¢«å›ºåŒ–åˆ°ç£ç›˜ä¸Šï¼› 25 ç¦ç”¨ WAL æ—¶ï¼ŒDB::Flush() åªå¯¹å•ä¸ª Column Family çš„æ•°æ®å›ºåŒ–æ“ä½œæ˜¯åŸå­çš„ï¼Œå¯¹å¤šä¸ª Column Family çš„æ•°æ®æ“ä½œåˆ™ä¸æ˜¯åŸå­çš„ï¼Œå®˜æ–¹è€ƒè™‘å°†æ¥ä¼šæ”¯æŒè¿™ä¸ª featureï¼› 26 å½“ä½¿ç”¨è‡ªå®šä¹‰çš„ comparators æˆ–è€… merge operators æ—¶ï¼Œldb å·¥å…·å°±æ— æ³•è¯»å– sst æ–‡ä»¶æ•°æ®ï¼› 27 RocksDB æ‰§è¡Œå‰å°çš„ Get() å’Œ Write() ä»»åŠ¡é‡åˆ°é”™è¯¯æ—¶ï¼Œå®ƒä¼šè¿”å› rocksdb::IOError å…·ä½“å€¼ï¼› 28 RocksDB æ‰§è¡Œåå°ä»»åŠ¡é‡åˆ°é”™è¯¯æ—¶ ä¸” options.paranoid_checks å€¼ä¸º trueï¼Œåˆ™ RocksDB ä¼šè‡ªåŠ¨è¿›å…¥åªè¯»æ¨¡å¼ï¼› 29 RocksDB ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ compact çš„æ—¶å€™ï¼Œè¿™ä¸ªä»»åŠ¡æ˜¯ä¸å¯å–æ¶ˆçš„ï¼› 30 RocksDB ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ compact ä»»åŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ CancelAllBackgroundWork(db, true) ä»¥ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ compact ä»»åŠ¡ï¼› 31 å½“å¤šä¸ªè¿›ç¨‹æ‰“å¼€ä¸€ä¸ª RocksDB æ—¶ï¼Œå¦‚æœæŒ‡å®šçš„ compact æ–¹å¼ä¸ä¸€æ ·ï¼Œåˆ™åé¢çš„è¿›ç¨‹ä¼šæ‰“å¼€å¤±è´¥ï¼› 32 Column Family ä½¿ç”¨åœºæ™¯ï¼š(1) ä¸åŒçš„ Column Family å¯ä»¥ä½¿ç”¨ä¸åŒçš„ setting/comparators/compression types/merge operators/compaction filtersï¼›(2) å¯¹æ•°æ®è¿›è¡Œé€»è¾‘éš”ç¦»ï¼Œæ–¹ä¾¿åˆ†åˆ«åˆ é™¤ï¼›(3) ä¸€ä¸ª Column Family å­˜å‚¨ metadataï¼Œå¦ä¸€ä¸ªå­˜å‚¨ dataï¼› 33 ä½¿ç”¨ä¸€ä¸ª RocksDB å°±æ˜¯ä½¿ç”¨ä¸€ä¸ªç‰©ç†å­˜å‚¨ç³»ç»Ÿï¼Œä½¿ç”¨ä¸€ä¸ª Column Family åˆ™æ˜¯ä½¿ç”¨ä¸€ä¸ªé€»è¾‘å­˜å‚¨ç³»ç»Ÿï¼ŒäºŒè€…ä¸»è¦åŒºåˆ«ä½“ç°åœ¨ æ•°æ®å¤‡ä»½ã€åŸå­å†™ä»¥åŠå†™æ€§èƒ½è¡¨ç°ä¸Šã€‚DB æ˜¯æ•°æ®å¤‡ä»½å’Œå¤åˆ¶ä»¥åŠ checkpoint çš„åŸºæœ¬å•ä½ï¼Œä½†æ˜¯ Column Family åˆ™åˆ©ç”¨ BatchWriteï¼Œå› ä¸ºè¿™ä¸ªæ“ä½œæ˜¯å¯ä»¥è·¨ Column Family çš„ï¼Œè€Œä¸”å¤šä¸ª Column Family å¯ä»¥å…±äº«åŒä¸€ä¸ª WALï¼Œå¤šä¸ª DB åˆ™æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ï¼› 34 RocksDB ä¸æ”¯æŒå¤šåˆ—ï¼› 35 RocksDB çš„è¯»å¹¶ä¸æ˜¯æ— é”çš„ï¼Œæœ‰å¦‚ä¸‹æƒ…å†µï¼š(1) è®¿é—® sharded block cache (2) å¦‚æœ table cache options.max_open_files ä¸ç­‰äº -1 (3) å¦‚æœ flush æˆ–è€… compaction åˆšåˆšå®Œæˆï¼ŒRocksDB æ­¤æ—¶ä¼šä½¿ç”¨å…¨å±€ mutex lock ä»¥è·å– LSM æ ‘çš„æœ€æ–° metadata (4) RocksDB ä½¿ç”¨çš„å†…å­˜åˆ†é…å™¨å¦‚ jemalloc æœ‰æ—¶ä¹Ÿä¼šåŠ é”ï¼Œè¿™å››ç§æƒ…å†µæ€»ä½“å¾ˆå°‘å‘ç”Ÿï¼Œæ€»ä½“å¯ä»¥è®¤ä¸ºè¯»æ˜¯æ— é”çš„ï¼› 36 å¦‚æœæƒ³é«˜æ•ˆçš„å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œ iterateï¼Œåˆ™å¯ä»¥åˆ›å»º snapshot ç„¶åå†éå†ï¼› 37 å¦‚æœä¸€ä¸ª key space range (minkey, maxkey) å¾ˆå¤§ï¼Œåˆ™ä½¿ç”¨ Column Family å¯¹å…¶è¿›è¡Œ shardingï¼Œå¦‚æœè¿™ä¸ª range ä¸å¤§åˆ™ä¸è¦å•ç‹¬ä½¿ç”¨ä¸€ä¸ª Column Familyï¼› 38 RocksDB æ²¡æœ‰è¿›è¡Œ compaction çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ rocksdb.estimate-live-data-size å¯ä»¥ä¼°ç®— RocksDB ä½¿ç”¨çš„ç£ç›˜ç©ºé—´ï¼› 39 Snapshot ä»…ä»…å­˜åœ¨äºé€»è¾‘æ¦‚å¿µä¸Šï¼Œå…¶å¯¹åº”çš„å®é™…ç‰©ç†æ–‡ä»¶å¯èƒ½æ­£è¢« compaction çº¿ç¨‹æ‰§è¡Œå†™ä»»åŠ¡ï¼›Checkpoint åˆ™æ˜¯å®é™…ç‰©ç†æ–‡ä»¶çš„ä¸€ä¸ªé•œåƒï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä¸ªç¡¬é“¾æ¥ï¼Œè€Œå‡ºå¤„äºåŒæ ·çš„ Env ä¸‹ã€éƒ½æ˜¯ RocksDB æ•°æ®æ–‡ä»¶æ ¼å¼ã€‘ï¼›è€Œ backup è™½ç„¶ä¹Ÿæ˜¯ç‰©ç†æ•°æ®çš„é•œåƒï¼Œä½†æ˜¯ä¸åŸå§‹æ•°æ®å¤„äºä¸åŒçš„ Env ä¸‹ã€å¦‚ backup å¯èƒ½åœ¨ HDFS ä¸Šã€‘ï¼› 40 æ¨èä½¿ç”¨å‹ç¼©ç®—æ³• LZ4ï¼ŒSnappy æ¬¡ä¹‹ï¼Œå‹ç¼©ä¹‹åå¦‚æœä¸ºäº†æ›´å¥½çš„å‹ç¼©æ•ˆæœå¯ä»¥ä½¿ç”¨ Zlibï¼› 41 å³ä½¿æ²¡æœ‰è¢«æ ‡è®°ä¸ºåˆ é™¤çš„ keyï¼Œä¹Ÿæ²¡æœ‰æ•°æ®è¿‡æœŸï¼ŒRocksDB ä»ç„¶ä¼šæ‰§è¡Œ compactionï¼Œä»¥æé«˜è¯»æ€§èƒ½ï¼› 42 RocksDB çš„ key å’Œ value æ˜¯å­˜åœ¨ä¸€èµ·çš„ï¼Œéå†ä¸€ä¸ª key çš„æ—¶å€™ï¼ŒRocksDB å·²ç»æŠŠå…¶ value è¯»å…¥ cache ä¸­ï¼› 43 å¯¹äºä¸€ä¸ªç¦»çº¿ DB å¯ä»¥é€šè¿‡ â€œsst_dump â€“show_properties â€“command=noneâ€ å‘½ä»¤è·å–ç‰¹å®š sst æ–‡ä»¶çš„ index &amp; filter çš„ sizeï¼Œå¯¹äºæ­£åœ¨è¿è¡Œçš„ DB å¯ä»¥é€šè¿‡è¯»å– DB çš„å±æ€§ â€œkAggregatedTablePropertiesâ€ æˆ–è€…è°ƒç”¨ DB::GetPropertiesOfAllTables() è·å– DB çš„ index &amp; filter çš„ sizeã€‚ å‚è€ƒæ–‡æ¡£ 1 RocksDB Tuning Guide 2 Rocksdb BlockBasedTable Format 3 PlainTable Format 4 Thread Pool 5 RocksDB Basics 6 Transactions 7 Bloom Filter 8 Universal Compaction 9 Leveled Compaction 10 Time to Live 11 RocksDB-FAQ 12 è®¾è®¡æ€è·¯å’Œä¸»è¦çŸ¥è¯†ç‚¹ 13 RocksDB Â· MANIFESTæ–‡ä»¶ä»‹ç» 14 RocksDB. Merge Operator 15 ä½¿ç”¨PinnableSliceå‡å°‘Getæ—¶çš„å†…å­˜æ‹·è´ 16 PinnableSlice; less memcpy with point lookups 17 How to backup RocksDB? 18 RocksDBç³»åˆ—åä¸‰:How to persist in memory RocksDB database? 19 Checkpoints 20 LSM-Treeä¸RocksDB 21 è‡ªåŠ¨è°ƒä¼˜ RocksDB","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®ç»“æ„/æ•°æ®åº“","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93/"}],"tags":[{"name":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/"}]},{"title":"ã€Golangã€‘- ä½¿ç”¨golangé‡å†™tgaæœåŠ¡","slug":"Golang/ä½¿ç”¨golangé‡å†™tgaæœåŠ¡","date":"2020-12-17T01:46:51.000Z","updated":"2021-09-06T02:03:31.268Z","comments":true,"path":"2020/12/17/Golang/ä½¿ç”¨golangé‡å†™tgaæœåŠ¡/","link":"","permalink":"http://blog.crazylaw.cn/2020/12/17/Golang/%E4%BD%BF%E7%94%A8golang%E9%87%8D%E5%86%99tga%E6%9C%8D%E5%8A%A1/","excerpt":"å‰è¨€æ—©æœŸï¼Œåœ¨æˆ‘ä»¬çš„éƒ¨é—¨ä¸­åç«¯çš„æŠ€æœ¯æ ˆè¯­è¨€ä¸»è¦æœ‰ä¸‰ç§è¯­è¨€ï¼Œåˆ†åˆ«æ˜¯php/python/erlangï¼Œå…¶ä¸­ç”¨äºåšæœåŠ¡çš„æ˜¯ php/erlangã€‚ åœ¨æˆ‘ä»¬çš„ä½“ç³»ä¸­ï¼Œæ—¥å¿—é‡‡é›†æœåŠ¡ä½“ç³»ç›®å‰éƒ½æ˜¯ç”¨erlangå†™çš„ï¼Œè€Œphpå†™çš„æœåŠ¡å¤šæ˜¯åŸºäºswooleå†™çš„ä¸€äº›åŸºç¡€æœåŠ¡ã€‚ åœ¨tgaæœåŠ¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä»kafka -&gt; æœåŠ¡ -&gt; æœ¬åœ°æ–‡ä»¶çš„æ¨¡å¼ã€‚ ä¸šåŠ¡æ®æµå›¾å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536+---------------------------------------------------------------+| || || +---------------------------------------------+ || | | || | | || | kafkaæœåŠ¡ | || | | || | | || | | || +----------------------+----------------------+ || | || | || +----------------------v-----------------------+ | +----------------------------+| | | | | || | | | | || | | | | || | mthinkingdataæœåŠ¡ | &lt;---------------------+ logbusæœåŠ¡ || | | | | || | | | | || | | | | || +----------------------+-----------------------+ | +----------------------------+| | || | || +----------------------v------------------------+ || | | || | | || | | || | æœ¬åœ°æ–‡ä»¶ +-------+| | | || | | || | | || +-----------------------------------------------+ || |+---------------------------------------------------------------+ äºæ˜¯æˆ‘ä»¬è¯•æ¢æ€§çš„è‡ªç ”åŸºäºswooleçš„kafkaå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬è‡ªå·±å®ç°æ ¹æ®kafkaåè®®çš„å°åŒ…ï¼Œè§£åŒ…ï¼Œæµç¨‹å¤„ç†ã€‚(swoole-kafka)mthinkingdataæœåŠ¡å°±æ˜¯æˆ‘ä»¬åŸºäºkafka-swooleç ”å‘çš„ä¸šåŠ¡æœåŠ¡ã€‚ 1234567891011121314151617+------------+| || message1 +------------+| | |+------------+ | |+------------+ +------+--------+| | | || message2 +-----+ snappyå‹ç¼© || | | |+------------+ +------+--------+ |+---------------+ || | || message[3..n] +----------+| |+---------------+ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°phpå¯¹äºcpuå¯†é›†å‹çš„å¤„ç†å­˜åœ¨ç“¶é¢ˆï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç”Ÿäº§è€…ä¸€æ–¹å¦‚æœå‘é€å¤šæ¡åè®®çš„æƒ…å†µä¸‹ï¼Œä¼šç»è¿‡ snappy ç®—æ³•çš„å‹ç¼©å†æ¨é€ä»¥ä¾¿å‡å°‘network-ioï¼ˆå¢åŠ cpu-ioï¼‰ã€‚æ¶ˆè´¹è€…åœ¨æ¥å—æ¶ˆæ¯çš„æ—¶å€™ä¹Ÿæ˜¯è¢«å‹ç¼©è¿‡çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å‹ï¼Œåœ¨è¿™ä¸ªè§£å‹çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¸ªååˆ†æ¶ˆè´¹cpuçš„è¿‡ç¨‹ï¼Œå³ä½¿æˆ‘ä»¬å½“æ—¶æ˜¯åŸºäºswoole4.3çš„åç¨‹ç‰ˆæœ¬æ¥å¤„ç†ï¼Œä¸è¡Œçš„æ˜¯çš„æŠ¢å å¼åç¨‹å½“æ—¶å¹¶æ²¡æœ‰å¾ˆå¥½çš„å®Œæˆï¼Œæˆ‘ä»¬æ²¡åŠæ³•è¾¾åˆ°å¿«é€Ÿçš„æ¥å—å¤šä¸ªæ•°æ®åŒ…çš„è¡Œä¸ºã€‚æ¶ˆè´¹é€Ÿåº¦ä¹Ÿå¹¶ä¸æ˜¯ç‰¹åˆ«ç†æƒ³ã€‚åœ¨è¿™ä¸ªå¤§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å€ŸåŠ©redisæ¥ä½œä¸ºä¸­é—´çš„å­˜å‚¨ã€‚è€Œredisæ˜¯å•çº¿ç¨‹çš„ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¯•è¿‡ä½¿ç”¨pipelineç­‰æ‰‹æ®µå‡å°‘tcpä¸­çš„å“åº”åŒ…çš„å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚ä½†æ˜¯ç”±äºredisåªèƒ½åˆ©ç”¨å•æ ¸çš„ç¼˜æ•…ï¼Œæ‰¹é‡å¤„ç†ä¸€æ‰¹æŒ‡ä»¤åï¼Œæœ€é«˜çš„cpuåˆ©ç”¨ç‡æ¥è¿‘100%ä¸‹æ— æ³•å†å¢é•¿ã€‚ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬çš„æœåŠ¡æ³¨å®šæ— æ³•è¾¾åˆ°å¾ˆå¥½çš„æ€§èƒ½æµ‹è¯•ã€‚ æˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œå½“æ—¶æœåŠ¡çš„ç“¶é¢ˆåœ¨äºï¼š phpè¯­è¨€æœ¬èº«çš„æ€§èƒ½ swooleåç¨‹ä¸æ”¯æŒæŠ¢å å¼è°ƒåº¦ æœªå®ç°åŠ¨æ€ä¼¸ç¼©æ‰©å±•workeræ•°é‡ï¼ˆæ„Ÿå…´è¶£å¯ä»¥å»çœ‹çœ‹kafka-swooleçš„æ¶æ„åˆ†äº«ï¼‰ redisæœªèƒ½åˆ©ç”¨å¤šæ ¸ï¼Œcpuåˆ©ç”¨ç‡è¾¾åˆ°å³°å€¼","text":"å‰è¨€æ—©æœŸï¼Œåœ¨æˆ‘ä»¬çš„éƒ¨é—¨ä¸­åç«¯çš„æŠ€æœ¯æ ˆè¯­è¨€ä¸»è¦æœ‰ä¸‰ç§è¯­è¨€ï¼Œåˆ†åˆ«æ˜¯php/python/erlangï¼Œå…¶ä¸­ç”¨äºåšæœåŠ¡çš„æ˜¯ php/erlangã€‚ åœ¨æˆ‘ä»¬çš„ä½“ç³»ä¸­ï¼Œæ—¥å¿—é‡‡é›†æœåŠ¡ä½“ç³»ç›®å‰éƒ½æ˜¯ç”¨erlangå†™çš„ï¼Œè€Œphpå†™çš„æœåŠ¡å¤šæ˜¯åŸºäºswooleå†™çš„ä¸€äº›åŸºç¡€æœåŠ¡ã€‚ åœ¨tgaæœåŠ¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä»kafka -&gt; æœåŠ¡ -&gt; æœ¬åœ°æ–‡ä»¶çš„æ¨¡å¼ã€‚ ä¸šåŠ¡æ®æµå›¾å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536+---------------------------------------------------------------+| || || +---------------------------------------------+ || | | || | | || | kafkaæœåŠ¡ | || | | || | | || | | || +----------------------+----------------------+ || | || | || +----------------------v-----------------------+ | +----------------------------+| | | | | || | | | | || | | | | || | mthinkingdataæœåŠ¡ | &lt;---------------------+ logbusæœåŠ¡ || | | | | || | | | | || | | | | || +----------------------+-----------------------+ | +----------------------------+| | || | || +----------------------v------------------------+ || | | || | | || | | || | æœ¬åœ°æ–‡ä»¶ +-------+| | | || | | || | | || +-----------------------------------------------+ || |+---------------------------------------------------------------+ äºæ˜¯æˆ‘ä»¬è¯•æ¢æ€§çš„è‡ªç ”åŸºäºswooleçš„kafkaå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬è‡ªå·±å®ç°æ ¹æ®kafkaåè®®çš„å°åŒ…ï¼Œè§£åŒ…ï¼Œæµç¨‹å¤„ç†ã€‚(swoole-kafka)mthinkingdataæœåŠ¡å°±æ˜¯æˆ‘ä»¬åŸºäºkafka-swooleç ”å‘çš„ä¸šåŠ¡æœåŠ¡ã€‚ 1234567891011121314151617+------------+| || message1 +------------+| | |+------------+ | |+------------+ +------+--------+| | | || message2 +-----+ snappyå‹ç¼© || | | |+------------+ +------+--------+ |+---------------+ || | || message[3..n] +----------+| |+---------------+ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°phpå¯¹äºcpuå¯†é›†å‹çš„å¤„ç†å­˜åœ¨ç“¶é¢ˆï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç”Ÿäº§è€…ä¸€æ–¹å¦‚æœå‘é€å¤šæ¡åè®®çš„æƒ…å†µä¸‹ï¼Œä¼šç»è¿‡ snappy ç®—æ³•çš„å‹ç¼©å†æ¨é€ä»¥ä¾¿å‡å°‘network-ioï¼ˆå¢åŠ cpu-ioï¼‰ã€‚æ¶ˆè´¹è€…åœ¨æ¥å—æ¶ˆæ¯çš„æ—¶å€™ä¹Ÿæ˜¯è¢«å‹ç¼©è¿‡çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å‹ï¼Œåœ¨è¿™ä¸ªè§£å‹çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¸ªååˆ†æ¶ˆè´¹cpuçš„è¿‡ç¨‹ï¼Œå³ä½¿æˆ‘ä»¬å½“æ—¶æ˜¯åŸºäºswoole4.3çš„åç¨‹ç‰ˆæœ¬æ¥å¤„ç†ï¼Œä¸è¡Œçš„æ˜¯çš„æŠ¢å å¼åç¨‹å½“æ—¶å¹¶æ²¡æœ‰å¾ˆå¥½çš„å®Œæˆï¼Œæˆ‘ä»¬æ²¡åŠæ³•è¾¾åˆ°å¿«é€Ÿçš„æ¥å—å¤šä¸ªæ•°æ®åŒ…çš„è¡Œä¸ºã€‚æ¶ˆè´¹é€Ÿåº¦ä¹Ÿå¹¶ä¸æ˜¯ç‰¹åˆ«ç†æƒ³ã€‚åœ¨è¿™ä¸ªå¤§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å€ŸåŠ©redisæ¥ä½œä¸ºä¸­é—´çš„å­˜å‚¨ã€‚è€Œredisæ˜¯å•çº¿ç¨‹çš„ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¯•è¿‡ä½¿ç”¨pipelineç­‰æ‰‹æ®µå‡å°‘tcpä¸­çš„å“åº”åŒ…çš„å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚ä½†æ˜¯ç”±äºredisåªèƒ½åˆ©ç”¨å•æ ¸çš„ç¼˜æ•…ï¼Œæ‰¹é‡å¤„ç†ä¸€æ‰¹æŒ‡ä»¤åï¼Œæœ€é«˜çš„cpuåˆ©ç”¨ç‡æ¥è¿‘100%ä¸‹æ— æ³•å†å¢é•¿ã€‚ä¹Ÿå› æ­¤ï¼Œæˆ‘ä»¬çš„æœåŠ¡æ³¨å®šæ— æ³•è¾¾åˆ°å¾ˆå¥½çš„æ€§èƒ½æµ‹è¯•ã€‚ æˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œå½“æ—¶æœåŠ¡çš„ç“¶é¢ˆåœ¨äºï¼š phpè¯­è¨€æœ¬èº«çš„æ€§èƒ½ swooleåç¨‹ä¸æ”¯æŒæŠ¢å å¼è°ƒåº¦ æœªå®ç°åŠ¨æ€ä¼¸ç¼©æ‰©å±•workeræ•°é‡ï¼ˆæ„Ÿå…´è¶£å¯ä»¥å»çœ‹çœ‹kafka-swooleçš„æ¶æ„åˆ†äº«ï¼‰ redisæœªèƒ½åˆ©ç”¨å¤šæ ¸ï¼Œcpuåˆ©ç”¨ç‡è¾¾åˆ°å³°å€¼ æ–¹æ¡ˆé’ˆå¯¹ä»¥ä¸Šå‡ ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é€ä¸€å¾—å‡ºè§£å†³æ–¹æ¡ˆ ä½¿ç”¨golangè¯­è¨€ï¼ˆè¯­è¨€ä¼˜å…ˆåœ¨å…¬å¸å†…éƒ¨åšå®¢æœ‰æ¯”è¾ƒï¼‰ ä½¿ç”¨åŸºäºgolangçš„åµŒå…¥å¼å­˜å‚¨æœåŠ¡ä½œä¸ºä¸­é—´å­˜å‚¨æœåŠ¡ï¼ˆbadgerï¼‰ï¼ˆrocksdbçš„ä½¿ç”¨åœ¨å°è¯•ä¸­ï¼‰ ä¹Ÿå› æ­¤å‚¬ç”Ÿå‡ºäº†ä½¿ç”¨golangé‡å†™tgaæœåŠ¡ï¼ˆmtgaï¼‰çš„éœ€æ±‚ã€‚ä»¥å…¶ä¸­ä¸€ä¸ªé¡¹ç›®å¼€å‘ä¸ºä¾‹å­(é¡¹ç›®ç¼–å·ï¼š24) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172â”œâ”€â”€ README.mdâ”œâ”€â”€ _build # éƒ¨ç½²çš„ç›®å½•ç»“æ„â”‚ â”œâ”€â”€ README.mdâ”‚ â”œâ”€â”€ bin â”‚ â”‚ â””â”€â”€ mtga # ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶â”‚ â”œâ”€â”€ configâ”‚ â”‚ â”œâ”€â”€ common.envâ”‚ â”‚ â”œâ”€â”€ msource.ymlâ”‚ â”‚ â”œâ”€â”€ mtga.local.ymlâ”‚ â”‚ â””â”€â”€ mtga.ymlâ”‚ â”œâ”€â”€ mctl # æ“ä½œå…¥å£è„šæœ¬â”‚ â”œâ”€â”€ scriptsâ”‚ â”‚ â””â”€â”€ init.sh # ç¬¬ä¸€æ¬¡éƒ¨ç½²é¡¹ç›®éœ€è¦æ‰§è¡Œçš„åˆå§‹åŒ–è„šæœ¬â”‚ â”œâ”€â”€ settingsâ”‚ â”‚ â”œâ”€â”€ mthinkingdata:filter.24.jsonâ”‚ â”‚ â””â”€â”€ mthinkingdata:metadata.24.jsonâ”‚ â””â”€â”€ tmpâ”œâ”€â”€ _local_build # æœ¬åœ°å¼€å‘éƒ¨ç½²çš„ç›®å½•ç»“æ„â”‚ â”œâ”€â”€ README.mdâ”‚ â”œâ”€â”€ binâ”‚ â”‚ â””â”€â”€ mtgaâ”‚ â”œâ”€â”€ configâ”‚ â”‚ â”œâ”€â”€ common.envâ”‚ â”‚ â”œâ”€â”€ msource.ymlâ”‚ â”‚ â”œâ”€â”€ mtga.local.ymlâ”‚ â”‚ â””â”€â”€ mtga.ymlâ”‚ â”œâ”€â”€ mctlâ”‚ â”œâ”€â”€ scriptsâ”‚ â”‚ â””â”€â”€ init.shâ”‚ â”œâ”€â”€ settingsâ”‚ â”‚ â”œâ”€â”€ mthinkingdata:filter.24.jsonâ”‚ â”‚ â””â”€â”€ mthinkingdata:metadata.24.jsonâ”‚ â””â”€â”€ tmpâ”œâ”€â”€ buildâ”‚ â”œâ”€â”€ Dockerfileâ”‚ â”œâ”€â”€ Jenkinsfileâ”‚ â””â”€â”€ README.mdâ””â”€â”€ src â”œâ”€â”€ Makefile # ä¾¿äºæ„å»ºæœåŠ¡ â”œâ”€â”€ app # ä¸šåŠ¡ä»£ç  â”‚ â”œâ”€â”€ bussiness.go # æ¶ˆè´¹è€…çš„ä¸šåŠ¡æ ¸å¿ƒä»£ç  â”‚ â”œâ”€â”€ config â”‚ â”‚ â”œâ”€â”€ app.go â”‚ â”‚ â”œâ”€â”€ redis_keys.go â”‚ â”‚ â”œâ”€â”€ setting_tools.go â”‚ â”‚ â””â”€â”€ settings.go â”‚ â”œâ”€â”€ main.go â”‚ â””â”€â”€ reporter â”‚ â””â”€â”€ notify.go â”œâ”€â”€ cmd # cliç»ˆç«¯å‘½ä»¤ â”‚ â”œâ”€â”€ clear_failure_queue.go # æ¸…ç†å¤±è´¥é˜Ÿåˆ— â”‚ â”œâ”€â”€ failure_queue_count.go # å¤±è´¥é˜Ÿåˆ—æ•°é‡ â”‚ â”œâ”€â”€ kafka_lag.go # å½“å‰æ¶ˆè´¹è€…é˜»å¡æ€»æ•°æ®é‡ â”‚ â”œâ”€â”€ offset_checker.go # topicä¸­å„ä¸ªpartitionçš„å½“å‰offsetä»¥åŠé˜»å¡æƒ…å†µ â”‚ â”œâ”€â”€ restart.go # é‡å¯æœåŠ¡ â”‚ â”œâ”€â”€ root.go â”‚ â”œâ”€â”€ start.go # å¯åŠ¨æœåŠ¡ â”‚ â”œâ”€â”€ start_not_daemon.go # ä»¥éå®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨æœåŠ¡ â”‚ â””â”€â”€ stop.go # æš‚åœæœåŠ¡ â”œâ”€â”€ config # é…ç½®ç›®å½• â”‚ â”œâ”€â”€ msource.yml â”‚ â”œâ”€â”€ mtga.local.yml â”‚ â””â”€â”€ mtga.yml â”œâ”€â”€ go.mod â”œâ”€â”€ go.sum â”œâ”€â”€ main.go â”œâ”€â”€ settings â”‚ â”œâ”€â”€ mthinkingdata:filter.24.json â”‚ â””â”€â”€ mthinkingdata:metadata.24.json â””â”€â”€ test â”œâ”€â”€ setting_test.go â””â”€â”€ setting_tools_test.go æ—©æœŸæˆ‘ä»¬è¿˜æ²¡æŠ›å¼ƒredisçš„æ—¶å€™ï¼ŒæŒç»­å ç”¨cpu100%çš„è¯å°±ä¼šå‡ºç°è¿™ä¸ªã€‚å¦‚æœä¸ç”¨pipeæ¨¡å¼çš„è¯ï¼Œtpsæµ‹è¯•åªæœ‰2500-3500ä¹‹é—´ã€‚æŠ›å¼ƒredisä½¿ç”¨äº†badgerä¹‹åï¼Œ ç»“åˆä¸šåŠ¡é€»è¾‘ï¼Œtps:1w/så·¦å³ å…¶ä¸­ç”¨åˆ°å†…éƒ¨çš„ç»„ä»¶åŒ…å«å¦‚ä¸‹ï¼š commentjson go-graceful-daemon logbdev metl-sdk msink msource mtga &amp;&amp; msource123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081// è½¬æ¢å‰&#123; \"headers\":&#123; \"app_id\":24, \"log_name\":\"log_item\" &#125;, \"logs\":&#123; \"account_name\":\"4866014107\", \"action\":2146, \"agent_id\":36, \"amount\":1, \"bag_amount\":0, \"bag_type\":0, \"bind_type\":1, \"client_version\":\"\", \"device_id\":\"\", \"end_time\":0, \"idfa\":\"\", \"imei\":\"\", \"is_internal\":0, \"item_id\":31103003, \"mac\":\"\", \"mtime\":1608184243, \"pid\":1608184244000008, \"platform\":3100, \"quality\":0, \"regrow\":14, \"role_id\":6001310009300, \"role_level\":800, \"server_id\":5001, \"server_version\":\"\", \"sn\":\"205914E03BF640CB76\", \"star\":0, \"start_time\":1608184243, \"upf\":3100, \"via\":\"36|3100\", \"zero_dateline\":1608134400 &#125;&#125;// è½¬æ¢å&#123; \"#account_id\":\"10289100005300x\", \"#distinct_id\":\"\", \"#event_name\":\"t_log_item\", \"#ip\":\"\", \"#time\":\"2020-12-17 13:52:39\", \"#type\":\"track\", \"properties\":&#123; \"account_name\":\"1608153237001005108\", \"action\":1005, \"agent_id\":11, \"amount\":-1, \"bag_amount\":1, \"bag_type\":0, \"bind_type\":1, \"client_version\":\"\", \"device_id\":\"\", \"end_time\":0, \"idfa\":\"\", \"imei\":\"\", \"is_internal\":0, \"item_id\":10203101, \"mac\":\"\", \"mtime\":1608184359, \"pid\":1608184359000031, \"platform\":101, \"quality\":0, \"regrow\":1, \"role_id\":110289100005300, \"role_level\":160, \"server_id\":289, \"server_version\":\"\", \"sn\":\"\", \"star\":0, \"start_time\":1608184359, \"upf\":101, \"via\":\"11|101\", \"zero_dateline\":1608134400 &#125;&#125; æ•°æ®åœ¨msourceåˆ°mtgaçš„äº¤äº’ æ”¹ç‰ˆå‰ï¼š 12345678910111213141516171819202122232425262728293031323334 +-----------------------------------------+ | +---------+ | | | msource | | | +---------+ | | | | +--------------------------------+ | | | | | | | spoutKafka(channel) | | | | +-&gt;X+-------------------------+ | | | | | | +-------------^----------^-------+ | +-------------v----------------+ | | | | |-----------+ | | | | | || ä¸šåŠ¡æœåŠ¡ | | | | | | +-----------+ |+------------+ | | | | | || | | +--------------------------------+ | | XXXXXXXXXXXXXXX || kafka +---------&gt;X+ | +-------+ | | | | | X1.è¿‡æ»¤çš„æ•°æ® X || | | | | | badge | | | | | | XXXXXXXXXXXXXXX |+------------+ | | | +-------+ | | | | | | | | | | | | | | | | | | +------+-------+ | | | | +---------------+ | | ^---------&gt; | | | ^--------------------+2.å¤±è´¥çš„æ•°æ® | | | | | ç­‰å¾…acké˜Ÿåˆ— &lt;-----^ | | | | +---------------+ | | | | | | | | | | | | | | +--------------+ | | | | | | | | | | | | | | | | | | +--------------+ | | | | | | +------------------+ | | | | +--^ &lt;--------------------------+3.æ­£å¸¸å¤„ç†å®Œçš„æ•°æ® | | | | | ä¸šåŠ¡å¤±è´¥é˜Ÿåˆ— | | | | | +------------------+ | | | | &lt;------------v | | | | | +--------------+ | | +------------------------------+ | +--------------------------------+ | +-----------------------------------------+ æ”¹ç‰ˆåï¼š 12345678910111213141516171819202122232425262728293031323334 +-----------------------------------------+ | +---------+ | +-----------------------+ | | msource | | | | | +---------+ | | ç‰¹å®šæ¡ä»¶ä¸‹æäº¤offse &lt;----------+ | | | | | | +--------------------------------+ | +-----------------------+ | | | | | | | +--&gt; spoutKafka(channel) | | | | | | ï¼ˆæœ‰ç¼“å†²ï¼‰ +-&gt;X+-------------------------+ | | | | | | | | | | +------------------------^-------+ | +-------------v----------------+ | | | | | |-----------+ | | | | | | || ä¸šåŠ¡æœåŠ¡ | | | | | | | +-----------+ | |+------------+ | | | | | | || | | | +--------------------------------+ | | XXXXXXXXXXXXXXX | || kafka +---------&gt;X+ | +-------+ | | | | X1.è¿‡æ»¤çš„æ•°æ® X | || | | | | badge | | | | | XXXXXXXXXXXXXXX | |+------------+ | | +-------+ ^--------&gt; | | | | | | | | | | | | | | | +-------+------+ | | | +---------------+ | | | | | &lt;-----------+X+------------------+2.å¤±è´¥çš„æ•°æ® | | | | | | ä¸šåŠ¡å¤±è´¥é˜Ÿåˆ— | | | | +---------------+ | | | | | | | | | | | | | +--------------+ | | | | | | | | | | | | | | | | | +------------------+ | | | +--------------------------------+ | | |3.æ­£å¸¸å¤„ç†å®Œçš„æ•°æ® +---------&gt; | | | +------------------+ | | | | | | | +------------------------------+ | | +-----------------------------------------+ æ¯10sè®°å½•ä¸€æ¬¡æœ¬åœ°offset æ¥æ”¶åˆ°ä¿¡å·é‡ï¼ˆSIGINT/SIGTERMï¼‰åˆ°æ—¶å€™ä¹Ÿæäº¤ä¸€æ¬¡ 1234567891011121314151617181920212223242526272829303132// æ¥æ”¶åˆ°ä¿¡å·é‡åˆ°æ—¶å€™ä¹Ÿæäº¤ä¸€æ¬¡go func() &#123; ch := make(chan os.Signal, 1) signal.Notify(ch, syscall.SIGINT, syscall.SIGTERM) for _ = range ch &#123; t.Stop() logic.ackf.RLock() for _, partitionMessage := range logic.acks &#123; for _,msg := range partitionMessage &#123; logic.Sk.Ack(msg) &#125; &#125; logic.ackf.RUnlock() &#125;&#125;()// æ¯10sè®°å½•ä¸€æ¬¡æœ¬åœ°offsett := time.NewTicker(10 * time.Second)go func() &#123; for &#123; select &#123; case &lt;-t.C: logic.ackf.RLock() for _, partitionMessage := range logic.acks &#123; for _,msg := range partitionMessage &#123; logic.Sk.Ack(msg) &#125; &#125; logic.ackf.RUnlock() &#125; &#125;&#125;() 12345678910111213141516// æœåŠ¡workerå¯åŠ¨æ ¸å¿ƒé€»è¾‘wg := sync.WaitGroup&#123;&#125;logic := new(CoreLogic)logic.Sk = sklogic.acks = map[string]map[int32]*kafka.Message&#123;&#125;logic.ackf = sync.RWMutex&#123;&#125;for i := 0; i &lt; config.AppConfig.Worker; &#123; wg.Add(1) go func() &#123; defer wg.Done() logic.Consume() &#125;() i++ &#125;wg.Wait() 123456789101112131415161718192021222324252627// bussiness.go çš„æ ¸å¿ƒä»£ç type CoreLogic struct &#123; Sk *msource.SpoutKafka ackf sync.RWMutex acks map[string]map[int32]*kafka.Message&#125;func (business *CoreLogic) Consume() &#123; ... // ä»æ­£å¸¸é˜Ÿåˆ—æ¥çš„æ•°æ® if msg.TopicPartition.Topic != nil &#123; business.ackf.Lock() if _, ok := business.acks[*msg.TopicPartition.Topic]; !ok &#123; business.acks[*msg.TopicPartition.Topic] = map[int32]*kafka.Message&#123;&#125; &#125; business.acks[*msg.TopicPartition.Topic][msg.TopicPartition.Partition] = msg business.ackf.Unlock() &#125; else &#123; // ä»å¤±è´¥é˜Ÿåˆ—æ¥çš„æ•°æ®ï¼Œç‹¬ç«‹å†™å…¥ï¼Œç‹¬ç«‹Ack err = p.Write(fileName, string(sinkBuffer)) if err != nil &#123; logbdev.Error(err) &#125; business.Sk.Ack(msg) &#125;&#125; ç”±äºæˆ‘ä»¬çš„æ¶ˆè´¹è€…éœ€è¦ä»msourceä¸­æŠŠæ¶ˆæ¯æ‹‰å‡ºæ¥ï¼Œæ‰€ä»¥è®¾ç½®äº†ä¸€ä¸ªCorelogicçš„ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº† sk,acks,ackfä¸‰ä¸ªå±æ€§ã€‚ ç”±äºæˆ‘ä»¬éœ€è¦å¼‚æ­¥çš„æäº¤offsetï¼Œæ‰€ä»¥éœ€è¦è®¾ç½® ackf çš„é”æ¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ 1234// è¯»å–æ¶ˆæ¯çš„æ–¹å¼for msg := range business.Sk.MessageChan() &#123; ...&#125; golangçš„æ ¼å¼åŒ–æ—¶é—´æˆ³å¾ˆå¥‡è‘©ï¼Œéœ€è¦ä»¥&quot;2006-01-02 15:04:05&quot;ä¸ºæ ¼å¼è¿›è¡Œæ ¼å¼åŒ–ã€‚ 1234// yyyy-MM-dd hh:mm:ss// yyyy-MM-dd H:i:sjsonArray[\"#time\"] = time.Unix(time.Now().Unix(), 0).Format(\"2006-01-02 15:04:05\") msourcemsourceæ˜¯kafkaå’Œæœ¬åœ°å­˜å‚¨çš„æ¡¥æ¢(é€šä¿¡æœåŠ¡)ï¼Œé—´æ¥å¾—åšç€æœåŠ¡å¯é æ€§çš„ä¿è¯ã€‚ï¼ˆæ•°æ®ä¸ä¸¢ï¼Œä¸é‡ï¼Œæ–¹ä¾¿æŸ¥çœ‹å µå¡æƒ…å†µï¼‰ 12345678910.&#x2F;mctlUsage: mtga [command]Available Commands: clear_failure_queue æ¸…ç©ºå¤±è´¥é˜Ÿåˆ— failure_queue_count å¤±è´¥é˜Ÿåˆ—æ•°é‡ kafka_lag æ¶ˆè´¹é˜»å¡ offset_checker offsetçš„æƒ…å†µ ä»¥ä¸‹å‘½ä»¤éƒ½æ˜¯msourceæä¾›å‡ºæ¥çš„apiï¼Œå†ç”±ä¸šåŠ¡æœåŠ¡å°è£…æˆå‘½ä»¤ ä¾‹å¦‚ï¼šoffset_checker 12345678910.---.----------------.-----------.------------.------------.------------.-----.| # | Topic | Partition | Low | High | Current | Lag |+---+----------------+-----------+------------+------------+------------+-----+| 0 | mulog_clean_24 | 0 | 6171720626 | 6197511755 | 6197511494 | 261 || 1 | mulog_clean_24 | 1 | 6169152656 | 6197196879 | 6197196555 | 324 || 2 | mulog_clean_24 | 2 | 6169656725 | 6195509715 | 6195509483 | 232 || 3 | mulog_clean_24 | 3 | 6172416843 | 6197496752 | 6197496518 | 234 || 4 | mulog_clean_24 | 4 | 6170706518 | 6197423974 | 6197423659 | 315 || 5 | mulog_clean_24 | 5 | 6168091223 | 6196757252 | 6196756991 | 261 |&#39;---&#39;----------------&#39;-----------&#39;------------&#39;------------&#39;------------&#39;-----&#39; ä¾‹å¦‚ï¼škafka_lag/failure_queue_count 11234 msourceå¦‚ä½•åšåˆ°ç”±ä¸šåŠ¡ç³»ç»Ÿæ§åˆ¶æŒ‡å®šoffsetä¸­æ¶ˆè´¹å‘¢ï¼Ÿ æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡äº†badgeræ¥å­˜å‚¨å„ä¸ªtopic-partitionçš„offsetã€‚æœåŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå–å„ä¸ªpartitionçš„offsetï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œå°±è®¾ç½®éœ€è¦ä»å¯¹åº”çš„offsetå¼€å§‹è¯»å–æ•°æ®ã€‚å¦‚æœä¸å­˜åœ¨å¯¹åº”çš„offsetçš„è¯ï¼Œé‚£ä¹ˆå°±æ ¹æ®ä½ çš„ç­–ç•¥ä»æœ€æ—©,æœ€è¿‘å¼€å§‹é€‰æ‹©æ‹‰å–æ•°æ®ã€‚ 12345678910111213141516171819+-------------------+|---------+ ||| badger | |+---------+ +---------------+| | || offsetå­˜å‚¨ | || | |+-------------------+ +---------v-------------+ | | +------------+ | ä»partitionæ‹‰å–æ•°æ® +-----+ ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚| | | +------------+ +---------+-------------+ | |+-------------------+ || | || Kafka &lt;---------------+| |+-------------------+ msourceçš„å·¥ä½œåŸç†åœ¨ä»‹ç»mtgaçš„æ—¶å€™åŸºæœ¬ä¹Ÿå·®ä¸å¤šä»‹ç»å®Œäº†ã€‚è‡³äºè¿™äº›apiçš„å®ç°æ˜¯åŸºäºUnix Socketå®ç°çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114func (sk *SpoutKafka) unixSocketListen() &#123;start: lis, err := net.Listen(\"unix\", UNIX_SOCKET_FILE) if err != nil &#123; logbdev.Info(\"UNIX Domain Socket åˆ›å»ºå¤±è´¥ï¼Œæ­£åœ¨å°è¯•é‡æ–°åˆ›å»º -&gt; \", err) err = os.Remove(UNIX_SOCKET_FILE) if err != nil &#123; logbdev.Info(\"åˆ é™¤ sock æ–‡ä»¶å¤±è´¥ï¼ç¨‹åºé€€å‡º -&gt; \", err) &#125; goto start &#125; else &#123; logbdev.Info(\"åˆ›å»º UNIX Domain Socket æˆåŠŸ\") &#125; sigs := make(chan os.Signal, 1) signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM) go func() &#123; &lt;-sigs if sk.SigTermCbNeed &#123; sk.SigTermCb(true) &#125; &#125;() defer func() &#123; lis.Close() os.Remove(UNIX_SOCKET_FILE) &#125;() invokeObjectMethod := func(conn net.Conn, object interface&#123;&#125;, methodName string, args ...interface&#123;&#125;) &#123; inputs := make([]reflect.Value, len(args)) for i, _ := range args &#123; inputs[i] = reflect.ValueOf(args[i]) &#125; intCb := func(v reflect.Value) &#123; n, err := conn.Write([]byte(fmt.Sprintf(\"%d\\n\", v.Int()))) if n &gt; 0 &#123; logbdev.Info(fmt.Sprintf(\"Cmd: %s ,æˆåŠŸå“åº”ç»“æœ: %d\", methodName, v.Int())) &#125; if err != nil &#123; logbdev.Error(fmt.Sprintf(\"Cmd: %s ,å“åº”å¤±è´¥ %s\", methodName, err)) &#125; &#125; strCb := func(v reflect.Value) &#123; n, err := conn.Write([]byte(fmt.Sprintf(\"%s\\n\", v.String()))) if n &gt; 0 &#123; logbdev.Info(fmt.Sprintf(\"Cmd: %s ,æˆåŠŸå“åº”ç»“æœ: %s\", methodName, v.String())) &#125; if err != nil &#123; logbdev.Error(fmt.Sprintf(\"Cmd: %s ,å“åº”å¤±è´¥ %s\", methodName, err)) &#125; &#125; for _, v := range reflect.ValueOf(object).MethodByName(methodName).Call(inputs) &#123; switch v.Kind() &#123; case reflect.Int: case reflect.Int64: intCb(v) break case reflect.String: strCb(v) break default: _, err := conn.Write([]byte(fmt.Sprintf(\"%s\\n\", \"ä¸æ”¯æŒçš„å“åº”æ•°æ®ç±»å‹\"))) if err != nil &#123; handleError(err.Error()) &#125; &#125; &#125; &#125; handle := func(conn net.Conn) &#123; defer conn.Close() for &#123; var buf = make([]byte, 1024) n, err := conn.Read(buf) // å¦‚æœå·²ç»æ²¡æ•°æ®äº†ï¼Œåˆ™ç»“æŸ if err == io.EOF &#123; return &#125; if err != nil &#123; logbdev.Info(\"Socket conn read error:\", err) return &#125; var cmd Cmd if n &gt; 0 &#123; err := json.Unmarshal(buf[:n], &amp;cmd) if err != nil &#123; _, err := conn.Write([]byte(fmt.Sprintf(\"Rpc-Jsonè§£æå¤±è´¥, err: %s\", err) + \"\\n\")) if err != nil &#123; logbdev.Warn(err) continue &#125; &#125; invokeObjectMethod(conn, sk, cmd.RpcFuncName, cmd.Params...) &#125; &#125; &#125; for &#123; conn, err := lis.Accept() if err != nil &#123; logbdev.Info(\"è¯·æ±‚æ¥æ”¶é”™è¯¯ -&gt; \", err) continue // ä¸€ä¸ªè¿æ¥é”™è¯¯ï¼Œä¸ä¼šå½±å“æ•´ä½“çš„ç¨³å®šæ€§ï¼Œå¿½ç•¥å°±å¥½ &#125; go handle(conn) //å¼€å§‹å¤„ç†æ•°æ® &#125;&#125; ä¹‹å‰åœ¨mtgaä¸­å‡ºç°è¿‡ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯rpcè¶…æ—¶é—®é¢˜çš„é—®é¢˜ï¼ˆsocketè¶…æ—¶ï¼‰ã€‚è¿™ä¸ªé—®é¢˜å¯¼è‡´äº†æˆ‘ä»¬åœ¨æ‰§è¡Œå„ç§å‘½ä»¤çš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°é—®é¢˜ä¼šä¸€ç›´hang upçš„çŠ¶æ€ï¼Œå¾—ä¸åˆ°ç»“æœçš„åŒæ—¶ä¸€ç›´å¡ä½ã€‚å½±å“åˆ°äº†æˆ‘ä»¬å¯¹æœåŠ¡çš„ç›‘æ§ã€‚ 1234567891011+----------------------------------------------------------+| +-------------+ || | msource | || +-------------+ || || +---------------------+ +---------------------+ || | | | | || | unix socket server | | unix socket client | || | | | | || +---------------------+ +---------------------+ |+----------------------------------------------------------+ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬åœ¨unix socket client è¿™é‡ŒåŠ äº†ä¸€ä¸ªè¶…æ—¶çš„æœºåˆ¶ã€‚å€ŸåŠ©æ˜¯contextçš„æœºåˆ¶ï¼Œå®ç°åç¨‹ä¹‹é—´çš„è¶…æ—¶é€šä¿¡ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758const ( TimeoutMsg = \"æ“ä½œè¶…æ—¶, è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€!\" TimeoutInt = -1)rcn := make(chan bool)ctx, cancel := context.WithTimeout(context.Background(), time.Second*10)defer cancel()go func() &#123; if exists(UNIX_SOCKET_FILE) &#123; conn, err := net.Dial(\"unix\", UNIX_SOCKET_FILE) if err != nil &#123; handleError(err.Error()) &#125; defer conn.Close() rpc := Cmd&#123;RpcFuncName: \"FailureQueueCount\"&#125; data, err := json.Marshal(rpc) if err != nil &#123; handleError(fmt.Sprintf(\"encode-jsonå¤±è´¥\")) &#125; n, err := conn.Write(data) if n &gt; 0 &amp;&amp; err == nil &#123; reader := bufio.NewReader(conn) msg, err := reader.ReadString('\\n') if err != nil &#123; logbdev.Info(err) &#125; msg = msg[:len(msg)-len(\"\\n\")] lagInt, err := strconv.Atoi(msg) if err != nil &#123; handleError(err.Error()) &#125; lag = int64(lagInt) &#125; &#125; else &#123; sk := SourceToolRun(configOpts) lag = sk.FailureQueueCount() &#125; rcn &lt;- true&#125;()for &#123; select &#123; case &lt;-ctx.Done(): if ctx.Err() != nil &#123; logbdev.Warn(ctx.Err()) return TimeoutInt &#125; else &#123; return lag &#125; case &lt;- rcn: return lag &#125;&#125; è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªcontext.WithTimeout æ˜¯ä¸ç®¡ä½ å†…éƒ¨æ˜¯å¦å¤„ç†å®Œæ¯•ï¼Œä¸€å®šä¼šåœ¨æŒ‡å®šçš„æ—¶é—´å†…timeoutï¼Œæ‰€ä»¥å¦‚æœæå‰å®Œæˆäº†å¿…é¡»é€šè¿‡è‡ªå·±çš„æ‰‹æ®µæå‰ç»“æŸã€‚ msinkè¿™ä¸ªç»„ä»¶çš„ä½œç”¨ä¸»è¦æ˜¯ç”¨äºæŠŠæŒ‡å®šçš„æ¶ˆæ¯è¿›è¡Œsinkåˆ°å„ç§ç»ˆç«¯ï¼Œä¾‹å¦‚msink_file,msink_kafkaç­‰ç­‰ã€‚ ç›®å‰æˆ‘ä»¬æ˜¯å°è£…åœ¨åŒä¸€ä¸ªä»“åº“ä¸­ï¼Œä»¥ä¸åŒæ–‡ä»¶ä¿å­˜ï¼Œåç»­ï¼Œæˆ‘ä»¬æˆ–è®¸ä¼šè€ƒè™‘æ‹†åˆ†å¼€æ¥ä¾¿äºç»´æŠ¤å‘ç‰ˆã€‚ 1234567891011â”œâ”€â”€ Dockerfileâ”œâ”€â”€ README.MDâ”œâ”€â”€ config.goâ”œâ”€â”€ config.ymlâ”œâ”€â”€ config_test.goâ”œâ”€â”€ error.goâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ msource_spout.goâ”œâ”€â”€ msource_spout_test.goâ””â”€â”€ rpc.go è¿™é‡Œä¸»è¦å’Œå¤§å®¶è¯´ä»¥ä¸‹msink_fileå§ï¼Œmsink_kafkaçš„å®ç°åŸç†å·®ä¸å¤šã€‚ æ”¯æŒè‡ªå®šä¹‰å›è°ƒå‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦å†™å…¥æˆåŠŸ æ”¯æŒæ‰¹å¤„ç†å’Œæµå¼å¤„ç† æµå¼å¤„ç†æœ‰ç‹¬ç«‹çš„Api func (f *FileClient) WriteWithoutEol(filePath string, message string) error func (f *FileClient) Write(filePath string, message string) error (f *FileClient) BatchLineDataChannel() chan&lt;- map[Filename]ChannelMessage æ‰¹å¤„ç†çš„Api (f *FileClient) BatchLineDataChannel() chan&lt;- map[Filename]ChannelMessage å¯èƒ½ç»†å¿ƒçš„æœ‹å‹å·²ç»å‘ç°äº†ï¼Œæµå¼å¤„ç†çš„ApiåŒ…å«äº†æ‰¹å¤„ç†çš„Apiã€‚æ˜¯çš„ï¼Œè¢«åŒ…å«åœ¨ä¸€èµ·äº†ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å­ï¼Ÿ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102func NewFileClient(client afero.Fs, opts ...DialOption) *FileClient &#123; p := new(FileClient) p.client = client p.dopts = defaultOptions() p.batchLineDataChannel = make(chan map[Filename]ChannelMessage, 1000) p.events = make(chan FileMetaMessage, 100) //å¾ªç¯è°ƒç”¨opts for _, opt := range opts &#123; opt.apply(&amp;p.dopts) &#125; var writer func(fileClient *FileClient) if p.dopts.batchWrite &#123; writer = channelBatchWriter &#125; else &#123; writer = channelWriter &#125; p.wg.Add(1) go func() &#123; writer(p) p.wg.Done() &#125;() p.wg.Add(1) go func() &#123; p.run() p.wg.Done() &#125;() return p&#125;// æµå¼func channelWriter(client *FileClient) &#123; for m := range client.batchLineDataChannel &#123; for fn, msg := range m &#123; err := client.WriteWithoutEol(string(fn), string(msg)) client.events &lt;- FileMetaMessage&#123;Message: string(msg), Error: err&#125; &#125; &#125;&#125;// æ‰¹é‡func channelBatchWriter(client *FileClient) &#123; var buffered = make(map[Filename][]ChannelMessage) bufferedCnt := 0 batchSize := client.dopts.batchLineDataChannelCount for m := range client.batchLineDataChannel &#123; for fn, msg := range m &#123; buffered[fn] = append(buffered[fn], msg) bufferedCnt++ &#125; loop: for true &#123; select &#123; case m, ok := &lt;-client.batchLineDataChannel: if !ok &#123; break loop &#125; if m == nil &#123; panic(\"nil message received on batchLineDataChannel\") &#125; for fn, msg := range m &#123; buffered[fn] = append(buffered[fn], msg) bufferedCnt++ if bufferedCnt &gt; batchSize &#123; break loop &#125; &#125; default: break loop &#125; &#125; var tmpLongMsg = make(map[Filename]string) for Filename, ChannelMessageList := range buffered &#123; tmpMsg := \"\" for _, cm := range ChannelMessageList &#123; tmpMsg += string(cm) &#125; tmpLongMsg[Filename] = tmpMsg &#125; for Filename, longMsg := range tmpLongMsg &#123; err := client.WriteWithoutEol(string(Filename), longMsg) for _, ChannelMessageList := range buffered &#123; for _, cm := range ChannelMessageList &#123; client.events &lt;- FileMetaMessage&#123;Message: string(cm), Error: err&#125; &#125; &#125; &#125; buffered = make(map[Filename][]ChannelMessage) bufferedCnt = 0 &#125;&#125; çœ‹åˆ°è¿™é‡Œå¤§å®¶åº”è¯¥ä¹ŸçŸ¥é“Apiåº”è¯¥å°±å¯ä»¥ç†è§£ä¸ºä»€ä¹ˆä¼šè¢«åŒ…å«åœ¨ä¸€èµ·äº†ã€‚ logdevè¿™æ˜¯æˆ‘ä»¬çš„æ—¥å¿—ç»„ä»¶ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¤šå¤šå°‘å°‘å·²ç»æœ‰äº†è¿™ä¸ªç»„ä»¶çš„èº«å½±ã€‚ 12345678910111213141516â”œâ”€â”€ README.mdâ”œâ”€â”€ exported.goâ”œâ”€â”€ go.modâ”œâ”€â”€ go.sumâ”œâ”€â”€ hooksâ”‚ â”œâ”€â”€ reporterâ”‚ â”‚ â”œâ”€â”€ metl.goâ”‚ â”‚ â”œâ”€â”€ reporter.goâ”‚ â”‚ â””â”€â”€ reporter_test.goâ”‚ â””â”€â”€ stackerâ”‚ â”œâ”€â”€ stacker.goâ”‚ â””â”€â”€ stacker_test.goâ”œâ”€â”€ logbdev.goâ”œâ”€â”€ logbdev_test.goâ”œâ”€â”€ logger.goâ”œâ”€â”€ mc_formatter.go å¸¸è§„è®¾ç½®ï¼Œä¸»è¦æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªç»„ä»¶ä¸­æ·»åŠ äº†å‡ ä¸ªhookï¼Œåˆ†åˆ«æ˜¯reporter,stacker reporter ï¼ˆè®¾ç½®éœ€è¦ä¸ŠæŠ¥æ—¥å¿—çš„çº§åˆ«ï¼Œç”¨äºå¦‚æœå‘ç°äº†errorçº§åˆ«çš„é”™è¯¯å°±æ¨é€æ—¥å¿—åˆ°æˆ‘ä»¬çš„å‘Šè­¦æœåŠ¡ä¸­ã€‚ï¼‰ stacker ï¼ˆè®¾ç½®éœ€è¦è¾“å‡ºå †æ ˆçš„çº§åˆ«æ—¥å¿—çº§åˆ«ï¼‰ æ—¥å¿—å­˜å‚¨çš„æ–¹å¼æœ‰å‡ ç§ å¸¸è§„çš„å•æ—¥å¿—å­˜å‚¨ æ—¥å¿—æŒ‰ç…§å¤§å°è½®è½¬ æ—¥å¿—æŒ‰ç…§æ—¥æœŸè½®è½¬ commentjsonè¿™ä¸ªæ˜¯ç”¨æ¥è§£æåŒ…å«äº†æ¢è¡Œç¬¦,ç©ºç™½è¡Œ,è¡Œæ³¨é‡Š,æ®µæ³¨é‡Šç­‰ç­‰çš„jsonå­—ç¬¦ä¸² 1234â”œâ”€â”€ README.mdâ”œâ”€â”€ hjson.goâ”œâ”€â”€ hjson_test.goâ””â”€â”€ test.json è¿™ä¸ªåŸç†ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªä¸ªå­—ç¬¦å»åŒ¹é…ï¼Œé‡æ–°æ„é€ å‡ºä¸€ä¸ªæ–°çš„åˆæ³•çš„jsonæ ¼å¼ã€‚é‡Œé¢çš„å•å…ƒæµ‹è¯•ä¹Ÿåšå¾—æ¯”è¾ƒå®Œå–„äº†ã€‚ go-graceful-daemonè¿™ä¸ªç»„ä»¶æ˜¯ç”¨æ¥å°†æœåŠ¡å˜æˆå®ˆæŠ¤è¿›ç¨‹ç”¨çš„ã€‚ 1234567â”œâ”€â”€ README.mdâ”œâ”€â”€ daemon.goâ”œâ”€â”€ go.modâ”œâ”€â”€ go.mod2â”œâ”€â”€ signal.goâ””â”€â”€ test â””â”€â”€ test.go è¿™é‡Œçš„æ ¸å¿ƒä¸»è¦æ˜¯å€ŸåŠ©äº†syscallçš„ForkExecå®ç°ã€‚ 1234567891011121314func forkDaemon() error &#123; args := os.Args os.Setenv(\"__Daemon\", \"true\") procAttr := &amp;syscall.ProcAttr&#123; Env: os.Environ(), &#125; pid, err := syscall.ForkExec(os.Args[0], args, procAttr) if err != nil &#123; return err &#125; log.Printf(\"[%d] %s start daemon\\n\", pid, AppName) savePid(pid) return nil&#125; å¹¶ä¸”æ”¯æŒè‡ªå®šå®ç°ä¿¡å·é‡çš„æ•æ‰å¤„ç†é€»è¾‘ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859var ErrStop = errors.New(\"stop serve signals\")type SignalHandlerFunc func(sig os.Signal) (err error)func SetSigHandler(handler SignalHandlerFunc, signals ...os.Signal) &#123; for _, sig := range signals &#123; handlers[sig] = handler &#125;&#125;// ServeSignals calls handlers for system signals.func ServeSignals() (err error) &#123; signals := make([]os.Signal, 0, len(handlers)) for sig := range handlers &#123; signals = append(signals, sig) &#125; ch := make(chan os.Signal, 8) signal.Notify(ch, signals...) for sig := range ch &#123; err = handlers[sig](sig) if err != nil &#123; break &#125; &#125; signal.Stop(ch) if err == ErrStop &#123; err = nil &#125; return&#125;var handlers = make(map[os.Signal]SignalHandlerFunc)func init() &#123; handlers[syscall.SIGINT] = sigtermDefaultHandler handlers[syscall.SIGTERM] = sigtermDefaultHandler handlers[syscall.SIGHUP] = sighupDefaultHandler&#125;func sigtermDefaultHandler(sig os.Signal) error &#123; log.Printf(\"[%d] %s stop graceful\", os.Getpid(), AppName) log.Printf(\"[%d] %s stopped.\", os.Getpid(), AppName) os.Remove(PidFile) os.Exit(1) return ErrStop&#125;func sighupDefaultHandler(sig os.Signal) error &#123; //only deamonæ—¶ä¸æ”¯æŒkill -HUP,å› ä¸ºå¯èƒ½ç›‘å¬åœ°å€ä¼šå ç”¨ log.Printf(\"[%d] %s stopped.\", os.Getpid(), AppName) os.Remove(PidFile) os.Exit(2) return ErrStop&#125; ç›®å‰å†…ç½®äº†SIGINT,SIGTERM,SIGHUPçš„é»˜è®¤è¡Œä¸º","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€DevOpsã€‘Jenkinsçš„share-librariesæ˜æœçš„è¿ç”¨","slug":"DevOps/Jenkinsåœ¨æ˜æœçš„è¿ç”¨","date":"2020-11-10T08:44:30.000Z","updated":"2021-03-20T16:25:01.798Z","comments":true,"path":"2020/11/10/DevOps/Jenkinsåœ¨æ˜æœçš„è¿ç”¨/","link":"","permalink":"http://blog.crazylaw.cn/2020/11/10/DevOps/Jenkins%E5%9C%A8%E6%98%8E%E6%9C%9D%E7%9A%84%E8%BF%90%E7%94%A8/","excerpt":"å‰è¨€æœ¬æ¬¡æˆ‘ä»¬ä¸ä»Jenkinsçš„éƒ¨ç½²æ¶æ„å’Œå…·ä½“é…ç½®è¯´æ˜ï¼Œæˆ‘ä»¬ä¸»è¦å›´ç»• jenkinsfile çš„å†…éƒ¨æ¥è®²è§£ã€‚","text":"å‰è¨€æœ¬æ¬¡æˆ‘ä»¬ä¸ä»Jenkinsçš„éƒ¨ç½²æ¶æ„å’Œå…·ä½“é…ç½®è¯´æ˜ï¼Œæˆ‘ä»¬ä¸»è¦å›´ç»• jenkinsfile çš„å†…éƒ¨æ¥è®²è§£ã€‚ Jenkinsfileç›®å‰æˆ‘ä»¬çš„ jenkins æœåŠ¡ç”¨è¿‡æ™®é€šçš„pipelineå’Œ å¤šåˆ†æ”¯çš„pipelineï¼Œå…¶ä¸»è¦åŒºåˆ«å°±æ˜¯å¤šåˆ†æ”¯pipelineæ›´åŠ çµæ´»ä¸€äº›ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬å°‘åšä¸€äº›é€»è¾‘å¤„ç†ã€‚ä½†æ˜¯è¿™å¼•å…¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬çš„jenkinsï¼Œå¿…é¡»å­˜åœ¨ä¸å¯¹åº”çš„åˆ†æ”¯ä¸­ï¼Œä¹Ÿå› æ­¤ï¼Œpipeline çš„æµç¨‹å˜æˆäº†ä»£ç ç®¡ç†ï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬å­˜åœ¨å¤šä¸ªé¡¹ç›®ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰é¡¹ç›®æ•° * 2(master/pre-develop) é‚£ä¹ˆå¤šçš„ jenkins éœ€è¦ç®¡ç†ï¼Œäºæ˜¯å°±å¯¼è‡´äº†æˆ‘ä»¬æœ‰å¾ˆå¤šè¿™ç§å†—ä½™çš„å†™æ³•ï¼Œè¿™è¿˜ä¸æ˜¯æœ€ç³Ÿç³•çš„ï¼Œæœ€ç³Ÿç³•çš„æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€äº›é€šç”¨çš„å†…å®¹çš„æ—¶å€™ï¼Œå°±éœ€è¦ä¸€ä¸ªä¸ªå»ä¿®æ”¹ï¼Œè¿™ç»å¯¹æ˜¯ç¾éš¾çº§åˆ«çš„éœ€æ±‚ã€‚ Jenkinsfileçš„å®ç°åˆ†ä¸º2ç§ï¼Œåˆ†åˆ«æ˜¯å£°æ˜å¼pipelineå’Œè„šæœ¬å¼pipelineï¼Œè¿™2ç§å„æœ‰ä¼˜ç¼ºç‚¹ jenkinséœ€è¦åšçš„äº‹æƒ…ï¼Œå¯ä»¥æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å‡ ç§ï¼š æ‹‰å–ä»£ç  ç‰ˆæœ¬ç®¡ç† å•å…ƒæµ‹è¯• æ„å»ºéƒ¨ç½² é€šçŸ¥ç»“æœ å£°æ˜å¼pipelineå¯ä»¥ä¸ºæˆ‘ä»¬æä¾›å…³é”®å­— å’Œ é¡ºåºç»“æ„æ¥è¾…åŠ©æˆ‘ä»¬å®Œæˆå¦‚ä¸Šçš„5ä¸ªé˜¶æ®µã€‚ ä½†æ˜¯ä»–çš„ç¼ºç‚¹ä¹Ÿæ˜¯æ˜æ˜¾çš„ï¼Œå°±æ˜¯ä¸èƒ½å¾ˆçµæ´»æ ¹æ®è‡ªå·±çš„æƒ³æ³•å»åšå¤„ç†é€»è¾‘ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯æ¯”è¾ƒè›‹ç–¼çš„ï¼Œä¾‹å¦‚é¡¹ç›®Aå’Œé¡¹ç›®Bï¼Œç‹¬ç«‹ç»´æŠ¤ä¸€ä¸ªjenkinsfileï¼Œä½†æ˜¯å…¶å®é¡¹ç›®Aå’Œé¡¹ç›®Bçš„jenkinsfileå…¶å®æ˜¯ä¸€è‡´çš„ï¼Œå¦‚æœæŸä¸€æ¡è¦ä¼˜åŒ–è¿™ä¸ªjenkinsfileçš„éƒ¨ç½²é€»è¾‘äº†ã€‚é‚£ä¹ˆé¡¹ç›®Bå’Œé¡¹ç›®Aéƒ½éœ€è¦ä¸€èµ·å¤„ç†ï¼Œæ— æ³•å®ç°å¤ç”¨çš„æ¦‚å¿µï¼Œå¹¶æ²¡æœ‰æä¾›æŠ½è±¡çš„æ¦‚å¿µï¼Œä¸åˆ©äºç»´æŠ¤ã€‚ å¯¹äºä¸€äº›ç›¸å¯¹ç®€å•ï¼Œæ²¡æœ‰å¤ªå¤æ‚æµç¨‹çš„æ„å»ºè¿‡ç¨‹æ¥è¯´ï¼Œå£°æ˜å¼ä¸€å®šæ˜¯å¤§å®¶çš„é¦–è¦é€‰æ‹©ã€‚ è„šæœ¬å¼pipelineå¯ä»¥ç»™æˆ‘ä»¬æä¾›ç±»ä¼¼äºå†™ä»£ç è„šæœ¬çš„æ–¹å¼æ¥ç»„ç»‡éƒ¨ç½²é€»è¾‘ï¼Œæˆ‘æŠŠè„šæœ¬å¼pipelineå®šä¹‰ä¸ºå‡çº§ç‰ˆçš„å£°æ˜å¼pipelineã€‚ è™½ç„¶è„šæœ¬å¼çš„pipelineå¯ä»¥ç»™æˆ‘ä»¬æä¾›çµæ´»çš„éƒ¨ç½²é€»è¾‘ï¼Œä½†æ˜¯ä¾æ—§æ— æ³•è§£å†³æˆ‘ä»¬çš„å¤ç”¨çš„é—®é¢˜ã€‚ æˆ‘ä»¬éœ€è¦æŠŠè¿™ç§èƒ½å¤ç”¨çš„ä¸œè¥¿æ”¾åœ¨åŒä¸€ä¸ªåœ°æ–¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œç±»ä¼¼äºä¾èµ–åº“çš„æ¦‚å¿µï¼Œç‹¬ç«‹ä¸jenkinsfileä¹‹å¤–çš„ä¸€ç§å­˜åœ¨ã€‚äºæ˜¯ä¹ï¼Œè¿™ä¾¿æœ‰äº†jenkins-shard-libarayã€‚ Jenkins-shard-libarayè¿™æ˜¯ä¸€ä¸ªjenkinsä¸­çš„å…±äº«ç±»åº“ï¼Œåªéœ€è¦åœ¨jenkinsfileä¸­å¯¹å…¶å¼•å…¥ï¼Œå°±å¯ä»¥å¼•ç”¨å…±äº«åº“çš„ä»£ç ï¼Œä»è€Œå®ç°æˆ‘ä»¬çš„å¤ç”¨ã€‚ ä½†æ˜¯æœ‰ä¸€ç‚¹æ˜¯è¿™ä¸ªå…±äº«åº“ï¼Œéœ€è¦æˆ‘ä»¬å‚¨å¤‡ç‚¹groovyè¯­è¨€çš„çŸ¥è¯†ï¼Œå› ä¸ºä»–æ˜¯ç”¨groovyä½œä¸ºâ€å¤–æŒ‚â€çš„æ–¹å¼åŠ è½½è¿è¡Œçš„ã€‚ æˆ‘ä»¬åœ¨å†™å…±äº«åº“çš„æ—¶å€™ï¼Œå¿…é¡» ä¾ç…§è¦æœ‰2ä¸ªåŸºæœ¬ç›®å½•ï¼Œå¦åˆ™jenkinsæ— æ³•ç±»åº“ã€‚ src (å¿…è¦ï¼Œæ ¸å¿ƒä»£ç ) vars (éå¿…è¦ï¼Œå£°æ˜è‡ªå·±çš„è¯­æ³•) resources (éå¿…è¦ï¼Œé…ç½®å­˜æ”¾çš„ç›®å½•) 123456789101112131415161718192021222324252627282930313233343536373839404142./â”œâ”€â”€ Jenkinsfile.example jenkinsfileçš„DEMOæ ·å¼â”œâ”€â”€ README.MDâ”œâ”€â”€ jarsâ”‚ â”œâ”€â”€ groovy-cps-1.1.jarâ”‚ â””â”€â”€ pipeline-model-definition-1.7.1.jarâ”œâ”€â”€ resources é…ç½®æ–‡ä»¶å’ŒåŸºç¡€åº“åˆ†å¼€ç®¡ç†äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šå­˜åœ¨é™æ€èµ„æºæ–‡ä»¶â”œâ”€â”€ srcâ”‚ â””â”€â”€ comâ”‚ â””â”€â”€ companyâ”‚ â””â”€â”€ jenkinsâ”‚ â”œâ”€â”€ BasePipeline.groovy åŸºç¡€ç®¡é“â”‚ â”œâ”€â”€ CommonPipeline.groovy å…¬å…±ç®¡é“â”‚ â”œâ”€â”€ Constant.groovy å¸¸é‡ç±»â”‚ â”œâ”€â”€ Deploy.groovy éƒ¨ç½²åŸºç±»â”‚ â”œâ”€â”€ Git.groovy gitç›¸å…³çš„æ“ä½œç±»â”‚ â”œâ”€â”€ GolangPipeline.groovy golangé¡¹ç›®ç®¡é“â”‚ â”œâ”€â”€ LaravelPipeline.groovy laravelé¡¹ç›®ç®¡é“â”‚ â”œâ”€â”€ MPipeline.groovy åˆå§‹åŒ–ç±»â”‚ â”œâ”€â”€ MetlNotify.groovy ç”¨äºå‘é€é€šçŸ¥çš„ç±»â”‚ â”œâ”€â”€ Repo.groovy ç”¨äºå®ä¾‹åŒ–ä»£ç ä»“åº“ä¿¡æ¯â”‚ â”œâ”€â”€ SummaryNotify.groovy ç”¨äºç»“æ„åŒ–é€šçŸ¥å†…å®¹çš„ç±»â”‚ â””â”€â”€ deployments å…·ä½“çš„éƒ¨ç½²ç±»â”‚ â”œâ”€â”€ AbstractDeployment.groovy æŠ½è±¡éƒ¨ç½²ç±»â”‚ â”œâ”€â”€ BaseDeployment.groovy åŸºç¡€éƒ¨ç½²ç±»â”‚ â”œâ”€â”€ DefaultDeployment.groovy é»˜è®¤éƒ¨ç½²ç±»â”‚ â””â”€â”€ GolangDeployment.groovy Goéƒ¨ç½²ç±»â”œâ”€â”€ tests å•å…ƒæµ‹è¯•ç›®å½•â”‚ â”œâ”€â”€ RepoTest.groovyâ”‚ â””â”€â”€ classfilesâ”‚ â””â”€â”€ comâ”‚ â””â”€â”€ companyâ”‚ â””â”€â”€ jenkinsâ”‚ â”œâ”€â”€ Constant.classâ”‚ â”œâ”€â”€ Git.classâ”‚ â”œâ”€â”€ MPipeline.classâ”‚ â”œâ”€â”€ MetlNotify.classâ”‚ â”œâ”€â”€ Repo.classâ”‚ â””â”€â”€ SummaryNotify.classâ””â”€â”€ vars å…¨å±€å‡½æ•°å®šä¹‰ç›®å½• â”œâ”€â”€ mpipeline.groovy è‡ªå®šä¹‰å…¥å£è¯­æ³•ç³– â””â”€â”€ notify.groovy å®šä¹‰é€šçŸ¥å…¨å±€è°ƒç”¨å‡½æ•° Jenkinsfile12345678910mpipeline&#123; script&#x3D;this&#125;import com.company.jenkins.LaravelPipelinedef laravelPipeline &#x3D; new LaravelPipeline(this)node &#123; laravelPipeline.preBuild().build().debug().reviews().production().execute()&#125; è¿™æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„jenkinsfileçš„demoã€‚æˆ‘ä»¬æŠŠä»–åˆ†ä¸º2ä¸ªéƒ¨åˆ†ã€‚ 1234# ç¬¬ä¸€éƒ¨åˆ†mpipeline&#123; script&#x3D;this&#125; 1234567# ç¬¬äºŒéƒ¨åˆ†import com.company.jenkins.LaravelPipelinedef laravelPipeline &#x3D; new LaravelPipeline(this)node &#123; laravelPipeline.preBuild().build().debug().reviews().production().execute()&#125; è¿™2ä¸ªéƒ¨åˆ†å„å¸å…¶èŒã€‚ ç¬¬ä¸€éƒ¨åˆ† mpipeline çš„è¯­æ³•ç³–ï¼Œæ¥è‡ªäºæˆ‘ä»¬vars/mpipeline.groovyæ–‡ä»¶ï¼Œè¿™æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„è¯­æ³•ç³–ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344import com.company.jenkins.*&#x2F;** * * @param body * repo ä»£ç ä»“åº“åœ°å€ default: null * autoCheckout æ˜¯å¦éœ€è¦è‡ªåŠ¨checkoutä»£ç ï¼Œdefault: true * @return *&#x2F;def call(body) &#123; def config &#x3D; [:] body.resolveStrategy &#x3D; Closure.DELEGATE_FIRST body.delegate &#x3D; config body() config.repo &#x3D; config.repo ?: null config.script &#x3D; config.script ?: null config.autoCheckout &#x3D; config.autoCheckout ?: true if (config.script &#x3D;&#x3D; null) &#123; throw new Exception(&quot;&lt;script&#x3D;this&gt;æ˜¯å¿…å¡«å‚æ•°&quot;) &#125; if (config.repo &#x3D;&#x3D; null) &#123; config.repo &#x3D; config.script.scm.getUserRemoteConfigs()[0].getUrl() &#125; node &#123; def mpipe &#x3D; new MPipeline(config.script, config.repo) mpipe.initializeResources() def credentialsId &#x3D; config.credentialsId ?: config.script.gitCredentialsId if (config.autoCheckout) &#123; stage(&quot;Checkout&quot;) &#123; &#x2F;&#x2F; git clone repo git credentialsId: credentialsId, url: mpipe.repo.getGitLink(), branch: env.BRANCH_NAME &#125; &#125; mpipe.initializeEnvironment() &#125; return this&#125; è¿™ä¸ªè¯­æ³•ç³–åšçš„å†…å®¹å®šä¹‰äº† mpipeline åšçš„å†…å®¹ï¼Œå…¶ä¸­æœ‰ä¸‰ä¸ªæœ‰æ•ˆå‚æ•° repo, script, autoCheckoutï¼Œåˆ†åˆ«çš„æ„æ€æ˜¯ä»£è¡¨è¯¥ä»»åŠ¡ä¸‹çš„æ“ä½œä»“åº“åœ°å€ï¼Œå½“å‰ä»»åŠ¡ä¸Šä¸‹æ–‡, æ˜¯å¦è‡ªåŠ¨æ‹‰å–ä»£ç ã€‚å…¶ä¸­ scriptå‚æ•°ä¸ºå¿…å¡«å‚æ•°ï¼Œå…¶ä»–2ä¸ªéƒ½æ˜¯é€‰å¡«å‚æ•°ï¼Œå…¶éƒ½å­˜åœ¨é»˜è®¤å€¼ã€‚è¿™ä¸ªscriptå¿…å¡«çš„åŸå› æ˜¯å› ä¸ºä¸€å®šè¦ä»jenkinsfileæŠŠå¯¹è±¡ä¼ é€’è¿›æ¥ï¼Œå¦åˆ™ä½œç”¨åŸŸæœ‰æ‰€ä¸åŒã€‚å› ä¸ºæˆ‘ä»¬åœ¨ç¬¬äºŒéƒ¨åˆ†è¦æŠŠè¿™ä¸ªå¯¹è±¡ç»§ç»­ä¼ é€’ä¸‹å»ï¼Œå› ä¸ºä»–æºå¸¦äº†è´¯ç©¿æ•´ä¸ªä»»åŠ¡çš„ä¸Šä¸‹æ–‡ã€‚ æˆ‘ä»¬è¿™é‡Œçœ‹åˆ°äº† node ç»“æ„å—ï¼Œè¿™æ˜¯å› ä¸ºåœ¨è„šæœ¬å¼pipelineä¸­ï¼Œä»–å…¶å®ä¹Ÿæ˜¯jenkinså†…ç½®çš„ä¸€ä¸ªè‡ªå®šä¹‰è¯­æ³•ç³–ï¼Œæ‰€ä»¥ä»–å¯ä»¥ç›´æ¥è¢«åµŒå…¥åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­ã€‚å› ä¸ºæˆ‘ä»¬è¿™é‡Œå®ä¾‹åŒ–äº†å…±äº«åº“ä¸­çš„Mpipelineç±»ï¼Œæ‰€ä»¥éœ€è¦åœ¨ node ç»“æ„å—ä¸­ç¼–å†™ä»£ç ã€‚ åœ¨è¿™ä¸€å—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åšäº†3ä»¶äº‹ 12345+--------------------------------------+ +--------------------------------+ +----------------------------------------------------+| | | | | || 1. Initialize the custom resource +---------------&gt;+ 2. Pull the warehouse code +-------------&gt;+ 3. Initialize the custom environment variable || | | | | |+--------------------------------------+ +--------------------------------+ +----------------------------------------------------+ åˆå§‹åŒ–è‡ªå®šä¹‰èµ„æºï¼ˆæ¥ä¸‹æ¥è¦è¯´çš„resource-libarayå…±äº«åº“ï¼‰ æ‹‰å–ä»“åº“ä»£ç ï¼ˆè¿™æ˜¯jenkinsè‡ªå¸¦çš„ä¸€ä¸ªgitæ’ä»¶ï¼Œè°ƒç”¨gitå‡½æ•°ï¼ŒåŠ ä¸Šä¸€äº›å‚æ•°ï¼Œå°±ä¼šæ‹‰å–ä»£ç åˆ°ä¸€ä¸ªç›®å½•ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºï¼‰ åˆå§‹åŒ–è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ åˆå§‹åŒ–è‡ªå®šä¹‰èµ„æºçš„ä»£ç å¦‚ä¸‹ï¼š 12345678910111213&#x2F;** * åˆå§‹åŒ–èµ„æºåº“ *&#x2F;def initializeResources() &#123; this.script.mresource_load([ script: this.script, groupRepo: this.getRepoGroupRepo(), shortJobName: this.getShortName(), host: this.getHost() ]) return this&#125; è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡ä¸Šä¸‹æ–‡å˜é‡ï¼Œè°ƒç”¨äº† mresource_load å‡½æ•°ï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬åœ¨ resource-libarayå…±äº«åº“ å®šä¹‰çš„å‡½æ•°ï¼Œç”¨äºåŠ è½½å¯¹åº”ä»“åº“çš„å…·ä½“èµ„æºé…ç½®ç”¨ï¼Œç›¸å…³å‚æ•°ä¾æ—§ä¼šåŠ è½½åˆ°ä¸Šä¸‹æ–‡ä¹‹ä¸­ã€‚ è‡ªå®šä¹‰ç¯å¢ƒå˜é‡éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&#x2F;** * åˆå§‹åŒ–ç¯å¢ƒå˜é‡ *&#x2F;def initializeEnvironment() &#123; this.initBaseEnv().initEnvDependGit().initEnvDependRepo() return this&#125;def initBaseEnv() &#123; &#x2F;&#x2F; SHORT_JOB_NAME this.script.env.SHORT_JOB_NAME &#x3D; this.getShortName() &#x2F;&#x2F; æ˜¯å¦ä»…ä»…æ˜¾ç¤ºstageèŠ‚ç‚¹è€Œä¸æ‰§è¡Œå†…å®¹ this.script.mStageShow &#x3D; false return this&#125;def initEnvDependGit() &#123; &#x2F;&#x2F; COMMIT_ID this.script.env.COMMIT_ID &#x3D; this.git.commitId() &#x2F;&#x2F; COMMIT_AUTHOR this.script.env.COMMIT_AUTHOR &#x3D; this.git.commitAuthor() &#x2F;&#x2F; COMMIT_TIME this.script.env.COMMIT_TIME &#x3D; this.git.commitTime() &#x2F;&#x2F; COMMIT_COMMENT this.script.env.COMMIT_COMMENT &#x3D; this.git.commitMessage() return this&#125;def initEnvDependRepo() &#123; &#x2F;&#x2F; REPO this.script.env.REPO &#x3D; this.repo.getRepo() &#x2F;&#x2F; REPOSITORY this.script.env.REPOSITORY &#x3D; this.repo.getFullRepoString() &#x2F;&#x2F; Notify this.script.env.COMMIT_ID_PATH &#x3D; this.repo.getCommitIdHostPath() &#x2F;&#x2F; REPOSITORY_LINK this.script.env.REPOSITORY_LINK &#x3D; this.repo.getGitLink() &#x2F;&#x2F; REPOSITORY_GROUP this.script.env.REPOSITORY_GROUP &#x3D; this.repo.getGroup() &#x2F;&#x2F; REPOSITORY_GROUP_REPO this.script.env.REPOSITORY_GROUP_REPO &#x3D; this.getRepoGroupRepo() return this&#125; è¿™ä¸ªï¼Œæˆ‘ä»¬æŠŠç¯å¢ƒå˜é‡ä¹Ÿæ‹†åˆ†å°è£…åˆ°å¯¹åº”çš„æ–¹æ³•äº†ï¼Œåˆ†åˆ«æ˜¯gitç›¸å…³çš„ç¯å¢ƒå˜é‡å’Œä»“åº“ä¿¡æ¯çš„ç¯å¢ƒå˜é‡ç­‰ç­‰ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹ ç¬¬äºŒéƒ¨åˆ† çš„ä»£ç ã€‚ 1234567# ç¬¬äºŒéƒ¨åˆ†import com.company.jenkins.LaravelPipelinedef laravelPipeline &#x3D; new LaravelPipeline(this)node &#123; laravelPipeline.preBuild().build().testing().debug().reviews().production().execute()&#125; è¿™é‡Œï¼Œæˆ‘ä»¬importè¿›æ¥äº†Laravelçš„å…·ä½“å®ç°ç®¡é“ï¼Œå¹¶ä¸”å®ä¾‹åŒ–è¿™ä¸ªå¯¹è±¡ï¼Œä¼ å…¥äº†å½“å‰ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚ å¹¶ä¸”åœ¨ä¸‹é¢çš„nodeç»“æ„ä¸­ï¼Œè°ƒç”¨laravelpipelineå¯¹è±¡çš„ç›¸å…³å°è£…æ–¹æ³•ã€‚ ç»è¿‡æˆ‘ä»¬å¯¹éƒ¨ç½²æµç¨‹çš„æŠ½è±¡å’Œç»Ÿä¸€ï¼Œæˆ‘ä»¬çš„éƒ¨ç½²æµç¨‹å¤§è‡´åˆ†ä¸º 5ä¸ªé˜¶æ®µã€‚åˆ†åˆ«å¦‚ä¸‹ï¼š 123456789101112131415161718192021+-----------------------------+| 1. Pre-construction phase |+------------+----------------+ | | +-----------------------+ +------------&gt;+2. Construction phase +------------------+ +-----------------------+ | | | +---------------------v-----------------------------+ +-------+3. Deployment development environment phase (Debug)| | +---------------------------------------------------+ | v +------------+---------------------------------------+ +-------------+4. Grayscale Environment Deployment Stageï¼ˆ reviewsï¼‰ | | +----------------------------------------------------+ |+------------v----------------------------------------------+| 5. Deployment of production environment phaseï¼ˆ produtionï¼‰ |+-----------------------------------------------------------+ é¢„æ„å»ºé˜¶æ®µ æ„å»ºé˜¶æ®µ éƒ¨ç½²å¼€å‘ç¯å¢ƒé˜¶æ®µï¼ˆdebugï¼‰ éƒ¨ç½²ç°åº¦ç¯å¢ƒé˜¶æ®µï¼ˆreviewsï¼‰ éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒé˜¶æ®µï¼ˆproductionï¼‰ å› æ­¤ï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„ä»“åº“jenkinsfileéƒ½æŒ‰ç…§è¿™æ ·å­çš„ä¸æ˜¯æ¥å†™ï¼Œè¿™æ ·å­å°±å¯ä»¥åšåˆ°ï¼Œå½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹éƒ¨ç½²çš„å†…å®¹çš„æ—¶å€™ï¼Œä»£ç ä»“åº“çš„jenkinsfileä¸éœ€è¦åšä»»åŠ¡å˜åŠ¨ï¼Œåªéœ€è¦ä¿®æ”¹æˆ‘ä»¬çš„å…±äº«åº“å³å¯ã€‚ éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132def preBuild() &#123; def callback &#x3D; &#123; this.startNotify() &#125; def apiName &#x3D; &#39;preBuild&#39; this.addCallback(apiName, callback) return this&#125;def build(isParallel &#x3D; true) &#123; def callback &#x3D; &#123; this.script.stage(&#39;Build&#39;) &#123; if (isParallel) &#123; def stages &#x3D; [failFast: true] stages[&quot;Composer Install&quot;] &#x3D; this.composerInstall() stages[&quot;Client Build&quot;] &#x3D; this.clientBuild() this.script.parallel stages &#125; else &#123; this.composerInstall()() this.clientBuild()() &#125; &#125; &#125; def apiName &#x3D; &#39;build&#39; this.addCallback(apiName, callback) return this&#125; è¿™é‡Œçœ‹åˆ°ï¼Œæˆ‘ä»¬å‡ ä¹æ‰€æœ‰çš„ä»£ç éƒ½ä¼šé€šè¿‡å›è°ƒå‡½æ•°æ¥ç¼–å†™çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å®é™…è°ƒç”¨çš„æ—¶å€™ï¼Œå¿…é¡»åŠ ä¸Š execute() æ–¹æ³•æ¥å®é™…è§¦å‘é“¾å¼è¿‡ç¨‹ã€‚ å› ä¸ºåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­ï¼Œlaravelæ˜¯phpçš„é¡¹ç›®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯æœ‰å‰ç«¯å’Œåç«¯çš„ä»£ç ã€‚åˆ†åˆ«æ˜¯composerä¾èµ–ï¼Œnpmä¾èµ–ã€‚ ç”±äºè¿™2ä¸ªéƒ¨åˆ†çš„ä¾èµ–ï¼Œä»–ä»¬æ˜¯æ²¡æœ‰ç›¸å…³æ€§çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡ä¸Šï¼Œé»˜è®¤æ˜¯æ”¯æŒ å¹¶å‘ æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè°ƒç”¨äº†jenkinsçš„ä¸€ä¸ªå†…ç½®å‡½æ•° parallelæ¥å®ç°å¹¶å‘ã€‚å®é™…æ•ˆæœå¦‚ä¸‹å±•ç¤ºï¼š 12345678910111213141516 +-----------------------+ | +------------------+ | | | Composer Install | | | +------------------+ | | | | |+----------------+ | || pre-build +-------&gt;+ build |+----------------+ | | | | | | | +------------------+ | | | Client Build | | | +------------------+ | | | +-----------------------+ ä»¥npmä¾èµ–å®‰è£…ä¸ºä¾‹å­ï¼š 1234567891011121314public npmInstall(def packageFile &#x3D; &#39;client&#x2F;package.json&#39;, def clientDir &#x3D; &#39;client&#39;, def version &#x3D; &#39;latest&#39;) &#123; def md5File &#x3D; &quot;$&#123;packageFile&#125;.md5&quot; def callback &#x3D; &#123; isChange -&gt; this.script.echo &quot;package.jsonæ˜¯å¦æœ‰å˜åŒ–:$&#123;isChange&#125;&quot; this.script.echo &quot;æ˜¯å¦å¼ºåˆ¶ç¼–è¯‘å‰ç«¯èµ„æº:$&#123;this.script.params.isBuild&#125;&quot; if (isChange || this.script.params.isBuild) &#123; this.script.docker.image(&quot;jenkins_docker_node:$&#123;version&#125;&quot;).inside(&#39;--dns-opt&#x3D;ndots:5 -v $HOME&#x2F;.npm:&#x2F;root&#x2F;.npm&#39;) &#123; ... &#125; &#125; &#125; this.checkChangeFile(packageFile, md5File, callback)&#125; å¦å¤–åœ¨composerå’Œnpmä¾èµ–å®‰è£…çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åšäº†ä¸€äº›ç»†èŠ‚ä¸Šçš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¼šæ£€æµ‹package.jsonä»¥åŠcomposer.jsonï¼Œå¦‚æœè¿™2ä¸ªæ–‡ä»¶æ²¡æœ‰å˜åŒ–çš„è¯ï¼Œåˆ™ä¸ä¼šæ›´æ–°ä¾èµ–ã€‚é¿å…äº†æ¯æ¬¡æ„å»ºéƒ½éœ€è¦å»æ£€æŸ¥æ›´æ–°ä¾èµ–åŒ…ã€‚å¦å¤–ç”±äºæˆ‘ä»¬çš„jenkisnç¯å¢ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªjenkinsçš„dockerå®¹å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„jenkinsç¯å¢ƒä¸‹æ˜¯ä¸ä¼šå­˜åœ¨phpä»¥åŠnodeçš„ç¯å¢ƒï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™ä¸ªæ—¶å€™ï¼Œåœ¨å®‰è£…ä¾èµ–çš„æ—¶å€™ï¼Œå€ŸåŠ©äº†ä¸Šä¸‹æ–‡ä¸­çš„ docker.image å…³é”®å­—æ¥æ„å»ºä¸€ä¸ªå®¹å™¨æ¥è§¦å‘æˆ‘ä»¬çš„ä¾èµ–å®‰è£…ã€‚ æ¥ä¸‹æ¥å°±æ˜¯éƒ¨ç½²ç›¸å…³çš„å†…å®¹äº†ï¼Œæˆ‘ä»¬ä»¥éƒ¨ç½² production ç¯å¢ƒæ¥ä¸¾ä¾‹å­ 12345678910111213141516171819202122def production(def map &#x3D; [ sshId : null, deployClass: null]) &#123; def callback &#x3D; &#123; if (map[&#39;sshId&#39;] &#x3D;&#x3D; null) &#123; map[&#39;sshId&#39;] &#x3D; this.getValue(&#39;deploySshId&#39;) &#125; if (map[&#39;deployClass&#39;] &#x3D;&#x3D; null) &#123; map[&#39;deployClass&#39;] &#x3D; this.getDeployClass() &#125; map[&#39;pipeline&#39;] &#x3D; this this.deploy.production(map) &#125; def apiName &#x3D; &#39;production&#39; this.addCallback(apiName, callback) return this&#125; å¦‚æœä¸æŒ‡å®š sshId å’Œ deployClass çš„è¯ï¼Œéƒ½ä¼šå­˜åœ¨é»˜è®¤å€¼ã€‚ç”±äºæˆ‘ä»¬æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯é€šè¿‡å›è°ƒçš„æ–¹å¼è°ƒç”¨çš„ï¼ˆå…¶å®ç±»ä¼¼äºä¸­é—´ä»¶ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œçš„å¤šäº†ä¸€ä¸ª map[pipeline] = this çš„ä»£ç ï¼Œæ„ä¹‰åœ¨äºæŠŠå½“å‰ä¸Šä¸‹æ–‡ä¼ é€’è¿›å…·ä½“çš„éƒ¨ç½²ç±»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134def production(def map &#x3D; [ sshId : null, deployClass: null, pipeline : null]) &#123; def keyword &#x3D; &#39;production&#39; this.script.stage(&#39;Production Deploy&#39;) &#123; if (this.git.isMasterBranch() &amp;&amp; this.script.currentResources[keyword].enabled !&#x3D; false) &#123; &#x2F;&#x2F; æ³¨å…¥å‚æ•° def tags &#x3D; this.git.tagsList() def buildParameters &#x3D; [ [ &#39;$class&#39; : &#39;ChoiceParameter&#39;, choiceType : &#39;PT_SINGLE_SELECT&#39;, description : &#39;&#39;&#39;é€‰æ‹©æ„å»ºç±»å‹ï¼šauto_deploy - è‡ªåŠ¨å‘å¸ƒï¼ˆç›´æ¥å‘å¸ƒæœ€æ–°ä»£ç ï¼‰ deploy - æŒ‡å®šç‰ˆæœ¬å‘å¸ƒrollback - ç‰ˆæœ¬å›æ»šå‘å¸ƒ&#39;&#39;&#39;, filterLength: 1, filterable : false, name : &#39;buildType&#39;, randomName : &#39;choice-parameter-69483043309720&#39;, script : [ &#39;$class&#39; : &#39;GroovyScript&#39;, fallbackScript: [ classpath: [], sandbox : true, script : &#39;return[&quot;unknow&quot;]&#39; ], script : [ classpath: [], sandbox : true, script : &#39;return[&quot;auto_deploy&quot;, &quot;deploy&quot;, &quot;rollback&quot;]&#39;, ] ] ], [ &#39;$class&#39; : &#39;ChoiceParameter&#39;, choiceType : &#39;PT_SINGLE_SELECT&#39;, description : &#39;&#39;&#39;é€‰æ‹©Tagæ ‡ç­¾ï¼šauto_deployæ—¶è¯¥å‚æ•°æ— æ•ˆ&#39;&#39;&#39;, filterLength: 20, filterable : true, name : &#39;buildTag&#39;, randomName : &#39;choice-parameter-69483043309721&#39;, script : [ &#39;$class&#39; : &#39;GroovyScript&#39;, fallbackScript: [ classpath: [], sandbox : true, script : &#39;return[&quot;unknow&quot;]&#39; ], script : [ classpath: [], sandbox : true, script : &quot;return [$&#123;tags&#125;]&quot;, ] ] ] ] if (!this.script.mStageShow) &#123; this.script.notify &#39;è¯·ç¡®è®¤æ˜¯å¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ&#39; this.script.timeout(time: 10, unit: &#39;MINUTES&#39;) &#123; try &#123; this.script.input &#39;è¯·ç¡®è®¤æ˜¯å¦è¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ&#39; &#125; catch (e) &#123; map[&#39;pipeline&#39;].parameters +&#x3D; buildParameters throw e &#125; def updateHistoryFile &#x3D; &#39;UPDATE_HISTORY&#39; def currentTag if (this.script.params.buildType &#x3D;&#x3D; &#39;deploy&#39; || this.script.params.buildType &#x3D;&#x3D; &#39;rollback&#39;) &#123; &#x2F;&#x2F; å‘å¸ƒæŒ‡å®štag this.script.sh &quot;git checkout $&#123;this.script.params.buildTag&#125;&quot; this.script.currentBuild.description &#x3D; &quot;ã€æŒ‡å®šå‘å¸ƒã€‘Tag: $&#123;this.script.params.buildTag&#125;&quot; if (this.script.params.buildType &#x3D;&#x3D; &#39;rollback&#39;) &#123; this.script.currentBuild.description &#x3D; &quot;ã€å›æ»šã€‘Tag: $&#123;this.script.params.buildTag&#125;&quot; &#125; currentTag &#x3D; this.script.params.buildTag &#125; else &#123; &#x2F;&#x2F; å¼€å§‹æ‰“tag ... try &#123; def tagRes if (link.startsWith(&quot;http&quot;)) &#123; &#x2F;&#x2F; gitbucket ... &#125; &#125; else &#123; &#x2F;&#x2F; gitlab ... &#125; if (tagRes[&#39;exitCode&#39;] &gt; 0 &amp;&amp; !tagRes[&#39;stdout&#39;].contains(&#39;already exists&#39;)) &#123; throw new Exception(tagRes[&#39;stdout&#39;]) &#125; &#125; catch (e) &#123; throw e &#125; this.script.sh &quot;tee $&#123;preCommitIdFile&#125; &lt;&lt;&lt; $&#123;this.git.commitId()&#125;&quot; currentTag &#x3D; nextTag &#x2F;&#x2F; æœ€æ–°tagåŠ å…¥ä¸‹æ‹‰æ¡† buildParameters[1][&#39;script&#39;][&#39;script&#39;][&#39;script&#39;] &#x3D; &quot;return [\\&quot;$&#123;currentTag&#125;\\&quot;,$&#123;tags&#125;]&quot; &#125; &#125; ... this.script.currentBuild.description &#x3D; &quot;ã€è‡ªåŠ¨å‘å¸ƒã€‘Tag: $&#123;currentTag&#125;&quot; this.publishDeployment(keyword)(map[&#39;sshId&#39;], map[&#39;deployClass&#39;]) ... &#125; &#125; else &#123; this.script.echo &#39;Production Deploy Show&#39; &#125; map[&#39;pipeline&#39;].parameters +&#x3D; buildParameters &#125; else &#123; Utils.markStageSkippedForConditional(this.script.env.STAGE_NAME) &#125; &#125; return this&#125; è¿™é‡Œï¼Œæˆ‘ä»¬å†è¯´æ˜ä¸€ä¸‹æˆ‘ä»¬çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚ æäº¤featureä»£ç  åˆå¹¶åˆ°pre-developåˆ†æ”¯ï¼Œè§¦å‘jenkinsä»»åŠ¡æ„å»ºæ›´æ–°debugç¯å¢ƒä»£ç  æœ€ç»ˆåˆå¹¶åˆ°masteråˆ†æ”¯ï¼Œè§¦å‘jenkinsä»»åŠ¡ï¼Œå¦‚æœä»£ç æœ‰å˜åŒ–åˆ™å¯¹æœ€æ–°çš„masterä»£ç è¿›è¡Œæ‰“tagï¼Œæ„å»ºæ›´æ–°productionç¯å¢ƒä»£ç  åŸºäºä»¥ä¸Šå‡ ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°éƒ¨ç½²productionç±»çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ£€æµ‹masterçš„ä»£ç ï¼Œå¦‚æœå­˜åœ¨å˜åŒ–åˆ™è¿›è¡Œæ‰“tagã€‚ç„¶åå†è°ƒç”¨å…·ä½“çš„éƒ¨ç½²é€»è¾‘ã€‚å…¶ä¸­ this.script.currentResources[keyword].enabled æ˜¯æ¥è‡ªäºæˆ‘ä»¬çš„ resource-libaray çš„é…ç½®ã€‚ 1234567891011121314151617abstract class AbstractDeployment &#123; &#x2F;** * æ‰“åŒ…é€»è¾‘ * @return *&#x2F; abstract def parallelBefore(def packFiles, def packExclude) &#x2F;** * å¹¶è¡Œé€»è¾‘ * @param ip * @param port * @param directory * @return *&#x2F; abstract def parallel(def ip, def port, def directory, def backupExclude)&#125; æˆ‘ä»¬çš„æŠ½è±¡å…·ä½“éƒ¨ç½²ç±»å­˜åœ¨2ä¸ªå¿…é¡»å®ç°çš„æŠ½è±¡æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ parallelBefore, parallelã€‚ parallelBeforeï¼šå¹¶å‘éƒ¨ç½²å‰åšçš„äº‹æƒ… parallelï¼šå¹¶å‘éƒ¨ç½²åˆ°å¤šå°ç›®æ ‡æœºå™¨ä¸Š resources-librariesèµ„æºå…±äº«åº“ å¯¹å¤–æä¾›ä¸€ä¸ªå…¨å±€çš„å‡½æ•° mresource_loadï¼Œå†…éƒ¨æä¾›ç»™ä¸Šä¸‹æ–‡å…³é”®å­—æ‹¿åˆ°å½“å‰é¡¹ç›®ï¼Œå½“å‰ç¯å¢ƒçš„å¯¹åº”çš„éƒ¨ç½²å†…å®¹ä¿¡æ¯ã€‚ 12345678910111213141516171819â”œâ”€â”€ README.MDâ”œâ”€â”€ resourcesâ”‚ â”œâ”€â”€ git.xxxx.comâ”‚ â”‚ â”œâ”€â”€ repo-group1â”‚ â”‚ â”‚ â”œâ”€â”€ a.yamlâ”‚ â”‚ â”‚ â””â”€â”€ b.yamlâ”‚ â”‚ â””â”€â”€ repo-group2â”‚ â”‚ â””â”€â”€ c.yamlâ”‚ â””â”€â”€ gitlab.xxx.comâ”‚ â”œâ”€â”€ repo-group3â”‚ â”‚ â”œâ”€â”€ d.yamlâ”‚ â”‚ â””â”€â”€ e.yamlâ”‚ â””â”€â”€ repo-group4â”‚ â”œâ”€â”€ f.yamlâ”‚ â””â”€â”€ g.yamlâ”œâ”€â”€ testsâ”‚ â””â”€â”€ test_mresource_load.groovyâ””â”€â”€ vars â””â”€â”€ mresource_load.groovy æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„åŸºæœ¬ç»“æ„å’Œä¸Šä¸€ä¸ª jenkins-shard-libraries ååˆ†çš„ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äº resources-libraries ä¸å­˜åœ¨ src ç›®å½•ï¼Œä½†æ˜¯ resources å…¨éƒ¨éƒ½å­˜åœ¨èµ„æºé…ç½®ã€‚ èµ„æºå­˜æ”¾çš„ç›®å½•ï¼Œç»“æ„ç›®å½•è§„åˆ™ä¸º &lt;FQDN&gt;/&lt;group&gt;/&lt;repo&gt;ï¼Œå¯¹åº”gitä»“åº“ã€‚ èµ„æºåº“é‡‡ç”¨yamlæ ¼å¼ã€‚ç›®å‰æ”¯æŒçš„keyæœ‰ï¼š type(normal|job_name) normal å¸¸è§„é¡¹ç›®ï¼Œä¸åŒºåˆ†é¡¹ç›® job_name åŒºåˆ†é¡¹ç›®ï¼Œä¸€å¥—ä»“åº“ï¼Œå¤šä¸ªé¡¹ç›®åŒºåˆ†éƒ¨ç½² debug å†…æµ‹ç¯å¢ƒ address ip:port directory ä»£ç ç›®å½•è·¯å¾„ deploy_ssh_id éƒ¨ç½²çš„å‡­è¯ execute_user æ‰§è¡Œçš„ç”¨æˆ·ï¼Œç›®å‰ä»…ä»…åœ¨GolangPiplineæœ‰æ•ˆ ssh_username éƒ¨ç½²ä»£ç çš„sshçš„è´¦å·ï¼Œç›®å‰åœ¨GolangPiplineä»…è°ƒè¯•ç”¨ reviews ç°åº¦ç¯å¢ƒ enabled: false è·³è¿‡reviewsæ­¥éª¤ address ip:port directory ä»£ç ç›®å½•è·¯å¾„ deploy_ssh_id éƒ¨ç½²çš„å‡­è¯ execute_user æ‰§è¡Œçš„ç”¨æˆ·ï¼Œç›®å‰ä»…ä»…åœ¨GolangPiplineæœ‰æ•ˆ ssh_username éƒ¨ç½²ä»£ç çš„sshçš„è´¦å·ï¼Œç›®å‰åœ¨GolangPiplineä»…è°ƒè¯•ç”¨ã€éå¿…å¡«ï¼Œé»˜è®¤é‡‡ç”¨deploy_ssh_idçš„ä¿¡æ¯ã€‘ production ç”Ÿäº§ç¯å¢ƒ address ip:port directory ä»£ç ç›®å½•è·¯å¾„ deploy_ssh_id éƒ¨ç½²çš„å‡­è¯ branch ç”Ÿäº§ç¯å¢ƒå¯¹åº”çš„åˆ†æ”¯ ã€éå¿…å¡«ã€‘ execute_user æ‰§è¡Œçš„ç”¨æˆ·ï¼Œç›®å‰ä»…ä»…åœ¨GolangPiplineæœ‰æ•ˆã€éå¿…å¡«ã€‘ ssh_username éƒ¨ç½²ä»£ç çš„sshçš„è´¦å·ï¼Œç›®å‰åœ¨GolangPiplineä»…è°ƒè¯•ç”¨ã€éå¿…å¡«ï¼Œé»˜è®¤é‡‡ç”¨deploy_ssh_idçš„ä¿¡æ¯ã€‘ é™„åŠ åœ¨ä¸Šä¸‹æ–‡çš„å˜é‡ï¼š script.currentResources script.gitCredentialsId script.buildCredentialsId å…·ä½“çš„yamlé…ç½®æ ¼å¼çš„demo 1234567891011121314151617181920212223242526type: &#39;normal&#39;git_credentials_id: &#39;git_credentials_id&#39;common: &amp;common deploy_ssh_id: &#39;deploy_ssh_id&#39;environment: debug: &lt;&lt;: *common address: - &#39;2.2.2.2:22&#39; - &#39;1.1.1.1:22&#39; directory: &#39;2.2.2.2:22&#39;: &#39;&#x2F;a&#39; &#39;1.1.1.1:22&#39;: &#39;&#x2F;b&#39; reviews: &lt;&lt;: *common address: &#39;3.3.3.3:22&#39; directory: &#39;&#x2F;c&#39; production: &lt;&lt;: *common address: &#39;4.4.4.4:22&#39; directory: &#39;&#x2F;d&#39; è¿™æ˜¯åŸºæœ¬çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å€ŸåŠ©äº†yamlçš„çµæ´»æ€§ï¼Œé…ç½®å‡ºå°½å¯èƒ½ç®€æ´ï¼Œå¯å¤ç”¨çš„é¡¹ã€‚æˆ‘ä»¬è¿˜æœ‰æ›´åŠ çµæ´»çš„é…ç½®å’Œæ ¼å¼ï¼Œå…·ä½“å‚è€ƒä»¥ä¸‹ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128@Grab(&#39;org.yaml:snakeyaml:1.26&#39;)import org.yaml.snakeyaml.*def call(def config &#x3D; [script: null, groupRepo: null, shortJobName: null, host: null]) &#123; def script &#x3D; config.script def groupRepo &#x3D; config.groupRepo def shortJobName &#x3D; config.shortJobName def host &#x3D; config.host if (groupRepo &#x3D;&#x3D; null) &#123; groupRepo &#x3D; script.env.REPOSITORY_GROUP_REPO &#125; if (shortJobName &#x3D;&#x3D; null) &#123; shortJobName &#x3D; script.env.SHORT_JOB_NAME &#125; if (host &#x3D;&#x3D; null) &#123; host &#x3D; &quot;git.xxxx.com&quot; &#125; configFile &#x3D; host + &#39;&#x2F;&#39; + groupRepo + &#39;.yaml&#39; Yaml yaml &#x3D; new Yaml() String resourceString &#x3D; libraryResource(configFile) Map&lt;String, Object&gt; obj &#x3D; yaml.load(resourceString) obj.type &#x3D; obj.type ?: null def resource &#x3D; [:] def git_credentials_id &#x3D; &#39;&#39; def build_credentials_id &#x3D; &#39;&#39; if (obj.type &#x3D;&#x3D; &#39;job_name&#39;) &#123; String pointJobName &#x3D; shortJobName for (item in obj) &#123; if (item.key &#x3D;&#x3D; pointJobName) &#123; def value &#x3D; item.value for (it1 in value) &#123; if (it1.key &#x3D;&#x3D; &#39;git_credentials_id&#39;) &#123; git_credentials_id &#x3D; it1.value continue &#125; if (it1.key &#x3D;&#x3D; &#39;build_credentials_id&#39;) &#123; build_credentials_id &#x3D; it1.value continue &#125; if (it1.key &#x3D;&#x3D; &#39;environment&#39;) &#123; &#x2F;&#x2F; å…¼å®¹ addressï¼ŒString &amp;&amp; List for (it in it1.value) &#123; for (values in it.value) &#123; if (values instanceof Map.Entry) &#123; if (values.key &#x3D;&#x3D; &#39;address&#39;) &#123; if (values.value instanceof String) &#123; values.value &#x3D; [values.value] &#125; &#125; &#125; &#125; &#125; &#125; if (it1.key &#x3D;&#x3D; &#39;environment&#39;) &#123; &#x2F;&#x2F; å…¼å®¹ directory for (it in it1.value) &#123; for (values in it.value) &#123; if (values instanceof Map.Entry) &#123; if (values.key &#x3D;&#x3D; &#39;directory&#39;) &#123; if (values.value instanceof String) &#123; def dir &#x3D; values.value values.value &#x3D; [:] for (def addr in it.value.address) &#123; values.value[addr] &#x3D; dir &#125; &#125; &#125; &#125; &#125; &#125; &#125; &#125; resource &#x3D; value break &#125; &#125; &#125; else &#123; &#x2F;&#x2F; job.type &#x3D;&#x3D; normal resource &#x3D; obj resource.remove(&#39;type&#39;) &#x2F;&#x2F; å…¼å®¹ addressï¼ŒString &amp;&amp; List for (item in resource.environment) &#123; for (values in item.value) &#123; if (values instanceof Map.Entry) &#123; if (values.key &#x3D;&#x3D; &#39;address&#39;) &#123; if (values.value instanceof String) &#123; values.value &#x3D; [values.value] &#125; &#125; &#125; &#125; &#125; &#x2F;&#x2F; å…¼å®¹ directory for (item in resource.environment) &#123; for (values in item.value) &#123; if (values instanceof Map.Entry) &#123; if (values.key &#x3D;&#x3D; &#39;directory&#39;) &#123; if (values.value instanceof String) &#123; def dir &#x3D; values.value values.value &#x3D; [:] for (def addr in item.value.address) &#123; values.value[addr] &#x3D; dir &#125; &#125; &#125; &#125; &#125; &#125; git_credentials_id &#x3D; resource.git_credentials_id build_credentials_id &#x3D; resource.build_credentials_id &#125; def environment &#x3D; resource.environment script.currentResources &#x3D; environment ?: [:] script.gitCredentialsId &#x3D; git_credentials_id ?: null script.buildCredentialsId &#x3D; build_credentials_id ?: null&#125; ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬çš„jenkinså¯¹å…±äº«åº“åº”ç”¨åœºæ™¯äº†ï¼Œåç»­ä¹Ÿä¼šéšç€æœåŠ¡å™¨å¯¹æ¶æ„è€Œå‡çº§ä¼˜åŒ–æ”¹å˜ã€‚","categories":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/categories/DevOps/"}],"tags":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/tags/DevOps/"},{"name":"Jenkins","slug":"Jenkins","permalink":"http://blog.crazylaw.cn/tags/Jenkins/"}]},{"title":"ã€kubernetesã€‘pauseå®¹å™¨","slug":"k8s/pauseå®¹å™¨","date":"2020-08-25T14:53:30.000Z","updated":"2021-03-20T16:25:01.807Z","comments":true,"path":"2020/08/25/k8s/pauseå®¹å™¨/","link":"","permalink":"http://blog.crazylaw.cn/2020/08/25/k8s/pause%E5%AE%B9%E5%99%A8/","excerpt":"å‰è¨€k8sä¸­æœ‰ initå®¹å™¨çš„æ¦‚å¿µï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯pauseå®¹å™¨ï¼Œpauseå®¹å™¨æ˜¯ä¸€ä¸ªååˆ†é‡è¦çš„æ¦‚å¿µï¼Œè´¯ç©¿æ•´ä¸ªPodçš„é€šä¿¡ã€‚","text":"å‰è¨€k8sä¸­æœ‰ initå®¹å™¨çš„æ¦‚å¿µï¼Œå…¶ä¸­ä¸€ä¸ªå°±æ˜¯pauseå®¹å™¨ï¼Œpauseå®¹å™¨æ˜¯ä¸€ä¸ªååˆ†é‡è¦çš„æ¦‚å¿µï¼Œè´¯ç©¿æ•´ä¸ªPodçš„é€šä¿¡ã€‚ Pauseå®¹å™¨Pauseå®¹å™¨ï¼Œåˆå«Infraå®¹å™¨ï¼Œæœ¬æ–‡å°†æ¢ç©¶è¯¥å®¹å™¨çš„ä½œç”¨ä¸åŸç†ã€‚ æˆ‘ä»¬çŸ¥é“åœ¨kubeletçš„é…ç½®ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼š 1KUBELET_POD_INFRA_CONTAINER=--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest ä¸Šé¢æ˜¯openshiftä¸­çš„é…ç½®å‚æ•°ï¼Œkubernetesä¸­é»˜è®¤çš„é…ç½®å‚æ•°æ˜¯ï¼š 1KUBELET_POD_INFRA_CONTAINER=--pod-infra-container-image=gcr.io/google_containers/pause-amd64:3.0 Pauseå®¹å™¨ï¼Œæ˜¯å¯ä»¥è‡ªå·±æ¥å®šä¹‰ï¼Œå®˜æ–¹ä½¿ç”¨çš„gcr.io/google_containers/pause-amd64:3.0å®¹å™¨çš„ä»£ç è§Githubï¼Œä½¿ç”¨Cè¯­è¨€ç¼–å†™ã€‚ Pauseå®¹å™¨ç‰¹ç‚¹ é•œåƒéå¸¸å°ï¼Œç›®å‰åœ¨700KBå·¦å³ æ°¸è¿œå¤„äºPause(æš‚åœ)çŠ¶æ€ Pauseå®¹å™¨èƒŒæ™¯åƒ Pod è¿™æ ·ä¸€ä¸ªä¸œè¥¿ï¼Œæœ¬èº«æ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µã€‚é‚£åœ¨æœºå™¨ä¸Šï¼Œå®ƒç©¶ç«Ÿæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬è¦è§£é‡Šçš„ä¸€ä¸ªé—®é¢˜ã€‚ æ—¢ç„¶è¯´ Pod è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ ¸å¿ƒå°±åœ¨äºå¦‚ä½•è®©ä¸€ä¸ª Pod é‡Œçš„å¤šä¸ªå®¹å™¨ä¹‹é—´æœ€é«˜æ•ˆçš„å…±äº«æŸäº›èµ„æºå’Œæ•°æ®ã€‚ å› ä¸ºå®¹å™¨ä¹‹é—´åŸæœ¬æ˜¯è¢« Linux Namespace å’Œ cgroups éš”å¼€çš„ï¼Œæ‰€ä»¥ç°åœ¨å®é™…è¦è§£å†³çš„æ˜¯æ€ä¹ˆå»æ‰“ç ´è¿™ä¸ªéš”ç¦»ï¼Œç„¶åå…±äº«æŸäº›äº‹æƒ…å’ŒæŸäº›ä¿¡æ¯ã€‚è¿™å°±æ˜¯ Pod çš„è®¾è®¡è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ‰€åœ¨ã€‚ æ‰€ä»¥è¯´å…·ä½“çš„è§£æ³•åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šç½‘ç»œå’Œå­˜å‚¨ã€‚ Pauseå®¹å™¨å°±æ˜¯ä¸ºè§£å†³Podä¸­çš„ç½‘ç»œé—®é¢˜è€Œç”Ÿçš„ã€‚ Pauseå®¹å™¨å®ç°Pod é‡Œçš„å¤šä¸ªå®¹å™¨æ€ä¹ˆå»å…±äº«ç½‘ç»œï¼Ÿä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼š æ¯”å¦‚è¯´ç°åœ¨æœ‰ä¸€ä¸ª Podï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªå®¹å™¨ A å’Œä¸€ä¸ªå®¹å™¨ Bï¼Œå®ƒä»¬ä¸¤ä¸ªå°±è¦å…±äº« Network Namespaceã€‚åœ¨ Kubernetes é‡Œçš„è§£æ³•æ˜¯è¿™æ ·çš„ï¼šå®ƒä¼šåœ¨æ¯ä¸ª Pod é‡Œï¼Œé¢å¤–èµ·ä¸€ä¸ª Infra container å°å®¹å™¨æ¥å…±äº«æ•´ä¸ª Pod çš„ Network Namespaceã€‚ Infra container æ˜¯ä¸€ä¸ªéå¸¸å°çš„é•œåƒï¼Œå¤§æ¦‚ 700KB å·¦å³ï¼Œæ˜¯ä¸€ä¸ªCè¯­è¨€å†™çš„ã€æ°¸è¿œå¤„äºâ€œæš‚åœâ€çŠ¶æ€çš„å®¹å™¨ã€‚ç”±äºæœ‰äº†è¿™æ ·ä¸€ä¸ª Infra container ä¹‹åï¼Œå…¶ä»–æ‰€æœ‰å®¹å™¨éƒ½ä¼šé€šè¿‡ Join Namespace çš„æ–¹å¼åŠ å…¥åˆ° Infra container çš„ Network Namespace ä¸­ã€‚ æ‰€ä»¥è¯´ä¸€ä¸ª Pod é‡Œé¢çš„æ‰€æœ‰å®¹å™¨ï¼Œå®ƒä»¬çœ‹åˆ°çš„ç½‘ç»œè§†å›¾æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚å³ï¼šå®ƒä»¬çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡ã€IPåœ°å€ã€Macåœ°å€ç­‰ç­‰ï¼Œè·Ÿç½‘ç»œç›¸å…³çš„ä¿¡æ¯ï¼Œå…¶å®å…¨æ˜¯ä¸€ä»½ï¼Œè¿™ä¸€ä»½éƒ½æ¥è‡ªäº Pod ç¬¬ä¸€æ¬¡åˆ›å»ºçš„è¿™ä¸ª Infra containerã€‚è¿™å°±æ˜¯ Pod è§£å†³ç½‘ç»œå…±äº«çš„ä¸€ä¸ªè§£æ³•ã€‚ åœ¨ Pod é‡Œé¢ï¼Œä¸€å®šæœ‰ä¸€ä¸ª IP åœ°å€ï¼Œæ˜¯è¿™ä¸ª Pod çš„ Network Namespace å¯¹åº”çš„åœ°å€ï¼Œä¹Ÿæ˜¯è¿™ä¸ª Infra container çš„ IP åœ°å€ã€‚æ‰€ä»¥å¤§å®¶çœ‹åˆ°çš„éƒ½æ˜¯ä¸€ä»½ï¼Œè€Œå…¶ä»–æ‰€æœ‰ç½‘ç»œèµ„æºï¼Œéƒ½æ˜¯ä¸€ä¸ª Pod ä¸€ä»½ï¼Œå¹¶ä¸”è¢« Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº«ã€‚è¿™å°±æ˜¯ Pod çš„ç½‘ç»œå®ç°æ–¹å¼ã€‚ ç”±äºéœ€è¦æœ‰ä¸€ä¸ªç›¸å½“äºè¯´ä¸­é—´çš„å®¹å™¨å­˜åœ¨ï¼Œæ‰€ä»¥æ•´ä¸ª Pod é‡Œé¢ï¼Œå¿…ç„¶æ˜¯ Infra container ç¬¬ä¸€ä¸ªå¯åŠ¨ã€‚å¹¶ä¸”æ•´ä¸ª Pod çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç­‰åŒäº Infra container çš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œä¸å®¹å™¨ A å’Œ B æ˜¯æ— å…³çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨ Kubernetes é‡Œé¢ï¼Œå®ƒæ˜¯å…è®¸å»å•ç‹¬æ›´æ–° Pod é‡Œçš„æŸä¸€ä¸ªé•œåƒçš„ï¼Œå³ï¼šåšè¿™ä¸ªæ“ä½œï¼Œæ•´ä¸ª Pod ä¸ä¼šé‡å»ºï¼Œä¹Ÿä¸ä¼šé‡å¯ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªè®¾è®¡ã€‚ Pauseå®¹å™¨çš„ä½œç”¨æˆ‘ä»¬æ£€æŸ¥nodeèŠ‚ç‚¹çš„æ—¶å€™ä¼šå‘ç°æ¯ä¸ªnodeä¸Šéƒ½è¿è¡Œäº†å¾ˆå¤šçš„pauseå®¹å™¨ï¼Œä¾‹å¦‚å¦‚ä¸‹ã€‚ 1234567$ docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES2c7d50f1a7be docker.io/jimmysong/heapster-grafana-amd64@sha256:d663759b3de86cf62e64a43b021f133c383e8f7b0dc2bdd78115bc95db371c9a \"/run.sh\" 3 hours ago Up 3 hours k8s_grafana_monitoring-influxdb-grafana-v4-5697c6b59-76zqs_kube-system_5788a3c5-29c0-11e8-9e88-525400005732_05df93dea877a docker.io/jimmysong/heapster-influxdb-amd64@sha256:a217008b68cb49e8f038c4eeb6029261f02adca81d8eae8c5c01d030361274b8 \"influxd --config ...\" 3 hours ago Up 3 hours k8s_influxdb_monitoring-influxdb-grafana-v4-5697c6b59-76zqs_kube-system_5788a3c5-29c0-11e8-9e88-525400005732_09cec6c0ef583 jimmysong/pause-amd64:3.0 \"/pause\" 3 hours ago Up 3 hours k8s_POD_monitoring-influxdb-grafana-v4-5697c6b59-76zqs_kube-system_5788a3c5-29c0-11e8-9e88-525400005732_054d06e30a4c7 docker.io/jimmysong/kubernetes-dashboard-amd64@sha256:668710d034c4209f8fa9a342db6d8be72b6cb5f1f3f696cee2379b8512330be4 \"/dashboard --inse...\" 3 hours ago Up 3 hours k8s_kubernetes-dashboard_kubernetes-dashboard-65486f5fdf-lshl7_kube-system_27c414a1-29c0-11e8-9e88-525400005732_05a5ef33b0d58 jimmysong/pause-amd64:3.0 \"/pause\" 3 hours ago Up 3 hours k8s_POD_kubernetes-dashboard-65486f5fdf-lshl7_kube-system_27c414a1-29c0-11e8-9e88-525400005732_0 kubernetesä¸­çš„pauseå®¹å™¨ä¸»è¦ä¸ºæ¯ä¸ªä¸šåŠ¡å®¹å™¨æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š åœ¨podä¸­æ‹…ä»»Linuxå‘½åç©ºé—´å…±äº«çš„åŸºç¡€ï¼› å¯ç”¨pidå‘½åç©ºé—´ï¼Œå¼€å¯initè¿›ç¨‹ã€‚ åœ¨The Almighty Pause Containerè¿™ç¯‡æ–‡ç« ä¸­åšå‡ºäº†è¯¦ç»†çš„è¯´æ˜ï¼Œpauseå®¹å™¨çš„ä½œç”¨å¯ä»¥ä»è¿™ä¸ªä¾‹å­ä¸­çœ‹å‡ºï¼Œé¦–å…ˆè§ä¸‹å›¾ï¼š æˆ‘ä»¬é¦–å…ˆåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªpauseå®¹å™¨ã€‚ 1docker run -d --name pause -p 8880:80 jimmysong/pause-amd64:3.0 ç„¶åå†è¿è¡Œä¸€ä¸ªnginxå®¹å™¨ï¼Œnginxå°†ä¸ºlocalhost:2368åˆ›å»ºä¸€ä¸ªä»£ç†ã€‚ 123456789101112131415$ cat &lt;&lt;EOF &gt;&gt; nginx.conferror_log stderr;events &#123; worker_connections 1024; &#125;http &#123; access_log /dev/stdout combined; server &#123; listen 80 default_server; server_name example.com www.example.com; location / &#123; proxy_pass http://127.0.0.1:2368; &#125; &#125;&#125;EOF$ docker run -d --name nginx -v `pwd`/nginx.conf:/etc/nginx/nginx.conf --net=container:pause --ipc=container:pause --pid=container:pause nginx çªç„¶é—´å‘ç°æŠ¥é”™ï¼š docker: Error response from daemon: can&#39;t join IPC of container 90208aca191fd04e86276bf29a1b1ff742f3d04c0c8c01f6cc61c3283909725b: non-shareable IPC (hint: use IpcMode:shareable for the donor container). å› ä¸ºå½“å‰dockerå®¹å™¨é»˜è®¤çš„&quot;default-ipc-mode&quot;: &quot;host&quot;ï¼Œæˆ‘ä»¬éœ€è¦åˆ‡æ¢åˆ°&quot;default-ipc-mode&quot;: &quot;shareable&quot;, linuxç¯å¢ƒä¸‹å†™å…¥åˆ°/etc/docker/daemon.jsonï¼Œdocker-for-mac å†™åœ¨é…ç½®ä¸­ã€‚ç„¶åé‡å¯å³å¯ã€‚ ç„¶åå†ä¸ºghoståˆ›å»ºä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œè¿™æ˜¯ä¸€æ¬¾åšå®¢è½¯ä»¶ã€‚ 1$ docker run -d --name ghost --net=container:pause --ipc=container:pause --pid=container:pause ghost ç°åœ¨è®¿é—®http://localhost:8880/å°±å¯ä»¥çœ‹åˆ°ghoståšå®¢çš„ç•Œé¢äº†ã€‚ è§£æ pauseå®¹å™¨å°†å†…éƒ¨çš„80ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„8880ç«¯å£ï¼Œpauseå®¹å™¨åœ¨å®¿ä¸»æœºä¸Šè®¾ç½®å¥½äº†ç½‘ç»œnamespaceåï¼Œnginxå®¹å™¨åŠ å…¥åˆ°è¯¥ç½‘ç»œnamespaceä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°nginxå®¹å™¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®šäº†--net=container:pauseï¼Œghostå®¹å™¨åŒæ ·åŠ å…¥åˆ°äº†è¯¥ç½‘ç»œnamespaceä¸­ï¼Œè¿™æ ·ä¸‰ä¸ªå®¹å™¨å°±å…±äº«äº†ç½‘ç»œï¼Œäº’ç›¸ä¹‹é—´å°±å¯ä»¥ä½¿ç”¨localhostç›´æ¥é€šä¿¡ï¼Œ--ipc=contianer:pause --pid=container:pauseå°±æ˜¯ä¸‰ä¸ªå®¹å™¨å¤„äºåŒä¸€ä¸ªnamespaceä¸­ï¼Œinitè¿›ç¨‹ä¸ºpauseï¼Œè¿™æ—¶æˆ‘ä»¬è¿›å…¥åˆ°ghostå®¹å™¨ä¸­æŸ¥çœ‹è¿›ç¨‹æƒ…å†µã€‚ 12345678# ps auxUSER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMANDroot 1 0.0 0.0 1024 4 ? Ss 13:49 0:00 /pauseroot 5 0.0 0.1 32432 5736 ? Ss 13:51 0:00 nginx: master psystemd+ 9 0.0 0.0 32980 3304 ? S 13:51 0:00 nginx: worker pnode 10 0.3 2.0 1254200 83788 ? Ssl 13:53 0:03 node current/inroot 79 0.1 0.0 4336 812 pts/0 Ss 14:09 0:00 shroot 87 0.0 0.0 17500 2080 pts/0 R+ 14:10 0:00 ps aux åœ¨ghostå®¹å™¨ä¸­åŒæ—¶å¯ä»¥çœ‹åˆ°pauseå’Œnginxå®¹å™¨çš„è¿›ç¨‹ï¼Œå¹¶ä¸”pauseå®¹å™¨çš„PIDæ˜¯1ã€‚è€Œåœ¨kubernetesä¸­å®¹å™¨çš„PID=1çš„è¿›ç¨‹å³ä¸ºå®¹å™¨æœ¬èº«çš„ä¸šåŠ¡è¿›ç¨‹ã€‚ 12345âœ k8s docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES56b408835478 nginx &quot;&#x2F;docker-entrypoint.â€¦&quot; About an hour ago Up About an hour nginxb4b5ecc6ddf4 ghost &quot;docker-entrypoint.sâ€¦&quot; 2 hours ago Up 2 hours ghost2be4a03fea85 k8s.gcr.io&#x2F;pause:3.2 &quot;&#x2F;pause&quot; 3 hours ago Up 3 hours 0.0.0.0:8880-&gt;80&#x2F;tcp pause å½“å…³é—­pauseè¿›ç¨‹çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å®¹å™¨éƒ½ä¼šåœæ­¢ 1docker stop pause å‚è€ƒ The Almighty Pause Container Kubernetesä¹‹Pauseå®¹å™¨ CNCF&amp;Aliyunäº‘åŸç”Ÿè¯¾ç¨‹","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"}]},{"title":"ã€çˆ¬è™«ã€‘- scrapy","slug":"çˆ¬è™«/Tutorial","date":"2020-08-24T01:46:51.000Z","updated":"2021-03-20T16:25:01.820Z","comments":true,"path":"2020/08/24/çˆ¬è™«/Tutorial/","link":"","permalink":"http://blog.crazylaw.cn/2020/08/24/%E7%88%AC%E8%99%AB/Tutorial/","excerpt":"å‰è¨€æœ€è¿‘åœ¨å’Œæœ‹å‹å†™ä¸€ä¸ªäºŒæ‰‹æˆ¿çš„é¡¹ç›®ï¼Œéœ€è¦ç”¨åˆ°çˆ¬è™«ï¼Œè¿™é‡Œå€ŸåŠ©äº†scrapyæ¥å†™ã€‚é¡ºä¾¿æ•´ç†äº†scrapyçš„ç”¨æ³•. fous_seas/sources","text":"å‰è¨€æœ€è¿‘åœ¨å’Œæœ‹å‹å†™ä¸€ä¸ªäºŒæ‰‹æˆ¿çš„é¡¹ç›®ï¼Œéœ€è¦ç”¨åˆ°çˆ¬è™«ï¼Œè¿™é‡Œå€ŸåŠ©äº†scrapyæ¥å†™ã€‚é¡ºä¾¿æ•´ç†äº†scrapyçš„ç”¨æ³•. fous_seas/sources ç¬¬ä¸€ä¸ª Spider12345678910111213141516171819import scrapyclass QuotesSpider(scrapy.Spider): name = \"quotes\" def start_requests(self): urls = [ 'http://quotes.toscrape.com/page/1/', 'http://quotes.toscrape.com/page/2/', ] for url in urls: yield scrapy.Request(url=url, callback=self.parse) def parse(self, response): page = response.url.split(\"/\")[-2] filename = 'quotes-%s.html' % page with open(filename, 'wb') as f: f.write(response.body) self.log('Saved file %s' % filename) å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ–°å»ºçš„ QuotesSpider ç±»æ˜¯ç»§æ‰¿è‡ª scrapy.Spider ç±»çš„ï¼›ä¸‹é¢çœ‹çœ‹å…¶å±æ€§å’Œæ–¹æ³•çš„æ„ä¹‰. name æ˜¯ Spider çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†è¯¥ Spiderï¼›å®ƒå¿…é¡»åœ¨æ•´ä¸ªé¡¹ç›®ä¸­æ˜¯å…¨å±€å”¯ä¸€çš„. start_requests() å¿…é¡»å®šä¹‰å¹¶è¿”å›ä¸€ç»„å¯ä»¥è¢« Spider çˆ¬å–çš„ Requestsï¼ŒRequest å¯¹è±¡ç”±ä¸€ä¸ª URL å’Œä¸€ä¸ªå›è°ƒå‡½æ•°æ„æˆ. parse() å°±æ˜¯ Request å¯¹è±¡ä¸­çš„å›è°ƒæ–¹æ³•ï¼Œç”¨æ¥è§£ææ¯ä¸€ä¸ª Request ä¹‹åçš„ Responseï¼›æ‰€ä»¥ï¼Œparse() æ–¹æ³•å°±æ˜¯ç”¨æ¥è§£æè¿”å›çš„å†…å®¹ï¼Œé€šè¿‡è§£æå¾—åˆ°çš„ URL åŒæ ·å¯ä»¥åˆ›å»ºå¯¹åº”çš„ Requests è¿›è€Œç»§ç»­çˆ¬å–. å†æ¥çœ‹çœ‹å…·ä½“çš„å®ç°ã€‚ start_request(self) æ–¹æ³•åˆ†åˆ«é’ˆå¯¹ http://quotes.toscrape.com/page/1/ å’Œ http://quotes.toscrape.com/page/2/ åˆ›å»ºäº†ä¸¤ä¸ªéœ€è¦è¢«çˆ¬å–çš„ Requests å¯¹è±¡ï¼›å¹¶é€šè¿‡ yield è¿›è¡Œè¿­ä»£è¿”å›ï¼›å¤‡æ³¨ï¼Œyield æ˜¯è¿­ä»£ç”Ÿæˆå™¨ï¼Œæ˜¯ä¸€ä¸ª Generatorï¼› parse(self, response) å¯¹ Request çš„åé¦ˆçš„å†…å®¹ Response è¿›è¡Œè§£æï¼Œè¿™é‡Œçš„è§£æçš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ†åˆ«åˆ›å»ºä¸¤ä¸ªæœ¬åœ°æ–‡ä»¶ï¼Œç„¶åå°† response.body çš„å†…å®¹æ”¾å…¥è¿™ä¸¤ä¸ªæ–‡ä»¶å½“ä¸­ã€‚ 1scrapy crawl quotes å¤§è‡´ä¼šè¾“å‡ºå¦‚ä¸‹å†…å®¹ 1234567891011...2016-12-16 21:24:05 [scrapy.core.engine] INFO: Spider opened2016-12-16 21:24:05 [scrapy.extensions.logstats] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)2016-12-16 21:24:05 [scrapy.extensions.telnet] DEBUG: Telnet console listening on 127.0.0.1:60232016-12-16 21:24:05 [scrapy.core.engine] DEBUG: Crawled (404) &lt;GET http://quotes.toscrape.com/robots.txt&gt; (referer: None)2016-12-16 21:24:05 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET http://quotes.toscrape.com/page/1/&gt; (referer: None)2016-12-16 21:24:05 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET http://quotes.toscrape.com/page/2/&gt; (referer: None)2016-12-16 21:24:05 [quotes] DEBUG: Saved file quotes-1.html2016-12-16 21:24:05 [quotes] DEBUG: Saved file quotes-2.html2016-12-16 21:24:05 [scrapy.core.engine] INFO: Closing spider (finished)... å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡çˆ¬å–ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°ç”Ÿæˆäº†ä¸¤ä¸ª html æ–‡ä»¶ quotes-1.html å’Œ quotes-2.html å¦‚ä½•æå–é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼æå–Scrapy æä¾›äº†å‘½ä»¤è¡Œçš„æ–¹å¼å¯ä»¥å¯¹éœ€è¦è¢«çˆ¬å–çš„å†…å®¹è¿›è¡Œé«˜æ•ˆçš„è°ƒè¯•ï¼Œé€šè¿‡ä½¿ç”¨Scrapy shellè¿›å…¥å‘½ä»¤è¡Œï¼Œç„¶ååœ¨å‘½ä»¤è¡Œä¸­å¯ä»¥å¿«é€Ÿçš„å¯¹è¦çˆ¬å–çš„å†…å®¹è¿›è¡Œæå–ï¼› ä¸€å®šè¦å­¦ä¼šè°ƒè¯•ï¼ï¼ï¼è¿™æ˜¯ä¸èƒ½è·³è¿‡çš„æ­¥éª¤ æˆ‘ä»¬è¯•ç€é€šè¿‡ Scrapy shell æ¥æå–ä¸‹ â€œhttp://quotes.toscrape.com/page/1/&quot; ä¸­çš„æ•°æ®ï¼Œé€šè¿‡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œè¿›å…¥ shell 123456scrapy shell &quot;http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&quot;&#x2F;&#x2F; æˆ–è€…scrapy shllfetch(&#39;http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&#39;) è¾“å‡º 123456789101112131415[ ... Scrapy log here ... ]2016-09-19 12:09:27 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&gt; (referer: None)[s] Available Scrapy objects:[s] scrapy scrapy module (contains scrapy.Request, scrapy.Selector, etc)[s] crawler &lt;scrapy.crawler.Crawler object at 0x7fa91d888c90&gt;[s] item &#123;&#125;[s] request &lt;GET http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&gt;[s] response &lt;200 http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&gt;[s] settings &lt;scrapy.settings.Settings object at 0x7fa91d888c10&gt;[s] spider &lt;DefaultSpider &#39;default&#39; at 0x7fa91c8af990&gt;[s] Useful shortcuts:[s] shelp() Shell help (print this help)[s] fetch(req_or_url) Fetch request (or URL) and update local objects[s] view(response) View response in a browser&gt;&gt;&gt; è¿™æ ·ï¼Œæˆ‘ä»¬å°±è¿›å…¥äº† Scrapy shell çš„ç¯å¢ƒï¼Œä¸Šé¢æ˜¾ç¤ºäº†è¿æ¥è¯·æ±‚å’Œè¿”å›çš„ç›¸å…³ä¿¡æ¯ï¼Œresponse è¿”å› status code 200 è¡¨ç¤ºæˆåŠŸè¿”å›ï¼› é€šè¿‡ CSS æ ‡å‡†è¿›è¡Œæå–è¿™é‡Œä¸»è¦æ˜¯éµå¾ª CSS æ ‡å‡† https://www.w3.org/TR/selectors/ æ¥å¯¹ç½‘é¡µçš„å…ƒç´ è¿›è¡Œæå–. é€šè¿‡ä½¿ç”¨ css() é€‰æ‹©æˆ‘ä»¬è¦æå–çš„å…ƒç´ ä¸‹é¢æ¼”ç¤ºä¸€ä¸‹å¦‚ä½•æå–å…ƒç´ . 12&gt;&gt;&gt; response.css(&#39;title&#39;)[&lt;Selector xpath&#x3D;u&#39;descendant-or-self::title&#39; data&#x3D;u&#39;&lt;title&gt;Quotes to Scrape&lt;&#x2F;title&gt;&#39;&gt;] å¯ä»¥çœ‹åˆ°ï¼Œå®ƒé€šè¿‡è¿”å›ä¸€ä¸ªç±»ä¼¼ SelectorList çš„å¯¹è±¡æˆåŠŸçš„è·å–åˆ°äº† http://quotes.toscrape.com/page/1/ é¡µé¢ä¸­çš„ çš„ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯æ˜¯å°è£…åœ¨Selectorå¯¹è±¡ä¸­çš„ data å±æ€§ä¸­çš„. æå–Selectorå…ƒç´ çš„æ–‡æœ¬å†…å®¹ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ç”¨æ¥æå– é€šè¿‡ä½¿ç”¨ extract() æˆ–è€… extract_first() æ–¹æ³•æ¥æå–å…ƒç´ çš„å†…å®¹ï¼›ä¸‹é¢æ¼”ç¤ºå¦‚ä½•æå– #1 è¿”å›çš„å…ƒç´  ä¸­çš„æ–‡æœ¬å†…å®¹ textï¼› 12&gt;&gt;&gt; response.css(&#39;title::text&#39;).extract_first()&#39;Quotes to Scrape&#39; extract_first() è¡¨ç¤ºæå–è¿”å›é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ª Selector å¯¹è±¡ï¼›åŒæ ·ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æ–¹å¼. 12&gt;&gt;&gt; response.css(&#39;title::text&#39;)[0].extract()&#39;Quotes to Scrape&#39; ä¸è¿‡ extract_first() æ–¹æ³•å¯ä»¥åœ¨å½“é¡µé¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œé¿å…å‡ºç°IndexErrorçš„é”™è¯¯ï¼› é€šè¿‡ re() æ–¹æ³•æ¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼æ¥è¿›è¡Œæå–å…ƒç´ çš„æ–‡æœ¬å†…å®¹ 123456&gt;&gt;&gt; response.css(&#39;title::text&#39;).re(r&#39;Quotes.*&#39;)[&#39;Quotes to Scrape&#39;]&gt;&gt;&gt; response.css(&#39;title::text&#39;).re(r&#39;Q\\w+&#39;)[&#39;Quotes&#39;]&gt;&gt;&gt; response.css(&#39;title::text&#39;).re(r&#39;(\\w+) to (\\w+)&#39;)[&#39;Quotes&#39;, &#39;Scrape&#39;] ä½¿ç”¨ XPathé™¤äº†ä½¿ç”¨ CSS æ ‡å‡† æ¥æå–å…ƒç´ æ„å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ XPath æ ‡å‡†æ¥æå–å…ƒç´ ï¼Œæ¯”å¦‚: 1234&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;title&#39;)[&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;title&#39; data&#x3D;&#39;&lt;title&gt;Quotes to Scrape&lt;&#x2F;title&gt;&#39;&gt;]&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;title&#x2F;text()&#39;).extract_first()&#39;Quotes to Scrape&#39; XPath æ¯” CSS çš„çˆ¬å–æ–¹å¼æ›´ä¸ºå¼ºå¤§ï¼Œå› ä¸ºå®ƒä¸ä»…ä»…æ˜¯æ ¹æ® HTML çš„ç»“æ„å…ƒç´ å»è¿›è¡Œæ£€ç´¢(Navigating)ï¼Œå¹¶ä¸”å®ƒå¯ä»¥é¡ºå¸¦çš„å¯¹æ–‡æœ¬(text)è¿›è¡Œæ£€ç´¢ï¼›æ‰€ä»¥å®ƒå¯ä»¥æ”¯æŒ CSS æ ‡å‡†ä¸èƒ½åšåˆ°çš„åœºæ™¯ï¼Œæ¯”å¦‚ï¼Œæ£€ç´¢ä¸€ä¸ª åŒ…å«æ–‡æœ¬å†…å®¹â€Next Pageâ€çš„ link å…ƒç´ ï¼›è¿™å°±ä½¿å¾—é€šè¿‡ XPath å»æ„å»ºçˆ¬è™«æ›´ä¸ºç®€å•. æ•°æ®æµè®¾è®¡å›¾ ItemsScrapy çš„æ ¸å¿ƒç›®çš„å°±æ˜¯ä»éç»“æ„åŒ–çš„ç½‘é¡µä¸­æå–å‡ºç»“æ„åŒ–çš„æ•°æ®ï¼›é»˜è®¤çš„ï¼ŒScrapy çˆ¬è™«ä»¥ dicts çš„å½¢å¼è¿”å›æ ¼å¼åŒ–çš„æ•°æ®ï¼›ä½†æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ dicts å¹¶ä¸èƒ½å¾ˆå¥½çš„è¡¨ç¤ºè¿™ç§ç»“æ„åŒ–æ•°æ®çš„ç»“æ„ï¼Œè€Œä¸”ç»å¸¸å®¹æ˜“å‡ºé”™ï¼Œè½¬æ¢ä¹Ÿéº»çƒ¦ã€‚ å› æ­¤ï¼ŒItem è¯ç”Ÿäº†ï¼Œå®ƒæä¾›äº†è¿™æ ·ä¸€ä¸ªç®€å•çš„å®¹å™¨æ¥æ”¶é›†çˆ¬å–åˆ°çš„æ•°æ®ï¼Œå¹¶æä¾›éå¸¸ç®€ä¾¿çš„ API æ¥å£°æ˜å®ƒçš„ fieldsã€‚ å£°æ˜ Itemsé€šè¿‡ä¸€ä¸ªç®€å•çš„ class å’Œå¤šä¸ª Field å¯¹è±¡æ¥å£°æ˜ Items å¯¹è±¡ï¼›çœ‹ä¸€ä¸ª Product Item çš„ä¾‹å­ã€‚ 1234567import scrapyclass Product(scrapy.Item): name &#x3D; scrapy.Field() price &#x3D; scrapy.Field() stock &#x3D; scrapy.Field() last_updated &#x3D; scrapy.Field(serializer&#x3D;str) éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒProduct ç»§æ‰¿è‡ª scrapy.Item çˆ¶ç±».","categories":[{"name":"çˆ¬è™«","slug":"çˆ¬è™«","permalink":"http://blog.crazylaw.cn/categories/%E7%88%AC%E8%99%AB/"}],"tags":[{"name":"çˆ¬è™«","slug":"çˆ¬è™«","permalink":"http://blog.crazylaw.cn/tags/%E7%88%AC%E8%99%AB/"}]},{"title":"ã€Golangã€‘- pprofæ€§èƒ½åˆ†æ","slug":"Golang/pprofæ€§èƒ½åˆ†æ","date":"2020-08-14T08:35:51.000Z","updated":"2021-03-20T16:25:01.799Z","comments":true,"path":"2020/08/14/Golang/pprofæ€§èƒ½åˆ†æ/","link":"","permalink":"http://blog.crazylaw.cn/2020/08/14/Golang/pprof%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/","excerpt":"å‰è¨€æœ€è¿‘åœ¨å¼€å‘ä¸€ä¸ªgolangçš„å¤§æ•°æ®æœåŠ¡ï¼Œå‘ç°åªè¦åˆ°äº†ä¸šåŠ¡å±‚æ€§èƒ½å°±æ€¥å‰§ä¸‹é™ï¼Œä¸ºäº†æ’æŸ¥è¿™ä¸ªåŸå› ï¼Œä½¿ç”¨pprofè¿›è¡Œæ€§èƒ½åˆ†æ","text":"å‰è¨€æœ€è¿‘åœ¨å¼€å‘ä¸€ä¸ªgolangçš„å¤§æ•°æ®æœåŠ¡ï¼Œå‘ç°åªè¦åˆ°äº†ä¸šåŠ¡å±‚æ€§èƒ½å°±æ€¥å‰§ä¸‹é™ï¼Œä¸ºäº†æ’æŸ¥è¿™ä¸ªåŸå› ï¼Œä½¿ç”¨pprofè¿›è¡Œæ€§èƒ½åˆ†æ ä½¿ç”¨åœ¨mainå‡½æ•°ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç  123456import \"runtime/pprof\"// ...cpuProfile, _ := os.Create(\"cpu_profile\")pprof.StartCPUProfile(cpuProfile)defer pprof.StopCPUProfile()// ... è¿™é‡Œ os.Create(&quot;cpu_profile&quot;) æŒ‡å®šç”Ÿæˆçš„æ•°æ®æ–‡ä»¶, ç„¶å pprof.StartCPUProfile çœ‹åå­—å°±çŸ¥é“æ˜¯å¼€å§‹å¯¹ CPU çš„ä½¿ç”¨è¿›è¡Œç›‘æ§. æœ‰å¼€å§‹å°±æœ‰ç»“æŸ, ä¸€èˆ¬ç›´æ¥è·Ÿç€ defer pprof.StopCPUProfile() çœçš„åé¢å¿˜äº†. ç¼–è¯‘æ‰§è¡Œä¸€æ¬¡ä»¥åä¼šåœ¨ç›®å½•ä¸‹ç”Ÿæˆç›‘æ§æ•°æ®å¹¶è®°å½•åˆ° cpu_profile. æ¥ç€å°±å¯ä»¥ä½¿ç”¨ pprof æ¥è§£è¯»åˆ†æè¿™äº›ç›‘æ§ç”Ÿæˆçš„æ•°æ®. CPU Profiling1234567root@60b1d42d6330:&#x2F;www# go tool pprof cpu_profileFile: mainBuild ID: 3d9d75a7fe2c5c4917c59acabfd743a6512d91faType: cpuTime: Aug 14, 2020 at 8:34am (UTC)Duration: 205.73ms, Total samples &#x3D; 30ms (14.58%)Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€Golangã€‘- devle","slug":"Golang/dlvåœ¨çº¿è°ƒè¯•","date":"2020-08-14T01:46:51.000Z","updated":"2021-03-20T16:25:01.799Z","comments":true,"path":"2020/08/14/Golang/dlvåœ¨çº¿è°ƒè¯•/","link":"","permalink":"http://blog.crazylaw.cn/2020/08/14/Golang/dlv%E5%9C%A8%E7%BA%BF%E8%B0%83%E8%AF%95/","excerpt":"å‰è¨€ç”±äºæˆ‘ä»¬å¯èƒ½æ–­ç‚¹è°ƒè¯•ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦debugå·¥å…·ï¼Œå¯¹äºgolangæ¥è¯´ï¼Œdelveæ¯”gdbå¯¹goç¨‹åºæ›´å‹å¥½ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä»Šå¤©æ¥çœ‹çœ‹devleæ€ä¹ˆdebugç¨‹åº","text":"å‰è¨€ç”±äºæˆ‘ä»¬å¯èƒ½æ–­ç‚¹è°ƒè¯•ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦debugå·¥å…·ï¼Œå¯¹äºgolangæ¥è¯´ï¼Œdelveæ¯”gdbå¯¹goç¨‹åºæ›´å‹å¥½ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä»Šå¤©æ¥çœ‹çœ‹devleæ€ä¹ˆdebugç¨‹åº å®‰è£…1go get github.com&#x2F;go-delve&#x2F;delve&#x2F;cmd&#x2F;dlv ç”¨æ³•aï¼‰dlv debug ä½¿ç”¨dlv debugå¯ä»¥åœ¨mainå‡½æ•°æ–‡ä»¶æ‰€åœ¨ç›®å½•ç›´æ¥å¯¹mainå‡½æ•°è¿›è¡Œè°ƒè¯•ï¼Œä¹Ÿå¯ä»¥åœ¨æ ¹ç›®å½•ä»¥æŒ‡å®šåŒ…è·¯å¾„çš„æ–¹å¼å¯¹mainå‡½æ•°è¿›è¡Œè°ƒè¯•ã€‚ bï¼‰dlv test ä½¿ç”¨dlv testå¯ä»¥å¯¹teståŒ…è¿›è¡Œè°ƒè¯•ã€‚ cï¼‰dlv attach ä½¿ç”¨dlv attachå¯ä»¥é™„åŠ åˆ°ä¸€ä¸ªå·²åœ¨è¿è¡Œçš„è¿›ç¨‹è¿›è¡Œè°ƒè¯•ã€‚ dï¼‰dlv connect ä½¿ç”¨dlv connectå¯ä»¥è¿æ¥åˆ°è°ƒè¯•æœåŠ¡å™¨è¿›è¡Œè°ƒè¯•ã€‚ eï¼‰dlv trace ä½¿ç”¨dlv traceå¯ä»¥è¿½è¸ªç¨‹åºã€‚ fï¼‰dlv exec ä½¿ç”¨dlv execå¯ä»¥å¯¹ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶è¿›è¡Œè°ƒè¯• åˆ›å»ºmain.goæ–‡ä»¶ï¼Œmainå‡½æ•°å…ˆé€šè¿‡å¾ªåˆå§‹åŒ–ä¸€ä¸ªåˆ‡ç‰‡ï¼Œç„¶åè¾“å‡ºåˆ‡ç‰‡çš„å†…å®¹ï¼š 12345678910111213package mainimport ( \"fmt\")func main() &#123; nums := make([]int, 5) for i := 0; i &lt; len(nums); i++ &#123; nums[i] = i * i &#125; fmt.Println(nums)&#125; å‘½ä»¤è¡Œè¿›å…¥åŒ…æ‰€åœ¨ç›®å½•ï¼Œç„¶åè¾“å…¥dlv debugå‘½ä»¤è¿›å…¥è°ƒè¯•ï¼š 123$ dlv debugType &#39;help&#39; for list of commands.(dlv) è¾“å…¥helpå‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°Delveæä¾›çš„è°ƒè¯•å‘½ä»¤åˆ—è¡¨ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960(dlv) helpThe following commands are available:Running the program: call ------------------------ Resumes process, injecting a function call (EXPERIMENTAL!!!) continue (alias: c) --------- Run until breakpoint or program termination. next (alias: n) ------------- Step over to next source line. rebuild --------------------- Rebuild the target executable and restarts it. It does not work if the executable was not built by delve. restart (alias: r) ---------- Restart process. step (alias: s) ------------- Single step through program. step-instruction (alias: si) Single step a single cpu instruction. stepout (alias: so) --------- Step out of the current function.Manipulating breakpoints: break (alias: b) ------- Sets a breakpoint. breakpoints (alias: bp) Print out info for active breakpoints. clear ------------------ Deletes breakpoint. clearall --------------- Deletes multiple breakpoints. condition (alias: cond) Set breakpoint condition. on --------------------- Executes a command when a breakpoint is hit. trace (alias: t) ------- Set tracepoint.Viewing program variables and memory: args ----------------- Print function arguments. display -------------- Print value of an expression every time the program stops. examinemem (alias: x) Examine memory: locals --------------- Print local variables. print (alias: p) ----- Evaluate an expression. regs ----------------- Print contents of CPU registers. set ------------------ Changes the value of a variable. vars ----------------- Print package variables. whatis --------------- Prints type of an expression.Listing and switching between threads and goroutines: goroutine (alias: gr) -- Shows or changes current goroutine goroutines (alias: grs) List program goroutines. thread (alias: tr) ----- Switch to the specified thread. threads ---------------- Print out info for every traced thread.Viewing the call stack and selecting frames: deferred --------- Executes command in the context of a deferred call. down ------------- Move the current frame down. frame ------------ Set the current frame, or execute command on a different frame. stack (alias: bt) Print stack trace. up --------------- Move the current frame up.Other commands: config --------------------- Changes configuration parameters. disassemble (alias: disass) Disassembler. edit (alias: ed) ----------- Open where you are in $DELVE_EDITOR or $EDITOR exit (alias: quit | q) ----- Exit the debugger. funcs ---------------------- Print list of functions. help (alias: h) ------------ Prints the help message. libraries ------------------ List loaded dynamic libraries list (alias: ls | l) ------- Show source code. source --------------------- Executes a file containing a list of delve commands sources -------------------- Print list of source files. types ---------------------- Print list of typesType help followed by a command for full documentation. æ¯ä¸ªGoç¨‹åºçš„å…¥å£æ˜¯main.mainå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨break(b)åœ¨æ­¤è®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼š 12(dlv) break main.mainBreakpoint 1 set at 0x10ae9b8 for main.main() .&#x2F;main.go:7 ç„¶åé€šè¿‡breakpoints(bp)æŸ¥çœ‹å·²ç»è®¾ç½®çš„æ‰€æœ‰æ–­ç‚¹ï¼š 12345(dlv) breakpointsBreakpoint unrecovered-panic at 0x102a380 for runtime.startpanic() &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;panic.go:588 (0) print runtime.curg._panic.argBreakpoint 1 at 0x10ae9b8 for main.main() .&#x2F;main.go:7 (0) æˆ‘ä»¬å‘ç°é™¤äº†æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„main.mainå‡½æ•°æ–­ç‚¹å¤–ï¼ŒDelveå†…éƒ¨å·²ç»ä¸ºpanicå¼‚å¸¸å‡½æ•°è®¾ç½®äº†ä¸€ä¸ªæ–­ç‚¹ã€‚ é€šè¿‡varså‘½ä»¤å¯ä»¥æŸ¥çœ‹å…¨éƒ¨åŒ…çº§çš„å˜é‡ã€‚å› ä¸ºæœ€ç»ˆçš„ç›®æ ‡ç¨‹åºå¯èƒ½å«æœ‰å¤§é‡çš„å…¨å±€å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªæ­£åˆ™å‚æ•°é€‰æ‹©æƒ³æŸ¥çœ‹çš„å…¨å±€å˜é‡ï¼š 12345(dlv) vars mainmain.initdoneÂ· &#x3D; 2runtime.main_init_done &#x3D; chan bool 0&#x2F;0runtime.mainStarted &#x3D; true(dlv) ç„¶åå°±å¯ä»¥é€šè¿‡continue(c)å‘½ä»¤è®©ç¨‹åºè¿è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹å¤„ï¼š 1234567891011121314(dlv) continue&gt; main.main() .&#x2F;main.go:7 (hits goroutine(1):1 total:1) (PC: 0x10ae9b8) 2: 3: import ( 4: &quot;fmt&quot; 5: ) 6:&#x3D;&gt; 7: func main() &#123; 8: nums :&#x3D; make([]int, 5) 9: for i :&#x3D; 0; i &lt; len(nums); i++ &#123; 10: nums[i] &#x3D; i * i 11: &#125; 12: fmt.Println(nums)(dlv) è¾“å…¥next(n)å‘½ä»¤å•æ­¥æ‰§è¡Œè¿›å…¥mainå‡½æ•°å†…éƒ¨ï¼š 1234567891011121314(dlv) next&gt; main.main() .&#x2F;main.go:8 (PC: 0x10ae9cf) 3: import ( 4: &quot;fmt&quot; 5: ) 6: 7: func main() &#123;&#x3D;&gt; 8: nums :&#x3D; make([]int, 5) 9: for i :&#x3D; 0; i &lt; len(nums); i++ &#123; 10: nums[i] &#x3D; i * i 11: &#125; 12: fmt.Println(nums) 13: &#125;(dlv) è¿›å…¥å‡½æ•°ä¹‹åå¯ä»¥é€šè¿‡argså’Œlocalså‘½ä»¤æŸ¥çœ‹å‡½æ•°çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ï¼š 1234(dlv) args(no args)(dlv) localsnums &#x3D; []int len: 842350763880, cap: 17491881, nil å› ä¸ºmainå‡½æ•°æ²¡æœ‰å‚æ•°ï¼Œå› æ­¤argså‘½ä»¤æ²¡æœ‰ä»»ä½•è¾“å‡ºã€‚è€Œlocalså‘½ä»¤åˆ™è¾“å‡ºäº†å±€éƒ¨å˜é‡numsåˆ‡ç‰‡çš„å€¼ï¼šæ­¤æ—¶åˆ‡ç‰‡è¿˜æœªå®Œæˆåˆå§‹åŒ–ï¼Œåˆ‡ç‰‡çš„åº•å±‚æŒ‡é’ˆä¸ºnilï¼Œé•¿åº¦å’Œå®¹é‡éƒ½æ˜¯ä¸€ä¸ªéšæœºæ•°å€¼ã€‚ å†æ¬¡è¾“å…¥nextå‘½ä»¤å•æ­¥æ‰§è¡Œåå°±å¯ä»¥æŸ¥çœ‹åˆ°numsåˆ‡ç‰‡åˆå§‹åŒ–ä¹‹åçš„ç»“æœäº†ï¼š 12345678910111213141516(dlv) next&gt; main.main() .&#x2F;main.go:9 (PC: 0x10aea12) 4: &quot;fmt&quot; 5: ) 6: 7: func main() &#123; 8: nums :&#x3D; make([]int, 5)&#x3D;&gt; 9: for i :&#x3D; 0; i &lt; len(nums); i++ &#123; 10: nums[i] &#x3D; i * i 11: &#125; 12: fmt.Println(nums) 13: &#125;(dlv) localsnums &#x3D; []int len: 5, cap: 5, [...]i &#x3D; 17601536(dlv) æ­¤æ—¶å› ä¸ºè°ƒè¯•å™¨å·²ç»åˆ°äº†forè¯­å¥è¡Œï¼Œå› æ­¤å±€éƒ¨å˜é‡å‡ºç°äº†è¿˜æœªåˆå§‹åŒ–çš„å¾ªç¯è¿­ä»£å˜é‡iã€‚ ä¸‹é¢æˆ‘ä»¬é€šè¿‡ç»„åˆä½¿ç”¨break(b)å’Œcondition(cond)å‘½ä»¤ï¼Œåœ¨å¾ªç¯å†…éƒ¨è®¾ç½®ä¸€ä¸ªæ¡ä»¶æ–­ç‚¹ï¼Œå½“å¾ªç¯å˜é‡iç­‰äº3æ—¶æ–­ç‚¹ç”Ÿæ•ˆï¼š 1234(dlv) break main.go:10Breakpoint 2 set at 0x10aea33 for main.main() .&#x2F;main.go:10(dlv) condition 2 i&#x3D;&#x3D;3(dlv) ç„¶åé€šè¿‡continueæ‰§è¡Œåˆ°åˆšè®¾ç½®çš„æ¡ä»¶æ–­ç‚¹ï¼Œå¹¶ä¸”è¾“å‡ºå±€éƒ¨å˜é‡ï¼š 1234567891011121314151617(dlv) continue&gt; main.main() .&#x2F;main.go:10 (hits goroutine(1):1 total:1) (PC: 0x10aea33) 5: ) 6: 7: func main() &#123; 8: nums :&#x3D; make([]int, 5) 9: for i :&#x3D; 0; i &lt; len(nums); i++ &#123;&#x3D;&gt; 10: nums[i] &#x3D; i * i 11: &#125; 12: fmt.Println(nums) 13: &#125;(dlv) localsnums &#x3D; []int len: 5, cap: 5, [...]i &#x3D; 3(dlv) print nums[]int len: 5, cap: 5, [0,1,4,0,0](dlv) æˆ‘ä»¬å‘ç°å½“å¾ªç¯å˜é‡iç­‰äº3æ—¶ï¼Œnumsåˆ‡ç‰‡çš„å‰3ä¸ªå…ƒç´ å·²ç»æ­£ç¡®åˆå§‹åŒ–ã€‚ æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡stackæŸ¥çœ‹å½“å‰æ‰§è¡Œå‡½æ•°çš„æ ˆå¸§ä¿¡æ¯ï¼š 12345678(dlv) stack0 0x00000000010aea33 in main.main at .&#x2F;main.go:101 0x000000000102bd60 in runtime.main at &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:1982 0x0000000001053bd1 in runtime.goexit at &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;asm_amd64.s:2361(dlv) æˆ–è€…é€šè¿‡goroutineå’Œgoroutineså‘½ä»¤æŸ¥çœ‹å½“å‰Goroutineç›¸å…³çš„ä¿¡æ¯ï¼š 1234567891011121314151617(dlv) goroutineThread 101686 at .&#x2F;main.go:10Goroutine 1: Runtime: .&#x2F;main.go:10 main.main (0x10aea33) User: .&#x2F;main.go:10 main.main (0x10aea33) Go: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;asm_amd64.s:258 runtime.rt0_go (0x1051643) Start: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:109 runtime.main (0x102bb90)(dlv) goroutines[4 goroutines]* Goroutine 1 - User: .&#x2F;main.go:10 main.main (0x10aea33) (thread 101686) Goroutine 2 - User: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:292 \\ runtime.gopark (0x102c189) Goroutine 3 - User: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:292 \\ runtime.gopark (0x102c189) Goroutine 4 - User: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:292 \\ runtime.gopark (0x102c189)(dlv) æœ€åå®Œæˆè°ƒè¯•å·¥ä½œåè¾“å…¥quitå‘½ä»¤é€€å‡ºè°ƒè¯•å™¨ã€‚è‡³æ­¤æˆ‘ä»¬å·²ç»æŒæ¡äº†Delveè°ƒè¯•å™¨å™¨çš„ç®€å•ç”¨æ³•ã€‚","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€DevOpsã€‘Jenkins-shared-library å®æˆ˜","slug":"DevOps/Jenkins-shared-library","date":"2020-07-10T09:35:30.000Z","updated":"2021-03-20T16:25:01.798Z","comments":true,"path":"2020/07/10/DevOps/Jenkins-shared-library/","link":"","permalink":"http://blog.crazylaw.cn/2020/07/10/DevOps/Jenkins-shared-library/","excerpt":"å‰è¨€æœ€è¿‘å…¬å¸ç”¨äº† jenkins åšä¸º CI/CD çš„å·¥å…·ï¼Œjenkinsæ˜¯ä»€ä¹ˆï¼Œæˆ‘å°±ä¸å’Œå¤§å®¶è¯¦ç»†è¯´æ˜äº†ã€‚ ä»Šå¤©ä¸»è¦è®²çš„æ˜¯ jenkins çš„ pipelineï¼Œæ—§ç‰ˆçš„ jenkins æˆ‘ä¸å¤ªäº†è§£ï¼Œä½†æ˜¯å¬è¯´è¿™ä¸ª pipeline æ˜¯æ–°å‡ºçš„ã€‚ ä»Šå¤©è¦è®²çš„ä¹Ÿä¸å•å•æ˜¯pipelineï¼Œæ›´æ˜¯æœ‰å¼ºåŠ›å¹²è´§share-libraryç›¸å…³çš„å†…å®¹ã€‚","text":"å‰è¨€æœ€è¿‘å…¬å¸ç”¨äº† jenkins åšä¸º CI/CD çš„å·¥å…·ï¼Œjenkinsæ˜¯ä»€ä¹ˆï¼Œæˆ‘å°±ä¸å’Œå¤§å®¶è¯¦ç»†è¯´æ˜äº†ã€‚ ä»Šå¤©ä¸»è¦è®²çš„æ˜¯ jenkins çš„ pipelineï¼Œæ—§ç‰ˆçš„ jenkins æˆ‘ä¸å¤ªäº†è§£ï¼Œä½†æ˜¯å¬è¯´è¿™ä¸ª pipeline æ˜¯æ–°å‡ºçš„ã€‚ ä»Šå¤©è¦è®²çš„ä¹Ÿä¸å•å•æ˜¯pipelineï¼Œæ›´æ˜¯æœ‰å¼ºåŠ›å¹²è´§share-libraryç›¸å…³çš„å†…å®¹ã€‚ Jenkinsfileç›®å‰æˆ‘ä»¬çš„ jenkins æœåŠ¡ç”¨è¿‡æ™®é€šçš„pipelineå’Œ å¤šåˆ†æ”¯çš„pipelineï¼Œå…¶ä¸»è¦åŒºåˆ«å°±æ˜¯å¤šåˆ†æ”¯pipelineæ›´åŠ çµæ´»ä¸€äº›ï¼Œèƒ½å¤Ÿè®©æˆ‘ä»¬å°‘åšä¸€äº›é€»è¾‘å¤„ç†ã€‚ä½†æ˜¯è¿™å¼•å…¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬çš„jenkinsï¼Œå¿…é¡»å­˜åœ¨ä¸å¯¹åº”çš„åˆ†æ”¯ä¸­ï¼Œä¹Ÿå› æ­¤ï¼Œpipeline çš„æµç¨‹å˜æˆäº†ä»£ç ç®¡ç†ï¼Œå¹¶ä¸”ç”±äºæˆ‘ä»¬å­˜åœ¨å¤šä¸ªé¡¹ç›®ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰é¡¹ç›®æ•° * 2(master/pre-develop) é‚£ä¹ˆå¤šçš„ jenkins éœ€è¦ç®¡ç†ï¼Œäºæ˜¯å°±å¯¼è‡´äº†æˆ‘ä»¬æœ‰å¾ˆå¤šè¿™ç§å†—ä½™çš„å†™æ³•ï¼Œè¿™è¿˜ä¸æ˜¯æœ€ç³Ÿç³•çš„ï¼Œæœ€ç³Ÿç³•çš„æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€äº›é€šç”¨çš„å†…å®¹çš„æ—¶å€™ï¼Œå°±éœ€è¦ä¸€ä¸ªä¸ªå»ä¿®æ”¹ï¼Œè¿™ç»å¯¹æ˜¯ç¾éš¾çº§åˆ«çš„éœ€æ±‚ã€‚ Shared-libraryå¹¸å¥½ï¼Œæˆ–è®¸ jenkins å·²ç»è€ƒè™‘åˆ°äº†è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œç»™æˆ‘ä»¬æä¾›äº†shared-libraryï¼Œåœ¨å…±äº«åº“çš„å­˜åœ¨ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€äº›è‡ªå®šä¹‰çš„å®šåˆ¶åŠŸèƒ½ã€‚ä½†æ˜¯è¿™ä¸æ˜¯æ²¡æœ‰ä»£ä»·çš„ï¼Œä»£ä»·å°±æ˜¯ä½ éœ€è¦äº†è§£groovyè¿™é—¨è¯­è¨€ï¼Œè¿™æ˜¯javaçš„æ´¾ç”Ÿè¯­è¨€ï¼Œæä¾›äº†å¼±ç±»å‹çš„è¯­æ³•ï¼Œè®©å†™ groovy è„šæœ¬çš„å˜å¾—æ›´åŠ è½»æ¾ç®€å•ï¼Œä½†æ˜¯ä¹Ÿå› æ­¤ï¼Œgroovy å’Œ java çš„è¯­æ³•å¸¸å¸¸å¯ä»¥æ··åœ¨ä¸€èµ·å†™ï¼Œæ˜¾å¾—æœ‰ç‚¹æ‚ä¹±ã€‚ ä½†æ˜¯æœ‰æ€»æ¯”æ²¡æœ‰å¥½ï¼Œæˆ‘ä»¬æŠŠå…±äº«åº“åˆ†æˆäº† 2 ä¸ªåº“ï¼Œåˆ†åˆ«æ˜¯resource-librariesï¼Œjenkins-shard-libraryã€‚ resource-libraries è¿™ä¸ªèµ„æºå…±äº«åº“å®šä¹‰äº†æˆ‘ä»¬éœ€è¦éƒ¨ç½²ä¸åŒçš„é…ç½®èµ„æºä¿¡æ¯ï¼Œä¸»è¦æ˜¯å¯¹åº”libraryResourceè¿™ä¸ª api æ¥åŠ è½½èµ„æº jenkins-shard-library è¿™ä¸ªå…±äº«åº“å®šä¹‰äº†æˆ‘ä»¬éœ€è¦çš„é€šç”¨æ–¹æ³•ï¼Œä¾‹å¦‚éƒ¨ç½²æµç¨‹å·²ç»éœ€è¦ç»Ÿä¸€å¯¹å¤–çš„ api resource-librariesç›®å‰ï¼Œæˆ‘ä»¬çš„èµ„æºåº“ç›®å½•ç»“æ„å¦‚ä¸‹ï¼ŒåŸºæœ¬ä¸å­˜åœ¨ src ç›®å½•ï¼Œè¿™ä¹Ÿæ„å‘³è€…è¿™ä¸ªåº“ä¸å­˜åœ¨ç‹¬ç‰¹çš„ç±»ä»£ç ï¼Œåªæœ‰ç»Ÿä¸€å¯¹å¤–å¼€æ”¾çš„varsï¼Œæ•´ä¸ªåº“å¯¹å¤–å¼€æ”¾çš„ api åªæœ‰ä¸€ä¸ªmresource_loadæ–¹æ³•ï¼Œæ ¸å¿ƒä½œç”¨å°±æ˜¯åŠ è½½resourcesç›®å½•ä¸­çš„ä¸ªé¡¹ç›®çš„é…ç½®ã€‚ç”±äºå¯èƒ½ä¼šå­˜åœ¨ä¸åŒç»„ä¹‹é—´çš„ç›¸åŒé¡¹ç›®åï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥ç»„/é¡¹ç›®ä¸ºç›®å½•åˆ‡åˆ†èµ„æºé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶ä»¥yamlæ ¼å¼ä¸ºç»Ÿä¸€æ ‡å‡†ã€‚ 1234567891011121314âœ resource-libraries git:(master) tree.â”œâ”€â”€ README.MDâ”œâ”€â”€ resourcesâ”‚ â”œâ”€â”€ GamePlatformâ”‚ â”‚ â””â”€â”€ mcfx-admin.yamlâ”‚ â”œâ”€â”€ mc-game-adminâ”‚ â”‚ â””â”€â”€ om.yamlâ”‚ â””â”€â”€ mc-webappâ”‚ â””â”€â”€ testing-tools.yamlâ”œâ”€â”€ testsâ”‚ â””â”€â”€ test_mresource_load.groovyâ””â”€â”€ vars â””â”€â”€ mresource_load.groovy åŸºæœ¬ç»“æ„å¦‚ä¸‹ï¼š 123456789101112131415âœ resource-libraries git:(master) cat resources&#x2F;mc-webapp&#x2F;testing-tools.yamltype: &#39;normal&#39;git_credentials_id: &#39;basedev-git-account&#39;common: &amp;common directory: &#39;&#x2F;data&#x2F;webapp&#x2F;testing-tools&#39; deploy_ssh_id: &#39;basedev_tp_normal&#39;debug: address: &#39;192.168.8.29:61618&#39; &lt;&lt;: *commonproduction: address: &#39;192.168.8.93:61618&#39; &lt;&lt;: *common 1234567891011121314151617âœ resource-libraries git:(master) cat resources&#x2F;mc-game-admin&#x2F;om.yamltype: job_namegit_credentials_id: &#39;basedev_24_om&#39;debug_address: &amp;debug_address &#39;192.168.8.47:61618&#39;release_address: &amp;release_address &#39;192.168.8.47:61618&#39;deploy_ssh_id: &amp;deploy_ssh_id &#39;basedev_tp_normal&#39;basedev-m24-om: debug: address: *debug_address directory: &#39;&#x2F;data&#x2F;m24&#x2F;web&#x2F;om_debug&#39; deploy_ssh_id: *deploy_ssh_id production: address: *release_address directory: &#39;&#x2F;data&#x2F;m24&#x2F;web&#x2F;om&#39; deploy_ssh_id: *deploy_ssh_id (*)type normal æ™®é€šæ¨¡å¼ job_name job_name æ¨¡å¼ã€‚å¯¹äºä¸€ä¸ªä»£ç ä»“åº“ï¼Œéœ€è¦åˆ†é¡¹ç›®éƒ¨ç½²çš„æˆ‘ä»¬å®šä¹‰ä¸º job_name æ¨¡å¼ï¼Œè¿™ä¸ªçš„å¥½å¤„å°±æ˜¯ä¸åŒçš„é¡¹ç›®å¯ä»¥ä»¥åŒä¸€ä»½é…ç½®æ–‡ä»¶è¿›è¡Œä¸åŒçš„é…ç½®ç®¡ç† (*)git_credentials_id è¿™æ˜¯ checkout ä¸‹æ¥çš„ git å”¯ä¸€å‡­è¯ id common è¿™ä¸ªæ˜¯æ¨èä½†æ˜¯éå¿…é¡»å­˜åœ¨çš„ç»“æ„ï¼Œè¿™é‡Œå­˜æ”¾ä¸€äº›æˆ‘ä»¬åœ¨ä¸‹é¢å®šä¹‰çš„ä¸€äº›é€šç”¨é…ç½®æ¥å‡å°‘å†—ä½™ æ”¯æŒçš„ç¯å¢ƒ debug reviews production ç¯å¢ƒå¿…å¡«çš„å±æ€§å¦‚ä¸‹ address (ip+port) æ”¯æŒ string æ”¯æŒ list directory ä»£ç éƒ¨ç½²ç›®å½• æ”¯æŒ string æ”¯æŒ list deploy_ssh_id éƒ¨ç½²ä»£ç åˆ°æœåŠ¡çš„ ssh çš„å”¯ä¸€å‡­è¯ id ç”±ä»¥ä¸Šæ„æˆæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶çš„æ ¼å¼ã€‚ jenkins-shard-libraryè¿™ä¸ªå…±äº«åº“ç›´æ¥å½±å“åˆ°æˆ‘ä»¬çš„ jenkinsfile çš„å†™æ³•ï¼Œè¿™æ˜¯ç›´æ¥ä½œç”¨ä¸ jenkinsfile çš„å…±äº«åº“ï¼Œå…ˆæ¥ä¸€ä¸ªç›®å‰ jenkinsfile çš„å†™æ³•ï¼š 12345678910111213def link &#x3D; &#39;https:&#x2F;&#x2F;xxx.com&#x2F;mc-webapp&#x2F;testing-tools&#39;mpipeline&#123; repo&#x3D;link script&#x3D;this&#125;import xxx.jenkins.LaravelPipelinedef larvaelPipeline &#x3D; new LaravelPipeline(this)node &#123; larvaelPipeline.preBuild().build().debug().reviews().production().execute()&#125; è¿™å°±æ˜¯ç›®å‰çš„ jenkinsfile çš„å†™æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ª jenkinsfile æ²¡æœ‰å®šåˆ¶çš„ä¸œè¥¿ï¼Œé™¤äº†ä¸€ä¸ªlinkä»“åº“é“¾æ¥ä¹‹å¤–ï¼Œå…¶ä»–éƒ½æ˜¯å…¬ç”¨çš„å†…å®¹ã€‚æ¥ä¸‹æ¥è¯´ä¸€ä¸‹jenkinsfile-dsl è¿™ä¸ªä¸œè¥¿ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ jenkinsfile ä¸­çœ‹åˆ°çš„mpipelineçš„ç»“æ„ä½“ï¼Œè¿™ä¸ªæ˜¯ç”±äºæˆ‘ä»¬è¿™ä¸ªåº“æä¾›çš„ä¸€ä¸ªdslç»“æ„ï¼Œå¹¶éåŸå§‹ jenkinsfile æä¾›çš„æ‰€æœ‰çš„ jenkinsfile å¿…é¡»å­˜åœ¨è¿™ä¸ªdslï¼Œå¹¶ä¸”éœ€è¦å†™åœ¨æµç¨‹çš„å¤´éƒ¨ï¼Œä»¥ç¡®ä¿ jenkinsfile çš„åˆå§‹åŒ–å¯¹åº”çš„äº‹æƒ…ï¼ˆcheckout+ç¯å¢ƒå˜é‡+å…³é”®å­—åŠ è½½ï¼‰ ç›®å‰ï¼Œå°è£…äº†ä¸€ä¸ªåŸºäºlaravelé¡¹ç›®çš„ pipeline æ“ä½œç±»ï¼Œç”¨è¿™ä¸ªç±»æ¥è¿›è¡Œæµç¨‹çš„ç»Ÿä¸€åˆ›å»ºç®¡ç†ã€‚æœ€åæˆ‘ä»¬åœ¨ nodeç»“æ„ä¸­è¿›è¡Œæµç¨‹çš„ api è°ƒç”¨ã€‚ 12345678910111213141516171819202122232425262728293031323334âœ jenkins-shard-library git:(master) tree.â”œâ”€â”€ Jenkinsfile.exampleâ”œâ”€â”€ README.MDâ”œâ”€â”€ jarsâ”‚ â””â”€â”€ groovy-cps-1.1.jarâ”œâ”€â”€ resourcesâ”œâ”€â”€ srcâ”‚ â””â”€â”€ xxxâ”‚ â””â”€â”€ xxxâ”‚ â””â”€â”€ jenkinsâ”‚ â”œâ”€â”€ Constant.groovyâ”‚ â”œâ”€â”€ Deploy.groovyâ”‚ â”œâ”€â”€ Git.groovyâ”‚ â”œâ”€â”€ LaravelPipeline.groovyâ”‚ â”œâ”€â”€ MPipeline.groovyâ”‚ â”œâ”€â”€ MetlNotify.groovyâ”‚ â”œâ”€â”€ Repo.groovyâ”‚ â””â”€â”€ SummaryNotify.groovyâ”œâ”€â”€ testsâ”‚ â”œâ”€â”€ RepoTest.groovyâ”‚ â””â”€â”€ classfilesâ”‚ â””â”€â”€ xxxâ”‚ â””â”€â”€ xxxâ”‚ â””â”€â”€ jenkinsâ”‚ â”œâ”€â”€ Constant.classâ”‚ â”œâ”€â”€ Git.classâ”‚ â”œâ”€â”€ MPipeline.classâ”‚ â”œâ”€â”€ MetlNotify.classâ”‚ â”œâ”€â”€ Repo.classâ”‚ â””â”€â”€ SummaryNotify.classâ””â”€â”€ vars â”œâ”€â”€ mpipeline.groovy â””â”€â”€ notify.groovy è¯¦ç»†çš„å°±ä¸å¤šåšè®²è§£ï¼Œåªè¯´ä¸€äº›é‡è¦çš„ï¼ŒLaravelPipeline å¯¹å¤–æä¾›çš„ api æœ‰ï¼š preBuild() æ„å»ºå‰éœ€è¦åšçš„äº‹æƒ…ï¼Œä¾‹å¦‚å‘é€é€šçŸ¥ä»»åŠ¡å¼€å§‹ build(isParallel = true) æ„å»ºè¿‡ç¨‹ï¼Œå‚æ•°isParallel = trueæ˜¯å¦å¹¶è¡Œæ„å»º deployment(def sshId = null) éƒ¨ç½² apiï¼Œä¸»è¦æ˜¯æŠŠ debugï¼Œreviewsï¼Œproduction å†™åœ¨äº†ä¸€èµ· customDeploy(def closure = {}) è‡ªå®šä¹‰éƒ¨ç½²æµç¨‹ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œéœ€è¦å‚è€ƒå…±äº«åº“çš„å†™æ³• debug(def sshId) å¦‚æœæ˜¯å¯¹åº”çš„åˆ†æ”¯ï¼Œé‚£ä¹ˆå°†ä¼šéƒ¨ç½²åˆ° debug ç¯å¢ƒ reviews(def sshId) å¦‚æœæ˜¯å¯¹åº”çš„åˆ†æ”¯ï¼Œé‚£ä¹ˆå°†ä¼šéƒ¨ç½²åˆ° reviews ç¯å¢ƒ production(def sshId) å¦‚æœæ˜¯å¯¹åº”çš„åˆ†æ”¯ï¼Œé‚£ä¹ˆå°†ä¼šéƒ¨ç½²åˆ° production ç¯å¢ƒ show() è¿™æ˜¯ä¸€ä¸ªç”¨äºæŸ¥çœ‹æ„å»ºæµç¨‹çš„æ–¹æ³•ï¼Œå¹¶ä¸ä¼šçœŸæ­£è¿è¡Œå„ä¸ªç»“æ„çš„ stage é‡Œé¢çš„å†…å®¹ã€‚ä½†æ˜¯å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹è¿çº¿å›¾ execute(def config = [show: false]) è¿™æ˜¯ä¸€ä¸ªå¯åŠ¨æ‰§è¡Œçš„æ–¹æ³•ï¼Œå¦‚æœä¼ å…¥äº†å‚æ•° show=trueï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•ç­‰äº show æ–¹æ³• å¯¹äºå…¨å±€å…³é”®å­—çš„æä¾›æœ‰ï¼š mpipeline ç”¨äºåˆå§‹åŒ–æ•´ä¸ªéƒ¨ç½²æµç¨‹ï¼Œå…¶ä¸­åŒ…å«äº† checkout å’Œç¯å¢ƒå˜é‡ç­‰çš„åˆå§‹åŒ– notify ç”¨äºå‘é€é€šçŸ¥ æœ€ç»ˆçš„æ•ˆæœå¦‚ä¸‹ï¼š","categories":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/categories/DevOps/"}],"tags":[{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/tags/DevOps/"}]},{"title":"ã€Dockerã€‘docker-aplineçš„é—®é¢˜","slug":"docker/docker-aplineçš„é—®é¢˜","date":"2020-06-18T12:28:30.000Z","updated":"2021-03-20T16:25:01.805Z","comments":true,"path":"2020/06/18/docker/docker-aplineçš„é—®é¢˜/","link":"","permalink":"http://blog.crazylaw.cn/2020/06/18/docker/docker-apline%E7%9A%84%E9%97%AE%E9%A2%98/","excerpt":"å‰è¨€ä»Šå¤©é¢†å¯¼å‘ç°äº†ä¸€ä¸ªdockerçš„é—®é¢˜ï¼Œä»–åœ¨ç”¨aplineä½œä¸ºåŸºç¡€é•œåƒçš„æ—¶å€™ï¼Œåœ¨å…¬å¸çš„æœåŠ¡å™¨ä¸Šæ— æ³•ping baidu.com ä½†æ˜¯æˆ‘ä»¬å´æ˜¯èƒ½åœ¨nslookupä¸­è§£æåˆ°åŸŸåã€‚","text":"å‰è¨€ä»Šå¤©é¢†å¯¼å‘ç°äº†ä¸€ä¸ªdockerçš„é—®é¢˜ï¼Œä»–åœ¨ç”¨aplineä½œä¸ºåŸºç¡€é•œåƒçš„æ—¶å€™ï¼Œåœ¨å…¬å¸çš„æœåŠ¡å™¨ä¸Šæ— æ³•ping baidu.com ä½†æ˜¯æˆ‘ä»¬å´æ˜¯èƒ½åœ¨nslookupä¸­è§£æåˆ°åŸŸåã€‚ é—®é¢˜1. ping baidu.comåœ¨ç”¨aplineä½œä¸ºåŸºç¡€é•œåƒçš„æ—¶å€™ï¼Œå‘ç°æ— æ³•pingçš„æƒ…å†µï¼Œåœ¨æˆ‘ç¿»é˜…äº†ä¸€äº›æ–‡çŒ®çš„ã€‚è¯´åˆ°äº†docker-aplineæ˜¯ä»¥8.8.8.8Googleçš„dnsæœåŠ¡ä½œä¸ºé»˜è®¤ç½‘å…³ã€‚ åˆç”±äºæˆ‘å›½å…·æœ‰â€œå¢™â€çš„ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŒ‡å®šå›½å†…çš„dnsæœåŠ¡å™¨ï¼Œä¾‹å¦‚114.114.114.114ï¼Œä½†æ˜¯è¿™äº›å¹¶ä¸èƒ½è§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚ åˆæœ‰ä¸€äº›ç½‘å‹è¯´æ˜¯å› ä¸ºæˆ‘ä»¬è‡ªå·±çš„dnsç½‘å…³æœåŠ¡ä¸æ­£å¸¸å¯¼è‡´çš„ï¼Œä½†æ˜¯ç¡®å®æˆ‘ä»¬çš„dnsæœåŠ¡ä¸€ç›´å¾ˆæ­£å¸¸ã€‚ åŸºäºäº†è¿™äº›éƒ½ä¸èƒ½è§£å†³æˆ‘ä»¬é—®é¢˜ç‚¹ã€‚åŸºäºæ„Ÿè§‰åˆ°äº†æ²¡æœ‰ä»»ä½•å¸Œæœ›ã€‚ ä½†æ˜¯åæ¥è¿˜æ˜¯æ‰¾åˆ°äº†ä¸€äº›å¦ç±»çš„è§£å†³æ€è·¯ã€‚ ä¾‹å¦‚æœ‰ä¸€æ‰¹äººæåˆ°äº†/etc/resolve.confçš„ndotsçš„å‚æ•°ã€‚ äºæ˜¯å¥½å¥‡çš„æœç´¢äº†ä¸€äº›ndotsç›¸å…³çš„å†…å®¹ï¼Œå‘ç°è¿™ä¸ªæ˜¯ç”¨äºä¼˜åŒ–dnsè§£æé€Ÿåº¦çš„å‚æ•°ã€‚ ndotsoptions ndots:0 ç¨å¾®æœ‰ç‚¹éº»çƒ¦ï¼Œæˆ‘æŸ¥äº†ä¸€äº›èµ„æ–™ã€‚å¦‚æœéœ€è¦æŸ¥æ‰¾åŸŸåæ˜¯ç›¸å¯¹åŸŸåï¼Œä¸”è¯¥åŸŸåä¸­åŒ…å«çš„. çš„æ•°ç›®å¤§äºæˆ–ç­‰äº option ndots:${n}å‘½ä»¤æŒ‡å®šçš„æ•°ï¼Œåˆ™æŸ¥è¯¢çš„ä»…æ˜¯è¯¥åŸŸåã€‚å¦åˆ™ä¼šä¾æ¬¡å¾€ä¼ å…¥çš„åŸŸååè¿½åŠ  search åˆ—è¡¨ï¼ˆsearch åˆ—è¡¨åœ¨è¿™é‡Œæ²¡æœ‰ï¼Œè¯¦è§searchï¼‰ä¸­çš„åç¼€ï¼Œç›´åˆ°è§£æå‡ºipåœ°å€ï¼Œæˆ–è€…è§£æå®Œåˆ—è¡¨ä¸­æ‰€æœ‰åç¼€æ‰ä¼šåœæ­¢ã€‚è¿™é‡Œè®¾ç½®æˆ 0ï¼Œæ„æ€å°±æ˜¯å¯¹äºä¼ å…¥çš„ç›¸å¯¹åŸŸåï¼ŒåªæŸ¥è¯¢è¯¥åŸŸåã€‚ ä¸€èˆ¬ndotséƒ½æ˜¯5å³å¯ã€‚æœ€é«˜å°±æ˜¯15ã€‚ é»˜è®¤ï¼š1 12ndots:n Sets a threshold for the number of dots which must appear in a name given to res_query(3) (see resolver(3)) before an initial absolute query will be made. The default for n is 1, meaning that if there are any dots in a name, the name will be tried first as an absolute name before any search list elements are appended to it. The value for this option is silently capped to 15. äºæ˜¯æŠ±ç€å°è¯•çš„æ€åº¦ã€‚ æ²¡æœ‰åŠ å…¥å‚æ•°å‰ 12[root@webapp_public_S1_192.168.8.135_61618_A ~]# docker run -it --rm composer:2.0 ping baidu.comping: bad address 'baidu.com' åŠ å…¥å‚æ•°å 1234[root@webapp_public_S1_192.168.8.135_61618_A ~]# docker run -it --dns-opt&#x3D;ndots:5 --rm composer:2.0 ping baidu.comPING baidu.com (39.156.69.79): 56 data bytes64 bytes from 39.156.69.79: seq&#x3D;0 ttl&#x3D;43 time&#x3D;37.941 ms64 bytes from 39.156.69.79: seq&#x3D;1 ttl&#x3D;43 time&#x3D;37.891 ms ç¥å¥‡çš„ä¸€å¹•å‡ºç°äº†ï¼ŒdnsæœåŠ¡æ­£å¸¸è§£æäº†ã€‚äºæ˜¯å¯ä»¥ç¡®å®šndotsåœ¨è§£å†³aplineåŸŸåè§£æä¸Šæœ‰é‡è¦çš„ä½œç”¨ã€‚","categories":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/categories/Docker/"}],"tags":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/tags/Docker/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- dockeræ„å»ºåŸºäºHadoopçš„å¤§æ•°æ®ç”Ÿæ€","slug":"å¤§æ•°æ®/dockeræ„å»ºåŸºäºHadoopçš„å¤§æ•°æ®ç”Ÿæ€","date":"2020-06-16T10:07:40.000Z","updated":"2021-03-20T16:25:01.815Z","comments":true,"path":"2020/06/16/å¤§æ•°æ®/dockeræ„å»ºåŸºäºHadoopçš„å¤§æ•°æ®ç”Ÿæ€/","link":"","permalink":"http://blog.crazylaw.cn/2020/06/16/%E5%A4%A7%E6%95%B0%E6%8D%AE/docker%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8EHadoop%E7%9A%84%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81/","excerpt":"å‰è¨€ä¼—æ‰€å‘¨çŸ¥ï¼Œhadoopçš„å¤§æ•°æ®ç”Ÿæ€çš„ç»„ä»¶ç‰ˆæœ¬å¯¹ä¾èµ–ååˆ†çš„ç¹æ‚ï¼Œå¯¹æ­¤æˆ‘ä»¬åœ¨å¦‚æœéœ€è¦ç”¨apacheå¼€æºåº“æ¥ä¸€ç‚¹ç‚¹å †èµ·ç§¯æœ¨ï¼Œæœ‰ç‚¹ç¹çæˆ‘ä»¬è¿™ä¸ªé¡¹ç›®çš„ç›®çš„åªæ˜¯ä¸ºäº†æ›´å¿«æ›´æ–¹ä¾¿çš„æ„å»ºå¤§æ•°æ®ç”Ÿæ€ç¯å¢ƒã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œé€‰æ‹©é‡‡ç”¨cdhçš„æ–¹å¼æ¥æ„å»ºå¤§æ•°æ®ç”Ÿæ€ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬å¸Œæœ›åœ¨ç»ˆç«¯å°±éƒ¨ç½²å¥½æœåŠ¡ï¼Œè€Œä¸éœ€è¦å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸é€‰æ‹©ç”¨cmf","text":"å‰è¨€ä¼—æ‰€å‘¨çŸ¥ï¼Œhadoopçš„å¤§æ•°æ®ç”Ÿæ€çš„ç»„ä»¶ç‰ˆæœ¬å¯¹ä¾èµ–ååˆ†çš„ç¹æ‚ï¼Œå¯¹æ­¤æˆ‘ä»¬åœ¨å¦‚æœéœ€è¦ç”¨apacheå¼€æºåº“æ¥ä¸€ç‚¹ç‚¹å †èµ·ç§¯æœ¨ï¼Œæœ‰ç‚¹ç¹çæˆ‘ä»¬è¿™ä¸ªé¡¹ç›®çš„ç›®çš„åªæ˜¯ä¸ºäº†æ›´å¿«æ›´æ–¹ä¾¿çš„æ„å»ºå¤§æ•°æ®ç”Ÿæ€ç¯å¢ƒã€‚æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œé€‰æ‹©é‡‡ç”¨cdhçš„æ–¹å¼æ¥æ„å»ºå¤§æ•°æ®ç”Ÿæ€ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬å¸Œæœ›åœ¨ç»ˆç«¯å°±éƒ¨ç½²å¥½æœåŠ¡ï¼Œè€Œä¸éœ€è¦å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸é€‰æ‹©ç”¨cmf åŸºäºdockerçš„cdh6çš„å¤§æ•°æ®ç”Ÿæ€ åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥æ‰¾åˆ°ä½ éœ€è¦çš„ä¸œè¥¿ Hadoop Impala Hive Kudu æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šè®°å½•ä¸€ä¸‹æˆ‘åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€é‡åˆ°çš„ä¸€äº›é—®é¢˜ã€‚ é€‰æ‹©åº•å±‚é•œåƒ åº•å±‚æ“ä½œç³»ç»Ÿé•œåƒ 123456789101112131415161718192021222324FROM centos:7LABEL maintainer=\"Caiwenhui &lt;471113744@qq.com&gt;\"ENV JAVA_HOME /usr/lib/jvm/java-openjdk# æ¢é˜¿é‡Œäº‘æºRUN yum install -y wget;\\ wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo;\\ # ç§»é™¤é˜¿é‡Œå·²ç»ä¸ç”¨çš„åŸŸå sed -i '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo;\\ sed -i '/mirrors.cloud.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo;\\ yum clean all; \\ yum makecache# # å®‰è£…åŸºç¡€å¿…å¤‡è½¯ä»¶RUN yum update -y; \\ yum intall -y deltarpm;\\ yum install -y java-1.8.0-openjdk-devel unzip curl vim python-setuptools sudo; \\ yum clean all;\\ yum makecacheCMD [\"/bin/bash\"] åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åŸºäºçš„æ˜¯centos7åšæ“ä½œç³»ç»Ÿé•œåƒï¼Œå¹¶ä¸”åœ¨åŸºç¡€ä¸Šï¼Œæ›¿æ¢æˆäº†é˜¿é‡Œäº‘çš„yumçš„æ•°æ®æºï¼Œå¹¶ä¸”å®‰è£…å¥½äº†jdk8ï¼Œæ–¹ä¾¿åç»­éƒ¨ç½²æœåŠ¡ é€‰æ‹©åŸºç¡€é•œåƒ åŸºäºcdh6çš„åŸºç¡€é•œåƒ 123456789101112131415FROM ccinn/centos-openjdk:latestLABEL maintainer=\"Caiwenhui &lt;471113744@qq.com&gt;\"USER rootENV CDH_VERSION 6.3.2ADD cloudera-cdh6.repo /etc/yum.repos.d/RUN rpm --import https://archive.cloudera.com/cdh6/$CDH_VERSION/redhat7/yum/RPM-GPG-KEY-cloudera;\\ yum makecacheWORKDIR /CMD [\"/bin/bash\"] åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç›®å½•å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠcloudera-cdh6.repoæ”¾åœ¨yumçš„æºä¸­ï¼Œæ–¹ä¾¿æˆ‘ä»¬é€šè¿‡yumå®‰è£…æœåŠ¡ï¼Œå‡å°‘ä¸å¿…è¦çš„ä¾èµ–é—®é¢˜ æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹©çš„hadoop3çš„ç‰ˆæœ¬ æ„å»ºhadoopé•œåƒ åŸºäºåŸºç¡€é•œåƒçš„hadoopæœåŠ¡ 1234567891011121314FROM ccinn/cdh6:latestLABEL maintainer=\"Caiwenhui &lt;471113744@qq.com&gt;\"USER rootADD support.sh /support.shRUN source /support.sh;\\ loop_exec 'yum install -y hadoop'WORKDIR /CMD [\"/bin/bash\"] é—®é¢˜11234567891011Install 1 Package (+52 Dependent packages)Total download size: 712 MInstalled size: 856 MDownloading packages:https:&#x2F;&#x2F;archive.cloudera.com&#x2F;cdh6&#x2F;6.3.2&#x2F;redhat7&#x2F;yum&#x2F;RPMS&#x2F;x86_64&#x2F;hadoop-hdfs-3.0.0%2Bcdh6.3.2-1605554.el7.x86_64.rpm: [Errno 14] curl#18 - &quot;transfer closed with 23278968 bytes remaining to read&quot;Trying other mirror.https:&#x2F;&#x2F;archive.cloudera.com&#x2F;cdh6&#x2F;6.3.2&#x2F;redhat7&#x2F;yum&#x2F;RPMS&#x2F;x86_64&#x2F;hadoop-3.0.0%2Bcdh6.3.2-1605554.el7.x86_64.rpm: [Errno 14] curl#18 - &quot;transfer closed with 40971220 bytes remaining to read&quot;Trying other mirror.https:&#x2F;&#x2F;archive.cloudera.com&#x2F;cdh6&#x2F;6.3.2&#x2F;redhat7&#x2F;yum&#x2F;RPMS&#x2F;noarch&#x2F;hive-2.1.1%2Bcdh6.3.2-1605554.el7.noarch.rpm: [Errno 14] curl#18 - &quot;transfer closed with 123435828 bytes remaining to read&quot;Trying other mirror. æˆ‘è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªloop_execçš„å‡½æ•°ï¼ŒåŸå› æ˜¯å› ä¸ºå›½å†…çš„ç½‘ç»œè¿‡æ…¢ï¼Œä»¥åŠè½¯ä»¶åŒ…â€œè¿‡å¤§â€ï¼Œå¯¼è‡´yumåœ¨å®‰è£…åŒ…çš„æ—¶å€™ï¼Œä¼šå¯¼è‡´ä¼ è¾“ä¸­æ–­ï¼Œä½¿å¾—æˆ‘ä»¬æ— æ³•â€œä¸€æ­¥â€å®‰è£…åˆ°ä½ æ‰€ä»¥è¿™é‡Œæˆ‘å†™äº†ä¸€ä¸ªå¾ªç¯è°ƒç”¨çš„å‡½æ•°ï¼Œå› ä¸ºyumå®‰è£…è¿‡ç¨‹ä¸­æ˜¯å¯ä»¥æ–­ç‚¹ç»­ä¼ çš„ï¼Œæ‰€ä»¥æˆ‘åˆ©ç”¨è¿™ä¸ªå‡½æ•°æ¥æ‰§è¡Œå¤šå‡ æ¬¡è¿™ä¸ªå‘½ä»¤å³å¯ï¼Œç›´åˆ°å®‰è£…æˆåŠŸä¸ºæ­¢ ä¸€èˆ¬æˆ‘æ˜¯3æ¬¡å®‰è£…å®Œæ¯• é—®é¢˜2æˆ‘å‘ç°åŸæ¥hadoopåŒ…æ˜¯åŸºç¡€åŒ…è€Œå·²ï¼Œæˆ‘ä»¬è¿˜è¦å®‰è£…hadoop-namenode,hadoop-datanodeï¼Œå› æ­¤ã€‚æˆ‘åˆæ‰‹åŠ¨åœ¨å®¹å™¨ä¸­è°ƒè¯•äº†èµ·æ¥ã€‚ 1/usr/bin/hdfs --config /etc/hadoop/conf namenode 12345678910111213141516171819202122232425262728293031323334[root@25b603a089cc &#x2F;]# &#x2F;usr&#x2F;bin&#x2F;hdfs --config &#x2F;etc&#x2F;hadoop&#x2F;conf namenode2020-06-16 10:18:34,126 INFO namenode.NameNode: STARTUP_MSG:&#x2F;************************************************************STARTUP_MSG: Starting NameNodeSTARTUP_MSG: host &#x3D; 25b603a089cc&#x2F;172.17.0.3STARTUP_MSG: args &#x3D; []STARTUP_MSG: version &#x3D; 3.0.0-cdh6.3.2STARTUP_MSG: classpath &#x3D; &#x2F;etc&#x2F;hadoop&#x2F;conf:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-lang3-3.7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-beanutils-1.9.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;log4j-1.2.17.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-logging-1.1.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;re2j-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-core-asl-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jettison-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;guava-11.0.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;javax.activation-api-1.2.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;paranamer-2.8.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-util-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;slf4j-log4j12.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsr311-api-1.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;azure-data-lake-store-sdk-2.2.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-servlet-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jaxb-api-2.2.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;metrics-core-3.0.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;nimbus-jose-jwt-4.41.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;javax.servlet-api-3.1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;protobuf-java-2.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-math3-3.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-core-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-compress-1.18.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;accessors-smart-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;woodstox-core-5.0.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-io-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-xc-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-xml-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;curator-recipes-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-servlet-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-lang-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;audience-annotations-0.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-config-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-security-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-server-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;netty-3.10.6.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-admin-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-json-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-databind-2.9.9.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-core-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-jaxrs-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-asn1-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-configuration2-2.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-crypto-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;httpcore-4.4.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;log4j-core-2.8.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;json-smart-2.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;snappy-java-1.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-mapper-asl-1.9.13-cloudera.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-simplekdc-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;logredactor-2.0.7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;avro.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-annotations-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-client-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-server-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;curator-client-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-cli-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jcip-annotations-1.0-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-server-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-xdr-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-common-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;htrace-core4-4.1.0-incubating.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;aws-java-sdk-bundle-1.11.271.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-webapp-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;stax2-api-3.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;slf4j-api-1.7.25.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;log4j-api-2.8.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-io-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-pkix-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;curator-framework-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;gson-2.2.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsp-api-2.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;xz-1.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;zookeeper.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-http-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;wildfly-openssl-1.0.4.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-core-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-identity-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jaxb-impl-2.2.3-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-net-3.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jul-to-slf4j-1.7.25.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;asm-5.0.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsch-0.1.54.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsr305-3.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-collections-3.2.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;httpclient-4.5.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-codec-1.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-format-javadoc.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-auth-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-jackson.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure-datalake.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-format.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-aws-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure-datalake-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-protobuf.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-annotations-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-auth.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-aws.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-scala_2.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-nfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-annotations.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-pig.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-pig-bundle.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-hadoop-bundle.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-kms.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-kms-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-cascading.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-generator.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-hadoop.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-avro.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-format-sources.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-column.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-thrift.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-encoding.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-nfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-cascading3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-lang3-3.7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-beanutils-1.9.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;log4j-1.2.17.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-logging-1.1.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;re2j-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-core-asl-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jettison-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;guava-11.0.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;javax.activation-api-1.2.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;paranamer-2.8.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-util-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jsr311-api-1.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-servlet-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jaxb-api-2.2.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;nimbus-jose-jwt-4.41.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;javax.servlet-api-3.1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;protobuf-java-2.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;okio-1.6.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-math3-3.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-core-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-compress-1.18.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;accessors-smart-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;woodstox-core-5.0.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-io-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-xc-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-xml-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;curator-recipes-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-servlet-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-lang-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;json-simple-1.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;avro-1.8.2-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;audience-annotations-0.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-config-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-security-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-server-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;zookeeper-3.4.5-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;netty-3.10.6.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-admin-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-json-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-databind-2.9.9.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-core-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-jaxrs-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-asn1-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-configuration2-2.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-crypto-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;httpcore-4.4.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;json-smart-2.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;snappy-java-1.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-mapper-asl-1.9.13-cloudera.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-simplekdc-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-annotations-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-client-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-server-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;curator-client-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-cli-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jcip-annotations-1.0-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-server-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-xdr-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-common-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;htrace-core4-4.1.0-incubating.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-webapp-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;stax2-api-3.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-io-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-pkix-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;curator-framework-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-daemon-1.0.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;gson-2.2.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;leveldbjni-all-1.8.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;xz-1.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-http-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;okhttp-2.7.5.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-util-ajax-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-core-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-identity-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jaxb-impl-2.2.3-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-net-3.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;asm-5.0.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jsch-0.1.54.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jsr305-3.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-collections-3.2.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;httpclient-4.5.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-codec-1.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-nfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-nfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-httpfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-httpfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-examples-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-openstack.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-aliyun.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-core.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-extras-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-uploader.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-openstack-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-distcp.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs-plugins-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-sls.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-uploader-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-kafka.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-datajoin-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-buffer-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-common-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-gridmix-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;jdom-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-examples.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-kafka-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-codec-http-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-rumen-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-app.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-extras.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-streaming-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;lz4-java-1.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;aliyun-sdk-oss-2.8.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-app-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-datajoin.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;azure-storage-5.4.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-nativetask-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-distcp-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs-plugins.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-shuffle-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-aliyun-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;kafka-clients-2.2.1-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;ojalgo-43.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-shuffle.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-gridmix.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-resolver-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-resourceestimator-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-rumen.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;azure-keyvault-core-0.8.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-codec-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-nativetask.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-transport-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-sls-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-resourceestimator.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archives.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archives-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-handler-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-core-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archive-logs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;zstd-jni-1.3.8-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-streaming.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archive-logs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jackson-jaxrs-json-provider-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;guice-servlet-4.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jackson-module-jaxb-annotations-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jersey-client-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;objenesis-1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;guice-4.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jackson-jaxrs-base-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;metrics-core-3.0.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;java-util-1.9.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;fst-2.50.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;javax.inject-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;geronimo-jcache_1.0_spec-1.0-alpha-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;json-io-2.5.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;HikariCP-java7-2.4.12.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;bcprov-jdk15on-1.60.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;ehcache-3.3.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;bcpkix-jdk15on-1.60.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;aopalliance-1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jersey-guice-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;mssql-jdbc-6.2.1.jre7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-applicationhistoryservice-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-registry-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-tests-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-sharedcachemanager-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-client-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-applicationhistoryservice.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-unmanaged-am-launcher-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-resourcemanager.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-resourcemanager-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-timeline-pluginstorage.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-distributedshell.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-router-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-client.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-web-proxy-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-sharedcachemanager.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-web-proxy.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-router.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-api-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-nodemanager-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-registry.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-distributedshell-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-timeline-pluginstorage-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-api.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-unmanaged-am-launcher.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-nodemanager.jarSTARTUP_MSG: build &#x3D; http:&#x2F;&#x2F;github.com&#x2F;cloudera&#x2F;hadoop -r 9aff20de3b5ecccf3c19d57f71b214fb4d37ee89; compiled by &#39;jenkins&#39; on 2019-11-08T13:49ZSTARTUP_MSG: java &#x3D; 1.8.0_252************************************************************&#x2F;2020-06-16 10:18:34,143 INFO namenode.NameNode: registered UNIX signal handlers for [TERM, HUP, INT]2020-06-16 10:18:34,296 INFO namenode.NameNode: createNameNode []2020-06-16 10:18:34,497 INFO impl.MetricsConfig: Loaded properties from hadoop-metrics2.properties2020-06-16 10:18:34,709 INFO impl.MetricsSystemImpl: Scheduled Metric snapshot period at 10 second(s).2020-06-16 10:18:34,709 INFO impl.MetricsSystemImpl: NameNode metrics system started2020-06-16 10:18:34,764 INFO namenode.NameNode: fs.defaultFS is file:&#x2F;&#x2F;&#x2F;2020-06-16 10:18:34,972 ERROR namenode.NameNode: Failed to start namenode.java.lang.IllegalArgumentException: Invalid URI for NameNode address (check fs.defaultFS): file:&#x2F;&#x2F;&#x2F; has no authority. at org.apache.hadoop.hdfs.DFSUtilClient.getNNAddress(DFSUtilClient.java:646) at org.apache.hadoop.hdfs.DFSUtilClient.getNNAddressCheckLogical(DFSUtilClient.java:675) at org.apache.hadoop.hdfs.DFSUtilClient.getNNAddress(DFSUtilClient.java:637) at org.apache.hadoop.hdfs.server.namenode.NameNode.getRpcServerAddress(NameNode.java:562) at org.apache.hadoop.hdfs.server.namenode.NameNode.loginAsNameNodeUser(NameNode.java:693) at org.apache.hadoop.hdfs.server.namenode.NameNode.initialize(NameNode.java:713) at org.apache.hadoop.hdfs.server.namenode.NameNode.&lt;init&gt;(NameNode.java:950) at org.apache.hadoop.hdfs.server.namenode.NameNode.&lt;init&gt;(NameNode.java:929) at org.apache.hadoop.hdfs.server.namenode.NameNode.createNameNode(NameNode.java:1653) at org.apache.hadoop.hdfs.server.namenode.NameNode.main(NameNode.java:1720)2020-06-16 10:18:34,983 INFO util.ExitUtil: Exiting with status 1: java.lang.IllegalArgumentException: Invalid URI for NameNode address (check fs.defaultFS): file:&#x2F;&#x2F;&#x2F; has no authority.2020-06-16 10:18:34,988 INFO namenode.NameNode: SHUTDOWN_MSG:&#x2F;************************************************************SHUTDOWN_MSG: Shutting down NameNode at 25b603a089cc&#x2F;172.17.0.3************************************************************&#x2F; æˆ‘ä»¥å‰å°çš„æ–¹å¼å¯åŠ¨æœåŠ¡ï¼Œå‘ç°æœåŠ¡å¹¶æ²¡æœ‰å¯åŠ¨æˆåŠŸï¼Œä»–å‘Šè¯‰æˆ‘æ£€æŸ¥fs.defaultFSå‚æ•° 12345678910111213141516171819202122[root@25b603a089cc &#x2F;]# cat &#x2F;etc&#x2F;hadoop&#x2F;conf&#x2F;core-site.xml&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&lt;!-- Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements. See the NOTICE file distributed with this work for additional information regarding copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with the License. You may obtain a copy of the License at http:&#x2F;&#x2F;www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0 Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.--&gt;&lt;?xml-stylesheet type&#x3D;&quot;text&#x2F;xsl&quot; href&#x3D;&quot;configuration.xsl&quot;?&gt;&lt;configuration&gt;&lt;&#x2F;configuration&gt; äºæ˜¯æˆ‘å‘ç°åŸæ¥è¿™ä¸ªcore-siteæ–‡ä»¶é»˜è®¤æ˜¯ä»€ä¹ˆé…ç½®éƒ½æ²¡æœ‰çš„ã€‚äºæ˜¯æˆ‘éœ€è¦æ‰‹åŠ¨åŠ ä¸Šä¸€äº›é…ç½®ã€‚ åœ¨è¿™é‡Œé¡ºå¸¦è¯´æ˜ä¸€ä¸‹é…ç½®ä¿¡æ¯ã€‚ å…·ä½“çš„å‚æ•°é…ç½®è¯·å‚è§ &gt;&gt; hadoop3-é»˜è®¤é…ç½®å‚æ•° &lt;&lt;&lt; åœ¨hadoopé›†ç¾¤ä¸­ï¼Œéœ€è¦é…ç½®çš„æ–‡ä»¶ä¸»è¦åŒ…æ‹¬å››ä¸ªï¼Œåˆ†åˆ«æ˜¯core-site.xmlã€hdfs-site.xmlã€mapred-site.xmlå’Œyarn-site.xmlï¼Œè¿™å››ä¸ªæ–‡ä»¶åˆ†åˆ«æ˜¯å¯¹ä¸åŒç»„ä»¶çš„é…ç½®å‚æ•°ï¼Œä¸»è¦å†…å®¹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š é…ç½®æ–‡ä»¶å é…ç½®å¯¹è±¡ ä¸»è¦å†…å®¹ core-site.xml é›†ç¾¤å…¨å±€å‚æ•° ç”¨äºå®šä¹‰ç³»ç»Ÿçº§åˆ«çš„å‚æ•°ï¼Œå¦‚HDFS URLã€Hadoopçš„ä¸´æ—¶ç›®å½•ç­‰ hdfs-site.xml HDFSå‚æ•° å¦‚åç§°èŠ‚ç‚¹å’Œæ•°æ®èŠ‚ç‚¹çš„å­˜æ”¾ä½ç½®ã€æ–‡ä»¶å‰¯æœ¬çš„ä¸ªæ•°ã€æ–‡ä»¶è¯»å–æƒé™ç­‰ mapred-site.xml Mapreduceå‚æ•° åŒ…æ‹¬JobHistory Serverå’Œåº”ç”¨ç¨‹åºå‚æ•°ä¸¤éƒ¨åˆ†ï¼Œå¦‚reduceä»»åŠ¡çš„é»˜è®¤ä¸ªæ•°ã€ä»»åŠ¡æ‰€èƒ½å¤Ÿä½¿ç”¨å†…å­˜çš„é»˜è®¤ä¸Šä¸‹é™ç­‰ yarn-site.xml é›†ç¾¤èµ„æºç®¡ç†ç³»ç»Ÿå‚æ•° é…ç½® ResourceManagerï¼ŒNodeManager çš„é€šä¿¡ç«¯å£ï¼Œwebç›‘æ§ç«¯å£ç­‰ æ­å»ºé›†ç¾¤é…ç½®æ—¶é‡è¦å‚æ•°ï¼š core-site.xml å‚æ•°å é»˜è®¤å€¼ å‚æ•°è§£é‡Š fs.defaultFS file:/// æ–‡ä»¶ç³»ç»Ÿä¸»æœºå’Œç«¯å£ io.file.buffer.size 4096 æµæ–‡ä»¶çš„ç¼“å†²åŒºå¤§å° hadoop.tmp.dir /tmp/hadoop-${user.name} ä¸´æ—¶æ–‡ä»¶å¤¹ hdfs-site.xml å‚æ•°å é»˜è®¤å€¼ å‚æ•°è§£é‡Š dfs.namenode.secondary.http-address 0.0.0.0:50090 å®šä¹‰HDFSå¯¹åº”çš„HTTPæœåŠ¡å™¨åœ°å€å’Œç«¯å£ dfs.namenode.name.dir file://${hadoop.tmp.dir}/dfs/name å®šä¹‰DFSçš„åç§°èŠ‚ç‚¹åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„ä½ç½® dfs.datanode.data.dir file://${hadoop.tmp.dir}/dfs/data å®šä¹‰DFSæ•°æ®èŠ‚ç‚¹å­˜å‚¨æ•°æ®å—æ—¶å­˜å‚¨åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿçš„ä½ç½® dfs.replication 3 ç¼ºçœçš„å—å¤åˆ¶æ•°é‡ dfs.webhdfs.enabled true æ˜¯å¦é€šè¿‡httpåè®®è¯»å–hdfsæ–‡ä»¶ï¼Œå¦‚æœé€‰æ˜¯ï¼Œåˆ™é›†ç¾¤å®‰å…¨æ€§è¾ƒå·® mapred-site.xml å‚æ•°å é»˜è®¤å€¼ å‚æ•°è§£é‡Š mapreduce.framework.name local å–å€¼localã€classicæˆ–yarnå…¶ä¸­ä¹‹ä¸€ï¼Œå¦‚æœä¸æ˜¯yarnï¼Œåˆ™ä¸ä¼šä½¿ç”¨YARNé›†ç¾¤æ¥å®ç°èµ„æºçš„åˆ†é… mapreduce.jobhistory.address 0.0.0.0:10020 å®šä¹‰å†å²æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£ï¼Œé€šè¿‡å†å²æœåŠ¡å™¨æŸ¥çœ‹å·²ç»è¿è¡Œå®Œçš„Mapreduceä½œä¸šè®°å½• mapreduce.jobhistory.webapp.address 0.0.0.0:19888 å®šä¹‰å†å²æœåŠ¡å™¨webåº”ç”¨è®¿é—®çš„åœ°å€å’Œç«¯å£ yarn-site.xml å‚æ•°å é»˜è®¤å€¼ å‚æ•°è§£é‡Š yarn.resourcemanager.address 0.0.0.0:8032 ResourceManager æä¾›ç»™å®¢æˆ·ç«¯è®¿é—®çš„åœ°å€ã€‚å®¢æˆ·ç«¯é€šè¿‡è¯¥åœ°å€å‘RMæäº¤åº”ç”¨ç¨‹åºï¼Œæ€æ­»åº”ç”¨ç¨‹åºç­‰ yarn.resourcemanager.scheduler.address 0.0.0.0:8030 ResourceManageræä¾›ç»™ApplicationMasterçš„è®¿é—®åœ°å€ã€‚ApplicationMasteré€šè¿‡è¯¥åœ°å€å‘RMç”³è¯·èµ„æºã€é‡Šæ”¾èµ„æºç­‰ yarn.resourcemanager.resource-tracker.address 0.0.0.0:8031 ResourceManager æä¾›ç»™NodeManagerçš„åœ°å€ã€‚NodeManageré€šè¿‡è¯¥åœ°å€å‘RMæ±‡æŠ¥å¿ƒè·³ï¼Œé¢†å–ä»»åŠ¡ç­‰ yarn.resourcemanager.webapp.address 0.0.0.0:8088 ResourceManagerå¯¹web æœåŠ¡æä¾›åœ°å€ã€‚ç”¨æˆ·å¯é€šè¿‡è¯¥åœ°å€åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹é›†ç¾¤å„ç±»ä¿¡æ¯ yarn.nodemanager.aux-services é€šè¿‡è¯¥é…ç½®é¡¹ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ä¸€äº›æœåŠ¡ï¼Œä¾‹å¦‚Map-Reduceçš„shuffleåŠŸèƒ½å°±æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼å®ç°çš„ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨NodeManagerä¸Šæ‰©å±•è‡ªå·±çš„æœåŠ¡ã€‚ åŸºäºä»¥ä¸Šä¿¡æ¯ã€‚ æ•´ç†ä¸€ä»½é…ç½®å¦‚ä¸‹ï¼š core-site.xml 123456789101112131415161718&lt;configuration&gt; &lt;property&gt; &lt;name&gt;fs.defaultFS&lt;/name&gt; &lt;value&gt;hdfs://0.0.0.0:8020&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;hadoop.proxyuser.hue.hosts&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;hadoop.proxyuser.hue.groups&lt;/name&gt; &lt;value&gt;*&lt;/value&gt; &lt;/property&gt; &lt;property&gt; &lt;name&gt;io.compression.codecs&lt;/name&gt; &lt;value&gt;org.apache.hadoop.io.compress.SnappyCodec&lt;/value&gt; &lt;/property&gt;&lt;/configuration&gt; hdfs-site.xml 1234567891011&lt;configuration&gt; &lt;property&gt; &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt; &lt;value&gt;file:///var/lib/hadoop-hdfs/cache/hdfs/dfs/name&lt;/value&gt; &lt;/property&gt; &lt;!-- CLOUDERA-BUILD: CDH-64745. --&gt; &lt;property&gt; &lt;name&gt;cloudera.erasure_coding.enabled&lt;/name&gt; &lt;value&gt;true&lt;/value&gt; &lt;/property&gt;&lt;/configuration&gt; æ¥ç€ï¼Œæˆ‘ä»¬å°è¯•å¯åŠ¨æœåŠ¡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135[root@25b603a089cc &#x2F;]# sudo &#x2F;usr&#x2F;bin&#x2F;hdfs --config &#x2F;etc&#x2F;hadoop&#x2F;conf namenode2020-06-16 15:55:52,251 INFO namenode.NameNode: STARTUP_MSG:&#x2F;************************************************************STARTUP_MSG: Starting NameNodeSTARTUP_MSG: host &#x3D; 25b603a089cc&#x2F;172.17.0.3STARTUP_MSG: args &#x3D; []STARTUP_MSG: version &#x3D; 3.0.0-cdh6.3.2STARTUP_MSG: classpath &#x3D; &#x2F;etc&#x2F;hadoop&#x2F;conf:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-lang3-3.7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-beanutils-1.9.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;log4j-1.2.17.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-logging-1.1.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;re2j-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-core-asl-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jettison-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;guava-11.0.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;javax.activation-api-1.2.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;paranamer-2.8.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-util-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;slf4j-log4j12.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsr311-api-1.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;azure-data-lake-store-sdk-2.2.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-servlet-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jaxb-api-2.2.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;metrics-core-3.0.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;nimbus-jose-jwt-4.41.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;javax.servlet-api-3.1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;protobuf-java-2.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-math3-3.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-core-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-compress-1.18.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;accessors-smart-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;woodstox-core-5.0.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-io-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-xc-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-xml-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;curator-recipes-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-servlet-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-lang-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;audience-annotations-0.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-config-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-security-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-server-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;netty-3.10.6.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-admin-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-json-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-databind-2.9.9.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-core-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-jaxrs-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-asn1-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-configuration2-2.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-crypto-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;httpcore-4.4.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;log4j-core-2.8.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;json-smart-2.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;snappy-java-1.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-mapper-asl-1.9.13-cloudera.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-simplekdc-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;logredactor-2.0.7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;avro.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-annotations-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-client-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jersey-server-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;curator-client-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-cli-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jcip-annotations-1.0-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-server-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-xdr-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-common-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;htrace-core4-4.1.0-incubating.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;aws-java-sdk-bundle-1.11.271.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-webapp-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;stax2-api-3.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;slf4j-api-1.7.25.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;log4j-api-2.8.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-io-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerby-pkix-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;curator-framework-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;gson-2.2.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsp-api-2.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;xz-1.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;zookeeper.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jetty-http-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;wildfly-openssl-1.0.4.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jackson-core-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;kerb-identity-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jaxb-impl-2.2.3-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-net-3.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jul-to-slf4j-1.7.25.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;asm-5.0.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsch-0.1.54.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;jsr305-3.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-collections-3.2.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;httpclient-4.5.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;lib&#x2F;commons-codec-1.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-format-javadoc.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-auth-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-jackson.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure-datalake.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-format.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-aws-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure-datalake-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-protobuf.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-annotations-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-auth.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-aws.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-scala_2.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-nfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-annotations.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-pig.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-pig-bundle.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-hadoop-bundle.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-kms.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-kms-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-cascading.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-generator.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-azure-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-hadoop.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-avro.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-common-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-format-sources.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-column.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-thrift.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-encoding.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;hadoop-nfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop&#x2F;.&#x2F;&#x2F;parquet-cascading3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-lang3-3.7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-beanutils-1.9.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;log4j-1.2.17.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-logging-1.1.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;re2j-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-core-asl-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jettison-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;guava-11.0.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;javax.activation-api-1.2.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;paranamer-2.8.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-util-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jsr311-api-1.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-servlet-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jaxb-api-2.2.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;nimbus-jose-jwt-4.41.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;javax.servlet-api-3.1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;protobuf-java-2.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;okio-1.6.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-math3-3.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-core-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-compress-1.18.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;accessors-smart-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;woodstox-core-5.0.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-io-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-xc-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-xml-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;curator-recipes-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-servlet-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-lang-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;json-simple-1.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;avro-1.8.2-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;audience-annotations-0.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-config-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-security-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-server-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;zookeeper-3.4.5-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;netty-3.10.6.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-admin-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-json-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-databind-2.9.9.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-core-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-jaxrs-1.9.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-asn1-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-configuration2-2.1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-crypto-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;httpcore-4.4.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;json-smart-2.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;snappy-java-1.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-mapper-asl-1.9.13-cloudera.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-simplekdc-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-annotations-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-client-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jersey-server-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;curator-client-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-cli-1.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jcip-annotations-1.0-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-server-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-xdr-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-common-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;htrace-core4-4.1.0-incubating.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-util-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-webapp-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;stax2-api-3.1.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-io-2.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerby-pkix-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;curator-framework-2.12.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-daemon-1.0.13.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;gson-2.2.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;leveldbjni-all-1.8.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;xz-1.6.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-http-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;okhttp-2.7.5.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jetty-util-ajax-9.3.25.v20180904.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jackson-core-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;kerb-identity-1.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jaxb-impl-2.2.3-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-net-3.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;asm-5.0.4.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jsch-0.1.54.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;jsr305-3.0.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-collections-3.2.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;httpclient-4.5.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;lib&#x2F;commons-codec-1.11.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-nfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-nfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-httpfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-httpfs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-native-client-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;.&#x2F;&#x2F;hadoop-hdfs-client.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-examples-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-openstack.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-aliyun.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-core.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-extras-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-uploader.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-openstack-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-distcp.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs-plugins-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-sls.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-uploader-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-kafka.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-datajoin-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-buffer-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-common-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient-3.0.0-cdh6.3.2-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-gridmix-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;jdom-1.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-examples.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-kafka-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-codec-http-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-rumen-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-app.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-extras.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-streaming-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;lz4-java-1.5.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;aliyun-sdk-oss-2.8.3.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-app-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-datajoin.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;azure-storage-5.4.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-nativetask-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-distcp-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs-plugins.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-shuffle-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-aliyun-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;kafka-clients-2.2.1-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;ojalgo-43.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-shuffle.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-gridmix.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-hs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-jobclient-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-resolver-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-resourceestimator-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-rumen.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;azure-keyvault-core-0.8.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-codec-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-nativetask.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-transport-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-sls-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-resourceestimator.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archives.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archives-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;netty-handler-4.1.17.Final.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-mapreduce-client-core-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archive-logs.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;zstd-jni-1.3.8-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-streaming.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-mapreduce&#x2F;.&#x2F;&#x2F;hadoop-archive-logs-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jackson-jaxrs-json-provider-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;guice-servlet-4.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jackson-module-jaxb-annotations-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jersey-client-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;objenesis-1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;guice-4.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jackson-jaxrs-base-2.9.9.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;metrics-core-3.0.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;java-util-1.9.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;fst-2.50.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;javax.inject-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;geronimo-jcache_1.0_spec-1.0-alpha-1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;json-io-2.5.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;HikariCP-java7-2.4.12.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;bcprov-jdk15on-1.60.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;ehcache-3.3.1.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;bcpkix-jdk15on-1.60.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;aopalliance-1.0.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;jersey-guice-1.19.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;lib&#x2F;mssql-jdbc-6.2.1.jre7.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-applicationhistoryservice-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-registry-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-tests-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-sharedcachemanager-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-client-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-applicationhistoryservice.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-unmanaged-am-launcher-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-resourcemanager.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-common.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-resourcemanager-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-timeline-pluginstorage.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-distributedshell.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-tests.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-router-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-client.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-common-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-web-proxy-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-sharedcachemanager.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-web-proxy.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-router.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-api-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-nodemanager-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-registry.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-distributedshell-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-timeline-pluginstorage-3.0.0-cdh6.3.2.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-api.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-applications-unmanaged-am-launcher.jar:&#x2F;usr&#x2F;lib&#x2F;hadoop-yarn&#x2F;.&#x2F;&#x2F;hadoop-yarn-server-nodemanager.jarSTARTUP_MSG: build &#x3D; http:&#x2F;&#x2F;github.com&#x2F;cloudera&#x2F;hadoop -r 9aff20de3b5ecccf3c19d57f71b214fb4d37ee89; compiled by &#39;jenkins&#39; on 2019-11-08T13:49ZSTARTUP_MSG: java &#x3D; 1.8.0_252************************************************************&#x2F;2020-06-16 15:55:52,271 INFO namenode.NameNode: registered UNIX signal handlers for [TERM, HUP, INT]2020-06-16 15:55:52,438 INFO namenode.NameNode: createNameNode []2020-06-16 15:55:52,671 INFO impl.MetricsConfig: Loaded properties from hadoop-metrics2.properties2020-06-16 15:55:52,908 INFO impl.MetricsSystemImpl: Scheduled Metric snapshot period at 10 second(s).2020-06-16 15:55:52,909 INFO impl.MetricsSystemImpl: NameNode metrics system started2020-06-16 15:55:52,970 INFO namenode.NameNode: fs.defaultFS is hdfs:&#x2F;&#x2F;0.0.0.0:80202020-06-16 15:55:52,977 INFO namenode.NameNode: Clients are to use 0.0.0.0:8020 to access this namenode&#x2F;service.2020-06-16 15:55:53,268 INFO util.JvmPauseMonitor: Starting JVM pause monitor2020-06-16 15:55:53,317 INFO hdfs.DFSUtil: Starting Web-server for hdfs at: http:&#x2F;&#x2F;0.0.0.0:98702020-06-16 15:55:53,363 INFO util.log: Logging initialized @2085ms2020-06-16 15:55:53,573 INFO server.AuthenticationFilter: Unable to initialize FileSignerSecretProvider, falling back to use random secrets.2020-06-16 15:55:53,606 INFO http.HttpRequestLog: Http request log for http.requests.namenode is not defined2020-06-16 15:55:53,629 INFO http.HttpServer2: Added global filter &#39;safety&#39; (class&#x3D;org.apache.hadoop.http.HttpServer2$QuotingInputFilter)2020-06-16 15:55:53,635 INFO http.HttpServer2: Added filter static_user_filter (class&#x3D;org.apache.hadoop.http.lib.StaticUserWebFilter$StaticUserFilter) to context hdfs2020-06-16 15:55:53,635 INFO http.HttpServer2: Added filter static_user_filter (class&#x3D;org.apache.hadoop.http.lib.StaticUserWebFilter$StaticUserFilter) to context static2020-06-16 15:55:53,635 INFO http.HttpServer2: Added filter static_user_filter (class&#x3D;org.apache.hadoop.http.lib.StaticUserWebFilter$StaticUserFilter) to context logs2020-06-16 15:55:53,697 INFO http.HttpServer2: Added filter &#39;org.apache.hadoop.hdfs.web.AuthFilter&#39; (class&#x3D;org.apache.hadoop.hdfs.web.AuthFilter)2020-06-16 15:55:53,700 INFO http.HttpServer2: addJerseyResourcePackage: packageName&#x3D;org.apache.hadoop.hdfs.server.namenode.web.resources;org.apache.hadoop.hdfs.web.resources, pathSpec&#x3D;&#x2F;webhdfs&#x2F;v1&#x2F;*2020-06-16 15:55:53,738 INFO http.HttpServer2: Jetty bound to port 98702020-06-16 15:55:53,747 INFO server.Server: jetty-9.3.25.v20180904, build timestamp: 2018-09-04T21:11:46Z, git hash: 3ce520221d0240229c862b122d2b06c12a6257322020-06-16 15:55:53,858 INFO handler.ContextHandler: Started o.e.j.s.ServletContextHandler@7bba5817&#123;&#x2F;logs,file:&#x2F;&#x2F;&#x2F;var&#x2F;log&#x2F;hadoop-hdfs&#x2F;,AVAILABLE&#125;2020-06-16 15:55:53,859 INFO handler.ContextHandler: Started o.e.j.s.ServletContextHandler@75437611&#123;&#x2F;static,file:&#x2F;&#x2F;&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;webapps&#x2F;static&#x2F;,AVAILABLE&#125;2020-06-16 15:55:54,026 INFO handler.ContextHandler: Started o.e.j.w.WebAppContext@20bd8be5&#123;&#x2F;,file:&#x2F;&#x2F;&#x2F;usr&#x2F;lib&#x2F;hadoop-hdfs&#x2F;webapps&#x2F;hdfs&#x2F;,AVAILABLE&#125;&#123;&#x2F;hdfs&#125;2020-06-16 15:55:54,041 INFO server.AbstractConnector: Started ServerConnector@24105dc5&#123;HTTP&#x2F;1.1,[http&#x2F;1.1]&#125;&#123;0.0.0.0:9870&#125;2020-06-16 15:55:54,041 INFO server.Server: Started @2764ms2020-06-16 15:55:54,394 WARN namenode.FSNamesystem: Only one image storage directory (dfs.namenode.name.dir) configured. Beware of data loss due to lack of redundant storage directories!2020-06-16 15:55:54,395 WARN namenode.FSNamesystem: Only one namespace edits storage directory (dfs.namenode.edits.dir) configured. Beware of data loss due to lack of redundant storage directories!2020-06-16 15:55:54,533 INFO namenode.FSEditLog: Edit logging is async:true2020-06-16 15:55:54,560 INFO namenode.FSNamesystem: KeyProvider: null2020-06-16 15:55:54,563 INFO namenode.FSNamesystem: fsLock is fair: true2020-06-16 15:55:54,564 INFO namenode.FSNamesystem: Detailed lock hold time metrics enabled: false2020-06-16 15:55:54,583 INFO namenode.FSNamesystem: fsOwner &#x3D; root (auth:SIMPLE)2020-06-16 15:55:54,583 INFO namenode.FSNamesystem: supergroup &#x3D; supergroup2020-06-16 15:55:54,583 INFO namenode.FSNamesystem: isPermissionEnabled &#x3D; true2020-06-16 15:55:54,584 INFO namenode.FSNamesystem: HA Enabled: false2020-06-16 15:55:54,683 INFO common.Util: dfs.datanode.fileio.profiling.sampling.percentage set to 0. Disabling file IO profiling2020-06-16 15:55:54,712 INFO blockmanagement.DatanodeManager: dfs.block.invalidate.limit: configured&#x3D;1000, counted&#x3D;60, effected&#x3D;10002020-06-16 15:55:54,713 INFO blockmanagement.DatanodeManager: dfs.namenode.datanode.registration.ip-hostname-check&#x3D;true2020-06-16 15:55:54,722 INFO blockmanagement.BlockManager: dfs.namenode.startup.delay.block.deletion.sec is set to 000:00:00:00.0002020-06-16 15:55:54,723 INFO blockmanagement.BlockManager: The block deletion will start around 2020 Jun 16 15:55:542020-06-16 15:55:54,727 INFO util.GSet: Computing capacity for map BlocksMap2020-06-16 15:55:54,727 INFO util.GSet: VM type &#x3D; 64-bit2020-06-16 15:55:54,732 INFO util.GSet: 2.0% max memory 876.5 MB &#x3D; 17.5 MB2020-06-16 15:55:54,732 INFO util.GSet: capacity &#x3D; 2^21 &#x3D; 2097152 entries2020-06-16 15:55:54,760 INFO blockmanagement.BlockManager: dfs.block.access.token.enable &#x3D; false2020-06-16 15:55:54,771 INFO Configuration.deprecation: No unit for dfs.namenode.safemode.extension(30000) assuming MILLISECONDS2020-06-16 15:55:54,772 INFO blockmanagement.BlockManagerSafeMode: dfs.namenode.safemode.threshold-pct &#x3D; 0.99900001287460332020-06-16 15:55:54,772 INFO blockmanagement.BlockManagerSafeMode: dfs.namenode.safemode.min.datanodes &#x3D; 02020-06-16 15:55:54,772 INFO blockmanagement.BlockManagerSafeMode: dfs.namenode.safemode.extension &#x3D; 300002020-06-16 15:55:54,772 INFO blockmanagement.BlockManager: defaultReplication &#x3D; 32020-06-16 15:55:54,772 INFO blockmanagement.BlockManager: maxReplication &#x3D; 5122020-06-16 15:55:54,773 INFO blockmanagement.BlockManager: minReplication &#x3D; 12020-06-16 15:55:54,773 INFO blockmanagement.BlockManager: maxReplicationStreams &#x3D; 22020-06-16 15:55:54,773 INFO blockmanagement.BlockManager: redundancyRecheckInterval &#x3D; 3000ms2020-06-16 15:55:54,773 INFO blockmanagement.BlockManager: encryptDataTransfer &#x3D; false2020-06-16 15:55:54,773 INFO blockmanagement.BlockManager: maxNumBlocksToLog &#x3D; 10002020-06-16 15:55:54,841 INFO namenode.FSDirectory: GLOBAL serial map: bits&#x3D;24 maxEntries&#x3D;167772152020-06-16 15:55:54,878 INFO util.GSet: Computing capacity for map INodeMap2020-06-16 15:55:54,878 INFO util.GSet: VM type &#x3D; 64-bit2020-06-16 15:55:54,879 INFO util.GSet: 1.0% max memory 876.5 MB &#x3D; 8.8 MB2020-06-16 15:55:54,879 INFO util.GSet: capacity &#x3D; 2^20 &#x3D; 1048576 entries2020-06-16 15:55:54,880 INFO namenode.FSDirectory: ACLs enabled? false2020-06-16 15:55:54,880 INFO namenode.FSDirectory: POSIX ACL inheritance enabled? true2020-06-16 15:55:54,880 INFO namenode.FSDirectory: XAttrs enabled? true2020-06-16 15:55:54,881 INFO namenode.NameNode: Caching file names occurring more than 10 times2020-06-16 15:55:54,891 INFO snapshot.SnapshotManager: Loaded config captureOpenFiles: true, skipCaptureAccessTimeOnlyChange: false, snapshotDiffAllowSnapRootDescendant: true2020-06-16 15:55:54,903 INFO util.GSet: Computing capacity for map cachedBlocks2020-06-16 15:55:54,903 INFO util.GSet: VM type &#x3D; 64-bit2020-06-16 15:55:54,905 INFO util.GSet: 0.25% max memory 876.5 MB &#x3D; 2.2 MB2020-06-16 15:55:54,905 INFO util.GSet: capacity &#x3D; 2^18 &#x3D; 262144 entries2020-06-16 15:55:54,925 INFO metrics.TopMetrics: NNTop conf: dfs.namenode.top.window.num.buckets &#x3D; 102020-06-16 15:55:54,925 INFO metrics.TopMetrics: NNTop conf: dfs.namenode.top.num.users &#x3D; 102020-06-16 15:55:54,925 INFO metrics.TopMetrics: NNTop conf: dfs.namenode.top.windows.minutes &#x3D; 1,5,252020-06-16 15:55:54,938 INFO namenode.FSNamesystem: Retry cache on namenode is enabled2020-06-16 15:55:54,938 INFO namenode.FSNamesystem: Retry cache will use 0.03 of total heap and retry cache entry expiry time is 600000 millis2020-06-16 15:55:54,943 INFO util.GSet: Computing capacity for map NameNodeRetryCache2020-06-16 15:55:54,944 INFO util.GSet: VM type &#x3D; 64-bit2020-06-16 15:55:54,944 INFO util.GSet: 0.029999999329447746% max memory 876.5 MB &#x3D; 269.3 KB2020-06-16 15:55:54,944 INFO util.GSet: capacity &#x3D; 2^15 &#x3D; 32768 entries2020-06-16 15:55:54,978 INFO common.Storage: Lock on &#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;in_use.lock acquired by nodename 2029@25b603a089cc2020-06-16 15:55:55,028 INFO namenode.FileJournalManager: Recovering unfinalized segments in &#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current2020-06-16 15:55:55,084 INFO namenode.FileJournalManager: Finalizing edits file &#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current&#x2F;edits_inprogress_0000000000000000001 -&gt; &#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current&#x2F;edits_0000000000000000001-00000000000000000012020-06-16 15:55:55,121 INFO namenode.FSImage: Planning to load image: FSImageFile(file&#x3D;&#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current&#x2F;fsimage_0000000000000000000, cpktTxId&#x3D;0000000000000000000)2020-06-16 15:55:55,282 INFO namenode.FSImageFormatPBINode: Loading 1 INodes.2020-06-16 15:55:55,349 INFO namenode.FSImageFormatProtobuf: Loaded FSImage in 0 seconds.2020-06-16 15:55:55,350 INFO namenode.FSImage: Loaded image for txid 0 from &#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current&#x2F;fsimage_00000000000000000002020-06-16 15:55:55,350 INFO namenode.FSImage: Reading org.apache.hadoop.hdfs.server.namenode.RedundantEditLogInputStream@5674e1f2 expecting start txid #12020-06-16 15:55:55,351 INFO namenode.FSImage: Start loading edits file &#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current&#x2F;edits_0000000000000000001-0000000000000000001 maxTxnsToRead &#x3D; 92233720368547758072020-06-16 15:55:55,355 INFO namenode.RedundantEditLogInputStream: Fast-forwarding stream &#39;&#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current&#x2F;edits_0000000000000000001-0000000000000000001&#39; to transaction ID 12020-06-16 15:55:55,390 INFO namenode.FSImage: Edits file &#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name&#x2F;current&#x2F;edits_0000000000000000001-0000000000000000001 of size 1048576 edits # 1 loaded in 0 seconds2020-06-16 15:55:55,390 INFO namenode.FSNamesystem: Need to save fs image? false (staleImage&#x3D;false, haEnabled&#x3D;false, isRollingUpgrade&#x3D;false)2020-06-16 15:55:55,392 INFO namenode.FSEditLog: Starting log segment at 22020-06-16 15:55:55,519 INFO namenode.NameCache: initialized with 0 entries 0 lookups2020-06-16 15:55:55,519 INFO namenode.FSNamesystem: Finished loading FSImage in 569 msecs2020-06-16 15:55:55,917 INFO namenode.NameNode: RPC server is binding to 0.0.0.0:80202020-06-16 15:55:55,939 INFO ipc.CallQueueManager: Using callQueue: class java.util.concurrent.LinkedBlockingQueue queueCapacity: 1000 scheduler: class org.apache.hadoop.ipc.DefaultRpcScheduler2020-06-16 15:55:55,965 INFO ipc.Server: Starting Socket Reader #1 for port 80202020-06-16 15:55:56,404 INFO namenode.FSNamesystem: Registered FSNamesystemState, ReplicatedBlocksState and ECBlockGroupsState MBeans.2020-06-16 15:55:56,423 INFO namenode.LeaseManager: Number of blocks under construction: 02020-06-16 15:55:56,448 INFO blockmanagement.BlockManager: initializing replication queues2020-06-16 15:55:56,449 INFO hdfs.StateChange: STATE* Leaving safe mode after 0 secs2020-06-16 15:55:56,449 INFO hdfs.StateChange: STATE* Network topology has 0 racks and 0 datanodes2020-06-16 15:55:56,449 INFO hdfs.StateChange: STATE* UnderReplicatedBlocks has 0 blocks2020-06-16 15:55:56,469 INFO blockmanagement.BlockManager: Total number of blocks &#x3D; 02020-06-16 15:55:56,469 INFO blockmanagement.BlockManager: Number of invalid blocks &#x3D; 02020-06-16 15:55:56,469 INFO blockmanagement.BlockManager: Number of under-replicated blocks &#x3D; 02020-06-16 15:55:56,469 INFO blockmanagement.BlockManager: Number of over-replicated blocks &#x3D; 02020-06-16 15:55:56,470 INFO blockmanagement.BlockManager: Number of blocks being written &#x3D; 02020-06-16 15:55:56,471 INFO hdfs.StateChange: STATE* Replication Queue initialization scan for invalid, over- and under-replicated blocks completed in 22 msec2020-06-16 15:55:56,536 INFO ipc.Server: IPC Server Responder: starting2020-06-16 15:55:56,543 INFO ipc.Server: IPC Server listener on 8020: starting2020-06-16 15:55:56,554 INFO namenode.NameNode: NameNode RPC up at: 0.0.0.0&#x2F;0.0.0.0:80202020-06-16 15:55:56,561 INFO namenode.FSNamesystem: Starting services required for active state2020-06-16 15:55:56,561 INFO namenode.FSDirectory: Initializing quota with 4 thread(s)2020-06-16 15:55:56,581 INFO namenode.FSDirectory: Quota initialization completed in 19 millisecondsname space&#x3D;1storage space&#x3D;0storage types&#x3D;RAM_DISK&#x3D;0, SSD&#x3D;0, DISK&#x3D;0, ARCHIVE&#x3D;02020-06-16 15:55:56,595 INFO blockmanagement.CacheReplicationMonitor: Starting CacheReplicationMonitor with interval 30000 milliseconds^C2020-06-16 15:56:01,491 ERROR namenode.NameNode: RECEIVED SIGNAL 2: SIGINT2020-06-16 15:56:01,496 INFO namenode.NameNode: SHUTDOWN_MSG:&#x2F;************************************************************SHUTDOWN_MSG: Shutting down NameNode at 25b603a089cc&#x2F;172.17.0.3************************************************************&#x2F; å‘ç°namenodeå¯åŠ¨æˆåŠŸã€‚ 12345678[root@25b603a089cc &#x2F;]# netstat -anpActive Internet connections (servers and established)Proto Recv-Q Send-Q Local Address Foreign Address State PID&#x2F;Program nametcp 0 0 0.0.0.0:9870 0.0.0.0:* LISTEN 1872&#x2F;javatcp 0 0 0.0.0.0:8020 0.0.0.0:* LISTEN 1872&#x2F;javatcp 0 0 172.17.0.3:36568 151.101.108.167:443 TIME_WAIT -tcp 0 0 172.17.0.3:43778 202.104.186.227:80 TIME_WAIT -tcp 0 0 172.17.0.3:43774 202.104.186.227:80 TIME_WAIT - å¹¶ä¸”çœ‹åˆ°äº†8020ä»–çš„rpcç«¯å£å·²ç»å¯åŠ¨ï¼Œ9870å°±æ˜¯webçš„ç«¯å£ã€‚ æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æµè§ˆå™¨çœ‹åˆ°æœåŠ¡å¯åŠ¨å®Œæ¯•äº†ã€‚ æµè§ˆå™¨è¾“å…¥ï¼šhttp://localhost:9870/ è‡³æ­¤ï¼Œå¤§æ•°æ®æœåŠ¡namenodeå®¹å™¨å®‰è£…å®Œæ¯•. æ¥ç€ï¼Œæˆ‘ä»¬ç»§ç»­éƒ¨ç½²æˆ‘ä»¬çš„datanodeæœåŠ¡ã€‚ä¸ºäº†è°ƒè¯•æ–¹ä¾¿ï¼Œæˆ‘åœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­éƒ¨ç½²datanode 1yum install -y hadoop-hdfs-datanode å®‰è£…å®Œæ¯•ä¹‹åï¼Œå†å¯åŠ¨æœåŠ¡ 1234567891011121314[root@9ba32201bb25 &#x2F;]# netstat -anpActive Internet connections (servers and established)Proto Recv-Q Send-Q Local Address Foreign Address State PID&#x2F;Program nametcp 0 0 0.0.0.0:8020 0.0.0.0:* LISTEN 917&#x2F;javatcp 0 0 127.0.0.11:39643 0.0.0.0:* LISTEN -tcp 0 0 0.0.0.0:9864 0.0.0.0:* LISTEN 990&#x2F;javatcp 0 0 0.0.0.0:9866 0.0.0.0:* LISTEN 990&#x2F;javatcp 0 0 0.0.0.0:9867 0.0.0.0:* LISTEN 990&#x2F;javatcp 0 0 127.0.0.1:38411 0.0.0.0:* LISTEN 990&#x2F;javatcp 0 0 0.0.0.0:9870 0.0.0.0:* LISTEN 917&#x2F;javatcp 0 0 172.24.0.2:42042 113.96.181.216:80 TIME_WAIT -tcp 0 0 172.24.0.2:8020 172.24.0.2:58574 ESTABLISHED 917&#x2F;javatcp 0 0 172.24.0.2:58574 172.24.0.2:8020 ESTABLISHED 990&#x2F;javaudp 0 0 127.0.0.11:54498 0.0.0.0:* è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°é™¤äº†8020/9870è¿™2ä¸ªæ˜¯namenodeçš„ç«¯å£ä¹‹å¤–ï¼Œå…¶ä»–ç«¯å£éƒ½æ˜¯datanodeèŠ‚ç‚¹çš„ç«¯å£ã€‚ æˆ‘ä»¬åœ¨hdfs-site.xmlä¸­æ·»åŠ äº†å¦‚ä¸‹é…ç½® 1234&lt;property&gt; &lt;name&gt;dfs.datanode.data.dir&lt;&#x2F;name&gt; &lt;value&gt;file:&#x2F;&#x2F;&#x2F;var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;data&lt;&#x2F;value&gt;&lt;&#x2F;property&gt; å†è°ƒæ•´dockerfileã€‚æœ€ç»ˆå¦‚ä¸‹ã€‚ 1234567891011121314151617181920212223242526FROM ccinn&#x2F;cdh6:latestLABEL maintainer&#x3D;&quot;Caiwenhui &lt;471113744@qq.com&gt;&quot;USER rootADD support.sh &#x2F;support.shADD conf&#x2F;core-site.xml &#x2F;etc&#x2F;hadoop&#x2F;conf&#x2F;ADD conf&#x2F;hdfs-site.xml &#x2F;etc&#x2F;hadoop&#x2F;conf&#x2F;ADD conf&#x2F;mapred-site.xml &#x2F;etc&#x2F;hadoop&#x2F;conf&#x2F;ADD bin&#x2F;run.sh &#x2F;bin&#x2F;RUN source &#x2F;support.sh;\\ loop_exec &#39;yum install -y hadoop-hdfs-namenode hadoop-hdfs-datanode&#39;RUN mkdir -p var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;name;\\ mkdir -p var&#x2F;lib&#x2F;hadoop-hdfs&#x2F;cache&#x2F;hdfs&#x2F;dfs&#x2F;data;WORKDIR &#x2F;# 9870 namenode&#39;s http# 9864 datanode&#39;s httpEXPOSE 9870 9864CMD [&quot;&#x2F;bin&#x2F;run.sh&quot;] æµè§ˆå™¨è¾“å…¥ï¼šhttp://localhost:9864/ æ„å»ºhiveé•œåƒ åŸºäºåŸºç¡€é•œåƒçš„hiveæœåŠ¡ å‰é¢ï¼Œæˆ‘ä»¬è¯´åˆ°hadoopçš„ç”Ÿæ€ç»„ä»¶æ˜¯ä¸ªç¹æ‚çš„ä¾èµ–å…³ç³»ï¼Œç‰ˆæœ¬æä¸å¯¹ï¼Œç»å¸¸ä¼šå‡ºç°æœåŠ¡èµ·ä¸æ¥çš„é—®é¢˜ã€‚ å½“æˆ‘ä»¬ä¸æƒ³ç”¨cdhç»™æˆ‘ä»¬é€‰æ‹©å¥½çš„ç»„ä»¶çš„æ—¶å€™ï¼Œè®°å¾—éœ€è¦è‡ªå·±æ¢³ç†å¥½ç‰ˆæœ¬å…³ç³»ã€‚ hiveä¸‹è½½å‰çš„ç‰ˆæœ¬ä¾èµ–è¯´æ˜-æŸ¥çœ‹hadoopå’Œhiveç‰ˆæœ¬çš„å…³ç³» ç”±äºæˆ‘ä»¬ç”¨çš„cdh6çš„æºï¼Œæ‰€ä»¥æˆ‘ç›´æ¥yumå®‰è£…ï¼Œè¿™é‡Œhiveçš„ç‰ˆæœ¬ä¸º2.1.1 12345678910111213141516171819FROM ccinn/cdh6:latestLABEL maintainer=\"Caiwenhui &lt;471113744@qq.com&gt;\"USER rootADD bin/support.sh /bin/ADD bin/run.sh /bin/# å®‰è£…å…ƒæ•°æ®å­˜å‚¨æœåŠ¡ postgresRUN source /bin/support.sh;\\ loop_exec 'yum install -y hive hive-metastore postgresql-jdbc' ;\\ ln -s /usr/share/java/postgresql-jdbc.jar /usr/lib/hive/lib/postgresql-jdbc.jarADD conf/hive-site.xml /etc/hive/conf/WORKDIR /CMD [\"/bin/run.sh\"] è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨postgresqlä½œä¸ºæˆ‘ä»¬çš„å…ƒæ•°æ®å­˜å‚¨æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å®‰è£…äº†ä¸€ä¸ªpostgresql-jdbcï¼Œå¹¶ä¸”éœ€è¦æŠŠjaråŒ…æ”¾åœ¨hiveæœåŠ¡åŠ è½½çš„ç¯å¢ƒå˜é‡ä¸‹ã€‚ æ„å»ºç”¨äºhiveé•œåƒçš„postgresé•œåƒ æ„å»ºç”¨äºhiveé•œåƒçš„postgresé•œåƒ 12345678910FROM postgres:9LABEL maintainer=\"Caiwenhui &lt;471113744@qq.com&gt;\"COPY cdh6-hive-postgres /cdh6-hive-postgresCOPY init-hive-db.sh /docker-entrypoint-initdb.d/init-user-db.sh# å› ä¸ºschemaå†…éƒ¨ç”¨äº†ç›¸å¯¹åœ°å€åŠ è½½å…³è”çš„sqlï¼Œæ‰€ä»¥è¿™é‡Œçš„å·¥ä½œç›®å½•éœ€è¦æŒ‡å®šä¸ºè„šæœ¬å½“å‰ç›®å½•WORKDIR /cdh6-hive-postgres æ•´ä¸ªdockerfileå¾ˆç®€å•ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·å’Œå¯†ç éƒ½æ˜¯ä½¿ç”¨äº†äº†hiveã€‚ æ„å»ºimpalaé•œåƒ æ„å»ºimpalaé•œåƒ 123456789101112131415FROM ccinn/cdh6:latestLABEL maintainer=\"Caiwenhui &lt;471113744@qq.com&gt;\"USER rootADD bin/support.sh /bin/ADD bin/run.sh /bin/RUN source /bin/support.sh;\\ loop_exec 'yum install -y impala impala-server impala-shell impala-catalog impala-state-store' ;WORKDIR /CMD [\"/bin/bash\"] åœ¨è¿™é‡Œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„impalaæœåŠ¡å¯åŠ¨æ˜¯æœ‰å…³è”é¡ºåºé—®é¢˜çš„ã€‚ 1âƒ£ï¸ impala-state-store 2âƒ£ï¸ impala-catalog 3âƒ£ï¸ impala-server(impalad) åˆ°æ­¤ï¼Œæˆ‘ä»¬æ•´å¥—å¤§æ•°æ®OLAPçš„ä½“ç³»è®¾æ–½ï¼Œç®—æ˜¯åŸºæœ¬å®Œæˆäº†ã€‚å…¶å®åˆ°hiveå·²ç»ç®—okäº†ã€‚ä½†æ˜¯å¤§å®¶å…¶å®å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘è¿™é‡Œåˆ°è®¡ç®—å¼•æ“å¹¶æ²¡æœ‰ä½¿ç”¨hiveserver2ã€‚è¿™é‡Œåˆ°hiveåªæ˜¯ç”¨äº†metastoreã€‚ ä¹Ÿå› æ­¤ï¼Œè¿™ä¸ªhiveåˆ°metastoreï¼Œç›®å‰æ¥è¯´ä»…ä»…åªæ˜¯ä¸ºäº†æœåŠ¡impalaç”¨åˆ°ã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®ï¼ŒHadoop","slug":"å¤§æ•°æ®ï¼ŒHadoop","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%EF%BC%8CHadoop/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- Hadoop åŸºæœ¬æ“ä½œ","slug":"å¤§æ•°æ®/hadoopåŸºæœ¬æ“ä½œ","date":"2020-06-12T01:56:40.000Z","updated":"2021-03-20T16:25:01.815Z","comments":true,"path":"2020/06/12/å¤§æ•°æ®/hadoopåŸºæœ¬æ“ä½œ/","link":"","permalink":"http://blog.crazylaw.cn/2020/06/12/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/","excerpt":"å‰è¨€ç”±äºä¹‹å‰ä¸€ç›´æ²¡æœ‰æ•´ç†è¿‡hadoopçš„å†…å®¹ï¼Œæˆ–è€…è¯´æ•´ç†å¾—æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥è§‰å¾—æœ‰å¿…è¦","text":"å‰è¨€ç”±äºä¹‹å‰ä¸€ç›´æ²¡æœ‰æ•´ç†è¿‡hadoopçš„å†…å®¹ï¼Œæˆ–è€…è¯´æ•´ç†å¾—æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥è§‰å¾—æœ‰å¿…è¦ Hadoop å­˜å‚¨ - HDFSHadoop çš„å­˜å‚¨ç³»ç»Ÿæ˜¯ HDFS(Hadoop Distributed File System)åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¹å¤–éƒ¨å®¢æˆ·ç«¯è€Œè¨€ï¼ŒHDFS å°±åƒä¸€ä¸ªä¼ ç»Ÿçš„åˆ†çº§æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥è¿›è¡Œåˆ›å»ºã€åˆ é™¤ã€ç§»åŠ¨æˆ–é‡å‘½åæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ç­‰æ“ä½œï¼Œä¸ Linux æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ã€‚ ä½†æ˜¯ï¼ŒHadoop HDFS çš„æ¶æ„æ˜¯åŸºäºä¸€ç»„ç‰¹å®šçš„èŠ‚ç‚¹æ„å»ºçš„ï¼Œåç§°èŠ‚ç‚¹ï¼ˆNameNodeï¼Œä»…ä¸€ä¸ª)ï¼Œå®ƒåœ¨ HDFS å†…éƒ¨æä¾›å…ƒæ•°æ®æœåŠ¡ï¼›ç¬¬äºŒåç§°èŠ‚ç‚¹(Secondary NameNode)ï¼Œåç§°èŠ‚ç‚¹çš„å¸®åŠ©èŠ‚ç‚¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ•´åˆå…ƒæ•°æ®æ“ä½œ(æ³¨æ„ä¸æ˜¯åç§°èŠ‚ç‚¹çš„å¤‡ä»½)ï¼›æ•°æ®èŠ‚ç‚¹(DataNode)ï¼Œå®ƒä¸º HDFS æä¾›å­˜å‚¨å—ã€‚ç”±äºä»…æœ‰ä¸€ä¸ª NameNodeï¼Œå› æ­¤è¿™æ˜¯ HDFS çš„ä¸€ä¸ªç¼ºç‚¹(å•ç‚¹å¤±è´¥ï¼Œåœ¨ Hadoop2.x åæœ‰è¾ƒå¤§æ”¹å–„)ã€‚ NameNodeå®ƒæ˜¯ä¸€ä¸ªé€šå¸¸åœ¨ HDFS æ¶æ„ä¸­å•ç‹¬æœºå™¨ä¸Šè¿è¡Œçš„ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†æ–‡ä»¶ç³»ç»Ÿåç§°ç©ºé—´å’Œæ§åˆ¶å¤–éƒ¨å®¢æˆ·æœºçš„è®¿é—®ã€‚NameNode å†³å®šæ˜¯å¦å°†æ–‡ä»¶æ˜ å°„åˆ° DataNode ä¸Šçš„å¤åˆ¶å—ä¸Šã€‚å¯¹äºæœ€å¸¸è§çš„ 3 ä¸ªå¤åˆ¶å—ï¼Œç¬¬ä¸€ä¸ªå¤åˆ¶å—å­˜å‚¨åœ¨åŒä¸€æœºæ¶çš„ä¸åŒèŠ‚ç‚¹ä¸Šï¼Œæœ€åä¸€ä¸ªå¤åˆ¶å—å­˜å‚¨åœ¨ä¸åŒæœºæ¶çš„æŸä¸ªèŠ‚ç‚¹ä¸Šã€‚ Secondary NameNodeç¬¬äºŒåç§°èŠ‚ç‚¹çš„ä½œç”¨åœ¨äºä¸º HDFS ä¸­çš„åç§°èŠ‚ç‚¹æä¾›ä¸€ä¸ª Checkpointï¼Œå®ƒåªæ˜¯åç§°èŠ‚ç‚¹çš„ä¸€ä¸ªåŠ©æ‰‹èŠ‚ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯å®ƒåœ¨ç¤¾åŒºå†…è¢«è®¤ä¸ºæ˜¯ Checkpoint Node çš„åŸå› ã€‚ DatabNodeæ•°æ®èŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªé€šå¸¸åœ¨ HDFS æ¶æ„ä¸­çš„å•ç‹¬æœºå™¨ä¸Šè¿è¡Œçš„ç»„ä»¶ã€‚Hadoop é›†ç¾¤åŒ…å«ä¸€ä¸ª NameNode å’Œå¤§é‡ DataNodeã€‚æ•°æ®èŠ‚ç‚¹é€šå¸¸ä»¥æœºæ¶çš„å½¢å¼ç»„ç»‡ï¼Œæœºæ¶é€šè¿‡ä¸€ä¸ªäº¤æ¢æœºå°†æ‰€æœ‰ç³»ç»Ÿè¿æ¥èµ·æ¥ã€‚ æ•°æ®èŠ‚ç‚¹å“åº”æ¥è‡ª HDFS å®¢æˆ·æœºçš„è¯»å†™è¯·æ±‚ã€‚å®ƒä»¬è¿˜å“åº”æ¥è‡ª NameNode çš„åˆ›å»ºã€åˆ é™¤å’Œå¤åˆ¶å—çš„å‘½ä»¤ã€‚åç§°èŠ‚ç‚¹ä¾èµ–æ¥è‡ªæ¯ä¸ªæ•°æ®èŠ‚ç‚¹çš„å®šæœŸå¿ƒè·³ï¼ˆheartbeatï¼‰æ¶ˆæ¯ã€‚æ¯æ¡æ¶ˆæ¯éƒ½åŒ…å«ä¸€ä¸ªå—æŠ¥å‘Šï¼Œåç§°èŠ‚ç‚¹å¯ä»¥æ ¹æ®è¿™ä¸ªæŠ¥å‘ŠéªŒè¯å—æ˜ å°„å’Œå…¶ä»–æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ã€‚å¦‚æœæ•°æ®èŠ‚ç‚¹ä¸èƒ½å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œåç§°èŠ‚ç‚¹å°†é‡‡å–ä¿®å¤æªæ–½ï¼Œé‡æ–°å¤åˆ¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šä¸¢å¤±çš„å—ã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®ï¼ŒHadoop","slug":"å¤§æ•°æ®ï¼ŒHadoop","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%EF%BC%8CHadoop/"}]},{"title":"ã€Dockerã€‘é›¶ç¢çŸ¥è¯†æ•´ç†","slug":"docker/docker-é›¶ç¢çŸ¥è¯†æ•´ç†","date":"2020-06-10T02:28:30.000Z","updated":"2021-03-20T16:25:01.805Z","comments":true,"path":"2020/06/10/docker/docker-é›¶ç¢çŸ¥è¯†æ•´ç†/","link":"","permalink":"http://blog.crazylaw.cn/2020/06/10/docker/docker-%E9%9B%B6%E7%A2%8E%E7%9F%A5%E8%AF%86%E6%95%B4%E7%90%86/","excerpt":"å‰è¨€è™½ç„¶è‡ªå·±å¯¹dockeræœ‰äº†ä¸€å®šäº†è§£äº†ï¼Œä½†æ˜¯æœ‰ä¸€äº›æ¯”è¾ƒé›¶ç¢å¯¹çŸ¥è¯†ç‚¹ï¼Œä¸€ç›´æ²¡æ•´ç†ï¼Œæ‰€ä»¥ç°åœ¨ç”¨ä¸€ç¯‡æ–‡ç« æ¥è®°å½•ä¸‹ä¸€äº›é›¶ç¢ç‚¹çŸ¥è¯†ç‚¹ï¼Œæ–¹ä¾¿è‡ªå·±æŸ¥é˜…","text":"å‰è¨€è™½ç„¶è‡ªå·±å¯¹dockeræœ‰äº†ä¸€å®šäº†è§£äº†ï¼Œä½†æ˜¯æœ‰ä¸€äº›æ¯”è¾ƒé›¶ç¢å¯¹çŸ¥è¯†ç‚¹ï¼Œä¸€ç›´æ²¡æ•´ç†ï¼Œæ‰€ä»¥ç°åœ¨ç”¨ä¸€ç¯‡æ–‡ç« æ¥è®°å½•ä¸‹ä¸€äº›é›¶ç¢ç‚¹çŸ¥è¯†ç‚¹ï¼Œæ–¹ä¾¿è‡ªå·±æŸ¥é˜… DOCKER ç»™è¿è¡Œä¸­çš„å®¹å™¨æ·»åŠ æ˜ å°„ç«¯å£1234âœ ~ docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES8eed84e6b307 golang:1.14.2 \"bash\" 3 weeks ago Up 4 days msource241a499c7061 garethflowers/svn-server:latest \"/usr/bin/svnserve -â€¦\" 5 weeks ago Up 6 days (healthy) 0.0.0.0:3690-&gt;3690/tcp svn æ–¹æ³•1 æŠŠç°æœ‰çš„å®¹å™¨commitæˆä¸€ä¸ªæ–°çš„images å†åŸºäºè¿™ä¸ªimages runä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œè¿™ä¸ªæ—¶å€™å¸¦ä¸Šç«¯å£æ˜ å°„è§„åˆ™å³å¯ ä¼˜ç‚¹å°±æ˜¯ä¸éœ€è¦æ¶‰åŠå¤ªå¤šåº•å±‚çš„ä¸œè¥¿ï¼Œéµå¾ªdockerçš„é»˜è®¤æä¾›çš„APIæ“ä½œå³å¯ æ–¹æ³•2ä¿®æ”¹åº•å±‚é…ç½®æ–‡ä»¶ 1docker inspect `svn` | grep IPAddress å®ä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243[ &#123; \"Id\": \"241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5\", \"Created\": \"2020-05-05T01:40:40.8904321Z\", \"Path\": \"/usr/bin/svnserve\", \"Args\": [ \"--daemon\", \"--foreground\", \"--root\", \"/var/opt/svn\" ], \"State\": &#123; \"Status\": \"running\", \"Running\": true, \"Paused\": false, \"Restarting\": false, \"OOMKilled\": false, \"Dead\": false, \"Pid\": 1893, \"ExitCode\": 0, \"Error\": \"\", \"StartedAt\": \"2020-06-04T01:01:15.928217933Z\", \"FinishedAt\": \"2020-06-04T01:01:13.970497593Z\", \"Health\": &#123; \"Status\": \"healthy\", \"FailingStreak\": 0, \"Log\": [ &#123; \"Start\": \"2020-06-10T03:19:51.4613637Z\", \"End\": \"2020-06-10T03:19:51.5609883Z\", \"ExitCode\": 0, \"Output\": \"tcp 0 0 0.0.0.0:3690 0.0.0.0:* LISTEN \\n\" &#125;, &#123; \"Start\": \"2020-06-10T03:20:21.5325319Z\", \"End\": \"2020-06-10T03:20:21.6352731Z\", \"ExitCode\": 0, \"Output\": \"tcp 0 0 0.0.0.0:3690 0.0.0.0:* LISTEN \\n\" &#125;, &#123; \"Start\": \"2020-06-10T03:20:51.6086611Z\", \"End\": \"2020-06-10T03:20:51.7427852Z\", \"ExitCode\": 0, \"Output\": \"tcp 0 0 0.0.0.0:3690 0.0.0.0:* LISTEN \\n\" &#125;, &#123; \"Start\": \"2020-06-10T03:21:21.7182145Z\", \"End\": \"2020-06-10T03:21:21.8185606Z\", \"ExitCode\": 0, \"Output\": \"tcp 0 0 0.0.0.0:3690 0.0.0.0:* LISTEN \\n\" &#125;, &#123; \"Start\": \"2020-06-10T03:21:51.7906908Z\", \"End\": \"2020-06-10T03:21:51.8788176Z\", \"ExitCode\": 0, \"Output\": \"tcp 0 0 0.0.0.0:3690 0.0.0.0:* LISTEN \\n\" &#125; ] &#125; &#125;, \"Image\": \"sha256:cc28899d5b9077f49f22494074e1197ef4af59d0a1ddca636f57c3b1dc3289d3\", \"ResolvConfPath\": \"/var/lib/docker/containers/241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5/resolv.conf\", \"HostnamePath\": \"/var/lib/docker/containers/241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5/hostname\", \"HostsPath\": \"/var/lib/docker/containers/241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5/hosts\", \"LogPath\": \"/var/lib/docker/containers/241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5/241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5-json.log\", \"Name\": \"/svn\", \"RestartCount\": 0, \"Driver\": \"overlay2\", \"Platform\": \"linux\", \"MountLabel\": \"\", \"ProcessLabel\": \"\", \"AppArmorProfile\": \"\", \"ExecIDs\": null, \"HostConfig\": &#123; \"Binds\": null, \"ContainerIDFile\": \"\", \"LogConfig\": &#123; \"Type\": \"json-file\", \"Config\": &#123;&#125; &#125;, \"NetworkMode\": \"default\", \"PortBindings\": &#123; \"3690/tcp\": [ &#123; \"HostIp\": \"\", \"HostPort\": \"3690\" &#125; ] &#125;, \"RestartPolicy\": &#123; \"Name\": \"always\", \"MaximumRetryCount\": 0 &#125;, \"AutoRemove\": false, \"VolumeDriver\": \"\", \"VolumesFrom\": null, \"CapAdd\": null, \"CapDrop\": null, \"Capabilities\": null, \"Dns\": [], \"DnsOptions\": [], \"DnsSearch\": [], \"ExtraHosts\": null, \"GroupAdd\": null, \"IpcMode\": \"private\", \"Cgroup\": \"\", \"Links\": null, \"OomScoreAdj\": 0, \"PidMode\": \"\", \"Privileged\": false, \"PublishAllPorts\": false, \"ReadonlyRootfs\": false, \"SecurityOpt\": null, \"UTSMode\": \"\", \"UsernsMode\": \"\", \"ShmSize\": 67108864, \"Runtime\": \"runc\", \"ConsoleSize\": [ 0, 0 ], \"Isolation\": \"\", \"CpuShares\": 0, \"Memory\": 0, \"NanoCpus\": 0, \"CgroupParent\": \"\", \"BlkioWeight\": 0, \"BlkioWeightDevice\": [], \"BlkioDeviceReadBps\": null, \"BlkioDeviceWriteBps\": null, \"BlkioDeviceReadIOps\": null, \"BlkioDeviceWriteIOps\": null, \"CpuPeriod\": 0, \"CpuQuota\": 0, \"CpuRealtimePeriod\": 0, \"CpuRealtimeRuntime\": 0, \"CpusetCpus\": \"\", \"CpusetMems\": \"\", \"Devices\": [], \"DeviceCgroupRules\": null, \"DeviceRequests\": null, \"KernelMemory\": 0, \"KernelMemoryTCP\": 0, \"MemoryReservation\": 0, \"MemorySwap\": 0, \"MemorySwappiness\": null, \"OomKillDisable\": false, \"PidsLimit\": null, \"Ulimits\": null, \"CpuCount\": 0, \"CpuPercent\": 0, \"IOMaximumIOps\": 0, \"IOMaximumBandwidth\": 0, \"MaskedPaths\": [ \"/proc/asound\", \"/proc/acpi\", \"/proc/kcore\", \"/proc/keys\", \"/proc/latency_stats\", \"/proc/timer_list\", \"/proc/timer_stats\", \"/proc/sched_debug\", \"/proc/scsi\", \"/sys/firmware\" ], \"ReadonlyPaths\": [ \"/proc/bus\", \"/proc/fs\", \"/proc/irq\", \"/proc/sys\", \"/proc/sysrq-trigger\" ] &#125;, \"GraphDriver\": &#123; \"Data\": &#123; \"LowerDir\": \"/var/lib/docker/overlay2/1e550f38444220f2853beac87489c7d717e24ac60cd9c64fe67e5571d01d7aee-init/diff:/var/lib/docker/overlay2/c9d13c35fbce9cce4b87c4c9f8e3a1fa335c495806c9aa28e9c85b01a7425f6f/diff:/var/lib/docker/overlay2/f0d6ab7fcc03bb7f98dd26452fd413e0db8b5b4fdc491fdef13aa8064f6d2b44/diff:/var/lib/docker/overlay2/9b3dba47a78414d42c011724a52ea1b25df7939c1db9746d8582c9c48ce80643/diff\", \"MergedDir\": \"/var/lib/docker/overlay2/1e550f38444220f2853beac87489c7d717e24ac60cd9c64fe67e5571d01d7aee/merged\", \"UpperDir\": \"/var/lib/docker/overlay2/1e550f38444220f2853beac87489c7d717e24ac60cd9c64fe67e5571d01d7aee/diff\", \"WorkDir\": \"/var/lib/docker/overlay2/1e550f38444220f2853beac87489c7d717e24ac60cd9c64fe67e5571d01d7aee/work\" &#125;, \"Name\": \"overlay2\" &#125;, \"Mounts\": [ &#123; \"Type\": \"volume\", \"Name\": \"c3a499500757570063073552298c2c6a2973351692eb91d9e3437944aeb79e6a\", \"Source\": \"/var/lib/docker/volumes/c3a499500757570063073552298c2c6a2973351692eb91d9e3437944aeb79e6a/_data\", \"Destination\": \"/var/opt/svn\", \"Driver\": \"local\", \"Mode\": \"\", \"RW\": true, \"Propagation\": \"\" &#125; ], \"Config\": &#123; \"Hostname\": \"241a499c7061\", \"Domainname\": \"\", \"User\": \"\", \"AttachStdin\": false, \"AttachStdout\": false, \"AttachStderr\": false, \"ExposedPorts\": &#123; \"3690/tcp\": &#123;&#125; &#125;, \"Tty\": false, \"OpenStdin\": false, \"StdinOnce\": false, \"Env\": [ \"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\" ], \"Cmd\": [ \"/usr/bin/svnserve\", \"--daemon\", \"--foreground\", \"--root\", \"/var/opt/svn\" ], \"Healthcheck\": &#123; \"Test\": [ \"CMD-SHELL\", \"netstat -ln | grep 3690 || exit 1\" ] &#125;, \"Image\": \"garethflowers/svn-server:latest\", \"Volumes\": &#123; \"/var/opt/svn\": &#123;&#125; &#125;, \"WorkingDir\": \"/var/opt/svn\", \"Entrypoint\": null, \"OnBuild\": null, \"Labels\": &#123; \"org.label-schema.build-date\": \"2020-02-13T21:46:23Z\", \"org.label-schema.description\": \"SVN Server\", \"org.label-schema.docker.cmd\": \"docker run --detach --publish 3690:3690 --volume :/var/opt/svn garethflowers/svn-server\", \"org.label-schema.name\": \"svn-server\", \"org.label-schema.schema-version\": \"1.0\", \"org.label-schema.url\": \"https://subversion.apache.org\", \"org.label-schema.vcs-ref\": \"d622ac5\", \"org.label-schema.vcs-url\": \"https://github.com/garethflowers/docker-svn-server\", \"org.label-schema.vendor\": \"garethflowers\", \"org.label-schema.version\": \"1.3.3\" &#125; ... æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹ï¼Œè¿™ä¸ªå®¹å™¨çš„idã€‚ å¦‚æœæ˜¯linuxç³»ç»Ÿä¸‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å­æ“ä½œã€‚ 1234cd /var/lib/docker/241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5 #è¿™é‡Œæ˜¯CONTAINER IDvi hostconfig.jsonå¦‚æœä¹‹å‰æ²¡æœ‰ç«¯å£æ˜ å°„, åº”è¯¥æœ‰è¿™æ ·çš„ä¸€æ®µ: â€œPortBindingsâ€:{â€œ3690/tcpâ€:[{â€œHostIpâ€:â€â€,â€HostPortâ€:â€3690â€}]} æ ¼å¼åŒ–åâ€œPortBindingsâ€: { â€œ3690/tcpâ€: [ { â€œHostIpâ€: â€œâ€, â€œHostPortâ€: â€œ3690â€ } ]}, 12å¢åŠ ä¸€ä¸ªæ˜ å°„, è¿™æ ·å†™: â€œPortBindingsâ€:{â€œ3690/tcpâ€:[{â€œHostIpâ€:â€â€,â€HostPortâ€:â€3690â€}],â€3306/tcpâ€:[{â€œHostIpâ€:â€â€,â€HostPortâ€:â€3307â€}]} 12345å‰ä¸€ä¸ªæ•°å­—æ˜¯å®¹å™¨ç«¯å£, åä¸€ä¸ªæ˜¯å®¿ä¸»æœºç«¯å£.è€Œä¿®æ”¹ç°æœ‰ç«¯å£æ˜ å°„æ›´ç®€å•, æŠŠç«¯å£å·æ”¹æ‰å°±è¡Œ.è®°å¾—è¦é‡å¯dockeræœåŠ¡ï¼Œå¦åˆ™é…ç½®ä¼šè¢«è¦†ç›–å›å» å¦‚æœæ˜¯å†macç³»ç»Ÿä¸‹æ“ä½œçš„è¯ï¼Œç”±äºdocker for macçš„æœ¬è´¨æ˜¯é€šè¿‡ä¸€ä¸ªå°å‹è™šæ‹Ÿæœºæ“ä½œçš„ï¼Œæ‰€ä»¥éœ€è¦å…ˆè¿›å…¥åˆ°è™šæ‹Ÿæœºä¸­ docker for mac çš„å†…å®¹é»˜è®¤åœ¨ ~/Library/Containers/com.docker.docker/ æˆ‘ä»¬æ‰¾åˆ° ~/Library/Containers/com.docker.docker/Data/vms/0/tty é€šè¿‡ screen tty è¿›å…¥åˆ°è™šæ‹Ÿæœºï¼Œè¿™ä¸ªæ—¶å€™ä½ å°±å¯ä»¥çœ‹åˆ°/var/lib/docker/241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5 è¿™é‡Œè·¯å¾„äº† é€€å‡ºåˆ°æ—¶å€™è®°å¾—ç”¨control+a kåˆ°ç»„åˆæ–¹å¼é€€å‡º 123docker-desktop:~# cat &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;241a499c7061a70ce20216d6e2310d851e8dcc41b4072727a16c752c4463a8a5&#x2F;hostconfig.json&#123;&quot;Binds&quot;:null,&quot;ContainerIDFile&quot;:&quot;&quot;,&quot;LogConfig&quot;:&#123;&quot;Type&quot;:&quot;json-file&quot;,&quot;Config&quot;:&#123;&#125;&#125;,&quot;NetworkMode&quot;:&quot;default&quot;,&quot;PortBindings&quot;:&#123;&quot;3690&#x2F;tcp&quot;:[&#123;&quot;HostIp&quot;:&quot;&quot;,&quot;HostPort&quot;:&quot;3690&quot;&#125;]&#125;,&quot;RestartPolicy&quot;:&#123;&quot;Name&quot;:&quot;always&quot;,&quot;MaximumRetryCount&quot;:0&#125;,&quot;AutoRemove&quot;:false,&quot;VolumeDriver&quot;:&quot;&quot;,&quot;VolumesFrom&quot;:null,&quot;CapAdd&quot;:null,&quot;CapDrop&quot;:null,&quot;Capabilities&quot;:null,&quot;Dns&quot;:[],&quot;DnsOptions&quot;:[],&quot;DnsSearch&quot;:[],&quot;ExtraHosts&quot;:null,&quot;GroupAdd&quot;:null,&quot;IpcMode&quot;:&quot;private&quot;,&quot;Cgroup&quot;:&quot;&quot;,&quot;Links&quot;:null,&quot;OomScoreAdj&quot;:0,&quot;PidMode&quot;:&quot;&quot;,&quot;Privileged&quot;:false,&quot;PublishAllPorts&quot;:false,&quot;ReadonlyRootfs&quot;:false,&quot;SecurityOpt&quot;:null,&quot;UTSMode&quot;:&quot;&quot;,&quot;UsernsMode&quot;:&quot;&quot;,&quot;ShmSize&quot;:67108864,&quot;Runtime&quot;:&quot;runc&quot;,&quot;ConsoleSize&quot;:[0,0],&quot;Isolation&quot;:&quot;&quot;,&quot;CpuShares&quot;:0,&quot;Memory&quot;:0,&quot;NanoCpus&quot;:0,&quot;CgroupParent&quot;:&quot;&quot;,&quot;BlkioWeight&quot;:0,&quot;BlkioWeightDevice&quot;:[],&quot;BlkioDeviceReadBps&quot;:null,&quot;BlkioDeviceWriteBps&quot;:null,&quot;BlkioDeviceReadIOps&quot;:null,&quot;BlkioDeviceWriteIOps&quot;:null,&quot;CpuPeriod&quot;:0,&quot;CpuQuota&quot;:0,&quot;CpuRealtimePeriod&quot;:0,&quot;CpuRealtimeRuntime&quot;:0,&quot;CpusetCpus&quot;:&quot;&quot;,&quot;CpusetMems&quot;:&quot;&quot;,&quot;Devices&quot;:[],&quot;DeviceCgroupRules&quot;:null,&quot;DeviceRequests&quot;:null,&quot;KernelMemory&quot;:0,&quot;KernelMemoryTCP&quot;:0,&quot;MemoryReservation&quot;:0,&quot;MemorySwap&quot;:0,&quot;MemorySwappiness&quot;:null,&quot;OomKillDisable&quot;:false,&quot;PidsLimit&quot;:null,&quot;Ulimits&quot;:null,&quot;CpuCount&quot;:0,&quot;CpuPercent&quot;:0,&quot;IOMaximumIOps&quot;:0,&quot;IOMaximumBandwidth&quot;:0,&quot;MaskedPaths&quot;:[&quot;&#x2F;proc&#x2F;asound&quot;,&quot;&#x2F;proc&#x2F;acpi&quot;,&quot;&#x2F;proc&#x2F;kcore&quot;,&quot;&#x2F;proc&#x2F;keys&quot;,&quot;&#x2F;proc&#x2F;latency_stats&quot;,&quot;&#x2F;proc&#x2F;timer_list&quot;,&quot;&#x2F;proc&#x2F;timer_stats&quot;,&quot;&#x2F;proc&#x2F;sched_debug&quot;,&quot;&#x2F;proc&#x2F;scsi&quot;,&quot;&#x2F;sys&#x2F;firmware&quot;],&quot;ReadonlyPaths&quot;:[&quot;&#x2F;proc&#x2F;bus&quot;,&quot;&#x2F;proc&#x2F;fs&quot;,&quot;&#x2F;proc&#x2F;irq&quot;,&quot;&#x2F;proc&#x2F;sys&quot;,&quot;&#x2F;proc&#x2F;sysrq-trigger&quot;]&#125;","categories":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/categories/Docker/"}],"tags":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/tags/Docker/"}]},{"title":"ã€Golangã€‘- sync.map","slug":"Golang/sync-map","date":"2020-06-02T05:59:51.000Z","updated":"2022-03-12T06:45:42.407Z","comments":true,"path":"2020/06/02/Golang/sync-map/","link":"","permalink":"http://blog.crazylaw.cn/2020/06/02/Golang/sync-map/","excerpt":"å‰è¨€ç”±äºè¦é€ ä¸€äº›è½®å­ï¼Œä¾‹å¦‚ åƒ laravel ä¸€æ ·çš„ Eventç»„ä»¶ï¼Œæˆ‘å‚è€ƒäº†ç½‘ä¸Šçš„å‡ ä¸ªåº“ go-trigger go-events è¿™ 2 ä¸ªåº“ï¼Œå¤§åŒå°å¼‚ï¼Œåªæœ‰ä¸€å°éƒ¨åˆ†å·®åˆ«ï¼Œæ–°æ‰“ç»„ä»¶å°†ä¼šåœ¨è¿™ 2 ä¸ªåº“çš„åŸºç¡€ä¸Šå†å°è£… è¿™ 2 ä¸ªåº“éƒ½æ˜¯æ¯”è¾ƒæ—©æœŸçš„åº“ï¼Œæ‰€ä»¥åœ¨å®ç°ä¸Šç”¨åˆ°äº† mapï¼Œä½†æ˜¯ç”±äºè€ƒè™‘åˆ° map çš„çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½ä½¿ç”¨äº† go1.9 ä¹‹å‰å®ç°çš„æ–¹å¼ï¼Œå°±æ˜¯åœ¨ç»“æ„ä½“åµŒå…¥ä¸€ä¸ªè¯»å†™é”æ¥é¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ åœ¨ Go 1.6 ä¹‹å‰ï¼Œ å†…ç½®çš„ map ç±»å‹æ˜¯éƒ¨åˆ† goroutine å®‰å…¨çš„ï¼Œå¹¶å‘çš„è¯»æ²¡æœ‰é—®é¢˜ï¼Œå¹¶å‘çš„å†™å¯èƒ½æœ‰é—®é¢˜ã€‚è‡ª go 1.6 ä¹‹åï¼Œ å¹¶å‘åœ°è¯»å†™ map ä¼šæŠ¥é”™ï¼Œè¿™åœ¨ä¸€äº›çŸ¥åçš„å¼€æºåº“ä¸­éƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ go 1.9 ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆæ˜¯é¢å¤–ç»‘å®šä¸€ä¸ªé”ï¼Œå°è£…æˆä¸€ä¸ªæ–°çš„ struct æˆ–è€…å•ç‹¬ä½¿ç”¨é”éƒ½å¯ä»¥ã€‚ æœ¬æ–‡å¸¦ä½ æ·±å…¥åˆ° sync.Map çš„å…·ä½“å®ç°ä¸­ï¼Œçœ‹çœ‹ä¸ºäº†å¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œä»£ç æ˜¯å¦‚ä½•å˜çš„å¤æ‚çš„,ä»¥åŠä½œè€…åœ¨å®ç° sync.Map çš„ä¸€äº›æ€æƒ³ã€‚","text":"å‰è¨€ç”±äºè¦é€ ä¸€äº›è½®å­ï¼Œä¾‹å¦‚ åƒ laravel ä¸€æ ·çš„ Eventç»„ä»¶ï¼Œæˆ‘å‚è€ƒäº†ç½‘ä¸Šçš„å‡ ä¸ªåº“ go-trigger go-events è¿™ 2 ä¸ªåº“ï¼Œå¤§åŒå°å¼‚ï¼Œåªæœ‰ä¸€å°éƒ¨åˆ†å·®åˆ«ï¼Œæ–°æ‰“ç»„ä»¶å°†ä¼šåœ¨è¿™ 2 ä¸ªåº“çš„åŸºç¡€ä¸Šå†å°è£… è¿™ 2 ä¸ªåº“éƒ½æ˜¯æ¯”è¾ƒæ—©æœŸçš„åº“ï¼Œæ‰€ä»¥åœ¨å®ç°ä¸Šç”¨åˆ°äº† mapï¼Œä½†æ˜¯ç”±äºè€ƒè™‘åˆ° map çš„çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ï¼Œæ‰€ä»¥ä»–ä»¬éƒ½ä½¿ç”¨äº† go1.9 ä¹‹å‰å®ç°çš„æ–¹å¼ï¼Œå°±æ˜¯åœ¨ç»“æ„ä½“åµŒå…¥ä¸€ä¸ªè¯»å†™é”æ¥é¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ åœ¨ Go 1.6 ä¹‹å‰ï¼Œ å†…ç½®çš„ map ç±»å‹æ˜¯éƒ¨åˆ† goroutine å®‰å…¨çš„ï¼Œå¹¶å‘çš„è¯»æ²¡æœ‰é—®é¢˜ï¼Œå¹¶å‘çš„å†™å¯èƒ½æœ‰é—®é¢˜ã€‚è‡ª go 1.6 ä¹‹åï¼Œ å¹¶å‘åœ°è¯»å†™ map ä¼šæŠ¥é”™ï¼Œè¿™åœ¨ä¸€äº›çŸ¥åçš„å¼€æºåº“ä¸­éƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥ go 1.9 ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆæ˜¯é¢å¤–ç»‘å®šä¸€ä¸ªé”ï¼Œå°è£…æˆä¸€ä¸ªæ–°çš„ struct æˆ–è€…å•ç‹¬ä½¿ç”¨é”éƒ½å¯ä»¥ã€‚ æœ¬æ–‡å¸¦ä½ æ·±å…¥åˆ° sync.Map çš„å…·ä½“å®ç°ä¸­ï¼Œçœ‹çœ‹ä¸ºäº†å¢åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œä»£ç æ˜¯å¦‚ä½•å˜çš„å¤æ‚çš„,ä»¥åŠä½œè€…åœ¨å®ç° sync.Map çš„ä¸€äº›æ€æƒ³ã€‚ æœ‰å¹¶å‘é—®é¢˜çš„ mapå®˜æ–¹çš„ faq å·²ç»æåˆ°å†…å»ºçš„ map ä¸æ˜¯çº¿ç¨‹(goroutine)å®‰å…¨çš„ã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€æ®µå¹¶å‘è¯»å†™çš„ä»£ç ,ä¸‹åˆ—ç¨‹åºä¸­ä¸€ä¸ª goroutine ä¸€ç›´è¯»ï¼Œä¸€ä¸ª goroutine ä¸€åªå†™åŒä¸€ä¸ªé”®å€¼ï¼Œå³å³ä½¿è¯»å†™çš„é”®ä¸ç›¸åŒï¼Œè€Œä¸” map ä¹Ÿæ²¡æœ‰â€æ‰©å®¹â€ç­‰æ“ä½œï¼Œä»£ç è¿˜æ˜¯ä¼šæŠ¥é”™ã€‚ 123456789101112131415package mainfunc main() &#123; m := make(map[int]int) go func() &#123; for &#123; _ = m[1] &#125; &#125;() go func() &#123; for &#123; m[2] = 2 &#125; &#125;() select &#123;&#125;&#125; æŠ¥é”™ä¿¡æ¯ä¸ºï¼šfatal error: concurrent map read and map write åœ¨å¼€å‘ msource ç»„ä»¶çš„æ—¶å€™ï¼ŒåŒæ ·é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ å¦‚æœä½ æŸ¥çœ‹ Go çš„æºä»£ç : hashmap_fast.go#L118,ä¼šçœ‹åˆ°è¯»çš„æ—¶å€™ä¼šæ£€æŸ¥ hashWriting æ ‡å¿—ï¼Œ å¦‚æœæœ‰è¿™ä¸ªæ ‡å¿—ï¼Œå°±ä¼šæŠ¥å¹¶å‘é”™è¯¯ã€‚ å†™çš„æ—¶å€™ä¼šè®¾ç½®è¿™ä¸ªæ ‡å¿—: hashmap.go#L542 1h.flags |= hashWriting hashmap.go#L628 è®¾ç½®å®Œä¹‹åä¼šå–æ¶ˆè¿™ä¸ªæ ‡è®°ã€‚ å½“ç„¶ï¼Œä»£ç ä¸­è¿˜æœ‰å¥½å‡ å¤„å¹¶å‘è¯»å†™çš„æ£€æŸ¥ï¼Œ æ¯”å¦‚å†™çš„æ—¶å€™ä¹Ÿä¼šæ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰å¹¶å‘çš„å†™ï¼Œåˆ é™¤é”®çš„æ—¶å€™ç±»ä¼¼å†™ï¼Œéå†çš„æ—¶å€™å¹¶å‘è¯»å†™é—®é¢˜ç­‰ã€‚ æœ‰æ—¶å€™ï¼Œmap çš„å¹¶å‘é—®é¢˜ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“è¢«å‘ç°, ä½ å¯ä»¥åˆ©ç”¨ -race å‚æ•°æ¥æ£€æŸ¥ã€‚ Go 1.9 ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆä½†æ˜¯ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå¹¶å‘åœ°ä½¿ç”¨ map å¯¹è±¡ï¼Œå°¤å…¶æ˜¯åœ¨ä¸€å®šè§„æ¨¡çš„é¡¹ç›®ä¸­ï¼Œmap æ€»ä¼šä¿å­˜ goroutine å…±äº«çš„æ•°æ®ã€‚åœ¨ Go å®˜æ–¹ blog çš„ Go maps in action ä¸€æ–‡ä¸­ï¼Œæä¾›äº†ä¸€ç§ç®€ä¾¿çš„è§£å†³æ–¹æ¡ˆã€‚ 1234var counter = struct&#123; sync.RWMutex m map[string]int&#125;&#123;m: make(map[string]int)&#125; å®ƒä½¿ç”¨åµŒå…¥ struct ä¸º map å¢åŠ ä¸€ä¸ªè¯»å†™é”ã€‚ è¯»æ•°æ®çš„æ—¶å€™å¾ˆæ–¹ä¾¿çš„åŠ é”ï¼š 1234counter.RLock()n := counter.m[\"some_key\"]counter.RUnlock()fmt.Println(\"some_key:\", n) å†™æ•°æ®çš„æ—¶å€™: 123counter.Lock()counter.m[\"some_key\"]++counter.Unlock() sync.Mapå¯ä»¥è¯´ï¼Œä¸Šé¢çš„è§£å†³æ–¹æ¡ˆç›¸å½“ç®€æ´ï¼Œå¹¶ä¸”åˆ©ç”¨è¯»å†™é”è€Œä¸æ˜¯ Mutex å¯ä»¥è¿›ä¸€æ­¥å‡å°‘è¯»å†™çš„æ—¶å€™å› ä¸ºé”å¸¦æ¥çš„æ€§èƒ½ã€‚ ä½†æ˜¯ï¼Œå®ƒåœ¨ä¸€äº›åœºæ™¯ä¸‹ä¹Ÿæœ‰é—®é¢˜ï¼Œå¦‚æœç†Ÿæ‚‰ Java çš„åŒå­¦ï¼Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹ java çš„ ConcurrentHashMap çš„å®ç°ï¼Œåœ¨ map çš„æ•°æ®éå¸¸å¤§çš„æƒ…å†µä¸‹ï¼Œä¸€æŠŠé”ä¼šå¯¼è‡´å¤§å¹¶å‘çš„å®¢æˆ·ç«¯å…±äº‰ä¸€æŠŠé”ï¼ŒJava çš„è§£å†³æ–¹æ¡ˆæ˜¯ shard, å†…éƒ¨ä½¿ç”¨å¤šä¸ªé”ï¼Œæ¯ä¸ªåŒºé—´å…±äº«ä¸€æŠŠé”ï¼Œè¿™æ ·å‡å°‘äº†æ•°æ®å…±äº«ä¸€æŠŠé”å¸¦æ¥çš„æ€§èƒ½å½±å“ï¼Œorcaman æä¾›äº†è¿™ä¸ªæ€è·¯çš„ä¸€ä¸ªå®ç°ï¼š concurrent-mapï¼Œä»–ä¹Ÿè¯¢é—®äº† Go ç›¸å…³çš„å¼€å‘äººå‘˜æ˜¯å¦åœ¨ Go ä¸­ä¹Ÿå®ç°è¿™ç§æ–¹æ¡ˆï¼Œç”±äºå®ç°çš„å¤æ‚æ€§ï¼Œç­”æ¡ˆæ˜¯ Yes, we considered it.,ä½†æ˜¯é™¤éæœ‰ç‰¹åˆ«çš„æ€§èƒ½æå‡å’Œåº”ç”¨åœºæ™¯ï¼Œå¦åˆ™æ²¡æœ‰è¿›ä¸€æ­¥çš„å¼€å‘æ¶ˆæ¯ã€‚ é‚£ä¹ˆï¼Œåœ¨ Go 1.9 ä¸­ sync.Map æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå®ƒæ˜¯å¦‚ä½•è§£å†³å¹¶å‘æå‡æ€§èƒ½çš„å‘¢ï¼Ÿ sync.Map çš„å®ç°æœ‰å‡ ä¸ªä¼˜åŒ–ç‚¹ï¼Œè¿™é‡Œå…ˆåˆ—å‡ºæ¥ï¼Œæˆ‘ä»¬åé¢æ…¢æ…¢åˆ†æã€‚ ç©ºé—´æ¢æ—¶é—´ã€‚ é€šè¿‡å†—ä½™çš„ä¸¤ä¸ªæ•°æ®ç»“æ„(readã€dirty),å®ç°åŠ é”å¯¹æ€§èƒ½çš„å½±å“ã€‚ä½¿ç”¨åªè¯»æ•°æ®(read)ï¼Œé¿å…è¯»å†™å†²çªã€‚åŠ¨æ€è°ƒæ•´ï¼Œmiss æ¬¡æ•°å¤šäº†ä¹‹åï¼Œå°† dirty æ•°æ®æå‡ä¸º readã€‚double-checkingã€‚å»¶è¿Ÿåˆ é™¤ã€‚ åˆ é™¤ä¸€ä¸ªé”®å€¼åªæ˜¯æ‰“æ ‡è®°ï¼Œåªæœ‰åœ¨æå‡ dirty çš„æ—¶å€™æ‰æ¸…ç†åˆ é™¤çš„æ•°æ®ã€‚ä¼˜å…ˆä» read è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼Œå› ä¸ºå¯¹ read çš„è¯»å–ä¸éœ€è¦é”ã€‚ä¸‹é¢æˆ‘ä»¬ä»‹ç» sync.Map çš„é‡ç‚¹ä»£ç ï¼Œä»¥ä¾¿ç†è§£å®ƒçš„å®ç°æ€æƒ³ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ sync.Map çš„æ•°æ®ç»“æ„ï¼š 123456789101112131415type Map struct &#123; // å½“æ¶‰åŠåˆ°dirtyæ•°æ®çš„æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸ªé” mu Mutex // ä¸€ä¸ªåªè¯»çš„æ•°æ®ç»“æ„ï¼Œå› ä¸ºåªè¯»ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰è¯»å†™å†²çªã€‚ // æ‰€ä»¥ä»è¿™ä¸ªæ•°æ®ä¸­è¯»å–æ€»æ˜¯å®‰å…¨çš„ã€‚ // å®é™…ä¸Šï¼Œå®é™…ä¹Ÿä¼šæ›´æ–°è¿™ä¸ªæ•°æ®çš„entries,å¦‚æœentryæ˜¯æœªåˆ é™¤çš„(unexpunged), å¹¶ä¸éœ€è¦åŠ é”ã€‚å¦‚æœentryå·²ç»è¢«åˆ é™¤äº†ï¼Œéœ€è¦åŠ é”ï¼Œä»¥ä¾¿æ›´æ–°dirtyæ•°æ®ã€‚ read atomic.Value // readOnly // dirtyæ•°æ®åŒ…å«å½“å‰çš„mapåŒ…å«çš„entries,å®ƒåŒ…å«æœ€æ–°çš„entries(åŒ…æ‹¬readä¸­æœªåˆ é™¤çš„æ•°æ®,è™½æœ‰å†—ä½™ï¼Œä½†æ˜¯æå‡dirtyå­—æ®µä¸ºreadçš„æ—¶å€™éå¸¸å¿«ï¼Œä¸ç”¨ä¸€ä¸ªä¸€ä¸ªçš„å¤åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥å°†è¿™ä¸ªæ•°æ®ç»“æ„ä½œä¸ºreadå­—æ®µçš„ä¸€éƒ¨åˆ†),æœ‰äº›æ•°æ®è¿˜å¯èƒ½æ²¡æœ‰ç§»åŠ¨åˆ°readå­—æ®µä¸­ã€‚ // å¯¹äºdirtyçš„æ“ä½œéœ€è¦åŠ é”ï¼Œå› ä¸ºå¯¹å®ƒçš„æ“ä½œå¯èƒ½ä¼šæœ‰è¯»å†™ç«äº‰ã€‚ // å½“dirtyä¸ºç©ºçš„æ—¶å€™ï¼Œ æ¯”å¦‚åˆå§‹åŒ–æˆ–è€…åˆšæå‡å®Œï¼Œä¸‹ä¸€æ¬¡çš„å†™æ“ä½œä¼šå¤åˆ¶readå­—æ®µä¸­æœªåˆ é™¤çš„æ•°æ®åˆ°è¿™ä¸ªæ•°æ®ä¸­ã€‚ dirty map[interface&#123;&#125;]*entry // å½“ä»Mapä¸­è¯»å–entryçš„æ—¶å€™ï¼Œå¦‚æœreadä¸­ä¸åŒ…å«è¿™ä¸ªentry,ä¼šå°è¯•ä»dirtyä¸­è¯»å–ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå°†missesåŠ ä¸€ï¼Œ // å½“missesç´¯ç§¯åˆ° dirtyçš„é•¿åº¦çš„æ—¶å€™ï¼Œ å°±ä¼šå°†dirtyæå‡ä¸ºread,é¿å…ä»dirtyä¸­misså¤ªå¤šæ¬¡ã€‚å› ä¸ºæ“ä½œdirtyéœ€è¦åŠ é”ã€‚ misses int&#125; å®ƒçš„æ•°æ®ç»“æ„å¾ˆç®€å•ï¼Œå€¼åŒ…å«å››ä¸ªå­—æ®µï¼šreadã€muã€dirtyã€missesã€‚ å®ƒä½¿ç”¨äº†å†—ä½™çš„æ•°æ®ç»“æ„ readã€dirtyã€‚dirty ä¸­ä¼šåŒ…å« read ä¸­æœªåˆ é™¤çš„ entriesï¼Œæ–°å¢åŠ çš„ entries ä¼šåŠ å…¥åˆ° dirty ä¸­ã€‚ read çš„æ•°æ®ç»“æ„æ˜¯ï¼š 1234type readOnly struct &#123; m map[interface&#123;&#125;]*entry amended bool // å¦‚æœMap.dirtyæœ‰äº›æ•°æ®ä¸åœ¨ä¸­çš„æ—¶å€™ï¼Œè¿™ä¸ªå€¼ä¸ºtrue&#125; amended æŒ‡æ˜ Map.dirty ä¸­æœ‰ readOnly.m æœªåŒ…å«çš„æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœä» Map.read æ‰¾ä¸åˆ°æ•°æ®çš„è¯ï¼Œè¿˜è¦è¿›ä¸€æ­¥åˆ° Map.dirty ä¸­æŸ¥æ‰¾ã€‚ å¯¹ Map.read çš„ä¿®æ”¹æ˜¯é€šè¿‡åŸå­æ“ä½œè¿›è¡Œçš„ã€‚ è™½ç„¶ read å’Œ dirty æœ‰å†—ä½™æ•°æ®ï¼Œä½†è¿™äº›æ•°æ®æ˜¯é€šè¿‡æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªæ•°æ®ï¼Œæ‰€ä»¥å°½ç®¡ Map çš„ value ä¼šå¾ˆå¤§ï¼Œä½†æ˜¯å†—ä½™çš„ç©ºé—´å ç”¨è¿˜æ˜¯æœ‰é™çš„ã€‚ readOnly.m å’Œ Map.dirty å­˜å‚¨çš„å€¼ç±»å‹æ˜¯\\*entry,å®ƒåŒ…å«ä¸€ä¸ªæŒ‡é’ˆ p, æŒ‡å‘ç”¨æˆ·å­˜å‚¨çš„ value å€¼ã€‚ 123type entry struct &#123; p unsafe.Pointer // *interface&#123;&#125;&#125; p æœ‰ä¸‰ç§å€¼ï¼š nil: entry å·²è¢«åˆ é™¤äº†ï¼Œå¹¶ä¸” m.dirty ä¸º nil expunged: entry å·²è¢«åˆ é™¤äº†ï¼Œå¹¶ä¸” m.dirty ä¸ä¸º nilï¼Œè€Œä¸”è¿™ä¸ª entry ä¸å­˜åœ¨äº m.dirty ä¸­ å…¶å®ƒï¼š entry æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å€¼ ä»¥ä¸Šæ˜¯ sync.Map çš„æ•°æ®ç»“æ„ï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ Loadã€Storeã€Deleteã€Range è¿™å››ä¸ªæ–¹æ³•ï¼Œå…¶å®ƒè¾…åŠ©æ–¹æ³•å¯ä»¥å‚è€ƒè¿™å››ä¸ªæ–¹æ³•æ¥ç†è§£ã€‚ LoadåŠ è½½æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æä¾›ä¸€ä¸ªé”® key,æŸ¥æ‰¾å¯¹åº”çš„å€¼ value,å¦‚æœä¸å­˜åœ¨ï¼Œé€šè¿‡ ok åæ˜ ï¼š 12345678910111213141516171819202122232425func (m *Map) Load(key interface&#123;&#125;) (value interface&#123;&#125;, ok bool) &#123; // 1.é¦–å…ˆä»m.readä¸­å¾—åˆ°åªè¯»readOnly,ä»å®ƒçš„mapä¸­æŸ¥æ‰¾ï¼Œä¸éœ€è¦åŠ é” read, _ := m.read.Load().(readOnly) e, ok := read.m[key] // 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå¹¶ä¸”m.dirtyä¸­æœ‰æ–°æ•°æ®ï¼Œéœ€è¦ä»m.dirtyæŸ¥æ‰¾ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åŠ é” if !ok &amp;&amp; read.amended &#123; m.mu.Lock() // åŒæ£€æŸ¥ï¼Œé¿å…åŠ é”çš„æ—¶å€™m.dirtyæå‡ä¸ºm.read,è¿™ä¸ªæ—¶å€™m.readå¯èƒ½è¢«æ›¿æ¢äº†ã€‚ read, _ = m.read.Load().(readOnly) e, ok = read.m[key] // å¦‚æœm.readä¸­è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œå¹¶ä¸”m.dirtyä¸­æœ‰æ–°æ•°æ® if !ok &amp;&amp; read.amended &#123; // ä»m.dirtyæŸ¥æ‰¾ e, ok = m.dirty[key] // ä¸ç®¡m.dirtyä¸­å­˜ä¸å­˜åœ¨ï¼Œéƒ½å°†missesè®¡æ•°åŠ ä¸€ // missLocked()ä¸­æ»¡è¶³æ¡ä»¶åå°±ä¼šæå‡m.dirty m.missLocked() &#125; m.mu.Unlock() &#125; if !ok &#123; return nil, false &#125; return e.load()&#125; è¿™é‡Œæœ‰ä¸¤ä¸ªå€¼çš„å…³æ³¨çš„åœ°æ–¹ã€‚ä¸€ä¸ªæ˜¯é¦–å…ˆä» m.read ä¸­åŠ è½½ï¼Œä¸å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸” m.dirty ä¸­æœ‰æ–°æ•°æ®ï¼ŒåŠ é”ï¼Œç„¶åä» m.dirty ä¸­åŠ è½½ã€‚ äºŒæ˜¯è¿™é‡Œä½¿ç”¨äº†åŒæ£€æŸ¥çš„å¤„ç†ï¼Œå› ä¸ºåœ¨ä¸‹é¢çš„ä¸¤ä¸ªè¯­å¥ä¸­ï¼Œè¿™ä¸¤è¡Œè¯­å¥å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚ 12if !ok &amp;&amp; read.amended &#123; m.mu.Lock() è™½ç„¶ç¬¬ä¸€å¥æ‰§è¡Œçš„æ—¶å€™æ¡ä»¶æ»¡è¶³ï¼Œä½†æ˜¯åœ¨åŠ é”ä¹‹å‰ï¼Œm.dirty å¯èƒ½è¢«æå‡ä¸º m.read,æ‰€ä»¥åŠ é”åè¿˜å¾—å†æ£€æŸ¥ m.readï¼Œåç»­çš„æ–¹æ³•ä¸­éƒ½ä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•ã€‚ åŒæ£€æŸ¥çš„æŠ€æœ¯ Java ç¨‹åºå‘˜éå¸¸ç†Ÿæ‚‰äº†ï¼Œå•ä¾‹æ¨¡å¼çš„å®ç°ä¹‹ä¸€å°±æ˜¯åˆ©ç”¨åŒæ£€æŸ¥çš„æŠ€æœ¯ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬æŸ¥è¯¢çš„é”®å€¼æ­£å¥½å­˜åœ¨äº m.read ä¸­ï¼Œæ— é¡»åŠ é”ï¼Œç›´æ¥è¿”å›ï¼Œç†è®ºä¸Šæ€§èƒ½ä¼˜å¼‚ã€‚å³ä½¿ä¸å­˜åœ¨äº m.read ä¸­ï¼Œç»è¿‡ miss å‡ æ¬¡ä¹‹åï¼Œm.dirty ä¼šè¢«æå‡ä¸º m.readï¼Œåˆä¼šä» m.read ä¸­æŸ¥æ‰¾ã€‚æ‰€ä»¥å¯¹äºæ›´æ–°ï¼å¢åŠ è¾ƒå°‘ï¼ŒåŠ è½½å­˜åœ¨çš„ key å¾ˆå¤šçš„ case,æ€§èƒ½åŸºæœ¬å’Œæ— é”çš„ map ç±»ä¼¼ã€‚ ä¸‹é¢çœ‹çœ‹ m.dirty æ˜¯å¦‚ä½•è¢«æå‡çš„ã€‚missLockedæ–¹æ³•ä¸­å¯èƒ½ä¼šå°† m.dirty æå‡ã€‚ 123456789func (m *Map) missLocked() &#123; m.misses++ if m.misses &lt; len(m.dirty) &#123; return &#125; m.read.Store(readOnly&#123;m: m.dirty&#125;) m.dirty = nil m.misses = 0&#125; Storeè¿™ä¸ªæ–¹æ³•æ˜¯æ›´æ–°æˆ–è€…æ–°å¢ä¸€ä¸ª entryã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849func (m *Map) Store(key, value interface&#123;&#125;) &#123; // å¦‚æœm.readå­˜åœ¨è¿™ä¸ªé”®ï¼Œå¹¶ä¸”è¿™ä¸ªentryæ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼Œå°è¯•ç›´æ¥å­˜å‚¨ã€‚ // å› ä¸ºm.dirtyä¹ŸæŒ‡å‘è¿™ä¸ªentry,æ‰€ä»¥m.dirtyä¹Ÿä¿æŒæœ€æ–°çš„entryã€‚ read, _ := m.read.Load().(readOnly) if e, ok := read.m[key]; ok &amp;&amp; e.tryStore(&amp;value) &#123; return &#125; // å¦‚æœ`m.read`ä¸å­˜åœ¨æˆ–è€…å·²ç»è¢«æ ‡è®°åˆ é™¤ m.mu.Lock() read, _ = m.read.Load().(readOnly) if e, ok := read.m[key]; ok &#123; if e.unexpungeLocked() &#123; //æ ‡è®°æˆæœªè¢«åˆ é™¤ m.dirty[key] = e //m.dirtyä¸­ä¸å­˜åœ¨è¿™ä¸ªé”®ï¼Œæ‰€ä»¥åŠ å…¥m.dirty &#125; e.storeLocked(&amp;value) //æ›´æ–° &#125; else if e, ok := m.dirty[key]; ok &#123; // m.dirtyå­˜åœ¨è¿™ä¸ªé”®ï¼Œæ›´æ–° e.storeLocked(&amp;value) &#125; else &#123; //æ–°é”®å€¼ if !read.amended &#123; //m.dirtyä¸­æ²¡æœ‰æ–°çš„æ•°æ®ï¼Œå¾€m.dirtyä¸­å¢åŠ ç¬¬ä¸€ä¸ªæ–°é”® m.dirtyLocked() //ä»m.readä¸­å¤åˆ¶æœªåˆ é™¤çš„æ•°æ® m.read.Store(readOnly&#123;m: read.m, amended: true&#125;) &#125; m.dirty[key] = newEntry(value) //å°†è¿™ä¸ªentryåŠ å…¥åˆ°m.dirtyä¸­ &#125; m.mu.Unlock()&#125;func (m *Map) dirtyLocked() &#123; if m.dirty != nil &#123; return &#125; read, _ := m.read.Load().(readOnly) m.dirty = make(map[interface&#123;&#125;]*entry, len(read.m)) for k, e := range read.m &#123; if !e.tryExpungeLocked() &#123; m.dirty[k] = e &#125; &#125;&#125;func (e *entry) tryExpungeLocked() (isExpunged bool) &#123; p := atomic.LoadPointer(&amp;e.p) for p == nil &#123; // å°†å·²ç»åˆ é™¤æ ‡è®°ä¸ºnilçš„æ•°æ®æ ‡è®°ä¸ºexpunged if atomic.CompareAndSwapPointer(&amp;e.p, nil, expunged) &#123; return true &#125; p = atomic.LoadPointer(&amp;e.p) &#125; return p == expunged&#125; ä½ å¯ä»¥çœ‹åˆ°ï¼Œä»¥ä¸Šæ“ä½œéƒ½æ˜¯å…ˆä»æ“ä½œ m.read å¼€å§‹çš„ï¼Œä¸æ»¡è¶³æ¡ä»¶å†åŠ é”ï¼Œç„¶åæ“ä½œ m.dirtyã€‚ Store å¯èƒ½ä¼šåœ¨æŸç§æƒ…å†µä¸‹(åˆå§‹åŒ–æˆ–è€… m.dirty åˆšè¢«æå‡å)ä» m.read ä¸­å¤åˆ¶æ•°æ®ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ m.read ä¸­æ•°æ®é‡éå¸¸å¤§ï¼Œå¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚ Deleteåˆ é™¤ä¸€ä¸ªé”®å€¼ã€‚ 12345678910111213141516func (m *Map) Delete(key interface&#123;&#125;) &#123; read, _ := m.read.Load().(readOnly) e, ok := read.m[key] if !ok &amp;&amp; read.amended &#123; m.mu.Lock() read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok &amp;&amp; read.amended &#123; delete(m.dirty, key) &#125; m.mu.Unlock() &#125; if ok &#123; e.delete() &#125;&#125; åŒæ ·ï¼Œåˆ é™¤æ“ä½œè¿˜æ˜¯ä» m.read ä¸­å¼€å§‹ï¼Œ å¦‚æœè¿™ä¸ª entry ä¸å­˜åœ¨äº m.read ä¸­ï¼Œå¹¶ä¸” m.dirty ä¸­æœ‰æ–°æ•°æ®ï¼Œåˆ™åŠ é”å°è¯•ä» m.dirty ä¸­åˆ é™¤ã€‚ æ³¨æ„ï¼Œè¿˜æ˜¯è¦åŒæ£€æŸ¥çš„ã€‚ ä» m.dirty ä¸­ç›´æ¥åˆ é™¤å³å¯ï¼Œå°±å½“å®ƒæ²¡å­˜åœ¨è¿‡ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä» m.read ä¸­åˆ é™¤ï¼Œå¹¶ä¸ä¼šç›´æ¥åˆ é™¤ï¼Œè€Œæ˜¯æ‰“æ ‡è®°ï¼š 12345678910111213func (e *entry) delete() (hadValue bool) &#123; for &#123; p := atomic.LoadPointer(&amp;e.p) // å·²æ ‡è®°ä¸ºåˆ é™¤ if p == nil || p == expunged &#123; return false &#125; // åŸå­æ“ä½œï¼Œe.pæ ‡è®°ä¸ºnil if atomic.CompareAndSwapPointer(&amp;e.p, p, nil) &#123; return true &#125; &#125;&#125; Rangeå› ä¸ºfor ... range mapæ˜¯å†…å»ºçš„è¯­è¨€ç‰¹æ€§ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ä½¿ç”¨for rangeéå† sync.Map, ä½†æ˜¯å¯ä»¥ä½¿ç”¨å®ƒçš„Rangeæ–¹æ³•ï¼Œé€šè¿‡å›è°ƒçš„æ–¹å¼éå†ã€‚ 1234567891011121314151617181920212223242526func (m *Map) Range(f func(key, value interface&#123;&#125;) bool) &#123; read, _ := m.read.Load().(readOnly) // å¦‚æœm.dirtyä¸­æœ‰æ–°æ•°æ®ï¼Œåˆ™æå‡m.dirty,ç„¶ååœ¨éå† if read.amended &#123; //æå‡m.dirty m.mu.Lock() read, _ = m.read.Load().(readOnly) //åŒæ£€æŸ¥ if read.amended &#123; read = readOnly&#123;m: m.dirty&#125; m.read.Store(read) m.dirty = nil m.misses = 0 &#125; m.mu.Unlock() &#125; // éå†, for rangeæ˜¯å®‰å…¨çš„ for k, e := range read.m &#123; v, ok := e.load() if !ok &#123; continue &#125; if !f(k, v) &#123; break &#125; &#125;&#125; Range æ–¹æ³•è°ƒç”¨å‰å¯èƒ½ä¼šåšä¸€ä¸ª m.dirty çš„æå‡ï¼Œä¸è¿‡æå‡ m.dirty ä¸æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ“ä½œã€‚ sync.Map çš„æ€§èƒ½Go 1.9 æºä»£ç ä¸­æä¾›äº†æ€§èƒ½çš„æµ‹è¯•ï¼š map_bench_test.goã€map_reference_test.go æˆ‘ä¹ŸåŸºäºè¿™äº›ä»£ç ä¿®æ”¹äº†ä¸€ä¸‹ï¼Œå¾—åˆ°ä¸‹é¢çš„æµ‹è¯•æ•°æ®ï¼Œç›¸æ¯”è¾ƒä»¥å‰çš„è§£å†³æ–¹æ¡ˆï¼Œæ€§èƒ½å¤šå°‘å›æœ‰äº›æå‡ï¼Œå¦‚æœä½ ç‰¹åˆ«å…³æ³¨æ€§èƒ½ï¼Œå¯ä»¥è€ƒè™‘ sync.Mapã€‚ 12345678910111213141516BenchmarkHitAll&#x2F;*sync.RWMutexMap-4 20000000 83.8 ns&#x2F;opBenchmarkHitAll&#x2F;*sync.Map-4 30000000 59.9 ns&#x2F;opBenchmarkHitAll_WithoutPrompting&#x2F;*sync.RWMutexMap-4 20000000 96.9 ns&#x2F;opBenchmarkHitAll_WithoutPrompting&#x2F;*sync.Map-4 20000000 64.1 ns&#x2F;opBenchmarkHitNone&#x2F;*sync.RWMutexMap-4 20000000 79.1 ns&#x2F;opBenchmarkHitNone&#x2F;*sync.Map-4 30000000 43.3 ns&#x2F;opBenchmarkHit_WithoutPrompting&#x2F;*sync.RWMutexMap-4 20000000 81.5 ns&#x2F;opBenchmarkHit_WithoutPrompting&#x2F;*sync.Map-4 30000000 44.0 ns&#x2F;opBenchmarkUpdate&#x2F;*sync.RWMutexMap-4 5000000 328 ns&#x2F;opBenchmarkUpdate&#x2F;*sync.Map-4 10000000 146 ns&#x2F;opBenchmarkUpdate_WithoutPrompting&#x2F;*sync.RWMutexMap-4 5000000 336 ns&#x2F;opBenchmarkUpdate_WithoutPrompting&#x2F;*sync.Map-4 5000000 324 ns&#x2F;opBenchmarkDelete&#x2F;*sync.RWMutexMap-4 10000000 155 ns&#x2F;opBenchmarkDelete&#x2F;*sync.Map-4 30000000 55.0 ns&#x2F;opBenchmarkDelete_WithoutPrompting&#x2F;*sync.RWMutexMap-4 10000000 173 ns&#x2F;opBenchmarkDelete_WithoutPrompting&#x2F;*sync.Map-4 10000000 å…¶å®ƒsync.Map æ²¡æœ‰ Len æ–¹æ³•ï¼Œå¹¶ä¸”ç›®å‰æ²¡æœ‰è¿¹è±¡è¦åŠ ä¸Š (issue#20680),æ‰€ä»¥å¦‚æœæƒ³å¾—åˆ°å½“å‰ Map ä¸­æœ‰æ•ˆçš„ entries çš„æ•°é‡ï¼Œéœ€è¦ä½¿ç”¨ Range æ–¹æ³•éå†ä¸€æ¬¡ï¼Œ æ¯”è¾ƒ X ç–¼ã€‚ LoadOrStore æ–¹æ³•å¦‚æœæä¾›çš„ key å­˜åœ¨ï¼Œåˆ™è¿”å›å·²å­˜åœ¨çš„å€¼(Load)ï¼Œå¦åˆ™ä¿å­˜æä¾›çš„é”®å€¼(Store)ã€‚","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"}]},{"title":"ã€Redisã€‘- äº‹åŠ¡å’ŒLuaè„šæœ¬","slug":"Redis/redisäº‹åŠ¡å’Œlua","date":"2020-06-02T02:46:51.000Z","updated":"2021-03-20T16:25:01.800Z","comments":true,"path":"2020/06/02/Redis/redisäº‹åŠ¡å’Œlua/","link":"","permalink":"http://blog.crazylaw.cn/2020/06/02/Redis/redis%E4%BA%8B%E5%8A%A1%E5%92%8Clua/","excerpt":"å‰è¨€Redis æˆ‘ä»¬ç”¨çš„è›®å¤šçš„äº†ï¼Œä½†æ˜¯ä¸€ç›´ä¹Ÿæ²¡æœ‰æ•´ç†ä»€ä¹ˆèµ„æ–™ï¼Œåˆšå¥½ä»Šå¤©è¦å¤„ç†ä¸€ä¸‹ï¼Œé¡ºä¾¿ä¸€ä¸‹ç›¸å…³çš„äº‹åŠ¡å’Œ lua è„šæœ¬çš„å†…å®¹ï¼Œç”±äºç®¡é“(pipeline)ä¸åœ¨è¿™æ¬¡åŸå­æ€§é—®é¢˜å½“ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸åŠ è¿›æ¥æ¯”è¾ƒè¯´æ˜äº†ã€‚","text":"å‰è¨€Redis æˆ‘ä»¬ç”¨çš„è›®å¤šçš„äº†ï¼Œä½†æ˜¯ä¸€ç›´ä¹Ÿæ²¡æœ‰æ•´ç†ä»€ä¹ˆèµ„æ–™ï¼Œåˆšå¥½ä»Šå¤©è¦å¤„ç†ä¸€ä¸‹ï¼Œé¡ºä¾¿ä¸€ä¸‹ç›¸å…³çš„äº‹åŠ¡å’Œ lua è„šæœ¬çš„å†…å®¹ï¼Œç”±äºç®¡é“(pipeline)ä¸åœ¨è¿™æ¬¡åŸå­æ€§é—®é¢˜å½“ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸åŠ è¿›æ¥æ¯”è¾ƒè¯´æ˜äº†ã€‚ è¯´æ˜Redis çš„åŸå­æ€§é—®é¢˜ï¼Œåœ¨ä¸€ç›´é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œæ˜¯ä¸€ä¸ªéœ€è¦é‡è§†çš„é—®é¢˜ï¼Œå¦åˆ™åŸå­æ€§ä¸æ»¡è¶³å°†ä¼šå¯¼è‡´ä¸šåŠ¡é€»è¾‘å‡ºç°é—®é¢˜ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¸¸ç”¨è§£å†³åŸå­æ€§é—®é¢˜çš„ä¸€èˆ¬éƒ½æ˜¯ç”¨ redis è‡ªå¸¦çš„å‘½ä»¤ï¼Œä¾‹å¦‚ brpoplpush ä¹‹ç±»çš„å‘½ä»¤ ä½†æ˜¯æˆ‘ä»¬å¯èƒ½éœ€è¦æ›´å¤šçš„ç»„åˆæˆä¸€ä¸ªåŸå­æ€§æ“ä½œ å› æ­¤ï¼Œè¿™é‡Œä¼šæœ‰ 2 ç§é€‰æ‹©ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š äº‹åŠ¡ lua è„šæœ¬ äº‹åŠ¡redis äº‹åŠ¡æä¾›äº†ä¸€ç§â€œå°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ï¼Œ ç„¶åä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œâ€çš„æœºåˆ¶ï¼Œ å¹¶ä¸”äº‹åŠ¡åœ¨æ‰§è¡Œçš„æœŸé—´ä¸ä¼šä¸»åŠ¨ä¸­æ–­ æˆ‘ä»¬å¯ä»¥é€šè¿‡ MULTI å‘½ä»¤å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç±»ä¼¼äº mysql çš„ BEGIN TRANSACTION è¯­å¥ åœ¨è¯¥è¯­å¥ä¹‹åæ‰§è¡Œçš„å‘½ä»¤éƒ½å°†è¢«è§†ä¸ºäº‹åŠ¡ä¹‹å†…çš„æ“ä½œ æœ€åæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œ EXEC/DISCARD å‘½ä»¤æ¥æäº¤/å›æ»šè¯¥äº‹åŠ¡å†…çš„æ‰€æœ‰æ“ä½œ è¿™ä¸¤ä¸ª Redis å‘½ä»¤å¯è¢«è§†ä¸ºç­‰åŒäºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ COMMIT/ROLLBACK è¯­å¥ æœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤ä¹‹åï¼Œ æ‰ä¼šç»§ç»­å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å…¶ä»–å‘½ä»¤ è¢«æ‰§è¡Œçš„å‘½ä»¤è¦ä¹ˆå…¨éƒ¨éƒ½è¢«æ‰§è¡Œï¼Œè¦ä¹ˆä¸€ä¸ªä¹Ÿä¸æ‰§è¡Œï¼Œå¹¶ä¸”äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«å…¶ä»–å·¥ä½œæ‰“æ–­ ä¸€ä¸ª redis äº‹åŠ¡ä»å¼€å§‹åˆ°æ‰§è¡Œä¼šç»å†ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š å¼€å§‹äº‹åŠ¡ â€“ MULTImulti å‘½ä»¤è®©å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢åˆ°äº‹åŠ¡çŠ¶æ€ å‘½ä»¤å…¥é˜Ÿå¦‚æœå®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œé‚£ä¹ˆæ‰€æœ‰å‘é€ç»™æœåŠ¡ç«¯çš„å‘½ä»¤éƒ½ä¼šç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œï¼Œè€Œå¦‚æœå®¢æˆ·ç«¯å¤„äºäº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œé‚£ä¹ˆæ‰€æœ‰å‘½ä»¤éƒ½è¿˜ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¢«å‘é€åˆ°ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè¿”å› QUEUEDï¼Œè¡¨ç¤ºå…¥é˜ŸæˆåŠŸ äº‹åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ æ¯ä¸ªæ•°ç»„é¡¹æ˜¯éƒ½åŒ…å«ä¸‰ä¸ªå±æ€§ cmd â€“ è¦æ‰§è¡Œçš„å‘½ä»¤ argv â€“ å‘½ä»¤çš„å‚æ•° argc â€“ å‚æ•°ä¸ªæ•° ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤ï¼š 1234127.0.0.1:6379&gt; SET msg &quot;hello caiwenhui&quot;QUEUED127.0.0.1:6379&gt; GET msgQUEUED redis server å°†åˆ›å»ºä»¥ä¸‹äº‹åŠ¡é˜Ÿåˆ—ï¼š index cmd argv argc 0 SET [â€œmsgâ€, â€œhello caiwenhuiâ€] 2 1 GET [â€œmsgâ€] 1 æ‰§è¡Œäº‹åŠ¡å¦‚æœå®¢æˆ·ç«¯æ­£å¤„äºäº‹åŠ¡çŠ¶æ€ï¼Œ é‚£ä¹ˆå½“ EXEC å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œ æœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯æ‰€ä¿å­˜çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œ ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼æ‰§è¡Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ ç„¶åå°†æ‰§è¡Œå‘½ä»¤æ‰€å¾—çš„ç»“æœä»¥ FIFO çš„é¡ºåºä¿å­˜åˆ°ä¸€ä¸ªå›å¤é˜Ÿåˆ—ä¸­ ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œä¸Šè¿°ä¸¤ä¸ªå‘½ä»¤åæ‰§è¡Œ EXEC å‘½ä»¤ï¼Œå°†ä¼šåˆ›å»ºå¦‚ä¸‹å›å¤é˜Ÿåˆ—ï¼š index ç±»å‹ å†…å®¹ 0 status code reply OK 1 bulk reply â€œhello motoâ€ 123456789127.0.0.1:6379&gt; multiOK127.0.0.1:6379&gt; SET msg &quot;hello caiwenhi&quot;QUEUED127.0.0.1:6379&gt; GET msgQUEUED127.0.0.1:6379&gt; EXEC1) OK1) hello caiwenhui WATCHWatch å‘½ä»¤ç”¨äºç›‘è§†ä¸€ä¸ª(æˆ–å¤šä¸ª) key ï¼Œå¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ª(æˆ–è¿™äº›) key è¢«å…¶ä»–å‘½ä»¤æ‰€æ”¹åŠ¨ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­ WATCH å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹å‰æ‰§è¡Œï¼Œ åœ¨äº‹åŠ¡çŠ¶æ€ä¸‹å‘é€ WATCH å‘½ä»¤ä¼šå¼•å‘é”™è¯¯ redis ä¸­ä¿å­˜äº†ä¸€ä¸ª watched_keys å­—å…¸ï¼Œå­—å…¸çš„é”®æ˜¯è¿™ä¸ªæ•°æ®åº“è¢«ç›‘è§†çš„é”®ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰ç›‘è§†è¿™ä¸ªé”®çš„å®¢æˆ·ç«¯ æ¯å½“ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œ WATCH å‘½ä»¤ï¼Œå¯¹åº”çš„ key æŒ‡å‘çš„é“¾è¡¨ä¸­å°±ä¼šå¢åŠ è¯¥å®¢æˆ·ç«¯çš„èŠ‚ç‚¹ å›¾æ„å‘³ç€ï¼Œkey1 æ­£åœ¨è¢« client1 å’Œ client2 ä¸¤ä¸ªå®¢æˆ·ç«¯ç›‘è§†ç€ï¼Œkey2 è¢« client3 ç›‘è§†ç€ï¼Œkey3 è¢« client4 ç›‘è§†ç€ ä¸€æ—¦å¯¹æ•°æ®åº“é”®ç©ºé—´è¿›è¡Œçš„ä¿®æ”¹æˆåŠŸæ‰§è¡Œï¼Œmulti.c çš„ touchWatchedKey å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œä»–çš„å·¥ä½œå°±æ˜¯éå†ä¸Šè¿°å­—å…¸ä¸­è¯¥ key æ‰€å¯¹åº”çš„æ•´ä¸ªé“¾è¡¨çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œæ‰“å¼€æ¯ä¸€ä¸ª WATCH è¯¥ key çš„ client çš„ REDIS_DIRTY_CAS é€‰é¡¹ å½“å®¢æˆ·ç«¯å‘é€ EXEC å‘½ä»¤è§¦å‘äº‹åŠ¡æ‰§è¡Œæ—¶ï¼ŒæœåŠ¡å™¨ä¼šå¯¹å®¢æˆ·ç«¯çŠ¶æ€è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹å·²ç»è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜è¢«å®¢æˆ·ç«¯ç›‘è§†çš„é”®è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹ï¼Œäº‹åŠ¡å®‰å…¨æ€§å·²ç»è¢«ç ´åï¼Œåˆ™æœåŠ¡ç«¯ç›´æ¥å‘å®¢æˆ·ç«¯è¿”å›ç©ºå›å¤ï¼Œè¡¨ç¤ºäº‹åŠ¡æ‰§è¡Œå¤±è´¥ å½“ä¸€ä¸ªå®¢æˆ·ç«¯ç»“æŸå®ƒçš„äº‹åŠ¡æ—¶ï¼Œæ— è®ºäº‹åŠ¡æ˜¯æˆåŠŸæ‰§è¡Œï¼Œè¿˜æ˜¯å¤±è´¥ï¼Œ watched_keys å­—å…¸ä¸­å’Œè¿™ä¸ªå®¢æˆ·ç«¯ç›¸å…³çš„èµ„æ–™éƒ½ä¼šè¢«æ¸…é™¤ redis äº‹åŠ¡çš„ç‰¹æ€§ å¦‚æœåœ¨æ‰§è¡Œ exec ä¹‹å‰äº‹åŠ¡ä¸­æ–­äº†ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¸ä¼šæ‰§è¡Œ å¦‚æœæŸä¸ªå‘½ä»¤è¯­æ³•é”™è¯¯ï¼Œä¸ä»…ä¼šå¯¼è‡´è¯¥å‘½ä»¤å…¥é˜Ÿå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½å°†æ— æ³•æ‰§è¡Œ å¦‚æœæ‰§è¡Œäº† exec å‘½ä»¤ä¹‹åï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šæŒ‰åºæ‰§è¡Œ å½“ redis åœ¨æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯ï¼Œé‚£ä¹ˆ redis ä¸ä¼šç»ˆæ­¢å…¶å®ƒå‘½ä»¤çš„æ‰§è¡Œï¼Œè¿™æ˜¯ä¸å…³ç³»å‹æ•°æ®åº“äº‹åŠ¡æœ€å¤§çš„åŒºåˆ«ï¼Œredis äº‹åŠ¡ä¸ä¼šå› ä¸ºæŸä¸ªå‘½ä»¤æ‰§è¡Œå¤±è´¥è€Œå›æ»š redis äº‹åŠ¡çš„ç¼ºé™·ä¸æ»¡è¶³åŸå­æ€§ä¸å…³ç³»å‹æ•°æ®åº“çš„äº‹åŠ¡ä¸åŒï¼Œredis äº‹åŠ¡æ˜¯ä¸æ»¡è¶³åŸå­æ€§çš„ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡æˆ– client æ˜¯å¯ä»¥å¯¹ç›¸åº”çš„ key è¿›è¡Œä¿®æ”¹çš„ æƒ³è¦é¿å…è¿™æ ·çš„å¹¶å‘æ€§é—®é¢˜å°±éœ€è¦ä½¿ç”¨ WATCH å‘½ä»¤ï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´ï¼Œå¿…é¡»ç»è¿‡ä»”ç»†è€ƒè™‘æ‰èƒ½å†³å®šç©¶ç«Ÿéœ€è¦å¯¹å“ªäº› key è¿›è¡Œ WATCH åŠ é” é¢å¤–çš„ WATCH ä¼šå¢åŠ äº‹åŠ¡å¤±è´¥çš„å¯èƒ½ï¼Œè€Œç¼ºå°‘å¿…è¦çš„ WATCH åˆä¼šè®©æˆ‘ä»¬çš„ç¨‹åºäº§ç”Ÿç«äº‰æ¡ä»¶ åæ‰§è¡Œçš„å‘½ä»¤æ— æ³•ä¾èµ–å…ˆæ‰§è¡Œå‘½ä»¤çš„ç»“æœç”±äºäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼Œåœ¨é‡åˆ° exec å‘½ä»¤ä¹‹å‰å¹¶æ²¡æœ‰çœŸæ­£çš„æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•åœ¨äº‹åŠ¡ä¸­çš„å‘½ä»¤ä¸­ä½¿ç”¨å‰é¢å‘½ä»¤çš„æŸ¥è¯¢ç»“æœ æˆ‘ä»¬å”¯ä¸€å¯ä»¥åšçš„å°±æ˜¯é€šè¿‡ watch ä¿è¯åœ¨æˆ‘ä»¬è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¦‚æœå…¶å®ƒäº‹åŠ¡åˆšå¥½è¿›è¡Œäº†ä¿®æ”¹ï¼Œåˆ™æˆ‘ä»¬çš„ä¿®æ”¹åœæ­¢ï¼Œç„¶ååº”ç”¨å±‚åšç›¸åº”çš„å¤„ç† äº‹åŠ¡ä¸­çš„æ¯æ¡å‘½ä»¤éƒ½ä¼šä¸ redis æœåŠ¡å™¨è¿›è¡Œç½‘ç»œäº¤äº’redis äº‹åŠ¡å¼€å¯ä¹‹åï¼Œæ¯æ‰§è¡Œä¸€ä¸ªæ“ä½œè¿”å›çš„éƒ½æ˜¯ queuedï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„å¤šæ¬¡äº¤äº’ æ˜æ˜æ˜¯éœ€è¦ä¸€æ¬¡æ‰¹é‡æ‰§è¡Œçš„ n æ¡å‘½ä»¤ï¼Œè¿˜éœ€è¦é€šè¿‡å¤šæ¬¡ç½‘ç»œäº¤äº’ï¼Œæ˜¾ç„¶éå¸¸æµªè´¹ è¿™ä¸ªå°±æ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰ pipeline çš„åŸå› ï¼Œå‡å°‘ RTT çš„æ—¶é—´ redis äº‹åŠ¡ç¼ºé™·çš„è§£å†³ â€“ LuaLua æ˜¯ä¸€ä¸ªå°å·§çš„è„šæœ¬è¯­è¨€ï¼Œæœ‰æ ‡å‡† C ç¼–å†™ï¼Œå‡ ä¹åœ¨æ‰€æœ‰æ“ä½œç³»ç»Ÿå’Œå¹³å°ä¸Šéƒ½å¯ä»¥ç¼–è¯‘è¿è¡Œ ä¸€ä¸ªå®Œæ•´çš„ Lua è§£é‡Šå™¨ä¸è¿‡ 200kï¼Œåœ¨ç›®å‰æ‰€æœ‰è„šæœ¬å¼•æ“ä¸­ï¼ŒLua çš„é€Ÿåº¦æ˜¯æœ€å¿«çš„ï¼Œè¿™ä¸€åˆ‡éƒ½å†³å®šäº† Lua æ˜¯ä½œä¸ºåµŒå…¥å¼è„šæœ¬çš„æœ€ä½³é€‰æ‹© redis 2.6 ç‰ˆæœ¬ä¹‹åä¹Ÿå†…åµŒäº†ä¸€ä¸ª Lua è§£é‡Šå™¨ï¼Œå¯ä»¥ç”¨äºä¸€äº›ç®€å•çš„äº‹åŠ¡ä¸é€»è¾‘è¿ç®— Redis å†…åµŒ Lua çš„ä¼˜åŠ¿åœ¨æœåŠ¡ç«¯å®ç°ä¸šåŠ¡é€»è¾‘æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„ï¼Œredis äº‹åŠ¡æ‰§è¡Œä¸­ï¼Œæ¯ä¸€æ¡æŒ‡ä»¤ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæˆ‘ä»¬æ— æ³•è®©åé¢çš„æ“ä½œä¾èµ–å‰é¢å‘½åçš„ç»“æœï¼Œè¿™å°±è®©æ•´ä¸ªäº‹åŠ¡ä»…ä»…æˆä¸ºäº†ä¸€ä¸ªå‘½ä»¤é›†åˆï¼Œåœ¨å‘½ä»¤ä¹‹é—´æˆ‘ä»¬å®Œå…¨æ— æ³•åšä»»ä½•äº‹ ä½†æ˜¯ï¼ŒLua ä½œä¸ºä¸€ä¸ªè„šæœ¬è¯­è¨€ï¼Œå¯ä»¥æ‹¥æœ‰åˆ†æ”¯ã€å¾ªç¯ç­‰è¯­æ³•ç»“æ„ï¼Œå¯ä»¥è¿›è¡Œä¸šåŠ¡é€»è¾‘çš„ç¼–å†™ åŸå­æ€§ç”±äº Lua è„šæœ¬æ˜¯æäº¤åˆ° Redis server è¿›è¡Œä¸€æ¬¡æ€§æ‰§è¡Œçš„ï¼Œæ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«å…¶ä»–ä»»ä½•å·¥ä½œæ‰“æ–­ï¼Œå…¶å®ƒä»»ä½•è„šæœ¬æˆ–è€…å‘½ä»¤éƒ½æ— æ³•æ‰§è¡Œ,ä¹Ÿå°±ä¸ä¼šå¼•èµ·ç«äº‰æ¡ä»¶ï¼Œä»è€Œæœ¬èº«å°±å®ç°äº†äº‹åŠ¡çš„åŸå­æ€§ ä½†æ˜¯ï¼Œè¿™åŒæ ·ä¼šå¼•èµ·ä¸€ä¸ªé—®é¢˜ï¼Œæ­£å¦‚å®˜æ–¹æ–‡æ¡£æ‰€è¯´çš„ï¼Œæ­£æ˜¯ç”±äº script æ‰§è¡Œçš„åŸå­æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸è¦åœ¨ script ä¸­æ‰§è¡Œè¿‡é•¿å¼€é”€çš„ç¨‹åºï¼Œå¦åˆ™ä¼šéªŒè¯å½±å“å…¶å®ƒè¯·æ±‚çš„æ‰§è¡Œ å¯å¤ç”¨æ‰€æœ‰ Lua è„šæœ¬éƒ½æ˜¯å¯é‡ç”¨çš„ï¼Œè¿™æ ·å°±å‡å°‘äº†ç½‘ç»œå¼€é”€ EVAL script numkeys key[key â€¦] arg [argâ€¦] EVALSHA sha1 SCRIPT LOAD script SCRIPT EXISTS sha1 EVAL1EVAL script numkeys key [key ...] arg [arg ...] å‚æ•° æè¿° script ä¸€æ®µ Lua è„šæœ¬æˆ– Lua è„šæœ¬æ–‡ä»¶æ‰€åœ¨è·¯å¾„åŠæ–‡ä»¶å numkeys Lua è„šæœ¬å¯¹åº”å‚æ•°æ•°é‡ key [key â€¦] Lua ä¸­é€šè¿‡å…¨å±€å˜é‡ KEYS æ•°ç»„å­˜å‚¨çš„ä¼ å…¥å‚æ•° arg [arg â€¦] Lua ä¸­é€šè¿‡å…¨å±€å˜é‡ ARGV æ•°ç»„å­˜å‚¨çš„ä¼ å…¥é™„åŠ å‚æ•° 12345EVAL &quot;return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;&quot; 2 key1 key2 first second1) &quot;key1&quot;2) &quot;key2&quot;3) &quot;first&quot;4) &quot;second&quot; SCRIPT LOAD ä¸ EVALSHA å‘½ä»¤å¯¹äºä¸ç«‹å³æ‰§è¡Œçš„ Lua è„šæœ¬ï¼Œæˆ–éœ€è¦é‡ç”¨çš„ Lua è„šæœ¬ï¼Œå¯ä»¥é€šè¿‡ SCRIPT LOAD æå‰è½½å…¥ Lua è„šæœ¬ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šç«‹å³è¿”å›å¯¹åº”çš„ SHA1 æ ¡éªŒç  å½“éœ€è¦æ‰§è¡Œå‡½æ•°æ—¶ï¼Œé€šè¿‡ EVALSHA è°ƒç”¨ SCRIPT LOAD è¿”å›çš„ SHA1 å³å¯ 12345678SCRIPT LOAD &quot;return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;&quot;&quot;232fd51614574cf0867b83d384a5e898cfd24e5a&quot;EVALSHA &quot;232fd51614574cf0867b83d384a5e898cfd24e5a&quot; 2 key1 key2 first second1) &quot;key1&quot;2) &quot;key2&quot;3) &quot;first&quot;4) &quot;second&quot; é€šè¿‡ Lua è„šæœ¬æ‰§è¡Œ redis å‘½ä»¤åœ¨ Lua è„šæœ¬ä¸­ï¼Œåªè¦ä½¿ç”¨ redis.call ä¼ å…¥ redis å‘½ä»¤å°±å¯ä»¥ç›´æ¥æ‰§è¡Œ 1eval &quot;return redis.call(&#39;set&#39;,KEYS[1],&#39;bar&#39;)&quot; 1 foo --ç­‰åŒäºåœ¨æœåŠ¡ç«¯æ‰§è¡Œ set foo bar ä½¿ç”¨ Lua è„šæœ¬å®ç°è®¿é—®é¢‘ç‡é™åˆ¶12345678910111213141516171819202122---- KEYS[1] è¦é™åˆ¶çš„ip-- ARGV[1] é™åˆ¶çš„è®¿é—®æ¬¡æ•°-- ARGV[2] é™åˆ¶çš„æ—¶é—´--local key = \"rate.limit:\" .. KEYS[1]local limit = tonumber(ARGV[1])local expire_time = ARGV[2]local is_exists = redis.call(\"EXISTS\", key)if is_exists == 1 then if redis.call(\"INCR\", key) &gt; limit then return 0 else return 1 endelse redis.call(\"SET\", key, 1) redis.call(\"EXPIRE\", key, expire_time) return 1end","categories":[{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/categories/Redis/"}],"tags":[{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/tags/Redis/"}]},{"title":"ã€Golangã€‘- confluent-kafka-go","slug":"Golang/confluent-kafka-go","date":"2020-06-01T01:46:51.000Z","updated":"2021-03-20T16:25:01.799Z","comments":true,"path":"2020/06/01/Golang/confluent-kafka-go/","link":"","permalink":"http://blog.crazylaw.cn/2020/06/01/Golang/confluent-kafka-go/","excerpt":"å‰è¨€ç”±äºæˆ‘ä»¬éƒ¨é—¨çš„ä¸€äº›å¤§æ•°æ®æœåŠ¡æ˜¯ç”¨åˆ° kafka çš„ï¼Œè¿™ä¸ªæ—¶æœŸæ­£å€¼æˆ‘ä»¬å¯¹ golang è¯­è¨€å¯¹ä¸€ä¸ªè½¬å‹é˜¶æ®µï¼Œå¯¹æ¯”äº†ä¸€ä¸‹å¼€æºå¯¹ kafka å®¢æˆ·ç«¯ï¼Œå†³å®šä½¿ç”¨ confluent-kafka-go, æ‰€ä»¥åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹confluent-kafka-go çš„ä¸€äº›å†…å®¹","text":"å‰è¨€ç”±äºæˆ‘ä»¬éƒ¨é—¨çš„ä¸€äº›å¤§æ•°æ®æœåŠ¡æ˜¯ç”¨åˆ° kafka çš„ï¼Œè¿™ä¸ªæ—¶æœŸæ­£å€¼æˆ‘ä»¬å¯¹ golang è¯­è¨€å¯¹ä¸€ä¸ªè½¬å‹é˜¶æ®µï¼Œå¯¹æ¯”äº†ä¸€ä¸‹å¼€æºå¯¹ kafka å®¢æˆ·ç«¯ï¼Œå†³å®šä½¿ç”¨ confluent-kafka-go, æ‰€ä»¥åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹confluent-kafka-go çš„ä¸€äº›å†…å®¹ è¯´æ˜confluent-kafka-go æ˜¯ä¸€ä¸ª confluent å®˜æ–¹çš„ golang è¯­è¨€åº“ï¼Œå…¶ä¾èµ–äº librdkafka å®ç°ï¼Œå¤§å¤šæ•°æœºå™¨ï¼Œ\blibrakafka éƒ½å·²ç»é¢„ç¼–è¯‘è¿›å» golang æ‰©å±•äº†ï¼Œä¸éœ€è¦é¢å¤–å®‰è£… librdkafkaï¼Œå¦‚æœä¸æ”¯æŒé¢„ç¼–è¯‘çš„è¯ï¼Œåˆ™éœ€è¦é¢å¤–å®‰è£…ã€‚ æä¾›ä¸€ä¸ª dockerfile çš„ demo 1234567891011121314151617181920212223242526272829303132333435# debian10 : buster# debian9 : buster# debian8 : jessie# debian7 : wheezyFROM golang:1.14.3-busterENV GO111MODULE=onENV GOPROXY=https://goproxy.io,directENV GOPRIVATE=git.mingchao.com# 1. æ¢æº# 2. åŠ å…¥confluentçš„æºï¼Œå®‰è£…librakafkaRUN echo \\ deb http://mirrors.aliyun.com/debian/ buster main non-free contrib \\ deb-src http://mirrors.aliyun.com/debian/ buster main non-free contrib \\ deb http://mirrors.aliyun.com/debian-security buster/updates main \\ deb-src http://mirrors.aliyun.com/debian-security buster/updates main \\ deb http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib \\ deb-src http://mirrors.aliyun.com/debian/ buster-updates main non-free contrib \\ deb http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib \\ deb-src http://mirrors.aliyun.com/debian/ buster-backports main non-free contrib \\ &gt; /etc/apt/sources.list &amp;&amp; \\ apt-get update -y &amp;&amp; \\ wget -qO - https://packages.confluent.io/deb/5.5/archive.key | apt-key add - &gt; /dev/null &amp;&amp; \\ sed -i '$a deb [arch=amd64] https://packages.confluent.io/deb/5.5 stable main' /etc/apt/sources.list &amp;&amp; \\ apt-get install -y librdkafka-devARG GIT_USERNAME=gitARG GIT_PASSWORD=git-passwordARG GIT_CREDEN_FILE=/.git-credentialsRUN touch $&#123;GIT_CREDEN_FILE&#125; &amp;&amp; \\ chown 600 $&#123;GIT_CREDEN_FILE&#125; &amp;&amp; \\ git config --global credential.helper 'store --file '$&#123;GIT_CREDEN_FILE&#125; &amp;&amp; \\ echo https://$&#123;GIT_USERNAME&#125;:$&#123;GIT_PASSWORD&#125;@git.mingchao.com | tee $&#123;GIT_CREDEN_FILE&#125; æºç  Api è¯´æ˜consumer.go è¿™æ˜¯ä¸€ä¸ª consumer ç›¸å…³çš„æ–‡ä»¶ã€‚ Subscribe(topic string, rebalanceCb RebalanceCb) errorè®¢é˜…ä¸€ä¸ª topicï¼Œè¿™ä¸ª api ä¼šè¦†ç›–ä¹‹å‰è®¾ç½®è¿‡äº†çš„ topic è®¢é˜… 123func (c *Consumer) Subscribe(topic string, rebalanceCb RebalanceCb) error &#123; return c.SubscribeTopics([]string&#123;topic&#125;, rebalanceCb)&#125; SubscribeTopics(topics []string, rebalanceCb RebalanceCb) (err error) è®¢é˜…å¤šä¸ª topic è¿™ä¸ª api ä¼šè¦†ç›–ä¹‹å‰è®¾ç½®è¿‡äº†çš„ topic è®¢é˜… 1234567891011121314151617181920func (c *Consumer) SubscribeTopics(topics []string, rebalanceCb RebalanceCb) (err error) &#123; ctopics := C.rd_kafka_topic_partition_list_new(C.int(len(topics))) defer C.rd_kafka_topic_partition_list_destroy(ctopics) for _, topic := range topics &#123; ctopic := C.CString(topic) defer C.free(unsafe.Pointer(ctopic)) C.rd_kafka_topic_partition_list_add(ctopics, ctopic, C.RD_KAFKA_PARTITION_UA) &#125; e := C.rd_kafka_subscribe(c.handle.rk, ctopics) if e != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return newError(e) &#125; c.rebalanceCb = rebalanceCb c.handle.currAppRebalanceEnable = c.rebalanceCb != nil || c.appRebalanceEnable return nil&#125; Unsubscribe() (err error) å–æ¶ˆå½“å‰å¯¹ topic çš„è®¢é˜… 1234func (c *Consumer) Unsubscribe() (err error) &#123; C.rd_kafka_unsubscribe(c.handle.rk) return nil&#125; Assign(partitions []TopicPartition) (err error) åˆ†é…ä¸€ç»„è¦ä½¿ç”¨çš„ partition è¿™ä¸ª api ä¼šè¦†ç›–ä¹‹å‰åˆ†é…è¿‡çš„ 12345678910111213func (c *Consumer) Assign(partitions []TopicPartition) (err error) &#123; c.appReassigned = true cparts := newCPartsFromTopicPartitions(partitions) defer C.rd_kafka_topic_partition_list_destroy(cparts) e := C.rd_kafka_assign(c.handle.rk, cparts) if e != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return newError(e) &#125; return nil&#125; Unassign() (err error) å–æ¶ˆå½“å‰åˆ†é…çš„ partition 12345678910func (c *Consumer) Unassign() (err error) &#123; c.appReassigned = true e := C.rd_kafka_assign(c.handle.rk, nil) if e != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return newError(e) &#125; return nil&#125; Commit() ([]TopicPartition, error) æäº¤å½“å‰å·²ç»åˆ†é…çš„ partition çš„ offset å€¼ åŸºäº StoreOffsets(offsets []TopicPartition) (storedOffsets []TopicPartition, err error) è¿™æ˜¯ä¸€ä¸ªé˜»å¡è¯·æ±‚ï¼Œå¦‚æœéœ€è¦å¼‚æ­¥æ“ä½œï¼Œéœ€è¦è°ƒç”¨è€…è‡ªè¡Œç”¨åç¨‹ è¿”å›æˆåŠŸæäº¤ offset çš„ topicPartition 123func (c *Consumer) Commit() ([]TopicPartition, error) &#123; return c.commit(nil)&#125; CommitMessage(m *Message) ([]TopicPartition, error) è¿™ä¸ª API åŸºäº message ç»“æ„ä½“ è¿™æ˜¯ä¸€ä¸ªé˜»å¡è¯·æ±‚ï¼Œå¦‚æœéœ€è¦å¼‚æ­¥æ“ä½œï¼Œéœ€è¦è°ƒç”¨è€…è‡ªè¡Œç”¨åç¨‹ è¿”å›æˆåŠŸæäº¤ offset çš„ topicPartition 12345678func (c *Consumer) CommitMessage(m *Message) ([]TopicPartition, error) &#123; if m.TopicPartition.Error != nil &#123; return nil, newErrorFromString(ErrInvalidArg, \"Can't commit errored message\") &#125; offsets := []TopicPartition&#123;m.TopicPartition&#125; offsets[0].Offset++ return c.commit(offsets)&#125; CommitOffsets(offsets []TopicPartition) ([]TopicPartition, error) æ ¹æ® []TopicPartition æ¥æäº¤ offset è¿™æ˜¯ä¸€ä¸ªé˜»å¡è¯·æ±‚ï¼Œå¦‚æœéœ€è¦å¼‚æ­¥æ“ä½œï¼Œéœ€è¦è°ƒç”¨è€…è‡ªè¡Œç”¨åç¨‹ è¿”å›æˆåŠŸæäº¤ offset çš„ topicPartition 123func (c *Consumer) CommitOffsets(offsets []TopicPartition) ([]TopicPartition, error) &#123; return c.commit(offsets)&#125; StoreOffsets(offsets []TopicPartition) (storedOffsets []TopicPartition, err error) æ ¹æ® []TopicPartition æ¥è®°å½•å°†ä¼šè¢«æäº¤çš„ offsetï¼ˆå¦‚æœå…è®¸è‡ªåŠ¨æäº¤çš„è¯ï¼Œé‚£ä¹ˆä¼šå—auto.commit.interval.msçš„å½±å“ï¼Œä¸€å®šå‘¨æœŸæ€§æäº¤ï¼Œå¦‚æœæ˜¯æ‰‹åŠ¨æäº¤çš„è¯åˆ™ä¾èµ– Commit()Apiï¼‰ è¿”å›æˆåŠŸå­˜å‚¨çš„ offsetsï¼Œå¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªåç§»é‡æ— æ³•å­˜å‚¨ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯å’Œåç§»é‡åˆ—è¡¨ã€‚æ¯ä¸ªåç§»é‡éƒ½å¯ä»¥é€šè¿‡å®ƒçš„æ¥æ£€æŸ¥ç‰¹å®šçš„é”™è¯¯ 123456789101112131415func (c *Consumer) StoreOffsets(offsets []TopicPartition) (storedOffsets []TopicPartition, err error) &#123; coffsets := newCPartsFromTopicPartitions(offsets) defer C.rd_kafka_topic_partition_list_destroy(coffsets) cErr := C.rd_kafka_offsets_store(c.handle.rk, coffsets) // coffsets might be annotated with an error storedOffsets = newTopicPartitionsFromCparts(coffsets) if cErr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return storedOffsets, newError(cErr) &#125; return storedOffsets, nil&#125; Seek(partition TopicPartition, timeoutMs int) error è·å–æŒ‡å®š partition çš„ offset å¦‚æœtimeoutMsä¸æ˜¯ 0ï¼Œåˆ™è°ƒç”¨å°†ç­‰å¾…è¿™ä¹ˆé•¿æ—¶é—´ä»¥æ‰§è¡ŒæŸ¥æ‰¾ã€‚å¦‚æœè¶…æ—¶åˆ°è¾¾ï¼Œå†…éƒ¨çŠ¶æ€å°†æœªçŸ¥ï¼Œå¹¶ä¸”æ­¤å‡½æ•°è¿”å› ErrTimedOutã€‚ å¦‚æœtimeoutMs ä¸º 0ï¼Œå®ƒå°†å‘èµ·æŸ¥æ‰¾ï¼Œä½†ç«‹å³è¿”å›ï¼Œä¸æŠ¥å‘Šä»»ä½•é”™è¯¯(ä¾‹å¦‚ï¼Œå¼‚æ­¥)ã€‚ Seek()åªèƒ½ç”¨äºå·²ç»ä½¿ç”¨çš„åˆ†åŒº(é€šè¿‡ Assign()æˆ–éšå¼ä½¿ç”¨é€šè¿‡è‡ªå¹³è¡¡è®¢é˜…())ã€‚ è¦è®¾ç½®èµ·å§‹åç§»é‡ï¼Œæœ€å¥½ä½¿ç”¨ Assign()å¹¶ä¸ºæ¯ä¸ªåˆ†åŒºæä¾›ä¸€ä¸ªèµ·å§‹åç§»é‡ã€‚ 1234567891011func (c *Consumer) Seek(partition TopicPartition, timeoutMs int) error &#123; rkt := c.handle.getRkt(*partition.Topic) cErr := C.rd_kafka_seek(rkt, C.int32_t(partition.Partition), C.int64_t(partition.Offset), C.int(timeoutMs)) if cErr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return newError(cErr) &#125; return nil&#125; Poll(timeoutMs int) (event Event) è½®è¯¢æ¶ˆæ¯æˆ–äº‹ä»¶ã€‚ å°†é˜»å¡æœ€å¤š timeoutMs çš„è¶…æ—¶æ—¶é—´ ä»¥ä¸‹å›è°ƒå¯èƒ½ä¼šè¢«è§¦å‘ Subscribe()â€™s rebalanceCb å¦‚æœè¶…æ—¶åˆ™è¿”å› nilï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªäº‹ä»¶ 1234func (c *Consumer) Poll(timeoutMs int) (event Event) &#123; ev, _ := c.handle.eventPoll(nil, timeoutMs, 1, nil) return ev&#125; ReadMessage(timeout time.Duration) (*Message, error) è¿”å›ä¸€æ¡æ¶ˆæ¯ è¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„ APIï¼Œå®ƒå°è£…äº† Poll()ï¼Œåªè¿”å›æ¶ˆæ¯æˆ–é”™è¯¯ã€‚æ‰€æœ‰å…¶ä»–äº‹ä»¶ç±»å‹éƒ½è¢«ä¸¢å¼ƒã€‚ è¯¥è°ƒç”¨æœ€å¤šä¼šé˜»å¡ timeout ç­‰å¾…æ–°æ¶ˆæ¯æˆ–é”™è¯¯ã€‚timeoutå¯ä»¥è®¾ç½®ä¸º-1ï¼Œè¡¨ç¤ºæ— é™æœŸç­‰å¾…ã€‚ è¶…æ—¶å°†ä¼šè¿”å›(nil, err) å½“ err æ˜¯ kafka.(Error).Code == Kafka.ErrTimedOut æ¶ˆæ¯å°†ä¼šè¿”å› (msg, nil), å½“æœ‰é”™è¯¯å½“æ—¶å€™å°†ä¼šè¿”å› (nil, err), å½“æŒ‡å®š partition é”™è¯¯çš„æ—¶å€™ï¼ˆtopicï¼Œpartitionï¼Œoffsetï¼‰ï¼Œå°†ä¼šè¿”å› (msg,err) å…¨éƒ¨å…¶ä»–çš„äº‹ä»¶ç±»å‹ï¼ŒåƒPartitionEOF,AssingedPartitionsç­‰ç­‰å°†ä¼šè¢«é»˜è®¤ä¸¢å¼ƒ 123456789101112131415161718192021222324252627282930313233343536373839func (c *Consumer) ReadMessage(timeout time.Duration) (*Message, error) &#123; var absTimeout time.Time var timeoutMs int if timeout &gt; 0 &#123; absTimeout = time.Now().Add(timeout) timeoutMs = (int)(timeout.Seconds() * 1000.0) &#125; else &#123; timeoutMs = (int)(timeout) &#125; for &#123; ev := c.Poll(timeoutMs) switch e := ev.(type) &#123; case *Message: if e.TopicPartition.Error != nil &#123; return e, e.TopicPartition.Error &#125; return e, nil case Error: return nil, e default: // Ignore other event types &#125; if timeout &gt; 0 &#123; // Calculate remaining time timeoutMs = int(math.Max(0.0, absTimeout.Sub(time.Now()).Seconds()*1000.0)) &#125; if timeoutMs == 0 &amp;&amp; ev == nil &#123; return nil, newError(C.RD_KAFKA_RESP_ERR__TIMED_OUT) &#125; &#125;&#125; Close() (err error) å…³é—­ä¸€ä¸ª Consumer å¯¹è±¡ è°ƒç”¨åï¼Œå¯¹è±¡ä¸å†å¯ç”¨ã€‚ 1234567891011121314151617181920212223func (c *Consumer) Close() (err error) &#123; // Wait for consumerReader() or pollLogEvents to terminate (by closing readerTermChan) close(c.readerTermChan) c.handle.waitGroup.Wait() if c.eventsChanEnable &#123; close(c.events) &#125; C.rd_kafka_queue_destroy(c.handle.rkq) c.handle.rkq = nil e := C.rd_kafka_consumer_close(c.handle.rk) if e != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return newError(e) &#125; c.handle.cleanup() C.rd_kafka_destroy(c.handle.rk) return nil&#125; GetMetadata(topic string, allTopics bool, timeoutMs int) (Metadata, error) ç”¨äºæŸ¥è¯¢é›†ç¾¤ä¸­ broker å’Œ topic çš„å…ƒæ•°æ® å¦‚æœ topic å‚æ•°ä¸ä¸º nilï¼Œåˆ™è¿”å›å’Œ topoic ç›¸å…³æ•°æ®ï¼Œå¦åˆ™ï¼ˆå¦‚æœallTopicså‚æ•°ä¸º falseï¼Œé‚£ä¹ˆå°†ä¼šè¿”å›å½“å‰ä½¿ç”¨ topic çš„å…ƒæ•°æ®ï¼Œå¦‚æœ allTopicså‚æ•°ä¸º true, é‚£ä¹ˆå°†è¿”å› broker ä¸­æ‰€æœ‰ topic çš„å…ƒæ•°æ®ï¼‰ GetMetadata ç›¸å½“äº Java API ä¸­çš„ listTopicsã€describeTopics å’Œ describeClusterã€‚ 123func (c *Consumer) GetMetadata(topic *string, allTopics bool, timeoutMs int) (*Metadata, error) &#123; return getMetadata(c, topic, allTopics, timeoutMs)&#125; QueryWatermarkOffsets(topic string, partition int32, timeoutMs int) (low, high int64, err error) æ ¹æ® topic å’Œ partitionï¼ŒæŸ¥è¯¢å½“å‰ broker ä¸­ä»–ä»¬çš„ä½æ°´ä½å’Œé«˜æ°´ä½çš„ offset 123func (c *Consumer) QueryWatermarkOffsets(topic string, partition int32, timeoutMs int) (low, high int64, err error) &#123; return queryWatermarkOffsets(c, topic, partition, timeoutMs)&#125; GetWatermarkOffsets(topic string, partition int32) (low, high int64, err error) æ ¹æ® topic å’Œ partition è¿”å›å½“å‰æœåŠ¡å­˜å‚¨çš„ä½æ°´ä½å’Œé«˜æ°´ä½çš„ offset æ¯ä¸ª fetch å“åº”æˆ–é€šè¿‡è°ƒç”¨ QueryWatermarkOffsets å¡«å……é«˜æ°´ä½çš„ offset å¦‚æœè®¾ç½®äº† statistics.interval.ms, ä½æ°´ä½å°†ä¼šæœ‰ä¸€ä¸ª statistics.interval.ms çš„å‘¨æœŸæ¥æ›´æ–° 123func (c *Consumer) GetWatermarkOffsets(topic string, partition int32) (low, high int64, err error) &#123; return getWatermarkOffsets(c, topic, partition)&#125; OffsetsForTimes(times []TopicPartition, timeoutMs int) (offsets []TopicPartition, err error) æ¯ä¸ªåˆ†åŒºè¿”å›çš„åç§»é‡æ˜¯æœ€æ—©çš„åç§»é‡ï¼Œå…¶æ—¶é—´æˆ³å¤§äºæˆ–ç­‰äºç›¸åº”åˆ†åŒºä¸­çš„ç»™å®šæ—¶é—´æˆ³ã€‚å¦‚æœæä¾›çš„æ—¶é—´æˆ³è¶…è¿‡åˆ†åŒºä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼Œåˆ™è¿”å›-1 å€¼ã€‚ 123func (c *Consumer) OffsetsForTimes(times []TopicPartition, timeoutMs int) (offsets []TopicPartition, err error) &#123; return offsetsForTimes(c, times, timeoutMs)&#125; Subscription() (topics []string, err error) è¿”å›å½“å‰è¢«è®¢é˜…çš„ topic 12345678910111213141516171819func (c *Consumer) Subscription() (topics []string, err error) &#123; var cTopics *C.rd_kafka_topic_partition_list_t cErr := C.rd_kafka_subscription(c.handle.rk, &amp;cTopics) if cErr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return nil, newError(cErr) &#125; defer C.rd_kafka_topic_partition_list_destroy(cTopics) topicCnt := int(cTopics.cnt) topics = make([]string, topicCnt) for i := 0; i &lt; topicCnt; i++ &#123; crktpar := C._c_rdkafka_topic_partition_list_entry(cTopics, C.int(i)) topics[i] = C.GoString(crktpar.topic) &#125; return topics, nil&#125; Assignment() (partitions []TopicPartition, err error) è¿”å›å½“å‰æŒ‡æ´¾çš„ partition 12345678910111213func (c *Consumer) Assignment() (partitions []TopicPartition, err error) &#123; var cParts *C.rd_kafka_topic_partition_list_t cErr := C.rd_kafka_assignment(c.handle.rk, &amp;cParts) if cErr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return nil, newError(cErr) &#125; defer C.rd_kafka_topic_partition_list_destroy(cParts) partitions = newTopicPartitionsFromCparts(cParts) return partitions, nil&#125; Committed(partitions []TopicPartition, timeoutMs int) (offsets []TopicPartition, err error) æŸ¥è¯¢å·²ç»æäº¤ commit çš„ offset 12345678910func (c *Consumer) Committed(partitions []TopicPartition, timeoutMs int) (offsets []TopicPartition, err error) &#123; cparts := newCPartsFromTopicPartitions(partitions) defer C.rd_kafka_topic_partition_list_destroy(cparts) cerr := C.rd_kafka_committed(c.handle.rk, cparts, C.int(timeoutMs)) if cerr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return nil, newError(cerr) &#125; return newTopicPartitionsFromCparts(cparts), nil&#125; Position(partitions []TopicPartition) (offsets []TopicPartition, err error) æ ¹æ® partition è¿”å›å…¶ offset å…¸å‹çš„ç”¨æ³•æ˜¯è°ƒç”¨ assign()æ¥è·å–åˆ†åŒºåˆ—è¡¨ï¼Œç„¶åå°†å…¶ä¼ é€’ç»™ Position()æ¥è·å–æ¯ä¸ªåˆ†åŒºçš„å½“å‰ offset æ¶ˆè´¹çš„ä½ç½®æ˜¯åˆ†åŒºè¯»å–çš„ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼ˆæœ€åä¸€æ¡ä¿¡æ¯çš„+1ï¼‰ 12345678910func (c *Consumer) Position(partitions []TopicPartition) (offsets []TopicPartition, err error) &#123; cparts := newCPartsFromTopicPartitions(partitions) defer C.rd_kafka_topic_partition_list_destroy(cparts) cerr := C.rd_kafka_position(c.handle.rk, cparts) if cerr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return nil, newError(cerr) &#125; return newTopicPartitionsFromCparts(cparts), nil&#125; Pause(partitions []TopicPartition) (err error) æ ¹æ®æä¾›çš„ partition æš‚åœæ¶ˆè´¹ å¦‚æœè®¾ç½®äº†go.events.channel.enableï¼Œåªä¼šå—åˆ°go.events.channel.sizeçš„å½±å“ï¼Œè¿™ä¸ª API å°†ä¸ä¼šç”Ÿæ•ˆ 123456789func (c *Consumer) Pause(partitions []TopicPartition) (err error) &#123; cparts := newCPartsFromTopicPartitions(partitions) defer C.rd_kafka_topic_partition_list_destroy(cparts) cerr := C.rd_kafka_pause_partitions(c.handle.rk, cparts) if cerr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return newError(cerr) &#125; return nil&#125; Resume(partitions []TopicPartition) (err error) å”¤é†’è¢«æš‚åœçš„ partition 123456789func (c *Consumer) Resume(partitions []TopicPartition) (err error) &#123; cparts := newCPartsFromTopicPartitions(partitions) defer C.rd_kafka_topic_partition_list_destroy(cparts) cerr := C.rd_kafka_resume_partitions(c.handle.rk, cparts) if cerr != C.RD_KAFKA_RESP_ERR_NO_ERROR &#123; return newError(cerr) &#125; return nil&#125; GetConsumerGroupMetadata() (*ConsumerGroupMetadata, error) è¿”å›å½“å‰æ¶ˆè´¹è€…ç»„çš„å…ƒæ•°æ® è¿™ä¸ªè¿”å›çš„å¯¹è±¡ï¼Œåº”è¯¥ä¼ é€’ç»™äº‹åŠ¡ç”Ÿäº§è€…çš„ SendOffsetsToTransaction() API 1234567891011121314func (c *Consumer) GetConsumerGroupMetadata() (*ConsumerGroupMetadata, error) &#123; cgmd := C.rd_kafka_consumer_group_metadata(c.handle.rk) if cgmd == nil &#123; return nil, NewError(ErrState, \"Consumer group metadata not available\", false) &#125; defer C.rd_kafka_consumer_group_metadata_destroy(cgmd) serialized, err := serializeConsumerGroupMetadata(cgmd) if err != nil &#123; return nil, err &#125; return &amp;ConsumerGroupMetadata&#123;serialized&#125;, nil&#125;","categories":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"},{"name":"Kafka","slug":"Kafka","permalink":"http://blog.crazylaw.cn/tags/Kafka/"}]},{"title":"ã€Dockerã€‘å¦‚ä½•é€‰æ‹©hub.dockerä¸­çš„tagæ ‡ç­¾","slug":"docker/docker-tagsçš„é€‰æ‹©","date":"2020-05-25T03:28:30.000Z","updated":"2021-03-20T16:25:01.805Z","comments":true,"path":"2020/05/25/docker/docker-tagsçš„é€‰æ‹©/","link":"","permalink":"http://blog.crazylaw.cn/2020/05/25/docker/docker-tags%E7%9A%84%E9%80%89%E6%8B%A9/","excerpt":"å‰è¨€å¾ˆå¤šå°ä¼™ä¼´æˆ–è®¸è¿˜ä¸æ¸…æ¥šå„ä¸ªtagçš„åŒºåˆ«ï¼Œå…¶å®æœ€å¤§çš„ä¸€ä¸ªé—®é¢˜åœ¨äºï¼Œä½ éœ€è¦äº†è§£å„å¤§æ“ä½œç³»ç»Ÿçš„ä¸åŒã€‚","text":"å‰è¨€å¾ˆå¤šå°ä¼™ä¼´æˆ–è®¸è¿˜ä¸æ¸…æ¥šå„ä¸ªtagçš„åŒºåˆ«ï¼Œå…¶å®æœ€å¤§çš„ä¸€ä¸ªé—®é¢˜åœ¨äºï¼Œä½ éœ€è¦äº†è§£å„å¤§æ“ä½œç³»ç»Ÿçš„ä¸åŒã€‚ æ“ä½œç³»ç»Ÿ debian ubuntu centos alpine debianDebian å‘è¡Œç‰ˆæœ¬Debian ä¸€ç›´ç»´æŠ¤ç€è‡³å°‘ä¸‰ä¸ªå‘è¡Œç‰ˆæœ¬ï¼šç¨³å®šç‰ˆï¼ˆstableï¼‰ï¼Œæµ‹è¯•ç‰ˆï¼ˆtestingï¼‰å’Œä¸ç¨³å®šç‰ˆï¼ˆunstableï¼‰ã€‚ ç¨³å®šç‰ˆï¼ˆstableï¼‰ç¨³å®šç‰ˆåŒ…å«äº† Debian å®˜æ–¹æœ€è¿‘ä¸€æ¬¡å‘è¡Œçš„è½¯ä»¶åŒ…ã€‚ ä½œä¸º Debian çš„æ­£å¼å‘è¡Œç‰ˆæœ¬ï¼Œå®ƒæ˜¯æˆ‘ä»¬ä¼˜å…ˆæ¨èç»™ç”¨æˆ·æ‚¨é€‰ç”¨çš„ç‰ˆæœ¬ã€‚ å½“å‰ Debian çš„ç¨³å®šç‰ˆç‰ˆæœ¬å·æ˜¯ 10ï¼Œå¼€å‘ä»£å·ä¸º busterã€‚æœ€åˆç‰ˆæœ¬ä¸º 10ï¼Œäº 2019å¹´07æœˆ06æ—¥ å‘å¸ƒï¼Œå…¶æ›´æ–° 10.4 å·²äº 2020å¹´05æœˆ09æ—¥ å‘å¸ƒã€‚ æµ‹è¯•ç‰ˆï¼ˆtestingï¼‰æµ‹è¯•ç‰ˆåŒ…å«äº†é‚£äº›æš‚æ—¶æœªè¢«æ”¶å½•è¿›å…¥ç¨³å®šç‰ˆçš„è½¯ä»¶åŒ…ï¼Œä½†å®ƒä»¬å·²ç»è¿›å…¥äº†å€™é€‰é˜Ÿåˆ—ã€‚ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬çš„æœ€å¤§ç›Šå¤„åœ¨äºå®ƒæ‹¥æœ‰æ›´å¤šç‰ˆæœ¬è¾ƒæ–°çš„è½¯ä»¶ã€‚ æƒ³è¦äº†è§£ ä»€ä¹ˆæ˜¯æµ‹è¯•ç‰ˆä»¥åŠ å¦‚ä½•æˆä¸ºç¨³å®šç‰ˆçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·çœ‹ Debian FAQã€‚ å½“å‰çš„æµ‹è¯•ç‰ˆç‰ˆæœ¬ä»£å·æ˜¯ bullseyeã€‚ ä¸ç¨³å®šç‰ˆï¼ˆunstableï¼‰ä¸ç¨³å®šç‰ˆå­˜æ”¾äº† Debian ç°è¡Œçš„å¼€å‘å·¥ä½œã€‚é€šå¸¸ï¼Œåªæœ‰å¼€å‘è€…å’Œé‚£äº›å–œæ¬¢è¿‡æƒŠé™©åˆºæ¿€ç”Ÿæ´»çš„äººé€‰ç”¨è¯¥ç‰ˆæœ¬ã€‚æ¨èä½¿ç”¨ä¸ç¨³å®šç‰ˆçš„ç”¨æˆ·è®¢é˜… debian-devel-announce é‚®ä»¶åˆ—è¡¨ï¼Œä»¥æ¥æ”¶å…³äºé‡å¤§å˜æ›´çš„é€šçŸ¥ï¼Œæ¯”å¦‚æœ‰å¯èƒ½å¯¼è‡´é—®é¢˜çš„å‡çº§ã€‚ ä¸ç¨³å®šç‰ˆçš„ç‰ˆæœ¬ä»£å·æ°¸è¿œéƒ½è¢«ç§°ä¸º sidã€‚ ä¸‹ä¸€ä»£ Debian æ­£å¼å‘è¡Œç‰ˆçš„ä»£å·ä¸º bullseye â€” å‘å¸ƒæ—¶é—´å°šæœªç¡®å®š Debian 10ï¼ˆbusterï¼‰ â€” å½“å‰çš„ç¨³å®šç‰ˆï¼ˆstableï¼‰ Debian 9ï¼ˆstretchï¼‰ â€” æ—§çš„ç¨³å®šç‰ˆï¼ˆoldstableï¼‰ Debian 8ï¼ˆjessieï¼‰ â€” æ›´æ—§çš„ç¨³å®šç‰ˆï¼ˆoldoldstableï¼‰ Debian 7ï¼ˆwheezyï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian 6.0ï¼ˆsqueezeï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian GNU/Linux 5.0ï¼ˆlennyï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian GNU/Linux 4.0ï¼ˆetchï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian GNU/Linux 3.1ï¼ˆsargeï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian GNU/Linux 3.0ï¼ˆwoodyï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian GNU/Linux 2.2ï¼ˆpotatoï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian GNU/Linux 2.1ï¼ˆslinkï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ Debian GNU/Linux 2.0ï¼ˆhammï¼‰ â€” è¢«æ·˜æ±°çš„ç¨³å®šç‰ˆ","categories":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/categories/Docker/"}],"tags":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/tags/Docker/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- Impalaå‡½æ•°ä½¿ç”¨æ–‡æ¡£","slug":"å¤§æ•°æ®/impalaå‡½æ•°æ€»ç»“æ–‡æ¡£","date":"2020-05-12T01:56:40.000Z","updated":"2021-03-20T16:25:01.815Z","comments":true,"path":"2020/05/12/å¤§æ•°æ®/impalaå‡½æ•°æ€»ç»“æ–‡æ¡£/","link":"","permalink":"http://blog.crazylaw.cn/2020/05/12/%E5%A4%A7%E6%95%B0%E6%8D%AE/impala%E5%87%BD%E6%95%B0%E6%80%BB%E7%BB%93%E6%96%87%E6%A1%A3/","excerpt":"å‰è¨€ç›®å‰ä¸€äº›ä¼ ç»Ÿçš„å…¬å¸æ¯”è¾ƒæ—©æœŸä½¿ç”¨å¤§æ•°æ®è®¡ç®—å¼•æ“çš„ï¼Œéƒ½ä¼šé€‰æ‹©ä½¿ç”¨imaplaåšä¸ºè®¡ç®—å¼•æ“ï¼Œæ‰€ä»¥å¯¹impalaå¯¹ä¸€äº›sqlä½¿ç”¨è¿˜æ˜¯éœ€è¦ç†Ÿæ‚‰çš„ã€‚","text":"å‰è¨€ç›®å‰ä¸€äº›ä¼ ç»Ÿçš„å…¬å¸æ¯”è¾ƒæ—©æœŸä½¿ç”¨å¤§æ•°æ®è®¡ç®—å¼•æ“çš„ï¼Œéƒ½ä¼šé€‰æ‹©ä½¿ç”¨imaplaåšä¸ºè®¡ç®—å¼•æ“ï¼Œæ‰€ä»¥å¯¹impalaå¯¹ä¸€äº›sqlä½¿ç”¨è¿˜æ˜¯éœ€è¦ç†Ÿæ‚‰çš„ã€‚ æ¡ä»¶å‡½æ•°æ•…åæ€è®®ï¼Œæ¡ä»¶å‡½æ•°åŒºåŸŸä¸»è¦éƒ½æ˜¯ä¸€äº›æ¡ä»¶åˆ¤å®šçš„å‡½æ•° case when1234567ç”¨æ³• 1:CASE a WHEN b THEN c [WHEN d THEN e]... [ELSE f] ENDç”¨æ³• 2:CASE WHEN a THEN b [WHEN c THEN d]... [ELSE e] END ç”¨æ³•1: 1234567select case xÂµÃ‚ when 1 then 'one' when 2 then 'two'Âµ when 0 then 'zero' else 'out of range' end from t1; ç”¨æ³•2: 12345678select case when dayname(now()) in ('Saturday','Sunday') then 'result undefined on weekends' when x &gt; y then 'x greater than y' when x = y then 'x and y are equal' when x is null or y is null then 'one of the columns is null' else null end from t1;","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"Impala","slug":"Impala","permalink":"http://blog.crazylaw.cn/tags/Impala/"}]},{"title":"ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘- Rabbitmqå®‰è£…ä¸é…ç½®","slug":"æ¶ˆæ¯é˜Ÿåˆ—/rabbitmq","date":"2020-05-08T01:46:51.000Z","updated":"2021-03-20T16:25:01.819Z","comments":true,"path":"2020/05/08/æ¶ˆæ¯é˜Ÿåˆ—/rabbitmq/","link":"","permalink":"http://blog.crazylaw.cn/2020/05/08/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/rabbitmq/","excerpt":"å‰è¨€ç”±äºéƒ¨é—¨çš„å¤§æ•°æ®æœåŠ¡ä¸€ç›´éƒ½æ˜¯ç”¨kafkaï¼Œä½†æ˜¯ä¸€äº›å¸¸è§„çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›ä¾èµ–kafkaï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥äº†rabbitmqã€‚","text":"å‰è¨€ç”±äºéƒ¨é—¨çš„å¤§æ•°æ®æœåŠ¡ä¸€ç›´éƒ½æ˜¯ç”¨kafkaï¼Œä½†æ˜¯ä¸€äº›å¸¸è§„çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›ä¾èµ–kafkaï¼Œæ‰€ä»¥æˆ‘ä»¬å¼•å…¥äº†rabbitmqã€‚ é‰´äºæˆ‘ä»¬è¦å¯¹é…ç½®åšç‰¹æ®Šå¤„ç†ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ªrabbitmq-env.confæ¥ç®¡ç†å…·ä½“å†…å®¹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940# è¿™æ˜¯rabbitmqçš„é…ç½®æ–‡ä»¶,ä¹Ÿæ”¯æŒshellè¯­è¨€# è¯¥æ–‡ä»¶å—RABBITMQ_CONF_ENV_FILEç¯å¢ƒå˜é‡å½±å“è·¯å¾„ï¼Œé»˜/etc/rabbitmq/rabbitmq-env.conf# è¿™ä¸ªé…ç½®çš„ç¯å¢ƒå˜é‡æœ€ç»ˆéƒ½ä¼šç”Ÿæˆè‡ªå¸¦æœ‰â€œRABBITMQ_â€çš„å‰ç¼€ï¼Œæ‰€ä»¥è¯·ä¸è¦æ‰‹åŠ¨è®¾ç½®RABBITMQ_# ç”±äºæˆ‘ä»¬ç”¨çš„FQDNï¼Œæ‰€ä»¥è¦é…ç½®longnameç¯å¢ƒå˜é‡, å› æ­¤æˆ‘ä»¬ä¸å›ºå®šèŠ‚ç‚¹å# https://www.rabbitmq.com/configure.html#environment-env-file-unix# åŸºç¡€å˜é‡rabbitmq_uid=rabbitmqrabbitmq_gid=rabbitmqrabbitmq_config_file=\"/etc/rabbitmq/rabbitmq.config\"rabbitmq_mnesia_base=\"/data/database/rabbitmq\"rabbitmq_log_base=\"/data/logs/rabbitmq\"# ä»¥ä¸‹ä¸ºæ‰§è¡Œå‘½ä»¤mkdir -p $&#123;rabbitmq_mnesia_base&#125; &amp;&amp; chown $&#123;rabbitmq_uid&#125;:$&#123;rabbitmq_gid&#125; $&#123;rabbitmq_mnesia_base&#125;mkdir -p $&#123;rabbitmq_log_base&#125; &amp;&amp; chown $&#123;rabbitmq_uid&#125;:$&#123;rabbitmq_gid&#125; $&#123;rabbitmq_log_base&#125;# ä»¥ä¸‹ä¸ºç¯å¢ƒå˜é‡, åˆ‡å‹¿æ‰‹åŠ¨è®¾ç½®\"RABBITMQ_\"å‰ç¼€ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆ# https://www.rabbitmq.com/relocate.html#environment-variables# https://www.rabbitmq.com/configure.html#supported-environment-variables# èŠ‚ç‚¹åç§°å®šä¹‰# https://www.rabbitmq.com/cli.html#node-names# NODENAME=rabbitmq@node1# èŠ‚ç‚¹åå­—ä½¿ç”¨FQDN# https://www.rabbitmq.com/cli.html#node-namesUSE_LONGNAME=true# é…ç½®æ–‡ä»¶è·¯å¾„CONFIG_FILE=$&#123;rabbitmq_config_file&#125;# é…ç½®æŒä¹…åŒ–æ•°æ®åº“è·¯å¾„MNESIA_BASE=$&#123;rabbitmq_mnesia_base&#125;# rabbitmqæ—¥å¿—å­˜å‚¨è·¯å¾„LOG_BASE=$&#123;rabbitmq_log_base&#125; ç”±äºæˆ‘ä»¬çš„hostnameä¸€èˆ¬æ˜¯é‡‡ç”¨FQDNï¼ˆå…¨é™å®šæ€§åŸŸåï¼‰ï¼Œå¹¶ä¸”æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯é•œåƒé›†ç¾¤çš„æ¨¡å¼ï¼Œæˆ‘è®¤ä¸ºhostnameå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦å›ºå®šã€‚å³ä½¿æ˜¯å‘ç”Ÿäº†æ•…éšœï¼Œåªè¦é›†ç¾¤ä¸­å­˜åœ¨ä¸€å°æœºå™¨ï¼Œé‚£ä¹ˆæŒä¹…åŒ–å¯¹æ•°æ®ä¹Ÿå¹¶ä¸ä¼šä¸¢å¤±ã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šé‡‡ç”¨é•œåƒæ¨¡å¼ï¼Ÿè¿™ä¸ªæ¨¡å¼ä¸æ˜¯ä¼šè®©å¤§é‡æ¶ˆæ¯å¯¹æ—¶å€™å¯¼è‡´å†…ç½‘æµé‡æš´æ¶¨å—ï¼Ÿ ç¡®å®æ˜¯ä¼šè¿™æ ·å­ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬æ˜¯åå°ç³»ç»Ÿä½¿ç”¨å±…å¤šï¼Œç›®å‰æ¥è¯´ï¼Œå¹¶ä¸ä¼šæœ‰å¤§é‡æ¶ˆæ¯çš„å‡ºç°ï¼Œå¦‚æœçœŸçš„æ˜¯è¿™æ ·å­çš„åŒ–ï¼Œæˆ‘ä»¬æ›´æ¨èç”¨kafkaæˆ–è€…rocketmqã€‚æˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯æ•°æ®çš„å®Œæ•´æ€§å¯é æ€§ã€‚ æ³¨æ„æˆ‘ä»¬çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦å¼€å¯rabbitmq-plugins enable rabbitmq_management_agentï¼Œè¿™æ ·å­åœ¨ç®¡ç†åå°ä¸­ï¼Œæˆ‘ä»¬æ‰å¯ä»¥çœ‹åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€ã€‚ æˆ‘ä»¬çš„åŸåˆ™æ˜¯ï¼š 12345678910å¦‚ä½•é€‰æ‹©è¿œç¨‹æˆ–æœ¬åœ°çš„RabbitMQï¼Ÿåœºæ™¯1ï¼šAã€B æœåŠ¡åœ¨åŒå°æœºå™¨ï¼Œä¸€äº§ä¸€æ¶ˆï¼Œä½¿ç”¨æœ¬åœ°ï¼ˆphpç³»ç»Ÿè¯¥åœºæ™¯ç›®å‰çš„ laravel + redis æ–¹æ¡ˆå·²èƒ½å¤Ÿæ»¡è¶³ï¼‰åœºæ™¯2ï¼šAã€B æœåŠ¡åœ¨å¤šå°æœºå™¨ï¼Œä¸€äº§ä¸€æ¶ˆï¼Œä½¿ç”¨è¿œç¨‹åœºæ™¯3ï¼šAã€Bã€C æœåŠ¡åœ¨åŒå°æœºå™¨ï¼Œä¸€äº§å¤šæ¶ˆï¼Œä½¿ç”¨æœ¬åœ°åœºæ™¯4ï¼šAã€Bã€C æœåŠ¡åœ¨å¤šå°æœºå™¨ï¼Œä¸€äº§å¤šæ¶ˆï¼Œä½¿ç”¨è¿œç¨‹å¦‚æœç¡®å®švhoståç§°ï¼Ÿ1ã€ä»…é™äºå•ç³»ç»Ÿå¹¶ä¸”è·¨æœºå™¨ä½¿ç”¨ï¼Œåˆ™ä½¿ç”¨ç³»ç»Ÿåç§°ä½œä¸º vhost åç§°2ã€å¤šç³»ç»Ÿå¹¶ä¸”è·¨æœºå™¨ä½¿ç”¨ï¼Œåˆ™ä½¿ç”¨ common ä½œä¸º vhost åç§°","categories":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"http://blog.crazylaw.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"}],"tags":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒRabbitmq","slug":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒRabbitmq","permalink":"http://blog.crazylaw.cn/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8CRabbitmq/"}]},{"title":"ã€rustã€‘åŒ…å’Œæ¨¡å—","slug":"Rustè¯­è¨€/rust-åŒ…å’Œæ¨¡å—","date":"2020-03-13T02:43:43.000Z","updated":"2021-03-20T16:25:01.800Z","comments":true,"path":"2020/03/13/Rustè¯­è¨€/rust-åŒ…å’Œæ¨¡å—/","link":"","permalink":"http://blog.crazylaw.cn/2020/03/13/Rust%E8%AF%AD%E8%A8%80/rust-%E5%8C%85%E5%92%8C%E6%A8%A1%E5%9D%97/","excerpt":"å‰è¨€Rust ä¸­ï¼Œcrate æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯ç¼–è¯‘å•å…ƒã€‚å…·ä½“è¯´æ¥ï¼Œå°±æ˜¯ä¸€ä¸ªæˆ–ä¸€æ‰¹æ–‡ä»¶ï¼ˆå¦‚æœæ˜¯ä¸€æ‰¹æ–‡ä»¶ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªæ–‡ä»¶æ˜¯è¿™ä¸ª crate çš„å…¥å£ï¼‰ã€‚å®ƒç¼–è¯‘åï¼Œä¼šå¯¹åº”ç€ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–ä¸€ä¸ªåº“ã€‚ Rust æä¾›äº†ä¸€ä¸ªå…³é”®å­— modï¼Œå®ƒå¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ¨¡å—ï¼Œæˆ–è€…å¼•ç”¨å¦å¤–ä¸€ä¸ªæ–‡ä»¶ä¸­çš„æ¨¡å—ã€‚","text":"å‰è¨€Rust ä¸­ï¼Œcrate æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯ç¼–è¯‘å•å…ƒã€‚å…·ä½“è¯´æ¥ï¼Œå°±æ˜¯ä¸€ä¸ªæˆ–ä¸€æ‰¹æ–‡ä»¶ï¼ˆå¦‚æœæ˜¯ä¸€æ‰¹æ–‡ä»¶ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªæ–‡ä»¶æ˜¯è¿™ä¸ª crate çš„å…¥å£ï¼‰ã€‚å®ƒç¼–è¯‘åï¼Œä¼šå¯¹åº”ç€ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–ä¸€ä¸ªåº“ã€‚ Rust æä¾›äº†ä¸€ä¸ªå…³é”®å­— modï¼Œå®ƒå¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ¨¡å—ï¼Œæˆ–è€…å¼•ç”¨å¦å¤–ä¸€ä¸ªæ–‡ä»¶ä¸­çš„æ¨¡å—ã€‚ åŒ…æ‰§è¡Œ cargo new -lib fooï¼Œä¼šå¾—åˆ°å¦‚ä¸‹ç›®å½•å±‚çº§ï¼š 1234fooâ”œâ”€â”€ Cargo.tomlâ””â”€â”€ src â””â”€â”€ lib.rs è¿™é‡Œï¼Œlib.rs å°±æ˜¯ä¸€ä¸ª crateï¼ˆå…¥å£ï¼‰ï¼Œå®ƒç¼–è¯‘åæ˜¯ä¸€ä¸ªåº“ã€‚ä¸€ä¸ªå·¥ç¨‹ä¸‹å¯ä»¥åŒ…å«ä¸æ­¢ä¸€ä¸ª crateï¼Œæœ¬å·¥ç¨‹åªæœ‰ä¸€ä¸ªã€‚ æ‰§è¡Œ cargo new barï¼Œä¼šå¾—åˆ°å¦‚ä¸‹ç›®å½•å±‚çº§ï¼š 1234barâ”œâ”€â”€ Cargo.tomlâ””â”€â”€ src â””â”€â”€ main.rs è¿™é‡Œï¼Œmain.rs å°±æ˜¯ä¸€ä¸ª crateï¼ˆå…¥å£ï¼‰ï¼Œå®ƒç¼–è¯‘åæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚ æ¨¡å—å…³äºæ¨¡å—çš„ä¸€äº›è¦ç‚¹ï¼š æ¯ä¸ª crate ä¸­ï¼Œé»˜è®¤å®ç°äº†ä¸€ä¸ªéšå¼çš„ æ ¹æ¨¡å—ï¼ˆroot moduleï¼‰ï¼› æ¨¡å—çš„å‘½åé£æ ¼ä¹Ÿæ˜¯ lower_snake_caseï¼Œè·Ÿå…¶å®ƒçš„ Rust çš„æ ‡è¯†ç¬¦ä¸€æ ·ï¼› æ¨¡å—å¯ä»¥åµŒå¥—ï¼› æ¨¡å—ä¸­å¯ä»¥å†™ä»»ä½•åˆæ³•çš„ Rust ä»£ç ï¼› åœ¨æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ¨¡å—æ¯”å¦‚ï¼Œåœ¨ä¸Šè¿° lib.rs ä¸­ï¼Œæˆ‘ä»¬å†™ä¸Šå¦‚ä¸‹ä»£ç ï¼š 1234567mod aaa &#123; const X: i32 = 10; fn print_aaa() &#123; println!(\"&#123;&#125;\", 42); &#125;&#125; æˆ‘ä»¬å¯ä»¥ç»§ç»­å†™å¦‚ä¸‹ä»£ç ï¼š 12345678910111213mod aaa &#123; const X: i32 = 10; fn print_aaa() &#123; println!(\"&#123;&#125;\", 42); &#125; mod BBB &#123; fn print_bbb() &#123; println!(\"&#123;&#125;\", 37); &#125; &#125;&#125; è¿˜å¯ä»¥ç»§ç»­å†™ï¼š 1234567891011121314151617181920mod aaa &#123; const X: i32 = 10; fn print_aaa() &#123; println!(\"&#123;&#125;\", 42); &#125; mod bbb &#123; fn print_bbb() &#123; println!(\"&#123;&#125;\", 37); &#125; &#125;&#125;mod ccc &#123; fn print_ccc() &#123; println!(\"&#123;&#125;\", 25); &#125;&#125; æ¨¡å—çš„å¯è§æ€§æˆ‘ä»¬å‰é¢å†™äº†ä¸€äº›æ¨¡å—ï¼Œä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬å†™é‚£äº›æ¨¡å—ï¼Œç›®å‰æ˜¯æ²¡æœ‰ä»€ä¹ˆä½œç”¨çš„ã€‚å†™æ¨¡å—çš„ç›®çš„ä¸€æ˜¯ä¸ºäº†åˆ†éš”é€»è¾‘å—ï¼ŒäºŒæ˜¯ä¸ºäº†æä¾›é€‚å½“çš„å‡½æ•°ï¼Œæˆ–å¯¹è±¡ï¼Œä¾›å¤–éƒ¨è®¿é—®ã€‚è€Œæ¨¡å—ä¸­çš„å†…å®¹ï¼Œé»˜è®¤æ˜¯ç§æœ‰çš„ï¼Œåªæœ‰æ¨¡å—å†…éƒ¨èƒ½è®¿é—®ã€‚ ä¸ºäº†è®©å¤–éƒ¨èƒ½ä½¿ç”¨æ¨¡å—ä¸­ itemï¼Œéœ€è¦ä½¿ç”¨ pub å…³é”®å­—ã€‚å¤–éƒ¨å¼•ç”¨çš„æ—¶å€™ï¼Œä½¿ç”¨ use å…³é”®å­—ã€‚ä¾‹å¦‚ï¼š 12345678910111213mod ccc &#123; pub fn print_ccc() &#123; println!(\"&#123;&#125;\", 25); &#125;&#125;fn main() &#123; use ccc::print_ccc; print_ccc(); // æˆ–è€… ccc::print_ccc();&#125; è§„åˆ™å¾ˆç®€å•ï¼Œä¸€ä¸ª itemï¼ˆå‡½æ•°ï¼Œç»‘å®šï¼ŒTrait ç­‰ï¼‰ï¼Œå‰é¢åŠ äº† pubï¼Œé‚£ä¹ˆå°±å®ƒå˜æˆå¯¹å¤–å¯è§ï¼ˆè®¿é—®ï¼Œè°ƒç”¨ï¼‰çš„äº†ã€‚ å¼•ç”¨å¤–éƒ¨æ–‡ä»¶æ¨¡å—é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šåœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­å†™æ¨¡å—å†…å®¹ï¼Œç„¶åä½¿ç”¨ mod å…³é”®å­—æ¥åŠ è½½é‚£ä¸ªæ–‡ä»¶ä½œä¸ºæˆ‘ä»¬çš„æ¨¡å—ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨ src ä¸‹æ–°å»ºäº†æ–‡ä»¶ aaa.rsã€‚ç°åœ¨ç›®å½•ç»“æ„æ˜¯ä¸‹é¢è¿™æ ·å­ï¼š 12345fooâ”œâ”€â”€ Cargo.tomlâ””â”€â”€ src â””â”€â”€ aaa.rs â””â”€â”€ main.rs æˆ‘ä»¬åœ¨ aaa.rs ä¸­ï¼Œå†™ä¸Šï¼š 123pub fn print_aaa() &#123; println!(\"&#123;&#125;\", 25);&#125; åœ¨ main.rs ä¸­ï¼Œå†™ä¸Šï¼š 1234567mod aaa;use aaa::print_aaa;fn main () &#123; print_aaa();&#125; ç¼–è¯‘åï¼Œç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚ ç»†å¿ƒçš„æœ‹å‹ä¼šå‘ç°ï¼Œaaa.rs ä¸­ï¼Œæ²¡æœ‰ä½¿ç”¨ mod xxx {} è¿™æ ·åŒ…è£¹èµ·æ¥ï¼Œæ˜¯å› ä¸º mod xxx; ç›¸å½“äºæŠŠ xxx.rs æ–‡ä»¶ç”¨ mod xxx {} åŒ…è£¹èµ·æ¥äº†ã€‚åˆå­¦è€…å¾€å¾€ä¼šå¤šåŠ ä¸€å±‚ï¼Œè¯·æ³¨æ„ã€‚ å¤šæ–‡ä»¶æ¨¡å—çš„å±‚çº§å…³ç³»Rust çš„æ¨¡å—æ”¯æŒå±‚çº§ç»“æ„ï¼Œä½†è¿™ç§å±‚çº§ç»“æ„æœ¬èº«ä¸æ–‡ä»¶ç³»ç»Ÿç›®å½•çš„å±‚çº§ç»“æ„æ˜¯è§£è€¦çš„ã€‚ mod xxx; è¿™ä¸ª xxx ä¸èƒ½åŒ…å« :: å·ã€‚ä¹Ÿå³åœ¨è¿™ä¸ªè¡¨è¾¾å½¢å¼ä¸­ï¼Œæ˜¯æ²¡æ³•å¼•ç”¨å¤šå±‚ç»“æ„ä¸‹çš„æ¨¡å—çš„ã€‚ä¹Ÿå³ï¼Œä½ ä¸å¯èƒ½ç›´æ¥ä½¿ç”¨ mod a::b::c::d; çš„å½¢å¼æ¥å¼•ç”¨ a/b/c/d.rs è¿™ä¸ªæ¨¡å—ã€‚ é‚£ä¹ˆï¼ŒRust çš„å¤šå±‚æ¨¡å—éµå¾ªå¦‚ä¸‹ä¸¤æ¡è§„åˆ™ï¼š ä¼˜å…ˆæŸ¥æ‰¾ xxx.rs æ–‡ä»¶ main.rsã€lib.rsã€mod.rs ä¸­çš„ mod xxx; é»˜è®¤ä¼˜å…ˆæŸ¥æ‰¾åŒçº§ç›®å½•ä¸‹çš„ xxx.rs æ–‡ä»¶ï¼› å…¶ä»–æ–‡ä»¶ yyy.rs ä¸­çš„ mod xxx;é»˜è®¤ä¼˜å…ˆæŸ¥æ‰¾åŒçº§ç›®å½•çš„ yyy ç›®å½•ä¸‹çš„ xxx.rs æ–‡ä»¶ï¼› å¦‚æœ xxx.rs ä¸å­˜åœ¨ï¼Œåˆ™æŸ¥æ‰¾ xxx/mod.rs æ–‡ä»¶ï¼Œå³ xxx ç›®å½•ä¸‹çš„ mod.rs æ–‡ä»¶ã€‚ ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼ŒåŠ è½½æˆæ¨¡å—åï¼Œæ•ˆæœæ˜¯ç›¸åŒçš„ã€‚Rust å°±å‡­è¿™ä¸¤æ¡è§„åˆ™ï¼Œé€šè¿‡è¿­ä»£ä½¿ç”¨ï¼Œç»“åˆ pub å…³é”®å­—ï¼Œå®ç°äº†å¯¹æ·±å±‚ç›®å½•ä¸‹æ¨¡å—çš„åŠ è½½ï¼› ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨æˆ‘ä»¬å»ºäº†ä¸€ä¸ªæµ‹è¯•å·¥ç¨‹ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 123456789srcâ”œâ”€â”€ aâ”‚ â”œâ”€â”€ bâ”‚ â”‚ â”œâ”€â”€ câ”‚ â”‚ â”‚ â”œâ”€â”€ d.rsâ”‚ â”‚ â”‚ â””â”€â”€ mod.rsâ”‚ â”‚ â””â”€â”€ mod.rsâ”‚ â””â”€â”€ mod.rsâ””â”€â”€ main.rs a/b/c/d.rs æ–‡ä»¶å†…å®¹ï¼š 123pub fn print_ddd() &#123; println!(\"i am ddd.\");&#125; a/b/c/mod.rs æ–‡ä»¶å†…å®¹ï¼š 1pub mod d; a/b/mod.rs æ–‡ä»¶å†…å®¹ï¼š 1pub mod c; a/mod.rs æ–‡ä»¶å†…å®¹ï¼š 1pub mod b; main.rs æ–‡ä»¶å†…å®¹ï¼š 1234567mod a;use a::b::c::d;fn main() &#123; d::print_ddd();&#125; è¾“å‡ºç»“æœä¸ºï¼ši am ddd. ä»”ç»†ç†è§£æœ¬ä¾‹å­ï¼Œå°±æ˜ç™½ Rust çš„å±‚çº§ç»“æ„æ¨¡å—çš„ç”¨æ³•äº†ã€‚ è‡³äºä¸ºä½• Rust è¦è¿™æ ·è®¾è®¡ï¼Œæœ‰å‡ ä¸‹å‡ ä¸ªåŸå› ï¼š Rust æœ¬èº«æ¨¡å—çš„è®¾è®¡æ˜¯ä¸æ“ä½œç³»ç»Ÿæ–‡ä»¶ç³»ç»Ÿç›®å½•è§£è€¦çš„ï¼Œå› ä¸º Rust æœ¬èº«å¯ç”¨äºæ“ä½œç³»ç»Ÿçš„å¼€å‘ï¼› Rust ä¸­çš„ä¸€ä¸ªæ–‡ä»¶å†…ï¼Œå¯åŒ…å«å¤šä¸ªæ¨¡å—ï¼Œç›´æ¥å°† a::b::c::d æ˜ å°„åˆ° a/b/c/d.rs ä¼šå¼•èµ·ä¸€äº›æ­§ä¹‰ï¼› Rust ä¸€åˆ‡ä»å®‰å…¨æ€§ã€æ˜¾å¼åŒ–ç«‹åœºå‡ºå‘ï¼Œè¦æ±‚å¼•ç”¨è·¯å¾„ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ¨¡å—ï¼Œæ¯”å¦‚ä¸Šä¾‹ï¼Œd æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ¨¡å—çš„è¯ï¼Œé‚£ä¹ˆï¼Œè¦æ±‚ c, b, a åˆ†åˆ«éƒ½æ˜¯æœ‰æ•ˆçš„æ¨¡å—ï¼Œå¯å•ç‹¬å¼•ç”¨ã€‚ è·¯å¾„å‰é¢æˆ‘ä»¬æåˆ°ï¼Œä¸€ä¸ª crate æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯ç¼–è¯‘å•å…ƒã€‚å®ƒæœ‰ä¸€ä¸ªå…¥å£æ–‡ä»¶ï¼Œè¿™ä¸ªå…¥å£æ–‡ä»¶æ˜¯è¿™ä¸ª crateï¼ˆé‡Œé¢å¯èƒ½åŒ…å«è‹¥å¹²ä¸ª moduleï¼‰çš„æ¨¡å—æ ¹è·¯å¾„ã€‚æ•´ä¸ªæ¨¡å—çš„å¼•ç”¨ï¼Œå½¢æˆä¸€ä¸ªé“¾ï¼Œæ¯ä¸ªæ¨¡å—ï¼Œéƒ½å¯ä»¥ç”¨ä¸€ä¸ªç²¾ç¡®çš„è·¯å¾„ï¼ˆæ¯”å¦‚ï¼ša::b::c::dï¼‰æ¥è¡¨ç¤ºï¼› ä¸æ–‡ä»¶ç³»ç»Ÿæ¦‚å¿µç±»ä¼¼ï¼Œæ¨¡å—è·¯å¾„ä¹Ÿæœ‰ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„çš„æ¦‚å¿µã€‚ä¸ºæ­¤ï¼ŒRust æä¾›äº† self å’Œ super ä¸¤ä¸ªå…³é”®å­—ã€‚ self åœ¨è·¯å¾„ä¸­ï¼Œæœ‰ä¸¤ç§æ„æ€ï¼š use self::xxx è¡¨ç¤ºï¼ŒåŠ è½½å½“å‰æ¨¡å—ä¸­çš„ xxxã€‚æ­¤æ—¶ self å¯çœç•¥ï¼› use xxx::{self, yyy}ï¼Œè¡¨ç¤ºï¼ŒåŠ è½½å½“å‰è·¯å¾„ä¸‹æ¨¡å— xxx æœ¬èº«ï¼Œä»¥åŠæ¨¡å— xxx ä¸‹çš„ yyyï¼› super è¡¨ç¤ºï¼Œå½“å‰æ¨¡å—è·¯å¾„çš„ä¸Šä¸€çº§è·¯å¾„ï¼Œå¯ä»¥ç†è§£æˆçˆ¶æ¨¡å—ã€‚ 1use super::xxx; è¡¨ç¤ºå¼•ç”¨çˆ¶æ¨¡å—ä¸­çš„ xxxã€‚ å¦å¤–ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„è·¯å¾„å½¢å¼ï¼š 1::xxx::yyy å®ƒè¡¨ç¤ºï¼Œå¼•ç”¨æ ¹è·¯å¾„ä¸‹çš„ xxx::yyyï¼Œè¿™ä¸ªæ ¹è·¯å¾„ï¼ŒæŒ‡çš„æ˜¯å½“å‰ crate çš„æ ¹è·¯å¾„ã€‚ è·¯å¾„ä¸­çš„ * ç¬¦å·ï¼š 1use xxx::*; è¡¨ç¤ºå¯¼å…¥ xxx æ¨¡å—ä¸‹çš„æ‰€æœ‰å¯è§ itemï¼ˆåŠ äº† pub æ ‡è¯†çš„ itemï¼‰ã€‚ Re-exportingæˆ‘ä»¬å¯ä»¥ç»“åˆä½¿ç”¨ pub use æ¥å®ç° Re-exportingã€‚Re-exporting çš„å­—é¢æ„æ€å°±æ˜¯ é‡æ–°å¯¼å‡ºã€‚å®ƒçš„æ„æ€æ˜¯è¿™æ ·çš„ï¼ŒæŠŠæ·±å±‚çš„ item å¯¼å‡ºåˆ°ä¸Šå±‚ç›®å½•ä¸­ï¼Œä½¿è°ƒç”¨çš„æ—¶å€™ï¼Œæ›´æ–¹ä¾¿ã€‚æ¥å£è®¾è®¡ä¸­ä¼šå¤§é‡ç”¨åˆ°è¿™ä¸ªæŠ€æœ¯ã€‚ è¿˜æ˜¯ä¸¾ä¸Šé¢é‚£ä¸ª a::b::c::d çš„ä¾‹å­ã€‚æˆ‘ä»¬åœ¨ main.rs ä¸­ï¼Œè¦è°ƒç”¨ dï¼Œå¾—ä½¿ç”¨ use a::b::c::d; æ¥è°ƒç”¨ã€‚è€Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹ a/mod.rs æ–‡ä»¶ä¸ºï¼š a/mod.rs æ–‡ä»¶å†…å®¹ï¼š 12pub mod b;pub use b::c::d; é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨ main.rs ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ use a::d; æ¥è°ƒç”¨äº†ã€‚ä»è¿™ä¸ªä¾‹å­æ¥çœ‹æ²¡è§‰å¾—æ–¹ä¾¿å¤šå°‘ã€‚ä½†æ˜¯å¦‚æœå¼€å‘çš„ä¸€ä¸ªåº“ä¸­æœ‰å¤§é‡çš„å†…å®¹ï¼Œè€Œä¸”æ˜¯åœ¨ä¸åŒå±‚æ¬¡çš„æ¨¡å—ä¸­ã€‚é‚£ä¹ˆï¼Œé€šè¿‡ç»Ÿä¸€å¯¼å‡ºåˆ°ä¸€ä¸ªåœ°æ–¹ï¼Œå°±èƒ½å¤§å¤§æ–¹ä¾¿æ¥å£ä½¿ç”¨è€…ã€‚ åŠ è½½å¤–éƒ¨ crateå‰é¢æˆ‘ä»¬è®²çš„ï¼Œéƒ½æ˜¯åœ¨å½“å‰ crate ä¸­çš„æŠ€æœ¯ã€‚çœŸæ­£æˆ‘ä»¬åœ¨å¼€å‘æ—¶ï¼Œä¼šå¤§é‡ç”¨åˆ°å¤–éƒ¨åº“ã€‚å¤–éƒ¨åº“æ˜¯é€šè¿‡ 1extern crate xxx; è¿™æ ·æ¥å¼•å…¥çš„ã€‚ æ³¨ï¼šè¦ä½¿ä¸Šè¿°å¼•ç”¨ç”Ÿæ•ˆï¼Œè¿˜å¿…é¡»åœ¨ Cargo.toml çš„ dependecies æ®µï¼ŒåŠ ä¸Š xxx=â€version numâ€ è¿™ç§ä¾èµ–è¯´æ˜ï¼Œè¯¦æƒ…è§ Cargo é¡¹ç›®ç®¡ç† è¿™ä¸€ç« ã€‚ å¼•å…¥åï¼Œå°±ç›¸å½“äºå¼•å…¥äº†ä¸€ä¸ªç¬¦å· xxxï¼Œåé¢å¯ä»¥ç›´æ¥ä»¥è¿™ä¸ª xxx ä¸ºæ ¹å¼•ç”¨è¿™ä¸ª crate ä¸­çš„ itemï¼š 123extern crate xxx;use xxx::yyy::zzz; å¼•å…¥çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ as å…³é”®å­—é‡å‘½åã€‚ 123extern crate xxx as foo;use foo::yyy::zzz;","categories":[{"name":"rust","slug":"rust","permalink":"http://blog.crazylaw.cn/categories/rust/"}],"tags":[{"name":"rust","slug":"rust","permalink":"http://blog.crazylaw.cn/tags/rust/"}]},{"title":"ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘- Kafkaæ•°æ®åŠ¨æ€è¿ç§»","slug":"æ¶ˆæ¯é˜Ÿåˆ—/kafka-migrants","date":"2020-02-27T09:25:40.000Z","updated":"2021-03-20T16:25:01.819Z","comments":true,"path":"2020/02/27/æ¶ˆæ¯é˜Ÿåˆ—/kafka-migrants/","link":"","permalink":"http://blog.crazylaw.cn/2020/02/27/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka-migrants/","excerpt":"å‰è¨€kafkaä½œä¸ºé«˜æ•ˆçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶æ•°æ®çš„ç»´æŠ¤ä¹Ÿæ˜¯ååˆ†é‡è¦çš„ã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½å­˜åœ¨å¯¹brokerè¿›è¡Œæ•°æ®è¿ç§»ï¼Œæˆ–è€…å¢åŠ æˆ–è€…å‡å°‘brokerã€‚å¯¹äºæˆ‘ä»¬å·²ç»åˆ›å»ºäº†å¯¹topicã€‚å…¶é…ç½®ä¸ä¼šéšä¾¿è¿›è¡Œæ›´æ–°ã€‚isrä¸­ä¾ç„¶å­˜åœ¨ç€å·²ç»ç§»é™¤äº†å¯¹brokerï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦æ›´æ–°å®ƒä»¬çš„ä¿¡æ¯ï¼Œå‘Šè¯‰kafkaæ•°æ®åˆ†å¸ƒçš„æƒ…å†µã€‚å¹¶ä¸”åœ¨æœ€å°‘isrçš„é—®é¢˜åˆ°æ¥ä¹‹å‰ï¼Œæå‰å‡å°‘äº‹æ•…çš„äº‹å‘ã€‚","text":"å‰è¨€kafkaä½œä¸ºé«˜æ•ˆçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶æ•°æ®çš„ç»´æŠ¤ä¹Ÿæ˜¯ååˆ†é‡è¦çš„ã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½å­˜åœ¨å¯¹brokerè¿›è¡Œæ•°æ®è¿ç§»ï¼Œæˆ–è€…å¢åŠ æˆ–è€…å‡å°‘brokerã€‚å¯¹äºæˆ‘ä»¬å·²ç»åˆ›å»ºäº†å¯¹topicã€‚å…¶é…ç½®ä¸ä¼šéšä¾¿è¿›è¡Œæ›´æ–°ã€‚isrä¸­ä¾ç„¶å­˜åœ¨ç€å·²ç»ç§»é™¤äº†å¯¹brokerï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦æ›´æ–°å®ƒä»¬çš„ä¿¡æ¯ï¼Œå‘Šè¯‰kafkaæ•°æ®åˆ†å¸ƒçš„æƒ…å†µã€‚å¹¶ä¸”åœ¨æœ€å°‘isrçš„é—®é¢˜åˆ°æ¥ä¹‹å‰ï¼Œæå‰å‡å°‘äº‹æ•…çš„äº‹å‘ã€‚ 1. åˆ›å»ºtopic1234bash-4.4# kafka-topics.sh --create --topic test-topic \\--zookeeper mzookeeper \\--replication-factor 2 --partitions 3Created topic \"test-topic\". 2.æŸ¥çœ‹test-topic12345bash-4.4# kafka-topics.sh --describe --zookeeper mzookeeper --topic test-topicTopic:test-topic PartitionCount:3 ReplicationFactor:2 Configs: Topic: test-topic Partition: 0 Leader: 1002 Replicas: 1002,1003 Isr: 1002,1003 Topic: test-topic Partition: 1 Leader: 1003 Replicas: 1003,1004 Isr: 1003,1004 Topic: test-topic Partition: 2 Leader: 1004 Replicas: 1004,1001 Isr: 1004,1001 3. äº§ç”Ÿä¸€æ‰¹æ•°æ®1234567891011bash-4.4# kafka-console-producer.sh --topic test-topic --broker-list mkafka1:9092111111222223333344444555555666661111222233334444 4. kafka-reassign-partitionsé‡åˆ†åŒº(å‡è®¾éœ€è¦å‡å°‘èŠ‚ç‚¹broker 1004ï¼Œæœ¬æµ‹è¯•é€šè¿‡å…³é—­å¯¹åº”kafka brokerèŠ‚ç‚¹æ¨¡æ‹Ÿ)12345bash-4.4# kafka-topics.sh --describe --zookeeper mzookeeper --topic test-topicTopic:test-topic PartitionCount:3 ReplicationFactor:2 Configs: Topic: test-topic Partition: 0 Leader: 1002 Replicas: 1002,1003 Isr: 1002,1003 Topic: test-topic Partition: 1 Leader: 1003 Replicas: 1003,1004 Isr: 1003 Topic: test-topic Partition: 2 Leader: 1001 Replicas: 1004,1001 Isr: 1001 è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°partition=2çš„Leaderç”±1004å˜ä¸ºäº†1001ï¼Œå¹¶ä¸”isrä¸­çš„1004å·²ç»ä¸è§äº†ã€‚ 5. æ–°å»ºæ–‡ä»¶topic-to-move.json ï¼Œæ¯”åŠ å…¥å¦‚ä¸‹å†…å®¹123cat&gt;topic-to-move.json&lt;&lt;EOF&#123;\"topics\": [&#123;\"topic\":\"test-topic\"&#125;], \"version\": 1&#125;EOF 6. ä½¿ç”¨â€“generateç”Ÿæˆè¿ç§»è®¡åˆ’ï¼Œbroker-listæ ¹æ®è‡ªå·±ç¯å¢ƒè®¾ç½®ï¼Œæˆ‘çš„ç¯å¢ƒç”±äºbroker 10004æŒ‚æ‰äº†ï¼Œåªå‰©ä¸‹1001å’Œ1002å’Œ10031234567bash-4.4# kafka-reassign-partitions.sh --zookeeper mzookeeper --topics-to-move-json-file topic-to-move.json --broker-list \"1001,1002,1003\" --generateCurrent partition replica assignment&#123;\"version\":1,\"partitions\":[&#123;\"topic\":\"test-topic\",\"partition\":0,\"replicas\":[1002,1003]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":2,\"replicas\":[1004,1001]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":1,\"replicas\":[1003,1004]&#125;]&#125;Proposed partition reassignment configuration&#123;\"version\":1,\"partitions\":[&#123;\"topic\":\"test-topic\",\"partition\":0,\"replicas\":[1003,1001]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":2,\"replicas\":[1002,1003]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":1,\"replicas\":[1001,1002]&#125;]&#125; æˆ‘ä»¬æŠŠæœ€ä¸‹é¢åˆ†é…å¥½çš„å»ºè®®çš„åˆ†åŒºå‰¯æœ¬åˆ†å¸ƒé…ç½®æ‹¿å‡ºæ¥ï¼Œå†™å…¥ä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¸­(ç”Ÿäº§ä¸Šä¸€èˆ¬ä¼šä¿ç•™å½“å‰åˆ†åŒºå‰¯æœ¬åˆ†å¸ƒï¼Œä»…æ›´æ”¹ä¸‹çº¿çš„åˆ†åŒºï¼Œè¿™æ ·æ•°æ®ç§»åŠ¨æ›´å°‘) 123cat &gt; kafka-reassign-execute.json &lt;&lt;EOF&#123;\"version\":1,\"partitions\":[&#123;\"topic\":\"test-topic\",\"partition\":0,\"replicas\":[1003,1001]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":2,\"replicas\":[1002,1003]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":1,\"replicas\":[1001,1002]&#125;]&#125;EOF 7. ä½¿ç”¨â€“executeæ‰§è¡Œè¿ç§»è®¡åˆ’ (æœ‰æ•°æ®ç§»åŠ¨ï¼Œbroker 1004ä¸Šçš„æ•°æ®ä¼šç§»åˆ°broker 1001å’Œ1002å’Œ1003ä¸Šï¼Œå¦‚æœæ•°æ®é‡å¤§ï¼Œæ‰§è¡Œçš„æ—¶é—´ä¼šæ¯”è¾ƒä¹…ï¼Œè€å¿ƒç­‰å¾…å³å¯)123456789bash-4.4# kafka-reassign-partitions.sh --zookeeper mzookeeper \\--reassignment-json-file kafka-reassign-execute.json \\--executeCurrent partition replica assignment&#123;\"version\":1,\"partitions\":[&#123;\"topic\":\"test-topic\",\"partition\":0,\"replicas\":[1002,1003]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":2,\"replicas\":[1004,1001]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":1,\"replicas\":[1003,1004]&#125;]&#125;Save this to use as the --reassignment-json-file option during rollbackSuccessfully started reassignment of partitions &#123;\"version\":1,\"partitions\":[&#123;\"topic\":\"test-topic\",\"partition\":0,\"replicas\":[1003,1001]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":2,\"replicas\":[1002,1003]&#125;,&#123;\"topic\":\"test-topic\",\"partition\":1,\"replicas\":[1001,1002]&#125;]&#125; è¿™é‡Œè¿˜æ˜¯åˆ—å‡ºäº†åŸå§‹çš„é…ç½®å’Œæœ€æ–°çš„é…ç½®ï¼Œå¹¶ä¸”æœ‰ä¸€å¥æç¤ºï¼šå¦‚æœéœ€è¦å›æ»šçš„è¯ï¼Œè¯·ä½¿ç”¨ç¬¬ä¸€ä»½é…ç½®ï¼Œç¬¬äºŒä»½é…ç½®å·²ç»æˆåŠŸå¼€å§‹é‡æ–°åˆ†å‘ã€‚ 8. ä½¿ç”¨-verifyæŸ¥çœ‹è¿ç§»è¿›åº¦1234567bash-4.4# kafka-reassign-partitions.sh --zookeeper mzookeeper \\--reassignment-json-file kafka-reassign-execute.json \\--verifyStatus of partition reassignment:Reassignment of partition [test-topic,0] completed successfullyReassignment of partition [test-topic,2] completed successfullyReassignment of partition [test-topic,1] completed successfully æˆåŠŸå¤„ç†å®Œæ¯•äº†ã€‚ 9. æŸ¥çœ‹è¯¦æƒ…12345bash-4.4# kafka-topics.sh --describe --zookeeper mzookeeper --topic test-topicTopic:test-topic PartitionCount:3 ReplicationFactor:2 Configs: Topic: test-topic Partition: 0 Leader: 1003 Replicas: 1003,1001 Isr: 1003,1001 Topic: test-topic Partition: 1 Leader: 1001 Replicas: 1001,1002 Isr: 1001,1002 Topic: test-topic Partition: 2 Leader: 1002 Replicas: 1002,1003 Isr: 1003,1002 å¯ä»¥çœ‹åˆ°1004çš„broker_idå·²ç»è¢«å½»åº•ç§»é™¤äº†ã€‚ 9. é€šè¿‡æ¶ˆè´¹è€…éªŒè¯ï¼Œå¯çŸ¥ï¼Œå¹¶æœªä¸¢å¤±æ•°æ®ã€‚æ³¨æ„éœ€è¦åŠ â€“from-beginningã€‚1234567891011bash-4.4# kafka-console-consumer.sh --topic test-topic --from-beginning --zookeeper mzookeeper111111444441111444433333666663333222225555552222","categories":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"http://blog.crazylaw.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"}],"tags":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","slug":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","permalink":"http://blog.crazylaw.cn/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8CKafka/"}]},{"title":"ã€Linuxã€‘å¦‚ä½•è·å–æ‰“å¼€æ–‡ä»¶å’Œæ–‡ä»¶æè¿°ç¬¦æ•°é‡","slug":"Linux/å¦‚ä½•è·å–æ‰“å¼€æ–‡ä»¶å’Œæ–‡ä»¶æè¿°ç¬¦æ•°é‡","date":"2019-12-10T09:43:43.000Z","updated":"2021-03-20T16:25:01.800Z","comments":true,"path":"2019/12/10/Linux/å¦‚ä½•è·å–æ‰“å¼€æ–‡ä»¶å’Œæ–‡ä»¶æè¿°ç¬¦æ•°é‡/","link":"","permalink":"http://blog.crazylaw.cn/2019/12/10/Linux/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%89%93%E5%BC%80%E6%96%87%E4%BB%B6%E5%92%8C%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%95%B0%E9%87%8F/","excerpt":"linux çš„æ–‡ä»¶æè¿°ç¬¦æ–‡ä»¶æè¿°ç¬¦ï¼ˆFD:file descriptorsï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯æ–‡ä»¶å¥æŸ„ï¼Œå½“æŸä¸ªç¨‹åºæ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå†…æ ¸è¿”å›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¨‹åºä¸ºäº†å¤„ç†è¯¥æ–‡ä»¶å¿…é¡»å¼•ç”¨æ­¤æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œç”¨ä»¥æ ‡æ˜æ¯ä¸€ä¸ªè¢«è¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶å’Œ socketã€‚æœ€å‰é¢çš„ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ0ï¼Œ1ï¼Œ2ï¼‰åˆ†åˆ«ä¸æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ï¼Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰å¯¹åº”ï¼Œåé¢æ‰“å¼€çš„æ–‡ä»¶ä¾æ­¤ç±»æ¨å¯¹åº” 3ã€4â€¦â€¦ ã€‚ linux ç³»ç»Ÿå¯¹æ¯ä¸ªç”¨æˆ·ã€è¿›ç¨‹ã€æˆ–æ•´ä¸ªç³»ç»Ÿçš„å¯æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ•°é‡éƒ½æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œä¸€èˆ¬é»˜è®¤ä¸º 1024ã€‚å½“æˆ‘ä»¬åœ¨ç³»ç»Ÿæˆ–åº”ç”¨çš„æ—¥å¿—ä¸­ç¢°åˆ°â€œtoo many open filesâ€é”™è¯¯è®°å½•æ—¶ï¼Œè¿™ä¸ªå…¶å®ä¸æ˜¯è¯´æ‰“å¼€çš„æ–‡ä»¶è¿‡å¤šï¼Œè€Œæ˜¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å·²è¾¾åˆ°äº†é™åˆ¶ï¼Œè¿™æ—¶å°±éœ€è¦å¢åŠ æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡é™åˆ¶äº†ã€‚","text":"linux çš„æ–‡ä»¶æè¿°ç¬¦æ–‡ä»¶æè¿°ç¬¦ï¼ˆFD:file descriptorsï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯æ–‡ä»¶å¥æŸ„ï¼Œå½“æŸä¸ªç¨‹åºæ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå†…æ ¸è¿”å›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¨‹åºä¸ºäº†å¤„ç†è¯¥æ–‡ä»¶å¿…é¡»å¼•ç”¨æ­¤æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œç”¨ä»¥æ ‡æ˜æ¯ä¸€ä¸ªè¢«è¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶å’Œ socketã€‚æœ€å‰é¢çš„ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ0ï¼Œ1ï¼Œ2ï¼‰åˆ†åˆ«ä¸æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ï¼Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰å¯¹åº”ï¼Œåé¢æ‰“å¼€çš„æ–‡ä»¶ä¾æ­¤ç±»æ¨å¯¹åº” 3ã€4â€¦â€¦ ã€‚ linux ç³»ç»Ÿå¯¹æ¯ä¸ªç”¨æˆ·ã€è¿›ç¨‹ã€æˆ–æ•´ä¸ªç³»ç»Ÿçš„å¯æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ•°é‡éƒ½æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œä¸€èˆ¬é»˜è®¤ä¸º 1024ã€‚å½“æˆ‘ä»¬åœ¨ç³»ç»Ÿæˆ–åº”ç”¨çš„æ—¥å¿—ä¸­ç¢°åˆ°â€œtoo many open filesâ€é”™è¯¯è®°å½•æ—¶ï¼Œè¿™ä¸ªå…¶å®ä¸æ˜¯è¯´æ‰“å¼€çš„æ–‡ä»¶è¿‡å¤šï¼Œè€Œæ˜¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å·²è¾¾åˆ°äº†é™åˆ¶ï¼Œè¿™æ—¶å°±éœ€è¦å¢åŠ æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡é™åˆ¶äº†ã€‚ è·å–ç³»ç»Ÿæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡12[root@localhost ~]# cat /proc/sys/fs/file-nr1216 0 197787 ç¬¬ä¸€åˆ— 1216 ï¼šä¸ºå·²åˆ†é…çš„ FD æ•°é‡ ç¬¬äºŒåˆ— 0 ï¼šä¸ºå·²åˆ†é…ä½†å°šæœªä½¿ç”¨çš„ FD æ•°é‡ ç¬¬ä¸‰åˆ— 197787 ï¼šä¸ºç³»ç»Ÿå¯ç”¨çš„æœ€å¤§ FD æ•°é‡ å·²ç”¨ FD æ•°é‡ï¼ä¸ºå·²åˆ†é…çš„ FD æ•°é‡ - ä¸ºå·²åˆ†é…ä½†å°šæœªä½¿ç”¨çš„ FD æ•°é‡ã€‚æ³¨æ„ï¼Œè¿™äº›æ•°å€¼æ˜¯ç³»ç»Ÿå±‚é¢çš„ã€‚ è·å–è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡1234567[root@localhost ~]# pidof vim3253[root@localhost ~]# ll /proc/3253/fdlrwx------. 1 test test 64 6æœˆ 8 18:11 0 -&gt; /dev/pts/0lrwx------. 1 test test 64 6æœˆ 8 18:11 1 -&gt; /dev/pts/0lrwx------. 1 test test 64 6æœˆ 8 18:11 2 -&gt; /dev/pts/0lrwx------. 1 test test 64 6æœˆ 8 18:11 4 -&gt; /home/test/.bash_history.swp å¯ä»¥çœ‹åˆ° vim è¿›ç¨‹ç”¨äº† 4 ä¸ª FD æ›´æ”¹æ–‡ä»¶æè¿°ç¬¦é™åˆ¶å½“ç¢°åˆ°â€œtoo many open filesâ€é”™è¯¯æ—¶ï¼Œå°±éœ€è¦å¢åŠ æ–‡ä»¶æè¿°ç¬¦çš„é™åˆ¶æ•°é‡ï¼Œç³»ç»Ÿçš„é»˜è®¤æ–‡ä»¶æè¿°ç¬¦éƒ½æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œåªéœ€å¢åŠ ç”¨æˆ·æˆ–è¿›ç¨‹çš„å°±å¯ä»¥äº† ç”¨æˆ·æˆ–è¿›ç¨‹12345[root@localhost ~]# ulimit -n1024[root@localhost ~]# ulimit -n 10240[root@localhost ~]# ulimit -n10240 æ³¨æ„ï¼Œä½¿ç”¨ ulimit å‘½ä»¤æ›´æ”¹ååªæ˜¯åœ¨å½“å‰ä¼šè¯ç”Ÿæ•ˆï¼Œå½“é€€å‡ºå½“å‰ä¼šè¯é‡æ–°ç™»å½•ååˆä¼šå›åˆ°é»˜è®¤å€¼ 1024ï¼Œè¦æ°¸ä¹…æ›´æ”¹å¯ä»¥ä¿®æ”¹æ–‡ä»¶ /etc/security/limit.confï¼Œå¦‚ 1[root@localhost ~]#vi /etc/security/limits.conf åŠ å…¥ â€œabc hard nofile 10240â€ abcï¼šç”¨æˆ·åï¼Œå³å…è®¸ test ä½¿ç”¨ ulimit å‘½ä»¤æ›´æ”¹ FD é™åˆ¶ï¼Œæœ€å¤§å€¼ä¸è¶…è¿‡ 10240ï¼Œæ›´æ”¹å abc ç”¨æˆ·çš„æ¯ä¸€ä¸ªè¿›ç¨‹ï¼ˆä»¥ abc ç”¨æˆ·è¿è¡Œçš„è¿›ç¨‹ï¼‰å¯æ‰“å¼€çš„ FD æ•°é‡ä¸º 10240 ä¸ª hardï¼šé™åˆ¶ç±»å‹ï¼Œæœ‰ soft/hard ä¸¤ç§ï¼Œè¾¾åˆ° soft é™åˆ¶ä¼šåœ¨ç³»ç»Ÿçš„æ—¥å¿—ï¼ˆä¸€èˆ¬ä¸º/var/log/messagesï¼‰é‡Œé¢è®°å½•ä¸€æ¡å‘Šè­¦æ—¥å¿—ï¼Œä½†ä¸å½±å“ä½¿ç”¨ã€‚hardï¼Œè¾¾åˆ°è¿™ä¸ªé™åˆ¶ï¼Œæœ‰æ—¥å¿—ä¸”ä¼šå½±å“ä½¿ç”¨ã€‚ nofileï¼šé™åˆ¶çš„å†…å®¹ï¼Œnofile - max number of open files 1024 ï¼šå€¼ æ›´æ”¹åï¼Œé€€å‡ºç»ˆç«¯é‡æ–°ç™»å½•ï¼Œç”¨ ulimit çœ‹çœ‹æœ‰æ²¡æœ‰ç”Ÿæ•ˆï¼Œå¦‚æœæ²¡ç”Ÿæ•ˆï¼Œå¯ä»¥åœ¨ abc ç”¨æˆ·çš„.bash_profile æ–‡ä»¶åŠ ä¸Š ulimit -n 10240 ,ä»¥ä½¿ç”¨æˆ· abc æ¯æ¬¡ç™»å½•æ—¶éƒ½ä¼šå°† FD æœ€å¤§å€¼æ›´æ”¹ä¸º 10240ï¼Œå¦‚ï¼š 12345[root@localhost ~]#echo \"ulimit -n 10240\" &gt;&gt; /home/abc/ .bash_profile10240[root@localhost ~]# su - abc[abc@localhost ~]\\$ ulimit -n10240 limit.conf æ–‡ä»¶é‡Œé¢æœ¬èº«å·²æœ‰å¾ˆè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™ä¸ªä¸‹æ¬¡å¯ä»¥è¯´è¯´ã€‚ ç³»ç»Ÿçº§åˆ«å°†æ•´ä¸ªæ“ä½œç³»ç»Ÿå¯ä»¥ä½¿ç”¨çš„ FD æ•°é‡æ›´æ”¹ä¸º 51200 123[root@localhost ~]# echo \"51200\" &gt; /proc/sys/fs/file-max[root@localhost ~]# cat /proc/sys/fs/file-nr1184 0 51200 åƒè¿™æ ·æ›´æ”¹åœ¨ç³»ç»Ÿé‡å¯åä¼šæ¢å¤åˆ°é»˜è®¤å€¼ï¼Œè¦æ°¸ä¹…æ›´æ”¹å¯ä»¥åœ¨ sysctl.conf æ–‡ä»¶åŠ ä¸Š fs.file-max = 51200 å¦‚ï¼š 1[root@localhost ~]# echo \"fs.file-max = 51200\" &gt;&gt; /etc/sysctl.conf è·å–æ‰“å¼€çš„æ–‡ä»¶æ•°é‡linux çš„ä¸€åˆ‡çš†ä¸ºæ–‡ä»¶ï¼Œé‚£ä¹ˆå¦‚ä½•çŸ¥é“ç³»ç»Ÿ/åº”ç”¨æ‰“å¼€äº†å“ªäº›æˆ–æ˜¯å¤šå°‘ä¸ªæ–‡ä»¶å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œç”¨ lsof å‘½ä»¤å°±è¡Œäº†ï¼Œlsofï¼Œlist open files çš„ç®€å†™ï¼Œå¯åˆ—å‡ºç¨‹åºæˆ–ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨çš„æ–‡ä»¶ã€‚ è·å–æ•´ä¸ªç³»ç»Ÿæ‰“å¼€çš„æ–‡ä»¶æ•°é‡12[root@localhost ~]# lsof |wc -l1864 è·å–æŸä¸ªç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶æ•°é‡12[root@localhost ~]# lsof -u test |wc -l15 è·å–æŸä¸ªç¨‹åºæ‰“å¼€çš„æ–‡ä»¶æ•°é‡1234[root@localhost ~]# pidof vim3253[root@localhost ~]# lsof -p 3253 |wc -l31 ä¸Šé¢æ‰€ç¤ºåªæ˜¯ç”¨ lsof æ¥æ˜¾ç¤ºå·²æ‰“å¼€çš„æ–‡ä»¶æ•°é‡ï¼Œlsof çš„åŠŸèƒ½è¿œä¸æ­¢è¿™äº›ï¼Œæœ‰å…´è¶£å¯ä»¥ man lsof çœ‹ä¸€ä¸‹ æŒ‡æ ‡ æµ‹è¯•å€¼ æµ‹è¯•æ—¶é•¿ 12 å°æ—¶ 15 åˆ† æ•°æ®é‡ 108000000 å¹³å‡æ¶ˆè´¹é€Ÿç‡ï¼ˆTPSï¼‰ 6500 æ¡/ç§’ æ€»ç»“ åœ¨è¿™ç§é«˜å³°æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œmthinkingdata ä¼šå µå¡ä¸€éƒ¨åˆ†æµé‡ï¼Œé™¤éä¼˜åŒ–åˆ©ç”¨ Redis çš„æœºåˆ¶ï¼Œä½¿æœåŠ¡æ”¯æŒå¤šä¸ª Redis å®ä¾‹å­˜å‚¨","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"}]},{"title":"ã€Linuxã€‘é¡ºåºå†™ç›˜å’Œéšæœºå†™ç›˜","slug":"Linux/é¡ºåºå†™ç›˜å’Œéšæœºå†™ç›˜","date":"2019-12-10T09:43:43.000Z","updated":"2021-03-20T16:25:01.800Z","comments":true,"path":"2019/12/10/Linux/é¡ºåºå†™ç›˜å’Œéšæœºå†™ç›˜/","link":"","permalink":"http://blog.crazylaw.cn/2019/12/10/Linux/%E9%A1%BA%E5%BA%8F%E5%86%99%E7%9B%98%E5%92%8C%E9%9A%8F%E6%9C%BA%E5%86%99%E7%9B%98/","excerpt":"linux çš„æ–‡ä»¶æè¿°ç¬¦æ–‡ä»¶æè¿°ç¬¦ï¼ˆFD:file descriptorsï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯æ–‡ä»¶å¥æŸ„ï¼Œå½“æŸä¸ªç¨‹åºæ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå†…æ ¸è¿”å›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¨‹åºä¸ºäº†å¤„ç†è¯¥æ–‡ä»¶å¿…é¡»å¼•ç”¨æ­¤æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œç”¨ä»¥æ ‡æ˜æ¯ä¸€ä¸ªè¢«è¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶å’Œ socketã€‚æœ€å‰é¢çš„ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ0ï¼Œ1ï¼Œ2ï¼‰åˆ†åˆ«ä¸æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ï¼Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰å¯¹åº”ï¼Œåé¢æ‰“å¼€çš„æ–‡ä»¶ä¾æ­¤ç±»æ¨å¯¹åº” 3ã€4â€¦â€¦ ã€‚ linux ç³»ç»Ÿå¯¹æ¯ä¸ªç”¨æˆ·ã€è¿›ç¨‹ã€æˆ–æ•´ä¸ªç³»ç»Ÿçš„å¯æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ•°é‡éƒ½æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œä¸€èˆ¬é»˜è®¤ä¸º 1024ã€‚å½“æˆ‘ä»¬åœ¨ç³»ç»Ÿæˆ–åº”ç”¨çš„æ—¥å¿—ä¸­ç¢°åˆ°â€œtoo many open filesâ€é”™è¯¯è®°å½•æ—¶ï¼Œè¿™ä¸ªå…¶å®ä¸æ˜¯è¯´æ‰“å¼€çš„æ–‡ä»¶è¿‡å¤šï¼Œè€Œæ˜¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å·²è¾¾åˆ°äº†é™åˆ¶ï¼Œè¿™æ—¶å°±éœ€è¦å¢åŠ æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡é™åˆ¶äº†ã€‚","text":"linux çš„æ–‡ä»¶æè¿°ç¬¦æ–‡ä»¶æè¿°ç¬¦ï¼ˆFD:file descriptorsï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯æ–‡ä»¶å¥æŸ„ï¼Œå½“æŸä¸ªç¨‹åºæ‰“å¼€æ–‡ä»¶æ—¶ï¼Œå†…æ ¸è¿”å›ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¨‹åºä¸ºäº†å¤„ç†è¯¥æ–‡ä»¶å¿…é¡»å¼•ç”¨æ­¤æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ï¼Œç”¨ä»¥æ ‡æ˜æ¯ä¸€ä¸ªè¢«è¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶å’Œ socketã€‚æœ€å‰é¢çš„ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ0ï¼Œ1ï¼Œ2ï¼‰åˆ†åˆ«ä¸æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ï¼Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰å¯¹åº”ï¼Œåé¢æ‰“å¼€çš„æ–‡ä»¶ä¾æ­¤ç±»æ¨å¯¹åº” 3ã€4â€¦â€¦ ã€‚ linux ç³»ç»Ÿå¯¹æ¯ä¸ªç”¨æˆ·ã€è¿›ç¨‹ã€æˆ–æ•´ä¸ªç³»ç»Ÿçš„å¯æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦æ•°é‡éƒ½æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œä¸€èˆ¬é»˜è®¤ä¸º 1024ã€‚å½“æˆ‘ä»¬åœ¨ç³»ç»Ÿæˆ–åº”ç”¨çš„æ—¥å¿—ä¸­ç¢°åˆ°â€œtoo many open filesâ€é”™è¯¯è®°å½•æ—¶ï¼Œè¿™ä¸ªå…¶å®ä¸æ˜¯è¯´æ‰“å¼€çš„æ–‡ä»¶è¿‡å¤šï¼Œè€Œæ˜¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡å·²è¾¾åˆ°äº†é™åˆ¶ï¼Œè¿™æ—¶å°±éœ€è¦å¢åŠ æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡é™åˆ¶äº†ã€‚ è·å–ç³»ç»Ÿæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡12[root@localhost ~]# cat /proc/sys/fs/file-nr1216 0 197787 ç¬¬ä¸€åˆ— 1216 ï¼šä¸ºå·²åˆ†é…çš„ FD æ•°é‡ ç¬¬äºŒåˆ— 0 ï¼šä¸ºå·²åˆ†é…ä½†å°šæœªä½¿ç”¨çš„ FD æ•°é‡ ç¬¬ä¸‰åˆ— 197787 ï¼šä¸ºç³»ç»Ÿå¯ç”¨çš„æœ€å¤§ FD æ•°é‡ å·²ç”¨ FD æ•°é‡ï¼ä¸ºå·²åˆ†é…çš„ FD æ•°é‡ - ä¸ºå·²åˆ†é…ä½†å°šæœªä½¿ç”¨çš„ FD æ•°é‡ã€‚æ³¨æ„ï¼Œè¿™äº›æ•°å€¼æ˜¯ç³»ç»Ÿå±‚é¢çš„ã€‚ è·å–è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡1234567[root@localhost ~]# pidof vim3253[root@localhost ~]# ll /proc/3253/fdlrwx------. 1 test test 64 6æœˆ 8 18:11 0 -&gt; /dev/pts/0lrwx------. 1 test test 64 6æœˆ 8 18:11 1 -&gt; /dev/pts/0lrwx------. 1 test test 64 6æœˆ 8 18:11 2 -&gt; /dev/pts/0lrwx------. 1 test test 64 6æœˆ 8 18:11 4 -&gt; /home/test/.bash_history.swp å¯ä»¥çœ‹åˆ° vim è¿›ç¨‹ç”¨äº† 4 ä¸ª FD æ›´æ”¹æ–‡ä»¶æè¿°ç¬¦é™åˆ¶å½“ç¢°åˆ°â€œtoo many open filesâ€é”™è¯¯æ—¶ï¼Œå°±éœ€è¦å¢åŠ æ–‡ä»¶æè¿°ç¬¦çš„é™åˆ¶æ•°é‡ï¼Œç³»ç»Ÿçš„é»˜è®¤æ–‡ä»¶æè¿°ç¬¦éƒ½æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œåªéœ€å¢åŠ ç”¨æˆ·æˆ–è¿›ç¨‹çš„å°±å¯ä»¥äº† ç”¨æˆ·æˆ–è¿›ç¨‹12345[root@localhost ~]# ulimit -n1024[root@localhost ~]# ulimit -n 10240[root@localhost ~]# ulimit -n10240 æ³¨æ„ï¼Œä½¿ç”¨ ulimit å‘½ä»¤æ›´æ”¹ååªæ˜¯åœ¨å½“å‰ä¼šè¯ç”Ÿæ•ˆï¼Œå½“é€€å‡ºå½“å‰ä¼šè¯é‡æ–°ç™»å½•ååˆä¼šå›åˆ°é»˜è®¤å€¼ 1024ï¼Œè¦æ°¸ä¹…æ›´æ”¹å¯ä»¥ä¿®æ”¹æ–‡ä»¶ /etc/security/limit.confï¼Œå¦‚ 1[root@localhost ~]#vi /etc/security/limits.conf åŠ å…¥ â€œabc hard nofile 10240â€ abcï¼šç”¨æˆ·åï¼Œå³å…è®¸ test ä½¿ç”¨ ulimit å‘½ä»¤æ›´æ”¹ FD é™åˆ¶ï¼Œæœ€å¤§å€¼ä¸è¶…è¿‡ 10240ï¼Œæ›´æ”¹å abc ç”¨æˆ·çš„æ¯ä¸€ä¸ªè¿›ç¨‹ï¼ˆä»¥ abc ç”¨æˆ·è¿è¡Œçš„è¿›ç¨‹ï¼‰å¯æ‰“å¼€çš„ FD æ•°é‡ä¸º 10240 ä¸ª hardï¼šé™åˆ¶ç±»å‹ï¼Œæœ‰ soft/hard ä¸¤ç§ï¼Œè¾¾åˆ° soft é™åˆ¶ä¼šåœ¨ç³»ç»Ÿçš„æ—¥å¿—ï¼ˆä¸€èˆ¬ä¸º/var/log/messagesï¼‰é‡Œé¢è®°å½•ä¸€æ¡å‘Šè­¦æ—¥å¿—ï¼Œä½†ä¸å½±å“ä½¿ç”¨ã€‚hardï¼Œè¾¾åˆ°è¿™ä¸ªé™åˆ¶ï¼Œæœ‰æ—¥å¿—ä¸”ä¼šå½±å“ä½¿ç”¨ã€‚ nofileï¼šé™åˆ¶çš„å†…å®¹ï¼Œnofile - max number of open files 1024 ï¼šå€¼ æ›´æ”¹åï¼Œé€€å‡ºç»ˆç«¯é‡æ–°ç™»å½•ï¼Œç”¨ ulimit çœ‹çœ‹æœ‰æ²¡æœ‰ç”Ÿæ•ˆï¼Œå¦‚æœæ²¡ç”Ÿæ•ˆï¼Œå¯ä»¥åœ¨ abc ç”¨æˆ·çš„.bash_profile æ–‡ä»¶åŠ ä¸Š ulimit -n 10240 ,ä»¥ä½¿ç”¨æˆ· abc æ¯æ¬¡ç™»å½•æ—¶éƒ½ä¼šå°† FD æœ€å¤§å€¼æ›´æ”¹ä¸º 10240ï¼Œå¦‚ï¼š 12345[root@localhost ~]#echo \"ulimit -n 10240\" &gt;&gt; /home/abc/ .bash_profile10240[root@localhost ~]# su - abc[abc@localhost ~]\\$ ulimit -n10240 limit.conf æ–‡ä»¶é‡Œé¢æœ¬èº«å·²æœ‰å¾ˆè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™ä¸ªä¸‹æ¬¡å¯ä»¥è¯´è¯´ã€‚ ç³»ç»Ÿçº§åˆ«å°†æ•´ä¸ªæ“ä½œç³»ç»Ÿå¯ä»¥ä½¿ç”¨çš„ FD æ•°é‡æ›´æ”¹ä¸º 51200 123[root@localhost ~]# echo \"51200\" &gt; /proc/sys/fs/file-max[root@localhost ~]# cat /proc/sys/fs/file-nr1184 0 51200 åƒè¿™æ ·æ›´æ”¹åœ¨ç³»ç»Ÿé‡å¯åä¼šæ¢å¤åˆ°é»˜è®¤å€¼ï¼Œè¦æ°¸ä¹…æ›´æ”¹å¯ä»¥åœ¨ sysctl.conf æ–‡ä»¶åŠ ä¸Š fs.file-max = 51200 å¦‚ï¼š 1[root@localhost ~]# echo \"fs.file-max = 51200\" &gt;&gt; /etc/sysctl.conf è·å–æ‰“å¼€çš„æ–‡ä»¶æ•°é‡linux çš„ä¸€åˆ‡çš†ä¸ºæ–‡ä»¶ï¼Œé‚£ä¹ˆå¦‚ä½•çŸ¥é“ç³»ç»Ÿ/åº”ç”¨æ‰“å¼€äº†å“ªäº›æˆ–æ˜¯å¤šå°‘ä¸ªæ–‡ä»¶å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œç”¨ lsof å‘½ä»¤å°±è¡Œäº†ï¼Œlsofï¼Œlist open files çš„ç®€å†™ï¼Œå¯åˆ—å‡ºç¨‹åºæˆ–ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨çš„æ–‡ä»¶ã€‚ è·å–æ•´ä¸ªç³»ç»Ÿæ‰“å¼€çš„æ–‡ä»¶æ•°é‡12[root@localhost ~]# lsof |wc -l1864 è·å–æŸä¸ªç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶æ•°é‡12[root@localhost ~]# lsof -u test |wc -l15 è·å–æŸä¸ªç¨‹åºæ‰“å¼€çš„æ–‡ä»¶æ•°é‡1234[root@localhost ~]# pidof vim3253[root@localhost ~]# lsof -p 3253 |wc -l31 ä¸Šé¢æ‰€ç¤ºåªæ˜¯ç”¨ lsof æ¥æ˜¾ç¤ºå·²æ‰“å¼€çš„æ–‡ä»¶æ•°é‡ï¼Œlsof çš„åŠŸèƒ½è¿œä¸æ­¢è¿™äº›ï¼Œæœ‰å…´è¶£å¯ä»¥ man lsof çœ‹ä¸€ä¸‹ æŒ‡æ ‡ æµ‹è¯•å€¼ æµ‹è¯•æ—¶é•¿ 12 å°æ—¶ 15 åˆ† æ•°æ®é‡ 108000000 å¹³å‡æ¶ˆè´¹é€Ÿç‡ï¼ˆTPSï¼‰ 6500 æ¡/ç§’ æ€»ç»“ åœ¨è¿™ç§é«˜å³°æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œmthinkingdata ä¼šå µå¡ä¸€éƒ¨åˆ†æµé‡ï¼Œé™¤éä¼˜åŒ–åˆ©ç”¨ Redis çš„æœºåˆ¶ï¼Œä½¿æœåŠ¡æ”¯æŒå¤šä¸ª Redis å®ä¾‹å­˜å‚¨","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"}]},{"title":"ã€æ•°æ®åº“å¼€å‘çŸ¥è¯†ã€‘B+æ ‘","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†/B+æ ‘","date":"2019-12-05T09:43:43.000Z","updated":"2021-03-20T16:25:01.816Z","comments":true,"path":"2019/12/05/æ•°æ®åº“å¼€å‘çŸ¥è¯†/B+æ ‘/","link":"","permalink":"http://blog.crazylaw.cn/2019/12/05/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/B+%E6%A0%91/","excerpt":"å‰æ²¿B/B+æ ‘åœ¨æ•°æ®å­˜å‚¨ä¸Šä¸€ç›´éƒ½æ˜¯æœ€é«˜æ•ˆçš„æ•°æ®ç»“æ„ã€‚B æ ‘çš„æ¦‚å¿µæ¯”è¾ƒæ¸…æ™°ï¼Œä½†æ˜¯ B+æ ‘çš„æ¦‚å¿µå´æœ‰ä¸åŒçš„è§£é‡Šã€‚","text":"å‰æ²¿B/B+æ ‘åœ¨æ•°æ®å­˜å‚¨ä¸Šä¸€ç›´éƒ½æ˜¯æœ€é«˜æ•ˆçš„æ•°æ®ç»“æ„ã€‚B æ ‘çš„æ¦‚å¿µæ¯”è¾ƒæ¸…æ™°ï¼Œä½†æ˜¯ B+æ ‘çš„æ¦‚å¿µå´æœ‰ä¸åŒçš„è§£é‡Šã€‚","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®ç»“æ„/æ•°æ®åº“","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93/"}],"tags":[{"name":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/"}]},{"title":"ã€æ•°æ®åº“å¼€å‘çŸ¥è¯†ã€‘åŸºäºB+æ ‘å®ç°ä¸€ä¸ªé«˜å¹¶å‘æ•°æ®åº“","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†/åŸºäºB+æ ‘å®ç°ä¸€ä¸ªé«˜å¹¶å‘æ•°æ®åº“","date":"2019-12-05T09:43:43.000Z","updated":"2021-03-20T16:25:01.817Z","comments":true,"path":"2019/12/05/æ•°æ®åº“å¼€å‘çŸ¥è¯†/åŸºäºB+æ ‘å®ç°ä¸€ä¸ªé«˜å¹¶å‘æ•°æ®åº“/","link":"","permalink":"http://blog.crazylaw.cn/2019/12/05/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/%E5%9F%BA%E4%BA%8EB+%E6%A0%91%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%AB%98%E5%B9%B6%E5%8F%91%E6%95%B0%E6%8D%AE%E5%BA%93/","excerpt":"å¼€å‘ç¬”è®°12345678910111213141516171819202122#define M (3) // \b\bB+æ ‘çš„é˜¶æ•°#define LIMIT_M_2 (M &gt;&gt; 1) // Mçš„ä¸­ç‚¹#define True (1)#define False (0)#define INDEX_NAME (\"index\") // ç´¢å¼•æ–‡ä»¶#define SUCCESS (1)#define ERROR (-1)#define OPEN_MODE (O_RDWR | O_CREAT | O_TRUNC) // æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ï¼šå¯è¯»å¯å†™æ‰“å¼€ | è‹¥æ­¤æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒ | å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œå¹¶ä¸”ä»¥åªå†™æˆ–å¯è¯»å¯å†™æ–¹å¼æ‰“å¼€ï¼Œåˆ™å°†å…¶é•¿åº¦æˆªæ–­ï¼ˆTruncateï¼‰ä¸º0å­—èŠ‚#define FILE_MODE (S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH) // æ–‡ä»¶çš„æƒé™ï¼š660typedef int KeyType; // å…³é”®å­—çš„æ•°æ®ç±»å‹typedef off_t Record; // ç´¢å¼•æ‰€å¯¹åº”çš„å€¼typedef struct BPTNode&#123; int isLeaf; // æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹ int keynum; // å…³é”®å­—ä¸ªæ•° KeyType key[M + 1]; // å­˜æ”¾çš„å…³é”®å­—çš„è¿ç»­å†…å­˜ struct BPTNode *ptr[M + 1];// å…³é”®å­—å­æ ‘çš„è¿ç»­å†…å­˜ struct BPTNode *next; Record value[M + 1]; // å…³é”®å­—å¯¹åº”çš„valueï¼Œå½“èŠ‚ç‚¹ä¸ºå¶å­èŠ‚ç‚¹çš„æ—¶å€™æ‰æœ‰æ•ˆ&#125;BPTNode, *BPTree; æˆ‘ä»¬çœ‹åˆ° BPTNode æ˜¯æˆ‘ä»¬çš„èŠ‚ç‚¹ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“å ç”¨çš„å†…å­˜å¤§å°æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹ï¼š è®°ä½å†…å­˜å¯¹é½çš„åŸåˆ™ï¼Œå¹¶ä¸”æŒ‡é’ˆå ç”¨ 8 ä¸ªå­—èŠ‚ï¼Œoff_t ä¸€èˆ¬æ˜¯ 64 ä½ï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ 14(int)+4(int)+4(KeyType)*4(M+1)+4(*pts)*4(M+1)+4(*next)+8(Record)*4(M+1) &#x3D; 4+4+16+32+8+32 &#x3D; 96bytes","text":"å¼€å‘ç¬”è®°12345678910111213141516171819202122#define M (3) // \b\bB+æ ‘çš„é˜¶æ•°#define LIMIT_M_2 (M &gt;&gt; 1) // Mçš„ä¸­ç‚¹#define True (1)#define False (0)#define INDEX_NAME (\"index\") // ç´¢å¼•æ–‡ä»¶#define SUCCESS (1)#define ERROR (-1)#define OPEN_MODE (O_RDWR | O_CREAT | O_TRUNC) // æ‰“å¼€æ–‡ä»¶çš„æ¨¡å¼ï¼šå¯è¯»å¯å†™æ‰“å¼€ | è‹¥æ­¤æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒ | å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œå¹¶ä¸”ä»¥åªå†™æˆ–å¯è¯»å¯å†™æ–¹å¼æ‰“å¼€ï¼Œåˆ™å°†å…¶é•¿åº¦æˆªæ–­ï¼ˆTruncateï¼‰ä¸º0å­—èŠ‚#define FILE_MODE (S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH) // æ–‡ä»¶çš„æƒé™ï¼š660typedef int KeyType; // å…³é”®å­—çš„æ•°æ®ç±»å‹typedef off_t Record; // ç´¢å¼•æ‰€å¯¹åº”çš„å€¼typedef struct BPTNode&#123; int isLeaf; // æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹ int keynum; // å…³é”®å­—ä¸ªæ•° KeyType key[M + 1]; // å­˜æ”¾çš„å…³é”®å­—çš„è¿ç»­å†…å­˜ struct BPTNode *ptr[M + 1];// å…³é”®å­—å­æ ‘çš„è¿ç»­å†…å­˜ struct BPTNode *next; Record value[M + 1]; // å…³é”®å­—å¯¹åº”çš„valueï¼Œå½“èŠ‚ç‚¹ä¸ºå¶å­èŠ‚ç‚¹çš„æ—¶å€™æ‰æœ‰æ•ˆ&#125;BPTNode, *BPTree; æˆ‘ä»¬çœ‹åˆ° BPTNode æ˜¯æˆ‘ä»¬çš„èŠ‚ç‚¹ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“å ç”¨çš„å†…å­˜å¤§å°æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹ï¼š è®°ä½å†…å­˜å¯¹é½çš„åŸåˆ™ï¼Œå¹¶ä¸”æŒ‡é’ˆå ç”¨ 8 ä¸ªå­—èŠ‚ï¼Œoff_t ä¸€èˆ¬æ˜¯ 64 ä½ï¼Œå ç”¨ 8 ä¸ªå­—èŠ‚ 14(int)+4(int)+4(KeyType)*4(M+1)+4(*pts)*4(M+1)+4(*next)+8(Record)*4(M+1) &#x3D; 4+4+16+32+8+32 &#x3D; 96bytes \b\b## æ„å»º B+æ ‘ 123456789101112131415161718192021222324252627282930313233343536373839404142// ä»ç´¢å¼•æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œåˆ›å»ºb+æ ‘extern BPTree CreatBPTree(BPTree T)&#123; int fd; int i = 0, ret = -1; unsigned long file_len = -1; struct stat statbuff; KeyType temp = 0; KeyType *q; Record t_record = 0; Record *p; q = &amp;temp; p = &amp;t_record; file_len = get_file_size(INDEX_NAME); if ((fd = open(INDEX_NAME, O_RDONLY)) == -1) &#123; printf(\"Open index file failled!\\n\"); return NULL; &#125; while (i &lt; file_len) &#123; if ((ret = pread(fd, q, 4, i)) == -1) &#123; close(fd); return NULL; &#125; if ((ret = pread(fd, p, 4, i + 4)) == -1) &#123; close(fd); return NULL; &#125; T = Insert(T, *q, *p); i = i + 8; &#125; close(fd); return T;&#125; ä»¥åªè¯»çš„æ–¹å¼æ‰“å¼€ç´¢å¼•æœªè§ï¼Œç”¨äºæ„å»º B+æ ‘ã€‚","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®ç»“æ„/æ•°æ®åº“","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93/"}],"tags":[{"name":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/"}]},{"title":"ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘- kafka-swoole","slug":"æ¶ˆæ¯é˜Ÿåˆ—/kafka-swoole","date":"2019-11-04T02:37:40.000Z","updated":"2021-03-20T16:25:01.819Z","comments":true,"path":"2019/11/04/æ¶ˆæ¯é˜Ÿåˆ—/kafka-swoole/","link":"","permalink":"http://blog.crazylaw.cn/2019/11/04/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka-swoole/","excerpt":"å‰è¨€ç›®å‰ kafka å®¢æˆ·ç«¯åœ¨ php ä¸­æ¯”è¾ƒå‡ºåçš„ä»…æœ‰ 2 ä¸ªï¼Œè¿™ 2 ä¸ªé¡¹ç›®éƒ½æœ‰å„è‡ªçš„åˆ©å¼Šã€‚åœ¨è¿™é‡Œæˆ‘é€‰æ‹©å‡ ä¸ªæ¥åˆ—ä¸€ä¸‹ weiboad/kafka-php åè®®éç»“æ„åŒ–å°è£…ï¼Œè‡ªå®šä¹‰æ€§è¾ƒå¼ºï¼Œä¸å¥½ç»´æŠ¤ ç›®å‰çš„ API åœ¨æ¶ˆè´¹è€…ä¸­ç”±äºå•ä¾‹è®¾è®¡çš„åŸå› ï¼Œä¸å…è®¸åœ¨æ¶ˆè´¹è€…ä¸­ç”Ÿäº§æ¶ˆæ¯ ä¸æ”¯æŒå¤šç§å‹ç¼©åè®® å•è¿›ç¨‹â€œåç¨‹å¼â€é€»è¾‘ï¼Œæ•°æ®æœªå®ç°åˆ†ç¦»ï¼Œå®¹æ˜“å µå¡æ¶ˆè´¹ arnaud-lb/php-rdkafka åè®®éç»“æ„åŒ–å°è£…ï¼Œè‡ªå®šä¹‰æ€§è¾ƒå¼ºï¼Œä¸å¥½ç»´æŠ¤ ä¸æ”¯æŒå¤šç§å‹ç¼©åè®® åˆ©ç”¨å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ PHP å¯¹å¤šçº¿ç¨‹å¯¹æ”¯æŒå¹¶ä¸å‹å¥½ï¼Œç›¸å¯¹äºç”¨ swoole è€Œè¨€ï¼ŒåŠ£åŠ¿è¾ƒä¸ºæ˜æ˜¾ï¼Œå®¹æ˜“å‡º bugï¼Œä¸”ç»´æŠ¤æ€§ä¸é«˜ åŸºäºä»¥ä¸Šå‡ ç‚¹ï¼Œæˆ‘ä»¬åœ¨åŸºäºswoole-4.3ä»¥ä¸Šé‡æ–°å¼€å‘äº†kafka-swooleé¡¹ç›®ï¼Œä¼˜ç‚¹å¦‚ä¸‹ï¼š å¤šè¿›ç¨‹å¤šæ ¸å¤„ç† æ”¯æŒ kafka å¤šä¸ª sink æ–¹å¼ï¼Œå®ç°æ‹‰å– kafka æ•°æ®å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œä»è€Œä¸å µå¡æ•°æ®æ‹‰å– é¦–ä¸ªæ”¯æŒå¤šç§å‹ç¼©æ–¹å¼ï¼ˆnormal(ä¸å‹ç¼©)/gzip/snappyï¼‰çš„ php å®¢æˆ·ç«¯ï¼Œä»è€Œåœ¨å¤§ååå¯¹æƒ…å†µä¸‹å‡å°‘å¸¦å®½å ç”¨ï¼Œæé«˜ä¼ è¾“é€Ÿç‡ åè®®å°è£…é‡‡ç”¨ OOP çš„æ–¹å¼ï¼Œç»“æ„åŒ–äº†åè®®çš„å°è£…ï¼Œåˆ©äºç»´æŠ¤å’Œå°è£…ï¼Œå¯¹åè®®åˆ©ç”¨åå°„æ¥ç»Ÿä¸€å°åŒ…å’Œè§£åŒ… åˆ©ç”¨åç¨‹æ¥å®ç°å•ä¸ªè¿›ç¨‹ä¸­å¯¹å¼‚æ­¥é€»è¾‘å¤„ç† æä¾›äº† runtime çš„ rpc å‘½ä»¤ï¼Œå®æ—¶è·å– kafka æˆå‘˜è¿›ç¨‹å¯¹å†…éƒ¨æ•°æ®ï¼Œå®æ—¶æŸ¥çœ‹æ¶ˆè´¹æƒ…å†µ æä¾›äº† kafka å‘½ä»¤ï¼Œæ–¹ä¾¿è·å– kafka æœåŠ¡ç›¸å…³ä¿¡æ¯å’Œ kafka ç›¸å…³æ“ä½œ åœ¨æˆå‘˜è¿›ç¨‹æŒ‚æ‰çš„æƒ…å†µä¸‹ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè‡ªåŠ¨æ‹‰èµ·ã€‚ å¯¹äºå¸¸é©»è¿›ç¨‹ï¼Œä¸æ’é™¤ä¸šåŠ¡é€»è¾‘å†™å‡ºäº†å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œæ‰€ä»¥æ‰€æœ‰çš„å­è¿›ç¨‹éƒ½å¸¦æœ‰å†…å­˜ä¸´ç•Œå€¼é‡å¯æœºåˆ¶æ¥é‡Šæ”¾å†…å­˜ ä¸»è¿›ç¨‹é€€å‡ºçš„æƒ…å†µä¸‹ï¼Œå‘èµ·äº†ç¦»å¼€æ¶ˆè´¹è€…ç»„çš„è¯·æ±‚ï¼Œä½¿å¾— kafka èƒ½å¿«é€Ÿå“åº”æ¶ˆè´¹è€…ç»„æœ€æ–°çŠ¶æ€ï¼Œä»è€Œæ›´å¥½å¹³æ»‘é‡æ–°åŠ å…¥æ¶ˆè´¹è€…","text":"å‰è¨€ç›®å‰ kafka å®¢æˆ·ç«¯åœ¨ php ä¸­æ¯”è¾ƒå‡ºåçš„ä»…æœ‰ 2 ä¸ªï¼Œè¿™ 2 ä¸ªé¡¹ç›®éƒ½æœ‰å„è‡ªçš„åˆ©å¼Šã€‚åœ¨è¿™é‡Œæˆ‘é€‰æ‹©å‡ ä¸ªæ¥åˆ—ä¸€ä¸‹ weiboad/kafka-php åè®®éç»“æ„åŒ–å°è£…ï¼Œè‡ªå®šä¹‰æ€§è¾ƒå¼ºï¼Œä¸å¥½ç»´æŠ¤ ç›®å‰çš„ API åœ¨æ¶ˆè´¹è€…ä¸­ç”±äºå•ä¾‹è®¾è®¡çš„åŸå› ï¼Œä¸å…è®¸åœ¨æ¶ˆè´¹è€…ä¸­ç”Ÿäº§æ¶ˆæ¯ ä¸æ”¯æŒå¤šç§å‹ç¼©åè®® å•è¿›ç¨‹â€œåç¨‹å¼â€é€»è¾‘ï¼Œæ•°æ®æœªå®ç°åˆ†ç¦»ï¼Œå®¹æ˜“å µå¡æ¶ˆè´¹ arnaud-lb/php-rdkafka åè®®éç»“æ„åŒ–å°è£…ï¼Œè‡ªå®šä¹‰æ€§è¾ƒå¼ºï¼Œä¸å¥½ç»´æŠ¤ ä¸æ”¯æŒå¤šç§å‹ç¼©åè®® åˆ©ç”¨å¤šçº¿ç¨‹ï¼Œä½†æ˜¯ PHP å¯¹å¤šçº¿ç¨‹å¯¹æ”¯æŒå¹¶ä¸å‹å¥½ï¼Œç›¸å¯¹äºç”¨ swoole è€Œè¨€ï¼ŒåŠ£åŠ¿è¾ƒä¸ºæ˜æ˜¾ï¼Œå®¹æ˜“å‡º bugï¼Œä¸”ç»´æŠ¤æ€§ä¸é«˜ åŸºäºä»¥ä¸Šå‡ ç‚¹ï¼Œæˆ‘ä»¬åœ¨åŸºäºswoole-4.3ä»¥ä¸Šé‡æ–°å¼€å‘äº†kafka-swooleé¡¹ç›®ï¼Œä¼˜ç‚¹å¦‚ä¸‹ï¼š å¤šè¿›ç¨‹å¤šæ ¸å¤„ç† æ”¯æŒ kafka å¤šä¸ª sink æ–¹å¼ï¼Œå®ç°æ‹‰å– kafka æ•°æ®å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œä»è€Œä¸å µå¡æ•°æ®æ‹‰å– é¦–ä¸ªæ”¯æŒå¤šç§å‹ç¼©æ–¹å¼ï¼ˆnormal(ä¸å‹ç¼©)/gzip/snappyï¼‰çš„ php å®¢æˆ·ç«¯ï¼Œä»è€Œåœ¨å¤§ååå¯¹æƒ…å†µä¸‹å‡å°‘å¸¦å®½å ç”¨ï¼Œæé«˜ä¼ è¾“é€Ÿç‡ åè®®å°è£…é‡‡ç”¨ OOP çš„æ–¹å¼ï¼Œç»“æ„åŒ–äº†åè®®çš„å°è£…ï¼Œåˆ©äºç»´æŠ¤å’Œå°è£…ï¼Œå¯¹åè®®åˆ©ç”¨åå°„æ¥ç»Ÿä¸€å°åŒ…å’Œè§£åŒ… åˆ©ç”¨åç¨‹æ¥å®ç°å•ä¸ªè¿›ç¨‹ä¸­å¯¹å¼‚æ­¥é€»è¾‘å¤„ç† æä¾›äº† runtime çš„ rpc å‘½ä»¤ï¼Œå®æ—¶è·å– kafka æˆå‘˜è¿›ç¨‹å¯¹å†…éƒ¨æ•°æ®ï¼Œå®æ—¶æŸ¥çœ‹æ¶ˆè´¹æƒ…å†µ æä¾›äº† kafka å‘½ä»¤ï¼Œæ–¹ä¾¿è·å– kafka æœåŠ¡ç›¸å…³ä¿¡æ¯å’Œ kafka ç›¸å…³æ“ä½œ åœ¨æˆå‘˜è¿›ç¨‹æŒ‚æ‰çš„æƒ…å†µä¸‹ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè‡ªåŠ¨æ‹‰èµ·ã€‚ å¯¹äºå¸¸é©»è¿›ç¨‹ï¼Œä¸æ’é™¤ä¸šåŠ¡é€»è¾‘å†™å‡ºäº†å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œæ‰€ä»¥æ‰€æœ‰çš„å­è¿›ç¨‹éƒ½å¸¦æœ‰å†…å­˜ä¸´ç•Œå€¼é‡å¯æœºåˆ¶æ¥é‡Šæ”¾å†…å­˜ ä¸»è¿›ç¨‹é€€å‡ºçš„æƒ…å†µä¸‹ï¼Œå‘èµ·äº†ç¦»å¼€æ¶ˆè´¹è€…ç»„çš„è¯·æ±‚ï¼Œä½¿å¾— kafka èƒ½å¿«é€Ÿå“åº”æ¶ˆè´¹è€…ç»„æœ€æ–°çŠ¶æ€ï¼Œä»è€Œæ›´å¥½å¹³æ»‘é‡æ–°åŠ å…¥æ¶ˆè´¹è€… æœåŠ¡æ¶æ„ kafka-swoole çš„å¤§ä½“æ¶æ„å›¾å¦‚ä¸Šï¼Œå¯ä»¥ç¬¼ç»Ÿçš„æ¦‚æ‹¬ä¸º 2 ä¸ªéƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«çš„ kafka-client å’Œconsumer/sinkerã€‚ kafka-clientä¸»è¦æ˜¯è´Ÿè´£ä» kafka æœåŠ¡ä¸­æ‹‰å–æ•°æ®ï¼Œconsumer/sinkerä¸»è¦è´Ÿè´£æ¶ˆè´¹æ•°æ®ã€‚ consumerå’Œsinker çš„åŒºåˆ«åœ¨äºï¼Œæ•°æ®æ˜¯å¦ç»è¿‡äº†ä¸­é—´å­˜å‚¨ä»‹è´¨ï¼Œå¦‚æœä¸ç»è¿‡ä¸­é—´å­˜å‚¨ä»‹è´¨çš„è¯ï¼Œé‚£ä¹ˆå°±æ˜¯consumerï¼Œå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥ä¼šåœ¨é…ç½®è¯´åˆ°çš„KAFKA_MESSAGE_STORAGE=Directlyï¼Œè¿™ä¹Ÿå°†ä¼šæ˜¯æˆ‘ä»¬æ˜¯å¦å¯ç”¨é¢å¤–çš„ sinker è¿›ç¨‹çš„å…³é”®æ‰€åœ¨ï¼Œå¦‚æœå®ƒè¢«é€‰æ‹©ä¹‹åï¼Œclient å’Œæ¶ˆè´¹è€…å°†ä¼šåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­å¤„ç†ï¼Œæ‰€ä»¥å¦‚æœä½ çš„ä¸šåŠ¡é€»è¾‘æ¯”è¾ƒè€—æ—¶çš„è¯ï¼ŒåŠ¿å¿…ä¼šå½±å“æ•°æ®æ‹‰å–é€Ÿåº¦ã€‚å¦‚æœé‡‡ç”¨ä¸­é—´å­˜å‚¨ä»‹è´¨çš„è¯ï¼Œé‚£ä¹ˆç›®å‰æ”¯æŒ 2 ç§å­˜å‚¨ä»‹è´¨ï¼Œåˆ†åˆ«æ˜¯Redis,Fileã€‚ç›®å‰æ¥è¯´æ›´åŠ æ¨èé‡‡ç”¨Redisçš„æ–¹å¼ï¼Œè™½ç„¶å€ŸåŠ©äº†ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œä½†æ˜¯å®ƒåœ¨å…¶ä»–å„ä¸ªæ–¹é¢éƒ½æ¯” File å¥½ï¼Œå°±ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœç”¨ File ä½œä¸ºå­˜å‚¨ä»‹è´¨çš„è¯ï¼ŒFile çš„è¯è¿˜éœ€è¦è‡ªå·±åšç£ç›˜å¤‡ä»½æ¥ä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚ runtime çš„ rpc å‘½ä»¤çš„å®ç°ç»†èŠ‚æœ¬é¡¹ç›®ä¸­ï¼Œæ‰€è°“çš„ rpc çš„å‘½åï¼Œä¸»è¦æ˜¯ç”±ä¸»è¿›ç¨‹æƒ³ kafka-client è¿›ç¨‹å‘èµ· rpc è¯·æ±‚çš„è¡Œä¸ºã€‚ç”¨äºè·å– kakfa-client å®æ—¶çŠ¶å†µè€Œå­˜åœ¨çš„ä¸€ç§æ–¹å¼ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å®ç°è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œè¿™é‡Œçš„é€‰å‹ï¼Œæˆ‘ä»¬é€‰æ‹©é€‰æ‹©äº†AF_UNIXçš„æ–¹å¼æ¥è¿›è¡Œé€šä¿¡ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ç«¯å£æœåŠ¡çš„æ–¹å¼ï¼Œæ˜¯å› ä¸ºï¼Œæˆ‘ä»¬çš„ rpc è¯·æ±‚ä¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œå¹¶ä¸”æ˜¯é’ˆå¯¹æœ¬é¡¹ç›®ï¼Œå¹¶ä¸”AF_UNIXä¹Ÿè®©æˆ‘ä»¬é€šä¿¡æ›´åŠ é«˜æ•ˆã€‚ ç”±äºæˆ‘ä»¬è¿™é‡Œéœ€è¦å®ç°ä¸‰æ–¹é€šä¿¡ï¼Œæ‰€æœ‰å‘èµ·è¯·æ±‚çš„å‘½ä»¤ç‹¬å ä¸€ä¸ªUNIX_FILEï¼Œæˆ‘ä»¬ä¸»è¿›ç¨‹å ä¸€ä¸ªUNIX_FILEï¼Œæ¯ä¸ª kafka-client åŒæ ·å ä¸€ä¸ªUNIX_FILEï¼Œå®ç°ä¸‰æ–¹é€šä¿¡ã€‚ rpc åè®®åè®®æœ¬èº«ååˆ†ç®€å•ï¼Œåè®®å¤´æœ‰ 4 ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•´å½¢å°åŒ…åè®®ä¸»ä½“çš„é•¿åº¦ï¼Œåè®®ä¸»ä½“æ˜¯ç”±role,rpc,methodä¸€èµ·ç»„æˆçš„ json_encode åçš„å­—ç¬¦ä¸²ã€‚ 1234567$cmd = [ 'role' =&gt; $external, 'rpc' =&gt; $rpc, 'method' =&gt; $method, ];$data = json_encode($cmd);$package = pack('N', strlen($data)) . $data; å¤„ç†æµç¨‹åœ¨ core é¡¹ç›® src/RPCä¸­ï¼Œæ˜¯æˆ‘ä»¬çš„æ‰€æœ‰çš„ RPC æœåŠ¡å¤„ç†ç±»ï¼Œç±»æœ‰ 2 ç§ç±»å‹çš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯getXxxå’ŒonXxxï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äº getXxxï¼šå„ä¸ª kafka-client è¿›ç¨‹å¤„ç†è¯¥ RPC è¯·æ±‚å¤„ç†çš„é€»è¾‘ onXxxï¼šè´Ÿè´£ä¸»è¿›ç¨‹èŠ‚å¥å„ä¸ª kafka-client è¿›ç¨‹å¤„ç†åçš„ç»“æœï¼Œè¿›è¡Œæ±‡æ€»å¤„ç† sinker ç›¸å…³çš„å†…å®¹å½“æˆ‘ä»¬ä½¿ç”¨kafka-swooleé¡¹ç›®çš„æ—¶å€™ï¼Œè¦å¦‚ä½•ä½¿ç”¨å‘¢ï¼Œå…¶å®ä¸šåŠ¡æ–¹å¹¶ä¸éœ€è¦è¿‡å¤šçš„å…³æ³¨ kafka-client çš„ç»†èŠ‚ï¼Œå› ä¸ºå®ƒçš„ä½œç”¨ä»…ä»…æ˜¯æ‹‰å–æ•°æ®åˆ°å­˜å‚¨ä»‹è´¨ï¼Œæˆ‘ä»¬å†™ä¸šåŠ¡çš„æ—¶å€™ï¼Œå…¶å®ä¸»è¦éƒ½æ˜¯åœ¨sinkerä¸­å†™ä¸šåŠ¡ã€‚ æˆ‘ä»¬åœ¨ app/Controllerä¸­æœ‰ä¸€ä¸ªSinkerControllerï¼Œé‡Œé¢çš„hanlder(array $messages)å°±æ˜¯æ¥æ”¶ä»å­˜å‚¨ä»‹è´¨ä¸­è¯»å–å›æ¥çš„æ•°æ®ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»å­˜å‚¨ä»‹è´¨ä¸­æ‹‰å–å‡ºæ¥çš„æ—¶å€™æ˜¯å¦è¢«æ¶ˆè´¹è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œä¸ç®¡æ˜¯Redisè¿˜æ˜¯Fileï¼Œéƒ½æ²¡æœ‰è‡ªå¸¦çš„ä¸€ä¸ªackæœºåˆ¶è®©æˆ‘ä»¬ä¿è¯æ•°æ®æ­£ç¡®è¢«æ¶ˆè´¹äº†ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿‚å›å¾—å®ç°äº†è¿™ä¸ªæ–¹å¼ï¼Œåˆ©ç”¨çš„å°±æ˜¯ redis çš„å¯é æ€§é˜Ÿåˆ—ã€‚ é€šè¿‡ä¸Šå›¾æ‰€ç¤ºçš„æ–¹å¼ï¼Œæˆ‘ä»¬çš„ ack æœºåˆ¶é€šè¿‡ä¸šåŠ¡æ–¹æ¥ç¡®è®¤ï¼Œæ‰€ä»¥ï¼Œè¯¥æ–¹æ³•çš„è¿”å›ç»“æœä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸‹æ ‡å¯¹åº”æ¯æ¡æ¶ˆæ¯çš„çŠ¶æ€ï¼Œå½“çŠ¶æ€ä¸ºtrueçš„æ—¶å€™ä»£è¡¨è¢«é¡ºåˆ©æ¶ˆè´¹äº†ï¼Œæ¶ˆæ¯ä¼šåœ¨ processingçš„é˜Ÿåˆ—ä¸­è¢«ç§»é™¤ï¼Œå¦‚æœè¢«æ ‡è®°ä¸ºäº†falseï¼Œé‚£ä¹ˆæ¶ˆæ¯å°†ä¸ä¼šè¢«ç§»é™¤ï¼Œå¯¹äºå¤±è´¥çš„æ¶ˆæ¯ï¼Œç›®å‰æˆ‘ä»¬å¹¶æ²¡æœ‰åšä»»ä½•çš„å¤„ç†ï¼Œå› ä¸ºå¯¹äºéƒ¨åˆ†æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯é‡è¯•çš„æƒ…å†µï¼Œéƒ¨åˆ†æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯çœŸçš„é”™è¯¯çš„æƒ…å†µã€‚å› æ­¤è¿™éƒ¨åˆ†æ¶ˆæ¯å¦‚æœé‡æ–°æ¶ˆè´¹çš„è¯ï¼Œéœ€è¦ä¸šåŠ¡æ–¹ç¡®è®¤ï¼Œå¹¶ä¸”é€šè¿‡å‘½ä»¤æ¥æŠŠæ•°æ®æ‹‰å›åˆ°pendingé˜Ÿåˆ—ä¸­æ¥å®ç°é‡æ–°æ¶ˆè´¹çš„æƒ…å†µã€‚å¦‚æœæ˜¯é”™è¯¯çš„è¯ï¼Œå°±éœ€è¦é€šè¿‡å‘½ä»¤æ¥æ¸…ç©ºé˜Ÿåˆ—ã€‚ kafka ç›¸å…³çš„å‘½ä»¤çš„æä¾›12345678910111213141516171819202122php bin/kafka-clientConsole ToolUsage: command [options] [arguments]Options: -h, --help Display this help message -q, --quiet Do not output any message -V, --version Display this application version --ansi Force ANSI output --no-ansi Disable ANSI output -n, --no-interaction Do not ask any interactive question -v|vv|vvv, --verbose Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debugAvailable commands: help Displays help for a command kafka.describeGroups See consumer group details kafka.produce Send a message list Lists commands rpc Built-in runtime RPC command start Start Kafka-Swoole å¸¦æœ‰ kafka å‰ç¼€çš„å‘½ä»¤ï¼Œéƒ½æ˜¯ç›´æ¥è¯·æ±‚ kafka ç›¸å…³çš„ API çš„å‘½ä»¤ã€‚ kafka.describeGroupsç”¨äºæŸ¥è¯¢æŸä¸ªæ¶ˆè´¹è€…ç»„è®¢é˜…çš„ topic çš„è¯¦æƒ… 1234567891011121314151617181920php bin/kafka-client kafka.describeGroups -hDescription: See consumer group detailsUsage: kafka.describeGroups [options]Options: -t, --topic=TOPIC Which topic is subscribed by the consumer group? -g, --group=GROUP Which consumer group? -h, --help Display this help message -q, --quiet Do not output any message -V, --version Display this application version --ansi Force ANSI output --no-ansi Disable ANSI output -n, --no-interaction Do not ask any interactive question -v|vv|vvv, --verbose Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debugHelp: See consumer group details... ä¾‹å­å¦‚ä¸‹å›¾ï¼š 12345678910111213141516171819202122php bin/kafka-client kafka.describeGroups -t mulog_clean_24 -g kafka-swooleDescribeGruops-BaseInfo======================= -------------- ------------ -------------- -------------- groupId groupState protocolType protocolData -------------- ------------ -------------- -------------- kafka-swoole Stable consumer Range -------------- ------------ -------------- -------------- --------------------------------------------------- -------------- -------------- ---------------- ----------- memberId clientId clientHost topcic paritions --------------------------------------------------- -------------- -------------- ---------------- ----------- kafka-swoole-44857c49-b019-439b-90dd-d71112b2c01e kafka-swoole /192.167.8.2 mulog_clean_24 0,1 --------------------------------------------------- -------------- -------------- ---------------- ----------- --------------------------------------------------- -------------- -------------- ---------------- ----------- memberId clientId clientHost topcic paritions --------------------------------------------------- -------------- -------------- ---------------- ----------- kafka-swoole-5714cd77-a0dd-4d29-aa20-718f9d713908 kafka-swoole /192.167.8.2 mulog_clean_24 2,3 --------------------------------------------------- -------------- -------------- ---------------- ----------- kafka.produceç”¨äºç”Ÿäº§ä¸€æ¡æ¶ˆæ¯åˆ°æŸä¸ª topic ä¸­ï¼Œæ”¯æŒå¤šç§å‹ç¼©æ–¹å¼ï¼Œæ”¯æŒå¤šç§ç”Ÿäº§æ¶ˆæ¯ç­–ç•¥ ç”Ÿäº§è€… partition ç­–ç•¥ï¼š -p/--partition= é‡‡ç”¨æŒ‡å®š partition çš„ç­–ç•¥ -k/--key= é‡‡ç”¨é€šè¿‡ key çš„å“ˆå¸Œåˆ° partition ç­–ç•¥ ä»¥ä¸Šä¸¤ä¸ªéƒ½ä¸é€‰ï¼Œåˆ™é‡‡ç”¨ éšæœºå‘é€ partition ç­–ç•¥ ç”Ÿäº§è€…å‹ç¼©æ–¹å¼ï¼š -c/--compress= é‡‡ç”¨çš„å‹ç¼©æ–¹å¼ï¼š0=ä¸å‹ç¼©/1=é‡‡ç”¨ gzip å‹ç¼©/2=ä½¿ç”¨ snappy å‹ç¼©/3=ä½¿ç”¨ lz4 å‹ç¼© ä¸å¡«å†™ï¼Œåˆ™ä¸è¿›è¡Œå‹ç¼© 12345678910111213141516171819202122232425php bin/kafka-client kafka.produce --helpDescription: Send a messageUsage: kafka.produce [options] [--] &lt;message&gt;Arguments: message The message you wish to send.Options: -t, --topic[=TOPIC] Which is the topic you want to send? -p, --partition[=PARTITION] Which is the topic you want to send to partition? -k, --key[=KEY] Which is the topic you want to send to partition by key? -c, --compress[=COMPRESS] Which one do you want to compress: 0: normal 1:gzip 2:snappy 3:lz4 -h, --help Display this help message -q, --quiet Do not output any message -V, --version Display this application version --ansi Force ANSI output --no-ansi Disable ANSI output -n, --no-interaction Do not ask any interactive question -v|vv|vvv, --verbose Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debugHelp: This command will help you send separate messages to a topic... ä¾‹å­å¦‚ä¸‹å›¾ï¼š 123456789101112131415161718192021222324252627282930php bin/kafka-client kafka.produce -t test_topic_A -- 'This is my test'array(3) &#123; [\"responses\"]=&gt; array(1) &#123; [0]=&gt; array(2) &#123; [\"topic\"]=&gt; string(12) \"test_topic_A\" [\"partition_responses\"]=&gt; array(1) &#123; [0]=&gt; array(3) &#123; [\"partition\"]=&gt; int(0) [\"errorCode\"]=&gt; int(0) [\"baseOffset\"]=&gt; int(0) &#125; &#125; &#125; &#125; [\"responseHeader\"]=&gt; array(1) &#123; [\"correlationId\"]=&gt; int(0) &#125; [\"size\"]=&gt; int(40)&#125; ç›®å‰è¾“å‡ºæ–¹å¼å¹¶æ²¡æœ‰ä¼˜åŒ–ï¼Œåç»­è¿›è¡Œè¾“å‡ºæ ·å¼ä¼˜åŒ– rpcæä¾›å®æ—¶è·å– kafka-client æˆå‘˜çš„å†…éƒ¨æƒ…å†µ 123456789101112131415161718192021222324252627php bin/kafka-client rpc -hDescription: Built-in runtime RPC commandUsage: rpc &lt;type&gt;Arguments: type which you want to execute command?Options: -h, --help Display this help message -q, --quiet Do not output any message -V, --version Display this application version --ansi Force ANSI output --no-ansi Disable ANSI output -n, --no-interaction Do not ask any interactive question -v|vv|vvv, --verbose Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debugHelp: The following are the built-in RPC command optionsï¼š kafka_lag offset_checker block_size member_leader metadata_brokers metadata_topics ä¾‹å­å¦‚ä¸‹å›¾ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849php bin/kafka-client rpc kafka_lag1000php bin/kafka-client rpc offset_checker -------------- ----------- ---------------- ------------------ ----------------- topic partition current-offset kafka-max-offset remaining-count -------------- ----------- ---------------- ------------------ ----------------- kafka-swoole 2 50223 50223 0 kafka-swoole 3 70353 70353 0 kafka-swoole 0 52395 52395 0 kafka-swoole 1 50407 50407 0 -------------- ----------- ---------------- ------------------ -----------------php bin/kafka-client rpc block_size254php bin/kafka-client rpc member_leader --------------------------------------------------- consumer-group-leaderId --------------------------------------------------- kafka-swoole-da43c9a0-b12d-46df-9941-ee80456ec9a2 --------------------------------------------------- --------------------------------------------------- consumer-group-membersId --------------------------------------------------- kafka-swoole-6080eb8e-3bfb-4be0-a923-037bb99a2666 kafka-swoole-da43c9a0-b12d-46df-9941-ee80456ec9a2 --------------------------------------------------- php bin/kafka-client rpc metadata_brokers --------- --------- ------ node-id host port --------- --------- ------ 1003 mkafka3 9092 1004 mkafka4 9092 1001 mkafka1 9092 1002 mkafka2 9092 --------- --------- ------ php bin/kafka-client rpc metadata_topics -------------- ----------- ----------- --------------- ----------- topic partition leader-id replica-nodes isr-nodes -------------- ----------- ----------- --------------- ----------- kafka-swoole 2 1001 1001,1004 1001,1004 kafka-swoole 1 1004 1004,1003 1004,1003 kafka-swoole 3 1002 1002,1001 1002,1001 kafka-swoole 0 1003 1003,1002 1002,1003 -------------- ----------- ----------- --------------- ----------- kafka å®¢æˆ·ç«¯å¯åŠ¨åˆ°æ‹‰å–æ•°æ®æµç¨‹ä»¥ä¸‹åˆ—å‡ºæ‰€æœ‰çš„å¿…å¤‡è¯·æ±‚ï¼Œåˆ°Fetchè¯·æ±‚ä½ç½®ï¼Œéƒ½æ˜¯åŒæ­¥è¯·æ±‚ï¼ŒOffsetCommitå’ŒHeartBeatéƒ½æ˜¯åˆ†å¼€çš„ç‹¬ç«‹è¯·æ±‚ Metadata è·å–å…ƒæ•°æ®ä¿¡æ¯ FindCoordinator è®© kafka åˆ†é…æ¶ˆè´¹è€…ç»„åè°ƒå™¨å…¥å£ JoinGroup å‘Šè¯‰ kafka å½“å‰ kafka-client éœ€è¦åŠ å…¥æ¶ˆè´¹è€…ç»„ SyncGroup åŒæ­¥æ¶ˆè´¹è€…ç»„æ¶ˆæ¯ï¼ˆå¦‚æœå‘èµ·è¯·æ±‚çš„æ˜¯ leader çš„è¯ï¼Œåˆ™éœ€è¦å¸¦ä¸Šæ‰€æœ‰æ¶ˆè´¹è€…ç»„æˆå‘˜æ‰€éœ€è¦è®¢é˜… topic å’Œ partition çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ç”± leader åˆ†é…ï¼‰ ListsOffsets è·å–å½“å‰ topic åœ¨ kafka/zookeeper ä¸­å­˜å‚¨çš„ offset çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ OffsetFetch è·å–å½“å‰æ¶ˆè´¹è€…ç»„åœ¨ kafka/zookeeper ä¸­å­˜å‚¨çš„ offset çš„å€¼ Fetch æ‹‰å–æ•°æ® OffsetCommit æäº¤å½“å‰æ¶ˆè´¹è€…ç»„å¤„ç†åˆ°çš„ offset HeartBeat \b å¿ƒè·³è¯·æ±‚ Rebalance æµç¨‹å‘é€åŠ å…¥ç»„è¯·æ±‚ï¼ˆRebalance æµç¨‹ï¼‰æ¶ˆè´¹è€…é¦–æ¬¡åŠ å…¥ group ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ Rebalance çš„ä¸€ç§ï¼Œå…¶ä¸­åŒ…å«äº†ä¸¤ç±»è¯·æ±‚ï¼šJoinGroup å’Œ SyncGroup è¯·æ±‚ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸¤æ¬¡è¯·æ±‚çš„æµç¨‹ï¼š å½“ç»„å†…æˆå‘˜åŠ å…¥ group æ—¶ï¼Œå®ƒä¼šå‘åè°ƒè€…å‘é€ä¸€ä¸ª JoinGroup è¯·æ±‚ã€‚è¯·æ±‚ä¸­ä¼šå°†è‡ªå·±è¦è®¢é˜…çš„ Topic ä¸ŠæŠ¥ï¼Œè¿™æ ·åè°ƒè€…å°±å¯ä»¥æ”¶é›†åˆ°æ‰€æœ‰æˆå‘˜çš„è®¢é˜…ä¿¡æ¯ã€‚æ”¶é›†å®Œè®¢é˜…ä¿¡æ¯ä¹‹åï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªå‘é€ JoinGroup è¯·æ±‚çš„æˆå‘˜å°†ä¼šè‡ªåŠ¨ç§°ä¸º Leaderã€‚æ‰€æœ‰åæ£‰å…¶ä»–æˆå‘˜åŠ å…¥çš„æ—¶å€™ï¼Œå°±å‘ç”Ÿäº† Rebalance çš„æƒ…å†µäº†ã€‚ æ–°æˆå‘˜å…¥ç»„ ç»„æˆå‘˜ä¸»åŠ¨ç¦»ç»„ ç»„æˆå‘˜å´©æºƒç¦»ç»„ Rebalance æ—¶ç»„å†…æˆå‘˜éœ€è¦æäº¤ offset Consumer åˆ†åŒºåˆ†é…ç­–ç•¥RangeAssignorRangeAssignor æ˜¯æŒ‰ç…§ Topic çš„ç»´åº¦è¿›è¡Œåˆ†é…çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‰ç…§ Topic å¯¹åº”çš„æ¯ä¸ªåˆ†åŒºå¹³å‡çš„æŒ‰ç…§èŒƒå›´åŒºæ®µåˆ†é…ç»™ Consumer å®ä¾‹ã€‚è¿™ç§åˆ†é…æ–¹æ¡ˆæ˜¯æŒ‰ç…§ Topic çš„ç»´åº¦å»åˆ†å‘åˆ†åŒºçš„ï¼Œæ­¤æ—¶å¯èƒ½ä¼šé€ æˆå…ˆåˆ†é…åˆ†åŒºçš„ Consumer å®ä¾‹çš„ä»»åŠ¡è¿‡é‡ã€‚ ä»ä¸Šå›¾çš„æœ€ç»ˆåˆ†é…ç»“æœçœ‹æ¥ï¼Œå› ä¸ºæ˜¯æŒ‰ç…§ Topic A å’Œ Topic B çš„ç»´åº¦è¿›è¡Œåˆ†é…çš„ã€‚å¯¹äº Topic A è€Œè¨€ï¼Œæœ‰ 2 ä¸ªæ¶ˆè´¹è€…ï¼Œæ­¤æ—¶ç®—å‡ºæ¥ C0 å¾—åˆ° 2 ä¸ªåˆ†åŒºï¼ŒC1 å¾—åˆ° 1 ä¸ªåˆ†åŒºï¼›å¯¹äº Topic B çš„ç»´åº¦ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯å…ˆåˆ†é…çš„ Consumer ä¼šå¾—åˆ°çš„æ›´å¤šï¼Œä»è€Œé€ æˆå€¾æ–œã€‚éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼ŒRangeAssignor æ˜¯æŒ‰ç…§èŒƒå›´æˆªæ–­åˆ†é…çš„ï¼Œä¸æ˜¯æŒ‰é¡ºåºåˆ†å‘çš„ã€‚ RoundRobinAssignorRoundRobinAssignor ä¸­æ–‡å¯ä»¥ç¿»è¯‘ä¸ºè½®è¯¢ï¼Œä¹Ÿå°±æ˜¯é¡ºåºä¸€ä¸ªä¸€ä¸ªçš„åˆ†å‘ã€‚å…¶ä¸­ä»£ç é‡Œé¢çš„å¤§æ¦‚é€»è¾‘å¦‚ä¸‹ï¼šæ‹¿åˆ°ç»„å†…æ‰€æœ‰ Consumer è®¢é˜…çš„ TopicPartitionï¼ŒæŒ‰ç…§é¡ºåºæŒ¨ä¸ªåˆ†å‘ç»™ Consumerï¼Œæ­¤æ—¶å¦‚æœå’Œå½“å‰ Consumer æ²¡æœ‰è®¢é˜…å…³ç³»ï¼Œåˆ™å¯»æ‰¾ä¸‹ä¸€ä¸ª Consumerã€‚ä»ä¸Šé¢é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœç»„å†…æ¯ä¸ªæ¶ˆè´¹è€…çš„è®¢é˜…å…³ç³»æ˜¯åŒæ ·çš„ï¼Œè¿™æ · TopicPartition çš„åˆ†é…æ˜¯å‡åŒ€çš„ã€‚ å½“ç»„å†…æ¯ä¸ªæ¶ˆè´¹è€…è®¢é˜…çš„ Topic æ˜¯ä¸åŒçš„ï¼Œè¿™æ ·å°±å¯èƒ½ä¼šé€ æˆåˆ†åŒºè®¢é˜…çš„å€¾æ–œã€‚ StickyAssignorStickyAssignor æ˜¯ Kafka Java å®¢æˆ·ç«¯æä¾›çš„ 3 ä¸­åˆ†é…ç­–ç•¥ä¸­æœ€å¤æ‚çš„ä¸€ç§ï¼Œä»å­—é¢ä¸Šå¯ä»¥çœ‹å‡ºæ˜¯å…·æœ‰â€œç²˜æ€§â€çš„åˆ†åŒºç­–ç•¥ã€‚Kafka ä» 0.11 ç‰ˆæœ¬å¼€å§‹å¼•å…¥ï¼Œå…¶ä¸»è¦å®ç°äº†ä¸¤ä¸ªåŠŸèƒ½ï¼š 1ã€ä¸»é¢˜åˆ†åŒºçš„åˆ†é…è¦å°½å¯èƒ½çš„å‡åŒ€ã€‚ 2ã€å½“ Rebalance å‘ç”Ÿæ—¶ï¼Œå°½å¯èƒ½ä¿æŒä¸Šä¸€æ¬¡çš„åˆ†é…æ–¹æ¡ˆã€‚ å½“ç„¶ï¼Œå½“ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶å‘ç”Ÿå†²çªæ˜¯ï¼Œç¬¬ä¸€ä¸ªæäº¤ä»¶è¦ä¼˜å…ˆäºç¬¬äºŒä¸ªæäº¤ï¼Œè¿™æ ·å¯ä»¥ä½¿åˆ†é…æ›´åŠ å‡åŒ€ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹å®˜æ–¹æä¾›çš„ 2 ä¸ªä¾‹å­ï¼Œæ¥çœ‹ä¸€ä¸‹ RoundRoubin å’Œ Sticky ä¸¤è€…çš„åŒºåˆ«ã€‚ ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåˆå§‹çŠ¶æ€å„ä¸ª Consumer è®¢é˜…æ˜¯ç›¸åŒçš„æ—¶å€™ï¼Œå¹¶ä¸”ä¸»é¢˜çš„åˆ†åŒºæ•°ä¹Ÿæ˜¯å¹³å‡çš„æ—¶å€™ï¼Œä¸¤ç§åˆ†é…æ–¹æ¡ˆçš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚ä½†æ˜¯å½“ Rebalance å‘ç”Ÿæ—¶ï¼Œå¯èƒ½å°±ä¼šä¸å¤ªç›¸åŒäº†ï¼ŒåŠ å…¥ä¸Šé¢çš„ C1 å‘ç”Ÿäº†ç¦»ç»„æ“ä½œï¼Œæ­¤æ—¶åˆ†åˆ«ä¼šæœ‰ä¸‹é¢çš„ Rebalance ç»“æœï¼š ä»ä¸Šé¢ Rebalance åçš„ç»“æœå¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶ä¸¤è€…æœ€ååˆ†é…éƒ½æ˜¯å‡åŒ€çš„ï¼Œä½†æ˜¯ RoundRoubin å®Œå…¨æ˜¯é‡æ–°åˆ†é…äº†ä¸€éï¼Œè€Œ Sticky åˆ™æ˜¯åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šè¾¾åˆ°äº†å‡åŒ€çš„çŠ¶æ€ã€‚ ä¸‹é¢æˆ‘ä»¬å†çœ‹ä¸€ä¸ª Consumer è®¢é˜…ä¸»é¢˜ä¸å‡åŒ€çš„ä¾‹å­ã€‚ ä»ä¸Šé¢çš„è®¢é˜…å…³ç³»å¯ä»¥çœ‹å‡ºï¼ŒConsumer çš„è®¢é˜…ä¸»é¢˜ä¸ªæ•°ä¸å‡åŒ€ï¼Œå¹¶ä¸”å„ä¸ªä¸»é¢˜çš„åˆ†åŒºæ•°ä¹Ÿæ˜¯ä¸ç›¸åŒçš„ã€‚æ­¤æ—¶ä¸¤ç§åˆ†é…æ–¹æ¡ˆçš„ç»“æœæœ‰äº†è¾ƒå¤§çš„å·®å¼‚ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´ Sticky æ–¹å¼çš„åˆ†é…ç›¸å¯¹æ¥è¯´æ˜¯æœ€åˆç†çš„ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ C1 å‘ç”Ÿç¦»ç»„æ—¶ï¼ŒRebalance ä¹‹åçš„åˆ†é…ç»“æœã€‚ ä»ä¸Šé¢ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒRoundRoubin çš„æ–¹æ¡ˆåœ¨ Rebalance ä¹‹åé€ æˆäº†ä¸¥é‡çš„åˆ†é…å€¾æ–œã€‚å› æ­¤åœ¨ç”Ÿäº§ä¸Šå¦‚æœæƒ³è¦å‡å°‘ Rebalance çš„å¼€é”€ï¼Œå¯ä»¥é€‰ç”¨ Sticky çš„åˆ†åŒºåˆ†é…ç­–ç•¥ã€‚ åè®®å°è£…ç»†èŠ‚è§„åˆ™å®˜æ–¹åè®®è¯´æ˜é“¾æ¥ï¼šApache-kafka-protocoléå®˜æ–¹åè®®è¯´æ˜é“¾æ¥ï¼šéå®˜æ–¹åè®®è¯´æ˜ é¡¹ç›®ä¸­åè®®çš„å°è£…åœ¨æˆ‘ä»¬çš„ core é¡¹ç›®ä¸­çš„src/Protocolé‡Œé¢ã€‚æ•´ä¸ªæ ‘å½¢å›¾å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120rpc/Protocolâ”œâ”€â”€ AbstractRequest.phpâ”œâ”€â”€ AbstractRequestOrResponse.phpâ”œâ”€â”€ AbstractResponse.phpâ”œâ”€â”€ CommonRequest.phpâ”œâ”€â”€ CommonResponse.phpâ”œâ”€â”€ Requestâ”‚ â”œâ”€â”€ Commonâ”‚ â”‚ â””â”€â”€ RequestHeader.phpâ”‚ â”œâ”€â”€ CreateTopicsâ”‚ â”‚ â”œâ”€â”€ AssignmentsCreateTopics.phpâ”‚ â”‚ â”œâ”€â”€ ConfigsCreateTopics.phpâ”‚ â”‚ â””â”€â”€ TopicsCreateTopics.phpâ”‚ â”œâ”€â”€ CreateTopicsRequest.phpâ”‚ â”œâ”€â”€ DescribeGroupsRequest.phpâ”‚ â”œâ”€â”€ Fetchâ”‚ â”‚ â”œâ”€â”€ PartitionsFetch.phpâ”‚ â”‚ â””â”€â”€ TopicsFetch.phpâ”‚ â”œâ”€â”€ FetchRequest.phpâ”‚ â”œâ”€â”€ FindCoordinatorRequest.phpâ”‚ â”œâ”€â”€ HeartbeatRequest.phpâ”‚ â”œâ”€â”€ JoinGroupâ”‚ â”‚ â”œâ”€â”€ ProtocolMetadataJoinGroup.phpâ”‚ â”‚ â”œâ”€â”€ ProtocolNameJoinGroup.phpâ”‚ â”‚ â”œâ”€â”€ ProtocolsJoinGroup.phpâ”‚ â”‚ â””â”€â”€ TopicJoinGroup.phpâ”‚ â”œâ”€â”€ JoinGroupRequest.phpâ”‚ â”œâ”€â”€ LeaveGroupRequest.phpâ”‚ â”œâ”€â”€ ListOffsetsâ”‚ â”‚ â”œâ”€â”€ PartitionsListsOffsets.phpâ”‚ â”‚ â””â”€â”€ TopicsListsOffsets.phpâ”‚ â”œâ”€â”€ ListOffsetsRequest.phpâ”‚ â”œâ”€â”€ Metadataâ”‚ â”‚ â””â”€â”€ TopicMetadata.phpâ”‚ â”œâ”€â”€ MetadataRequest.phpâ”‚ â”œâ”€â”€ OffsetCommitâ”‚ â”‚ â”œâ”€â”€ PartitionsOffsetCommit.phpâ”‚ â”‚ â””â”€â”€ TopicsOffsetCommit.phpâ”‚ â”œâ”€â”€ OffsetCommitRequest.phpâ”‚ â”œâ”€â”€ OffsetFetchâ”‚ â”‚ â”œâ”€â”€ PartitionsOffsetFetch.phpâ”‚ â”‚ â””â”€â”€ TopicsOffsetFetch.phpâ”‚ â”œâ”€â”€ OffsetFetchRequest.phpâ”‚ â”œâ”€â”€ Produceâ”‚ â”‚ â”œâ”€â”€ DataProduce.phpâ”‚ â”‚ â”œâ”€â”€ MessageProduce.phpâ”‚ â”‚ â”œâ”€â”€ MessageSetProduce.phpâ”‚ â”‚ â””â”€â”€ TopicDataProduce.phpâ”‚ â”œâ”€â”€ ProduceRequest.phpâ”‚ â”œâ”€â”€ SyncGroupâ”‚ â”‚ â”œâ”€â”€ AssignmentsSyncGroup.phpâ”‚ â”‚ â”œâ”€â”€ GroupAssignmentsSyncGroup.phpâ”‚ â”‚ â”œâ”€â”€ MemberAssignmentsSyncGroup.phpâ”‚ â”‚ â””â”€â”€ PartitionAssignmentsSyncGroup.phpâ”‚ â””â”€â”€ SyncGroupRequest.phpâ”œâ”€â”€ Responseâ”‚ â”œâ”€â”€ Commonâ”‚ â”‚ â””â”€â”€ ResponseHeader.phpâ”‚ â”œâ”€â”€ CreateTopicsâ”‚ â”‚ â””â”€â”€ TopicsCreateTopics.phpâ”‚ â”œâ”€â”€ CreateTopicsResponse.phpâ”‚ â”œâ”€â”€ DescribeGroupsâ”‚ â”‚ â”œâ”€â”€ GroupsDescribeGroups.phpâ”‚ â”‚ â”œâ”€â”€ MembersAssignmentDescribeGroups.phpâ”‚ â”‚ â”œâ”€â”€ MembersDescribeGroups.phpâ”‚ â”‚ â”œâ”€â”€ MembersMetadataDescribeGroups.phpâ”‚ â”‚ â””â”€â”€ PartitionsAssignmentDescribeGroups.phpâ”‚ â”œâ”€â”€ DescribeGroupsResponse.phpâ”‚ â”œâ”€â”€ Fetchâ”‚ â”‚ â”œâ”€â”€ MessageFetch.phpâ”‚ â”‚ â”œâ”€â”€ MessageSetFetch.phpâ”‚ â”‚ â”œâ”€â”€ PartitionHeaderFetch.phpâ”‚ â”‚ â”œâ”€â”€ PartitionResponsesFetch.phpâ”‚ â”‚ â””â”€â”€ ResponsesFetch.phpâ”‚ â”œâ”€â”€ FetchResponse.phpâ”‚ â”œâ”€â”€ FindCoordinatorResponse.phpâ”‚ â”œâ”€â”€ HeartbeatResponse.phpâ”‚ â”œâ”€â”€ JoinGroupâ”‚ â”‚ â”œâ”€â”€ MembersJoinGroup.phpâ”‚ â”‚ â”œâ”€â”€ ProtocolMetadataJoinGroup.phpâ”‚ â”‚ â””â”€â”€ TopicJoinGroup.phpâ”‚ â”œâ”€â”€ JoinGroupResponse.phpâ”‚ â”œâ”€â”€ LeaveGroupResponse.phpâ”‚ â”œâ”€â”€ ListOffsetsâ”‚ â”‚ â”œâ”€â”€ PartitionsResponsesListOffsets.phpâ”‚ â”‚ â””â”€â”€ ResponsesListOffsets.phpâ”‚ â”œâ”€â”€ ListOffsetsResponse.phpâ”‚ â”œâ”€â”€ Metadataâ”‚ â”‚ â”œâ”€â”€ BrokerMetadata.phpâ”‚ â”‚ â”œâ”€â”€ PartitionMetadata.phpâ”‚ â”‚ â””â”€â”€ TopicMetadata.phpâ”‚ â”œâ”€â”€ MetadataResponse.phpâ”‚ â”œâ”€â”€ OffsetCommitâ”‚ â”‚ â”œâ”€â”€ PartitionsOffsetCommit.phpâ”‚ â”‚ â””â”€â”€ TopicOffsetCommit.phpâ”‚ â”œâ”€â”€ OffsetCommitResponse.phpâ”‚ â”œâ”€â”€ OffsetFetchâ”‚ â”‚ â”œâ”€â”€ PartitionsResponsesOffsetFetch.phpâ”‚ â”‚ â””â”€â”€ ResponsesOffsetFetch.phpâ”‚ â”œâ”€â”€ OffsetFetchResponse.phpâ”‚ â”œâ”€â”€ Produceâ”‚ â”‚ â”œâ”€â”€ PartitionResponsesProduce.phpâ”‚ â”‚ â””â”€â”€ ResponsesProduce.phpâ”‚ â”œâ”€â”€ ProduceResponse.phpâ”‚ â”œâ”€â”€ SyncGroupâ”‚ â”‚ â”œâ”€â”€ MemberAssignmentsSyncGroup.phpâ”‚ â”‚ â””â”€â”€ PartitionAssignmentsSyncGroup.phpâ”‚ â””â”€â”€ SyncGroupResponse.phpâ”œâ”€â”€ TraitStructureâ”‚ â”œâ”€â”€ ToArrayTrait.phpâ”‚ â””â”€â”€ ValueTrait.phpâ””â”€â”€ Type â”œâ”€â”€ AbstractType.php â”œâ”€â”€ Arrays32.php â”œâ”€â”€ Bytes32.php â”œâ”€â”€ Int16.php â”œâ”€â”€ Int32.php â”œâ”€â”€ Int64.php â”œâ”€â”€ Int8.php â””â”€â”€ String16.php æˆ‘ä»¬å…ˆè¯´æ˜ä¸€ä¸‹ä»¥æ­¤ç›®å½•ä¸ºæ ¹ç›®å½•åˆ°æƒ…å†µä¸‹ï¼Œä¸€çº§æ–‡ä»¶ï¼ˆéç›®å½•ï¼‰çš„ä½œç”¨ï¼š AbstractRequestOrResponse.php (è¿™ä¸ªæ˜¯æ— è®ºæ˜¯ request è¿˜æ˜¯ response éƒ½å¿…é¡»æœ‰éƒ½å­—æ®µï¼šå­—èŠ‚é•¿åº¦) AbstractRequest.php (ç»§æ‰¿ AbstractRequestOrResponseï¼ŒåŒ…å«äº†è¯·æ±‚åè®®å¤´ï¼Œå°åŒ…æ ¸å¿ƒé€»è¾‘) AbstractResponse.php ï¼ˆç»§æ‰¿ AbstractRequestOrResponseï¼ŒåŒ…å«äº†å“åº”åè®®å¤´ï¼Œè§£åŒ…æ ¸å¿ƒé€»è¾‘ï¼‰ CommonRequest.php ï¼ˆç»§æ‰¿ AbstractRequestï¼Œç”¨äºè¾…åŠ©å°è£…åè®®ä¸­ç‰¹æ®Šçš„å­—æ®µå¤„ç†æ–¹å¼ï¼‰ CommonResponse.phpï¼ˆç»§æ‰¿ AbstractResponseï¼Œç”¨äºè¾…åŠ©è§£å¼€åè®®ä¸­ç‰¹æ®Šçš„å­—æ®µå¤„ç†æ–¹å¼ï¼‰ Typeåœ¨è¿™ä¸ªç›®å½•ä¸­ï¼Œå…¨éƒ¨éƒ½æ˜¯æ•°æ®ç±»å‹ï¼Œæˆ‘ä»¬æ•´ä¸ªåè®®çš„æ‰€æœ‰å­—æ®µçš„å®šä¹‰éƒ½æ¥è‡ªäºæ­¤ç›®å½•çš„æ•°æ®ç±»å‹ï¼Œç›®å‰ç”¨åˆ°çš„æ•°æ®ç±»å‹æœ‰ Arrays32 (æ•°ç»„ç±»å‹ï¼Œå  32bitsï¼ŒPHP ä¸­çš„æ ‡è®°ä¸ºï¼šN) Bytes32 (å­—èŠ‚ç±»å‹ï¼Œå  32bitsï¼ŒPHP ä¸­çš„æ ‡è®°ä¸ºï¼šN) String16 (å­—ç¬¦ä¸²ç±»å‹ï¼Œå  16bitsï¼ŒPHP ä¸­çš„æ ‡è®°ä¸ºï¼šn) Int8 (æ•´å‹ç±»å‹ï¼Œå  8bitsï¼ŒPHP ä¸­çš„æ ‡è®°ä¸ºï¼šC) Int16 (æ•´å‹ç±»å‹ï¼Œå  16bitsï¼ŒPHP ä¸­çš„æ ‡è®°ä¸ºï¼šn) Int32 (æ•´å‹ç±»å‹ï¼Œå  32bitsï¼ŒPHP ä¸­çš„æ ‡è®°ä¸ºï¼šN) Int64 (æ•´å‹ç±»å‹ï¼Œå  64bitsï¼ŒPHP ä¸­çš„æ ‡è®°ä¸ºï¼šN2) Requeståœ¨è¿™ä¸ªç›®å½•ä¸­ï¼Œå…¨éƒ¨éƒ½æ˜¯è¯·æ±‚åè®®ä½“çš„å†…å®¹ï¼Œä»¥æ­¤ä¸ºæ ¹ç›®å½•ä¸‹çš„ä¸€çº§æ–‡ä»¶ï¼ˆéç›®å½•ï¼‰ï¼Œéƒ½æ˜¯å¯¹åº”çš„æ¯ä¸€ä¸ª API åè®®ï¼Œå®ƒä»¬å…¨éƒ¨éƒ½ç»§æ‰¿AbstractRequestç±»ï¼Œå¹¶ä¸”å±æ€§å¿…é¡»ä¸ºprivateä¿®é¥°ç¬¦ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œä¸è¦å¿˜è®°äº†å†™ä¸Šå…³é”®ä¿¡æ¯ï¼Œå°±æ˜¯è¿™ä¸ªå±æ€§çš„æ•°æ®ç±»å‹çš„æ³¨è§£(@var Xxx $ooo)ï¼Œè¿™å°†ä¼šæˆ‘ä»¬å°åŒ…å…³é”®æ‰€åœ¨ï¼Œè¿™ä¸ªæ•°æ®ç±»å‹ï¼Œéƒ½æ¥è‡ªäºTypeç›®å½•ã€‚è€Œæ ¹ç›®å½•ä¸‹çš„äºŒçº§ç›®å½•åˆ™æ˜¯å¯¹åº”çš„åè®®ç»“æ„ä¸­çš„å­ç»“æ„ï¼Œè§„åˆ™å’Œä¹‹å‰æè¿°çš„å¤§ä½“ä¸€è‡´ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™å­ç»“æ„å¹¶æ²¡æœ‰ç»§æ‰¿äº†ä»»ä½•çˆ¶ç±»ã€‚ å…¶ä¸­æ¯ä¸ªç±»ä¸­å¯èƒ½å­˜åœ¨onXxxçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™AbstractRequestå¹¶ä¸ä¼šæ­£å¸¸çš„è§£æè¿™ä¸ªç±»ä¸­çš„å­—æ®µï¼Œè€Œæ˜¯å»æ‰§è¡Œæ¯ä¸ªç±»ä¸­ç‰¹å®šçš„å›è°ƒæ–¹æ³•ï¼Œè¿›è¡Œå®šåˆ¶å°åŒ…ã€‚ Responseåœ¨è¿™ä¸ªç›®å½•ä¸­ï¼Œå…¨éƒ¨éƒ½æ˜¯è¯·æ±‚åè®®ä½“çš„å†…å®¹ï¼Œä»¥æ­¤ä¸ºæ ¹ç›®å½•ä¸‹çš„ä¸€çº§æ–‡ä»¶ï¼ˆéç›®å½•ï¼‰ï¼Œéƒ½æ˜¯å¯¹åº”çš„æ¯ä¸€ä¸ª API åè®®ï¼Œå®ƒä»¬å…¨éƒ¨éƒ½ç»§æ‰¿AbstractResponseç±»ï¼Œå¹¶ä¸”å±æ€§å¿…é¡»ä¸ºprivateä¿®é¥°ç¬¦ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œä¸è¦å¿˜è®°äº†å†™ä¸Šå…³é”®ä¿¡æ¯ï¼Œå°±æ˜¯è¿™ä¸ªå±æ€§çš„æ•°æ®ç±»å‹çš„æ³¨è§£(@var Xxx $ooo)ï¼Œè¿™å°†ä¼šæˆ‘ä»¬å°åŒ…å…³é”®æ‰€åœ¨ï¼Œè¿™ä¸ªæ•°æ®ç±»å‹ï¼Œéƒ½æ¥è‡ªäºTypeç›®å½•ã€‚è€Œæ ¹ç›®å½•ä¸‹çš„äºŒçº§ç›®å½•åˆ™æ˜¯å¯¹åº”çš„åè®®ç»“æ„ä¸­çš„å­ç»“æ„ï¼Œè§„åˆ™å’Œä¹‹å‰æè¿°çš„å¤§ä½“ä¸€è‡´ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™å­ç»“æ„å¹¶æ²¡æœ‰ç»§æ‰¿äº†ä»»ä½•çˆ¶ç±»ã€‚ å…¶ä¸­æ¯ä¸ªç±»ä¸­å¯èƒ½å­˜åœ¨onXxxçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™AbstractResposeå¹¶ä¸ä¼šæ­£å¸¸çš„è§£æè¿™ä¸ªç±»ä¸­çš„å­—æ®µï¼Œå…ˆæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œè¿›è¡Œå®šåˆ¶è§£åŒ…ã€‚é€šè¿‡è¿”å› true æˆ–è€…è¿”å› false æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ç»§ç»­æ­£å¸¸è§£æè¿™ä¸ªå­—æ®µï¼Œå¦‚æœè¿”å› true åˆ™æ˜¯è·³è¿‡è¿™ä¸ªå­—æ®µä¸å†è§£æï¼Œè¯´æ˜äº†è¿™ä¸ªå­—æ®µåœ¨onXxxä¸­å¯ä»¥è§£æå®Œæ¯•äº†ã€‚å¦åˆ™å°†ç»§ç»­è§£æè¿™ä¸ªå­—æ®µã€‚ TraitStructureåœ¨è¿™ä¸ªç›®å½•ä¸­ï¼Œéƒ½æ˜¯ä¸€äº›å¤ç”¨ä½“ï¼ˆtraitï¼‰ï¼Œç›®å‰æ¥è¯´ç”¨ä¸Šçš„åªæœ‰ToArrayTraitï¼Œè¿™ä¸ªç»“æ„ä½“ä¸»è¦çš„èŒè´£æ˜¯æŠŠå¯¹è±¡è¿”å›æˆæ•°ç»„ç»“æ„ã€‚ å‹ç¼©æ–¹å¼è¯¦è§£ç»è¿‡æˆ‘å¯¹ä¸Šæ–‡ä¸­æåˆ°å¯¹ 2 ä¸ªæœ€å¤š star çš„ä»“åº“çš„è€ƒå¯Ÿï¼Œå‘ç°è¿™ 2 ä¸ªä»“åº“è¦ä¹ˆæ˜¯å‹ç¼©æ–¹å¼ä¸æ”¯æŒï¼Œè¦ä¹ˆå°±æ˜¯åè®®æ–¹å¼å°è£…é”™è¯¯ã€‚ æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œå¯ä»¥å¾ˆå¯¹å‹ç¼©æ–¹å¼åšä¸€äº›è¯´æ˜ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æ•°æ®æ˜¯å¯ä»¥ä¸å‹ç¼©çš„ï¼Œä½†æ˜¯ï¼Œå½“æˆ‘ä»¬çš„ç”Ÿäº§è€…åœ¨å†³å®šç”¨å‹ç¼©æ•°æ®çš„æ–¹å¼æ¥ä¼ è¾“æ•°æ®çš„æ—¶å€™ï¼Œå°±ä»£è¡¨ä½ è¿™çš„æ¶ˆè´¹ç«¯å°±å¿…é¡»æ”¯æŒå¯¹åº”çš„è§£å‹æ–¹å¼ã€‚ åœ¨å‹ç¼©çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æ•°æ®é‡å¯ä»¥è¢«å‹ç¼©å­˜å‚¨åœ¨ kafka ä¸­ï¼Œä¸ä½†å¯ä»¥èŠ‚çº¦æœåŠ¡å™¨çš„ç£ç›˜ç©ºé—´ï¼Œè€Œä¸”è¿˜å‡å°‘äº†å¸¦å®½çš„å ç”¨ï¼Œæé«˜äº†ä¼ è¾“é€Ÿç‡ã€‚æ‰€ä»¥åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æœºå™¨ CPU æœ‰æ¡ä»¶çš„æƒ…å†µä¸‹ï¼Œæœ€å¥½è¿˜æ˜¯å¯¹æ•°æ®è¿›è¡Œå‹ç¼©ä¼ è¾“ã€‚ ç”±äºæˆ‘ä»¬ç›®å‰åªå¯¹ VERSION=0 çš„åè®®è¿›è¡Œå°è£…ï¼Œæ‰€ä»¥ç”¨æ­¤æ¥è¯´æ˜ã€‚ 1234567891011121314MessageSet (Version: 0) &#x3D;&gt; [offset message_size message] offset &#x3D;&gt; INT64 message_size &#x3D;&gt; INT32 message &#x3D;&gt; crc magic_byte attributes key value crc &#x3D;&gt; INT32 magic_byte &#x3D;&gt; INT8 attributes &#x3D;&gt; INT8 bit 0~2: 0: no compression 1: gzip 2: snappy bit 3~7: unused key &#x3D;&gt; BYTES value &#x3D;&gt; BYTES æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªåè®®è¯´æ˜ä¸­ï¼Œmessage ç»“æ„ä½“ä¸­åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªå…³é”®å†…å®¹ï¼š crc magic_byte attributes ç¬¬[0-2]bit ä»£è¡¨ç€å‹ç¼©æ–¹å¼ ç¬¬[3-7]bit ç•™ç©º key value æ‰€ä»¥æˆ‘ä»¬åœ¨è§£åè®®çš„æ—¶å€™ï¼Œä» attributes çš„ç¬¬[0-2]ä¸ª bit ä¸­å¯ä»¥çŸ¥é“ value çš„æ•°æ®æ˜¯å¦éœ€è¦è¿›è¡Œå‹ç¼©æˆ–è€…è§£å‹ã€‚ åœ¨ä»£ç å±‚é¢ä¸­å°±æ˜¯ï¼š å‹ç¼©ï¼š 123456789101112131415161718192021222324252627282930313233343536373839/** * @param $protocol * * @throws \\Kafka\\Exception\\ProtocolTypeException * @throws \\ReflectionException */public function onMessageSetSize(&amp;$protocol)&#123; if (($this-&gt;getMessage()-&gt;getAttributes()-&gt;getValue() &amp; 0x07) !== CompressionCodecEnum::NORMAL) &#123; $wrapperMessage = clone $this-&gt;getMessage(); $this-&gt;getMessage()-&gt;setAttributes(Int8::value(CompressionCodecEnum::NORMAL)) -&gt;setValue($this-&gt;getMessage() -&gt;getValue()); $commentRequest = new CommonRequest(); $data = $commentRequest-&gt;packProtocol(MessageProduce::class, $this-&gt;getMessage()); $data = pack(Int32::getWrapperProtocol(), strlen($data)) . $data; $left = 0xffffffff00000000; $right = 0x00000000ffffffff; $l = (-1 &amp; $left) &gt;&gt; 32; $r = -1 &amp; $right; $data = pack(Int64::getWrapperProtocol(), $l, $r) . $data; if (($wrapperMessage-&gt;getAttributes()-&gt;getValue() &amp; 0x07) === CompressionCodecEnum::SNAPPY) &#123; $compressValue = snappy_compress($data); &#125; elseif (($wrapperMessage-&gt;getAttributes()-&gt;getValue() &amp; 0x07) === CompressionCodecEnum::GZIP) &#123; $compressValue = gzencode($data); &#125; else &#123; throw new RuntimeException('not support lz4'); &#125; $wrapperMessage-&gt;setKey(Bytes32::value(''))-&gt;setValue(Bytes32::value($compressValue)); $this-&gt;setMessage($wrapperMessage); &#125; $commentRequest = new CommonRequest(); $data = $commentRequest-&gt;packProtocol(MessageProduce::class, $this-&gt;getMessage()); $this-&gt;setMessageSetSize(Int32::value(strlen($data))); $protocol .= pack(Int32::getWrapperProtocol(), $this-&gt;getMessageSetSize()-&gt;getValue());&#125; è§£å‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384/** * @param $protocol * * @return bool * @throws \\Kafka\\Exception\\ProtocolTypeException * @throws \\ReflectionException */public function onRecordSet(&amp;$protocol)&#123; $recordSet = []; while (is_string($protocol) &amp;&amp; strlen($protocol) &gt; 0) &#123; $commonResponse = new CommonResponse(); $instance = new MessageSetFetch(); $commonResponse-&gt;unpackProtocol(MessageSetFetch::class, $instance, $protocol); // Insufficient reading sub-section, the message is put on the next read if ($instance-&gt;getMessage()-&gt;getCrc()-&gt;getValue() === null) &#123; continue; &#125; // Internal decompression if ($instance-&gt;getMessage()-&gt;getAttributes()-&gt;getValue() !== CompressionCodecEnum::NORMAL) &#123; $buffer = $instance-&gt;getMessage()-&gt;getValue()-&gt;getValue(); $commonResponse-&gt;unpackProtocol(MessageSetFetch::class, $instance, $buffer); &#125; $recordSet[] = $instance; &#125; $this-&gt;setRecordSet($recordSet); return true;&#125;/** * @param $protocol * * @return bool */public function onValue(&amp;$protocol)&#123; if (($this-&gt;getAttributes()-&gt;getValue() &amp; 0x07) === CompressionCodecEnum::SNAPPY) &#123; /* snappy-java adds its own header (SnappyCodec) which is not compatible with the official Snappy implementation. 8: magic, 4: version, 4: compatible followed by any number of chunks: 4: length ...: snappy-compressed data. */ $protocol = substr($protocol, 20); $ret = []; SnappyDecompression: if (!is_string($protocol) || (is_string($protocol) &amp;&amp; strlen($protocol) &lt;= 0)) &#123; $ret = implode('', $ret); &#125; else &#123; $buffer = substr($protocol, 0, ProtocolTypeEnum::B32); $protocol = substr($protocol, ProtocolTypeEnum::B32); $len = unpack(ProtocolTypeEnum::getTextByCode(ProtocolTypeEnum::B32), $buffer); $len = is_array($len) ? array_shift($len) : $len; $data = substr($protocol, 0, $len); $protocol = substr($protocol, $len); $ret[] = snappy_uncompress($data); goto SnappyDecompression; &#125; $this-&gt;setValue(Bytes32::value($ret)); return true; &#125; else if (($this-&gt;getAttributes()-&gt;getValue() &amp; 0x07) === CompressionCodecEnum::GZIP) &#123; $buffer = substr($protocol, 0, ProtocolTypeEnum::B32); $protocol = substr($protocol, ProtocolTypeEnum::B32); $len = unpack(ProtocolTypeEnum::getTextByCode(ProtocolTypeEnum::B32), $buffer); $len = is_array($len) ? array_shift($len) : $len; $data = substr($protocol, 0, $len); $protocol = substr($protocol, $len); $this-&gt;setValue(Bytes32::value(gzdecode($data))); return true; &#125; // Normal return false;&#125; åœ¨å‹ç¼©çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å¯¹æ•°æ®è¿›è¡Œå‹ç¼©å¤„ç†çš„æ—¶å€™ï¼Œattributeså±æ€§å¿…é¡»è®¾ç½®ä¸º 0ï¼Œè¿™æ˜¯å’Œè§£å‹é€»è¾‘ç›¸å¯¹åº”çš„ã€‚åªè¦åœ¨å‹ç¼©å®Œæ¯•ä¹‹åï¼ŒäºŒæ¬¡å°è£…çš„æ—¶å€™ï¼Œattributes åœ¨ç¬¬äºŒæ¬¡èµ‹å€¼çš„æ—¶å€™æ‰ä¼šè®¾ç½®æˆçœŸæ­£çš„å€¼ã€‚ æ‰€ä»¥è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡$this-&gt;getAttributes()-&gt;getValue() &amp; 0x07çš„æ–¹å¼ï¼Œæ¥åˆ¤æ–­å½“å‰æ•°æ®æ˜¯å¦éœ€è¦è§£å‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é‡‡ç”¨ snappy/zip çš„å‹ç¼©æ–¹å¼çš„æ—¶å€™,æ•°æ®å‹ç¼©äº†ï¼Œç»†èŠ‚è¢«å±è”½äº†èµ·æ¥ï¼Œæ¶ˆæ¯æ›´åŠ çš„å®‰å…¨äº†ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡å¯¹messageSetè§£å‹åå¾—å‡ºæ¥åæ¥ï¼Œvalue å…¶å®ä»ç„¶å¹¶æ²¡æœ‰è¢«è§£å‹ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­attributesçš„å€¼ï¼Œå¦‚æœç»è¿‡ç¬¬ä¸€æ¬¡è§£å‹ï¼Œattributesä¸ä¸º 0 çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå®ƒéœ€è¦å†è¿›è¡Œä¸€æ¬¡è§£å‹ï¼Œè¿™ä¸€æ¬¡ï¼Œæ•°æ®å°†é‡æ–°è¦†ç›–æ•´ä¸ªmessageSetç»“æ„ä½“ï¼Œå¹¶ä¸”arttibuteså°†ä¼šè¢«è®¾ç½®ä¸º 0ï¼Œä»¥æ­¤æ¥å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œåè®®å·²ç»æ­£ç¡®è§£æå®Œæ¯•ã€‚ è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ kafka å¹¶ä¸ä»…ä»…åªæ˜¯å•å•ç”¨äº† snappy å‹ç¼©æ–¹å¼ï¼Œå®ƒè¿˜åŠ å…¥äº†å®ƒè‡ªå·±çš„åè®®å¤´ï¼ˆè¿™ä¸ªçœŸçš„æ˜¯ä¸ªå·¨å‘ï¼‰ï¼Œæ‰€ä»¥ä½ éœ€è¦å¿½ç•¥å‰é¢çš„ 20 ä¸ªå­—èŠ‚ã€‚åç»­ä»¥è¢« 4 ä¸ªå­—èŠ‚çš„è§£æå‡ºæ¥çš„å­—ç¬¦é•¿åº¦æ¥é€’å½’è§£å‹ã€‚ç›¸å¯¹äº snappy çš„å‹ç¼©æ–¹å¼ï¼Œgzip çš„å‹ç¼©æ–¹å¼å°±æ˜¯ä¸­è§„ä¸­çŸ©äº†ã€‚ å¦‚ä½•åˆ©ç”¨ docker ç¯å¢ƒå°è¯•åŠ å…¥å¼€å‘é¡¹ç›®ä¸­ï¼Œå·²ç»æŠŠå¼€å‘ç”¨çš„docker-composer.yamlå·²ç»å†™å¥½äº†ï¼Œåªéœ€è¦é‡‡ç”¨docker-composer upå³å¯ã€‚å…¶ä»–çš„éƒ½æ˜¯å¸¸è§„æ“ä½œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263version: &quot;3&quot;services: mzookeeper: image: wurstmeister&#x2F;zookeeper container_name: kafka-swoole-zookeeper mkafka1: image: wurstmeister&#x2F;kafka:2.11-0.9.0.1 container_name: kafka-swoole-kafka1 environment: KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181 KAFKA_NUM_PARTITIONS: 4 depends_on: - mzookeeper mkafka2: image: wurstmeister&#x2F;kafka:2.11-0.9.0.1 container_name: kafka-swoole-kafka2 environment: KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181 KAFKA_NUM_PARTITIONS: 4 depends_on: - mzookeeper mkafka3: image: wurstmeister&#x2F;kafka:2.11-0.9.0.1 container_name: kafka-swoole-kafka3 environment: KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181 KAFKA_NUM_PARTITIONS: 4 depends_on: - mzookeeper mkafka4: image: wurstmeister&#x2F;kafka:2.11-0.9.0.1 container_name: kafka-swoole-kafka3 environment: KAFKA_ADVERTISED_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_LISTENERS: PLAINTEXT:&#x2F;&#x2F;:9092 KAFKA_ZOOKEEPER_CONNECT: mzookeeper:2181 KAFKA_NUM_PARTITIONS: 4 depends_on: - mzookeeper kafka-swoole: build: .&#x2F; container_name: kafka-swoole-php volumes: - .&#x2F;:&#x2F;data&#x2F;www depends_on: - mzookeeper - mkafka1 - mkafka2 - mkafka3 - mkafka4","categories":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"http://blog.crazylaw.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"}],"tags":[{"name":"Swoole","slug":"Swoole","permalink":"http://blog.crazylaw.cn/tags/Swoole/"},{"name":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","slug":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","permalink":"http://blog.crazylaw.cn/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8CKafka/"}]},{"title":"ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘- Kafkaç›¸å…³","slug":"æ¶ˆæ¯é˜Ÿåˆ—/kafka","date":"2019-10-01T07:25:40.000Z","updated":"2021-03-20T16:25:01.819Z","comments":true,"path":"2019/10/01/æ¶ˆæ¯é˜Ÿåˆ—/kafka/","link":"","permalink":"http://blog.crazylaw.cn/2019/10/01/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/","excerpt":"å‰è¨€ç›®å‰ kafka å®¢æˆ·ç«¯åœ¨ php ä¸­æ¯”è¾ƒå‡ºåçš„ä»…æœ‰ 2 ä¸ªï¼Œä½†æ˜¯å…¶å„æœ‰åˆ©å¼Šï¼Œåœ¨è¿™é‡Œå°±ä¸å±•å¼€è¯¦ç»†è¯´æ˜äº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå«kafka-swooleçš„é¡¹ç›®ï¼Œé¡¹ç›®ç”±swoole4.xåç¨‹+å¤šè¿›ç¨‹å®ç°ï¼Œå®ç°åœ¨ä¸²è¡ŒåŒ–åç¨‹çš„åŸºç¡€ä¸Šå®ç°å¹¶è¡Œæ“ä½œã€‚ ç”±äºå¾ˆå¤šå°ä¼™ä¼´å¯¹ kafka å¹¶ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ä¸€äº›åŸºç¡€çš„ kafka è‡ªå¸¦çš„å‘½ä»¤ä½¿ç”¨æ–¹å¼","text":"å‰è¨€ç›®å‰ kafka å®¢æˆ·ç«¯åœ¨ php ä¸­æ¯”è¾ƒå‡ºåçš„ä»…æœ‰ 2 ä¸ªï¼Œä½†æ˜¯å…¶å„æœ‰åˆ©å¼Šï¼Œåœ¨è¿™é‡Œå°±ä¸å±•å¼€è¯¦ç»†è¯´æ˜äº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå«kafka-swooleçš„é¡¹ç›®ï¼Œé¡¹ç›®ç”±swoole4.xåç¨‹+å¤šè¿›ç¨‹å®ç°ï¼Œå®ç°åœ¨ä¸²è¡ŒåŒ–åç¨‹çš„åŸºç¡€ä¸Šå®ç°å¹¶è¡Œæ“ä½œã€‚ ç”±äºå¾ˆå¤šå°ä¼™ä¼´å¯¹ kafka å¹¶ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ä¸€äº›åŸºç¡€çš„ kafka è‡ªå¸¦çš„å‘½ä»¤ä½¿ç”¨æ–¹å¼ æˆ‘çš„ kafka é›†ç¾¤æ˜¯ 4 ä¸ª brokerï¼Œæ˜¯ç”¨ docker è¿æ¥åœ¨ä¸€èµ·çš„ kafka é›†ç¾¤ã€‚åˆ†åˆ«è®¾ç½®äº† hostname mkafka1:9092 mkafka2:9092 mkafka3:9092 mkafka4:9092 mzookeeper:2181 kafka-topics.shè¿™ä¸ªè„šæœ¬ä¸»è¦æ˜¯ç”¨äº kafka åˆ›å»º topics è€Œä½¿ç”¨ã€‚ åˆ›å»º topic Option Description â€“alter ä¿®æ”¹ topic çš„åˆ†åŒºæ•°ï¼Œå‰¯æœ¬æŒ‡æ´¾ä»¥åŠ topic çš„ç°æœ‰é…ç½® â€“config &lt;name=value&gt; åˆ›å»º topic çš„æ—¶å€™ä¼šç”¨åˆ°é»˜è®¤é…ç½®ï¼Œç½®é¡¶å…·ä½“çš„é…ç½®å‚æ•°ï¼Œå…·ä½“æŸ¥çœ‹ kafka çš„é…ç½®é¡¹ â€“create åˆ›å»º topic â€“delete åˆ é™¤ topic â€“delete-config åˆ›å»º topic çš„æ—¶å€™ç§»é™¤æŸä¸€ä¸ªé…ç½®é¡¹ â€“describe æŸä¸€ä¸ª topic çš„è¯¦æƒ…æè¿° â€“list æ‰€æœ‰å¯ç”¨çš„ topic åˆ—è¡¨ â€“partitions æŒ‡å®š topic æ•°ç›® â€“replica-assignment &lt;broker_id_for_part1_replica1,â€¦&gt; åˆ›å»ºæˆ–æ›´æ”¹çš„ä¸»é¢˜çš„æ‰‹åŠ¨åˆ†åŒºåˆ°ä»£ç†çš„åˆ†é…åˆ—è¡¨ã€‚ â€“replication-factor topic çš„å‰¯æœ¬å› å­ â€“topic éœ€è¦åˆ›å»ºçš„ topic åå­— â€“unavailable-partitions â€“describe ä¸»é¢˜çš„æ—¶å€™ï¼Œåˆ™åªæ˜¾ç¤ºå…¶ leader ä¸å¯ç”¨çš„åˆ†åŒº â€“zookeeper zookeeper èŠ‚ç‚¹ 1234kafka-topics.sh --create --zookeeper mzookeeper:2181 --replication-factor 2 --partitions 4 --topic kafka-swoole## æ ‡å‡†è¾“å‡ºCreated topic &quot;kafka-swoole&quot;. è¿™æ ·å­æ‰§è¡Œå‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªå‰¯æœ¬å› å­ä¸º 2ï¼Œå¹¶ä¸”åˆ†åŒºæ•°ä¸º 4 ï¼Œåå­—å« kafka-swoole çš„ topic æŸ¥çœ‹æ‰€æœ‰çš„ topic åˆ—è¡¨12345678kafka-topics.sh --list --zookeeper mzookeeper:2181## æ ‡å‡†è¾“å‡º__consumer_offsetscaiwenhuicaiwenhui2kafka-swooletest æŸ¥çœ‹ æŸä¸ª topic çš„è¯¦æƒ…12345678kafka-topics.sh --zookeeper mzookeeper:2181 --topic kafka-swoole --describe## æ ‡å‡†è¾“å‡ºTopic:kafka-swoole PartitionCount:4 ReplicationFactor:2 Configs: Topic: kafka-swoole Partition: 0 Leader: 1003 Replicas: 1003,1002 Isr: 1003,1002 Topic: kafka-swoole Partition: 1 Leader: 1004 Replicas: 1004,1003 Isr: 1004,1003 Topic: kafka-swoole Partition: 2 Leader: 1001 Replicas: 1001,1004 Isr: 1001,1004 Topic: kafka-swoole Partition: 3 Leader: 1002 Replicas: 1002,1001 Isr: 1002,1001 å‘æŸä¸ª topic å†™å…¥æ¶ˆæ¯1kafka-console-producer.sh --broker-list mkafka1:9092 --topic kafka-swoole ä»æŸä¸ª topic è¯»å–æ¶ˆæ¯ä»æœ€å¼€å§‹çš„ offset è¯»å–1kafka-console-consumer.sh --bootstrap-server mkafka1:9092 --topic kafka-swoole --from-beginning ä»æœ€æ–°çš„ offset ä¸­è¯»1kafka-console-consumer.sh --bootstrap-server mkafka1:9092 --topic kafka-swoole æŸ¥çœ‹æŸä¸ª topic çš„æŸä¸ªæ—¶åˆ»çš„ offsetæœ€æ—©ä¹‹å‰çš„æ¶ˆæ¯çš„ offset1234567kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list 192.168.11.148:9092 -time -2 --topic kafka-swoole# æ ‡å‡†è¾“å‡ºkafka-swoole:2:0kafka-swoole:1:0kafka-swoole:3:0kafka-swoole:0:0 æœ€è¿‘çš„æ¶ˆæ¯ offset1234567kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list 192.168.11.148:9092 -time -1 --topic kafka-swoole# æ ‡å‡†è¾“å‡ºkafka-swoole:2:0kafka-swoole:1:0kafka-swoole:3:0kafka-swoole:0:6 æŸä¸€ä¸ªæ—¶åˆ»çš„ offset1kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list 192.168.11.148:9092 -time 1569943885 --topic kafka-swoole","categories":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"http://blog.crazylaw.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"}],"tags":[{"name":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","slug":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","permalink":"http://blog.crazylaw.cn/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8CKafka/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- Glow æºç å‰–æ","slug":"å¤§æ•°æ®/Glowæºç å‰–æ","date":"2019-08-11T16:07:40.000Z","updated":"2021-03-20T16:25:01.814Z","comments":true,"path":"2019/08/12/å¤§æ•°æ®/Glowæºç å‰–æ/","link":"","permalink":"http://blog.crazylaw.cn/2019/08/12/%E5%A4%A7%E6%95%B0%E6%8D%AE/Glow%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/","excerpt":"å‰è¨€çŠ¹è±«å…¬å¸çš„æµå¼è®¡ç®—ï¼Œå¹¶æ²¡æœ‰ç”¨ç±»ä¼¼äº Hadoop çš„ mapreduce æœºåˆ¶æˆ–è€… storm æˆ–è€… flinkï¼Œæ˜¯æˆ‘ä»¬è‡ªç ”åŸºäº erlang çš„å•èŠ‚ç‚¹æœåŠ¡ï¼Œå…¶ä¼˜ç‚¹å°±æ˜¯ï¼šéƒ¨ç½²å’Œè¿ç§»éƒ½ååˆ†ç®€å•ï¼Œå¹¶ä¸”çŠ¹è±« erlang çš„å¤©ç„¶çš„è‰¯å¥½çš„åˆ©ç”¨äº†å¤šæ ¸ CPU çš„ä¼˜åŠ¿ï¼Œå¯ä»¥å®ç°æ•ˆç‡è¾ƒé«˜çš„å¤§æ•°æ®æµå¼è®¡ç®—ã€‚ä½†æ˜¯ç”±äºå…¶å•æœºæ€§ï¼Œå¯¼è‡´å¯¹å•å°æœºå™¨çš„è¦æ±‚è¿‡äºè‹›åˆ»ï¼Œå¹¶ä¸”ä¸èƒ½è¿›è¡Œæ‰©å±•æœºå™¨æé«˜è®¡ç®—èƒ½åŠ›æ˜¯å…¶è‡´å‘½çš„ç¼ºç‚¹ï¼Œæ‰€ä»¥ç›®å‰æˆ‘è§„åˆ’åˆ©ç”¨ golangï¼Œå†™ä¸€ä¸ªæ”¯æŒåˆ†å¸ƒå¼å¹¶è¡Œè®¡ç®—çš„æœåŠ¡ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œäº†è§£äº†å„å¤§æµå¼è®¡ç®—çš„åŸºæœ¬æ€æƒ³ï¼Œå¹¶ä¸”ç»“åˆ golang è¯­è¨€çš„ç‰¹æ€§ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªå«glowçš„æœåŠ¡ï¼Œæƒ³è¦å†™å¥½ä¸€ä¸ªåˆ†å¸ƒå¼æµå¼è®¡ç®—çš„æœåŠ¡ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ glow æœ‰ä»€ä¹ˆå¥½çš„å€Ÿé‰´çš„æ€æƒ³å’Œæ€è·¯ã€‚","text":"å‰è¨€çŠ¹è±«å…¬å¸çš„æµå¼è®¡ç®—ï¼Œå¹¶æ²¡æœ‰ç”¨ç±»ä¼¼äº Hadoop çš„ mapreduce æœºåˆ¶æˆ–è€… storm æˆ–è€… flinkï¼Œæ˜¯æˆ‘ä»¬è‡ªç ”åŸºäº erlang çš„å•èŠ‚ç‚¹æœåŠ¡ï¼Œå…¶ä¼˜ç‚¹å°±æ˜¯ï¼šéƒ¨ç½²å’Œè¿ç§»éƒ½ååˆ†ç®€å•ï¼Œå¹¶ä¸”çŠ¹è±« erlang çš„å¤©ç„¶çš„è‰¯å¥½çš„åˆ©ç”¨äº†å¤šæ ¸ CPU çš„ä¼˜åŠ¿ï¼Œå¯ä»¥å®ç°æ•ˆç‡è¾ƒé«˜çš„å¤§æ•°æ®æµå¼è®¡ç®—ã€‚ä½†æ˜¯ç”±äºå…¶å•æœºæ€§ï¼Œå¯¼è‡´å¯¹å•å°æœºå™¨çš„è¦æ±‚è¿‡äºè‹›åˆ»ï¼Œå¹¶ä¸”ä¸èƒ½è¿›è¡Œæ‰©å±•æœºå™¨æé«˜è®¡ç®—èƒ½åŠ›æ˜¯å…¶è‡´å‘½çš„ç¼ºç‚¹ï¼Œæ‰€ä»¥ç›®å‰æˆ‘è§„åˆ’åˆ©ç”¨ golangï¼Œå†™ä¸€ä¸ªæ”¯æŒåˆ†å¸ƒå¼å¹¶è¡Œè®¡ç®—çš„æœåŠ¡ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œäº†è§£äº†å„å¤§æµå¼è®¡ç®—çš„åŸºæœ¬æ€æƒ³ï¼Œå¹¶ä¸”ç»“åˆ golang è¯­è¨€çš„ç‰¹æ€§ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªå«glowçš„æœåŠ¡ï¼Œæƒ³è¦å†™å¥½ä¸€ä¸ªåˆ†å¸ƒå¼æµå¼è®¡ç®—çš„æœåŠ¡ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ glow æœ‰ä»€ä¹ˆå¥½çš„å€Ÿé‰´çš„æ€æƒ³å’Œæ€è·¯ã€‚ æºç åˆ†ææˆ‘ä»¬è¦è®°å¾—è¿™ 5 ä¸ªå†…å®¹ï¼Œè¿™æ˜¯æ„æˆæ•´ä¸ª flow çš„æ ¸å¿ƒåè¯ ä¸Šä¸‹æ–‡ Context æ­¥è¿› Step ä»»åŠ¡ Task æ•°æ®é›† Dataset æ•°æ®åˆ†ç‰‡ DatasetShard ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ä¸Šä¸‹æ–‡æœ‰ 4 ä¸ªå±æ€§ï¼Œå…¶ä¸­ 2 ä¸ªé—®æ•°ç»„ Id int Steps []flow.Step Datasets []flow.Dataset ChannelBufferSize int æ­¥è¿›ï¼ˆStepï¼‰ &amp; ä»»åŠ¡ï¼ˆTaskï¼‰æ­¥è¿›ï¼ˆStepï¼‰Step æœ‰ 6 ä¸ªå±æ€§ Id int Name string Inputs []flow.Dataset ï¼ˆæ¯ä¸€æ­¥çš„æ¥æºç»“æœé›†ï¼‰ Output flow.Dataset ï¼ˆæ¯ä¸€ä¸ªéœ€è¦è¾“å‡ºçš„ç»“æœé›†ï¼‰ Function function (æ¯ä¸€æ­¥æ“ä½œæ¥å£æä¾›çš„ç”¨æˆ·è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘) Tasks []flow.Task ï¼ˆä»»åŠ¡æ•°åŸºäºä¸Šä¸€æ­¥ä¸­çš„ Output ä¸­ Task ä¸­ Outputs çš„æ•°æ®åˆ†åŒºæ•°é‡ï¼‰ ä»»åŠ¡ï¼ˆTaskï¼‰Task æœ‰ 5 ä¸ªå±æ€§ Id int Inputs []flow.DatasetShard Outputs []flow.DatasetShard ï¼ˆè¾“å‡ºç»“æœé›†çš„åˆ†åŒºï¼Œå„ä¸ªåˆ†åŒºå¤„äºå¹³ç­‰å…³ç³»ï¼‰ Step flow.Step ï¼ˆæ‰€å±å“ªä¸€æ­¥çš„ä»»åŠ¡ï¼‰ InputChans []reflect.Value ä¸€ä¸ªä»»åŠ¡ Inputs ç­‰äºä¸€ä¸ªä¸Šä¸€æ­¥ä¸­çš„ Output ä¸­ Task ä¸­çš„ Outputs çš„æ•°é‡ æ•°æ®é›†ï¼ˆDatasetï¼‰ &amp; æ•°æ®ç²‰åˆ†ç‰‡ï¼ˆDatasetShardï¼‰æ•°æ®é›†ï¼ˆDatasetï¼‰Dataset æœ‰ 10 ä¸ªå±æ€§ Id int ï¼ˆStep è¾“å‡ºçš„æ•°æ®ç»“é›†ï¼‰ context flow.FlowContext Type reflect.Type | *reflect.rtype Shards []flow.DatasetShard ï¼ˆå¯¹åº” Step ä¸­ Tasks ä¸­ Outputs çš„æ•°æ®åˆ†åŒºï¼‰ Step flow.Step ï¼ˆå±äºå“ªä¸€ä¸ªç»“æœé›†ï¼‰ ReadingSteps []flow.Step ï¼ˆå¯¹åº”ä¸‹ä¸€æ­¥çš„ Stepï¼‰ ExternalInputChans []reflect.Value ExternalOutputChans []reflect.Value IsKeyPartitioned bool isKeyLocalSorted bool æ•°æ®é›†åˆ†ç‰‡ï¼ˆDatasetShardï¼‰DatasetShard æœ‰ 9 ä¸ªå±æ€§ Id int Parent flow.Dataset ï¼ˆæ‰€å±çš„ç»“æœé›†ï¼‰ WriteChan reflect.Value ReadingTasks []flow.Task ï¼ˆStep ä¸Šæœ‰å‡ ä¸ª Tasks å°±æœ‰å‡ ä¸ªï¼‰ Counter int ReadyTime time.Time CloseTime time.Time lock sync.RWMutex readingChans []reflect.Value word_countå’Œå…¶ä»–æµå¼è®¡ç®—ä¸€æ ·ï¼Œæä¾›äº†ä¸€ä¸ªå•è¯ç»Ÿè®¡çš„ä¾‹å­ã€‚ 1234567891011121314151617181920flow.New().TextFile( \"/etc/passwd\", 2,).Filter(func(line string) bool &#123; //println(\"filter:\", line) return !strings.HasPrefix(line, \"#\")&#125;).Map(func(line string, ch chan string) &#123; for _, token := range strings.Split(line, \":\") &#123; ch &lt;- token &#125;&#125;).Map(func(key string) int &#123; println(\"map:\", key) return 1&#125;).Reduce(func(x int, y int) int &#123; println(\"x:\", x) println(\"y:\", y) println(\"reduce:\", x+y) return x + y&#125;).Map(func(x int) &#123; println(\"count:\", x)&#125;).Run() æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ‰§è¡Œæµç¨‹ã€‚ flow.New() ç”Ÿæˆ flow.FlowContext TextFile(â€œ/etc/passwdâ€, 2) æ‰“å¼€/etc/passwd æ–‡ä»¶ï¼Œå¹¶ä¸”æ•°æ®åˆ†ç‰‡æ•°é‡ä¸ºï¼š2 è¿™æ˜¯ç¬¬ä¸€ä¸ª Step Filter(func) å°†è¿”å›trueçš„æ•°æ®ç­›é€‰å‡ºæ¥ è¿™æ˜¯ç¬¬äºŒä¸ª Step Map(func(line string, ch chan string)) éœ€è¦è¿æ‰§è¡Œ map è¿ç®—ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸Šä¸€ä¸ª Step çš„ç»“æœå€¼ï¼Œç¬¬äºŒä¸ªå‚æ•°è¯´æ˜éœ€è¦é€šè¿‡ä¸€ä¸ªå¯è¯»å¯å†™çš„ chan æ¥å†™å…¥ä¼ è¾“æ•°æ®ï¼Œç›¸å½“äºäºŒæ¬¡æ‹†åˆ†æ•°æ® è¿™æ˜¯ç¬¬ä¸‰ä¸ª Step Map(func(key string)) ä»ä¸Šä¸€æ­¥çš„ Step ä¸­çš„ chan ä¸­è¯»å–å‡ºæ¥çš„æ•°æ®ï¼Œæ¯æ¬¡æ¥ä¸€ä¸ª keyï¼Œéƒ½è¿”å›ä¸€ä¸ªæ•´å‹ï¼š1 Reduce(func(x int, y int)ï¼‰è¿›è¡ŒReduceçš„æ“ä½œï¼Œå°†æ•°æ®åˆå¹¶æ±‡æ€»ï¼Œx ä»£è¡¨ä¸Šä¸€æ¬¡ step çš„æ€»æ•°ï¼Œy ä»£è¡¨æœ€è¿‘ä¸€æ¬¡å¾—åˆ°çš„å€¼ã€‚ä½†æ˜¯è¿™é‡Œæ¯”è¾ƒç‰¹æ®Šï¼Œåœ¨å‰é¢æ‰€æœ‰ step éƒ½å¤„ç†å®Œæ¯•ä¹‹åï¼Œå¦‚æœä½ æ˜¯è¿›è¡Œäº†æ•°æ®åˆ†ç‰‡çš„è¯ï¼Œä¼šæŠŠæ•°æ®åˆ†ç‰‡å†åˆå¹¶ä¸€æ¬¡ã€‚ Map(func(x int)) ç”±äºæˆ‘ä»¬è¿›è¡Œäº† Reduce äº†ï¼Œæ‰€ä»¥åœ¨ Reduce ä¹‹åçš„ map åªä¼šè¿›è¡Œä¸€æ¬¡è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™ x å°±ä»£è¡¨æˆ‘ä»¬ Reduce çš„ API çš„æœ€ç»ˆç»“æœ Run() è¿è¡Œæµå¼è®¡ç®— æŒ‰ç…§çœ‹æºç çš„å¥—è·¯ è¿è¡Œ demoï¼Œç†è§£ demo æ‰¾åˆ° demo çš„è¿è¡Œå…¥å£ æ ¹æ®å…¥å£æ¥æŸ¥çœ‹è¿è¡Œæ–¹å¼ å†å›è¿‡å¤´æ¥çœ‹ demo çš„ç»†èŠ‚ è¿è¡Œé€»è¾‘123func (d *Dataset) Run() &#123; d.context.Run()&#125; 123456789func (fc *FlowContext) Run() &#123; if taskRunner != nil &amp;&amp; taskRunner.IsTaskMode() &#123; taskRunner.Run(fc) &#125; else if contextRunner != nil &amp;&amp; contextRunner.IsDriverMode() &#123; contextRunner.Run(fc) &#125; else &#123; fc.runFlowContextInStandAloneMode() &#125;&#125; 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950func (fc *FlowContext) runFlowContextInStandAloneMode() &#123; // è®¾ç½®ä¸€ä¸ªç”¨äºç­‰äºåç¨‹å…¨éƒ¨è¿è¡Œå®Œæ¯•çš„è®¡æ•°`wg` var wg sync.WaitGroup // ç”Ÿæˆä¸€ä¸ª`map[int]bool`ç±»å‹çš„ç±»ä¼¼äº HashTable ä¸€æ ·çš„ K/V æ˜ å°„ç»“æ„çš„ Map ç±»å‹ isDatasetStarted := make(map[int]bool) // è®¾ç½®æ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·çš„å¤„ç†å›è°ƒå‡½æ•° OnInterrupt(fc.OnInterrupt, nil) // å¯åŠ¨æ‰€æœ‰çš„ä»»åŠ¡è¾¹ç•Œ // start all task edges for _, step := range fc.Steps &#123; // å¾ªç¯æ‰€æœ‰çš„Stepsï¼Œæ¯ä¸€ä¸ªAPIå°±ä»£è¡¨ä¸€ä¸ªStep for _, input := range step.Inputs &#123; // å¾ªç¯æ¯ä¸ªstepä¸­çš„Inputs if _, ok := isDatasetStarted[input.Id]; !ok &#123; // å¦‚æœDatasetå·²ç»å¯åŠ¨ï¼Œé‚£ä¹ˆå°±è·³è¿‡ï¼Œå¦åˆ™è¿›è¡Œå¯åŠ¨é€»è¾‘ wg.Add(1) // æ¯ä¸€æ¬¡éœ€è¦è¿è¡Œinputçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨+1 go func(input *Dataset) &#123; // æ¯ä¸€ä¸ªinputéƒ½å¯åŠ¨ä¸€ä¸ªåç¨‹è¿è¡Œä¸»é€»è¾‘ defer wg.Done() // æ¯ä¸ªåç¨‹ç»“æŸçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨-1 input.RunDatasetInStandAloneMode() // åœ¨åç¨‹ç¯å¢ƒä¸‹è¿è¡Œæ¯ä¸ªinputå¯åŠ¨è‡ªèº«é€»è¾‘ &#125;(input) isDatasetStarted[input.Id] = true // åˆ›å»ºåç¨‹å®Œæ¯•ä¹‹åè®¾ç½®è¿™ä¸ªinputå·²ç»å¤„ç†è¿‡äº† &#125; &#125; wg.Add(1) // æ¯ä¸€æ¬¡éœ€è¦è¿è¡Œstepçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨+1 go func(step *Step) &#123; // åˆ›å»ºåç¨‹è¿è¡Œä¸»é€»è¾‘ defer wg.Done() // æ¯ä¸ªåç¨‹ç»“æŸçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨-1 step.RunStep() // åœ¨åç¨‹ç¯å¢ƒä¸‹è¿è¡Œstepçš„è‡ªèº«é€»è¾‘ &#125;(step) if step.Output != nil &#123; // å¦‚æœstepçš„outputä¸ç­‰äºnilçš„è¯ï¼Œè¿›è¡Œé€»è¾‘ if _, ok := isDatasetStarted[step.Output.Id]; !ok &#123;// å¦‚æœæ²¡æœ‰è¿è¡Œè¿‡çš„è¯ï¼Œå°±è¿è¡Œå¦åˆ™å°±è·³å‡º wg.Add(1) // æ¯ä¸€æ¬¡éœ€è¦è¿è¡ŒOutputçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨+1 go func(step *Step) &#123; // åˆ›å»ºåç¨‹è¿è¡Œä¸»é€»è¾‘ defer wg.Done() // æ¯ä¸ªåç¨‹ç»“æŸçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨-1 step.Output.RunDatasetInStandAloneMode() // åœ¨åç¨‹ç¯å¢ƒä¸‹è¿è¡ŒOutputçš„è‡ªèº«é€»è¾‘ &#125;(step) isDatasetStarted[step.Output.Id] = true // åˆ›å»ºåç¨‹å®Œæ¯•ä¹‹åè®¾ç½®è¿™ä¸ªOutputå·²ç»å¤„ç†è¿‡äº† &#125; &#125; &#125; wg.Wait() // å½“æ‰€æœ‰åç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åå†é€€å‡ºä¸»åç¨‹&#125;/* æ€»ç»“ï¼š 1. step.Inputs å’Œ step.Output éƒ½æ˜¯Dataset 2. step.Inputsä¸­æ‰€æœ‰inputè¿è¡Œå®Œé€»è¾‘ä¹‹åï¼Œå†è¿è¡Œstepçš„é€»è¾‘ï¼Œæœ€åå†è¿è¡Œstepçš„Outpué€»è¾‘ï¼Œå†æ¥ç€ä¸‹ä¸€ä¸ªstep 3. æ¯ä¸ªé€»è¾‘çš„è¿è¡Œéƒ½æ˜¯åœ¨åˆ›å»ºåç¨‹ä¹‹åè¿è¡Œ*/ çœ‹åˆ°è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒæ ¸å¿ƒçš„æœ‰func (fc *FlowContext) runFlowContextInStandAloneMode()ï¼Œfunc (s *Step) RunStep()æˆ‘ä»¬å°±çœ‹åˆ°äº†æœ€ç»ˆçš„å…¥å£äº†ï¼Œè§£é‡Šæˆ‘å†™åœ¨ä»£ç ä¸­ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ input/Output è¿è¡Œçš„ä¸»é€»è¾‘ 12345678910111213141516171819202122232425262728293031323334353637383940414243func (d *Dataset) RunDatasetInStandAloneMode() &#123; // è®¾ç½®ä¸€ä¸ªç”¨äºç­‰äºåç¨‹å…¨éƒ¨è¿è¡Œå®Œæ¯•çš„è®¡æ•°`wg` var wg sync.WaitGroup if len(d.ExternalInputChans) &gt; 0 &#123; // å¦‚æœæ•°æ®é›†å­˜åœ¨å¤–éƒ¨chançš„è¯ d.connectExternalInputChansToRead(&amp;wg) // è¿æ¥å¤–éƒ¨chanè¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”å¦‚æœç”¨åˆ°åç¨‹çš„è¯ï¼Œéœ€è¦åŒæ­¥æ›´æ–°åç¨‹è®¡æ•°å™¨ for _, shard := range d.Shards &#123; // å¾ªç¯æ•°æ®é›†çš„åˆ†ç‰‡ shard.SetupReadingChans() // æ•°æ®é›†åˆ†ç‰‡è¿è¡Œä¸»è¦é€»è¾‘ &#125; &#125; else &#123; // å¦‚æœä¸å­˜åœ¨å¤–éƒ¨chançš„è¯ for _, shard := range d.Shards &#123; // å¾ªç¯æ•°æ®é›†çš„åˆ†ç‰‡ wg.Add(1) // æ¯ä¸€æ¬¡éœ€è¦è¿è¡Œæ•°æ®åˆ†ç‰‡çš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨+1 go func(shard *DatasetShard) &#123; // åˆ›å»ºåç¨‹è¿è¡Œä¸»é€»è¾‘ defer wg.Done() // æ¯ä¸ªåç¨‹ç»“æŸçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨-1 // println(\"setup shard reading chans\", shard.Name()) shard.SetupReadingChans() // æ•°æ®åˆ†ç‰‡éƒ¨ç½²è¯»å–çš„æ•°æ®çš„chan // start to run var t reflect.Value // å®šä¹‰ä¸ªreflect.Valueçš„ç±»å‹ for ok := true; ok; &#123; // æ­»å¾ªç¯ if t, ok = shard.WriteChan.Recv(); ok &#123; // \b\b\b\b\b\bæ•°æ®åˆ†ç‰‡å†™chané˜»å¡æ¥æ”¶æ•°æ®ï¼Œå¦‚æœæœ‰æ•°æ®æ¥çš„è¯å°±æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ shard.SendForRead(t) // æ•°æ®åˆ†ç‰‡å‘é€æ•°æ®åˆ°Readchanï¼Œå‚æ•°ä¸ºreflect.Valueç±»å‹ // hookup output channels d.sendToExternalOutputChans(t) // å‘é€æ•°æ®åˆ°å¤–éƒ¨OutputChan &#125; &#125; // println(\"close shard reading\", shard.Name()) shard.CloseRead() // æ•°æ®åˆ†ç‰‡å…³é—­ &#125;(shard) &#125; &#125; wg.Wait() // å½“æ‰€æœ‰åç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åå†è¿è¡Œä¸‹é¢çš„é€»è¾‘ d.closeExternalOutputChans() // å…³é—­å¤–éƒ¨Outputchan return/* æ€»ç»“ï¼š 1. æ¯ä¸ªæ•°æ®åˆ†ç‰‡éƒ½éœ€è¦å…³è”Taskä¸­çš„inputçš„chan 2. å½“æ•°æ®åˆ†ç‰‡çš„WriteChanå¯è¯»å–çš„æ—¶å€™ï¼ŒæŠŠæ•°æ®ä¼ é€’ç»™readingChans 3. å‘é€å®Œæ¯•ä¹‹åï¼Œè¿˜ä¼šè®°å½•å…³é—­æ—¶é—´*/&#125; 12345678910111213141516171819202122232425262728293031func (shard *DatasetShard) SetupReadingChans() &#123; // get unique list of tasks since ReadingTasks can have duplicates // especially when one dataset is used twice in a task, e.g. selfJoin() // è·å–å”¯ä¸€çš„ä»»åŠ¡åˆ—è¡¨ï¼Œå› ä¸ºReadingTaskså¯èƒ½æœ‰é‡å¤çš„ä»»åŠ¡ // ç‰¹åˆ«æ˜¯å½“ä¸€ä¸ªæ•°æ®é›†åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­ä½¿ç”¨ä¸¤æ¬¡æ—¶ï¼Œä¾‹å¦‚selfJoin() // å®šä¹‰å˜é‡uniqTasks var uniqTasks []*Task // ç”Ÿæˆä¸€ä¸ª`map[*Task]bool`ç±»å‹çš„ç±»ä¼¼äº HashTable ä¸€æ ·çš„ K/V æ˜ å°„ç»“æ„çš„ Map ç±»å‹ seenTasks := make(map[*Task]bool) for _, task := range shard.ReadingTasks &#123; // å¾ªç¯æ•°æ®åˆ†ç‰‡ä¸­çš„ReadingTasksï¼Œè¯»å–ä»»åŠ¡ if ok := seenTasks[task]; ok &#123; // å¦‚æœä»»åŠ¡å·²ç»å¤„ç†è¿‡äº†ï¼Œå°±å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡ continue &#125; seenTasks[task] = true // å¼€å§‹å¤„ç†ä»»åŠ¡ï¼Œè®¾ç½®ä¸ºtrue uniqTasks = append(uniqTasks, task) // åŠ å…¥uniqTasksçš„list &#125; shard.lock.Lock() // æ•°æ®åˆ†ç‰‡ä¸ŠåŠ ä¸Š`RWMutex`ï¼Œå¹¶ä¸”è¿›è¡Œå†™é” defer shard.lock.Unlock() // å‡½æ•°ç»“æŸçš„æ—¶å€™ï¼Œè¿›è¡Œå†™è§£é” for _, task := range uniqTasks &#123; // å†å†™é”è¯»æƒ…å†µä¸‹è¿›è¡Œï¼šå¾ªç¯å”¯ä¸€çš„Tasks for i, s := range task.Inputs &#123; // å¾ªç¯æ¯ä¸ªTaskçš„Inputs if s == shard &#123; // æ‰¾åˆ°å¯¹åº”çš„ç´¢å¼•i shard.readingChans = append(shard.readingChans, task.InputChans[i]) // æŠŠè¾“å…¥ä»»åŠ¡ä¸Šçš„inputchanåŠ å…¥åˆ°åˆ†åŒºéœ€è¦è¯»å–çš„chanå» &#125; &#125; &#125; shard.ReadyTime = time.Now() // æ•°æ®åˆ†ç‰‡å‡†å¤‡å°±ç»ªçš„æ—¶é—´ // fmt.Printf(\"shard %s has reading tasks:%d channel:%d\\n\", shard.Name(), len(shard.ReadingTasks), len(shard.readingChans))&#125; 12345678910func (s *DatasetShard) SendForRead(t reflect.Value) &#123; s.lock.RLock() // æ•°æ®åˆ†ç‰‡è¿›è¡Œè¯»é” defer s.lock.RUnlock() // æ•°ç»“æŸçš„æ—¶å€™ï¼Œè¿›è¡Œè¯»è§£é” s.Counter++ // å‘é€æ¬¡æ•°+1 for _, c := range s.readingChans &#123; // å¾€è¯»chanå‘é€æ•°æ® // println(s.Name(), \"send chan\", i, \"entry:\", s.counter) c &lt;- t &#125;&#125; 123456789func (s *DatasetShard) CloseRead() &#123; s.lock.RLock() // æ•°æ®åˆ†ç‰‡è¿›è¡Œè¯»é” defer s.lock.RUnlock() // æ•°ç»“æŸçš„æ—¶å€™ï¼Œè¿›è¡Œè¯»è§£é” for _, c := range s.readingChans &#123; close(c) // å…³é—­æ‰€æœ‰è¯»chan &#125; s.CloseTime = time.Now() // è®°å½•å…³é—­æ—¶é—´&#125; æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ RunStep çš„ä¸»é€»è¾‘ï¼š 1234567891011121314func (s *Step) RunStep() &#123; // è®¾ç½®ä¸€ä¸ªç”¨äºç­‰äºåç¨‹å…¨éƒ¨è¿è¡Œå®Œæ¯•çš„è®¡æ•°`wg` var wg sync.WaitGroup for i, t := range s.Tasks &#123; // å¾ªç¯æ‰€æœ‰Stepçš„ä»»åŠ¡ wg.Add(1) // æ¯ä¸€æ¬¡éœ€è¦è¿è¡Œæ•°æ®åˆ†ç‰‡çš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨+1 go func(i int, t *Task) &#123; // åˆ›å»ºåç¨‹è¿è¡Œä¸»é€»è¾‘ defer wg.Done() // æ¯ä¸ªåç¨‹ç»“æŸçš„æ—¶å€™ï¼Œåç¨‹è®¡æ•°å™¨-1 t.RunTask() // è¿è¡Œä»»åŠ¡çš„ä¸»é€»è¾‘ &#125;(i, t) &#125; wg.Wait() // å½“æ‰€æœ‰åç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰ç®—å®Œæ¯• return&#125; 1234567891011121314// source -&gt;w:ds:r -&gt; task -&gt; w:ds:r// source close next ds' w chan// ds close its own r chan// task closes its own channel to next ds' w:dsfunc (t *Task) RunTask() &#123; // println(\"start\", t.Name()) t.Step.Function(t) // è¿è¡Œæ¯ä¸€ä¸ªStepè‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘å‡½æ•° for _, out := range t.Outputs &#123; // println(t.Name(), \"close WriteChan of\", out.Name()) out.WriteChan.Close() // å…³é—­æ¯ä¸ªoutputçš„chanï¼Œé‚£ä¸ªæ¯ä¸ªStep.Functionä¸­çš„åç¨‹å°†ä¼šç»“æŸ &#125; // println(\"stop\", t.Name()) &#125; å›åˆ°æˆ‘ä»¬çš„ç¨‹åºï¼š ================= 123456789101112131415161718192021func (fc *FlowContext) TextFile(fname string, shard int) (ret *Dataset) &#123; fn := func(out chan string) &#123; file, err := os.Open(fname) if err != nil &#123; // FIXME collect errors log.Panicf(\"Can not open file %s: %v\", fname, err) return &#125; defer file.Close() scanner := bufio.NewScanner(file) for scanner.Scan() &#123; out &lt;- scanner.Text() &#125; if err := scanner.Err(); err != nil &#123; log.Printf(\"Scan file %s: %v\", fname, err) &#125; &#125; return fc.Source(fn, shard)&#125; è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°func (fc *FlowContext) TextFile(fname string, shard int) (ret *Dataset)ï¼Œ 12345678910111213141516171819202122232425262728293031323334353637383940// Source returns a new Dataset which evenly distributes the data items produced by f// among multiple shards. f must be a function defined in the form func(chan &lt;some_type&gt;).func (fc *FlowContext) Source(f interface&#123;&#125;, shard int) (ret *Dataset) &#123; ret = fc.newNextDataset(shard, guessFunctionOutputType(f)) step := fc.AddOneToAllStep(nil, ret) step.Name = \"Source\" step.Function = func(task *Task) &#123; ctype := reflect.ChanOf(reflect.BothDir, ret.Type) outChan := reflect.MakeChan(ctype, 0) fn := reflect.ValueOf(f) var wg sync.WaitGroup wg.Add(1) go func() &#123; defer wg.Done() defer outChan.Close() fn.Call([]reflect.Value&#123;outChan&#125;) &#125;() wg.Add(1) go func() &#123; defer wg.Done() var t reflect.Value i := 0 for ok := true; ok; &#123; if t, ok = outChan.Recv(); ok &#123; task.Outputs[i].WriteChan.Send(t) i++ if i == shard &#123; i = 0 &#125; &#125; &#125; &#125;() wg.Wait() &#125; return&#125;","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"Golang","slug":"å¤§æ•°æ®/Golang","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/Golang/"}],"tags":[{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"},{"name":"å¤§æ•°æ®ï¼Œæµå¼è®¡ç®—","slug":"å¤§æ•°æ®ï¼Œæµå¼è®¡ç®—","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"}]},{"title":"ã€ç½‘ç»œåè®®ã€‘TCP - tcpdumpç”¨æ³•","slug":"ç½‘ç»œåè®®/TCP-tcpdump","date":"2019-08-07T07:57:13.000Z","updated":"2021-03-20T16:25:01.822Z","comments":true,"path":"2019/08/07/ç½‘ç»œåè®®/TCP-tcpdump/","link":"","permalink":"http://blog.crazylaw.cn/2019/08/07/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/TCP-tcpdump/","excerpt":"å‰è¨€ç”±äºæˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šç¼–ç¨‹æˆ–è€…è°ƒè¯•çš„æ—¶å€™ï¼Œéƒ½ä¸å¯èƒ½æ˜¯å„ç§æŠ“åŒ…å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å­¦ä¼šè¿ç”¨ tcpdump æ¥å¯¹ç½‘ç»œçš„æ•°æ®è¿›è¡ŒæŠ“åŒ…ã€‚ç”¨ç®€å•çš„è¯æ¥å®šä¹‰ tcpdumpï¼Œå°±æ˜¯ï¼šdump the traffic on a networkï¼Œæ ¹æ®ä½¿ç”¨è€…çš„å®šä¹‰å¯¹ç½‘ç»œä¸Šçš„æ•°æ®åŒ…è¿›è¡Œæˆªè·çš„åŒ…åˆ†æå·¥å…·ã€‚ tcpdump å¯ä»¥å°†ç½‘ç»œä¸­ä¼ é€çš„æ•°æ®åŒ…çš„â€œå¤´â€å®Œå…¨æˆªè·ä¸‹æ¥æä¾›åˆ†æã€‚å®ƒæ”¯æŒé’ˆå¯¹ç½‘ç»œå±‚ã€åè®®ã€ä¸»æœºã€ç½‘ç»œæˆ–ç«¯å£çš„è¿‡æ»¤ï¼Œå¹¶æä¾› andã€orã€not ç­‰é€»è¾‘è¯­å¥æ¥å¸®åŠ©ä½ å»æ‰æ— ç”¨çš„ä¿¡æ¯ã€‚","text":"å‰è¨€ç”±äºæˆ‘ä»¬åœ¨æœåŠ¡å™¨ä¸Šç¼–ç¨‹æˆ–è€…è°ƒè¯•çš„æ—¶å€™ï¼Œéƒ½ä¸å¯èƒ½æ˜¯å„ç§æŠ“åŒ…å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å­¦ä¼šè¿ç”¨ tcpdump æ¥å¯¹ç½‘ç»œçš„æ•°æ®è¿›è¡ŒæŠ“åŒ…ã€‚ç”¨ç®€å•çš„è¯æ¥å®šä¹‰ tcpdumpï¼Œå°±æ˜¯ï¼šdump the traffic on a networkï¼Œæ ¹æ®ä½¿ç”¨è€…çš„å®šä¹‰å¯¹ç½‘ç»œä¸Šçš„æ•°æ®åŒ…è¿›è¡Œæˆªè·çš„åŒ…åˆ†æå·¥å…·ã€‚ tcpdump å¯ä»¥å°†ç½‘ç»œä¸­ä¼ é€çš„æ•°æ®åŒ…çš„â€œå¤´â€å®Œå…¨æˆªè·ä¸‹æ¥æä¾›åˆ†æã€‚å®ƒæ”¯æŒé’ˆå¯¹ç½‘ç»œå±‚ã€åè®®ã€ä¸»æœºã€ç½‘ç»œæˆ–ç«¯å£çš„è¿‡æ»¤ï¼Œå¹¶æä¾› andã€orã€not ç­‰é€»è¾‘è¯­å¥æ¥å¸®åŠ©ä½ å»æ‰æ— ç”¨çš„ä¿¡æ¯ã€‚ å‘½ä»¤è¯´æ˜123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130-A ä»¥ASCIIç æ–¹å¼æ˜¾ç¤ºæ¯ä¸€ä¸ªæ•°æ®åŒ…(ä¸ä¼šæ˜¾ç¤ºæ•°æ®åŒ…ä¸­é“¾è·¯å±‚å¤´éƒ¨ä¿¡æ¯). åœ¨æŠ“å–åŒ…å«ç½‘é¡µæ•°æ®çš„æ•°æ®åŒ…æ—¶, å¯æ–¹ä¾¿æŸ¥çœ‹æ•°æ®(nt: å³Handy for capturing web pages).-c count tcpdumpå°†åœ¨æ¥å—åˆ°countä¸ªæ•°æ®åŒ…åé€€å‡º.-C file-size (nt: æ­¤é€‰é¡¹ç”¨äºé…åˆ-w file é€‰é¡¹ä½¿ç”¨) è¯¥é€‰é¡¹ä½¿å¾—tcpdump åœ¨æŠŠåŸå§‹æ•°æ®åŒ…ç›´æ¥ä¿å­˜åˆ°æ–‡ä»¶ä¸­ä¹‹å‰, æ£€æŸ¥æ­¤æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡file-size. å¦‚æœè¶…è¿‡äº†, å°†å…³é—­æ­¤æ–‡ä»¶,å¦åˆ›ä¸€ä¸ªæ–‡ä»¶ç»§ç»­ç”¨äºåŸå§‹æ•°æ®åŒ…çš„è®°å½•. æ–°åˆ›å»ºçš„æ–‡ä»¶åä¸-w é€‰é¡¹æŒ‡å®šçš„æ–‡ä»¶åä¸€è‡´, ä½†æ–‡ä»¶ååå¤šäº†ä¸€ä¸ªæ•°å­—.è¯¥æ•°å­—ä¼šä»1å¼€å§‹éšç€æ–°åˆ›å»ºæ–‡ä»¶çš„å¢å¤šè€Œå¢åŠ . file-sizeçš„å•ä½æ˜¯ç™¾ä¸‡å­—èŠ‚(nt: è¿™é‡ŒæŒ‡1,000,000ä¸ªå­—èŠ‚,å¹¶é1,048,576ä¸ªå­—èŠ‚, åè€…æ˜¯ä»¥1024å­—èŠ‚ä¸º1k, 1024kå­—èŠ‚ä¸º1Mè®¡ç®—æ‰€å¾—, å³1M&#x3D;1024 ï¼Š 1024 ï¼ 1,048,576)-d ä»¥å®¹æ˜“é˜…è¯»çš„å½¢å¼,åœ¨æ ‡å‡†è¾“å‡ºä¸Šæ‰“å°å‡ºç¼–æ’è¿‡çš„åŒ…åŒ¹é…ç , éšåtcpdumpåœæ­¢.(nt | rt: human readable, å®¹æ˜“é˜…è¯»çš„,é€šå¸¸æ˜¯æŒ‡ä»¥asciiç æ¥æ‰“å°ä¸€äº›ä¿¡æ¯. compiled, ç¼–æ’è¿‡çš„. packet-matching code, åŒ…åŒ¹é…ç ,å«ä¹‰æœªçŸ¥, éœ€è¡¥å……)-dd ä»¥Cè¯­è¨€çš„å½¢å¼æ‰“å°å‡ºåŒ…åŒ¹é…ç .-ddd ä»¥åè¿›åˆ¶æ•°çš„å½¢å¼æ‰“å°å‡ºåŒ…åŒ¹é…ç (ä¼šåœ¨åŒ…åŒ¹é…ç ä¹‹å‰æœ‰ä¸€ä¸ªé™„åŠ çš„&#39;count&#39;å‰ç¼€).-D æ‰“å°ç³»ç»Ÿä¸­æ‰€æœ‰tcpdumpå¯ä»¥åœ¨å…¶ä¸Šè¿›è¡ŒæŠ“åŒ…çš„ç½‘ç»œæ¥å£. æ¯ä¸€ä¸ªæ¥å£ä¼šæ‰“å°å‡ºæ•°å­—ç¼–å·, ç›¸åº”çš„æ¥å£åå­—, ä»¥åŠå¯èƒ½çš„ä¸€ä¸ªç½‘ç»œæ¥å£æè¿°. å…¶ä¸­ç½‘ç»œæ¥å£åå­—å’Œæ•°å­—ç¼–å·å¯ä»¥ç”¨åœ¨tcpdump çš„-i flag é€‰é¡¹(nt: æŠŠåå­—æˆ–æ•°å­—ä»£æ›¿flag), æ¥æŒ‡å®šè¦åœ¨å…¶ä¸ŠæŠ“åŒ…çš„ç½‘ç»œæ¥å£. æ­¤é€‰é¡¹åœ¨ä¸æ”¯æŒæ¥å£åˆ—è¡¨å‘½ä»¤çš„ç³»ç»Ÿä¸Šå¾ˆæœ‰ç”¨(nt: æ¯”å¦‚, Windows ç³»ç»Ÿ, æˆ–ç¼ºä¹ ifconfig -a çš„UNIXç³»ç»Ÿ); æ¥å£çš„æ•°å­—ç¼–å·åœ¨windows 2000 æˆ–å…¶åçš„ç³»ç»Ÿä¸­å¾ˆæœ‰ç”¨, å› ä¸ºè¿™äº›ç³»ç»Ÿä¸Šçš„æ¥å£åå­—æ¯”è¾ƒå¤æ‚, è€Œä¸æ˜“ä½¿ç”¨. å¦‚æœtcpdumpç¼–è¯‘æ—¶æ‰€ä¾èµ–çš„libpcapåº“å¤ªè€,-D é€‰é¡¹ä¸ä¼šè¢«æ”¯æŒ, å› ä¸ºå…¶ä¸­ç¼ºä¹ pcap_findalldevs()å‡½æ•°.-e æ¯è¡Œçš„æ‰“å°è¾“å‡ºä¸­å°†åŒ…æ‹¬æ•°æ®åŒ…çš„æ•°æ®é“¾è·¯å±‚å¤´éƒ¨ä¿¡æ¯-E spi@ipaddr algo:secret,... å¯é€šè¿‡spi@ipaddr algo:secret æ¥è§£å¯†IPsec ESPåŒ…(nt | rt:IPsec Encapsulating Security Payload,IPsec å°è£…å®‰å…¨è´Ÿè½½, IPsecå¯ç†è§£ä¸º, ä¸€æ•´å¥—å¯¹ipæ•°æ®åŒ…çš„åŠ å¯†åè®®, ESP ä¸ºæ•´ä¸ªIP æ•°æ®åŒ…æˆ–å…¶ä¸­ä¸Šå±‚åè®®éƒ¨åˆ†è¢«åŠ å¯†åçš„æ•°æ®,å‰è€…çš„å·¥ä½œæ¨¡å¼ç§°ä¸ºéš§é“æ¨¡å¼; åè€…çš„å·¥ä½œæ¨¡å¼ç§°ä¸ºä¼ è¾“æ¨¡å¼ . å·¥ä½œåŸç†, å¦éœ€è¡¥å……). éœ€è¦æ³¨æ„çš„æ˜¯, åœ¨ç»ˆç«¯å¯åŠ¨tcpdump æ—¶, å¯ä»¥ä¸ºIPv4 ESP packets è®¾ç½®å¯†é’¥(secretï¼‰. å¯ç”¨äºåŠ å¯†çš„ç®—æ³•åŒ…æ‹¬des-cbc, 3des-cbc, blowfish-cbc, rc3-cbc, cast128-cbc, æˆ–è€…æ²¡æœ‰(none).é»˜è®¤çš„æ˜¯des-cbc(nt: des, Data Encryption Standard, æ•°æ®åŠ å¯†æ ‡å‡†, åŠ å¯†ç®—æ³•æœªçŸ¥, å¦éœ€è¡¥å……).secret ä¸ºç”¨äºESP çš„å¯†é’¥, ä½¿ç”¨ASCII å­—ç¬¦ä¸²æ–¹å¼è¡¨è¾¾. å¦‚æœä»¥ 0x å¼€å¤´, è¯¥å¯†é’¥å°†ä»¥16è¿›åˆ¶æ–¹å¼è¯»å…¥. è¯¥é€‰é¡¹ä¸­ESP çš„å®šä¹‰éµå¾ªRFC2406, è€Œä¸æ˜¯ RFC1827. å¹¶ä¸”, æ­¤é€‰é¡¹åªæ˜¯ç”¨æ¥è°ƒè¯•çš„, ä¸æ¨èä»¥çœŸå®å¯†é’¥(secret)æ¥ä½¿ç”¨è¯¥é€‰é¡¹, å› ä¸ºè¿™æ ·ä¸å®‰å…¨: åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥çš„secret å¯ä»¥è¢«å…¶ä»–äººé€šè¿‡ps ç­‰å‘½ä»¤æŸ¥çœ‹åˆ°. é™¤äº†ä»¥ä¸Šçš„è¯­æ³•æ ¼å¼(nt: æŒ‡spi@ipaddr algo:secret), è¿˜å¯ä»¥åœ¨åé¢æ·»åŠ ä¸€ä¸ªè¯­æ³•è¾“å…¥æ–‡ä»¶åå­—ä¾›tcpdump ä½¿ç”¨(ntï¼šå³æŠŠspi@ipaddr algo:secret,... ä¸­...æ¢æˆä¸€ä¸ªè¯­æ³•æ–‡ä»¶å). æ­¤æ–‡ä»¶åœ¨æ¥å—åˆ°ç¬¬ä¸€ä¸ªESP åŒ…æ—¶ä¼šæ‰“å¼€æ­¤æ–‡ä»¶, æ‰€ä»¥æœ€å¥½æ­¤æ—¶æŠŠèµ‹äºˆtcpdump çš„ä¸€äº›ç‰¹æƒå–æ¶ˆ(nt: å¯ç†è§£ä¸º, è¿™æ ·é˜²èŒƒä¹‹å, å½“è¯¥æ–‡ä»¶ä¸ºæ¶æ„ç¼–å†™æ—¶,ä¸è‡³äºé€ æˆè¿‡å¤§æŸå®³).-f æ˜¾ç¤ºå¤–éƒ¨çš„IPv4 åœ°å€æ—¶(nt: foreign IPv4 addresses, å¯ç†è§£ä¸º, éæœ¬æœºipåœ°å€), é‡‡ç”¨æ•°å­—æ–¹å¼è€Œä¸æ˜¯åå­—.(æ­¤é€‰é¡¹æ˜¯ç”¨æ¥å¯¹ä»˜Sunå…¬å¸çš„NISæœåŠ¡å™¨çš„ç¼ºé™·(nt: NIS, ç½‘ç»œä¿¡æ¯æœåŠ¡, tcpdump æ˜¾ç¤ºå¤–éƒ¨åœ°å€çš„åå­—æ—¶ä¼šç”¨åˆ°å¥¹æä¾›çš„åç§°æœåŠ¡): æ­¤NISæœåŠ¡å™¨åœ¨æŸ¥è¯¢éæœ¬åœ°åœ°å€åå­—æ—¶,å¸¸å¸¸ä¼šé™·å…¥æ— å°½çš„æŸ¥è¯¢å¾ªç¯). ç”±äºå¯¹å¤–éƒ¨(foreign)IPv4åœ°å€çš„æµ‹è¯•éœ€è¦ç”¨åˆ°æœ¬åœ°ç½‘ç»œæ¥å£(nt: tcpdump æŠ“åŒ…æ—¶ç”¨åˆ°çš„æ¥å£)åŠå…¶IPv4 åœ°å€å’Œç½‘ç»œæ©ç . å¦‚æœæ­¤åœ°å€æˆ–ç½‘ç»œæ©ç ä¸å¯ç”¨, æˆ–è€…æ­¤æ¥å£æ ¹æœ¬å°±æ²¡æœ‰è®¾ç½®ç›¸åº”ç½‘ç»œåœ°å€å’Œç½‘ç»œæ©ç (nt: linux ä¸‹çš„ &#39;any&#39; ç½‘ç»œæ¥å£å°±ä¸éœ€è¦è®¾ç½®åœ°å€å’Œæ©ç , ä¸è¿‡æ­¤&#39;any&#39;æ¥å£å¯ä»¥æ”¶åˆ°ç³»ç»Ÿä¸­æ‰€æœ‰æ¥å£çš„æ•°æ®åŒ…), è¯¥é€‰é¡¹ä¸èƒ½æ­£å¸¸å·¥ä½œ.-F file ä½¿ç”¨file æ–‡ä»¶ä½œä¸ºè¿‡æ»¤æ¡ä»¶è¡¨è¾¾å¼çš„è¾“å…¥, æ­¤æ—¶å‘½ä»¤è¡Œä¸Šçš„è¾“å…¥å°†è¢«å¿½ç•¥.-i interface æŒ‡å®štcpdump éœ€è¦ç›‘å¬çš„æ¥å£. å¦‚æœæ²¡æœ‰æŒ‡å®š, tcpdump ä¼šä»ç³»ç»Ÿæ¥å£åˆ—è¡¨ä¸­æœå¯»ç¼–å·æœ€å°çš„å·²é…ç½®å¥½çš„æ¥å£(ä¸åŒ…æ‹¬ loopback æ¥å£).ä¸€ä½†æ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æ¥å£, æœå¯»é©¬ä¸Šç»“æŸ. åœ¨é‡‡ç”¨2.2ç‰ˆæœ¬æˆ–ä¹‹åç‰ˆæœ¬å†…æ ¸çš„Linux æ“ä½œç³»ç»Ÿä¸Š, &#39;any&#39; è¿™ä¸ªè™šæ‹Ÿç½‘ç»œæ¥å£å¯è¢«ç”¨æ¥æ¥æ”¶æ‰€æœ‰ç½‘ç»œæ¥å£ä¸Šçš„æ•°æ®åŒ…(nt: è¿™ä¼šåŒ…æ‹¬ç›®çš„æ˜¯è¯¥ç½‘ç»œæ¥å£çš„, ä¹ŸåŒ…æ‹¬ç›®çš„ä¸æ˜¯è¯¥ç½‘ç»œæ¥å£çš„). éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœçœŸå®ç½‘ç»œæ¥å£ä¸èƒ½å·¥ä½œåœ¨&#39;æ··æ‚&#39;æ¨¡å¼(promiscuous)ä¸‹,åˆ™æ— æ³•åœ¨&#39;any&#39;è¿™ä¸ªè™šæ‹Ÿçš„ç½‘ç»œæ¥å£ä¸ŠæŠ“å–å…¶æ•°æ®åŒ…. å¦‚æœ -D æ ‡å¿—è¢«æŒ‡å®š, tcpdumpä¼šæ‰“å°ç³»ç»Ÿä¸­çš„æ¥å£ç¼–å·ï¼Œè€Œè¯¥ç¼–å·å°±å¯ç”¨äºæ­¤å¤„çš„interface å‚æ•°.-l å¯¹æ ‡å‡†è¾“å‡ºè¿›è¡Œè¡Œç¼“å†²(nt: ä½¿æ ‡å‡†è¾“å‡ºè®¾å¤‡é‡åˆ°ä¸€ä¸ªæ¢è¡Œç¬¦å°±é©¬ä¸ŠæŠŠè¿™è¡Œçš„å†…å®¹æ‰“å°å‡ºæ¥).åœ¨éœ€è¦åŒæ—¶è§‚å¯ŸæŠ“åŒ…æ‰“å°ä»¥åŠä¿å­˜æŠ“åŒ…è®°å½•çš„æ—¶å€™å¾ˆæœ‰ç”¨. æ¯”å¦‚, å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç»„åˆæ¥è¾¾åˆ°æ­¤ç›®çš„: &#96;&#96;tcpdump -l | tee dat&#39;&#39; æˆ–è€… &#96;&#96;tcpdump -l &gt; dat &amp; tail -f dat&#39;&#39;.(nt: å‰è€…ä½¿ç”¨teeæ¥æŠŠtcpdump çš„è¾“å‡ºåŒæ—¶æ”¾åˆ°æ–‡ä»¶datå’Œæ ‡å‡†è¾“å‡ºä¸­, è€Œåè€…é€šè¿‡é‡å®šå‘æ“ä½œ&#39;&gt;&#39;, æŠŠtcpdumpçš„è¾“å‡ºæ”¾åˆ°dat æ–‡ä»¶ä¸­, åŒæ—¶é€šè¿‡tailæŠŠdatæ–‡ä»¶ä¸­çš„å†…å®¹æ”¾åˆ°æ ‡å‡†è¾“å‡ºä¸­)-L åˆ—å‡ºæŒ‡å®šç½‘ç»œæ¥å£æ‰€æ”¯æŒçš„æ•°æ®é“¾è·¯å±‚çš„ç±»å‹åé€€å‡º.(nt: æŒ‡å®šæ¥å£é€šè¿‡-i æ¥æŒ‡å®š)-m module é€šè¿‡module æŒ‡å®šçš„file è£…è½½SMI MIB æ¨¡å—(nt: SMIï¼ŒStructure of Management Information, ç®¡ç†ä¿¡æ¯ç»“æ„MIB, Management Information Base, ç®¡ç†ä¿¡æ¯åº“. å¯ç†è§£ä¸º, è¿™ä¸¤è€…ç”¨äºSNMP(Simple Network Management Protoco)åè®®æ•°æ®åŒ…çš„æŠ“å–. å…·ä½“SNMP çš„å·¥ä½œåŸç†æœªçŸ¥, å¦éœ€è¡¥å……). æ­¤é€‰é¡¹å¯å¤šæ¬¡ä½¿ç”¨, ä»è€Œä¸ºtcpdump è£…è½½ä¸åŒçš„MIB æ¨¡å—.-M secret å¦‚æœTCP æ•°æ®åŒ…(TCP segments)æœ‰TCP-MD5é€‰é¡¹(åœ¨RFC 2385æœ‰ç›¸å…³æè¿°), åˆ™ä¸ºå…¶æ‘˜è¦çš„éªŒè¯æŒ‡å®šä¸€ä¸ªå…¬å…±çš„å¯†é’¥secret.-n ä¸å¯¹åœ°å€(æ¯”å¦‚, ä¸»æœºåœ°å€, ç«¯å£å·)è¿›è¡Œæ•°å­—è¡¨ç¤ºåˆ°åå­—è¡¨ç¤ºçš„è½¬æ¢.-N ä¸æ‰“å°å‡ºhost çš„åŸŸåéƒ¨åˆ†. æ¯”å¦‚, å¦‚æœè®¾ç½®äº†æ­¤é€‰ç°, tcpdump å°†ä¼šæ‰“å°&#39;nic&#39; è€Œä¸æ˜¯ &#39;nic.ddn.mil&#39;.-O ä¸å¯ç”¨è¿›è¡ŒåŒ…åŒ¹é…æ—¶æ‰€ç”¨çš„ä¼˜åŒ–ä»£ç . å½“æ€€ç–‘æŸäº›bugæ˜¯ç”±ä¼˜åŒ–ä»£ç å¼•èµ·çš„, æ­¤é€‰é¡¹å°†å¾ˆæœ‰ç”¨.-p ä¸€èˆ¬æƒ…å†µä¸‹, æŠŠç½‘ç»œæ¥å£è®¾ç½®ä¸ºé&#39;æ··æ‚&#39;æ¨¡å¼. ä½†å¿…é¡»æ³¨æ„ , åœ¨ç‰¹æ®Šæƒ…å†µä¸‹æ­¤ç½‘ç»œæ¥å£è¿˜æ˜¯ä¼šä»¥&#39;æ··æ‚&#39;æ¨¡å¼æ¥å·¥ä½œï¼› ä»è€Œ, &#39;-p&#39; çš„è®¾ä¸ä¸è®¾, ä¸èƒ½å½“åšä»¥ä¸‹é€‰ç°çš„ä»£åè¯:&#39;ether host &#123;local-hw-add&#125;&#39; æˆ– &#39;ether broadcast&#39;(nt: å‰è€…è¡¨ç¤ºåªåŒ¹é…ä»¥å¤ªç½‘åœ°å€ä¸ºhost çš„åŒ…, åè€…è¡¨ç¤ºåŒ¹é…ä»¥å¤ªç½‘åœ°å€ä¸ºå¹¿æ’­åœ°å€çš„æ•°æ®åŒ…).-q å¿«é€Ÿ(ä¹Ÿè®¸ç”¨&#39;å®‰é™&#39;æ›´å¥½?)æ‰“å°è¾“å‡º. å³æ‰“å°å¾ˆå°‘çš„åè®®ç›¸å…³ä¿¡æ¯, ä»è€Œè¾“å‡ºè¡Œéƒ½æ¯”è¾ƒç®€çŸ­.-R è®¾å®štcpdump å¯¹ ESP&#x2F;AH æ•°æ®åŒ…çš„è§£ææŒ‰ç…§ RFC1825è€Œä¸æ˜¯RFC1829(nt: AH, è®¤è¯å¤´, ESPï¼Œ å®‰å…¨è´Ÿè½½å°è£…, è¿™ä¸¤è€…ä¼šç”¨åœ¨IPåŒ…çš„å®‰å…¨ä¼ è¾“æœºåˆ¶ä¸­). å¦‚æœæ­¤é€‰é¡¹è¢«è®¾ç½®, tcpdump å°†ä¸ä¼šæ‰“å°å‡º&#39;ç¦æ­¢ä¸­ç»§&#39;åŸŸ(nt: relay prevention field). å¦å¤–,ç”±äºESP&#x2F;AHè§„èŒƒä¸­æ²¡æœ‰è§„å®šESP&#x2F;AHæ•°æ®åŒ…å¿…é¡»æ‹¥æœ‰åè®®ç‰ˆæœ¬å·åŸŸ,æ‰€ä»¥tcpdumpä¸èƒ½ä»æ”¶åˆ°çš„ESP&#x2F;AHæ•°æ®åŒ…ä¸­æ¨å¯¼å‡ºåè®®ç‰ˆæœ¬å·.-r file ä»æ–‡ä»¶file ä¸­è¯»å–åŒ…æ•°æ®. å¦‚æœfile å­—æ®µä¸º &#39;-&#39; ç¬¦å·, åˆ™tcpdump ä¼šä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–åŒ…æ•°æ®.-S æ‰“å°TCP æ•°æ®åŒ…çš„é¡ºåºå·æ—¶, ä½¿ç”¨ç»å¯¹çš„é¡ºåºå·, è€Œä¸æ˜¯ç›¸å¯¹çš„é¡ºåºå·.(nt: ç›¸å¯¹é¡ºåºå·å¯ç†è§£ä¸º, ç›¸å¯¹ç¬¬ä¸€ä¸ªTCP åŒ…é¡ºåºå·çš„å·®è·,æ¯”å¦‚, æ¥å—æ–¹æ”¶åˆ°ç¬¬ä¸€ä¸ªæ•°æ®åŒ…çš„ç»å¯¹é¡ºåºå·ä¸º232323, å¯¹äºåæ¥æ¥æ”¶åˆ°çš„ç¬¬2ä¸ª,ç¬¬3ä¸ªæ•°æ®åŒ…, tcpdumpä¼šæ‰“å°å…¶åºåˆ—å·ä¸º1, 2åˆ†åˆ«è¡¨ç¤ºä¸ç¬¬ä¸€ä¸ªæ•°æ®åŒ…çš„å·®è·ä¸º1 å’Œ 2. è€Œå¦‚æœæ­¤æ—¶-S é€‰é¡¹è¢«è®¾ç½®, å¯¹äºåæ¥æ¥æ”¶åˆ°çš„ç¬¬2ä¸ª, ç¬¬3ä¸ªæ•°æ®åŒ…ä¼šæ‰“å°å‡ºå…¶ç»å¯¹é¡ºåºå·:232324, 232325).-s snaplen è®¾ç½®tcpdumpçš„æ•°æ®åŒ…æŠ“å–é•¿åº¦ä¸ºsnaplen, å¦‚æœä¸è®¾ç½®é»˜è®¤å°†ä¼šæ˜¯68å­—èŠ‚(è€Œæ”¯æŒç½‘ç»œæ¥å£åˆ†æ¥å¤´(nt: NIT, ä¸Šæ–‡å·²æœ‰æè¿°,å¯æœç´¢&#39;ç½‘ç»œæ¥å£åˆ†æ¥å¤´&#39;å…³é”®å­—æ‰¾åˆ°é‚£é‡Œ)çš„SunOSç³»åˆ—æ“ä½œç³»ç»Ÿä¸­é»˜è®¤çš„ä¹Ÿæ˜¯æœ€å°å€¼æ˜¯96).68å­—èŠ‚å¯¹äºIP, ICMP(nt: Internet Control Message Protocol,å› ç‰¹ç½‘æ§åˆ¶æŠ¥æ–‡åè®®), TCP ä»¥åŠ UDP åè®®çš„æŠ¥æ–‡å·²è¶³å¤Ÿ, ä½†å¯¹äºåç§°æœåŠ¡(nt: å¯ç†è§£ä¸ºdns, nisç­‰æœåŠ¡), NFSæœåŠ¡ç›¸å…³çš„æ•°æ®åŒ…ä¼šäº§ç”ŸåŒ…æˆªçŸ­. å¦‚æœäº§ç”ŸåŒ…æˆªçŸ­è¿™ç§æƒ…å†µ, tcpdumpçš„ç›¸åº”æ‰“å°è¾“å‡ºè¡Œä¸­ä¼šå‡ºç°&#39;&#39;[|proto]&#39;&#39;çš„æ ‡å¿—ï¼ˆproto å®é™…ä¼šæ˜¾ç¤ºä¸ºè¢«æˆªçŸ­çš„æ•°æ®åŒ…çš„ç›¸å…³åè®®å±‚æ¬¡). éœ€è¦æ³¨æ„çš„æ˜¯, é‡‡ç”¨é•¿çš„æŠ“å–é•¿åº¦(nt: snaplenæ¯”è¾ƒå¤§), ä¼šå¢åŠ åŒ…çš„å¤„ç†æ—¶é—´, å¹¶ä¸”ä¼šå‡å°‘tcpdump å¯ç¼“å­˜çš„æ•°æ®åŒ…çš„æ•°é‡ï¼Œ ä»è€Œä¼šå¯¼è‡´æ•°æ®åŒ…çš„ä¸¢å¤±. æ‰€ä»¥, åœ¨èƒ½æŠ“å–æˆ‘ä»¬æƒ³è¦çš„åŒ…çš„å‰æä¸‹, æŠ“å–é•¿åº¦è¶Šå°è¶Šå¥½.æŠŠsnaplen è®¾ç½®ä¸º0 æ„å‘³ç€è®©tcpdumpè‡ªåŠ¨é€‰æ‹©åˆé€‚çš„é•¿åº¦æ¥æŠ“å–æ•°æ®åŒ….-T type å¼ºåˆ¶tcpdumpæŒ‰typeæŒ‡å®šçš„åè®®æ‰€æè¿°çš„åŒ…ç»“æ„æ¥åˆ†ææ”¶åˆ°çš„æ•°æ®åŒ…. ç›®å‰å·²çŸ¥çš„type å¯å–çš„åè®®ä¸º: aodv (Ad-hoc On-demand Distance Vector protocol, æŒ‰éœ€è·ç¦»å‘é‡è·¯ç”±åè®®, åœ¨Ad hoc(ç‚¹å¯¹ç‚¹æ¨¡å¼)ç½‘ç»œä¸­ä½¿ç”¨), cnfp (Cisco NetFlow protocol), rpc(Remote Procedure Call), rtp (Real-Time Applications protocol), rtcp (Real-Time Applications con-trol protocol), snmp (Simple Network Management Protocol), tftp (Trivial File Transfer Protocol, ç¢æ–‡ä»¶åè®®), vat (Visual Audio Tool, å¯ç”¨äºåœ¨internet ä¸Šè¿›è¡Œç”µ è§†ç”µè¯ä¼šè®®çš„åº”ç”¨å±‚åè®®), ä»¥åŠwb (distributed White Board, å¯ç”¨äºç½‘ç»œä¼šè®®çš„åº”ç”¨å±‚åè®®).-t åœ¨æ¯è¡Œè¾“å‡ºä¸­ä¸æ‰“å°æ—¶é—´æˆ³-tt ä¸å¯¹æ¯è¡Œè¾“å‡ºçš„æ—¶é—´è¿›è¡Œæ ¼å¼å¤„ç†(nt: è¿™ç§æ ¼å¼ä¸€çœ¼å¯èƒ½çœ‹ä¸å‡ºå…¶å«ä¹‰, å¦‚æ—¶é—´æˆ³æ‰“å°æˆ1261798315)-ttt tcpdump è¾“å‡ºæ—¶, æ¯ä¸¤è¡Œæ‰“å°ä¹‹é—´ä¼šå»¶è¿Ÿä¸€ä¸ªæ®µæ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½)-tttt åœ¨æ¯è¡Œæ‰“å°çš„æ—¶é—´æˆ³ä¹‹å‰æ·»åŠ æ—¥æœŸçš„æ‰“å°-u æ‰“å°å‡ºæœªåŠ å¯†çš„NFS å¥æŸ„(nt: handleå¯ç†è§£ä¸ºNFS ä¸­ä½¿ç”¨çš„æ–‡ä»¶å¥æŸ„, è¿™å°†åŒ…æ‹¬æ–‡ä»¶å¤¹å’Œæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶)-U ä½¿å¾—å½“tcpdumpåœ¨ä½¿ç”¨-w é€‰é¡¹æ—¶, å…¶æ–‡ä»¶å†™å…¥ä¸åŒ…çš„ä¿å­˜åŒæ­¥.(nt: å³, å½“æ¯ä¸ªæ•°æ®åŒ…è¢«ä¿å­˜æ—¶, å®ƒå°†åŠæ—¶è¢«å†™å…¥æ–‡ä»¶ä¸­,è€Œä¸æ˜¯ç­‰æ–‡ä»¶çš„è¾“å‡ºç¼“å†²å·²æ»¡æ—¶æ‰çœŸæ­£å†™å…¥æ­¤æ–‡ä»¶) -U æ ‡å¿—åœ¨è€ç‰ˆæœ¬çš„libcapåº“(nt: tcpdump æ‰€ä¾èµ–çš„æŠ¥æ–‡æ•è·åº“)ä¸Šä¸èµ·ä½œç”¨, å› ä¸ºå…¶ä¸­ç¼ºä¹pcap_cump_flush()å‡½æ•°.-v å½“åˆ†æå’Œæ‰“å°çš„æ—¶å€™, äº§ç”Ÿè¯¦ç»†çš„è¾“å‡º. æ¯”å¦‚, åŒ…çš„ç”Ÿå­˜æ—¶é—´, æ ‡è¯†, æ€»é•¿åº¦ä»¥åŠIPåŒ…çš„ä¸€äº›é€‰é¡¹. è¿™ä¹Ÿä¼šæ‰“å¼€ä¸€äº›é™„åŠ çš„åŒ…å®Œæ•´æ€§æ£€æµ‹, æ¯”å¦‚å¯¹IPæˆ–ICMPåŒ…å¤´éƒ¨çš„æ ¡éªŒå’Œ.-vv äº§ç”Ÿæ¯”-væ›´è¯¦ç»†çš„è¾“å‡º. æ¯”å¦‚, NFSå›åº”åŒ…ä¸­çš„é™„åŠ åŸŸå°†ä¼šè¢«æ‰“å°, SMBæ•°æ®åŒ…ä¹Ÿä¼šè¢«å®Œå…¨è§£ç .-vvv äº§ç”Ÿæ¯”-vvæ›´è¯¦ç»†çš„è¾“å‡º. æ¯”å¦‚, telent æ—¶æ‰€ä½¿ç”¨çš„SB, SE é€‰é¡¹å°†ä¼šè¢«æ‰“å°, å¦‚æœtelnetåŒæ—¶ä½¿ç”¨çš„æ˜¯å›¾å½¢ç•Œé¢, å…¶ç›¸åº”çš„å›¾å½¢é€‰é¡¹å°†ä¼šä»¥16è¿›åˆ¶çš„æ–¹å¼æ‰“å°å‡ºæ¥(nt: telnet çš„SB,SEé€‰é¡¹å«ä¹‰æœªçŸ¥, å¦éœ€è¡¥å……).-w æŠŠåŒ…æ•°æ®ç›´æ¥å†™å…¥æ–‡ä»¶è€Œä¸è¿›è¡Œåˆ†æå’Œæ‰“å°è¾“å‡º. è¿™äº›åŒ…æ•°æ®å¯åœ¨éšåé€šè¿‡-r é€‰é¡¹æ¥é‡æ–°è¯»å…¥å¹¶è¿›è¡Œåˆ†æå’Œæ‰“å°.-W filecount æ­¤é€‰é¡¹ä¸-C é€‰é¡¹é…åˆä½¿ç”¨, è¿™å°†é™åˆ¶å¯æ‰“å¼€çš„æ–‡ä»¶æ•°ç›®, å¹¶ä¸”å½“æ–‡ä»¶æ•°æ®è¶…è¿‡è¿™é‡Œè®¾ç½®çš„é™åˆ¶æ—¶, ä¾æ¬¡å¾ªç¯æ›¿ä»£ä¹‹å‰çš„æ–‡ä»¶, è¿™ç›¸å½“äºä¸€ä¸ªæ‹¥æœ‰filecount ä¸ªæ–‡ä»¶çš„æ–‡ä»¶ç¼“å†²æ± . åŒæ—¶, è¯¥é€‰é¡¹ä¼šä½¿å¾—æ¯ä¸ªæ–‡ä»¶åçš„å¼€å¤´ä¼šå‡ºç°è¶³å¤Ÿå¤šå¹¶ç”¨æ¥å ä½çš„0, è¿™å¯ä»¥æ–¹ä¾¿è¿™äº›æ–‡ä»¶è¢«æ­£ç¡®çš„æ’åº.-x å½“åˆ†æå’Œæ‰“å°æ—¶, tcpdump ä¼šæ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®, åŒæ—¶ä¼šä»¥16è¿›åˆ¶æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®(ä½†ä¸åŒ…æ‹¬è¿æ¥å±‚çš„å¤´éƒ¨).æ€»å…±æ‰“å°çš„æ•°æ®å¤§å°ä¸ä¼šè¶…è¿‡æ•´ä¸ªæ•°æ®åŒ…çš„å¤§å°ä¸snaplen ä¸­çš„æœ€å°å€¼. å¿…é¡»è¦æ³¨æ„çš„æ˜¯, å¦‚æœé«˜å±‚åè®®æ•°æ®æ²¡æœ‰snaplen è¿™ä¹ˆé•¿,å¹¶ä¸”æ•°æ®é“¾è·¯å±‚(æ¯”å¦‚, Ethernetå±‚)æœ‰å¡«å……æ•°æ®, åˆ™è¿™äº›å¡«å……æ•°æ®ä¹Ÿä¼šè¢«æ‰“å°.(nt: so for link layers that pad, æœªèƒ½è¡”æ¥ç†è§£å’Œç¿»è¯‘, éœ€è¡¥å…… )-xx tcpdump ä¼šæ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®, åŒæ—¶ä¼šä»¥16è¿›åˆ¶æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®, å…¶ä¸­åŒ…æ‹¬æ•°æ®é“¾è·¯å±‚çš„å¤´éƒ¨.-X å½“åˆ†æå’Œæ‰“å°æ—¶, tcpdump ä¼šæ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®, åŒæ—¶ä¼šä»¥16è¿›åˆ¶å’ŒASCIIç å½¢å¼æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®(ä½†ä¸åŒ…æ‹¬è¿æ¥å±‚çš„å¤´éƒ¨).è¿™å¯¹äºåˆ†æä¸€äº›æ–°åè®®çš„æ•°æ®åŒ…å¾ˆæ–¹ä¾¿.-XX å½“åˆ†æå’Œæ‰“å°æ—¶, tcpdump ä¼šæ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®, åŒæ—¶ä¼šä»¥16è¿›åˆ¶å’ŒASCIIç å½¢å¼æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®, å…¶ä¸­åŒ…æ‹¬æ•°æ®é“¾è·¯å±‚çš„å¤´éƒ¨.è¿™å¯¹äºåˆ†æä¸€äº›æ–°åè®®çš„æ•°æ®åŒ…å¾ˆæ–¹ä¾¿.-y datalinktype è®¾ç½®tcpdump åªæ•è·æ•°æ®é“¾è·¯å±‚åè®®ç±»å‹æ˜¯datalinktypeçš„æ•°æ®åŒ…-Z user ä½¿tcpdump æ”¾å¼ƒè‡ªå·±çš„è¶…çº§æƒé™(å¦‚æœä»¥rootç”¨æˆ·å¯åŠ¨tcpdump, tcpdumpå°†ä¼šæœ‰è¶…çº§ç”¨æˆ·æƒé™), å¹¶æŠŠå½“å‰tcpdumpçš„ç”¨æˆ·IDè®¾ç½®ä¸ºuser, ç»„IDè®¾ç½®ä¸ºuseré¦–è¦æ‰€å±ç»„çš„ID(nt: tcpdump æ­¤å¤„å¯ç†è§£ä¸ºtcpdump è¿è¡Œä¹‹åå¯¹åº”çš„è¿›ç¨‹) æ­¤é€‰é¡¹ä¹Ÿå¯åœ¨ç¼–è¯‘çš„æ—¶å€™è¢«è®¾ç½®ä¸ºé»˜è®¤æ‰“å¼€.(nt: æ­¤æ—¶user çš„å–å€¼æœªçŸ¥, éœ€è¡¥å……) å®ç”¨å‘½ä»¤å®ä¾‹é»˜è®¤å¯åŠ¨1tcpdump æ™®é€šæƒ…å†µä¸‹ï¼Œç›´æ¥å¯åŠ¨ tcpdump å°†ç›‘è§†ç¬¬ä¸€ä¸ªç½‘ç»œæ¥å£(ç½‘å¡)ä¸Šæ‰€æœ‰æµè¿‡çš„æ•°æ®åŒ…ã€‚ ç›‘è§†æŒ‡å®šç½‘ç»œæ¥å£çš„æ•°æ®åŒ…1tcpdump -i eth1 å¦‚æœä¸æŒ‡å®šç½‘å¡ï¼Œé»˜è®¤ tcpdump åªä¼šç›‘è§†ç¬¬ä¸€ä¸ªç½‘ç»œæ¥å£ï¼Œä¸€èˆ¬æ˜¯ eth0ï¼Œä¸‹é¢çš„ä¾‹å­éƒ½æ²¡æœ‰æŒ‡å®šç½‘ç»œæ¥å£ã€‚ ç›‘è§†æŒ‡å®šä¸»æœºçš„æ•°æ®åŒ…1tcpdump host sundown è¿‡æ»¤å‡ºæ‰€æœ‰è¿›å…¥æˆ–ç¦»å¼€åŸŸåä¸ºï¼šccinn çš„æ•°æ®åŒ…. 1tcpdump host 210.27.48.10 ä¹Ÿå¯ä»¥æŒ‡å®š ip,ä¾‹å¦‚æˆªè·æ‰€æœ‰ 210.27.48.10 çš„ä¸»æœºæ”¶åˆ°çš„å’Œå‘å‡ºçš„æ‰€æœ‰çš„æ•°æ®åŒ… 1tcpdump host ccinn and \\( baa or bee \\) è¿‡æ»¤å‡ºåŸŸåä¸º ccinn ä¸ baa æˆ–è€…ä¸ bee ä¹‹é—´é€šä¿¡çš„æ•°æ®åŒ… 1tcpdump host 210.27.48.1 and \\ (210.27.48.2 or 210.27.48.3 \\) åŒåŸŸåçš„åŸç†ï¼Œæˆªè·ä¸»æœº IP 210.27.48.1 å’Œä¸»æœº IP 210.27.48.2 æˆ– 210.27.48.3 çš„é€šä¿¡ 1tcpdump ip host ace and not helios æ‰“å° ace ä¸ä»»ä½•å…¶ä»–ä¸»æœºä¹‹é—´é€šä¿¡çš„ IP æ•°æ®åŒ…, ä½†ä¸åŒ…æ‹¬ä¸ helios ä¹‹é—´çš„æ•°æ®åŒ…. 1tcpdump ip host 210.27.48.1 and ! 210.27.48.2 å¦‚æœæƒ³è¦è·å–ä¸»æœº 210.27.48.1 é™¤äº†å’Œä¸»æœº 210.27.48.2 ä¹‹å¤–æ‰€æœ‰ä¸»æœºé€šä¿¡çš„ ip åŒ…. 1tcpdump -i eth0 src host ccinn.com æˆªè·ä¸»æœº ccinn.com å‘é€çš„æ‰€æœ‰æ•°æ® 1tcpdump -i eth0 dst host ccinn.com æˆªè·ä¸»æœº ccinn.com æ¥æ”¶çš„æ‰€æœ‰æ•°æ® ç›‘è§†æŒ‡å®šä¸»æœºå’Œç«¯å£çš„æ•°æ®åŒ…1tcpdump tcp port 23 and host 210.27.48.1 å¦‚æœæƒ³è¦è·å–ä¸»æœº 210.27.48.1 å¹¶ä¸”ç«¯å£ä¸º 23 çš„æ¥æ”¶æˆ–å‘å‡ºçš„ tcp åŒ… 1tcpdump udp port 123 å¯¹æœ¬æœºçš„ udp 123 ç«¯å£è¿›è¡Œè¿‡æ»¤ ç›‘è§†æŒ‡å®šåè®®çš„æ•°æ®åŒ…è¿™ä¸ªæ˜¯çµæ´»åº¦æ¯”è¾ƒé«˜çš„ç”¨æ³•ï¼Œéœ€è¦æˆ‘ä»¬å¯¹åº•å±‚åè®®æœ‰ä¸€å®šäº†è§£æ‰æ¯”è¾ƒå¥½å¤„ç†ã€‚è¿™é‡Œä¼šç”¨ TCP åè®®ä½œä¸ºä¾‹å­ã€‚å¦‚æœå¯¹ TCP åè®®ä¸äº†è§£çš„è¯ï¼Œè¿™ä¸ªé«˜çº§ç”¨æ³•å¯èƒ½æ´¾ä¸ä¸Šç”¨åœºã€‚ ä¸‹é¢è¯¦ç»†ä»‹ç»proto [ expr : size] Protoå³protocolçš„ç¼©å†™ï¼Œå®ƒè¡¨ç¤ºè¿™é‡Œè¦æŒ‡å®šçš„æ˜¯æŸç§åè®®åç§°ï¼Œå¦‚ip,tcp,udpç­‰ã€‚æ€»ä¹‹å¯ä»¥æŒ‡å®šçš„åè®®æœ‰åå¤šç§ï¼Œå¦‚é“¾è·¯å±‚åè®® ether,fddi,tr,wlan,ppp,slip,link, ç½‘ç»œå±‚åè®®ip,ip6,arp,rarp,icmpä¼ è¾“å±‚åè®®tcp,udpç­‰ã€‚ exprç”¨æ¥æŒ‡å®šæ•°æ®æŠ¥å­—èŠ‚å•ä½çš„åç§»é‡ï¼Œè¯¥åç§»é‡ç›¸å¯¹äºæŒ‡å®šçš„åè®®å±‚ï¼Œé»˜è®¤çš„èµ·å§‹ä½ç½®æ˜¯0ï¼›è€Œsizeè¡¨ç¤ºä»åç§»é‡çš„ä½ç½®å¼€å§‹æå–å¤šå°‘ä¸ªå­—èŠ‚ï¼Œå¯ä»¥è®¾ç½®ä¸º 1ã€2ã€4,é»˜è®¤ä¸º1å­—èŠ‚ã€‚å¦‚æœåªè®¾ç½®äº†exprï¼Œè€Œæ²¡æœ‰è®¾ç½®sizeï¼Œåˆ™é»˜è®¤æå–1ä¸ªå­—èŠ‚ã€‚æ¯”å¦‚ip[2:2]ï¼Œå°±è¡¨ç¤ºæå–å‡ºç¬¬3ã€4ä¸ªå­—èŠ‚ï¼›è€Œip[0]åˆ™è¡¨ç¤ºæå–ipåè®®å¤´çš„ ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚åœ¨æˆ‘ä»¬æå–äº†ç‰¹å®šå†…å®¹ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦è®¾ç½®æˆ‘ä»¬çš„è¿‡æ»¤æ¡ä»¶äº†ï¼Œæˆ‘ä»¬å¯ç”¨çš„â€œæ¯”è¾ƒæ“ä½œç¬¦â€åŒ…æ‹¬ï¼š&gt;ï¼Œ&lt;ï¼Œ&gt;=ï¼Œ&lt;=ï¼Œ=ï¼Œ!=ï¼Œæ€»å…±æœ‰6ä¸ªã€‚ ä¸¾ä¸ªä¾‹å­ï¼šæŠ“å–å¸¦æœ‰ç‰¹æ®Šæ ‡å¿—çš„çš„ TCP åŒ…(å¦‚ SYN-ACK æ ‡å¿—, URG-ACK æ ‡å¿—ç­‰). åœ¨ TCP çš„å¤´éƒ¨ä¸­, æœ‰ 8 æ¯”ç‰¹(bit)ç”¨ä½œæ§åˆ¶ä½åŒºåŸŸ, å…¶å–å€¼ä¸º:CWR | ECE | URG | ACK | PSH | RST | SYN | FIN ç°å‡è®¾æˆ‘ä»¬æƒ³è¦ç›‘æ§å»ºç«‹ä¸€ä¸ª TCP è¿æ¥æ•´ä¸ªè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„æ•°æ®åŒ…. å¯å›å¿†å¦‚ä¸‹:TCP ä½¿ç”¨ 3 æ¬¡æ¡æ‰‹åè®®æ¥å»ºç«‹ä¸€ä¸ªæ–°çš„è¿æ¥; å…¶ä¸æ­¤ä¸‰æ¬¡æ¡æ‰‹è¿æ¥é¡ºåºå¯¹åº”ï¼Œå¹¶å¸¦æœ‰ç›¸åº” TCP æ§åˆ¶æ ‡å¿—çš„æ•°æ®åŒ…å¦‚ä¸‹: è¿æ¥å‘èµ·æ–¹å‘é€ SYN æ ‡å¿—çš„æ•°æ®åŒ… æ¥æ”¶æ–¹ç”¨å¸¦æœ‰ SYN å’Œ ACK æ ‡å¿—çš„æ•°æ®åŒ…è¿›è¡Œå›åº” å‘èµ·æ–¹æ”¶åˆ°æ¥æ”¶æ–¹å›åº”åå†å‘é€å¸¦æœ‰ ACK æ ‡å¿—çš„æ•°æ®åŒ…è¿›è¡Œå›åº” 1234567891011121314151617181920212223240 15 31-----------------------------------------------------------------| source port | destination port |-----------------------------------------------------------------| sequence number |-----------------------------------------------------------------| acknowledgment number |-----------------------------------------------------------------| HL | rsvd |C|E|U|A|P|R|S|F| window size |-----------------------------------------------------------------| TCP checksum | urgent pointer |-----------------------------------------------------------------| 0 7 | 15 | 23 | 31 || ---------------- | ---------------------- | --------------- | ---------------- || HL \\| rsvd | C\\|E\\|U\\|A\\|P\\|R\\|S\\|F | window size || ---------------- | --------------- | --------------- | ---------------- || | 13th octet | | ||C|E|U|A|P|R|S|F||---------------||0 0 0 0 0 0 1 0||---------------||7 6 5 4 3 2 1 0| æˆ‘ä»¬çœ‹å›è¿™å¼ å›¾ï¼ŒTCP å¤´éƒ¨ä¸€èˆ¬æ˜¯æœ‰ 20 ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œåœ¨æ ‡å¿—ä½ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰è¡Œå¼€å§‹ï¼Œ\b ç¬¬ä¸‰è¡Œå¼€å§‹çš„è¯å°±å·²ç»ç»è¿‡äº† 12 ä¸ªå­—èŠ‚äº†ï¼Œé‚£ä¹ˆå‘å·¦ç§»åŠ¨ 8bitï¼Œå°±æ˜¯åˆšå¥½æˆ‘ä»¬çš„æ ‡å¿—ä½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯åˆšå¥½ä»ç¬¬ 13 ä¸ªå­—èŠ‚çš„æ•°æ®å¼€å§‹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„æ ‡å¿—ä½æ•°æ®ï¼Œæ ‡å¿—ä½ä¸€å…±å ç”¨ 8 ä¸ªæ ‡å¿—ä½ï¼ŒSYN æ ‡å¿—ä½ä»ä½å¾€é«˜æ•°ï¼Œå°±æ˜¯ç¬¬äºŒä½ï¼ŒACK æ ‡å¿—ä½å°±æ˜¯ç¬¬äº”ä½ã€‚ æ‰€ä»¥æˆ‘ä»¬çš„è¡¨è¾¾å¼ä¸ºï¼š 1( ( value of octet 13 ) AND ( 2 ) ) &#x3D;&#x3D; ( 2 ) ä¹Ÿå°±æ˜¯ï¼š 1tcpdump -iany &#39;tcp[13] &amp; 2 &#x3D;&#x3D; 2&#39; è¿™ä¸ªå‘½ä»¤å°±æ˜¯è·å–TCPåè®®ä¸­æ•°æ®åŒ…ä¸­ä»£è¡¨SYNæ¶ˆæ¯çš„æ•°æ®ã€‚ è¿™æ ·å­ï¼Œæˆ‘ä»¬æ•æ‰åˆ°çš„å°±æ˜¯åªæœ‰å¦‚ä¸‹æ¶ˆæ¯ï¼Œ 12345root@8152f1016ea8:&#x2F;data# tcpdump -iany &#39;tcp port 6379 and tcp[13] &amp; 2 &#x3D;&#x3D; 2&#39;tcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes10:06:37.491460 IP localhost.34716 &gt; localhost.6379: Flags [S], seq 998071933, win 43690, options [mss 65495,sackOK,TS val 11418013 ecr 0,nop,wscale 7], length 010:06:37.491501 IP localhost.6379 &gt; localhost.34716: Flags [S.], seq 2636200817, ack 998071934, win 43690, options [mss 65495,sackOK,TS val 11418013 ecr 11418013,nop,wscale 7], length 0 å…¨éƒ¨éƒ½æ˜¯å¸¦æœ‰[S]æ ‡å¿—çš„ã€‚ ä½¿ç”¨ tcpdump æŠ“å– HTTP åŒ…1tcpdump -XvvennSs 0 -i eth0 tcp[20:2]&#x3D;0x4745 or tcp[20:2]&#x3D;0x4854 0x4745 ä¸ºâ€GETâ€å‰ä¸¤ä¸ªå­—æ¯â€GEâ€,0x4854 ä¸ºâ€HTTPâ€å‰ä¸¤ä¸ªå­—æ¯â€HTâ€ã€‚ æ€»ç»“tcpdump å¯¹æˆªè·çš„æ•°æ®å¹¶æ²¡æœ‰è¿›è¡Œå½»åº•è§£ç ï¼Œæ•°æ®åŒ…å†…çš„å¤§éƒ¨åˆ†å†…å®¹æ˜¯ä½¿ç”¨åå…­è¿›åˆ¶çš„å½¢å¼ç›´æ¥æ‰“å°è¾“å‡ºçš„ã€‚æ˜¾ç„¶è¿™ä¸åˆ©äºåˆ†æç½‘ç»œæ•…éšœï¼Œé€šå¸¸çš„è§£å†³åŠæ³•æ˜¯å…ˆä½¿ç”¨å¸¦-w å‚æ•°çš„ tcpdump æˆªè·æ•°æ®å¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­ä¿å­˜æˆ cap æ–‡ä»¶ï¼Œç„¶åå†ä½¿ç”¨å…¶ä»–ç¨‹åº(å¦‚ Wireshark)è¿›è¡Œè§£ç åˆ†æã€‚å½“ç„¶ä¹Ÿåº”è¯¥å®šä¹‰è¿‡æ»¤è§„åˆ™ï¼Œä»¥é¿å…æ•è·çš„æ•°æ®åŒ…å¡«æ»¡æ•´ä¸ªç¡¬ç›˜ã€‚ å¦‚æœéœ€è¦æœ€å®Œæ•´å¯¹è¯´æ˜å¯¹è¯ï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘è¯´æ˜tcpdump.","categories":[{"name":"ç½‘ç»œåè®®","slug":"ç½‘ç»œåè®®","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"TCP","slug":"TCP","permalink":"http://blog.crazylaw.cn/tags/TCP/"}]},{"title":"ã€ç½‘ç»œåè®®ã€‘TCP - é‡ä¼ æœºåˆ¶","slug":"ç½‘ç»œåè®®/TCP-é‡ä¼ æœºåˆ¶","date":"2019-08-07T03:33:40.000Z","updated":"2021-03-20T16:25:01.822Z","comments":true,"path":"2019/08/07/ç½‘ç»œåè®®/TCP-é‡ä¼ æœºåˆ¶/","link":"","permalink":"http://blog.crazylaw.cn/2019/08/07/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/TCP-%E9%87%8D%E4%BC%A0%E6%9C%BA%E5%88%B6/","excerpt":"å‰è¨€TCP è¦ä¿è¯æ‰€æœ‰çš„æ•°æ®åŒ…éƒ½å¯ä»¥åˆ°è¾¾ï¼Œæ‰€ä»¥ï¼Œå¿…éœ€è¦æœ‰é‡ä¼ æœºåˆ¶ã€‚ å…¶ä¸­æ¶‰åŠ ACK åŒ…æ¯”è¾ƒå…³é”®ï¼Œå› ä¸ºåœ¨çª—å£çš„è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå·²ç»è¯´è¿‡äº†ï¼ŒACK æœºåˆ¶èµ·å§‹å°±æ˜¯ç±»ä¼¼äºä¸€ç§åé¦ˆæœºåˆ¶ã€‚","text":"å‰è¨€TCP è¦ä¿è¯æ‰€æœ‰çš„æ•°æ®åŒ…éƒ½å¯ä»¥åˆ°è¾¾ï¼Œæ‰€ä»¥ï¼Œå¿…éœ€è¦æœ‰é‡ä¼ æœºåˆ¶ã€‚ å…¶ä¸­æ¶‰åŠ ACK åŒ…æ¯”è¾ƒå…³é”®ï¼Œå› ä¸ºåœ¨çª—å£çš„è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå·²ç»è¯´è¿‡äº†ï¼ŒACK æœºåˆ¶èµ·å§‹å°±æ˜¯ç±»ä¼¼äºä¸€ç§åé¦ˆæœºåˆ¶ã€‚ TCP é‡ä¼ æœºåˆ¶æ³¨æ„ï¼Œæ¥æ”¶ç«¯ç»™å‘é€ç«¯çš„ Ack ç¡®è®¤åªä¼šç¡®è®¤æœ€åä¸€ä¸ªè¿ç»­çš„åŒ…ï¼Œæ¯”å¦‚ï¼Œå‘é€ç«¯å‘äº† 1,2,3,4,5 ä¸€å…±äº”ä»½æ•°æ®ï¼Œæ¥æ”¶ç«¯æ”¶åˆ°äº† 1ï¼Œ2ï¼Œäºæ˜¯å› ack 3ï¼Œç„¶åæ”¶åˆ°äº† 4ï¼ˆæ³¨æ„æ­¤æ—¶ 3 æ²¡æ”¶åˆ°ï¼‰ï¼Œæ­¤æ—¶çš„ TCP ä¼šæ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬è¦çŸ¥é“ï¼Œå› ä¸ºæ­£å¦‚å‰é¢æ‰€è¯´çš„ï¼ŒSeqNum å’Œ Ack æ˜¯ä»¥å­—èŠ‚æ•°ä¸ºå•ä½ï¼Œæ‰€ä»¥ ack çš„æ—¶å€™ï¼Œä¸èƒ½è·³ç€ç¡®è®¤ï¼Œåªèƒ½ç¡®è®¤æœ€å¤§çš„è¿ç»­æ”¶åˆ°çš„åŒ…ï¼Œä¸ç„¶ï¼Œå‘é€ç«¯å°±ä»¥ä¸ºä¹‹å‰çš„éƒ½æ”¶åˆ°äº†ã€‚ è¶…æ—¶é‡ä¼ æœºåˆ¶ä¸€ç§æ˜¯ä¸å› ackï¼Œæ­»ç­‰ 3ï¼Œå½“å‘é€æ–¹å‘ç°æ”¶ä¸åˆ° 3 çš„ ack è¶…æ—¶åï¼Œä¼šé‡ä¼  3ã€‚ä¸€æ—¦æ¥æ”¶æ–¹æ”¶åˆ° 3 åï¼Œä¼š ack å› 4â€”â€”æ„å‘³ç€ 3 å’Œ 4 éƒ½æ”¶åˆ°äº†ã€‚ ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼ä¼šæœ‰æ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å› ä¸ºè¦æ­»ç­‰ 3ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ 4 å’Œ 5 å³ä¾¿å·²ç»æ”¶åˆ°äº†ï¼Œè€Œå‘é€æ–¹ä¹Ÿå®Œå…¨ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Œå› ä¸ºæ²¡æœ‰æ”¶åˆ° Ackï¼Œæ‰€ä»¥ï¼Œå‘é€æ–¹å¯èƒ½ä¼šæ‚²è§‚åœ°è®¤ä¸ºä¹Ÿä¸¢äº†ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¹Ÿä¼šå¯¼è‡´ 4 å’Œ 5 çš„é‡ä¼ ã€‚ å¯¹æ­¤æœ‰ä¸¤ç§é€‰æ‹©ï¼š ä¸€ç§æ˜¯ä»…é‡ä¼  timeout çš„åŒ…ã€‚ä¹Ÿå°±æ˜¯ç¬¬ 3 ä»½æ•°æ®ã€‚ å¦ä¸€ç§æ˜¯é‡ä¼  timeout åæ‰€æœ‰çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 3ï¼Œ4ï¼Œ5 è¿™ä¸‰ä»½æ•°æ®ã€‚ è¿™ä¸¤ç§æ–¹å¼æœ‰å¥½ä¹Ÿæœ‰ä¸å¥½ã€‚ç¬¬ä¸€ç§ä¼šèŠ‚çœå¸¦å®½ï¼Œä½†æ˜¯æ…¢ï¼Œç¬¬äºŒç§ä¼šå¿«ä¸€ç‚¹ï¼Œä½†æ˜¯ä¼šæµªè´¹å¸¦å®½ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰æ— ç”¨åŠŸã€‚ä½†æ€»ä½“æ¥è¯´éƒ½ä¸å¥½ã€‚å› ä¸ºéƒ½åœ¨ç­‰ timeoutï¼Œtimeout å¯èƒ½ä¼šå¾ˆé•¿ï¼ˆåœ¨ä¸‹ç¯‡ä¼šè¯´ TCP æ˜¯æ€ä¹ˆåŠ¨æ€åœ°è®¡ç®—å‡º timeout çš„ï¼‰ å¿«é€Ÿé‡ä¼ æœºåˆ¶äºæ˜¯ï¼ŒTCP å¼•å…¥äº†ä¸€ç§å« Fast Retransmit çš„ç®—æ³•ï¼Œä¸ä»¥æ—¶é—´é©±åŠ¨ï¼Œè€Œä»¥æ•°æ®é©±åŠ¨é‡ä¼ ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœï¼ŒåŒ…æ²¡æœ‰è¿ç»­åˆ°è¾¾ï¼Œå°± ack æœ€åé‚£ä¸ªå¯èƒ½è¢«ä¸¢äº†çš„åŒ…ï¼Œå¦‚æœå‘é€æ–¹è¿ç»­æ”¶åˆ° 3 æ¬¡ç›¸åŒçš„ ackï¼Œå°±é‡ä¼ ã€‚Fast Retransmit çš„å¥½å¤„æ˜¯ä¸ç”¨ç­‰ timeout äº†å†é‡ä¼ ã€‚ æ¯”å¦‚ï¼šå¦‚æœå‘é€æ–¹å‘å‡ºäº† 1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5 ä»½æ•°æ®ï¼Œç¬¬ä¸€ä»½å…ˆåˆ°é€äº†ï¼Œäºæ˜¯å°± ack å› 2ï¼Œç»“æœ 2 å› ä¸ºæŸäº›åŸå› æ²¡æ”¶åˆ°ï¼Œ3 åˆ°è¾¾äº†ï¼Œäºæ˜¯è¿˜æ˜¯ ack å› 2ï¼Œåé¢çš„ 4 å’Œ 5 éƒ½åˆ°äº†ï¼Œä½†æ˜¯è¿˜æ˜¯ ack å› 2ï¼Œå› ä¸º 2 è¿˜æ˜¯æ²¡æœ‰æ”¶åˆ°ï¼Œäºæ˜¯å‘é€ç«¯æ”¶åˆ°äº†ä¸‰ä¸ª ack=2 çš„ç¡®è®¤ï¼ŒçŸ¥é“äº† 2 è¿˜æ²¡æœ‰åˆ°ï¼Œäºæ˜¯å°±é©¬ä¸Šé‡è½¬ 2ã€‚ç„¶åï¼Œæ¥æ”¶ç«¯æ”¶åˆ°äº† 2ï¼Œæ­¤æ—¶å› ä¸º 3ï¼Œ4ï¼Œ5 éƒ½æ”¶åˆ°äº†ï¼Œäºæ˜¯ ack å› 6ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š Fast Retransmit åªè§£å†³äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ timeout çš„é—®é¢˜ï¼Œå®ƒä¾ç„¶é¢ä¸´ä¸€ä¸ªè‰°éš¾çš„é€‰æ‹©ï¼Œå°±æ˜¯é‡è½¬ä¹‹å‰çš„ä¸€ä¸ªè¿˜æ˜¯é‡è£…æ‰€æœ‰çš„é—®é¢˜ã€‚å¯¹äºä¸Šé¢çš„ç¤ºä¾‹æ¥è¯´ï¼Œæ˜¯é‡ä¼ #2 å‘¢è¿˜æ˜¯é‡ä¼ #2ï¼Œ#3ï¼Œ#4ï¼Œ#5 å‘¢ï¼Ÿå› ä¸ºå‘é€ç«¯å¹¶ä¸æ¸…æ¥šè¿™è¿ç»­çš„ 3 ä¸ª ack(2)æ˜¯è°ä¼ å›æ¥çš„ï¼Ÿä¹Ÿè®¸å‘é€ç«¯å‘äº† 20 ä»½æ•°æ®ï¼Œæ˜¯#6ï¼Œ#10ï¼Œ#20 ä¼ æ¥çš„å‘¢ã€‚è¿™æ ·ï¼Œå‘é€ç«¯å¾ˆæœ‰å¯èƒ½è¦é‡ä¼ ä» 2 åˆ° 20 çš„è¿™å †æ•°æ®ï¼ˆè¿™å°±æ˜¯æŸäº› TCP çš„å®é™…çš„å®ç°ï¼‰ã€‚å¯è§ï¼Œè¿™æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚ SACK æ–¹æ³•å¦å¤–ä¸€ç§æ›´å¥½çš„æ–¹å¼å«ï¼šSelective Acknowledgment (SACK)ï¼ˆå‚çœ‹ RFC 2018ï¼‰ï¼Œè¿™ç§æ–¹å¼éœ€è¦åœ¨ TCP å¤´é‡ŒåŠ ä¸€ä¸ª SACK çš„ä¸œè¥¿ï¼ŒACK è¿˜æ˜¯ Fast Retransmit çš„ ACKï¼ŒSACK åˆ™æ˜¯æ±‡æŠ¥æ”¶åˆ°çš„æ•°æ®ç¢ç‰ˆã€‚å‚çœ‹ä¸‹å›¾ï¼š è¿™æ ·ï¼Œåœ¨å‘é€ç«¯å°±å¯ä»¥æ ¹æ®å›ä¼ çš„ SACK æ¥çŸ¥é“å“ªäº›æ•°æ®åˆ°äº†ï¼Œå“ªäº›æ²¡æœ‰åˆ°ã€‚äºæ˜¯å°±ä¼˜åŒ–äº† Fast Retransmit çš„ç®—æ³•ã€‚å½“ç„¶ï¼Œè¿™ä¸ªåè®®éœ€è¦ä¸¤è¾¹éƒ½æ”¯æŒã€‚åœ¨ Linux ä¸‹ï¼Œå¯ä»¥é€šè¿‡ tcp_sack å‚æ•°æ‰“å¼€è¿™ä¸ªåŠŸèƒ½ï¼ˆLinux 2.4 åé»˜è®¤æ‰“å¼€ï¼‰ã€‚sè¿™é‡Œè¿˜éœ€è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜â€”â€”æ¥æ”¶æ–¹ Renegingï¼Œæ‰€è°“ Reneging çš„æ„æ€å°±æ˜¯æ¥æ”¶æ–¹æœ‰æƒæŠŠå·²ç»æŠ¥ç»™å‘é€ç«¯ SACK é‡Œçš„æ•°æ®ç»™ä¸¢äº†ã€‚è¿™æ ·å¹²æ˜¯ä¸è¢«é¼“åŠ±çš„ï¼Œå› ä¸ºè¿™ä¸ªäº‹ä¼šæŠŠé—®é¢˜å¤æ‚åŒ–äº†ï¼Œä½†æ˜¯ï¼Œæ¥æ”¶æ–¹è¿™ä¹ˆåšå¯èƒ½ä¼šæœ‰äº›æç«¯æƒ…å†µï¼Œæ¯”å¦‚è¦æŠŠå†…å­˜ç»™åˆ«çš„æ›´é‡è¦çš„ä¸œè¥¿ã€‚æ‰€ä»¥ï¼Œå‘é€æ–¹ä¹Ÿä¸èƒ½å®Œå…¨ä¾èµ– SACKï¼Œè¿˜æ˜¯è¦ä¾èµ– ACKï¼Œå¹¶ç»´æŠ¤ Time-Outï¼Œå¦‚æœåç»­çš„ ACK æ²¡æœ‰å¢é•¿ï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦æŠŠ SACK çš„ä¸œè¥¿é‡ä¼ ï¼Œå¦å¤–ï¼Œæ¥æ”¶ç«¯è¿™è¾¹æ°¸è¿œä¸èƒ½æŠŠ SACK çš„åŒ…æ ‡è®°ä¸º Ackã€‚ æ³¨æ„ï¼šSACK ä¼šæ¶ˆè´¹å‘é€æ–¹çš„èµ„æºï¼Œè¯•æƒ³ï¼Œå¦‚æœä¸€ä¸ªæ”»å‡»è€…ç»™æ•°æ®å‘é€æ–¹å‘ä¸€å † SACK çš„é€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´å‘é€æ–¹å¼€å§‹è¦é‡ä¼ ç”šè‡³éå†å·²ç»å‘å‡ºçš„æ•°æ®ï¼Œè¿™ä¼šæ¶ˆè€—å¾ˆå¤šå‘é€ç«¯çš„èµ„æºã€‚è¯¦ç»†çš„ä¸œè¥¿è¯·å‚çœ‹ã€ŠTCP SACK çš„æ€§èƒ½æƒè¡¡ã€‹ Duplicate SACKDuplicate SACK åˆç§° D-SACKï¼Œå…¶ä¸»è¦ä½¿ç”¨äº† SACK æ¥å‘Šè¯‰å‘é€æ–¹æœ‰å“ªäº›æ•°æ®è¢«é‡å¤æ¥æ”¶äº†ã€‚RFC-2833 é‡Œæœ‰è¯¦ç»†æè¿°å’Œç¤ºä¾‹ã€‚ä¸‹é¢ä¸¾å‡ ä¸ªä¾‹å­ï¼ˆæ¥æºäº RFC-2833ï¼‰ D-SACK ä½¿ç”¨äº† SACK çš„ç¬¬ä¸€ä¸ªæ®µæ¥åšæ ‡å¿—ï¼Œ å¦‚æœ SACK çš„ç¬¬ä¸€ä¸ªæ®µçš„èŒƒå›´è¢« ACK æ‰€è¦†ç›–ï¼Œé‚£ä¹ˆå°±æ˜¯ D-SACK å¦‚æœ SACK çš„ç¬¬ä¸€ä¸ªæ®µçš„èŒƒå›´è¢« SACK çš„ç¬¬äºŒä¸ªæ®µè¦†ç›–ï¼Œé‚£ä¹ˆå°±æ˜¯ D-SACK ç¤ºä¾‹ä¸€ï¼šACK ä¸¢åŒ…ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸¢äº†ä¸¤ä¸ª ACKï¼Œæ‰€ä»¥ï¼Œå‘é€ç«¯é‡ä¼ äº†ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ï¼ˆ3000-3499ï¼‰ï¼Œäºæ˜¯æ¥æ”¶ç«¯å‘ç°é‡å¤æ”¶åˆ°ï¼Œäºæ˜¯å›äº†ä¸€ä¸ª SACK=3000-3500ï¼Œå› ä¸º ACK éƒ½åˆ°äº† 4000 æ„å‘³ç€æ”¶åˆ°äº† 4000 ä¹‹å‰çš„æ‰€æœ‰æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ª SACK å°±æ˜¯ D-SACKâ€”â€”æ—¨åœ¨å‘Šè¯‰å‘é€ç«¯æˆ‘æ”¶åˆ°äº†é‡å¤çš„æ•°æ®ï¼Œè€Œä¸”æˆ‘ä»¬çš„å‘é€ç«¯è¿˜çŸ¥é“ï¼Œæ•°æ®åŒ…æ²¡æœ‰ä¸¢ï¼Œä¸¢çš„æ˜¯ ACK åŒ…ã€‚ 123456789Transmitted Received ACK SentSegment Segment (Including SACK Blocks)3000-3499 3000-3499 3500 (ACK dropped)3500-3999 3500-3999 4000 (ACK dropped)3000-3499 3000-3499 4000, SACK&#x3D;3000-3500 ç¤ºä¾‹äºŒï¼Œç½‘ç»œå»¶è¯¯ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œç½‘ç»œåŒ…ï¼ˆ1000-1499ï¼‰è¢«ç½‘ç»œç»™å»¶è¯¯äº†ï¼Œå¯¼è‡´å‘é€æ–¹æ²¡æœ‰æ”¶åˆ° ACKï¼Œè€Œåé¢åˆ°è¾¾çš„ä¸‰ä¸ªåŒ…è§¦å‘äº†â€œFast Retransmit ç®—æ³•â€ï¼Œæ‰€ä»¥é‡ä¼ ï¼Œä½†é‡ä¼ æ—¶ï¼Œè¢«å»¶è¯¯çš„åŒ…åˆåˆ°äº†ï¼Œæ‰€ä»¥ï¼Œå›äº†ä¸€ä¸ª SACK=1000-1500ï¼Œå› ä¸º ACK å·²åˆ°äº† 3000ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ª SACK æ˜¯ D-SACKâ€”â€”æ ‡è¯†æ”¶åˆ°äº†é‡å¤çš„åŒ…ã€‚ è¿™ä¸ªæ¡ˆä¾‹ä¸‹ï¼Œå‘é€ç«¯çŸ¥é“ä¹‹å‰å› ä¸ºâ€œFast Retransmit ç®—æ³•â€è§¦å‘çš„é‡ä¼ ä¸æ˜¯å› ä¸ºå‘å‡ºå»çš„åŒ…ä¸¢äº†ï¼Œä¹Ÿä¸æ˜¯å› ä¸ºå›åº”çš„ ACK åŒ…ä¸¢äº†ï¼Œè€Œæ˜¯å› ä¸ºç½‘ç»œå»¶æ—¶äº†ã€‚ 1234567891011121314151617Transmitted Received ACK SentSegment Segment (Including SACK Blocks)500-999 500-999 10001000-1499 (delayed)1500-1999 1500-1999 1000, SACK&#x3D;1500-20002000-2499 2000-2499 1000, SACK&#x3D;1500-25002500-2999 2500-2999 1000, SACK&#x3D;1500-30001000-1499 1000-1499 3000 1000-1499 3000, SACK&#x3D;1000-1500 å¯è§ï¼Œå¼•å…¥äº† D-SACKï¼Œæœ‰è¿™ä¹ˆå‡ ä¸ªå¥½å¤„ï¼šs1ï¼‰å¯ä»¥è®©å‘é€æ–¹çŸ¥é“ï¼Œæ˜¯å‘å‡ºå»çš„åŒ…ä¸¢äº†ï¼Œè¿˜æ˜¯å›æ¥çš„ ACK åŒ…ä¸¢äº†ã€‚ 2ï¼‰æ˜¯ä¸æ˜¯è‡ªå·±çš„ timeout å¤ªå°äº†ï¼Œå¯¼è‡´é‡ä¼ ã€‚ 3ï¼‰ç½‘ç»œä¸Šå‡ºç°äº†å…ˆå‘çš„åŒ…ååˆ°çš„æƒ…å†µï¼ˆåˆç§° reorderingï¼‰ 4ï¼‰ç½‘ç»œä¸Šæ˜¯ä¸æ˜¯æŠŠæˆ‘çš„æ•°æ®åŒ…ç»™å¤åˆ¶äº†ã€‚ çŸ¥é“è¿™äº›ä¸œè¥¿å¯ä»¥å¾ˆå¥½å¾—å¸®åŠ© TCP äº†è§£ç½‘ç»œæƒ…å†µï¼Œä»è€Œå¯ä»¥æ›´å¥½çš„åšç½‘ç»œä¸Šçš„æµæ§ã€‚ Linux ä¸‹çš„ tcp_dsack å‚æ•°ç”¨äºå¼€å¯è¿™ä¸ªåŠŸèƒ½ï¼ˆLinux 2.4 åé»˜è®¤æ‰“å¼€ï¼‰","categories":[{"name":"ç½‘ç»œåè®®","slug":"ç½‘ç»œåè®®","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"TCP","slug":"TCP","permalink":"http://blog.crazylaw.cn/tags/TCP/"}]},{"title":"ã€ç½‘ç»œåè®®ã€‘TCP çª—å£","slug":"ç½‘ç»œåè®®/TCP-çª—å£","date":"2019-08-06T09:43:43.000Z","updated":"2021-03-20T16:25:01.822Z","comments":true,"path":"2019/08/06/ç½‘ç»œåè®®/TCP-çª—å£/","link":"","permalink":"http://blog.crazylaw.cn/2019/08/06/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/TCP-%E7%AA%97%E5%8F%A3/","excerpt":"å‰è¨€ç”±äºæœ€è¿‘å†™äº†ä¸€ç¯‡å…³äº TCP åè®®çš„æ–‡ç« ï¼Œæ‰€ä»¥ä¸€äº›æ›´åŠ ç»†èŠ‚çš„å†…å®¹ï¼Œæ›´åå‘ TCP ç‹¬ç«‹åè®®çš„ï¼Œæ‹¿å‡ºæ¥ç‹¬ç«‹è®°å½•ã€‚ ä¸ºäº†è·å¾—æœ€ä¼˜çš„è¿æ¥é€Ÿç‡ï¼Œä½¿ç”¨ TCP çª—å£æ¥æ§åˆ¶æµé€Ÿç‡ï¼ˆflow controlï¼‰ï¼Œæ»‘åŠ¨çª—å£å°±æ˜¯ä¸€ç§ä¸»è¦çš„æœºåˆ¶ã€‚è¿™ä¸ªçª—å£å…è®¸æºç«¯åœ¨ç»™å®šè¿æ¥ä¼ é€æ•°æ®åˆ†æ®µè€Œä¸ç”¨ç­‰å¾…ç›®æ ‡ç«¯è¿”å› ACKï¼Œä¸€å¥è¯æè¿°ï¼šçª—å£çš„å¤§å°å†³å®šåœ¨ä¸éœ€è¦å¯¹ç«¯å“åº”ï¼ˆacknowledgementï¼‰æƒ…å†µä¸‹ä¼ é€æ•°æ®çš„æ•°é‡ã€‚â€‹ å®˜æ–¹å®šä¹‰ï¼šâ€œThe amount of octets that can be transmitted without receiving an acknowledgement from the other sideâ€ã€‚","text":"å‰è¨€ç”±äºæœ€è¿‘å†™äº†ä¸€ç¯‡å…³äº TCP åè®®çš„æ–‡ç« ï¼Œæ‰€ä»¥ä¸€äº›æ›´åŠ ç»†èŠ‚çš„å†…å®¹ï¼Œæ›´åå‘ TCP ç‹¬ç«‹åè®®çš„ï¼Œæ‹¿å‡ºæ¥ç‹¬ç«‹è®°å½•ã€‚ ä¸ºäº†è·å¾—æœ€ä¼˜çš„è¿æ¥é€Ÿç‡ï¼Œä½¿ç”¨ TCP çª—å£æ¥æ§åˆ¶æµé€Ÿç‡ï¼ˆflow controlï¼‰ï¼Œæ»‘åŠ¨çª—å£å°±æ˜¯ä¸€ç§ä¸»è¦çš„æœºåˆ¶ã€‚è¿™ä¸ªçª—å£å…è®¸æºç«¯åœ¨ç»™å®šè¿æ¥ä¼ é€æ•°æ®åˆ†æ®µè€Œä¸ç”¨ç­‰å¾…ç›®æ ‡ç«¯è¿”å› ACKï¼Œä¸€å¥è¯æè¿°ï¼šçª—å£çš„å¤§å°å†³å®šåœ¨ä¸éœ€è¦å¯¹ç«¯å“åº”ï¼ˆacknowledgementï¼‰æƒ…å†µä¸‹ä¼ é€æ•°æ®çš„æ•°é‡ã€‚â€‹ å®˜æ–¹å®šä¹‰ï¼šâ€œThe amount of octets that can be transmitted without receiving an acknowledgement from the other sideâ€ã€‚ TCP çª—å£æœºåˆ¶æ¯”å¦‚æˆ‘è®©å‘é€çš„æ¯ä¸€ä¸ªåŒ…éƒ½æœ‰ä¸€ä¸ª idï¼Œæ¥æ”¶ç«¯å¿…é¡»å¯¹æ¯ä¸€ä¸ªåŒ…è¿›è¡Œç¡®è®¤ï¼Œè¿™æ ·è®¾å¤‡ A ä¸€æ¬¡å¤šå‘é€å‡ ä¸ªç‰‡æ®µï¼Œè€Œä¸å¿…ç­‰å€™ ACKï¼ŒåŒæ—¶æ¥æ”¶ç«¯ä¹Ÿè¦å‘ŠçŸ¥å®ƒèƒ½å¤Ÿæ”¶å¤šå°‘ï¼Œè¿™æ ·å‘é€ç«¯å‘èµ·æ¥ä¹Ÿæœ‰ä¸ªé™åˆ¶ï¼Œå½“ç„¶è¿˜éœ€è¦ä¿è¯é¡ºåºæ€§ï¼Œä¸è¦ä¹±åºï¼Œå¯¹äºä¹±åºçš„çŠ¶å†µï¼Œæˆ‘ä»¬å¯ä»¥å…è®¸ç­‰å¾…ä¸€å®šæƒ…å†µä¸‹çš„ä¹±åºï¼Œæ¯”å¦‚è¯´å…ˆç¼“å­˜æå‰åˆ°çš„æ•°æ®ï¼Œç„¶åå»ç­‰å¾…éœ€è¦çš„æ•°æ®ï¼Œå¦‚æœä¸€å®šæ—¶é—´æ²¡æ¥å°± DROP æ‰ï¼Œæ¥ä¿è¯é¡ºåºæ€§ï¼ åœ¨ TCP/IP åè®®æ ˆä¸­ï¼Œæ»‘åŠ¨çª—å£çš„å¼•å…¥å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œå…ˆæ¥çœ‹ä»æ¦‚å¿µä¸Šæ•°æ®åˆ†ä¸ºå“ªäº›ç±» TCP header ä¸­æœ‰ä¸€ä¸ª Window Size å­—æ®µï¼Œå®ƒå…¶å®æ˜¯æŒ‡æ¥æ”¶ç«¯çš„çª—å£ï¼Œå³æ¥æ”¶çª—å£ï¼Œç”¨æ¥å‘ŠçŸ¥å‘é€ç«¯è‡ªå·±æ‰€èƒ½æ¥æ”¶çš„æ•°æ®é‡ï¼Œä»è€Œè¾¾åˆ°ä¸€éƒ¨åˆ†æµæ§çš„ç›®çš„ã€‚å…¶å® TCP åœ¨æ•´ä¸ªå‘é€è¿‡ç¨‹ä¸­ï¼Œä¹Ÿåœ¨åº¦é‡å½“å‰çš„ç½‘ç»œçŠ¶æ€ï¼Œç›®çš„æ˜¯ä¸ºäº†ç»´æŒä¸€ä¸ªå¥åº·ç¨³å®šçš„å‘é€è¿‡ç¨‹ï¼Œæ¯”å¦‚æ‹¥å¡æ§åˆ¶ã€‚å› æ­¤ï¼Œæ•°æ®æ˜¯åœ¨æŸäº›æœºåˆ¶çš„æ§åˆ¶ä¸‹è¿›è¡Œä¼ è¾“çš„ï¼Œå°±æ˜¯çª—å£æœºåˆ¶ã€‚å‘é€ç«¯çš„å‘é€çª—å£æ˜¯åŸºäºæ¥æ”¶ç«¯çš„æ¥æ”¶çª—å£æ¥è®¡ç®—çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ TCP æ˜¯æœ‰è¿æ¥çš„å‘é€ï¼Œæ•°æ®ä¼ è¾“éœ€è¦å¯¹ç«¯ç¡®è®¤ï¼Œå‘é€çš„æ•°æ®åˆ†ä¸ºå¦‚ä¸‹å››ç±»æ¥çœ‹ï¼Œå›¾ 1 å’Œå›¾ 2 ä»‹ç»çš„åŒä¸€ä¸ªä¸œè¥¿ å·²ç»å‘é€å¹¶ä¸”å¯¹ç«¯ç¡®è®¤ï¼ˆSent/ACKedï¼‰ï¼Œå‘é€çª—å¤–ï¼Œç¼“å†²åŒºå¤– å·²ç»å‘é€ä½†æœªæ”¶åˆ°ç¡®è®¤æ•°æ®ï¼ˆSent/UnACKedï¼‰ï¼Œå‘é€çª—å†…ï¼Œç¼“å†²åŒºå†… å…è®¸å‘é€ä½†å°šæœªé˜²çš„æ•°æ® â€‹ï¼ˆUnsent/Insideï¼‰ï¼Œå‘é€çª—å†…ï¼Œç¼“å†²åŒºå†… æœªå‘é€æš‚ä¸å…è®¸ï¼ˆUnsent/Outsideï¼‰ï¼Œå‘é€çª—å¤–ï¼Œç¼“å†²åŒºå†… â€‹ Sent and Acknowledgedï¼šè¿™äº›æ•°æ®è¡¨ç¤ºå·²ç»å‘é€æˆåŠŸå¹¶å·²ç»è¢«ç¡®è®¤çš„æ•°æ®ï¼Œæ¯”å¦‚å›¾ä¸­çš„å‰ 31 ä¸ª bytesï¼Œè¿™äº›æ•°æ®å…¶å®çš„ä½ç½®æ˜¯åœ¨çª—å£ä¹‹å¤–äº†ï¼Œå› ä¸ºçª—å£å†…é¡ºåºæœ€ä½çš„è¢«ç¡®è®¤ä¹‹åï¼Œè¦ç§»é™¤çª—å£ï¼Œå®é™…ä¸Šæ˜¯çª—å£è¿›è¡Œåˆæ‹¢ï¼ŒåŒæ—¶æ‰“å¼€æ¥æ”¶æ–°çš„å¸¦å‘é€çš„æ•°æ® Send But Not Yet Acknowledgedï¼šè¿™éƒ¨åˆ†æ•°æ®ç§°ä¸ºå‘é€ä½†æ²¡æœ‰è¢«ç¡®è®¤ï¼Œæ•°æ®è¢«å‘é€å‡ºå»ï¼Œæ²¡æœ‰æ”¶åˆ°æ¥æ”¶ç«¯çš„ ACKï¼Œè®¤ä¸ºå¹¶æ²¡æœ‰å®Œæˆå‘é€ï¼Œè¿™ä¸ªå±äºçª—å£å†…çš„æ•°æ®ã€‚ Not Sentï¼ŒRecipient Ready to Receiveï¼šè¿™éƒ¨åˆ†æ˜¯å°½å¿«å‘é€çš„æ•°æ®ï¼Œè¿™éƒ¨åˆ†æ•°æ®å·²ç»è¢«åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œä¹Ÿå°±æ˜¯çª—å£ä¸­äº†ï¼Œç­‰å¾…å‘é€ï¼Œå…¶å®è¿™ä¸ªçª—å£æ˜¯å®Œå…¨æœ‰æ¥æ”¶æ–¹å‘ŠçŸ¥çš„ï¼Œæ¥æ”¶æ–¹å‘ŠçŸ¥è¿˜æ˜¯èƒ½å¤Ÿæ¥å—è¿™äº›åŒ…ï¼Œæ‰€ä»¥å‘é€æ–¹éœ€è¦å°½å¿«çš„å‘é€è¿™äº›åŒ… Not Sentï¼ŒRecipient Not Ready to Receiveï¼š è¿™äº›æ•°æ®å±äºæœªå‘é€ï¼ŒåŒæ—¶æ¥æ”¶ç«¯ä¹Ÿä¸å…è®¸å‘é€çš„ï¼Œå› ä¸ºè¿™äº›æ•°æ®å·²ç»è¶…å‡ºäº†æ¥æ”¶ç«¯æ‰€æ¥æ”¶çš„èŒƒå›´ å¯¹äºæ¥æ”¶ç«¯ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªæ¥æ”¶çª—å£çš„ï¼Œç±»ä¼¼å‘é€ç«¯ï¼Œæ¥æ”¶ç«¯çš„æ•°æ®æœ‰ 3 ä¸ªåˆ†ç±»ï¼Œå› ä¸ºæ¥æ”¶ç«¯å¹¶ä¸éœ€è¦ç­‰å¾… ACK æ‰€ä»¥å®ƒæ²¡æœ‰ç±»ä¼¼çš„æ¥æ”¶å¹¶ç¡®è®¤äº†çš„åˆ†ç±»ï¼Œæƒ…å†µå¦‚ä¸‹ Received and ACK Not Send to Processï¼šè¿™éƒ¨åˆ†æ•°æ®å±äºæ¥æ”¶äº†æ•°æ®ä½†æ˜¯è¿˜æ²¡æœ‰è¢«ä¸Šå±‚çš„åº”ç”¨ç¨‹åºæ¥æ”¶ï¼Œä¹Ÿæ˜¯è¢«ç¼“å­˜åœ¨çª—å£å†… Received Not ACK: å·²ç»æ¥æ”¶å¹¶ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å›å¤ ACKï¼Œè¿™äº›åŒ…å¯èƒ½è¾“å±äº Delay ACK çš„èŒƒç•´äº† Not Receivedï¼šæœ‰ç©ºä½ï¼Œè¿˜æ²¡æœ‰è¢«æ¥æ”¶çš„æ•°æ®ã€‚ TCP çª—å£å°±æ˜¯è¿™æ ·é€æ¸æ»‘åŠ¨ï¼Œå‘é€æ–°çš„æ•°æ®ï¼Œæ»‘åŠ¨çš„ä¾æ®å°±æ˜¯å‘é€æ•°æ®å·²ç»æ”¶åˆ° ACKï¼Œç¡®è®¤å¯¹ç«¯æ”¶åˆ°ï¼Œæ‰èƒ½ç»§ç»­çª—å£æ»‘åŠ¨å‘é€æ–°çš„æ•°æ®ã€‚å¯ä»¥çœ‹åˆ°çª—å£å¤§å°å¯¹äºååé‡æœ‰ç€é‡è¦å½±å“ï¼ŒåŒæ—¶ ACK å“åº”ä¸ç³»ç»Ÿå»¶æ—¶åˆå¯†åˆ‡ç›¸å…³ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼šå¦‚æœå‘é€ç«¯çš„çª—å£è¿‡å¤§ä¼šå¼•èµ·æ¥æ”¶ç«¯å…³é—­çª—å£ï¼Œå¤„ç†ä¸è¿‡æ¥åä¹‹ï¼Œå¦‚æœçª—å£è®¾ç½®è¾ƒå°ï¼Œç»“æœå°±æ˜¯ä¸èƒ½å……åˆ†åˆ©ç”¨å¸¦å®½ï¼Œæ‰€ä»¥ä»”ç»†è°ƒèŠ‚çª—å£å¯¹äºé€‚åº”ä¸åŒå»¶è¿Ÿå’Œå¸¦å®½è¦æ±‚çš„ç³»ç»Ÿå¾ˆé‡è¦ã€‚ å‘é€çª—å£å’Œå¯ç”¨çª—å£å¯¹äºå‘é€æ–¹æ¥è®²ï¼Œçª—å£å†…çš„åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œå°±æ˜¯å‘é€çª—å£ï¼ˆå·²ç»å‘é€äº†ï¼Œä½†æ˜¯æ²¡æœ‰æ”¶åˆ° ACKï¼‰ï¼Œå¯ç”¨çª—å£ï¼Œæ¥æ”¶ç«¯å…è®¸å‘é€ä½†æ˜¯æ²¡æœ‰å‘é€çš„é‚£éƒ¨åˆ†ç§°ä¸ºå¯ç”¨çª—å£ã€‚ Send Window ï¼š 20 ä¸ª bytes è¿™éƒ¨åˆ†å€¼æ˜¯æœ‰æ¥æ”¶æ–¹åœ¨ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™è¿›è¡Œé€šå‘Šçš„ï¼ŒåŒæ—¶åœ¨æ¥æ”¶è¿‡ç¨‹ä¸­ä¹Ÿä¸æ–­çš„é€šå‘Šå¯ä»¥å‘é€çš„çª—å£å¤§å°ï¼Œæ¥è¿›è¡Œé€‚åº” Window Already Sent: å·²ç»å‘é€çš„æ•°æ®ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ”¶åˆ° ACKã€‚ æ»‘åŠ¨çª—å£åŸç†TCP å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªæŠ¥æ–‡æ®µéƒ½ä¼šå›å¤ ACK çš„ï¼Œå¯èƒ½ä¼šå¯¹ä¸¤ä¸ªæŠ¥æ–‡æ®µå‘é€ä¸€ä¸ª ACKï¼Œä¹Ÿå¯èƒ½ä¼šå¯¹å¤šä¸ªæŠ¥æ–‡æ®µå‘é€ 1 ä¸ª ACKã€ç´¯è®¡ ACKã€‘ï¼Œæ¯”å¦‚è¯´å‘é€æ–¹æœ‰ 1/2/3 3 ä¸ªæŠ¥æ–‡æ®µï¼Œå…ˆå‘é€äº† 2,3 ä¸¤ä¸ªæŠ¥æ–‡æ®µï¼Œä½†æ˜¯æ¥æ”¶æ–¹æœŸæœ›æ”¶åˆ° 1 æŠ¥æ–‡æ®µï¼Œè¿™ä¸ªæ—¶å€™ 2,3 æŠ¥æ–‡æ®µå°±åªèƒ½æ”¾åœ¨ç¼“å­˜ä¸­ç­‰å¾…æŠ¥æ–‡ 1 çš„ç©ºæ´è¢«å¡«ä¸Šï¼Œå¦‚æœæŠ¥æ–‡ 1ï¼Œä¸€ç›´ä¸æ¥ï¼ŒæŠ¥æ–‡ 2/3 ä¹Ÿå°†è¢«ä¸¢å¼ƒï¼Œå¦‚æœæŠ¥æ–‡ 1 æ¥äº†ï¼Œé‚£ä¹ˆä¼šå‘é€ä¸€ä¸ª ACK å¯¹è¿™ 3 ä¸ªæŠ¥æ–‡è¿›è¡Œä¸€æ¬¡ç¡®è®¤ã€‚ ä¸¾ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹æ»‘åŠ¨çª—å£çš„åŸç†ï¼š å‡è®¾ 32~45 è¿™äº›æ•°æ®ï¼Œæ˜¯ä¸Šå±‚ Application å‘é€ç»™ TCP çš„ï¼ŒTCP å°†å…¶åˆ†æˆå››ä¸ª Segment æ¥å‘å¾€ internet seg1 3234 seg2 3536 seg3 3741 seg4 4245 è¿™å››ä¸ªç‰‡æ®µï¼Œä¾æ¬¡å‘é€å‡ºå»ï¼Œæ­¤æ—¶å‡è®¾æ¥æ”¶ç«¯ä¹‹æ¥æ”¶åˆ°äº† seg1 seg2 seg4 æ­¤æ—¶æ¥æ”¶ç«¯çš„è¡Œä¸ºæ˜¯å›å¤ä¸€ä¸ª ACK åŒ…è¯´æ˜å·²ç»æ¥æ”¶åˆ°äº† 32~36 çš„æ•°æ®ï¼Œå¹¶å°† seg4 è¿›è¡Œç¼“å­˜ï¼ˆä¿è¯é¡ºåºï¼Œäº§ç”Ÿä¸€ä¸ªä¿å­˜ seg3 çš„ holeï¼‰ å‘é€ç«¯æ”¶åˆ° ACK ä¹‹åï¼Œå°±ä¼šå°† 32~36 çš„æ•°æ®åŒ…ä»å‘é€å¹¶æ²¡æœ‰ç¡®è®¤åˆ‡åˆ°å‘é€å·²ç»ç¡®è®¤ï¼Œæå‡ºçª—å£ï¼Œè¿™ä¸ªæ—¶å€™çª—å£å‘å³ç§»åŠ¨ å‡è®¾æ¥æ”¶ç«¯é€šå‘Šçš„ Window Size ä»ç„¶ä¸å˜ï¼Œæ­¤æ—¶çª—å£å³ç§»ï¼Œäº§ç”Ÿä¸€äº›æ–°çš„ç©ºä½ï¼Œè¿™äº›æ˜¯æ¥æ”¶ç«¯å…è®¸å‘é€çš„èŒƒç•´ å¯¹äºä¸¢å¤±çš„ seg3ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´ï¼ŒTCP å°±ä¼šé‡æ–°ä¼ é€ï¼ˆé‡ä¼ æœºåˆ¶ï¼‰ï¼Œé‡ä¼ æˆåŠŸä¼š seg3 seg4 ä¸€å—è¢«ç¡®è®¤ï¼Œä¸æˆåŠŸï¼Œseg4 ä¹Ÿå°†è¢«ä¸¢å¼ƒ å°±æ˜¯ä¸æ–­é‡å¤ç€ä¸Šè¿°çš„è¿‡ç¨‹ï¼Œéšç€çª—å£ä¸æ–­æ»‘åŠ¨ï¼Œå°†çœŸä¸ªæ•°æ®æµå‘é€åˆ°æ¥æ”¶ç«¯ï¼Œå®é™…ä¸Šæ¥æ”¶ç«¯çš„ Window Size é€šå‘Šä¹Ÿæ˜¯ä¼šå˜åŒ–çš„ï¼Œæ¥æ”¶ç«¯æ ¹æ®è¿™ä¸ªå€¼æ¥ç¡®å®šä½•æ—¶åŠå‘é€å¤šå°‘æ•°æ®ï¼Œä»å¯¹æ•°æ®æµè¿›è¡Œæµæ§ã€‚åŸç†å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ»‘åŠ¨çª—å£åŠ¨æ€è°ƒæ•´ä¸»è¦æ˜¯æ ¹æ®æ¥æ”¶ç«¯çš„æ¥æ”¶æƒ…å†µï¼ŒåŠ¨æ€å»è°ƒæ•´ Window Sizeï¼Œç„¶åæ¥æ§åˆ¶å‘é€ç«¯çš„æ•°æ®æµé‡ã€‚ å®¢æˆ·ç«¯ä¸æ–­å¿«é€Ÿå‘é€æ•°æ®ï¼ŒæœåŠ¡å™¨æ¥æ”¶ç›¸å¯¹è¾ƒæ…¢ï¼Œçœ‹ä¸‹å®éªŒçš„ç»“æœï¼š åŒ… 175ï¼Œå‘é€ ACK æºå¸¦ WIN = 384ï¼Œå‘ŠçŸ¥å®¢æˆ·ç«¯ï¼Œç°åœ¨åªèƒ½æ¥æ”¶ 384 ä¸ªå­—èŠ‚ åŒ… 176ï¼Œå®¢æˆ·ç«¯æœçœŸåªå‘é€äº† 384 ä¸ªå­—èŠ‚ï¼ŒWireshark ä¹Ÿæ¯”è¾ƒæ™ºèƒ½ï¼Œä¹Ÿå®£å‘Š TCP Window Full åŒ… 177ï¼ŒæœåŠ¡å™¨å›å¤ä¸€ä¸ª ACKï¼Œå¹¶é€šå‘Šçª—å£ä¸º 0ï¼Œè¯´æ˜æ¥æ”¶æ–¹å·²ç»æ”¶åˆ°æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä¿å­˜åˆ°ç¼“å†²åŒºï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™åº”ç”¨ç¨‹åºå¹¶æ²¡æœ‰æ¥æ”¶è¿™äº›æ•°æ®ï¼Œå¯¼è‡´ç¼“å†²åŒºæ²¡æœ‰æ›´å¤šçš„ç©ºé—´ï¼Œæ•…é€šå‘Šçª—å£ä¸º 0, è¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„é›¶çª—å£ï¼Œé›¶çª—å£æœŸé—´ï¼Œå‘é€æ–¹åœæ­¢å‘é€æ•°æ® å®¢æˆ·ç«¯å¯Ÿè§‰åˆ°çª—å£ä¸º 0ï¼Œåˆ™ä¸å†å‘é€æ•°æ®ç»™æ¥æ”¶æ–¹ åŒ… 178ï¼Œæ¥æ”¶æ–¹å‘é€ä¸€ä¸ªçª—å£é€šå‘Šï¼Œå‘ŠçŸ¥å‘é€æ–¹å·²ç»æœ‰æ¥æ”¶æ•°æ®çš„èƒ½åŠ›äº†ï¼Œå¯ä»¥å‘é€æ•°æ®åŒ…äº† åŒ… 179ï¼Œæ”¶åˆ°çª—å£é€šå‘Šä¹‹åï¼Œå°±å‘é€ç¼“å†²åŒºå†…çš„æ•°æ®äº†. TCP çª—å£å¤§å°æœ€æ—© TCP åè®®æ¶‰åŠç”¨æ¥å¤§èŒƒå›´ç½‘ç»œä¼ è¾“æ—¶å€™ï¼Œå…¶å®æ˜¯æ²¡æœ‰è¶…è¿‡ 56Kb/s çš„ â€‹ è¿æ¥é€Ÿåº¦çš„ã€‚å› æ­¤ï¼ŒTCP åŒ…å¤´ä¸­åªä¿ç•™äº† 16bit ç”¨æ¥æ ‡è¯†çª—å£å¤§å°ï¼Œå…è®¸çš„æœ€å¤§ç¼“å­˜å¤§å°ä¸è¶…è¿‡ 64KBã€‚ä¸ºäº†æ‰“ç ´è¿™ä¸€é™åˆ¶ï¼ŒRFC1323 è§„å®šäº† TCP çª—å£å°ºå¯¸é€‰æ‹©ï¼Œæ˜¯åœ¨ TCP è¿æ¥å¼€å§‹çš„æ—¶å€™ä¸‰æ­¥æ¡æ‰‹çš„æ—¶å€™åå•†çš„ï¼ˆSYN, SYN-ACK,ACKï¼‰ï¼Œä¼šåå•†ä¸€ä¸ª Window size scaling factorï¼Œä¹‹åäº¤äº’æ•°æ®ä¸­çš„æ˜¯ Window size valueï¼Œæ‰€ä»¥æœ€ç»ˆçš„çª—å£å¤§å°æ˜¯äºŒè€…çš„ä¹˜ç§¯. Window size value: 64 or 0000 0000 0100 0000 (16 bits) â€‹- Window size scaling factor: 256 or 2 ^ 8 (as advertised by the 1st packet) The actual window size is 16,384 (64 * 256) è¿™é‡Œçš„çª—å£å¤§å°å°±æ„å‘³ç€ï¼Œç›´åˆ°å‘é€ 16384 ä¸ªå­—èŠ‚ï¼Œæ‰ä¼šåœæ­¢ç­‰å¾…å¯¹æ–¹çš„ ACK.éšç€åŒæ–¹å›è¯ç»§ç»­ï¼Œçª—å£çš„å¤§å°å¯ä»¥ä¿®æ”¹ window size value å‚æ•°å®Œæˆå˜çª„æˆ–å˜å®½ï¼Œä½†æ˜¯æ³¨æ„ï¼šWindow size scaling factor ä¹˜ç§¯å› å­å¿…é¡»ä¿æŒä¸å˜ã€‚åœ¨ RFC1323 ä¸­è§„å®šçš„åç§»ï¼ˆshift countï¼‰æ˜¯ 14ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¤§çš„çª—å£å¯ä»¥è¾¾åˆ° Gbitï¼Œå¾ˆå¤§ã€‚ TCP çª—å£çš„å‚æ•°è®¾ç½®TCP çª—å£èµ·ç€æ§åˆ¶æµé‡çš„ä½œç”¨ï¼Œå®é™…ä½¿ç”¨æ—¶è¿™æ˜¯ä¸€ä¸ªåŒç«¯åè°ƒçš„è¿‡ç¨‹ï¼Œè¿˜æ¶‰åŠåˆ° TCP çš„æ…¢å¯åŠ¨â€‹ï¼ˆRapid Increase/Multiplicative Decreaseï¼‰ï¼Œæ‹¥å¡é¿å…ï¼Œæ‹¥å¡çª—å£å’Œæ‹¥å¡æ§åˆ¶ã€‚å¯ä»¥è®°ä½ï¼Œå‘é€é€Ÿç‡æ˜¯ç”± minï¼ˆæ‹¥å¡çª—å£[cwnd]ï¼Œæ¥æ”¶çª—å£[rwnd]ï¼‰ï¼Œæ¥æ”¶çª—å£åœ¨ä¸‹æ–‡æœ‰è®²ã€‚ TCP çª—å£ä¼˜åŒ–è®¾ç½® â€‹TCPâ€‹ çª—å£æ—¢ç„¶é‚£ä¹ˆé‡è¦ï¼Œé‚£è¦æ€ä¹ˆè®¾ç½®ï¼Œä¸€ä¸ªç®€å•çš„åŸåˆ™æ˜¯ 2 å€çš„ BDP.è¿™é‡Œçš„ BDP çš„æ„æ€æ˜¯ bandwidth-delay productï¼Œä¹Ÿå°±æ˜¯å¸¦å®½å’Œæ—¶å»¶çš„ä¹˜ç§¯ï¼Œå¸¦å®½å¯¹äºç½‘ç»œå–æœ€å·®è¿æ¥çš„å¸¦å®½ã€‚ 1buffer size &#x3D; 2 * bandwidth * delayâ€‹ è¿˜æœ‰ä¸€ç§ç®€å•çš„æ–¹å¼ï¼Œä½¿ç”¨ ping æ¥è®¡ç®—ç½‘ç»œçš„ç¯å›æ—¶å»¶ï¼ˆRTTï¼‰ï¼Œç„¶åè¡¨è¾¾ä¸ºï¼š 1buffer size &#x3D; bandwidth * RTTâ€‹ ä¸ºä»€ä¹ˆæ˜¯ 2 å€ï¼Ÿå› ä¸ºå¯ä»¥è¿™ä¹ˆæƒ³ï¼Œå¦‚æœæ»‘åŠ¨çª—å£æ˜¯ bandwidth\\*delayï¼Œå½“å‘é€ä¸€æ¬¡æ•°æ®æœ€åä¸€ä¸ªå­—èŠ‚åˆšåˆ°æ—¶ï¼Œå¯¹ç«¯è¦å› ACK æ‰èƒ½ç»§ç»­å‘é€ï¼Œå°±éœ€è¦ç­‰å¾…ä¸€æ¬¡å•å‘æ—¶å»¶çš„æ—¶é—´(å¯ä»¥ç»Ÿç§°ä¸ºRTT/2)ï¼Œæ‰€ä»¥å½“æ˜¯ 2 å€æ—¶ï¼Œåˆšå¥½å°±èƒ½åœ¨ç­‰ ACK çš„æ—¶é—´ç»§ç»­å‘é€æ•°æ®ï¼Œç­‰æ”¶åˆ° ACK æ—¶æ•°æ®åˆšå¥½å‘é€å®Œæˆï¼Œè¿™æ ·å°±æé«˜äº†æ•ˆç‡ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šå¸¦å®½æ˜¯ 20Mbps,é€šè¿‡ ping æˆ‘ä»¬è®¡ç®—å•å‘æ—¶å»¶æ˜¯ 20msï¼Œé‚£ä¹ˆå¯ä»¥è®¡ç®—ï¼š20000000bps*8*0.02 = 52,428bytesâ€‹ï¼Œå› æ­¤æˆ‘ä»¬æœ€ä¼˜çª—å£ç”¨ 104,856 bytes = 2 x 52,428ï¼Œæ‰€ä»¥è¯´å½“å‘é€è€…å‘é€ 104,856 bytes æ•°æ®åæ‰éœ€è¦ç­‰å¾…ä¸€ä¸ª ACK å“åº”ï¼Œå½“å‘é€äº†ä¸€åŠçš„æ—¶å€™ï¼Œå¯¹ç«¯å·²ç»æ”¶åˆ°å¹¶ä¸”è¿”å› ACKï¼ˆç†æƒ³æƒ…å†µï¼‰ï¼Œç­‰åˆ° ACK å›æ¥ï¼ŒåˆæŠŠå‰©ä¸‹çš„ä¸€åŠå‘é€å‡ºå»äº†ï¼Œæ‰€ä»¥å‘é€ç«¯å°±æ— éœ€ç­‰å¾… ACK è¿”å›ã€‚ æ³¨æ„æˆ‘ä»¬è¿™é‡Œçš„ bps(bit peer second)ï¼Œæ‰€ä»¥è½¬æˆ bytes çš„æ—¶å€™éœ€è¦æ³¨æ„ 8 å€çš„è½¬æ¢ å‘ç°äº†ä¹ˆï¼Ÿè¿™é‡Œçš„çª—å£å·²ç»æ˜æ˜¾å¤§äº 64KB äº†ï¼Œæ‰€ä»¥æœºåˆ¶æ”¹å–„äº†ã€‚ TCP æ‹¥å¡æ§åˆ¶ç°åœ¨æˆ‘ä»¬çœ‹çœ‹åˆ°åº•å¦‚ä½•æ§åˆ¶æµé‡ã€‚TCP åœ¨ä¼ è¾“æ•°æ®æ—¶å’Œ windows size å…³ç³»å¯†åˆ‡ï¼Œæœ¬èº«çª—å£ç”¨æ¥æ§åˆ¶æµé‡ï¼Œåœ¨ä¼ è¾“æ•°æ®æ—¶ï¼Œå‘é€æ–¹æ•°æ®è¶…è¿‡æ¥æ”¶æ–¹å°±ä¼šä¸¢åŒ…ï¼Œæµé‡æ§åˆ¶ï¼Œæµé‡æ§åˆ¶è¦æ±‚æ•°æ®ä¼ è¾“åŒæ–¹åœ¨æ¯æ¬¡äº¤äº’æ—¶å£°æ˜å„è‡ªçš„æ¥æ”¶çª—å£ã€Œrwndã€å¤§å°ï¼Œç”¨æ¥è¡¨ç¤ºè‡ªå·±æœ€å¤§èƒ½ä¿å­˜å¤šå°‘æ•°æ®ï¼Œè¿™ä¸»è¦æ˜¯é’ˆå¯¹æ¥æ”¶æ–¹è€Œè¨€çš„ï¼Œé€šä¿—ç‚¹å„¿è¯´å°±æ˜¯è®©å‘é€æ–¹çŸ¥é“æ¥æ”¶æ–¹èƒ½åƒå‡ ç¢—é¥­ï¼Œå¦‚æœçª—å£è¡°å‡åˆ°é›¶ï¼Œä¹Ÿå°±æ˜¯å‘é€æ–¹ä¸èƒ½å†å‘äº†ï¼Œé‚£ä¹ˆå°±è¯´æ˜åƒé¥±äº†ï¼Œå¿…é¡»æ¶ˆåŒ–æ¶ˆåŒ–ï¼Œå¦‚æœç¡¬æ’‘èƒ€æ¼äº†ï¼Œé‚£å°±æ˜¯ä¸¢åŒ…äº†ã€‚ TCP çš„æ‹¥å¡æ§åˆ¶ä¸»è¦ä¾èµ–äº æ‹¥å¡çª—å£(congestion window, cwnd) å’Œ æ…¢å¯åŠ¨é˜ˆå€¼(slow start threshold, ssthresh)ã€‚cwnd æ˜¯å‘é€ç«¯æ ¹æ®ç½‘ç»œçš„æ‹¥å¡ç¨‹åº¦æ‰€é¢„è®¾çš„ä¸€ä¸ªçª—å£å¤§å°ï¼Œè€Œ ssthresh åˆ™æ˜¯æ…¢å¯åŠ¨çª—å£çš„é˜ˆå€¼ï¼Œcwnd è¶…è¿‡æ­¤é˜ˆå€¼åˆ™è½¬å˜æ§åˆ¶ç­–ç•¥ã€‚ TCP æ‹¥å¡æ§åˆ¶çš„ä¸»è¦ç®—æ³•æœ‰ æ…¢å¯åŠ¨(Slow Start)ã€æ‹¥å¡é¿å…(Congestion Avoidance)ã€å¿«é€Ÿé‡ä¼ (Fast Retransmit)ã€å¿«é€Ÿæ¢å¤(Fast Recovery)ç­‰ã€‚ æ…¢å¯åŠ¨(Slow Start)è™½ç„¶æµé‡æ§åˆ¶å¯ä»¥é¿å…å‘é€æ–¹è¿‡è½½æ¥æ”¶æ–¹ï¼Œä½†æ˜¯å´æ— æ³•é¿å…è¿‡è½½ç½‘ç»œï¼Œè¿™æ˜¯å› ä¸ºæ¥æ”¶çª—å£ã€Œrwndã€åªåæ˜ äº†æœåŠ¡å™¨ä¸ªä½“çš„æƒ…å†µï¼Œå´æ— æ³•åæ˜ ç½‘ç»œæ•´ä½“çš„æƒ…å†µã€‚sä¸ºäº†é¿å…ç½‘ç»œè¿‡è½½ï¼Œæ…¢å¯åŠ¨å¼•å…¥äº†æ‹¥å¡çª—å£ã€Œcwndã€s çš„æ¦‚å¿µï¼Œç”¨æ¥è¡¨ç¤ºå‘é€æ–¹åœ¨å¾—åˆ°æ¥æ”¶æ–¹ç¡®è®¤å‰ï¼Œæœ€å¤§å…è®¸ä¼ è¾“çš„æœªç»ç¡®è®¤çš„æ•°æ®ã€‚ã€Œcwndã€åŒã€Œrwndã€ç›¸æ¯”ä¸åŒçš„æ˜¯ï¼šå®ƒåªæ˜¯å‘é€æ–¹çš„ä¸€ä¸ªå†…éƒ¨å‚æ•°ï¼Œæ— éœ€é€šçŸ¥ç»™æ¥æ”¶æ–¹ï¼Œå…¶åˆå§‹å€¼å¾€å¾€æ¯”è¾ƒå°ï¼Œç„¶åéšç€æ•°æ®åŒ…è¢«æ¥æ”¶æ–¹ç¡®è®¤ï¼Œçª—å£æˆå€æ‰©å¤§ï¼Œæœ‰ç‚¹ç±»ä¼¼äºæ‹³å‡»æ¯”èµ›ï¼Œå¼€å§‹æ—¶ä¸äº†è§£æ•Œæƒ…ï¼Œå¾€å¾€æ˜¯æ¬¡æ‹³è¯•æ¢ï¼Œæ…¢æ…¢å¿ƒé‡Œæœ‰åº•äº†ï¼Œå¼€å§‹é€æ¸åŠ å¤§é‡æ‹³è¿›æ”»çš„åŠ›åº¦ã€‚ åœ¨æ…¢å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œéšç€ã€Œcwndã€çš„å¢åŠ ï¼Œå¯èƒ½ä¼šå‡ºç°ç½‘ç»œè¿‡è½½ï¼Œå…¶å¤–åœ¨è¡¨ç°å°±æ˜¯ä¸¢åŒ…ï¼Œä¸€æ—¦å‡ºç°æ­¤ç±»é—®é¢˜ï¼Œã€Œcwndã€çš„å¤§å°ä¼šè¿…é€Ÿè¡°å‡ï¼Œä»¥ä¾¿ç½‘ç»œèƒ½å¤Ÿç¼“è¿‡æ¥ã€‚ è¯´æ˜ï¼šç½‘ç»œä¸­å®é™…ä¼ è¾“çš„æœªç»ç¡®è®¤çš„æ•°æ®å¤§å°å–å†³äºã€Œrwndã€å’Œã€Œcwndã€ä¸­çš„å°å€¼ã€‚ æ‹¥å¡é¿å… â€‹ä»æ…¢å¯åŠ¨çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°ï¼Œå‘é€æ–¹é€šè¿‡å¯¹ã€Œcwndã€å¤§å°çš„æ§åˆ¶ï¼Œèƒ½å¤Ÿé¿å…ç½‘ç»œè¿‡è½½ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œä¸¢åŒ…ä¸å…¶è¯´æ˜¯ä¸€ä¸ªç½‘ç»œé—®é¢˜ï¼Œå€’ä¸å¦‚è¯´æ˜¯ä¸€ç§åé¦ˆæœºåˆ¶ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ„ŸçŸ¥åˆ°å‘ç”Ÿäº†ç½‘ç»œæ‹¥å¡ï¼Œè¿›è€Œè°ƒæ•´æ•°æ®ä¼ è¾“ç­–ç•¥ï¼Œå®é™…ä¸Šï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ…¢å¯åŠ¨é˜ˆå€¼ã€Œssthreshã€çš„æ¦‚å¿µï¼Œå¦‚æœã€Œcwndã€å°äºã€Œssthreshã€ï¼Œé‚£ä¹ˆè¡¨ç¤ºåœ¨æ…¢å¯åŠ¨é˜¶æ®µï¼›å¦‚æœã€Œcwndã€å¤§äºã€Œssthreshã€ï¼Œé‚£ä¹ˆè¡¨ç¤ºåœ¨æ‹¥å¡é¿å…é˜¶æ®µï¼Œæ­¤æ—¶ã€Œcwndã€ä¸å†åƒæ…¢å¯åŠ¨é˜¶æ®µé‚£æ ·å‘ˆæŒ‡æ•°çº§æ•´æ•´ï¼Œè€Œæ˜¯è¶‹å‘äºçº¿æ€§å¢é•¿ï¼Œä»¥æœŸé¿å…ç½‘ç»œæ‹¥å¡ï¼Œæ­¤é˜¶æ®µæœ‰å¤šç§ç®—æ³•å®ç°ï¼Œé€šå¸¸ä¿æŒç¼ºçœå³å¯ã€‚ å¦‚ä½•è°ƒæ•´ã€Œrwndã€åˆ°ä¸€ä¸ªåˆç†å€¼å¾ˆå¤šæ—¶å€™ TCP çš„ä¼ è¾“é€Ÿç‡å¼‚å¸¸åä½ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯æ¥æ”¶çª—å£ã€Œrwndã€è¿‡å°å¯¼è‡´ï¼Œå°¤å…¶å¯¹äºæ—¶å»¶è¾ƒå¤§çš„ç½‘ç»œï¼Œå®é™…ä¸Šæ¥æ”¶çª—å£ã€Œrwndã€çš„åˆç†å€¼å–å†³äº BDP çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯å¸¦å®½å’Œå»¶è¿Ÿçš„ä¹˜ç§¯ã€‚å‡è®¾å¸¦å®½æ˜¯ 100Mbpsï¼Œå»¶è¿Ÿæ˜¯ 100msï¼Œé‚£ä¹ˆè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š 1BDP &#x3D; 100Mbps * 100ms &#x3D; (100 &#x2F; 8) * (100 &#x2F; 1000) &#x3D; 1.25MBâ€‹ æ­¤é—®é¢˜ä¸‹å¦‚æœæƒ³æœ€å¤§é™åº¦æå‡ååº¦é‡ï¼Œæ¥æ”¶çª—å£ã€Œrwndã€çš„å¤§å°ä¸åº”å°äº 1.25MBã€‚ å¦‚ä½•è°ƒæ•´ã€Œcwndã€åˆ°ä¸€ä¸ªåˆç†å€¼ä¸€èˆ¬æ¥è¯´ã€Œcwndã€çš„åˆå§‹å€¼å–å†³äº MSS çš„å¤§å°ï¼Œè®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š 1min(4 * MSS, max(2 * MSS, 4380)) å…·ä½“æ¥è¯´ï¼Œæ–°å»º TCP è¿æ¥æ—¶ï¼Œcwnd éœ€åˆå§‹åŒ–ä¸ºä¸€ä¸ªæˆ–å‡ ä¸ªæœ€å¤§å‘é€æŠ¥æ–‡æ®µå¤§å°(send maximum segment size, SMSS æˆ–è€…æœ‰ä¸€äº›ä¹Ÿå« MSS)ã€‚å…·ä½“è§„åˆ™ï¼ˆIW ä¸ºåˆå§‹çª—å£å¤§å°ï¼‰ï¼š 1234567IW &#x3D; 1*(SMSS) (if SMSS &lt;&#x3D; 2190 bytes)IW &#x3D; 2*(SMSS) and not more than 2 segments (if SMSS &gt; 2190 bytes)IW &#x3D; 3*(SMSS) and not more than 3 segments (if 2190 â‰¥ SMSS &gt; 1095 bytes)IW &#x3D; 4*(SMSS) and not more than 4 segments (otherwise) ä»¥å¤ªç½‘æ ‡å‡†çš„ MSS å¤§å°é€šå¸¸æ˜¯ 1460ï¼Œæ‰€ä»¥ã€Œcwndã€çš„åˆå§‹å€¼æ˜¯ 3MSSã€‚å½“æˆ‘ä»¬æµè§ˆè§†é¢‘æˆ–è€…ä¸‹è½½è½¯ä»¶çš„æ—¶å€™ï¼Œã€Œcwndã€åˆå§‹å€¼çš„å½±å“å¹¶ä¸æ˜æ˜¾ï¼Œè¿™æ˜¯å› ä¸ºä¼ è¾“çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œå³ä¾¿æ…¢å¯åŠ¨é˜¶æ®µã€Œcwndã€åˆå§‹å€¼æ¯”è¾ƒå°ï¼Œä¹Ÿä¼šåœ¨ç›¸å¯¹å¾ˆçŸ­çš„æ—¶é—´å†…åŠ é€Ÿåˆ°æ»¡çª—å£ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ ä¸è¿‡å½“æˆ‘ä»¬æµè§ˆç½‘é¡µçš„æ—¶å€™ï¼Œæƒ…å†µå°±ä¸ä¸€æ ·äº†ï¼Œè¿™æ˜¯å› ä¸ºä¼ è¾“çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼Œæ—¶é—´æ¯”è¾ƒçŸ­ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œå¦‚æœæ…¢å¯åŠ¨é˜¶æ®µã€Œcwndã€åˆå§‹å€¼æ¯”è¾ƒå°ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½è¿˜æ²¡æ¥å¾—åŠåŠ é€Ÿåˆ°æ»¡çª—å£ï¼Œé€šè®¯å°±ç»“æŸäº†ã€‚è¿™å°±å¥½æ¯”åšå°”ç‰¹å‚åŠ ç™¾ç±³æ¯”èµ›ï¼Œå¦‚æœèµ·è·‘æ…¢çš„è¯ï¼Œå³ä¾¿ä»–çš„åŠ é€Ÿå¾ˆå¿«ï¼Œä¹Ÿå¯èƒ½æ‹¿ä¸åˆ°å¥½æˆç»©ï¼Œå› ä¸ºè¿˜æ²¡ç­‰ä»–å®Œå…¨è·‘èµ·æ¥ï¼Œç»ˆç‚¹çº¿å·²ç»åˆ°äº†ã€‚ å¦‚æœ TCP è¿æ¥ä¸€å»ºç«‹å°±å‘æœåŠ¡å™¨å¤§é‡å‘åŒ…ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ‹¥å¡ã€‚å› æ­¤ï¼Œæ–°å»ºç«‹çš„è¿æ¥ä¸èƒ½ä¸€å¼€å§‹å°±å¤§é‡å‘é€æ•°æ®åŒ…ï¼Œè€Œæ˜¯åº”è¯¥æ ¹æ®ç½‘ç»œçŠ¶å†µï¼Œé€æ­¥åœ°å¢åŠ æ¯æ¬¡å‘é€æ•°æ®åŒ…çš„é‡ï¼Œè¿™å°±æ˜¯æ…¢å¯åŠ¨ã€‚æ…¢å¯åŠ¨é€šå¸¸åœ¨æ–°å»ºç«‹ TCP è¿æ¥æˆ–ç”±äº RTOï¼ˆé‡ä¼ è¶…æ—¶ï¼‰ è€Œä¸¢åŒ…æ—¶æ‰§è¡Œã€‚ å½“ cwnd å€¼è¶…è¿‡ ssthresh å€¼æ—¶ï¼Œæ…¢å¯åŠ¨è¿‡ç¨‹ç»“æŸï¼Œè¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µã€‚åœ¨æ‹¥å¡é¿å…é˜¶æ®µï¼Œcwnd å°†ä¸å†å‘ˆæŒ‡æ•°å¢é•¿ï¼Œè€Œæ˜¯å‘ˆçº¿æ€§å¢é•¿ã€‚ æ”¶åˆ°ä¸€ä¸ª ACK æ—¶ï¼Œcwnd = cwnd + 1/cwnd å½“æ¯è¿‡ä¸€ä¸ª RTT æ—¶ï¼Œcwnd = cwnd + 1 è¿™æ ·æ”¾ç¼“äº†æ‹¥å¡çª—å£çš„å¢é•¿é€Ÿç‡ï¼Œé¿å…å¢é•¿è¿‡å¿«å¯¼è‡´ç½‘ç»œæ‹¥å¡ï¼Œæ…¢æ…¢çš„å¢åŠ è°ƒæ•´åˆ°ç½‘ç»œçš„æœ€ä½³å€¼ã€‚ æ‹¥å¡çŠ¶æ€ ç­‰å¾… RTO è¶…æ—¶ï¼Œé‡ä¼ æ•°æ®åŒ…ï¼Œæ­¤æ—¶ TCP ååº”å¼ºçƒˆï¼š å°† ssthresh é™ä½ä¸ºæ­¤æ—¶ cwnd çš„ä¸€åŠ å°† cwnd é‡æ–°è®¾ä¸ºåˆå§‹å€¼(IW) é‡æ–°è¿›å…¥æ…¢å¯åŠ¨é˜¶æ®µ åŸåˆ™ï¼šåŠ æ³•å¢å¤§ã€ä¹˜æ³•å‡å°ã€‚ è¿ç»­æ”¶åˆ° 3 ä¸ª duplicate ACK æ—¶ï¼Œé‡ä¼ æ•°æ®åŒ…ï¼Œæ— é¡»ç­‰å¾… RTOã€‚ å¿«é€Ÿé‡ä¼ TCP åœ¨æ”¶åˆ°ä¸€ä¸ªä¹±åºçš„æŠ¥æ–‡æ®µæ—¶ï¼Œä¼šç«‹å³å‘é€ä¸€ä¸ªé‡å¤çš„ ACKï¼Œå¹¶ä¸”æ­¤ ACK ä¸å¯è¢«å»¶è¿Ÿã€‚ å¦‚æœè¿ç»­æ”¶åˆ° 3 ä¸ªæˆ– 3 ä¸ªä»¥ä¸Šé‡å¤çš„ ACKï¼ŒTCP ä¼šåˆ¤å®šæ­¤æŠ¥æ–‡æ®µä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ä¼ é€’ï¼Œè€Œæ— éœ€ç­‰å¾… RTOã€‚è¿™å°±å«åšå¿«é€Ÿé‡ä¼ ã€‚ å¿«é€Ÿæ¢å¤å¿«é€Ÿæ¢å¤æ˜¯æŒ‡å¿«é€Ÿé‡ä¼ åç›´æ¥è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µè€Œéæ…¢å¯åŠ¨é˜¶æ®µã€‚æ€»ç»“ä¸€ä¸‹å¿«é€Ÿæ¢å¤çš„æ­¥éª¤ï¼ˆä»¥ SMSS ä¸ºå•ä½ï¼‰ï¼š å½“æ”¶åˆ° 3 ä¸ªé‡å¤çš„ ACK æ—¶ï¼Œå°† ssthresh è®¾ç½®ä¸º cwnd çš„ä¸€åŠ(ssthresh = cwnd/2)ï¼Œç„¶åå°† cwnd çš„å€¼è®¾ä¸º ssthresh åŠ  3(cwnd = ssthresh + 3)ï¼Œç„¶åå¿«é€Ÿé‡ä¼ ä¸¢å¤±çš„æŠ¥æ–‡æ®µ æ¯æ¬¡æ”¶åˆ°é‡å¤çš„ ACK æ—¶ï¼Œcwnd å¢åŠ  1(cwnd += 1)ï¼Œå¹¶å‘é€ 1 ä¸ª packet(å¦‚æœå…è®¸çš„è¯) å½“æ”¶åˆ°æ–°çš„ ACK æ—¶ï¼Œå°† cwnd è®¾ç½®ä¸ºç¬¬ä¸€æ­¥ä¸­ ssthresh çš„å€¼(cwnd = ssthresh)ï¼Œä»£è¡¨æ¢å¤è¿‡ç¨‹ç»“æŸå¿«é€Ÿæ¢å¤åå°†è¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µã€‚ è¿˜æœ‰å…¶ä»–çš„å……ä¼ ç›¸å…³çš„å†…å®¹ä¼šæ”¾åœ¨å…¶ä»–æ–‡ç« ä¸­ã€‚ æ€»ç»“ä»ä¼ è¾“æ•°æ®æ¥è®²ï¼ŒTCP/UDP ä»¥åŠå…¶ä»–åè®®éƒ½å¯ä»¥å®Œæˆæ•°æ®çš„ä¼ è¾“ï¼Œä»ä¸€ç«¯ä¼ è¾“åˆ°å¦å¤–ä¸€ç«¯ï¼ŒTCP æ¯”è¾ƒå‡ºä¼—çš„ä¸€ç‚¹å°±æ˜¯æä¾›ä¸€ä¸ªå¯é çš„ï¼Œæµæ§çš„æ•°æ®ä¼ è¾“ï¼Œæ‰€ä»¥å®ç°èµ·æ¥è¦æ¯”å…¶ä»–åè®®å¤æ‚çš„å¤šï¼Œå…ˆæ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªä¿®é¥°è¯çš„æ„ä¹‰ï¼š Reliability ï¼Œæä¾› TCP çš„å¯é æ€§ï¼ŒTCP çš„ä¼ è¾“è¦ä¿è¯æ•°æ®èƒ½å¤Ÿå‡†ç¡®åˆ°è¾¾ç›®çš„åœ°ï¼Œå¦‚æœä¸èƒ½ï¼Œéœ€è¦èƒ½æ£€æµ‹å‡ºæ¥å¹¶ä¸”é‡æ–°å‘é€æ•°æ®ã€‚ Data Flow Controlï¼Œæä¾› TCP çš„æµæ§ç‰¹æ€§ï¼Œç®¡ç†å‘é€æ•°æ®çš„é€Ÿç‡ï¼Œä¸è¦è¶…è¿‡è®¾å¤‡çš„æ‰¿è½½èƒ½åŠ›","categories":[{"name":"ç½‘ç»œåè®®","slug":"ç½‘ç»œåè®®","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"TCP","slug":"TCP","permalink":"http://blog.crazylaw.cn/tags/TCP/"}]},{"title":"ã€ç½‘ç»œåè®®ã€‘TCP/IPåè®®","slug":"ç½‘ç»œåè®®/TCP-IP","date":"2019-08-06T02:43:43.000Z","updated":"2021-03-20T16:25:01.822Z","comments":true,"path":"2019/08/06/ç½‘ç»œåè®®/TCP-IP/","link":"","permalink":"http://blog.crazylaw.cn/2019/08/06/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/TCP-IP/","excerpt":"å‰è¨€ç”±äºæœ€è¿‘çœ‹äº† Redis5 çš„æºç ï¼Œæ‰€ä»¥å¯¹ç½‘ç»œç¼–ç¨‹åˆè¿›ä¸€æ­¥åŠ æ·±äº†äº†è§£ï¼Œåœ¨è¿™é‡Œï¼Œç”±äºæ²¡æœ‰å¾ˆç³»ç»Ÿçš„æ•´ç†è¿‡ TCP/IP åè®®ç›¸å…³çš„å†…å®¹ï¼Œæ‰€ä»¥å†™ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œä»¥æ­¤æ¥è®°å½•æˆ‘æœ€è¿‘å­¦ä¹ åˆ°çš„å†…å®¹ï¼Œå†…å®¹ä¼šåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ã€‚ TCP/IP åè®®ï¼Œä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹ï¼Œåè®®ç»†èŠ‚ åè®®ç›¸å…³çš„ç»†èŠ‚ï¼Œä¼˜åŒ–è°ƒæ•´å†…æ ¸å‚æ•° æ¨¡æ‹Ÿå¼‚å¸¸è¿æ¥ï¼Œä¼˜åŒ–è°ƒæ•´å†…æ ¸å‚æ•° åˆ©ç”¨ C è¯­è¨€ï¼ŒåŸºäº epoll å†™ä¸€ä¸ªæ”¯æŒé«˜å¹¶å‘çš„ TCP èŠå¤©æœåŠ¡å™¨","text":"å‰è¨€ç”±äºæœ€è¿‘çœ‹äº† Redis5 çš„æºç ï¼Œæ‰€ä»¥å¯¹ç½‘ç»œç¼–ç¨‹åˆè¿›ä¸€æ­¥åŠ æ·±äº†äº†è§£ï¼Œåœ¨è¿™é‡Œï¼Œç”±äºæ²¡æœ‰å¾ˆç³»ç»Ÿçš„æ•´ç†è¿‡ TCP/IP åè®®ç›¸å…³çš„å†…å®¹ï¼Œæ‰€ä»¥å†™ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œä»¥æ­¤æ¥è®°å½•æˆ‘æœ€è¿‘å­¦ä¹ åˆ°çš„å†…å®¹ï¼Œå†…å®¹ä¼šåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ã€‚ TCP/IP åè®®ï¼Œä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹ï¼Œåè®®ç»†èŠ‚ åè®®ç›¸å…³çš„ç»†èŠ‚ï¼Œä¼˜åŒ–è°ƒæ•´å†…æ ¸å‚æ•° æ¨¡æ‹Ÿå¼‚å¸¸è¿æ¥ï¼Œä¼˜åŒ–è°ƒæ•´å†…æ ¸å‚æ•° åˆ©ç”¨ C è¯­è¨€ï¼ŒåŸºäº epoll å†™ä¸€ä¸ªæ”¯æŒé«˜å¹¶å‘çš„ TCP èŠå¤©æœåŠ¡å™¨ TCP/IP åè®®åœ¨è¿™é‡Œï¼Œå…ˆæ¨èä¸€æœ¬ä¹¦TCP/IP è¯¦è§£å· 1ï¼šåè®® TCP å¤´éƒ¨åè®®ï¼Œå¤§å®¶ä¸€å®šè¦ç‰¢è®°è¿™ä¸€å¹…å›¾ï¼Œæ‰èƒ½æ›´å¥½çš„ç†è§£åè®®ï¼Œè®°å¾—ï¼Œåè®®å›¾çš„çœ‹æ³•ï¼šä»ç¬¬ä¸€è¡Œå¼€å§‹åˆ°ç¬¬äºŒè¡Œï¼Œæ˜¯è¿åœ¨ä¸€èµ·è¯»åˆ°ï¼Œåˆ‡å‹¿å°†åè®®åˆ†æ®µè¯»å–ï¼Œå¦åˆ™ä¼šä¸€è„¸æ‡µé€¼ï¼Œè¿™æ ·å­å°±å¯ä»¥çœ‹æ‡‚æ•´ä¸ªåè®®å’Œå­—èŠ‚æ•°äº†ã€‚ tcp æ ‡å¿—ä½CWR &amp;&amp; ECNCWR(Congestion Window Reduced) &amp; ECNï¼ˆECN-Echo, Explicit Congestion Notificationï¼‰ CWR é˜»å¡çª—å£å·²å‡å°‘ï¼Œæ„æ€æ˜¯å‘Šè¯‰å¯¹ç«¯æˆ‘å·²ç»æŒ‰ç…§ä½ çš„è¦æ±‚ï¼Œè¿›è¡Œé˜»å¡çª—å£å‡å°‘äº†ï¼Œå¹¶å¯åŠ¨é˜»å¡ç®—æ³•æ¥æ§åˆ¶æˆ‘çš„å‘åŒ…é€Ÿåº¦ï¼› ECN æ˜¾å¼é˜»å¡çª—å£é€šçŸ¥ï¼Œæ„æ€é€šçŸ¥å‘é€æ–¹ï¼Œæˆ‘æ¥æ”¶çš„æŠ¥æ–‡å‡ºç°äº†é˜»å¡ï¼Œè¯·æ§åˆ¶å‘åŒ…é€Ÿåº¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCWR å’Œ ECN å¿…é¡»é…åˆä½¿ç”¨ï¼ŒCWR æ˜¯æ”¶åˆ° ECN çš„åº”ç­”ã€‚æ­¤å¤–ï¼Œåœ¨ tcp ä¸‰æ¬¡æ¡æ‰‹æ—¶ï¼Œè¿™ä¸¤ä¸ªæ ‡å¿—è¡¨æ˜ tcp ç«¯æ˜¯å¦æ”¯æŒ ECNã€‚å¦‚æœå»ºç«‹è¿æ¥ä¸€æ–¹æ”¯æŒï¼Œåˆ™åœ¨å‘é€çš„ SYN åŒ…ï¼Œå°† ECN æ ‡å¿—ç½®ä¸º 1ï¼Œå¦‚æœæœåŠ¡ç«¯ä¹Ÿæ”¯æŒï¼Œåˆ™åœ¨ ACK åŒ…åªè®¾ç½® ECNã€‚ ç¼˜ç”±ï¼štcp å»ºç«‹è¿æ¥åï¼ŒæŠ¥æ–‡ç»è¿‡ç»è¿‡è·¯ç”±æˆ–ç½‘å…³ç­‰ç½‘ç»œè®¾å¤‡åï¼Œåœ¨è·¯ç”±å™¨æˆ–ç½‘å…³ç­‰ç½‘ç»œè®¾å¤‡å‡ºç°é˜»å¡æ—¶ï¼Œè·¯ç”±å™¨æˆ–ç½‘å…³ç­‰è®¾å¤‡è®¾ç½® IP å±‚çš„æŸä¸ªæ ‡å¿—è¡¨æ˜å‡ºç°é˜»å¡ï¼Œè¿™æ ·æ¥æ”¶å¯ä»¥æ˜ç¡®çŸ¥é“æŠ¥æ–‡å‡ºç°äº†é˜»å¡ã€‚ç„¶è€Œï¼Œéœ€è¦çŸ¥é“é˜»å¡è¿›è¡Œé˜»å¡æ§åˆ¶çš„æ˜¯æŠ¥æ–‡å‘é€æ–¹è€Œéæ¥æ”¶æ–¹ã€‚æ‰€ä»¥æ¥æ”¶æ–¹ä¼šåœ¨ ACK æŠ¥æ–‡ä¸­è®¾ç½® ECN æ ‡å¿—ï¼ŒåŒæ—¶å‘é€æ–¹åœ¨ ACK ä¸­è®¾ç½® CWR æ ‡å¿—ï¼Œè¡¨æ˜å·²ç»æ”¶åˆ° ECNï¼Œå¹¶è¿›è¡Œäº†å‡å°‘é˜»å¡çª—å£æ“ä½œå’Œå¯ç”¨é˜»å¡ç®—æ³•ã€‚ URGURG(Urgent) è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„å¸¦å¤–æ•°æ®ã€‚å› ä¸º tcp æ˜¯æ²¡æœ‰æ¶ˆæ¯è¾¹ç•Œçš„ï¼Œå‡å¦‚æœ‰ä¸€ç§æƒ…å†µï¼Œä½ å·²ç»å‘é€äº†ä¸€äº›æ•°æ®ï¼Œä½†æ˜¯æ­¤æ—¶ï¼Œä½ è¦å‘é€ä¸€äº›æ•°æ®ä¼˜å…ˆå¤„ç†ï¼Œå°±å¯ä»¥è®¾ç½®è¿™äº›æ ‡å¿—ã€‚åŒæ—¶å¦‚æœè®¾ç½®äº†è¿™ä¸ªæ ‡å¿—ï¼Œç´§æ€¥æŒ‡é’ˆ(æŠ¥æ–‡å¤´ä¸­, Urgent Pointer(16Bit)éƒ¨åˆ†)ä¹Ÿä¼šè®¾ç½®ä¸ºç›¸åº”çš„åç§»ã€‚å½“æ¥å—æ–¹æ”¶åˆ° URG æ•°æ®æ—¶ï¼Œä¸ç¼“å­˜åœ¨æ¥æ”¶çª—å£ï¼Œç›´æ¥å¾€ä¸Šä¼ ç»™ä¸Šå±‚ã€‚å…·ä½“çš„ä½¿ç”¨å¸¦å¤–æ•°æ®å¤§ä½“çš„æ–¹æ³•ï¼Œå°±æ˜¯ï¼Œè°ƒç”¨ send å’Œ recv æ˜¯è¦åŠ ä¸Š MSG_OOB å‚æ•°ã€‚åŒæ—¶æ¥æ”¶æ–¹è¦å¤„ç† SIGURG ä¿¡å·ã€‚ä½¿ç”¨ MSG_OOB æ˜¯éœ€è¦æ³¨æ„ï¼š ç´§æ€¥æŒ‡é’ˆåªèƒ½æ ‡ç¤ºä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœå‘é€å¸¦å¤–æ•°æ®å¤šäºä¸€ä¸ªå­—èŠ‚ï¼Œå…¶ä»–æ•°æ®å°†å½“æˆæ˜¯æ­£å¸¸çš„æ•°æ®ã€‚ æ¥æ”¶ç«¯éœ€è¦è°ƒç”¨ fcntl(sockfd,F_SETOWN, getpid());ï¼Œå¯¹ socket æè¿°ç¬¦å·è¿›è¡Œå®¿ä¸»è®¾ç½®ï¼Œå¦åˆ™æ— æ³•æ•è· SIGURG ä¿¡å·ã€‚ å¦‚æœè®¾ç½®é€‰é¡¹ SO_OOBINLINEï¼Œé‚£ä¹ˆå°†ä¸èƒ½ä½¿ç”¨ MSG_OOB å‚æ•°æ¥æ”¶çš„æŠ¥æ–‡(è°ƒç”¨æŠ¥é”™)ï¼Œç´§æ€¥æŒ‡é’ˆçš„å­—ç¬¦å°†è¢«æ­£å¸¸è¯»å‡ºæ¥ï¼Œå¦‚æœéœ€è¦åˆ¤æ–­æ˜¯å¦ç´§æ€¥æ•°æ®ï¼Œåˆ™éœ€è¦æå‰åˆ¤æ–­ï¼šioctl (fd,SIOCATMARK,&amp;flag);if (flag) {read(sockfd,&amp;ch,1);ã€‚ ä¸è¿‡ï¼Œæ®è¯´è¿™ä¸ªå¸¦å¤–æ•°æ®åœ¨å®é™…ä¸Šï¼Œç”¨å¾—å¾ˆå°‘ã€‚ PSHPSHï¼ˆPushï¼‰ tcp æŠ¥æ–‡çš„æµåŠ¨ï¼Œå…ˆæ˜¯å‘é€æ–¹å¡è¿›å‘é€æ–¹çš„ç¼“å­˜å†å‘é€ï¼›åŒæ ·æ¥æ”¶æ–¹æ˜¯å…ˆå¡åˆ°æ¥æ”¶æ–¹çš„ç¼“å­˜å†æŠ•é€’åˆ°åº”ç”¨ã€‚PSH æ ‡å¿—çš„æ„æ€æ˜¯ï¼Œæ— è®ºæ¥æ”¶æˆ–å‘é€æ–¹ï¼Œéƒ½ä¸ç”¨ç¼“å­˜æŠ¥æ–‡ï¼Œç›´æ¥æ¥æ”¶æŠ•é€’ç»™ä¸Šå±‚åº”ç”¨æˆ–ç›´æ¥å‘é€ã€‚PSH æ ‡å¿—å¯ä»¥æä¾›æŠ¥æ–‡å‘é€çš„å®æ—¶æ€§ã€‚å¦‚æœè®¾ç½®äº† SO_NODELAY é€‰é¡¹(ä¹Ÿå°±æ˜¯å…³é—­ Nagle ç®—æ³•)ï¼Œå¯ä»¥å¼ºåˆ¶è®¾ç½®è¿™ä¸ªæ ‡å¿—ã€‚ SYN &amp;&amp; ACK &amp;&amp; FIN &amp;&amp; RST SYN(Synchronize), ACK(Acknowledgement), FINï¼ˆFinishï¼‰å’Œ RST(Reset) è¿™å‡ ä¸ªæ ‡è®°æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚ SYN, Synchronize sequence numbersã€‚ ACK, Acknowledgement Number æœ‰æ•ˆï¼Œåº”ç­”æ ‡è®°ã€‚ FIN,å‘é€ç«¯ç»“æŸå‘é€ã€‚ RST è¿æ¥ä¸å¯è¾¾ã€‚ tcp é€‰é¡¹(ä¸å®Œå…¨)tcp é™¤äº† 20 å­—èŠ‚åŸºæœ¬æ•°æ®å¤–ï¼Œåé¢è¿˜åŒ…æ‹¬äº†æœ€å¤š 40 ä¸ªå­—èŠ‚çš„ tcp çš„é€‰é¡¹ã€‚tcp é€‰é¡¹ä¸€èˆ¬å­˜å‚¨ä¸º kind/type(1byte) length(1byte) value çš„æ ¼å¼å¼ï¼Œä¸åŒçš„é€‰é¡¹å…·ä½“æ ¼å¼æœ‰æ‰€ä¸åŒã€‚è¿™é‡Œç®€å•ç½—åˆ—ä¸€äº›å¸¸è§çš„ tcp é€‰é¡¹å¹¶åšç®€å•ä»‹ç»ã€‚ MSS(Maximum Segment Size)tcp æŠ¥æ–‡æœ€å¤§ä¼ è¾“é•¿è¯»ï¼Œtcp åœ¨ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹é˜¶æ®µï¼Œåœ¨ SYN æŠ¥æ–‡äº¤äº’è¯¥å€¼ï¼Œæ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ•°å€¼å¹¶éåå•†å‡ºæ¥çš„ï¼Œè€Œæ˜¯ç”±ç½‘ç»œè®¾å¤‡å±æ€§å¾—å‡ºã€‚MSS ä¸€ä¸ªå¸¸è§çš„å€¼æ˜¯ 1460(MTU1500 - IP å¤´éƒ¨ - TCP å¤´éƒ¨)ã€‚ è¯¦ç»†è¯·æŸ¥çœ‹ã€ŠTCP - çª—å£ã€‹è¿™ä¸€ç¯‡æ–‡ç« ã€‚ SACK(Selective Acknowledgements)é€‰æ‹© ACKï¼Œç”¨äºå¤„ç† segment ä¸è¿ç»­çš„æƒ…å†µï¼Œè¿™æ ·å¯ä»¥å‡å°‘æŠ¥æ–‡é‡ä¼ ã€‚æ¯”å¦‚ï¼š A å‘ B å‘é€ 4 ä¸ª segmentï¼ŒB æ”¶åˆ°äº† 1,2,4 ä¸ª segmentï¼Œç½‘ç»œä¸¢å¤±äº† 3 è¿™ä¸ª segmentã€‚B æ”¶åˆ° 1,2segment åï¼Œå›åº” ACK 3ï¼Œè¡¨ç¤º 1,2 è¿™ä¸¤ä¸ª ACK å·²ç»æ”¶åˆ°ï¼ŒåŒæ—¶åœ¨é€‰é¡¹å­—æ®µé‡Œé¢ï¼ŒåŒ…æ‹¬ 4 è¿™ä¸ªæ®µï¼Œè¡¨ç¤º 4 è¿™ä¸ª segment ä¹Ÿæ”¶åˆ°äº†ã€‚äºæ˜¯ A å°±é‡ä¼  3 è¿™ä¸ª segmentï¼Œä¸å¿…é‡ä¼  4 è¿™ä¸ª segmentã€‚B æ”¶åˆ° 3 è¿™ä¸ª segment åï¼Œç›´æ¥ ACK 5ï¼Œè¡¨æ˜ 3,4 éƒ½æ”¶åˆ°äº†ã€‚ è¯¦ç»†è¯·æŸ¥çœ‹ã€ŠTCP - é‡ä¼ æœºåˆ¶ã€‹è¿™ä¸€ç¯‡æ–‡ç« ã€‚ WS(Window Scale)åœ¨ tcp å¤´éƒ¨ï¼ŒWindow Size(16Bit)è¡¨é¢æ¥æ”¶çª—å£å¤§å°ï¼Œä½†æ˜¯å¯¹äºç°ä»£ç½‘ç»œè€Œè¨€ï¼Œè¿™ä¸ªå€¼å¤ªå°äº†ã€‚æ‰€ä»¥ tcp é€šè¿‡é€‰é¡¹æ¥å¢åŠ è¿™ä¸ªçª—å£çš„å€¼ã€‚WS å€¼çš„èŒƒå›´ 0 ï½ 14ï¼Œè¡¨ç¤º Window Size(16Bit)æ•°å€¼å…ˆå‘å·¦ç§»åŠ¨çš„ä½æ•°ã€‚è¿™æ ·å®é™…ä¸Šçª—å£çš„å¤§å°å¯è¾¾ 31 ä½ã€‚åœ¨ç¨‹åºç½‘ç»œè®¾è®¡æ—¶ï¼Œæœ‰ä¸ª SO_RECVBUFï¼Œè¡¨ç¤ºè®¾ç½®æ¥æ”¶ç¼“å†²çš„å¤§å°ï¼Œç„¶è€Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå€¼å’Œæ¥æ”¶çª—å£çš„å¤§å°ä¸å®Œå…¨ç›¸ç­‰ï¼Œä½†æ˜¯è¿™ä¸ªæ•°å€¼å’Œæ¥æ”¶çª—å£å­˜åœ¨ä¸€å®šçš„å…³ç³»ï¼Œåœ¨å†…æ ¸é…ç½®çš„èŒƒå›´å†…ï¼Œå¤§å°æ¯”è¾ƒæ¥è¿‘ã€‚ TS(Timestamps)Timestamps åœ¨ tcp é€‰é¡¹ä¸­åŒ…æ‹¬ä¸¤ä¸ª 32 ä½çš„ timestamp: TSval(Timestamp value)å’Œ TSecr(Timestamp Echo Reply)ã€‚å¦‚æœè®¾ç½®äº† TS è¿™ä¸ªé€‰é¡¹ï¼Œå‘é€æ–¹å‘é€æ—¶ï¼Œå°†å½“å‰æ—¶é—´å¡«å…¥ TSvalï¼Œæ¥æ”¶æ–¹å›åº”æ—¶ï¼Œå°†å‘é€æ–¹çš„ TSval å¡«å…¥ TSecr å³å¯(æ³¨æ„å‘é€æˆ–æ¥æ”¶éƒ½æœ‰è®¾ç½® TSval å’Œ TSecr )ã€‚TS é€‰é¡¹çš„å­˜åœ¨æœ‰ä¸¤ä¸ªé‡è¦ä½œç”¨ï¼š ä¸€æ˜¯å¯ä»¥æ›´åŠ ç²¾ç¡®è®¡ç®— RTT(Round-Trip-Time)ï¼Œåªéœ€è¦åœ¨å›åº”æŠ¥æ–‡é‡Œé¢ç”¨å½“å‰æ—¶é—´å‡å» TSecr å³å¯ï¼› äºŒæ˜¯ PAWS(Protection Against Wrapped Sequence number, é˜²æ­¢ sequence å›ç»•) ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ¯”å¦‚è¯´ï¼Œå‘é€å¤§é‡çš„æ•°æ®ï¼š0-10Gï¼Œå‡è®¾ segment æ¯”è¾ƒå¤§ä¸º 1G è€Œä¸” sequence æ¯”è¾ƒå°ä¸º 5Gï¼Œæ¥æ”¶ç«¯æ¥æ”¶ 1,3,4,5 æ•°æ®æ®µæ­£å¸¸æ¥æ”¶ï¼Œæ”¶åˆ°çš„å‘é€æ—¶é—´åˆ†åˆ« 1,3,4,5ï¼Œç¬¬ 2 segment ä¸¢å¤±äº†ï¼Œç”±äº SACKï¼Œå¯¼è‡´ 2 è¢«é‡ä¼ ï¼Œåœ¨æ¥æ”¶ 6 æ—¶ï¼Œsequence ç”±äºå›ç»•å˜æˆäº† 1ï¼Œè¿™æ—¶æ”¶åˆ°çš„å‘é€æ—¶é—´ä¸º 6ï¼Œç„¶ååˆæ”¶åˆ°è¿·é€”çš„ 2ï¼Œseq ä¸º 2ï¼Œå‘é€æ—¶é—´ä¸º 2ï¼Œè¿™ä¸ªæ—¶é—´æ¯” 6 å°ï¼Œæ˜¯ä¸åˆæ³•çš„ï¼Œtcp ç›´æ¥ä¸¢å¼ƒè¿™ä¸ªè¿·é€”çš„æŠ¥æ–‡ã€‚ UTO(User Timeout)UTO æŒ‡çš„æ˜¯å‘é€ SYNï¼Œæ”¶åˆ° ACK çš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœåœ¨ UTO å†…æ²¡æœ‰æ”¶åˆ°ï¼Œåˆ™è®¤ä¸ºå¯¹ç«¯å·²æŒ‚ã€‚ åœ¨ç½‘ç»œç¨‹åºè®¾è®¡çš„æ—¶å€™ï¼Œä¸ºäº†æ¢æµ‹å¯¹ç«¯æ˜¯å¦å­˜æ´»ï¼Œç»å¸¸æ¶‰åŠå¿ƒè·³æŠ¥æ–‡ï¼Œé€šè¿‡ tcp çš„ keepalive å’Œ UTO æœºåˆ¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯ï¼Œå‰è€…å¯ä»¥é€šè¿‡å¿ƒè·³æŠ¥æ–‡å®æ—¶çŸ¥é“å¯¹ç«¯æ˜¯å¦å­˜æ´»ï¼ŒäºŒåè€…åªæœ‰ç­‰å¾…ä¸‹æ¬¡è°ƒç”¨å‘é€æˆ–æ¥æ”¶å‡½æ•°æ‰å¯ä»¥æ–­å®šï¼š 1) SO_KEEPALIVE ç›¸å…³é€‰é¡¹ è®¾ç½® SO_KEEPALIVE é€‰é¡¹ï¼Œæ‰“å¼€ keepalive æœºåˆ¶ã€‚ è®¾ç½® TCP_KEEPIDLE é€‰é¡¹ï¼Œç©ºé—²æ—¶é—´é—´éš”å¯åŠ¨ keepalive æœºåˆ¶ï¼Œé»˜è®¤ä¸º 2 å°æ—¶ã€‚ è®¾ç½® TCP_KEEPINTVL é€‰é¡¹ï¼Œkeepalive æœºåˆ¶å¯åŠ¨åï¼Œæ¯éš”å¤šé•¿æ—¶é—´å‘é€ä¸€ä¸ª keepalive æŠ¥æ–‡ã€‚é»˜è®¤ä¸º 75 ç§’ã€‚ è®¾ç½® TCP_KEEPCNT é€‰é¡¹ï¼Œè®¾ç½®å‘é€å¤šå°‘ä¸ª keepalive æ•°æ®åŒ…éƒ½æ²¡æœ‰æ­£å¸¸å“åº”ï¼Œåˆ™æ–­å®šå¯¹ç«¯å·²ç»å´©æºƒã€‚é»˜è®¤ä¸º 9ã€‚ ç”±äº tcp æœ‰è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œå¦‚æœå¯¹äº ACK ä¸¢å¤±çš„æƒ…å†µï¼Œkeepalive æœºåˆ¶å°†æœ‰å¯èƒ½å¤±æ•ˆã€‚ ä¸‰æ¬¡æ¡æ‰‹åœ¨è¿™é‡Œæˆ‘ä»¬è€ç”Ÿå¸¸è°ˆçš„ä¸€ä¸ªä¸œè¥¿ï¼Œå°±æ˜¯ TCP/IP åè®®ï¼ŒåŸºæœ¬ä¸Šæˆ‘ä»¬å¸¸ç”¨çš„é“¾æ¥ï¼Œå¤§å¤šæ•°éƒ½æ˜¯åŸºäº TCP åè®®æ¥çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªåè®®ä¸­åŒ…å«äº† 2 ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µï¼Œåˆ†åˆ«ä¸Š ä¸‰æ¬¡æ¡æ‰‹ å’Œ å››æ¬¡æŒ¥æ‰‹ï¼Œç›¸ä¿¡å¤§å®¶å½“äº†ä¸€å®šç¨‹åº¦ï¼Œéƒ½å¯¹è¿™ 2 ä¸ªæ¦‚å¿µæœ‰æ‰€è€³é—»ï¼Œé‚£ä¹ˆè¿™ 2 ä¸ªæ¦‚å¿µçš„æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ã€‚æˆ‘ä»¬ç”¨å›¾è¡¨ç¤ºå‡ºæ¥ã€‚ tcpdump æŠ“åŒ…æŸ¥çœ‹ TCP åè®®è¿™é‡Œï¼Œæˆ‘ä»¬ç”¨ redis æ¥æµ‹è¯•ã€‚ 123456root@8152f1016ea8:&#x2F;data# tcpdump -iany tcp port 6379 -Stcpdump: verbose output suppressed, use -v or -vv for full protocol decodelistening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes06:18:05.136476 IP localhost.34698 &gt; localhost.6379: Flags [S], seq 493310144, win 43690, options [mss 65495,sackOK,TS val 10045219 ecr 0,nop,wscale 7], length 006:18:05.136570 IP localhost.6379 &gt; localhost.34698: Flags [S.], seq 3870646421, ack 493310145, win 43690, options [mss 65495,sackOK,TS val 10045219 ecr 10045219,nop,wscale 7], length 006:18:05.136602 IP localhost.34698 &gt; localhost.6379: Flags [.], ack 3870646422, win 342, options [nop,nop,TS val 10045219 ecr 10045219], length 0 çœ‹ä¸Šè¿°æƒ…å†µï¼Œæˆ‘ä»¬ç”¨tcpdump ç›‘å¬äº†æ‰€æœ‰ç½‘å¡ï¼Œå¹¶ä¸”æ˜¯TCPåè®®ï¼Œå¹¶ä¸” src æˆ–è€… dst çš„ç«¯å£ä¸º 6379 çš„åè®®ï¼ŒåŠ ä¸Š-Sæ˜¯ä¸ºäº†ç°å®ç»å¯¹å€¼ï¼Œå¦åˆ™tcpdumpå°†æ˜¾ç¤ºç›¸å¯¹å€¼ï¼Œå¯¹äºå°ç™½æ¥è¯´ï¼Œç»å¯¹å€¼æ¯”ç›¸å¯¹å€¼æ›´å¥½çœ‹ã€‚å¯¹äºè€æ‰‹æ¥è¯´ï¼Œç›¸å¯¹å€¼å¯ä»¥æ’é™¤æ— æ•ˆçš„å†…å®¹ï¼Œç®€åŒ–å†…å®¹ï¼Œæ›´åˆ©äºæŸ¥çœ‹åˆ†æã€‚ ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼š 106:18:05.136476 IP localhost.34698 &gt; localhost.6379: Flags [S], seq 493310144, win 43690, options [mss 65495,sackOK,TS val 10045219 ecr 0,nop,wscale 7], length 0 è¿™æ¡åè®®ï¼Œæˆ‘ä»¬çœ‹åˆ°æ˜¯æˆ‘ä»¬æœ¬åœ°ç”Ÿæˆæ‰“å¼€äº†ä¸€ä¸ª fdï¼Œå¹¶ä¸”ç›‘å¬äº† 34698 ç«¯å£ï¼Œå¹¶ä¸”è¿™ä¸ªåè®®æ˜¯å‘é€SYNåè®®çš„ä¸€æ¡åè®®ï¼Œä»£è¡¨è¿™ä¸ªåè®®ä¸­ï¼ŒSYN æ ‡è¯†ä½è¢«è®¾ç½®ä¸ºäº† 1ï¼Œåºåˆ—åŒ…è¢«è®¾ç½®ä¸ºäº†ï¼š493310144ï¼Œå¹¶ä¸”æ»‘åŠ¨çª—å£å¤§å°ä¸ºï¼š43690ï¼Œä»£è¡¨å®¢æˆ·ç«¯ç›®å‰æœ€å¤§å¯ä»¥æ¥æ”¶ 43690 å­—èŠ‚çš„æ•°æ®ï¼Œoptions ä»£è¡¨ tcp å¯é€‰é…ç½®ï¼Œåœ¨è¿™é‡Œï¼Œè®¾ç½®äº† MSS æœ€å¤§å‘é€çš„æ•°æ®åŒ…ï¼š65495 sackOKï¼šå¯ç”¨äº† SACK ç®—æ³•ï¼Œ TS æ—¶é—´æˆ³ val ï¼šå‘é€ç«¯æ—¶é—´ 10045219 ecr ï¼šæ¥æ”¶ç«¯æ—¶é—´ 0 nop: å ä½ç¬¦ï¼Œæ²¡ä»»ä½•é€‰é¡¹ wscale ï¼šçª—å£å› å­ 7 length: æ•°æ®åŒ…é•¿åº¦ä¸º 0 è¿™æ—¶å€™å®¢æˆ·ç«¯è¿æ¥ä¼šå˜æˆï¼šSYN-SENT çŠ¶æ€ ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼š 106:18:05.136570 IP localhost.6379 &gt; localhost.34698: Flags [S.], seq 3870646421, ack 493310145, win 43690, options [mss 65495,sackOK,TS val 10045219 ecr 10045219,nop,wscale 7], length 0 è¿™æ¡åè®®ï¼Œæˆ‘ä»¬çœ‹åˆ° redis æœåŠ¡å™¨è¿”å›ç»™äº†å®¢æˆ·ç«¯ä¸€ä¸ªåè®®ï¼Œè¿™ä¸ªåè®®åŒ…å«äº†SYNå’ŒACKï¼Œä»£è¡¨è¿™ä¸ªåè®®çš„SYNå’ŒACKæ ‡å¿—ä½éƒ½è¢«è®¾ç½®æˆäº† 1ï¼Œæ‰€ä»¥è¿™ä¸ªåè®®åŒ…çš„seqå’Œackæ˜¯æœ‰æ•ˆçš„ï¼Œæ»‘åŠ¨çª—å£å¤§å°ä¸º 43690,ä»£è¡¨æœåŠ¡ç«¯å¯ä»¥è¯»å– 43690 å­—èŠ‚çš„æ•°æ®ï¼Œoptions ä»£è¡¨ tcp çš„å¯é€‰é…ç½®ã€‚ MSS æœ€å¤§å‘é€çš„æ•°æ®åŒ…ï¼š65495 sackOKï¼šå¯ç”¨äº† SACK ç®—æ³•ï¼Œ TS æ—¶é—´æˆ³ val ï¼šå‘é€ç«¯æ—¶é—´ 10045219 ecr ï¼šæ¥æ”¶ç«¯æ—¶é—´ 10045219 nop: å ä½ç¬¦ï¼Œæ²¡ä»»ä½•é€‰é¡¹ wscale ï¼šçª—å£å› å­ 7 length: æ•°æ®åŒ…é•¿åº¦ä¸º 0 è¿™æ—¶å€™æœåŠ¡ç«¯è¿æ¥ä¼šå˜æˆï¼šSYN-RECEIVED çŠ¶æ€ ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼š 106:18:05.136602 IP localhost.34698 &gt; localhost.6379: Flags [.], ack 3870646422, win 342, options [nop,nop,TS val 10045219 ecr 10045219], length 0 è¿™æ¡åè®®ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼ŒåŒ…å«äº†ACKåŒ…ï¼Œæ‰€ä»¥åªæœ‰ACKçš„æ ‡å¿—ä½è¢«è®¾ç½®ä½äº† 1ï¼Œä»£è¡¨åªæœ‰ackè¿™ä¸ªå€¼æ˜¯æœ‰æ•ˆçš„ï¼Œå®¢æˆ·ç«¯å‘Šè¯‰æœåŠ¡ç«¯ï¼Œå½“å‰çª—å£å¤§å°ä¸º 342ï¼Œæ‰€ä»¥æœ€å¤§åªèƒ½å‘é€ 342 å­—èŠ‚çš„æ•°æ®ï¼Œ op: å ä½ç¬¦ï¼Œæ²¡ä»»ä½•é€‰é¡¹ op: å ä½ç¬¦ï¼Œæ²¡ä»»ä½•é€‰é¡¹ TS æ—¶é—´æˆ³ val ï¼šå‘é€ç«¯æ—¶é—´ 10045219 ecr ï¼šæ¥æ”¶ç«¯æ—¶é—´ 10045219 length: æ•°æ®åŒ…é•¿åº¦ä¸º 0 åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ä¸‰æ¬¡æ¡æ‰‹å°±å®Œæˆäº†ï¼Œ2 è€…çš„å˜çš„çŠ¶æ€éƒ½ä¼šå˜æˆESTABLISHEDï¼Œå®Œæˆäº†æˆ‘ä»¬çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å‘é€æ•°æ®åŒ…ã€‚ å››æ¬¡æŒ¥æ‰‹ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿™é‡Œæ˜¯å››æ¬¡æŒ¥æ‰‹å‘¢ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„ TCP åè®® æ˜¯å…¨åŒå·¥çš„ï¼Œä¸èƒ½å•è¾¹çš„å…³é—­å…¶ä¸­ä¸€è¾¹ã€‚ tcpdump æŠ“åŒ…æŸ¥çœ‹ TCP åè®®åŒæ ·çš„ï¼Œæˆ‘ä»¬ç”¨ redis çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸ºä¾‹å­ã€‚ 1234567891007:04:52.517203 IP localhost.6379 &gt; localhost.34698: Flags [.], ack 493310162, win 342, options [nop,nop,TS val 10326272 ecr 10317312], length 007:05:07.843078 IP localhost.34698 &gt; localhost.6379: Flags [.], ack 3870657890, win 1427, options [nop,nop,TS val 10327808 ecr 10326272], length 007:05:07.843136 IP localhost.6379 &gt; localhost.34698: Flags [.], ack 493310162, win 342, options [nop,nop,TS val 10327808 ecr 10317312], length 007:05:23.202386 IP localhost.34698 &gt; localhost.6379: Flags [.], ack 3870657890, win 1427, options [nop,nop,TS val 10329344 ecr 10327808], length 007:05:23.202425 IP localhost.6379 &gt; localhost.34698: Flags [.], ack 493310162, win 342, options [nop,nop,TS val 10329344 ecr 10317312], length 007:05:38.529675 IP localhost.34698 &gt; localhost.6379: Flags [.], ack 3870657890, win 1427, options [nop,nop,TS val 10330880 ecr 10329344], length 007:05:38.529706 IP localhost.6379 &gt; localhost.34698: Flags [.], ack 493310162, win 342, options [nop,nop,TS val 10330880 ecr 10317312], length 007:10:26.796243 IP localhost.34698 &gt; localhost.6379: Flags [F.], seq 493310162, ack 3870657890, win 1427, options [nop,nop,TS val 10359737 ecr 10358528], length 007:10:26.796488 IP localhost.6379 &gt; localhost.34698: Flags [F.], seq 3870657890, ack 493310163, win 342, options [nop,nop,TS val 10359737 ecr 10359737], length 007:10:26.796519 IP localhost.34698 &gt; localhost.6379: Flags [.], ack 3870657891, win 1427, options [nop,nop,TS val 10359737 ecr 10359737], length 0 åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å¾ˆå¤šæ¡æ¶ˆæ¯ï¼Œå…¨éƒ¨éƒ½æ˜¯å¸¦æœ‰ ACK åŒ…çš„ï¼Œå€’æ•°ç¬¬ä¸‰æ¡ä¹‹å‰çš„ï¼Œéƒ½æ˜¯å¸¸è§„çš„ ACK åŒ…ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå¿ƒè·³åŒ…ã€‚ è¿™é‡Œï¼Œæˆ‘ä»¬è®©å®¢æˆ·ç«¯æ¥æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œç”¨ï¼šquit å‘½ä»¤é€€å‡ºå®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯ï¼šç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼š 107:10:26.796243 IP localhost.34698 &gt; localhost.6379: Flags [F.], seq 493310162, ack 3870657890, win 1427, options [nop,nop,TS val 10359737 ecr 10358528], length 0 å®¢æˆ·ç«¯çŠ¶æ€å˜æˆï¼šFIN_WAIT1 è¿™ä¸€æ¡æ¶ˆæ¯ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°é‡Œé¢æœ‰FINå’ŒACKçš„æ ‡å¿—ä½è¢«è®¾ç½®ä¸ºäº† 1ï¼Œæ‰€ä»¥ä»£è¡¨æ•°æ®åŒ…ä¸­çš„ï¼šseqå’Œ ackæ˜¯æœ‰æ•ˆçš„ï¼Œseq=493310162ï¼Œack=3870657890ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ¡æ¶ˆæ¯ä¸­çš„ ACK åŒ…å¹¶ä¸æ˜¯ä¸ºäº† 4 æ¬¡æŒ¥æ‰‹è€Œå­˜åœ¨çš„ï¼Œä»–åªæ˜¯å•çº¯çš„å‘Šè¯‰æœåŠ¡ç«¯ï¼Œæˆ‘ä¸‹ä¸€æ¡æ¶ˆæ¯çš„å­—èŠ‚éœ€è¦ä»åºå·ä¸º 3870657890 å¼€å§‹è¯»èµ·ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†å››æ¬¡æŒ¥æ‰‹è€Œå­˜åœ¨çš„åè®®åªæœ‰ seqã€‚ æœåŠ¡ç«¯ï¼šç¬¬äºŒå’Œç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼š 107:10:26.796488 IP localhost.6379 &gt; localhost.34698: Flags [F.], seq 3870657890, ack 493310163, win 342, options [nop,nop,TS val 10359737 ecr 10359737], length 0 è¿™ä¸€æ¡æ¶ˆæ¯ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°é‡Œé¢åŒæ ·æœ‰FINå’ŒACKçš„æ ‡å¿—ä½è¢«è®¾ç½®ä¸ºäº† 1ï¼Œæ‰€ä»¥ä»£è¡¨æ•°æ®åŒ…ä¸­çš„seqå’Œackæ˜¯æœ‰æ•ˆçš„ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çš„ seq=3870657890(ack)ï¼Œack=(ä¸Šä¸€æ¡æ¶ˆæ¯çš„ seq+1)ï¼Œè¿™ä¸ªæ—¶å€™è¿™ä¸ª ack åŒ…æ˜¯ä¸ºäº†å››æ¬¡æŒ¥æ‰‹è€Œå­˜åœ¨çš„ã€‚æ‰€ä»¥è¿™ 2 ä¸ªä¸åŒæ ‡å¿—ä½ï¼šåˆ†åˆ«ä»£è¡¨äº†ç¬¬äºŒæ¬¡å’Œç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼Œå…¶ä¸­ ACK ä»£è¡¨ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼ŒFIN ä»£è¡¨ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ è¿™ä¸ªæ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ® ACK åŒ…å˜æˆï¼šFIN-WAIT-2ï¼Œæ¥ç€åˆå› ä¸ºæ¥æ”¶åˆ°æœåŠ¡ç«¯çš„ FIN åŒ…ï¼Œæ‰€ä»¥ä¼šå˜æˆ TIME_WAIT çŠ¶æ€ï¼ŒæœåŠ¡ç«¯å‘é€äº† ACK åŒ…å˜æˆï¼šCLOSE-WAIT çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·ç«¯ ACK æœ€åä¸€æ¬¡æ¡æ‰‹æ¶ˆæ¯ã€‚ å®¢æˆ·ç«¯ï¼šç¬¬å››æ¬¡æŒ¥æ‰‹ï¼š 107:10:26.796519 IP localhost.34698 &gt; localhost.6379: Flags [.], ack 3870657891, win 1427, options [nop,nop,TS val 10359737 ecr 10359737], length 0 è¿™é‡Œå®¢æˆ·ç«¯å‘é€äº†ä¸€æ¡ ack åŒ…ï¼Œack=(ä¸Šä¸€æ¡æ¶ˆæ¯çš„ seq+1)ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ä¼šåœ¨è¿™é‡Œæ–­å¼€é“¾æ¥ï¼Œå˜æˆå®Œå…¨å…³é—­çŠ¶æ€ï¼ˆCLOSEDï¼‰ã€‚ ç–‘é—®ä¸ºä»€ä¹ˆå»ºç«‹è¿æ¥åè®®æ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œå…³é—­è¿æ¥å´æ˜¯å››æ¬¡æ¡æ‰‹å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºæœåŠ¡ç«¯çš„ LISTEN çŠ¶æ€ä¸‹çš„ SOCKET å½“æ”¶åˆ° SYN æŠ¥æ–‡çš„å»ºè¿è¯·æ±‚åï¼Œå®ƒå¯ä»¥æŠŠ ACK å’Œ SYNï¼ˆACK èµ·åº”ç­”ä½œç”¨ï¼Œè€Œ SYN èµ·åŒæ­¥ä½œç”¨ï¼‰æ”¾åœ¨ä¸€ä¸ªæŠ¥æ–‡é‡Œæ¥å‘é€ã€‚ä½†å…³é—­è¿æ¥æ—¶ï¼Œå½“æ”¶åˆ°å¯¹æ–¹çš„ FIN æŠ¥æ–‡é€šçŸ¥æ—¶ï¼Œå®ƒä»…ä»…è¡¨ç¤ºå¯¹æ–¹æ²¡æœ‰æ•°æ®å‘é€ç»™ä½ äº†ï¼›ä½†æœªå¿…ä½ æ‰€æœ‰çš„æ•°æ®éƒ½å…¨éƒ¨å‘é€ç»™å¯¹æ–¹äº†ï¼Œæ‰€ä»¥ä½ å¯èƒ½æœªå¿…ä¼šé©¬ä¸Šä¼šå…³é—­ SOCKET,ä¹Ÿå³ä½ å¯èƒ½è¿˜éœ€è¦å‘é€ä¸€äº›æ•°æ®ç»™å¯¹æ–¹ä¹‹åï¼Œå†å‘é€ FIN æŠ¥æ–‡ç»™å¯¹æ–¹æ¥è¡¨ç¤ºä½ åŒæ„ç°åœ¨å¯ä»¥å…³é—­è¿æ¥äº†ï¼Œæ‰€ä»¥å®ƒè¿™é‡Œçš„ ACK æŠ¥æ–‡å’Œ FIN æŠ¥æ–‡å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯åˆ†å¼€å‘é€çš„ã€‚ ä¸ºä»€ä¹ˆ TIME_WAIT çŠ¶æ€è¿˜éœ€è¦ç­‰ 2MSL åæ‰èƒ½è¿”å›åˆ° CLOSED çŠ¶æ€è¿™æ˜¯å› ä¸ºè™½ç„¶åŒæ–¹éƒ½åŒæ„å…³é—­è¿æ¥äº†ï¼Œè€Œä¸”æ¡æ‰‹çš„ 4 ä¸ªæŠ¥æ–‡ä¹Ÿéƒ½åè°ƒå’Œå‘é€å®Œæ¯•ï¼ŒæŒ‰ç†å¯ä»¥ç›´æ¥å›åˆ° CLOSED çŠ¶æ€ï¼ˆå°±å¥½æ¯”ä» SYN_SEND çŠ¶æ€åˆ° ESTABLISH çŠ¶æ€é‚£æ ·ï¼‰ï¼š ä¸€æ–¹é¢æ˜¯å¯é çš„å®ç° TCP å…¨åŒå·¥è¿æ¥çš„ç»ˆæ­¢ï¼Œä¹Ÿå°±æ˜¯å½“æœ€åçš„ ACK ä¸¢å¤±åï¼Œè¢«åŠ¨å…³é—­ç«¯ä¼šé‡å‘ FINï¼Œå› æ­¤ä¸»åŠ¨å…³é—­ç«¯éœ€è¦ç»´æŒçŠ¶æ€ä¿¡æ¯ï¼Œä»¥å…è®¸å®ƒé‡æ–°å‘é€æœ€ç»ˆçš„ ACKã€‚ å¦ä¸€æ–¹é¢ï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬å¿…é¡»è¦å‡æƒ³ç½‘ç»œæ˜¯ä¸å¯é çš„ï¼Œä½ æ— æ³•ä¿è¯ä½ æœ€åå‘é€çš„ ACK æŠ¥æ–‡ä¼šä¸€å®šè¢«å¯¹æ–¹æ”¶åˆ°ï¼Œå› æ­¤å¯¹æ–¹å¤„äº LAST_ACK çŠ¶æ€ä¸‹çš„ SOCKET å¯èƒ½ä¼šå› ä¸ºè¶…æ—¶æœªæ”¶åˆ° ACK æŠ¥æ–‡ï¼Œè€Œé‡å‘ FIN æŠ¥æ–‡ï¼Œæ‰€ä»¥è¿™ä¸ª TIME_WAIT çŠ¶æ€çš„ä½œç”¨å°±æ˜¯ç”¨æ¥é‡å‘å¯èƒ½ä¸¢å¤±çš„ ACK æŠ¥æ–‡ã€‚ TCP åœ¨ 2MSL ç­‰å¾…æœŸé—´ï¼Œå®šä¹‰è¿™ä¸ªè¿æ¥(4 å…ƒç»„)ä¸èƒ½å†ä½¿ç”¨ï¼Œä»»ä½•è¿Ÿåˆ°çš„æŠ¥æ–‡éƒ½ä¼šä¸¢å¼ƒã€‚è®¾æƒ³å¦‚æœæ²¡æœ‰ 2MSL çš„é™åˆ¶ï¼Œæ°å¥½æ–°åˆ°çš„è¿æ¥æ­£å¥½æ»¡è¶³åŸå…ˆçš„ 4 å…ƒç»„ï¼Œè¿™æ—¶å€™è¿æ¥å°±å¯èƒ½æ¥æ”¶åˆ°ç½‘ç»œä¸Šçš„å»¶è¿ŸæŠ¥æ–‡å°±å¯èƒ½å¹²æ‰°æœ€æ–°å»ºç«‹çš„è¿æ¥ã€‚ TCP æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„æµç¨‹å›¾ï¼š TCP æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€å›¾ï¼š å¯¹äºçŠ¶æ€å›¾ï¼Œå¯èƒ½å¤§å®¶å¯¹è¿™ä¸ªå›¾ç¬¬ä¸€çœ¼æ˜¯è’™è”½çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å™è¿°ä¸€ä¸‹æµç¨‹ã€‚ æˆ‘ä»¬çš„Clientæˆ–è€… Serveréƒ½æ˜¯ä» CLOSEçŠ¶æ€å¯åŠ¨çš„ï¼ŒServer å¯åŠ¨ä¹‹åï¼Œå°±æ˜¯åˆ°äº†LISTENçŠ¶æ€ï¼ŒClient å¯åŠ¨ä¹‹åï¼Œå°±æ˜¯è¿æ¥ï¼Œä¹Ÿå°±æ˜¯ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯å‘é€ SYN æ•°æ®åŒ…ï¼ŒClinet å˜æˆäº† SYN SENTçŠ¶æ€ï¼ˆè¿™æ˜¯ä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸€æ­¥ï¼‰ï¼Œ å½±å“ TCP è¿æ¥çš„å†…æ ¸å‚æ•°å½±å“ TCP è¿æ¥çš„å†…æ ¸å‚æ•°å¯ä»¥é€šè¿‡ä¸€ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ 123456789101112131415161718192021222324252627282930313233343536sysctl -a | grep tcpnet.ipv4.tcp_base_mss &#x3D; 1024net.ipv4.tcp_ecn &#x3D; 2net.ipv4.tcp_ecn_fallback &#x3D; 1net.ipv4.tcp_fin_timeout &#x3D; 60net.ipv4.tcp_fwmark_accept &#x3D; 0net.ipv4.tcp_keepalive_intvl &#x3D; 75net.ipv4.tcp_keepalive_probes &#x3D; 9net.ipv4.tcp_keepalive_time &#x3D; 7200net.ipv4.tcp_l3mdev_accept &#x3D; 0net.ipv4.tcp_mtu_probing &#x3D; 0net.ipv4.tcp_notsent_lowat &#x3D; 4294967295net.ipv4.tcp_orphan_retries &#x3D; 0net.ipv4.tcp_probe_interval &#x3D; 600net.ipv4.tcp_probe_threshold &#x3D; 8net.ipv4.tcp_reordering &#x3D; 3net.ipv4.tcp_retries1 &#x3D; 3net.ipv4.tcp_retries2 &#x3D; 15net.ipv4.tcp_syn_retries &#x3D; 6net.ipv4.tcp_synack_retries &#x3D; 5net.ipv4.tcp_syncookies &#x3D; 1net.ipv4.vs.secure_tcp &#x3D; 0net.ipv4.vs.sloppy_tcp &#x3D; 0net.netfilter.nf_conntrack_tcp_be_liberal &#x3D; 0net.netfilter.nf_conntrack_tcp_loose &#x3D; 1net.netfilter.nf_conntrack_tcp_max_retrans &#x3D; 3net.netfilter.nf_conntrack_tcp_timeout_close &#x3D; 10net.netfilter.nf_conntrack_tcp_timeout_close_wait &#x3D; 60net.netfilter.nf_conntrack_tcp_timeout_established &#x3D; 432000net.netfilter.nf_conntrack_tcp_timeout_fin_wait &#x3D; 120net.netfilter.nf_conntrack_tcp_timeout_last_ack &#x3D; 30net.netfilter.nf_conntrack_tcp_timeout_max_retrans &#x3D; 300net.netfilter.nf_conntrack_tcp_timeout_syn_recv &#x3D; 60net.netfilter.nf_conntrack_tcp_timeout_syn_sent &#x3D; 120net.netfilter.nf_conntrack_tcp_timeout_time_wait &#x3D; 120net.netfilter.nf_conntrack_tcp_timeout_unacknowledged &#x3D; 300 å¦‚æœåˆä¸€äº›å‚æ•°ä¸åœ¨ä¸Šé¢çš„è¯ï¼Œå°±ä»£è¡¨è¿™ä¸ªå‚æ•°å¹¶æœªè¢«å¼€å¯ï¼Œå¯ä»¥æ‰‹åŠ¨å¼€å¯ã€‚å¯ä»¥é€šè¿‡å‘½ä»¤ç›´æ¥è®¾ç½®ï¼Œsysctl *ï¼Œä¹Ÿå¯ä»¥æ“ä½œ vi /etc/sysctl.confã€‚ å†™å…¥sysctl.confçš„å‚æ•°å¹¶ä¸ä¼šç«‹åˆ»ç”Ÿæ•ˆï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œsysctl -p å‘ç°ç³»ç»Ÿå­˜åœ¨å¤§é‡ TIME_WAIT çŠ¶æ€çš„è¿æ¥1234net.ipv4.tcp_syncookies &#x3D; 1net.ipv4.tcp_tw_reuse &#x3D; 1net.ipv4.tcp_tw_recycle &#x3D; 1net.ipv4.tcp_fin_timeout &#x3D; 30 net.ipv4.tcp_syncookies = 1 è¡¨ç¤ºå¼€å¯ SYN Cookiesã€‚å½“å‡ºç° SYN ç­‰å¾…é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œå¯ç”¨ cookies æ¥å¤„ç†ï¼Œå¯é˜²èŒƒå°‘é‡ SYN æ”»å‡»ï¼Œé»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºå…³é—­ï¼› net.ipv4.tcp_tw_reuse = 1 è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°† TIME-WAIT sockets é‡æ–°ç”¨äºæ–°çš„ TCP è¿æ¥ï¼Œé»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºå…³é—­ï¼› net.ipv4.tcp_tw_recycle = 1 è¡¨ç¤ºå¼€å¯ TCP è¿æ¥ä¸­ TIME-WAIT sockets çš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºå…³é—­ã€‚ net.ipv4.tcp_fin_timeout ä¿®æ”¹ç³»çµ±é»˜è®¤çš„ TIMEOUT æ—¶é—´ backlog TCP å»ºç«‹è¿æ¥æ˜¯è¦è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ï¼Œä½†æ˜¯å¦å®Œæˆä¸‰æ¬¡æ¡æ‰‹åï¼ŒæœåŠ¡å™¨å°±å¤„ç†ï¼ˆacceptï¼‰å‘¢ï¼Ÿ backlog å…¶å®æ˜¯è¿æ¥é˜Ÿåˆ—ï¼Œåœ¨ Linux å†…æ ¸ 2.2 ä¹‹å‰ï¼Œbacklog å¤§å°åŒ…æ‹¬åŠè¿æ¥çŠ¶æ€å’Œå…¨è¿æ¥çŠ¶æ€ä¸¤ç§é˜Ÿåˆ—å¤§å°ã€‚ åŠè¿æ¥çŠ¶æ€ä¸ºï¼šæœåŠ¡å™¨å¤„äº Listen çŠ¶æ€æ—¶æ”¶åˆ°å®¢æˆ·ç«¯ SYN æŠ¥æ–‡æ—¶æ”¾å…¥åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼Œå³ SYN queueï¼ˆæœåŠ¡å™¨ç«¯å£çŠ¶æ€ä¸ºï¼šSYN_RCVDï¼‰ã€‚ å…¨è¿æ¥çŠ¶æ€ä¸ºï¼šTCP çš„è¿æ¥çŠ¶æ€ä»æœåŠ¡å™¨ï¼ˆSYN+ACKï¼‰å“åº”å®¢æˆ·ç«¯åï¼Œåˆ°å®¢æˆ·ç«¯çš„ ACK æŠ¥æ–‡åˆ°è¾¾æœåŠ¡å™¨ä¹‹å‰ï¼Œåˆ™ä¸€ç›´ä¿ç•™åœ¨åŠè¿æ¥çŠ¶æ€ä¸­ï¼›å½“æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ ACK æŠ¥æ–‡åï¼Œè¯¥æ¡ç›®å°†ä»åŠè¿æ¥é˜Ÿåˆ—æ¬åˆ°å…¨è¿æ¥é˜Ÿåˆ—å°¾éƒ¨ï¼Œå³ accept queue ï¼ˆæœåŠ¡å™¨ç«¯å£çŠ¶æ€ä¸ºï¼šESTABLISHEDï¼‰ã€‚ åœ¨ Linux å†…æ ¸ 2.2 ä¹‹åï¼Œåˆ†ç¦»ä¸ºä¸¤ä¸ª backlog æ¥åˆ†åˆ«é™åˆ¶åŠè¿æ¥ï¼ˆSYN_RCVD çŠ¶æ€ï¼‰é˜Ÿåˆ—å¤§å°å’Œå…¨è¿æ¥ï¼ˆESTABLISHED çŠ¶æ€ï¼‰é˜Ÿåˆ—å¤§å°ã€‚ å½“åº”ç”¨ç¨‹åºè°ƒç”¨ listen ç³»ç»Ÿè°ƒç”¨è®©ä¸€ä¸ª socket è¿›å…¥ LISTEN çŠ¶æ€æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå‚æ•°ï¼šbacklogã€‚è¿™ä¸ªå‚æ•°ç»å¸¸è¢«æè¿°ä¸ºï¼Œæ–°è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦é™åˆ¶ã€‚ ç”±äº TCP å»ºç«‹è¿æ¥éœ€è¦è¿›è¡Œ 3 æ¬¡æ¡æ‰‹ï¼Œä¸€ä¸ªæ–°è¿æ¥åœ¨åˆ°è¾¾ ESTABLISHED çŠ¶æ€å¯ä»¥è¢« accept ç³»ç»Ÿè°ƒç”¨è¿”å›ç»™åº”ç”¨ç¨‹åºå‰ï¼Œå¿…é¡»ç»è¿‡ä¸€ä¸ªä¸­é—´çŠ¶æ€ SYN RECEIVEDã€‚è¿™æ„å‘³ç€ï¼ŒTCP/IP åè®®æ ˆåœ¨å®ç° backlog é˜Ÿåˆ—æ—¶ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„é€‰æ‹©ï¼š ä»…ä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—è§„æ¨¡ç”± listen ç³»ç»Ÿè°ƒç”¨ backlog å‚æ•°æŒ‡å®šã€‚å½“åè®®æ ˆæ”¶åˆ°ä¸€ä¸ª SYN åŒ…æ—¶ï¼Œå“åº” SYN/ACK åŒ…å¹¶ä¸”å°†è¿æ¥åŠ è¿›è¯¥é˜Ÿåˆ—ã€‚å½“æœåŠ¡ç«¯ç›¸åº”çš„ ACK å“åº”åŒ…æ”¶åˆ°åï¼Œè¿æ¥å˜ä¸º ESTABLISHED çŠ¶æ€ï¼Œå¯ä»¥å‘åº”ç”¨ç¨‹åºè¿”å›ã€‚è¿™æ„å‘³ç€é˜Ÿåˆ—é‡Œçš„è¿æ¥å¯ä»¥æœ‰ä¸¤ç§ä¸åŒçš„çŠ¶æ€ï¼šSEND RECEIVED å’Œ ESTABLISHEDã€‚åªæœ‰åä¸€ç§è¿æ¥æ‰èƒ½è¢« accept ç³»ç»Ÿè°ƒç”¨è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚ ä½¿ç”¨ä¸¤ä¸ªé˜Ÿåˆ—â€”â€”SYN é˜Ÿåˆ—(å¾…å®Œæˆè¿æ¥é˜Ÿåˆ—)å’Œ accept é˜Ÿåˆ—(å·²å®Œæˆè¿æ¥é˜Ÿåˆ—)ã€‚çŠ¶æ€ä¸º SYN RECEIVED çš„è¿æ¥è¿›å…¥ SYN é˜Ÿåˆ—ï¼Œåç»­å½“çŠ¶æ€å˜æ›´ä¸º ESTABLISHED æ—¶ç§»åˆ° accept é˜Ÿåˆ—(å³æ”¶åˆ° 3 æ¬¡æ¡æ‰‹ä¸­æœ€åä¸€ä¸ª ACK åŒ…)ã€‚é¡¾åæ€ä¹‰ï¼Œaccept ç³»ç»Ÿè°ƒç”¨å°±åªæ˜¯ç®€å•åœ°ä» accept é˜Ÿåˆ—æ¶ˆè´¹æ–°è¿æ¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œlisten ç³»ç»Ÿè°ƒç”¨ backlog å‚æ•°å†³å®š accept é˜Ÿåˆ—çš„æœ€å¤§è§„æ¨¡ã€‚ å†å²ä¸Šï¼Œèµ·æºäº BSD çš„ TCP å®ç°ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ¡ˆæ„å‘³ç€ï¼Œä½† backlog é™åˆ¶è¾¾åˆ°ï¼Œç³»ç»Ÿå°†åœæ­¢å¯¹ SYN åŒ…å“åº” SYN/ACK åŒ…ã€‚é€šå¸¸ï¼Œåè®®æ ˆåªæ˜¯ä¸¢å¼ƒ SYN åŒ…(è€Œä¸æ˜¯å›ä¸€ä¸ª RST åŒ…)ä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥é‡è¯•(è€Œä¸æ˜¯å¼‚å¸¸é€€å‡º)ã€‚TCP/IP è¯¦è§£ å· 3 ç¬¬ 14.5 èŠ‚ä¸­æœ‰æåˆ°è¿™ä¸€ç‚¹ã€‚ä¹¦ä¸­ä½œè€…æåˆ°ï¼ŒBSD å®ç°è™½ç„¶ä½¿ç”¨äº†ä¸¤ä¸ªç‹¬ç«‹çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯è¡Œä¸ºè·Ÿä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—å¹¶æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚åœ¨ Linux ä¸Šï¼Œæƒ…å†µæœ‰æ‰€ä¸åŒï¼Œæƒ…å†µ listen ç³»ç»Ÿè°ƒç”¨ man æ–‡æ¡£é¡µï¼š 1234backlogå‚æ•°çš„è¡Œä¸ºåœ¨Linux2.2ä¹‹åæœ‰æ‰€æ”¹å˜ã€‚ç°åœ¨ï¼Œå®ƒæŒ‡å®šäº†ç­‰å¾…acceptç³»ç»Ÿè°ƒç”¨çš„å·²å»ºç«‹è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯å¾…å®Œæˆè¿æ¥è¯·æ±‚æ•°ã€‚å¾…å®Œæˆè¿æ¥é˜Ÿåˆ—é•¿åº¦ç”±&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlogæŒ‡å®šï¼›åœ¨syncookieså¯ç”¨çš„æƒ…å†µä¸‹ï¼Œé€»è¾‘ä¸Šæ²¡æœ‰æœ€å¤§å€¼é™åˆ¶ï¼Œè¿™ä¸ªè®¾ç½®ä¾¿è¢«å¿½ç•¥ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å‰ç‰ˆæœ¬çš„ Linux å®ç°äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼Œä½¿ç”¨ä¸¤ä¸ªé˜Ÿåˆ—â€”â€”ä¸€ä¸ª SYN é˜Ÿåˆ—ï¼Œé•¿åº¦ç³»ç»Ÿçº§åˆ«å¯è®¾ç½®ä»¥åŠä¸€ä¸ª accept é˜Ÿåˆ—é•¿åº¦ç”±åº”ç”¨ç¨‹åºæŒ‡å®šã€‚ æ€»ç»“ä¸€ä¸‹ï¼š Linux å†…æ ¸åè®®æ ˆåœ¨æ”¶åˆ° 3 æ¬¡æ¡æ‰‹æœ€åä¸€ä¸ª ACK åŒ…ï¼Œç¡®è®¤ä¸€ä¸ªæ–°è¿æ¥å·²å®Œæˆï¼Œè€Œ accept é˜Ÿåˆ—å·²æ»¡çš„æƒ…å†µä¸‹ï¼Œä¼šå¿½ç•¥è¿™ä¸ªåŒ…ã€‚ä¸€å¼€å§‹æ‚¨å¯èƒ½ä¼šå¯¹æ­¤æ„Ÿåˆ°å¥‡æ€ªâ€”â€”åˆ«å¿˜äº† SYN RECEIVED çŠ¶æ€ä¸‹æœ‰ä¸€ä¸ªè®¡æ—¶å™¨å®ç°ï¼šå¦‚æœ ACK åŒ…æ²¡æœ‰æ”¶åˆ°(æˆ–è€…æ˜¯æˆ‘ä»¬è®¨è®ºçš„å¿½ç•¥)ï¼ŒæœåŠ¡ç«¯ä¼šåˆ©ç”¨è®¡æ—¶å™¨, åè®®æ ˆä¼šé‡å‘ SYN/ACK åŒ…(é‡è¯•æ¬¡æ•°ç”±/proc/sys/net/ipv4/tcp_synack_retries å†³å®š)ã€‚ ä¾‹å­ï¼šä¸€ä¸ªå®¢æˆ·æ­£å°è¯•è¿æ¥ä¸€ä¸ªå·²ç»è¾¾åˆ°å…¶æœ€å¤§ backlog çš„ socket 1234567891011121314151617181920212223240.000 127.0.0.1 -&gt; 127.0.0.1 TCP 74 53302 &gt; 9999 [SYN] Seq&#x3D;0 Len&#x3D;00.000 127.0.0.1 -&gt; 127.0.0.1 TCP 74 9999 &gt; 53302 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Len&#x3D;00.000 127.0.0.1 -&gt; 127.0.0.1 TCP 66 53302 &gt; 9999 [ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;00.000 127.0.0.1 -&gt; 127.0.0.1 TCP 71 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;50.207 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;50.623 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;51.199 127.0.0.1 -&gt; 127.0.0.1 TCP 74 9999 &gt; 53302 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Len&#x3D;01.199 127.0.0.1 -&gt; 127.0.0.1 TCP 66 [TCP Dup ACK 6#1] 53302 &gt; 9999 [ACK] Seq&#x3D;6 Ack&#x3D;1 Len&#x3D;01.455 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;53.123 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;53.399 127.0.0.1 -&gt; 127.0.0.1 TCP 74 9999 &gt; 53302 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Len&#x3D;03.399 127.0.0.1 -&gt; 127.0.0.1 TCP 66 [TCP Dup ACK 10#1] 53302 &gt; 9999 [ACK] Seq&#x3D;6 Ack&#x3D;1 Len&#x3D;06.459 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;57.599 127.0.0.1 -&gt; 127.0.0.1 TCP 74 9999 &gt; 53302 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Len&#x3D;07.599 127.0.0.1 -&gt; 127.0.0.1 TCP 66 [TCP Dup ACK 13#1] 53302 &gt; 9999 [ACK] Seq&#x3D;6 Ack&#x3D;1 Len&#x3D;013.131 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;515.599 127.0.0.1 -&gt; 127.0.0.1 TCP 74 9999 &gt; 53302 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Len&#x3D;015.599 127.0.0.1 -&gt; 127.0.0.1 TCP 66 [TCP Dup ACK 16#1] 53302 &gt; 9999 [ACK] Seq&#x3D;6 Ack&#x3D;1 Len&#x3D;026.491 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;531.599 127.0.0.1 -&gt; 127.0.0.1 TCP 74 9999 &gt; 53302 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Len&#x3D;031.599 127.0.0.1 -&gt; 127.0.0.1 TCP 66 [TCP Dup ACK 19#1] 53302 &gt; 9999 [ACK] Seq&#x3D;6 Ack&#x3D;1 Len&#x3D;053.179 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;5106.491 127.0.0.1 -&gt; 127.0.0.1 TCP 71 [TCP Retransmission] 53302 &gt; 9999 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Len&#x3D;5106.491 127.0.0.1 -&gt; 127.0.0.1 TCP 54 9999 &gt; 53302 [RST] Seq&#x3D;1 Len&#x3D;0 ç”±äºå®¢æˆ·ç«¯çš„ TCP å®ç°åœ¨æ”¶åˆ°å¤šä¸ª SYN/ACK åŒ…æ—¶ï¼Œè®¤ä¸º ACK åŒ…å·²ç»ä¸¢å¤±äº†å¹¶ä¸”é‡ä¼ å®ƒã€‚å¦‚æœåœ¨ SYN/ACK é‡è¯•æ¬¡æ•°è¾¾åˆ°é™åˆ¶å‰ï¼ŒæœåŠ¡ç«¯åº”ç”¨ä» accept é˜Ÿåˆ—æ¥æ”¶è¿æ¥ï¼Œä½¿å¾— backlog å‡å°‘ï¼Œé‚£ä¹ˆåè®®æ ˆä¼šå¤„ç†è¿™äº›é‡ä¼ çš„ ACK åŒ…ï¼Œå°†è¿æ¥çŠ¶æ€ä» SYN RECEIVED å˜æ›´åˆ° ESTABLISHED å¹¶ä¸”å°†å…¶åŠ å…¥ accept é˜Ÿåˆ—ã€‚å¦åˆ™ï¼Œæ­£å¦‚ä»¥ä¸ŠåŒ…è·Ÿè¸ªæ‰€ç¤ºï¼Œå®¢æˆ·è¯»ä¼šæ”¶åˆ°ä¸€ä¸ª RST åŒ…å®£å‘Šè¿æ¥å¤±è´¥ã€‚ åœ¨å®¢æˆ·ç«¯çœ‹æ¥ï¼Œç¬¬ä¸€æ¬¡æ”¶åˆ° SYN/ACK åŒ…ä¹‹åï¼Œè¿æ¥å°±ä¼šè¿›å…¥ ESTABLISHED çŠ¶æ€ã€‚å¦‚æœè¿™æ—¶å®¢æˆ·ç«¯é¦–å…ˆå¼€å§‹å‘é€æ•°æ®ï¼Œé‚£ä¹ˆæ•°æ®ä¹Ÿä¼šè¢«é‡ä¼ ã€‚å¥½åœ¨ TCP æœ‰æ…¢å¯åŠ¨æœºåˆ¶ï¼Œåœ¨æœåŠ¡ç«¯è¿˜æ²¡è¿›å…¥ ESTABLISHED ä¹‹å‰ï¼Œå®¢æˆ·ç«¯èƒ½å‘é€çš„æ•°æ®éå¸¸æœ‰é™ã€‚ ç›¸åï¼Œå¦‚æœå®¢æˆ·ç«¯ä¸€å¼€å§‹å°±åœ¨ç­‰å¾…æœåŠ¡ç«¯ï¼Œè€ŒæœåŠ¡ç«¯ backlog æ²¡èƒ½å‡å°‘ï¼Œé‚£ä¹ˆæœ€åçš„ç»“æœæ˜¯è¿æ¥åœ¨å®¢æˆ·ç«¯çœ‹æ¥æ˜¯ ESTABLISHED çŠ¶æ€ï¼Œä½†åœ¨æœåŠ¡ç«¯çœ‹æ¥æ˜¯ CLOSED çŠ¶æ€ã€‚è¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„åŠå¼€è¿æ¥ã€‚ SYN queue é˜Ÿåˆ—é•¿åº¦ç”±å…¶ä¸­ä¸€ä¸ªå‚æ•°æŒ‡å®šï¼Œé»˜è®¤ä¸º 2048 1&#x2F;proc&#x2F;sys&#x2F;net&#x2F;ipv4&#x2F;tcp_max_syn_backlog Accept queue é˜Ÿåˆ—é•¿åº¦ç”± /proc/sys/net/core/somaxconn å’Œä½¿ç”¨ listen å‡½æ•°æ—¶ä¼ å…¥çš„å‚æ•°ï¼ŒäºŒè€…å–æœ€å°å€¼ã€‚é»˜è®¤ä¸º 128ã€‚åœ¨ Linux å†…æ ¸ 2.4.25 ä¹‹å‰ï¼Œæ˜¯å†™æ­»åœ¨ä»£ç å¸¸é‡ SOMAXCONN ï¼Œåœ¨ Linux å†…æ ¸ 2.4.25 ä¹‹åï¼Œåœ¨é…ç½®æ–‡ä»¶ /proc/sys/net/core/somaxconn ä¸­ç›´æ¥ä¿®æ”¹ï¼Œæˆ–è€…åœ¨ /etc/sysctl.conf ä¸­é…ç½® net.core.somaxconn = 128 ã€‚ 1&#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn 1234567[root@localhost ~]# ss -lState Recv-Q Send-Q Local Address:Port Peer Address:PortLISTEN 0 128 *:http *:*LISTEN 0 128 :::ssh :::*LISTEN 0 128 *:ssh *:*LISTEN 0 100 ::1:smtp :::*LISTEN 0 100 127.0.0.1:smtp *:* åœ¨ LISTEN çŠ¶æ€ï¼Œå…¶ä¸­ Send-Q å³ä¸º Accept queue çš„æœ€å¤§å€¼ï¼ŒRecv-Q åˆ™è¡¨ç¤º Accept queue ä¸­ç­‰å¾…è¢«æœåŠ¡å™¨ accept()ã€‚ å¦å¤–å®¢æˆ·ç«¯ connect()è¿”å›ä¸ä»£è¡¨ TCP è¿æ¥å»ºç«‹æˆåŠŸï¼Œæœ‰å¯èƒ½æ­¤æ—¶ accept queue å·²æ»¡ï¼Œç³»ç»Ÿä¼šç›´æ¥ä¸¢å¼ƒåç»­ ACK è¯·æ±‚ï¼›å®¢æˆ·ç«¯è¯¯ä»¥ä¸ºè¿æ¥å·²å»ºç«‹ï¼Œå¼€å§‹è°ƒç”¨ç­‰å¾…è‡³è¶…æ—¶ï¼›æœåŠ¡å™¨åˆ™ç­‰å¾… ACK è¶…æ—¶ï¼Œä¼šé‡ä¼  SYN+ACK ç»™å®¢æˆ·ç«¯ï¼Œé‡ä¼ æ¬¡æ•°å—é™ net.ipv4.tcp_synack_retries ï¼Œé»˜è®¤ä¸º 5ï¼Œè¡¨ç¤ºé‡å‘ 5 æ¬¡ï¼Œæ¯æ¬¡ç­‰å¾… 30~40 ç§’ï¼Œå³åŠè¿æ¥é»˜è®¤æ—¶é—´å¤§çº¦ä¸º 180 ç§’ï¼Œè¯¥å‚æ•°å¯ä»¥åœ¨ tcp è¢«æ´ªæ°´æ”»å‡»æ˜¯ä¸´æ—¶å¯ç”¨è¿™ä¸ªå‚æ•°ã€‚ keepaliveå…¶å® keepalive çš„åŸç†å°±æ˜¯ TCP å†…åµŒçš„ä¸€ä¸ªå¿ƒè·³åŒ…ã€‚ ä»¥æœåŠ¡å™¨ç«¯ä¸ºä¾‹ï¼Œå¦‚æœå½“å‰ server ç«¯æ£€æµ‹åˆ°è¶…è¿‡ä¸€å®šæ—¶é—´ï¼ˆé»˜è®¤æ˜¯ 7,200,000 millisecondsï¼Œä¹Ÿå°±æ˜¯ 2 ä¸ªå°æ—¶ï¼‰æ²¡æœ‰æ•°æ®ä¼ è¾“ï¼Œé‚£ä¹ˆä¼šå‘ client ç«¯å‘é€ä¸€ä¸ª keep-alive packetï¼ˆè¯¥ keep-alive packet å°±æ˜¯ ACK å’Œå½“å‰ TCP åºåˆ—å·å‡ä¸€çš„ç»„åˆï¼‰ï¼Œæ­¤æ—¶ client ç«¯åº”è¯¥ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹ä¸€ï¼š client ç«¯ä»ç„¶å­˜åœ¨ï¼Œç½‘ç»œè¿æ¥çŠ¶å†µè‰¯å¥½ã€‚æ­¤æ—¶ client ç«¯ä¼šè¿”å›ä¸€ä¸ª ACKã€‚server ç«¯æ¥æ”¶åˆ° ACK åé‡ç½®è®¡æ—¶å™¨ï¼ˆå¤ä½å­˜æ´»å®šæ—¶å™¨ï¼‰ï¼Œåœ¨ 2 å°æ—¶åå†å‘é€æ¢æµ‹ã€‚å¦‚æœ 2 å°æ—¶å†…è¿æ¥ä¸Šæœ‰æ•°æ®ä¼ è¾“ï¼Œé‚£ä¹ˆåœ¨è¯¥æ—¶é—´åŸºç¡€ä¸Šå‘åæ¨å»¶ 2 ä¸ªå°æ—¶ã€‚ å®¢æˆ·ç«¯å¼‚å¸¸å…³é—­ï¼Œæˆ–æ˜¯ç½‘ç»œæ–­å¼€ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œclient ç«¯éƒ½ä¸ä¼šå“åº”ã€‚æœåŠ¡å™¨æ²¡æœ‰æ”¶åˆ°å¯¹å…¶å‘å‡ºæ¢æµ‹çš„å“åº”ï¼Œå¹¶ä¸”åœ¨ä¸€å®šæ—¶é—´ï¼ˆç³»ç»Ÿé»˜è®¤ä¸º 1000 msï¼‰åé‡å¤å‘é€ keep-alive packetï¼Œå¹¶ä¸”é‡å¤å‘é€ä¸€å®šæ¬¡æ•°ï¼ˆ2000 XP 2003 ç³»ç»Ÿé»˜è®¤ä¸º 5 æ¬¡, Vista åçš„ç³»ç»Ÿé»˜è®¤ä¸º 10 æ¬¡ï¼‰ã€‚ å®¢æˆ·ç«¯æ›¾ç»å´©æºƒï¼Œä½†å·²ç»é‡å¯ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨å°†ä¼šæ”¶åˆ°å¯¹å…¶å­˜æ´»æ¢æµ‹çš„å“åº”ï¼Œä½†è¯¥å“åº”æ˜¯ä¸€ä¸ªå¤ä½ï¼Œä»è€Œå¼•èµ·æœåŠ¡å™¨å¯¹è¿æ¥çš„ç»ˆæ­¢ã€‚ å¯¹äºåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œ2 å°æ—¶çš„ç©ºé—²æ—¶é—´å¤ªé•¿ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹å·¥å¼€å¯ Keepalive åŠŸèƒ½å¹¶è®¾ç½®åˆç†çš„ Keepalive å‚æ•°ã€‚ å…¨å±€è®¾ç½®å¯æ›´æ”¹/etc/sysctl.conf,åŠ ä¸Š: 123net.ipv4.tcp_keepalive_intvl &#x3D; 20net.ipv4.tcp_keepalive_probes &#x3D; 3net.ipv4.tcp_keepalive_time &#x3D; 60 åœ¨ç¨‹åºä¸­è®¾ç½®å¦‚ä¸‹: 12345678910111213141516#include &lt;sys/socket.h&gt;#include &lt;netinet/in.h&gt;#include &lt;arpa/inet.h&gt;#include &lt;sys/types.h&gt;#include &lt;netinet/tcp.h&gt;// æ³¨æ„æˆ‘è¿™é‡Œæ•…æ„ç”¨å¿ƒè·³åŒ…å’Œæ¢æµ‹åŒ…æ¥åŒºåˆ†ï¼Œå¿ƒè·³åŒ…æ˜¯æ­£å¸¸å¿ƒè·³åŒ…ï¼Œæ¢æµ‹åŒ…æ˜¯å¿ƒè·³åŒ…å‘é€å¤±è´¥ï¼Œæˆ–è€…æ¥æ”¶è¿”å›çš„ackå¤±è´¥ä¹‹åï¼Œå‘é€çš„å¼‚å¸¸å¿ƒè·³åŒ…int keepAlive = 1; // å¼€å¯keepaliveå±æ€§int keepIdle = 60; // æ¯æ¬¡å¿ƒè·³åŒ…å‘é€çš„æ—¶é—´é—´éš”int keepInterval = 5; // æ¯ä¸ªæ¢æµ‹åŒ…çš„æ—¶é—´é—´éš”ä¸º5 ç§’int keepCount = 3; // æ¢æµ‹å°è¯•çš„æ¬¡æ•°.å¦‚æœç¬¬1æ¬¡æ¢æµ‹åŒ…å°±æ”¶åˆ°å“åº”äº†,åˆ™å2æ¬¡çš„ä¸å†å‘ï¼Œå˜å›æ­£å¸¸çš„å¿ƒè·³åŒ…setsockopt(rs, SOL_SOCKET, SO_KEEPALIVE, (void *)&amp;keepAlive, sizeof(keepAlive));setsockopt(rs, SOL_TCP, TCP_KEEPIDLE, (void*)&amp;keepIdle, sizeof(keepIdle));setsockopt(rs, SOL_TCP, TCP_KEEPINTVL, (void *)&amp;keepInterval, sizeof(keepInterval));setsockopt(rs, SOL_TCP, TCP_KEEPCNT, (void *)&amp;keepCount, sizeof(keepCount)); åœ¨ç¨‹åºä¸­è¡¨ç°ä¸º,å½“ tcp æ£€æµ‹åˆ°å¯¹ç«¯ socket ä¸å†å¯ç”¨æ—¶(ä¸èƒ½å‘å‡ºæ¢æµ‹åŒ…,æˆ–æ¢æµ‹åŒ…æ²¡æœ‰æ”¶åˆ° ACK çš„å“åº”åŒ…),select ä¼šè¿”å› socket å¯è¯»,å¹¶ä¸”åœ¨ recv æ—¶è¿”å›-1,åŒæ—¶ç½®ä¸Š errno ä¸º ETIMEDOUT. æ¨¡æ‹Ÿå¼‚å¸¸è¿æ¥åŸºäº Epoll çš„èŠå¤©æœåŠ¡å™¨","categories":[{"name":"ç½‘ç»œåè®®","slug":"ç½‘ç»œåè®®","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"TCP","slug":"TCP","permalink":"http://blog.crazylaw.cn/tags/TCP/"}]},{"title":"ã€æºç å‰–æã€‘Redisä¸»æµç¨‹","slug":"æºç å‰–æ/redis5æºç å‰–æ","date":"2019-07-10T02:43:43.000Z","updated":"2021-03-20T16:25:01.820Z","comments":true,"path":"2019/07/10/æºç å‰–æ/redis5æºç å‰–æ/","link":"","permalink":"http://blog.crazylaw.cn/2019/07/10/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/redis5%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/","excerpt":"å‰è¨€ä» main å‡½æ•°å¼€å§‹ï¼Œæ²¿ç€ä»£ç æ‰§è¡Œè·¯å¾„ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ä¸€ç›´è¿½ä¸‹å»ã€‚ä½†ä¸ºäº†è®©æœ¬æ–‡ä¸è‡³äºå¤ªè¿‡å†—é•¿ï¼Œæˆ‘ä»¬è¿˜æ˜¯é™å®šä¸€ä¸‹èŒƒå›´ã€‚æœ¬æ–‡çš„ç›®æ ‡å°±å®šä¸ºï¼šå¼•é¢†è¯»è€…ä» main å‡½æ•°å¼€å§‹ï¼Œä¸€æ­¥æ­¥è¿½è¸ªä¸‹å»ï¼Œæœ€ç»ˆåˆ°è¾¾ä»»ä¸€ Redis å‘½ä»¤çš„æ‰§è¡Œå…¥å£ã€‚ åç»­ï¼Œå†å‰–æå„ä¸ªå‘½ä»¤çš„å†…éƒ¨å®ç° æœ¬æ–‡åŸºäº redis5.0 åˆ†æ”¯ ä¸ºäº†è¡¨è¿°æ¸…æ¥šï¼Œæœ¬æ–‡æŒ‰ç…§å¦‚ä¸‹æ€è·¯è¿›è¡Œï¼š å…ˆæ¦‚æ‹¬åœ°ä»‹ç»æ•´ä¸ªä»£ç åˆå§‹åŒ–æµç¨‹ï¼ˆä» main å‡½æ•°å¼€å§‹ï¼‰å’Œäº‹ä»¶å¾ªç¯çš„ç»“æ„ï¼› å†æ¦‚æ‹¬åœ°ä»‹ç»å¯¹äº Redis å‘½ä»¤è¯·æ±‚çš„å¤„ç†æµç¨‹ï¼› é‡ç‚¹ä»‹ç»äº‹ä»¶æœºåˆ¶ï¼› å¯¹äºå‰é¢ä»‹ç»çš„å„ä¸ªä»£ç å¤„ç†æµç¨‹ï¼Œç»™å‡ºè¯¦ç»†çš„ä»£ç è°ƒç”¨å…³ç³»ï¼Œæ–¹ä¾¿éšæ—¶æŸ¥é˜…ï¼› æ ¹æ®è¿™æ ·å‡ éƒ¨åˆ†çš„åˆ’åˆ†ï¼Œå¦‚æœä½ åªæƒ³ç²—è¯»å¤§è‡´çš„å¤„ç†æµç¨‹ï¼Œé‚£ä¹ˆåªéœ€è¦é˜…è¯»å‰ä¸¤ä¸ªéƒ¨åˆ†å°±å¯ä»¥äº†ã€‚è€Œåä¸¤éƒ¨åˆ†åˆ™ä¼šæ·±å…¥åˆ°æŸäº›å€¼å¾—å…³æ³¨çš„ç»†èŠ‚ã€‚","text":"å‰è¨€ä» main å‡½æ•°å¼€å§‹ï¼Œæ²¿ç€ä»£ç æ‰§è¡Œè·¯å¾„ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ä¸€ç›´è¿½ä¸‹å»ã€‚ä½†ä¸ºäº†è®©æœ¬æ–‡ä¸è‡³äºå¤ªè¿‡å†—é•¿ï¼Œæˆ‘ä»¬è¿˜æ˜¯é™å®šä¸€ä¸‹èŒƒå›´ã€‚æœ¬æ–‡çš„ç›®æ ‡å°±å®šä¸ºï¼šå¼•é¢†è¯»è€…ä» main å‡½æ•°å¼€å§‹ï¼Œä¸€æ­¥æ­¥è¿½è¸ªä¸‹å»ï¼Œæœ€ç»ˆåˆ°è¾¾ä»»ä¸€ Redis å‘½ä»¤çš„æ‰§è¡Œå…¥å£ã€‚ åç»­ï¼Œå†å‰–æå„ä¸ªå‘½ä»¤çš„å†…éƒ¨å®ç° æœ¬æ–‡åŸºäº redis5.0 åˆ†æ”¯ ä¸ºäº†è¡¨è¿°æ¸…æ¥šï¼Œæœ¬æ–‡æŒ‰ç…§å¦‚ä¸‹æ€è·¯è¿›è¡Œï¼š å…ˆæ¦‚æ‹¬åœ°ä»‹ç»æ•´ä¸ªä»£ç åˆå§‹åŒ–æµç¨‹ï¼ˆä» main å‡½æ•°å¼€å§‹ï¼‰å’Œäº‹ä»¶å¾ªç¯çš„ç»“æ„ï¼› å†æ¦‚æ‹¬åœ°ä»‹ç»å¯¹äº Redis å‘½ä»¤è¯·æ±‚çš„å¤„ç†æµç¨‹ï¼› é‡ç‚¹ä»‹ç»äº‹ä»¶æœºåˆ¶ï¼› å¯¹äºå‰é¢ä»‹ç»çš„å„ä¸ªä»£ç å¤„ç†æµç¨‹ï¼Œç»™å‡ºè¯¦ç»†çš„ä»£ç è°ƒç”¨å…³ç³»ï¼Œæ–¹ä¾¿éšæ—¶æŸ¥é˜…ï¼› æ ¹æ®è¿™æ ·å‡ éƒ¨åˆ†çš„åˆ’åˆ†ï¼Œå¦‚æœä½ åªæƒ³ç²—è¯»å¤§è‡´çš„å¤„ç†æµç¨‹ï¼Œé‚£ä¹ˆåªéœ€è¦é˜…è¯»å‰ä¸¤ä¸ªéƒ¨åˆ†å°±å¯ä»¥äº†ã€‚è€Œåä¸¤éƒ¨åˆ†åˆ™ä¼šæ·±å…¥åˆ°æŸäº›å€¼å¾—å…³æ³¨çš„ç»†èŠ‚ã€‚ åˆå§‹åŒ–æµç¨‹å’Œäº‹ä»¶å¾ªç¯æ¦‚è¿°Redis æºç çš„ main å‡½æ•°åœ¨æºæ–‡ä»¶ server.c ä¸­ã€‚main å‡½æ•°å¼€å§‹æ‰§è¡Œåçš„é€»è¾‘å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š å„ç§åˆå§‹åŒ–ï¼ˆåŒ…æ‹¬äº‹ä»¶å¾ªç¯çš„åˆå§‹åŒ–ï¼‰ æ‰§è¡Œäº‹ä»¶å¾ªç¯ è¿™ä¸¤ä¸ªæ‰§è¡Œé˜¶æ®µå¯ä»¥ç”¨ä¸‹é¢çš„æµç¨‹å›¾æ¥è¡¨è¾¾ï¼ˆç‚¹å‡»çœ‹å¤§å›¾ï¼‰ï¼š é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åˆå§‹åŒ–é˜¶æ®µä¸­çš„å„ä¸ªæ­¥éª¤ï¼š é…ç½®åŠ è½½å’Œåˆå§‹åŒ–ã€‚è¿™ä¸€æ­¥è¡¨ç¤º Redis æœåŠ¡å™¨åŸºæœ¬æ•°æ®ç»“æ„å’Œå„ç§å‚æ•°çš„åˆå§‹åŒ–ã€‚åœ¨ Redis æºç ä¸­ï¼ŒRedis æœåŠ¡å™¨æ˜¯ç”¨ä¸€ä¸ªå«åš redisServer çš„ struct æ¥è¡¨è¾¾çš„ï¼Œé‡Œé¢å®šä¹‰äº† Redis æœåŠ¡å™¨èµ–ä»¥è¿è¡Œçš„å„ç§å‚æ•°ï¼Œæ¯”å¦‚ç›‘å¬çš„ç«¯å£å·å’Œæ–‡ä»¶æè¿°ç¬¦ã€å½“å‰è¿æ¥çš„å„ä¸ª client ç«¯ã€Redis å‘½ä»¤è¡¨(command table)é…ç½®ã€æŒä¹…åŒ–ç›¸å…³çš„å„ç§å‚æ•°ï¼Œç­‰ç­‰ï¼Œä»¥åŠåé¢é©¬ä¸Šä¼šè®¨è®ºçš„äº‹ä»¶å¾ªç¯ç»“æ„ã€‚Redis æœåŠ¡å™¨åœ¨è¿è¡Œæ—¶å°±æ˜¯ç”±ä¸€ä¸ª redisServer ç±»å‹çš„å…¨å±€å˜é‡æ¥è¡¨ç¤ºçš„ï¼ˆå˜é‡åå°±å« serverï¼‰ï¼Œè¿™ä¸€æ­¥çš„åˆå§‹åŒ–ä¸»è¦å°±æ˜¯å¯¹äºè¿™ä¸ªå…¨å±€å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªéœ€è¦ç‰¹åˆ«å…³æ³¨çš„å‡½æ•°ï¼špopulateCommandTableã€‚å®ƒåˆå§‹åŒ–äº† Redis å‘½ä»¤è¡¨ï¼Œé€šè¿‡å®ƒå¯ä»¥ç”±ä»»æ„ä¸€ä¸ª Redis å‘½ä»¤çš„åå­—æŸ¥æ‰¾è¯¥å‘½ä»¤çš„é…ç½®ä¿¡æ¯ï¼ˆæ¯”å¦‚è¯¥å‘½ä»¤æ¥æ”¶çš„å‘½ä»¤å‚æ•°ä¸ªæ•°ã€æ‰§è¡Œå‡½æ•°å…¥å£ç­‰ï¼‰ã€‚åœ¨æœ¬æ–‡çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä¼šä¸€èµ·æ¥çœ‹ä¸€çœ‹å¦‚ä½•ä»æ¥æ”¶ä¸€ä¸ª Redis å‘½ä»¤çš„è¯·æ±‚å¼€å§‹ï¼Œä¸€æ­¥æ­¥æ‰§è¡Œåˆ°æ¥æŸ¥é˜…è¿™ä¸ªå‘½ä»¤è¡¨ï¼Œä»è€Œæ‰¾åˆ°è¯¥å‘½ä»¤çš„æ‰§è¡Œå…¥å£ã€‚å¦å¤–ï¼Œè¿™ä¸€æ­¥ä¸­è¿˜æœ‰ä¸€ä¸ªå€¼å¾—ä¸€æçš„åœ°æ–¹ï¼šåœ¨å¯¹å…¨å±€çš„ redisServer ç»“æ„è¿›è¡Œäº†åˆå§‹åŒ–ä¹‹åï¼Œè¿˜éœ€è¦ä»é…ç½®æ–‡ä»¶ï¼ˆredis.confï¼‰ä¸­åŠ è½½é…ç½®ã€‚è¿™ä¸ªè¿‡ç¨‹å¯èƒ½è¦†ç›–æ‰ä¹‹å‰åˆå§‹åŒ–è¿‡çš„ redisServer ç»“æ„ä¸­çš„æŸäº›å‚æ•°ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯å…ˆç»è¿‡ä¸€è½®åˆå§‹åŒ–ï¼Œä¿è¯ Redis çš„å„ä¸ªå†…éƒ¨æ•°æ®ç»“æ„ä»¥åŠå‚æ•°éƒ½æœ‰ç¼ºçœå€¼ï¼Œç„¶åå†ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½è‡ªå®šä¹‰çš„é…ç½®ã€‚ åˆ›å»ºäº‹ä»¶å¾ªç¯ã€‚åœ¨ Redis ä¸­ï¼Œäº‹ä»¶å¾ªç¯æ˜¯ç”¨ä¸€ä¸ªå« aeEventLoop çš„ struct æ¥è¡¨ç¤ºçš„ã€‚ã€Œåˆ›å»ºäº‹ä»¶å¾ªç¯ã€è¿™ä¸€æ­¥ä¸»è¦å°±æ˜¯åˆ›å»ºä¸€ä¸ª aeEventLoop ç»“æ„ï¼Œå¹¶å­˜å‚¨åˆ° server å…¨å±€å˜é‡ï¼ˆå³å‰é¢æåˆ°çš„ redisServer ç±»å‹çš„ç»“æ„ï¼‰ä¸­ã€‚å¦å¤–ï¼Œäº‹ä»¶å¾ªç¯çš„æ‰§è¡Œä¾èµ–ç³»ç»Ÿåº•å±‚çš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶(I/O multiplexing)ï¼Œæ¯”å¦‚ Linux ç³»ç»Ÿä¸Šçš„ epoll æœºåˆ¶[1]ã€‚å› æ­¤ï¼Œè¿™ä¸€æ­¥ä¹ŸåŒ…å«å¯¹äºåº•å±‚ I/O å¤šè·¯å¤ç”¨æœºåˆ¶çš„åˆå§‹åŒ–ï¼ˆè°ƒç”¨ç³»ç»Ÿ APIï¼‰ã€‚ å¼€å§‹ socket ç›‘å¬ã€‚æœåŠ¡å™¨ç¨‹åºéœ€è¦ç›‘å¬æ‰èƒ½æ”¶åˆ°è¯·æ±‚ã€‚æ ¹æ®é…ç½®ï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šæ‰“å¼€ä¸¤ç§ç›‘å¬ï¼šå¯¹äº TCP è¿æ¥çš„ç›‘å¬å’Œå¯¹äº Unix domain socket[2]çš„ç›‘å¬ã€‚ã€ŒUnix domain socketã€æ˜¯ä¸€ç§é«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡(IPC[3])æœºåˆ¶ï¼Œåœ¨ POSIX è§„èŒƒ[4]ä¸­ä¹Ÿæœ‰æ˜ç¡®çš„å®šä¹‰[5]ï¼Œç”¨äºåœ¨åŒä¸€å°ä¸»æœºä¸Šçš„ä¸¤ä¸ªä¸åŒè¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œæ¯”ä½¿ç”¨ TCP åè®®æ€§èƒ½æ›´é«˜ï¼ˆå› ä¸ºçœå»äº†åè®®æ ˆçš„å¼€é”€ï¼‰ã€‚å½“ä½¿ç”¨ Redis å®¢æˆ·ç«¯è¿æ¥åŒä¸€å°æœºå™¨ä¸Šçš„ Redis æœåŠ¡å™¨æ—¶ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨ã€ŒUnix domain socketã€è¿›è¡Œè¿æ¥ã€‚ä½†ä¸ç®¡æ˜¯å“ªä¸€ç§ç›‘å¬ï¼Œç¨‹åºéƒ½ä¼šè·å¾—æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶å­˜å‚¨åˆ° server å…¨å±€å˜é‡ä¸­ã€‚å¯¹äº TCP çš„ç›‘å¬æ¥è¯´ï¼Œç”±äºç›‘å¬çš„ IP åœ°å€å’Œç«¯å£å¯ä»¥ç»‘å®šå¤šä¸ªï¼Œå› æ­¤è·å¾—çš„ç”¨äºç›‘å¬ TCP è¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ä¹Ÿå¯ä»¥åŒ…å«å¤šä¸ªã€‚åé¢ï¼Œç¨‹åºå°±å¯ä»¥æ‹¿è¿™ä¸€æ­¥è·å¾—çš„æ–‡ä»¶æè¿°ç¬¦å»æ³¨å†Œ I/O äº‹ä»¶å›è°ƒäº†ã€‚ æ³¨å†Œ timer äº‹ä»¶å›è°ƒã€‚Redis ä½œä¸ºä¸€ä¸ªå•çº¿ç¨‹(single-threaded)çš„ç¨‹åºï¼Œå®ƒå¦‚æœæƒ³è°ƒåº¦ä¸€äº›å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚å‘¨æœŸæ€§åœ°æ‰§è¡Œè¿‡æœŸ key çš„å›æ”¶åŠ¨ä½œï¼Œé™¤äº†ä¾èµ–äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œæ²¡æœ‰å…¶å®ƒçš„åŠæ³•ã€‚è¿™ä¸€æ­¥å°±æ˜¯å‘å‰é¢åˆšåˆšåˆ›å»ºå¥½çš„äº‹ä»¶å¾ªç¯ä¸­æ³¨å†Œä¸€ä¸ª timer äº‹ä»¶ï¼Œå¹¶é…ç½®æˆå¯ä»¥å‘¨æœŸæ€§åœ°æ‰§è¡Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼šserverCronã€‚ç”±äº Redis åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œå› æ­¤è¿™ä¸ªå‡½æ•°å‘¨æœŸæ€§çš„æ‰§è¡Œä¹Ÿæ˜¯åœ¨è¿™ä¸ªçº¿ç¨‹å†…ï¼Œå®ƒç”±äº‹ä»¶å¾ªç¯æ¥é©±åŠ¨ï¼ˆå³åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ï¼‰ï¼Œä½†ä¸å½±å“åŒä¸€ä¸ªçº¿ç¨‹ä¸Šå…¶å®ƒé€»è¾‘çš„æ‰§è¡Œï¼ˆç›¸å½“äºæŒ‰æ—¶é—´åˆ†ç‰‡äº†ï¼‰ã€‚serverCron å‡½æ•°åˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿå®é™…ä¸Šï¼Œå®ƒé™¤äº†å‘¨æœŸæ€§åœ°æ‰§è¡Œè¿‡æœŸ key çš„å›æ”¶åŠ¨ä½œï¼Œè¿˜æ‰§è¡Œäº†å¾ˆå¤šå…¶å®ƒä»»åŠ¡ï¼Œæ¯”å¦‚ä¸»ä»é‡è¿ã€Cluster èŠ‚ç‚¹é—´çš„é‡è¿ã€BGSAVE å’Œ AOF rewrite çš„è§¦å‘æ‰§è¡Œï¼Œç­‰ç­‰ã€‚è¿™ä¸ªä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œè¿™é‡Œå°±ä¸å±•å¼€æè¿°äº†ã€‚ æ³¨å†Œ I/O äº‹ä»¶å›è°ƒã€‚Redis æœåŠ¡ç«¯æœ€ä¸»è¦çš„å·¥ä½œå°±æ˜¯ç›‘å¬ I/O äº‹ä»¶ï¼Œä»ä¸­åˆ†æå‡ºæ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œç„¶åè¿”å›å“åº”ç»“æœã€‚å¯¹äº I/O äº‹ä»¶çš„ç›‘å¬ï¼Œè‡ªç„¶ä¹Ÿæ˜¯ä¾èµ–äº‹ä»¶å¾ªç¯ã€‚å‰é¢æåˆ°è¿‡ï¼ŒRedis å¯ä»¥æ‰“å¼€ä¸¤ç§ç›‘å¬ï¼šå¯¹äº TCP è¿æ¥çš„ç›‘å¬å’Œå¯¹äº Unix domain socket çš„ç›‘å¬ã€‚å› æ­¤ï¼Œè¿™é‡Œå°±åŒ…å«å¯¹äºè¿™ä¸¤ç§ I/O äº‹ä»¶çš„å›è°ƒçš„æ³¨å†Œï¼Œä¸¤ä¸ªå›è°ƒå‡½æ•°åˆ†åˆ«æ˜¯ acceptTcpHandler å’Œ acceptUnixHandlerã€‚å¯¹äºæ¥è‡ª Redis å®¢æˆ·ç«¯çš„è¯·æ±‚çš„å¤„ç†ï¼Œå°±ä¼šèµ°åˆ°è¿™ä¸¤ä¸ªå‡½æ•°ä¸­å»ã€‚æˆ‘ä»¬åœ¨ä¸‹ä¸€éƒ¨åˆ†å°±ä¼šè®¨è®ºåˆ°è¿™ä¸ªå¤„ç†è¿‡ç¨‹ã€‚å¦å¤–ï¼Œå…¶å® Redis åœ¨è¿™é‡Œè¿˜ä¼šæ³¨å†Œä¸€ä¸ª I/O äº‹ä»¶ï¼Œç”¨äºé€šè¿‡ç®¡é“(pipe[6])æœºåˆ¶ä¸ module è¿›è¡ŒåŒå‘é€šä¿¡ã€‚è¿™ä¸ªä¹Ÿä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæˆ‘ä»¬æš‚æ—¶å¿½ç•¥å®ƒã€‚ åˆå§‹åŒ–åå°çº¿ç¨‹ã€‚Redis ä¼šåˆ›å»ºä¸€äº›é¢å¤–çš„çº¿ç¨‹ï¼Œåœ¨åå°è¿è¡Œï¼Œä¸“é—¨ç”¨äºå¤„ç†ä¸€äº›è€—æ—¶çš„å¹¶ä¸”å¯ä»¥è¢«å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯ä¸€äº›æ¸…ç†å·¥ä½œï¼‰ã€‚åœ¨ Redis é‡Œé¢è¿™äº›åå°çº¿ç¨‹è¢«ç§°ä¸º bio(Background I/O service)ã€‚å®ƒä»¬è´Ÿè´£çš„ä»»åŠ¡åŒ…æ‹¬ï¼šå¯ä»¥å»¶è¿Ÿæ‰§è¡Œçš„æ–‡ä»¶å…³é—­æ“ä½œ(æ¯”å¦‚ unlink å‘½ä»¤çš„æ‰§è¡Œ)ï¼ŒAOF çš„æŒä¹…åŒ–å†™åº“æ“ä½œ(å³ fsync è°ƒç”¨ï¼Œä½†æ³¨æ„åªæœ‰å¯ä»¥è¢«å»¶è¿Ÿæ‰§è¡Œçš„ fsync æ“ä½œæ‰åœ¨åå°çº¿ç¨‹æ‰§è¡Œ)ï¼Œè¿˜æœ‰ä¸€äº›å¤§ key çš„æ¸…é™¤æ“ä½œ(æ¯”å¦‚ flushdb async å‘½ä»¤çš„æ‰§è¡Œ)ã€‚å¯è§ bio è¿™ä¸ªåå­—æœ‰ç‚¹åä¸å‰¯å®ï¼Œå®ƒåšçš„äº‹æƒ…ä¸ä¸€å®šè·Ÿ I/O æœ‰å…³ã€‚å¯¹äºè¿™äº›åå°çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜ä¼šäº§ç”Ÿä¸€ä¸ªç–‘é—®ï¼šå‰é¢çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå·²ç»æ³¨å†Œäº†ä¸€ä¸ª timer äº‹ä»¶å›è°ƒï¼Œå³ serverCron å‡½æ•°ï¼ŒæŒ‰è¯´åå°çº¿ç¨‹æ‰§è¡Œçš„è¿™äº›ä»»åŠ¡ä¼¼ä¹ä¹Ÿå¯ä»¥æ”¾åœ¨ serverCron ä¸­å»æ‰§è¡Œã€‚å› ä¸º serverCron å‡½æ•°ä¹Ÿæ˜¯å¯ä»¥ç”¨æ¥æ‰§è¡Œåå°ä»»åŠ¡çš„ã€‚å®é™…ä¸Šè¿™æ ·åšæ˜¯ä¸è¡Œçš„ã€‚å‰é¢æˆ‘ä»¬å·²ç»æåˆ°è¿‡ï¼ŒserverCron ç”±äº‹ä»¶å¾ªç¯æ¥é©±åŠ¨ï¼Œæ‰§è¡Œè¿˜æ˜¯åœ¨ Redis ä¸»çº¿ç¨‹ä¸Šï¼Œç›¸å½“äºå’Œä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œçš„å…¶å®ƒæ“ä½œï¼ˆä¸»è¦æ˜¯å¯¹äºå‘½ä»¤è¯·æ±‚çš„æ‰§è¡Œï¼‰æŒ‰æ—¶é—´è¿›è¡Œåˆ†ç‰‡äº†ã€‚è¿™æ ·çš„è¯ï¼ŒserverCron é‡Œé¢å°±ä¸èƒ½æ‰§è¡Œè¿‡äºè€—æ—¶çš„æ“ä½œï¼Œå¦åˆ™å®ƒå°±ä¼šå½±å“ Redis æ‰§è¡Œå‘½ä»¤çš„å“åº”æ—¶é—´ã€‚å› æ­¤ï¼Œå¯¹äºè€—æ—¶çš„ã€å¹¶ä¸”å¯ä»¥è¢«å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œå°±åªèƒ½æ”¾åˆ°å•ç‹¬çš„çº¿ç¨‹ä¸­å»æ‰§è¡Œäº†ã€‚ å¯åŠ¨äº‹ä»¶å¾ªç¯ã€‚å‰é¢åˆ›å»ºå¥½äº†äº‹ä»¶å¾ªç¯çš„ç»“æ„ï¼Œä½†è¿˜æ²¡æœ‰çœŸæ­£è¿›å…¥å¾ªç¯çš„é€»è¾‘ã€‚è¿‡äº†è¿™ä¸€æ­¥ï¼Œäº‹ä»¶å¾ªç¯å°±è¿è¡Œèµ·æ¥ï¼Œé©±åŠ¨å‰é¢æ³¨å†Œçš„ timer äº‹ä»¶å›è°ƒå’Œ I/O äº‹ä»¶å›è°ƒä¸æ–­æ‰§è¡Œã€‚ æ³¨æ„ï¼šRedis æœåŠ¡å™¨çš„åˆå§‹åŒ–å…¶å®è¿˜è¦å®Œæˆå¾ˆå¤šå¾ˆå¤šäº‹ï¼Œæ¯”å¦‚åŠ è½½æ•°æ®åˆ°å†…å­˜ï¼ŒCluster é›†ç¾¤çš„åˆå§‹åŒ–ï¼Œmodule çš„åˆå§‹åŒ–ï¼Œç­‰ç­‰ã€‚ä½†ä¸ºäº†ç®€åŒ–ï¼Œä¸Šé¢è®¨è®ºçš„åˆå§‹åŒ–æµç¨‹ï¼Œåªåˆ—å‡ºäº†æˆ‘ä»¬å½“å‰å…³æ³¨çš„æ­¥éª¤ã€‚æœ¬æ–‡å…³æ³¨çš„æ˜¯ç”±äº‹ä»¶é©±åŠ¨çš„æ•´ä¸ªè¿è¡Œæœºåˆ¶ä»¥åŠè·Ÿå‘½ä»¤æ‰§è¡Œç›´æ¥ç›¸å…³çš„éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘ä»¬æš‚æ—¶å¿½ç•¥æ‰å…¶å®ƒä¸å¤ªç›¸å…³çš„æ­¥éª¤ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬ç»§ç»­å»è®¨è®ºä¸Šé¢æµç¨‹å›¾ä¸­çš„ç¬¬äºŒä¸ªé˜¶æ®µï¼šäº‹ä»¶å¾ªç¯ã€‚ æˆ‘ä»¬å…ˆæƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ä¸€ä¸ªå¾ªç¯ã€‚ ä¸€ä¸ªç¨‹åºå¯åŠ¨åï¼Œå¦‚æœæ²¡æœ‰å¾ªç¯ï¼Œé‚£ä¹ˆå®ƒä»ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸€ç›´æ‰§è¡Œåˆ°æœ€åä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åå°±åªèƒ½é€€å‡ºäº†ã€‚è€Œ Redis ä½œä¸ºä¸€ä¸ªæœåŠ¡ç«¯ç¨‹åºï¼Œæ˜¯è¦ç­‰ç€å®¢æˆ·ç«¯ä¸åœåœ°å‘æ¥è¯·æ±‚ç„¶ååšç›¸åº”çš„å¤„ç†ï¼Œä¸èƒ½è‡ªå·±æ‰§è¡Œå®Œå°±é€€å‡ºäº†ã€‚å› æ­¤ï¼ŒRedis å¯åŠ¨åå¿…å®šè¦è¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ã€‚æ˜¾ç„¶ï¼Œç¨‹åºåœ¨æ¯ä¸€æ¬¡çš„å¾ªç¯æ‰§è¡Œä¸­ï¼Œå¦‚æœæœ‰äº‹ä»¶ï¼ˆåŒ…æ‹¬å®¢æˆ·ç«¯è¯·æ±‚çš„ I/O äº‹ä»¶ï¼‰å‘ç”Ÿï¼Œå°±ä¼šå»å¤„ç†è¿™äº›äº‹ä»¶ã€‚ä½†å¦‚æœæ²¡æœ‰äº‹ä»¶å‘ç”Ÿå‘¢ï¼Ÿç¨‹åºæ˜¾ç„¶ä¹Ÿä¸åº”è¯¥ç©ºè½¬ï¼Œè€Œæ˜¯åº”è¯¥ç­‰å¾…ï¼ŒæŠŠæ•´ä¸ªå¾ªç¯é˜»å¡ä½ã€‚è¿™é‡Œçš„ç­‰å¾…ï¼Œå°±æ˜¯ä¸Šé¢æµç¨‹å›¾é‡Œçš„ã€Œç­‰å¾…äº‹ä»¶å‘ç”Ÿã€è¿™ä¸ªæ­¥éª¤ã€‚é‚£ä¹ˆï¼Œå½“æ•´ä¸ªå¾ªç¯è¢«é˜»å¡ä½ä¹‹åï¼Œä»€ä¹ˆæ—¶å€™å†æ¢å¤æ‰§è¡Œå‘¢ï¼Ÿè‡ªç„¶æ˜¯ç­‰å¾…çš„äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œç¨‹åºè¢«é‡æ–°å”¤é†’ï¼Œå¾ªç¯ç»§ç»­ä¸‹å»ã€‚è¿™é‡Œéœ€è¦çš„ç­‰å¾…å’Œå”¤é†’æ“ä½œï¼Œæ€ä¹ˆå®ç°å‘¢ï¼Ÿå®ƒä»¬éƒ½éœ€è¦ä¾èµ–ç³»ç»Ÿçš„èƒ½åŠ›æ‰èƒ½åšåˆ°ï¼ˆæˆ‘ä»¬åœ¨æ–‡ç« ç¬¬ä¸‰éƒ¨åˆ†ä¼šè¯¦ç»†ä»‹ç»ï¼‰ã€‚ å®é™…ä¸Šï¼Œè¿™ç§äº‹ä»¶å¾ªç¯æœºåˆ¶ï¼Œå¯¹äºå¼€å‘è¿‡æ‰‹æœºå®¢æˆ·ç«¯çš„åŒå­¦æ¥è¯´ï¼Œæ˜¯éå¸¸å¸¸è§ä¸”åŸºç¡€çš„æœºåˆ¶ã€‚æ¯”å¦‚è·‘åœ¨ iOS/Android ä¸Šé¢çš„ Appï¼Œè¿™äº›ç¨‹åºéƒ½æœ‰ä¸€ä¸ªæ¶ˆæ¯å¾ªç¯ï¼Œè´Ÿè´£ç­‰å¾…å„ç§ UI äº‹ä»¶ï¼ˆç‚¹å‡»ã€æ»‘åŠ¨ç­‰ï¼‰çš„å‘ç”Ÿï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚åŒç†ï¼Œå¯¹åº”åˆ°æœåŠ¡ç«¯ï¼Œè¿™ä¸ªå¾ªç¯çš„åŸç†å¯ä»¥è®¤ä¸ºå·®ä¸å¤šï¼Œåªæ˜¯ç­‰å¾…å’Œå¤„ç†çš„äº‹ä»¶å˜æˆæ˜¯ I/O äº‹ä»¶äº†ã€‚å¦å¤–ï¼Œé™¤äº† I/O äº‹ä»¶ï¼Œæ•´ä¸ªç³»ç»Ÿåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è‚¯å®šè¿˜éœ€è¦æ ¹æ®æ—¶é—´æ¥è°ƒåº¦æ‰§è¡Œä¸€äº›ä»»åŠ¡ï¼Œæ¯”å¦‚å»¶è¿Ÿ 100 æ¯«ç§’å†æ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œæˆ–è€…å‘¨æœŸæ€§åœ°æ¯éš” 1 ç§’æ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œè¿™å°±éœ€è¦ç­‰å¾…å’Œå¤„ç†å¦å¤–ä¸€ç§äº‹ä»¶â€”â€”timer äº‹ä»¶ã€‚ timer äº‹ä»¶å’Œ I/O äº‹ä»¶æ˜¯ä¸¤ç§æˆªç„¶ä¸åŒçš„äº‹ä»¶ï¼Œå¦‚ä½•ç”±äº‹ä»¶å¾ªç¯æ¥ç»Ÿä¸€è°ƒåº¦å‘¢ï¼Ÿå‡è®¾äº‹ä»¶å¾ªç¯åœ¨ç©ºé—²çš„æ—¶å€™å»ç­‰å¾… I/O äº‹ä»¶çš„å‘ç”Ÿï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¸€ä¸ª timer äº‹ä»¶å…ˆå‘ç”Ÿäº†ï¼Œè¿™æ—¶äº‹ä»¶å¾ªç¯å°±æ²¡æœ‰è¢«åŠæ—¶å”¤é†’ï¼ˆä»åœ¨ç­‰å¾… I/O äº‹ä»¶ï¼‰ï¼›åä¹‹ï¼Œå¦‚æœäº‹ä»¶å¾ªç¯åœ¨ç­‰å¾… timer äº‹ä»¶ï¼Œè€Œä¸€ä¸ª I/O äº‹ä»¶å…ˆå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆåŒæ ·æ²¡èƒ½å¤Ÿè¢«åŠæ—¶å”¤é†’ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶èƒ½å¤ŸåŒæ—¶ç­‰å¾…è¿™ä¸¤ç§äº‹ä»¶çš„å‘ç”Ÿã€‚è€Œæ°å¥½ï¼Œä¸€äº›ç³»ç»Ÿçš„ API å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼ˆæ¯”å¦‚æˆ‘ä»¬å‰é¢æåˆ°çš„ epoll æœºåˆ¶ï¼‰ã€‚ å‰é¢æµç¨‹å›¾çš„ç¬¬äºŒé˜¶æ®µå·²ç»æ¯”è¾ƒæ¸…æ¥šåœ°è¡¨è¾¾å‡ºäº†äº‹ä»¶å¾ªç¯çš„æ‰§è¡Œæµç¨‹ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å¯¹äºå…¶ä¸­ä¸€äº›æ­¥éª¤éœ€è¦å…³æ³¨çš„åœ°æ–¹åšä¸€äº›è¡¥å……è¯´æ˜ï¼š æŸ¥æ‰¾æœ€è¿‘çš„ timer äº‹ä»¶ã€‚å¦‚å‰æ‰€è¿°ï¼Œäº‹ä»¶å¾ªç¯éœ€è¦ç­‰å¾… timer å’Œ I/O ä¸¤ç§äº‹ä»¶ã€‚å¯¹äº I/O äº‹ä»¶ï¼Œåªéœ€è¦æ˜ç¡®è¦ç­‰å¾…çš„æ˜¯å“ªäº›æ–‡ä»¶æè¿°ç¬¦å°±å¯ä»¥äº†ï¼›è€Œå¯¹äº timer äº‹ä»¶ï¼Œè¿˜éœ€è¦ç»è¿‡ä¸€ç•ªæ¯”è¾ƒï¼Œæ˜ç¡®åœ¨å½“å‰è¿™ä¸€è½®å¾ªç¯ä¸­éœ€è¦ç­‰å¾…å¤šé•¿æ—¶é—´ã€‚ç”±äºç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½æ³¨å†Œå¤šä¸ª timer äº‹ä»¶å›è°ƒï¼Œæ¯”å¦‚å…ˆè¦æ±‚åœ¨ 100 æ¯«ç§’åæ‰§è¡Œä¸€ä¸ªå›è°ƒï¼ŒåŒæ—¶åˆè¦æ±‚åœ¨ 200 æ¯«ç§’åæ‰§è¡Œå¦ä¸€ä¸ªå›è°ƒï¼Œè¿™å°±è¦æ±‚äº‹ä»¶å¾ªç¯åœ¨å®ƒçš„æ¯ä¸€è½®æ‰§è¡Œä¹‹å‰ï¼Œé¦–å…ˆè¦æ‰¾å‡ºæœ€è¿‘éœ€è¦æ‰§è¡Œçš„é‚£æ¬¡ timer äº‹ä»¶ã€‚è¿™æ ·äº‹ä»¶å¾ªç¯åœ¨æ¥ä¸‹æ¥çš„ç­‰å¾…ä¸­å°±çŸ¥é“è¯¥ç­‰å¾…å¤šé•¿æ—¶é—´ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç­‰å¾… 100 æ¯«ç§’ï¼‰ã€‚ ç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚è¿™ä¸€æ­¥æˆ‘ä»¬éœ€è¦èƒ½å¤ŸåŒæ—¶ç­‰å¾… timer å’Œ I/O ä¸¤ç§äº‹ä»¶çš„å‘ç”Ÿã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä¾èµ–ç³»ç»Ÿåº•å±‚çš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶(I/O multiplexing)ã€‚è¿™ç§æœºåˆ¶ä¸€èˆ¬æ˜¯è¿™æ ·è®¾è®¡çš„ï¼šå®ƒå…è®¸æˆ‘ä»¬é’ˆå¯¹å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦æ¥ç­‰å¾…å¯¹åº”çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œå¹¶åŒæ—¶å¯ä»¥æŒ‡å®šä¸€ä¸ªæœ€é•¿çš„é˜»å¡è¶…æ—¶æ—¶é—´ã€‚å¦‚æœåœ¨è¿™æ®µé˜»å¡æ—¶é—´å†…ï¼Œæœ‰ I/O äº‹ä»¶å‘ç”Ÿï¼Œé‚£ä¹ˆç¨‹åºä¼šè¢«å”¤é†’ç»§ç»­æ‰§è¡Œï¼›å¦‚æœä¸€ç›´æ²¡æœ‰ I/O äº‹ä»¶å‘ç”Ÿï¼Œè€Œæ˜¯æŒ‡å®šçš„æ—¶é—´å…ˆè¶…æ—¶äº†ï¼Œé‚£ä¹ˆç¨‹åºä¹Ÿä¼šè¢«å”¤é†’ã€‚å¯¹äº timer äº‹ä»¶çš„ç­‰å¾…ï¼Œå°±æ˜¯ä¾é è¿™é‡Œçš„è¶…æ—¶æœºåˆ¶ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„è¶…æ—¶æ—¶é—´ä¹Ÿå¯ä»¥æŒ‡å®šæˆæ— é™é•¿ï¼Œè¿™å°±ç›¸å½“äºåªç­‰å¾… I/O äº‹ä»¶ã€‚æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ä¸Šä¸€æ­¥æŸ¥æ‰¾æœ€è¿‘çš„ timer äº‹ä»¶ï¼ŒæŸ¥æ‰¾å®Œä¹‹åå¯èƒ½æœ‰ä¸‰ç§ç»“æœï¼Œå› æ­¤è¿™ä¸€æ­¥ç­‰å¾…ä¹Ÿå¯èƒ½å‡ºç°ä¸‰ç§å¯¹åº”çš„æƒ…å†µï¼š ç¬¬ä¸€ç§æƒ…å†µï¼ŒæŸ¥æ‰¾åˆ°äº†ä¸€ä¸ªæœ€è¿‘çš„ timer äº‹ä»¶ï¼Œå®ƒè¦æ±‚åœ¨æœªæ¥æŸä¸€ä¸ªæ—¶åˆ»è§¦å‘ã€‚é‚£ä¹ˆï¼Œè¿™ä¸€æ­¥åªéœ€è¦æŠŠè¿™ä¸ªæœªæ¥æ—¶åˆ»è½¬æ¢æˆé˜»å¡è¶…æ—¶æ—¶é—´å³å¯ã€‚ ç¬¬äºŒç§æƒ…å†µï¼ŒæŸ¥æ‰¾åˆ°äº†ä¸€ä¸ªæœ€è¿‘çš„ timer äº‹ä»¶ï¼Œä½†å®ƒè¦æ±‚çš„æ—¶åˆ»å·²ç»è¿‡å»äº†ã€‚é‚£ä¹ˆï¼Œè¿™æ—¶å€™å®ƒåº”è¯¥ç«‹åˆ»è¢«è§¦å‘ï¼Œè€Œä¸åº”è¯¥å†æœ‰ä»»ä½•ç­‰å¾…ã€‚å½“ç„¶ï¼Œåœ¨å®ç°çš„æ—¶å€™è¿˜æ˜¯è°ƒç”¨äº†äº‹ä»¶ç­‰å¾…çš„ APIï¼Œåªæ˜¯æŠŠè¶…æ—¶äº‹ä»¶è®¾ç½®æˆ 0 å°±å¯ä»¥è¾¾åˆ°è¿™ä¸ªæ•ˆæœã€‚ ç¬¬ä¸‰ç§æƒ…å†µï¼Œæ²¡æœ‰æŸ¥æ‰¾åˆ°ä»»ä½•æ³¨å†Œçš„ timer äº‹ä»¶ã€‚é‚£ä¹ˆï¼Œè¿™æ—¶å€™åº”è¯¥æŠŠè¶…æ—¶æ—¶é—´è®¾ç½®æˆæ— é™é•¿ã€‚æ¥ä¸‹æ¥åªæœ‰ I/O äº‹ä»¶å‘ç”Ÿæ‰èƒ½å”¤é†’ã€‚ åˆ¤æ–­æœ‰ I/O äº‹ä»¶å‘ç”Ÿè¿˜æ˜¯è¶…æ—¶ã€‚è¿™é‡Œæ˜¯ç¨‹åºä»ä¸Šä¸€æ­¥ï¼ˆå¯èƒ½çš„ï¼‰é˜»å¡çŠ¶æ€ä¸­æ¢å¤åæ‰§è¡Œçš„åˆ¤æ–­é€»è¾‘ã€‚å¦‚æœæ˜¯ I/O äº‹ä»¶å‘ç”Ÿäº†ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œ I/O äº‹ä»¶å›è°ƒï¼Œç„¶åæ ¹æ®éœ€è¦æŠŠåˆ°æœŸçš„ timer äº‹ä»¶çš„å›è°ƒä¹Ÿæ‰§è¡Œæ‰ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼›å¦‚æœæ˜¯è¶…æ—¶å…ˆå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆè¡¨ç¤ºåªæœ‰ timer äº‹ä»¶éœ€è¦è§¦å‘ï¼ˆæ²¡æœ‰ I/O äº‹ä»¶å‘ç”Ÿï¼‰ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠŠåˆ°æœŸçš„ timer äº‹ä»¶çš„å›è°ƒæ‰§è¡Œæ‰ã€‚ æ‰§è¡Œ I/O äº‹ä»¶å›è°ƒã€‚æˆ‘ä»¬å‰é¢æåˆ°çš„å¯¹äº TCP è¿æ¥çš„ç›‘å¬å’Œå¯¹äº Unix domain socket çš„ç›‘å¬ï¼Œè¿™ä¸¤ç§ I/O äº‹ä»¶çš„å›è°ƒå‡½æ•° acceptTcpHandler å’Œ acceptUnixHandlerï¼Œå°±æ˜¯åœ¨è¿™ä¸€æ­¥è¢«è°ƒç”¨çš„ã€‚ æ‰§è¡Œ timer äº‹ä»¶å›è°ƒã€‚æˆ‘ä»¬å‰é¢æåˆ°çš„å‘¨æœŸæ€§çš„å›è°ƒå‡½æ•° serverCronï¼Œå°±æ˜¯åœ¨è¿™ä¸€æ­¥è¢«è°ƒç”¨çš„ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ª timer äº‹ä»¶è¢«å¤„ç†åï¼Œå®ƒå°±ä¼šè¢«ä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œä¸ä¼šå†æ¬¡æ‰§è¡Œäº†ã€‚ä½† serverCron å´æ˜¯è¢«å‘¨æœŸæ€§è°ƒç”¨çš„ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º Redis å¯¹äº timer äº‹ä»¶å›è°ƒçš„å¤„ç†è®¾è®¡äº†ä¸€ä¸ªå°æœºåˆ¶ï¼štimer äº‹ä»¶çš„å›è°ƒå‡½æ•°å¯ä»¥è¿”å›ä¸€ä¸ªéœ€è¦ä¸‹æ¬¡æ‰§è¡Œçš„æ¯«ç§’æ•°ã€‚å¦‚æœè¿”å›å€¼æ˜¯æ­£å¸¸çš„æ­£å€¼ï¼Œé‚£ä¹ˆ Redis å°±ä¸ä¼šæŠŠè¿™ä¸ª timer äº‹ä»¶ä»äº‹ä»¶å¾ªç¯çš„é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œè¿™æ ·å®ƒåé¢è¿˜æœ‰æœºä¼šå†æ¬¡æ‰§è¡Œã€‚ä¾‹å¦‚ï¼ŒæŒ‰ç…§é»˜è®¤çš„è®¾ç½®ï¼ŒserverCron è¿”å›å€¼æ˜¯ 100ï¼Œå› æ­¤å®ƒæ¯éš” 100 æ¯«ç§’ä¼šæ‰§è¡Œä¸€æ¬¡ï¼ˆå½“ç„¶è¿™ä¸ªæ‰§è¡Œé¢‘ç‡å¯ä»¥åœ¨ redis.conf ä¸­é€šè¿‡ hz å˜é‡æ¥è°ƒæ•´ï¼‰ã€‚ è‡³æ­¤ï¼ŒRedis æ•´ä¸ªäº‹ä»¶å¾ªç¯çš„è½®å»“æˆ‘ä»¬å°±æ¸…æ¥šäº†ã€‚Redis ä¸»è¦çš„å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬æ¥æ”¶è¯·æ±‚ã€æ‰§è¡Œå‘½ä»¤ï¼Œä»¥åŠå‘¨æœŸæ€§åœ°æ‰§è¡Œåå°ä»»åŠ¡ï¼ˆserverCronï¼‰ï¼Œéƒ½æ˜¯ç”±è¿™ä¸ªäº‹ä»¶å¾ªç¯é©±åŠ¨çš„ã€‚å½“è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒI/O äº‹ä»¶è¢«è§¦å‘ï¼Œäº‹ä»¶å¾ªç¯è¢«å”¤é†’ï¼Œæ ¹æ®è¯·æ±‚æ‰§è¡Œå‘½ä»¤å¹¶è¿”å›å“åº”ç»“æœï¼›åŒæ—¶ï¼Œåå°å¼‚æ­¥ä»»åŠ¡ï¼ˆå¦‚å›æ”¶è¿‡æœŸçš„ keyï¼‰è¢«æ‹†åˆ†æˆè‹¥å¹²å°æ®µï¼Œç”± timer äº‹ä»¶æ‰€è§¦å‘ï¼Œå¤¹æ‚åœ¨ I/O äº‹ä»¶å¤„ç†çš„é—´éš™æ¥å‘¨æœŸæ€§åœ°è¿è¡Œã€‚è¿™ç§æ‰§è¡Œæ–¹å¼å…è®¸ä»…ä»…ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤§é‡çš„è¯·æ±‚ï¼Œå¹¶èƒ½æä¾›å¿«é€Ÿçš„å“åº”æ—¶é—´ã€‚å½“ç„¶ï¼Œè¿™ç§å®ç°æ–¹å¼ä¹‹æ‰€ä»¥èƒ½å¤Ÿé«˜æ•ˆè¿è½¬ï¼Œé™¤äº†äº‹ä»¶å¾ªç¯çš„ç»“æ„ä¹‹å¤–ï¼Œè¿˜å¾—ç›Šäºç³»ç»Ÿæä¾›çš„å¼‚æ­¥çš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶(I/O multiplexing)ã€‚äº‹ä»¶å¾ªç¯ä½¿å¾— CPU èµ„æºè¢«åˆ†æ—¶å¤ç”¨äº†ï¼Œä¸åŒä»£ç å—ä¹‹é—´å¹¶æ²¡æœ‰ã€ŒçœŸæ­£çš„ã€å¹¶å‘æ‰§è¡Œï¼Œä½† I/O å¤šè·¯å¤ç”¨æœºåˆ¶ä½¿å¾— CPU å’Œ I/O çš„æ‰§è¡Œæ˜¯çœŸæ­£å¹¶å‘çš„ã€‚è€Œä¸”ï¼Œä½¿ç”¨å•çº¿ç¨‹è¿˜æœ‰é¢å¤–çš„å¥½å¤„ï¼šé¿å…äº†ä»£ç çš„å¹¶å‘æ‰§è¡Œï¼Œåœ¨è®¿é—®å„ç§æ•°æ®ç»“æ„çš„æ—¶å€™éƒ½æ— éœ€è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä»è€Œå¤§å¤§é™ä½äº†å®ç°çš„å¤æ‚åº¦ã€‚ Redis å‘½ä»¤è¯·æ±‚çš„å¤„ç†æµç¨‹æ¦‚è¿°æˆ‘ä»¬åœ¨å‰é¢è®¨è®ºã€Œæ³¨å†Œ I/O äº‹ä»¶å›è°ƒã€çš„æ—¶å€™æåˆ°è¿‡ï¼ŒRedis å¯¹äºæ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚çš„å¤„ç†ï¼Œéƒ½ä¼šèµ°åˆ° acceptTcpHandler æˆ– acceptUnixHandler è¿™ä¸¤ä¸ªå›è°ƒå‡½æ•°ä¸­å»ã€‚å®é™…ä¸Šï¼Œè¿™æ ·æè¿°è¿˜è¿‡äºç²—ç•¥ã€‚ Redis å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå…¶å®å¯ä»¥ç»†åˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹ï¼š è¿æ¥å»ºç«‹ã€‚å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼ˆé€šè¿‡ TCP æˆ– Unix domain socketï¼‰ï¼ŒæœåŠ¡å™¨æ¥å—è¿æ¥ã€‚ å‘½ä»¤å‘é€ã€æ‰§è¡Œå’Œå“åº”ã€‚è¿æ¥ä¸€æ—¦å»ºç«‹å¥½ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥åœ¨è¿™ä¸ªæ–°å»ºç«‹çš„è¿æ¥ä¸Šå‘é€å‘½ä»¤æ•°æ®ï¼ŒæœåŠ¡å™¨æ”¶åˆ°åæ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œå¹¶æŠŠæ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚è€Œä¸”ï¼Œåœ¨æ–°å»ºç«‹çš„è¿æ¥ä¸Šï¼Œè¿™æ•´ä¸ªçš„ã€Œå‘½ä»¤å‘é€ã€æ‰§è¡Œå’Œå“åº”ã€çš„è¿‡ç¨‹å°±å¯ä»¥åå¤æ‰§è¡Œã€‚ä¸Šè¿°ç¬¬ä¸€ä¸ªè¿‡ç¨‹ï¼Œã€Œè¿æ¥å»ºç«‹ã€ï¼Œå¯¹åº”åˆ°æœåŠ¡ç«¯çš„ä»£ç ï¼Œå°±æ˜¯ä¼šèµ°åˆ° acceptTcpHandler æˆ– acceptUnixHandler è¿™ä¸¤ä¸ªå›è°ƒå‡½æ•°ä¸­å»ã€‚æ¢å¥è¯è¯´ï¼ŒRedis æœåŠ¡å™¨æ¯æ”¶åˆ°ä¸€ä¸ªæ–°çš„è¿æ¥è¯·æ±‚ï¼Œå°±ä¼šç”±äº‹ä»¶å¾ªç¯è§¦å‘ä¸€ä¸ª I/O äº‹ä»¶ï¼Œä»è€Œæ‰§è¡Œåˆ° acceptTcpHandler æˆ– acceptUnixHandler å›è°ƒå‡½æ•°çš„ä»£ç ã€‚ æ¥ä¸‹æ¥ï¼Œä» socket ç¼–ç¨‹çš„è§’åº¦ï¼ŒæœåŠ¡å™¨åº”è¯¥è°ƒç”¨ accept ç³»ç»Ÿ API[7]æ¥æ¥å—è¿æ¥è¯·æ±‚ï¼Œå¹¶ä¸ºæ–°çš„è¿æ¥åˆ›å»ºå‡ºä¸€ä¸ª socketã€‚è¿™ä¸ªæ–°çš„ socket ä¹Ÿå°±å¯¹åº”ç€ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ä¸ºäº†åœ¨æ–°çš„è¿æ¥ä¸Šèƒ½æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„å‘½ä»¤ï¼Œæ¥ä¸‹æ¥å¿…é¡»åœ¨äº‹ä»¶å¾ªç¯ä¸­ä¸ºè¿™ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦æ³¨å†Œä¸€ä¸ª I/O äº‹ä»¶å›è°ƒã€‚è¿™ä¸ªè¿‡ç¨‹çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š ä»ä¸Šé¢æµç¨‹å›¾å¯ä»¥çœ‹å‡ºï¼Œæ–°çš„è¿æ¥æ³¨å†Œäº†ä¸€ä¸ª I/O äº‹ä»¶å›è°ƒï¼Œå³ readQueryFromClientã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹åº”å‰é¢è®²çš„ç¬¬äºŒä¸ªè¿‡ç¨‹ï¼Œã€Œå‘½ä»¤å‘é€ã€æ‰§è¡Œå’Œå“åº”ã€ï¼Œå½“æœåŠ¡å™¨æ”¶åˆ°å‘½ä»¤æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¼šç”±äº‹ä»¶å¾ªç¯è§¦å‘ä¸€ä¸ª I/O äº‹ä»¶ï¼Œæ‰§è¡Œåˆ° readQueryFromClient å›è°ƒã€‚è¿™ä¸ªå‡½æ•°çš„å®ç°å°±æ˜¯åœ¨å¤„ç†å‘½ä»¤çš„ã€Œæ‰§è¡Œå’Œå“åº”ã€äº†ã€‚å› æ­¤ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹å›¾ï¼š ä¸Šè¿°æµç¨‹å›¾æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š ä» socket ä¸­è¯»å…¥æ•°æ®ï¼Œæ˜¯æŒ‰ç…§æµçš„æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç«™åœ¨åº”ç”¨å±‚çš„è§’åº¦ï¼Œä»åº•å±‚ç½‘ç»œå±‚è¯»å…¥çš„æ•°æ®ï¼Œæ˜¯ç”±ä¸€ä¸ªä¸ªå­—èŠ‚ç»„æˆçš„å­—èŠ‚æµã€‚è€Œæˆ‘ä»¬éœ€è¦ä»è¿™äº›å­—èŠ‚æµä¸­è§£æå‡ºå®Œæ•´çš„ Redis å‘½ä»¤ï¼Œæ‰èƒ½çŸ¥é“æ¥ä¸‹æ¥å¦‚ä½•å¤„ç†ã€‚ä½†ç”±äºç½‘ç»œä¼ è¾“çš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½æ§åˆ¶ä¸€æ¬¡è¯»å…¥å¤šå°‘ä¸ªå­—èŠ‚ã€‚å®é™…ä¸Šï¼Œå³ä½¿æœåŠ¡å™¨åªæ˜¯æ”¶åˆ°ä¸€ä¸ª Redis å‘½ä»¤çš„éƒ¨åˆ†æ•°æ®ï¼ˆå“ªæ€•åªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼‰ï¼Œä¹Ÿæœ‰å¯èƒ½è§¦å‘ä¸€æ¬¡ I/O äº‹ä»¶å›è°ƒã€‚è¿™æ—¶æˆ‘ä»¬æ˜¯è°ƒç”¨ read ç³»ç»Ÿ API[8]æ¥è¯»å…¥æ•°æ®çš„ã€‚è™½ç„¶è°ƒç”¨ read æ—¶æˆ‘ä»¬å¯ä»¥æŒ‡å®šæœŸæœ›è¯»å–çš„å­—èŠ‚æ•°ï¼Œä½†å®ƒå¹¶ä¸ä¼šä¿è¯ä¸€å®šèƒ½è¿”å›æœŸæœ›é•¿åº¦çš„æ•°æ®ã€‚æ¯”å¦‚æˆ‘ä»¬æƒ³è¯» 100 ä¸ªå­—èŠ‚ï¼Œä½†å¯èƒ½åªèƒ½è¯»åˆ° 80 ä¸ªå­—èŠ‚ï¼Œå‰©ä¸‹çš„ 20 ä¸ªå­—èŠ‚å¯èƒ½è¿˜åœ¨ç½‘ç»œä¼ è¾“ä¸­æ²¡æœ‰åˆ°è¾¾ã€‚è¿™ç§æƒ…å†µç»™æ¥æ”¶ Redis å‘½ä»¤çš„è¿‡ç¨‹é€ æˆäº†å¾ˆå¤§çš„éº»çƒ¦ï¼šé¦–å…ˆï¼Œå¯èƒ½æˆ‘ä»¬è¯»åˆ°çš„æ•°æ®è¿˜ä¸å¤Ÿä¸€ä¸ªå®Œæ•´çš„å‘½ä»¤ï¼Œè¿™æ—¶æˆ‘ä»¬åº”è¯¥ç»§ç»­ç­‰å¾…æ›´å¤šçš„æ•°æ®åˆ°è¾¾ã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬å¯èƒ½ä¸€æ¬¡æ€§æ”¶åˆ°äº†å¤§é‡çš„æ•°æ®ï¼Œé‡Œé¢åŒ…å«ä¸æ­¢ä¸€ä¸ªå‘½ä»¤ï¼Œè¿™æ—¶æˆ‘ä»¬å¿…é¡»æŠŠé‡Œé¢åŒ…å«çš„æ‰€æœ‰å‘½ä»¤éƒ½è§£æå‡ºæ¥ï¼Œè€Œä¸”è¦æ­£ç¡®è§£æåˆ°æœ€åä¸€ä¸ªå®Œæ•´å‘½ä»¤çš„è¾¹ç•Œã€‚å¦‚æœæœ€åä¸€ä¸ªå®Œæ•´å‘½ä»¤åé¢è¿˜æœ‰å¤šä½™çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®åº”è¯¥ç•™åœ¨ä¸‹æ¬¡æœ‰æ›´å¤šæ•°æ®åˆ°è¾¾æ—¶å†å¤„ç†ã€‚è¿™ä¸ªå¤æ‚çš„è¿‡ç¨‹ä¸€èˆ¬ç§°ä¸ºã€Œç²˜åŒ…ã€ã€‚ ã€Œç²˜åŒ…ã€å¤„ç†çš„ç¬¬ä¸€ä¸ªè¡¨ç°ï¼Œå°±æ˜¯å½“å°è¯•è§£æå‡ºä¸€ä¸ªå®Œæ•´çš„å‘½ä»¤æ—¶ï¼Œå¦‚æœè§£æå¤±è´¥äº†ï¼Œé‚£ä¹ˆä¸Šé¢çš„æµç¨‹å°±ç›´æ¥é€€å‡ºäº†ã€‚æ¥ä¸‹æ¥ï¼Œå¦‚æœæœ‰æ›´å¤šæ•°æ®åˆ°è¾¾ï¼Œäº‹ä»¶å¾ªç¯ä¼šå†æ¬¡è§¦å‘ I/O äº‹ä»¶å›è°ƒï¼Œé‡æ–°è¿›å…¥ä¸Šé¢çš„æµç¨‹ç»§ç»­å¤„ç†ã€‚ ã€Œç²˜åŒ…ã€å¤„ç†çš„ç¬¬äºŒä¸ªè¡¨ç°ï¼Œæ˜¯ä¸Šé¢æµç¨‹å›¾ä¸­çš„å¤§å¾ªç¯ã€‚åªè¦æš‚å­˜è¾“å…¥æ•°æ®çš„ query buffer ä¸­è¿˜æœ‰æ•°æ®å¯ä»¥å¤„ç†ï¼Œé‚£ä¹ˆå°±ä¸åœåœ°å»å°è¯•è§£æå®Œæ•´å‘½ä»¤ï¼Œç›´åˆ°æŠŠé‡Œé¢æ‰€æœ‰çš„å®Œæ•´å‘½ä»¤éƒ½å¤„ç†å®Œï¼Œæ‰é€€å‡ºå¾ªç¯ã€‚ æŸ¥å‘½ä»¤è¡¨é‚£ä¸€æ­¥ï¼Œå°±æ˜¯æŸ¥æ‰¾æœ¬æ–‡å‰é¢æåˆ°çš„ç”± populateCommandTable åˆå§‹åŒ–çš„å‘½ä»¤è¡¨ï¼Œè¿™ä¸ªå‘½ä»¤è¡¨å­˜å‚¨åœ¨ server.c çš„å…¨å±€å˜é‡ redisCommandTable å½“ä¸­ã€‚å‘½ä»¤è¡¨ä¸­å­˜æœ‰å„ä¸ª Redis å‘½ä»¤çš„æ‰§è¡Œå…¥å£ã€‚ å¯¹äºå‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œåœ¨ä¸Šé¢çš„æµç¨‹å›¾ä¸­åªæ˜¯æœ€åå­˜åˆ°äº†ä¸€ä¸ªè¾“å‡º buffer ä¸­ï¼Œå¹¶æ²¡æœ‰çœŸæ­£è¾“å‡ºç»™å®¢æˆ·ç«¯ã€‚è¾“å‡ºç»™å®¢æˆ·ç«¯çš„è¿‡ç¨‹ä¸åœ¨è¿™ä¸ªæµç¨‹å½“ä¸­ï¼Œè€Œæ˜¯ç”±å¦å¤–ä¸€ä¸ªåŒæ ·æ˜¯ç”±äº‹ä»¶å¾ªç¯é©±åŠ¨çš„è¿‡ç¨‹æ¥å®Œæˆã€‚è¿™ä¸ªè¿‡ç¨‹æ¶‰åŠå¾ˆå¤šç»†èŠ‚ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå…ˆç•¥è¿‡ï¼Œç•™åœ¨åé¢ç¬¬å››éƒ¨åˆ†å†æ¥è®¨è®ºã€‚ äº‹ä»¶æœºåˆ¶ä»‹ç»åœ¨æœ¬æ–‡ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬æåˆ°è¿‡ï¼Œæˆ‘ä»¬å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶èƒ½å¤ŸåŒæ—¶ç­‰å¾… I/O å’Œ timer è¿™ä¸¤ç§äº‹ä»¶çš„å‘ç”Ÿã€‚è¿™ä¸€æœºåˆ¶å°±æ˜¯ç³»ç»Ÿåº•å±‚çš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶(I/O multiplexing)ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šï¼Œå­˜åœ¨å¤šç§ä¸åŒçš„ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ã€‚å› æ­¤ï¼Œä¸ºäº†æ–¹ä¾¿ä¸Šå±‚ç¨‹åºå®ç°ï¼ŒRedis å®ç°äº†ä¸€ä¸ªç®€å•çš„äº‹ä»¶é©±åŠ¨ç¨‹åºåº“ï¼Œå³ ae.c çš„ä»£ç ï¼Œå®ƒå±è”½äº†ç³»ç»Ÿåº•å±‚åœ¨äº‹ä»¶å¤„ç†ä¸Šçš„å·®å¼‚ï¼Œå¹¶å®ç°äº†æˆ‘ä»¬å‰é¢ä¸€ç›´åœ¨è®¨è®ºçš„äº‹ä»¶å¾ªç¯ã€‚ åœ¨ Redis çš„äº‹ä»¶åº“çš„å®ç°ä¸­ï¼Œç›®å‰å®ƒåº•å±‚æ”¯æŒ 4 ç§ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼š select ç³»ç»Ÿè°ƒç”¨[9]ã€‚è¿™åº”è¯¥æ˜¯æœ€æ—©å‡ºç°çš„ä¸€ç§ I/O å¤šè·¯å¤ç”¨æœºåˆ¶äº†ï¼Œäº 1983 å¹´åœ¨ 4.2BSD Unix ä¸­è¢«é¦–æ¬¡ä½¿ç”¨[10]ã€‚å®ƒæ˜¯ POSIX è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚å¦å¤–ï¼Œè·Ÿ select ç±»ä¼¼çš„è¿˜æœ‰ä¸€ä¸ª poll ç³»ç»Ÿè°ƒç”¨[11]ï¼Œå®ƒæ˜¯ 1986 å¹´åœ¨ SVR3 Unix ç³»ç»Ÿä¸­é¦–æ¬¡ä½¿ç”¨çš„[10]ï¼Œä¹Ÿéµå¾ª POSIX è§„èŒƒã€‚åªè¦æ˜¯éµå¾ª POSIX è§„èŒƒçš„æ“ä½œç³»ç»Ÿï¼Œå®ƒå°±èƒ½æ”¯æŒ select å’Œ poll æœºåˆ¶ï¼Œå› æ­¤åœ¨ç›®å‰æˆ‘ä»¬å¸¸è§çš„ç³»ç»Ÿä¸­è¿™ä¸¤ç§ I/O äº‹ä»¶æœºåˆ¶ä¸€èˆ¬éƒ½æ˜¯æ”¯æŒçš„ã€‚ epoll æœºåˆ¶[1]ã€‚epoll æ˜¯æ¯” select æ›´æ–°çš„ä¸€ç§ I/O å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œæœ€æ—©å‡ºç°åœ¨ Linux å†…æ ¸çš„ 2.5.44 ç‰ˆæœ¬ä¸­[12]ã€‚å®ƒè¢«è®¾è®¡å‡ºæ¥æ˜¯ä¸ºäº†ä»£æ›¿æ—§çš„ select å’Œ pollï¼Œæä¾›ä¸€ç§æ›´é«˜æ•ˆçš„ I/O æœºåˆ¶ã€‚æ³¨æ„ï¼Œepoll æ˜¯ Linux ç³»ç»Ÿæ‰€ç‰¹æœ‰çš„ï¼Œå®ƒä¸å±äº POSIX è§„èŒƒã€‚ kqueue æœºåˆ¶[13]ã€‚kqueue æœ€æ—©æ˜¯ 2000 å¹´åœ¨ FreeBSD 4.1 ä¸Šè¢«è®¾è®¡å‡ºæ¥çš„ï¼Œåæ¥ä¹Ÿæ”¯æŒ NetBSDã€OpenBSDã€DragonflyBSD å’Œ macOS ç³»ç»Ÿ[14]ã€‚å®ƒå’Œ Linux ç³»ç»Ÿä¸Šçš„ epoll æ˜¯ç±»ä¼¼çš„ã€‚ event portsã€‚è¿™æ˜¯åœ¨ illumos ç³»ç»Ÿ[15]ä¸Šç‰¹æœ‰çš„ä¸€ç§ I/O äº‹ä»¶æœºåˆ¶ã€‚æ—¢ç„¶åœ¨ä¸åŒç³»ç»Ÿä¸Šæœ‰ä¸åŒçš„äº‹ä»¶æœºåˆ¶ï¼Œé‚£ä¹ˆ Redis åœ¨ä¸åŒç³»ç»Ÿä¸Šç¼–è¯‘æ—¶é‡‡ç”¨çš„æ˜¯å“ªä¸ªæœºåˆ¶å‘¢ï¼Ÿç”±äºåœ¨ä¸Šé¢å››ç§æœºåˆ¶ä¸­ï¼Œåä¸‰ç§æ˜¯æ›´ç°ä»£ï¼Œä¹Ÿæ˜¯æ¯” select å’Œ poll æ›´é«˜æ•ˆçš„æ–¹æ¡ˆï¼Œå› æ­¤ Redis ä¼˜å…ˆé€‰æ‹©ä½¿ç”¨åä¸‰ç§æœºåˆ¶ã€‚ é€šè¿‡ä¸Šé¢å¯¹å„ç§ I/O æœºåˆ¶æ‰€é€‚ç”¨çš„æ“ä½œç³»ç»Ÿçš„æ€»ç»“ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºï¼Œå¦‚æœä½ åœ¨ macOS ä¸Šç¼–è¯‘ Redisï¼Œé‚£ä¹ˆå®ƒåº•å±‚ä¼šé€‰ç”¨ kqueueï¼›è€Œå¦‚æœåœ¨ Linux ä¸Šç¼–è¯‘åˆ™ä¼šé€‰æ‹© epollï¼Œè¿™ä¹Ÿæ˜¯ Redis åœ¨å®é™…è¿è¡Œä¸­æ¯”è¾ƒå¸¸è§çš„æƒ…å†µã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ‰€ä¾èµ–çš„ I/O äº‹ä»¶æœºåˆ¶ï¼Œä¸å¦‚ä½•å®ç°é«˜å¹¶å‘çš„ç½‘ç»œæœåŠ¡å…³ç³»å¯†åˆ‡ã€‚å¾ˆå¤šæŠ€æœ¯åŒå­¦åº”è¯¥éƒ½å¬è¯´è¿‡ C10K é—®é¢˜[16]ã€‚éšç€ç¡¬ä»¶å’Œç½‘ç»œçš„å‘å±•ï¼Œå•æœºæ”¯æ’‘ 10000 ä¸ªè¿æ¥ï¼Œç”šè‡³å•æœºæ”¯æ’‘ç™¾ä¸‡ä¸ªè¿æ¥ï¼Œéƒ½æˆä¸ºå¯èƒ½[17]ã€‚é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹ä¸è¿™äº›åº•å±‚æœºåˆ¶æ¯æ¯ç›¸å…³ã€‚è¿™é‡Œæ¨èå‡ ç¯‡ blogï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥å»ä»”ç»†é˜…è¯»ï¼ˆè®¿é—®é“¾æ¥è¯·å‚è§æ–‡æœ«å‚è€ƒæ–‡çŒ®ï¼‰ï¼š The C10K problem[16]ï¼› Epoll is fundamentally broken[18]ï¼› The Implementation of epoll[19]ï¼› ç°åœ¨æˆ‘ä»¬å›è¿‡å¤´æ¥å†çœ‹ä¸€ä¸‹åº•å±‚çš„è¿™äº› I/O äº‹ä»¶æœºåˆ¶æ˜¯å¦‚ä½•æ”¯æŒäº† Redis çš„äº‹ä»¶å¾ªç¯çš„ï¼ˆä¸‹é¢çš„æè¿°æ˜¯å¯¹æœ¬æ–‡å‰é¢ç¬¬ä¸€éƒ¨åˆ†ä¸­äº‹ä»¶å¾ªç¯æµç¨‹çš„ç»†åŒ–ï¼‰ï¼š é¦–å…ˆï¼Œå‘äº‹ä»¶å¾ªç¯ä¸­æ³¨å†Œ I/O äº‹ä»¶å›è°ƒçš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šå“ªä¸ªå›è°ƒå‡½æ•°æ³¨å†Œåˆ°å“ªä¸ªäº‹ä»¶ä¸Šï¼ˆäº‹ä»¶ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥è¡¨ç¤ºï¼‰ã€‚äº‹ä»¶å’Œå›è°ƒå‡½æ•°çš„å¯¹åº”å…³ç³»ï¼Œç”± Redis ä¸Šå±‚å°è£…çš„äº‹ä»¶é©±åŠ¨ç¨‹åºåº“æ¥ç»´æŠ¤ã€‚å…·ä½“å‚è§å‡½æ•° aeCreateFileEvent çš„ä»£ç ã€‚ ç±»ä¼¼åœ°ï¼Œå‘äº‹ä»¶å¾ªç¯ä¸­æ³¨å†Œ timer äº‹ä»¶å›è°ƒçš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šå¤šé•¿æ—¶é—´ä¹‹åæ‰§è¡Œå“ªä¸ªå›è°ƒå‡½æ•°ã€‚è¿™é‡Œéœ€è¦è®°å½•å“ªä¸ªå›è°ƒå‡½æ•°é¢„æœŸåœ¨å“ªä¸ªæ—¶åˆ»è¢«è°ƒç”¨ï¼Œè¿™ä¹Ÿæ˜¯ç”± Redis ä¸Šå±‚å°è£…çš„äº‹ä»¶é©±åŠ¨ç¨‹åºåº“æ¥ç»´æŠ¤çš„ã€‚å…·ä½“å‚è§å‡½æ•° aeCreateTimeEvent çš„ä»£ç ã€‚ åº•å±‚çš„å„ç§äº‹ä»¶æœºåˆ¶éƒ½ä¼šæä¾›ä¸€ä¸ªç­‰å¾…äº‹ä»¶çš„æ“ä½œï¼Œæ¯”å¦‚ epoll æä¾›çš„ epoll_wait APIã€‚è¿™ä¸ªç­‰å¾…æ“ä½œä¸€èˆ¬å¯ä»¥æŒ‡å®šé¢„æœŸç­‰å¾…çš„äº‹ä»¶åˆ—è¡¨ï¼ˆäº‹ä»¶ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥è¡¨ç¤ºï¼‰ï¼Œå¹¶åŒæ—¶å¯ä»¥æŒ‡å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼ˆå³æœ€å¤§ç­‰å¾…å¤šé•¿æ—¶é—´ï¼‰ã€‚åœ¨äº‹ä»¶å¾ªç¯ä¸­éœ€è¦ç­‰å¾…äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œå°±è°ƒç”¨è¿™ä¸ªç­‰å¾…æ“ä½œï¼Œä¼ å…¥ä¹‹å‰æ³¨å†Œè¿‡çš„æ‰€æœ‰ I/O äº‹ä»¶ï¼Œå¹¶æŠŠæœ€è¿‘çš„ timer äº‹ä»¶æ‰€å¯¹åº”çš„æ—¶åˆ»è½¬æ¢æˆè¿™é‡Œéœ€è¦çš„è¶…æ—¶æ—¶é—´ã€‚å…·ä½“å‚è§å‡½æ•° aeProcessEvents çš„ä»£ç ã€‚ ä»ä¸Šä¸€æ­¥çš„ç­‰å¾…æ“ä½œä¸­å”¤é†’ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼šå¦‚æœæ˜¯ I/O äº‹ä»¶å‘ç”Ÿäº†ï¼Œé‚£ä¹ˆå°±æ ¹æ®è§¦å‘çš„äº‹ä»¶æŸ¥åˆ° I/O å›è°ƒå‡½æ•°ï¼Œè¿›è¡Œè°ƒç”¨ï¼›å¦‚æœæ˜¯è¶…æ—¶äº†ï¼Œé‚£ä¹ˆæ£€æŸ¥æ‰€æœ‰æ³¨å†Œè¿‡çš„ timer äº‹ä»¶ï¼Œå¯¹äºé¢„æœŸè°ƒç”¨æ—¶åˆ»è¶…è¿‡å½“å‰æ—¶é—´çš„å›è°ƒå‡½æ•°éƒ½è¿›è¡Œè°ƒç”¨ã€‚ æœ€åï¼Œå…³äºäº‹ä»¶æœºåˆ¶ï¼Œè¿˜æœ‰ä¸€äº›ä¿¡æ¯å€¼å¾—å…³æ³¨ï¼šä¸šç•Œå·²ç»æœ‰ä¸€äº›æ¯”è¾ƒæˆç†Ÿçš„å¼€æºçš„äº‹ä»¶åº“äº†ï¼Œå…¸å‹çš„æ¯”å¦‚ libevent[20]å’Œ libev[21]ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›å¼€æºåº“å±è”½äº†éå¸¸å¤æ‚çš„åº•å±‚ç³»ç»Ÿç»†èŠ‚ï¼Œå¹¶å¯¹ä¸åŒçš„ç³»ç»Ÿç‰ˆæœ¬å®ç°åšäº†å…¼å®¹ï¼Œæ˜¯éå¸¸æœ‰ä»·å€¼çš„ã€‚é‚£ä¸ºä»€ä¹ˆ Redis çš„ä½œè€…è¿˜æ˜¯è‡ªå·±å®ç°äº†ä¸€å¥—å‘¢ï¼Ÿåœ¨ Google Group çš„ä¸€ä¸ªå¸–å­ä¸Šï¼ŒRedis çš„ä½œè€…ç»™å‡ºäº†ä¸€äº›åŸå› ã€‚å¸–å­åœ°å€å¦‚ä¸‹ï¼š https://groups.google.com/group/redis-db/browse_thread/thread/b52814e9ef15b8d0/ åŸå› å¤§è‡´æ€»ç»“èµ·æ¥å°±æ˜¯ï¼š ä¸æƒ³å¼•å…¥å¤ªå¤§çš„å¤–éƒ¨ä¾èµ–ã€‚æ¯”å¦‚ libevent å¤ªå¤§äº†ï¼Œæ¯” Redis çš„ä»£ç åº“è¿˜å¤§ã€‚ æ–¹ä¾¿åšä¸€äº›å®šåˆ¶åŒ–çš„å¼€å‘ã€‚ ç¬¬ä¸‰æ–¹åº“æœ‰æ—¶å€™ä¼šå‡ºç°ä¸€äº›æ„æƒ³ä¸åˆ°çš„ bugã€‚ ä»£ç è°ƒç”¨å…³ç³»å¯¹äºæœ¬æ–‡å‰é¢åˆ†æçš„å„ä¸ªä»£ç å¤„ç†æµç¨‹ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ã€äº‹ä»¶å¾ªç¯ã€æ¥æ”¶å‘½ä»¤è¯·æ±‚ã€æ‰§è¡Œå‘½ä»¤ã€è¿”å›å“åº”ç»“æœç­‰ç­‰ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶æŸ¥é˜…ï¼Œä¸‹é¢ç”¨ä¸€ä¸ªæ ‘å‹å›¾å±•ç¤ºäº†éƒ¨åˆ†å…³é”®å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼ˆå›¾æ¯”è¾ƒå¤§ï¼Œç‚¹å‡»å¯ä»¥çœ‹å¤§å›¾ï¼‰ã€‚å†æ¬¡æé†’ï¼šä¸‹é¢çš„è°ƒç”¨å…³ç³»å›¾åŸºäº Redis æºç çš„ 5.0 åˆ†æ”¯ï¼Œæœªæ¥å¾ˆå¯èƒ½éšç€ Redis ä»£ç åº“çš„è¿­ä»£è€Œæœ‰æ‰€å˜åŒ–ã€‚ ä¸Šå›¾ä¸­æ·»åŠ äº†éƒ¨åˆ†æ³¨é‡Šï¼Œåº”è¯¥å¯ä»¥å¾ˆæ¸…æ¥šåœ°å’Œæœ¬æ–‡å‰é¢ä»‹ç»è¿‡çš„ä¸€äº›æµç¨‹å¯¹åº”ä¸Šã€‚å¦å¤–ï¼Œå›¾ä¸­ä¸€äº›å¯èƒ½éœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼Œå¦‚ä¸‹åˆ—å‡ºï¼š åˆå§‹åŒ–è¿‡ç¨‹å¢åŠ äº† aeSetBeforeSleepProc å’Œ aeSetAfterSleepProcï¼Œæ³¨å†Œäº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™åœ¨æœ¬æ–‡å‰é¢æ²¡æœ‰æåˆ°è¿‡ã€‚ä¸€ä¸ªç”¨äºåœ¨äº‹ä»¶å¾ªç¯æ¯è½®å¼€å§‹æ—¶è°ƒç”¨ï¼Œå¦ä¸€ä¸ªä¼šåœ¨æ¯è½®äº‹ä»¶å¾ªç¯çš„é˜»å¡ç­‰å¾…åï¼ˆå³ aeApiPoll è¿”å›åï¼‰è°ƒç”¨ã€‚å›¾ä¸­ä¸‹é¢ç¬¬ 5 ä¸ªè°ƒç”¨æµç¨‹çš„å…¥å£ beforeSleepï¼Œå°±æ˜¯ç”±è¿™é‡Œçš„ aeSetBeforeSleepProc æ¥æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸­çš„ã€‚ å‰æ–‡æåˆ°çš„ serverCron å‘¨æœŸæ€§åœ°æ‰§è¡Œï¼Œå°±æ˜¯æŒ‡çš„åœ¨processTimeEvents è¿™ä¸ªè°ƒç”¨åˆ†æ”¯ä¸­è°ƒç”¨çš„ timeProc è¿™ä¸ªå‡½æ•°ã€‚ åœ¨æ•°æ®æ¥æ”¶å¤„ç†çš„æµç¨‹ readQueryFromClient ä¸­ï¼Œé€šè¿‡ lookupCommand æ¥æŸ¥è¯¢ Redis å‘½ä»¤è¡¨ï¼Œè¿™ä¸ªå‘½ä»¤è¡¨ä¹Ÿå°±æ˜¯å‰é¢åˆå§‹åŒ–æ—¶ç”± populateCommandTable åˆå§‹åŒ–çš„ redisCommandTable å…¨å±€ç»“æ„ã€‚æŸ¥æ‰¾å‘½ä»¤å…¥å£åï¼Œè°ƒç”¨ server.c çš„ call å‡½æ•°æ¥æ‰§è¡Œå‘½ä»¤ã€‚å›¾ä¸­ call å‡½æ•°çš„ä¸‹ä¸€å±‚ï¼Œå°±æ˜¯è°ƒç”¨å„ä¸ªå‘½ä»¤çš„å…¥å£å‡½æ•°ï¼ˆå›¾ä¸­åªåˆ—å‡ºäº†å‡ ä¸ªä¾‹å­ï¼‰ã€‚ä»¥ get å‘½ä»¤çš„å…¥å£å‡½æ•° getCommand ä¸ºä¾‹ï¼Œå®ƒæ‰§è¡Œå®Œçš„æ‰§è¡Œç»“æœï¼Œæœ€ç»ˆä¼šè°ƒç”¨ addReply å­˜å…¥åˆ°è¾“å‡º buffer ä¸­ï¼Œå³ client ç»“æ„çš„ buf æˆ– reply å­—æ®µä¸­ï¼ˆæ ¹æ®æ‰§è¡Œç»“æœçš„å¤§å°ä¸åŒï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°±åƒå‰é¢ã€ŒRedis å‘½ä»¤è¯·æ±‚çš„å¤„ç†æµç¨‹ã€æœ€åè®¨è®ºçš„ä¸€æ ·ï¼Œè¿™é‡Œåªæ˜¯æŠŠæ‰§è¡Œç»“æœå­˜åˆ°äº†ä¸€ä¸ªè¾“å‡º buffer ä¸­ï¼Œå¹¶æ²¡æœ‰çœŸæ­£è¾“å‡ºç»™å®¢æˆ·ç«¯ã€‚çœŸæ­£æŠŠå“åº”ç»“æœå‘é€ç»™å®¢æˆ·ç«¯çš„æ‰§è¡Œé€»è¾‘ï¼Œåœ¨åé¢çš„ beforeSleep å’Œ sendReplyToClient æµç¨‹ä¸­ã€‚ æœ€åå°†å‘½ä»¤æ‰§è¡Œç»“æœå‘é€ç»™å®¢æˆ·ç«¯çš„è¿‡ç¨‹ï¼Œç”± beforeSleep æ¥è§¦å‘ã€‚å®ƒæ£€æŸ¥è¾“å‡º buffe ä¸­æœ‰æ²¡æœ‰éœ€è¦å‘é€ç»™å®¢æˆ·ç«¯çš„æ‰§è¡Œç»“æœæ•°æ®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œä¼šè°ƒç”¨ writeToClient å°è¯•è¿›è¡Œå‘é€ã€‚å¦‚æœä¸€æ¬¡æ€§æ²¡æœ‰æŠŠæ•°æ®å‘é€å®Œæ¯•ï¼Œé‚£ä¹ˆè¿˜éœ€è¦å†å‘äº‹ä»¶å¾ªç¯ä¸­æ³¨å†Œä¸€ä¸ªå†™ I/O äº‹ä»¶å›è°ƒ sendReplyToClientï¼Œåœ¨æ°å½“çš„æ—¶æœºå†æ¬¡è°ƒç”¨ writeToClient æ¥å°è¯•å‘é€ã€‚å¦‚æœè¿˜æ˜¯æœ‰å‰©ä½™æ•°æ®æ²¡æœ‰å‘é€å®Œæ¯•ï¼Œé‚£ä¹ˆåé¢ä¼šç”± beforeSleep å›è°ƒæ¥å†æ¬¡è§¦å‘è¿™ä¸ªæµç¨‹ã€‚ å¤–åŠ ä¸€äº›æˆ‘ä¸ªäººæ€»è®¡çš„ xmind çš„æ€ç»´å¯¼å›¾ï¼š å‚è€ƒæ–‡çŒ®ï¼š Redis æºç ä»å“ªé‡Œè¯»èµ· epoll âˆ’ I/O event notification facility Unix domain socket Inter-process communication POSIX.1-2017 Definitions for UNIX domain sockets Create descriptor pair for interprocess communication BSD System Calls Manual ACCEPT(2) BSD System Calls Manual READ(2) BSD System Calls Manual SELECT(2) poll vs select vs event-based BSD System Calls Manual POLL(2) Epoll from Wikipedia BSD System Calls Manual KQUEUE(2) Kqueue from Wikipedia illumos from Wikipedia The C10K problem C10k problem from Wikipedia Epoll is fundamentally broken The Implementation of epoll libevent libev","categories":[{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/categories/Redis/"}],"tags":[{"name":"Redisï¼Œæºç å‰–æ","slug":"Redisï¼Œæºç å‰–æ","permalink":"http://blog.crazylaw.cn/tags/Redis%EF%BC%8C%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"}]},{"title":"ã€æ•°æ®ç»“æ„ã€‘äºŒå‰æ ‘","slug":"æ•°æ®ç»“æ„/äºŒå‰æ ‘","date":"2019-07-09T07:20:00.000Z","updated":"2021-03-20T16:25:01.818Z","comments":true,"path":"2019/07/09/æ•°æ®ç»“æ„/äºŒå‰æ ‘/","link":"","permalink":"http://blog.crazylaw.cn/2019/07/09/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E4%BA%8C%E5%8F%89%E6%A0%91/","excerpt":"","text":"æ•°æ®ç»“æ„ä¸­æœ‰å¾ˆå¤šæ ‘çš„ç»“æ„ï¼Œå…¶ä¸­åŒ…æ‹¬äºŒå‰æ ‘ã€äºŒå‰æœç´¢æ ‘ã€2-3 æ ‘ã€çº¢é»‘æ ‘ç­‰ç­‰ã€‚æœ¬æ–‡ä¸­å¯¹æ•°æ®ç»“æ„ä¸­å¸¸è§çš„å‡ ç§æ ‘çš„æ¦‚å¿µå’Œç”¨é€”è¿›è¡Œäº†æ±‡æ€»ï¼Œä¸æ±‚ä¸¥æ ¼ç²¾å‡†ï¼Œä½†æ±‚ç®€å•æ˜“æ‡‚ã€‚ äºŒå‰æ ‘æ˜¯æ•°æ®ç»“æ„ä¸­ä¸€ç§é‡è¦çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿæ˜¯æ ‘è¡¨å®¶æ—æœ€ä¸ºåŸºç¡€çš„ç»“æ„ã€‚ äºŒå‰æ ‘çš„å®šä¹‰ï¼šäºŒå‰æ ‘çš„æ¯ä¸ªç»“ç‚¹è‡³å¤šåªæœ‰äºŒæ£µå­æ ‘(ä¸å­˜åœ¨åº¦å¤§äº 2 çš„ç»“ç‚¹)ï¼ŒäºŒå‰æ ‘çš„å­æ ‘æœ‰å·¦å³ä¹‹åˆ†ï¼Œæ¬¡åºä¸èƒ½é¢ å€’ã€‚äºŒå‰æ ‘çš„ç¬¬ i å±‚è‡³å¤šæœ‰ 2^(i-1) ä¸ªç»“ç‚¹ï¼›æ·±åº¦ä¸º k çš„äºŒå‰æ ‘è‡³å¤šæœ‰ (2^k)-1 ä¸ªç»“ç‚¹ï¼›å¯¹ä»»ä½•ä¸€æ£µäºŒå‰æ ‘ Tï¼Œå¦‚æœå…¶ç»ˆç«¯ç»“ç‚¹æ•°ä¸º n0ï¼Œåº¦ä¸º 2 çš„ç»“ç‚¹æ•°ä¸º n2ï¼Œåˆ™ n0=n2+1ã€‚","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}],"tags":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}]},{"title":"ã€Cè¯­è¨€ã€‘- Makefile","slug":"Cè¯­è¨€/Makefile","date":"2019-07-08T02:11:09.000Z","updated":"2021-03-20T16:25:01.798Z","comments":true,"path":"2019/07/08/Cè¯­è¨€/Makefile/","link":"","permalink":"http://blog.crazylaw.cn/2019/07/08/C%E8%AF%AD%E8%A8%80/Makefile/","excerpt":"å‰è¨€ä»€ä¹ˆæ˜¯ makefileï¼Ÿæˆ–è®¸å¾ˆå¤š Winodws çš„ç¨‹åºå‘˜éƒ½ä¸çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œå› ä¸ºé‚£äº› Windows çš„ IDE éƒ½ä¸ºä½ åšäº†è¿™ä¸ªå·¥ä½œï¼Œä½†æˆ‘è§‰å¾—è¦ä½œä¸€ä¸ªå¥½çš„å’Œ professional çš„ç¨‹åºå‘˜ï¼Œmakefile è¿˜æ˜¯è¦æ‡‚ã€‚è¿™å°±å¥½åƒç°åœ¨æœ‰è¿™ä¹ˆå¤šçš„ HTML çš„ç¼–è¾‘å™¨ï¼Œä½†å¦‚æœä½ æƒ³æˆä¸ºä¸€ä¸ªä¸“ä¸šäººå£«ï¼Œä½ è¿˜æ˜¯è¦äº†è§£ HTML çš„æ ‡è¯†çš„å«ä¹‰ã€‚ç‰¹åˆ«åœ¨ Unix ä¸‹çš„è½¯ä»¶ç¼–è¯‘ï¼Œä½ å°±ä¸èƒ½ä¸è‡ªå·±å†™ makefile äº†ï¼Œä¼šä¸ä¼šå†™ makefileï¼Œä»ä¸€ä¸ªä¾§é¢è¯´æ˜äº†ä¸€ä¸ªäººæ˜¯å¦å…·å¤‡å®Œæˆå¤§å‹å·¥ç¨‹çš„èƒ½åŠ›ã€‚å› ä¸ºï¼Œmakefile å…³ç³»åˆ°äº†æ•´ä¸ªå·¥ç¨‹çš„ç¼–è¯‘è§„åˆ™ã€‚ä¸€ä¸ªå·¥ç¨‹ä¸­çš„æºæ–‡ä»¶ä¸è®¡æ•°ï¼Œå…¶æŒ‰ç±»å‹ã€åŠŸèƒ½ã€æ¨¡å—åˆ†åˆ«æ”¾åœ¨è‹¥å¹²ä¸ªç›®å½•ä¸­ï¼Œmakefile å®šä¹‰äº†ä¸€ç³»åˆ—çš„è§„åˆ™æ¥æŒ‡å®šï¼Œå“ªäº›æ–‡ä»¶éœ€è¦å…ˆç¼–è¯‘ï¼Œå“ªäº›æ–‡ä»¶éœ€è¦åç¼–è¯‘ï¼Œå“ªäº›æ–‡ä»¶éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œç”šè‡³äºè¿›è¡Œæ›´å¤æ‚çš„åŠŸèƒ½æ“ä½œï¼Œå› ä¸º makefile å°±åƒä¸€ä¸ª Shell è„šæœ¬ä¸€æ ·ï¼Œå…¶ä¸­ä¹Ÿå¯ä»¥æ‰§è¡Œæ“ä½œç³»ç»Ÿçš„å‘½ä»¤ã€‚makefile å¸¦æ¥çš„å¥½å¤„å°±æ˜¯â€”â€”â€œè‡ªåŠ¨åŒ–ç¼–è¯‘â€ï¼Œä¸€æ—¦å†™å¥½ï¼Œåªéœ€è¦ä¸€ä¸ª make å‘½ä»¤ï¼Œæ•´ä¸ªå·¥ç¨‹å®Œå…¨è‡ªåŠ¨ç¼–è¯‘ï¼Œæå¤§çš„æé«˜äº†è½¯ä»¶å¼€å‘çš„æ•ˆç‡ã€‚make æ˜¯ä¸€ä¸ªå‘½ä»¤å·¥å…·ï¼Œæ˜¯ä¸€ä¸ªè§£é‡Š makefile ä¸­æŒ‡ä»¤çš„å‘½ä»¤å·¥å…·ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¤§å¤šæ•°çš„ IDE éƒ½æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚ï¼šDelphi çš„ makeï¼ŒVisual C++çš„ nmakeï¼ŒLinux ä¸‹ GNU çš„ makeã€‚å¯è§ï¼Œmakefile éƒ½æˆä¸ºäº†ä¸€ç§åœ¨å·¥ç¨‹æ–¹é¢çš„ç¼–è¯‘æ–¹æ³•ã€‚ å…¶å®åœ¨æˆ‘çœ¼ä¸­ï¼Œæ„Ÿè§‰ makefile æ–‡ä»¶å…¶å®å°±æ˜¯ç­‰äºä¸€ä¸ª shell æ–‡ä»¶ï¼Œç”¨äºå¤„ç†â€œè‡ªåŠ¨åŒ–â€çš„å†…å®¹ï¼Œåªä¸è¿‡å®ƒæ˜¯ç”± C è¯­è¨€ç¨‹åºæœ¬èº«è§£æçš„ã€‚","text":"å‰è¨€ä»€ä¹ˆæ˜¯ makefileï¼Ÿæˆ–è®¸å¾ˆå¤š Winodws çš„ç¨‹åºå‘˜éƒ½ä¸çŸ¥é“è¿™ä¸ªä¸œè¥¿ï¼Œå› ä¸ºé‚£äº› Windows çš„ IDE éƒ½ä¸ºä½ åšäº†è¿™ä¸ªå·¥ä½œï¼Œä½†æˆ‘è§‰å¾—è¦ä½œä¸€ä¸ªå¥½çš„å’Œ professional çš„ç¨‹åºå‘˜ï¼Œmakefile è¿˜æ˜¯è¦æ‡‚ã€‚è¿™å°±å¥½åƒç°åœ¨æœ‰è¿™ä¹ˆå¤šçš„ HTML çš„ç¼–è¾‘å™¨ï¼Œä½†å¦‚æœä½ æƒ³æˆä¸ºä¸€ä¸ªä¸“ä¸šäººå£«ï¼Œä½ è¿˜æ˜¯è¦äº†è§£ HTML çš„æ ‡è¯†çš„å«ä¹‰ã€‚ç‰¹åˆ«åœ¨ Unix ä¸‹çš„è½¯ä»¶ç¼–è¯‘ï¼Œä½ å°±ä¸èƒ½ä¸è‡ªå·±å†™ makefile äº†ï¼Œä¼šä¸ä¼šå†™ makefileï¼Œä»ä¸€ä¸ªä¾§é¢è¯´æ˜äº†ä¸€ä¸ªäººæ˜¯å¦å…·å¤‡å®Œæˆå¤§å‹å·¥ç¨‹çš„èƒ½åŠ›ã€‚å› ä¸ºï¼Œmakefile å…³ç³»åˆ°äº†æ•´ä¸ªå·¥ç¨‹çš„ç¼–è¯‘è§„åˆ™ã€‚ä¸€ä¸ªå·¥ç¨‹ä¸­çš„æºæ–‡ä»¶ä¸è®¡æ•°ï¼Œå…¶æŒ‰ç±»å‹ã€åŠŸèƒ½ã€æ¨¡å—åˆ†åˆ«æ”¾åœ¨è‹¥å¹²ä¸ªç›®å½•ä¸­ï¼Œmakefile å®šä¹‰äº†ä¸€ç³»åˆ—çš„è§„åˆ™æ¥æŒ‡å®šï¼Œå“ªäº›æ–‡ä»¶éœ€è¦å…ˆç¼–è¯‘ï¼Œå“ªäº›æ–‡ä»¶éœ€è¦åç¼–è¯‘ï¼Œå“ªäº›æ–‡ä»¶éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œç”šè‡³äºè¿›è¡Œæ›´å¤æ‚çš„åŠŸèƒ½æ“ä½œï¼Œå› ä¸º makefile å°±åƒä¸€ä¸ª Shell è„šæœ¬ä¸€æ ·ï¼Œå…¶ä¸­ä¹Ÿå¯ä»¥æ‰§è¡Œæ“ä½œç³»ç»Ÿçš„å‘½ä»¤ã€‚makefile å¸¦æ¥çš„å¥½å¤„å°±æ˜¯â€”â€”â€œè‡ªåŠ¨åŒ–ç¼–è¯‘â€ï¼Œä¸€æ—¦å†™å¥½ï¼Œåªéœ€è¦ä¸€ä¸ª make å‘½ä»¤ï¼Œæ•´ä¸ªå·¥ç¨‹å®Œå…¨è‡ªåŠ¨ç¼–è¯‘ï¼Œæå¤§çš„æé«˜äº†è½¯ä»¶å¼€å‘çš„æ•ˆç‡ã€‚make æ˜¯ä¸€ä¸ªå‘½ä»¤å·¥å…·ï¼Œæ˜¯ä¸€ä¸ªè§£é‡Š makefile ä¸­æŒ‡ä»¤çš„å‘½ä»¤å·¥å…·ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¤§å¤šæ•°çš„ IDE éƒ½æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚ï¼šDelphi çš„ makeï¼ŒVisual C++çš„ nmakeï¼ŒLinux ä¸‹ GNU çš„ makeã€‚å¯è§ï¼Œmakefile éƒ½æˆä¸ºäº†ä¸€ç§åœ¨å·¥ç¨‹æ–¹é¢çš„ç¼–è¯‘æ–¹æ³•ã€‚ å…¶å®åœ¨æˆ‘çœ¼ä¸­ï¼Œæ„Ÿè§‰ makefile æ–‡ä»¶å…¶å®å°±æ˜¯ç­‰äºä¸€ä¸ª shell æ–‡ä»¶ï¼Œç”¨äºå¤„ç†â€œè‡ªåŠ¨åŒ–â€çš„å†…å®¹ï¼Œåªä¸è¿‡å®ƒæ˜¯ç”± C è¯­è¨€ç¨‹åºæœ¬èº«è§£æçš„ã€‚ Makefile ä¹¦å†™å‘½ä»¤æ˜¾ç¤ºå‘½ä»¤é€šå¸¸ï¼Œmake ä¼šæŠŠå…¶è¦æ‰§è¡Œçš„å‘½ä»¤è¡Œåœ¨å‘½ä»¤æ‰§è¡Œå‰è¾“å‡ºåˆ°å±å¹•ä¸Šã€‚å½“æˆ‘ä»¬ç”¨â€œ@â€å­—ç¬¦åœ¨å‘½ä»¤è¡Œå‰ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªå‘½ä»¤å°†ä¸è¢« make æ˜¾ç¤ºå‡ºæ¥ï¼Œæœ€å…·ä»£è¡¨æ€§çš„ä¾‹å­æ˜¯ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªåŠŸèƒ½æ¥åƒå±å¹•æ˜¾ç¤ºä¸€äº›ä¿¡æ¯ã€‚å¦‚ï¼š 1@echo æ­£åœ¨ç¼–è¯‘ XXX æ¨¡å—...... å½“ make æ‰§è¡Œæ—¶ï¼Œä¼šè¾“å‡ºâ€œæ­£åœ¨ç¼–è¯‘ XXX æ¨¡å—â€¦â€¦â€å­—ä¸²ï¼Œä½†ä¸ä¼šè¾“å‡ºå‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰â€œ@â€ï¼Œé‚£ä¹ˆï¼Œmake å°†è¾“å‡ºï¼š 123echo æ­£åœ¨ç¼–è¯‘ XXX æ¨¡å—......æ­£åœ¨ç¼–è¯‘ XXX æ¨¡å—...... å¦‚æœ make æ‰§è¡Œæ—¶ï¼Œå¸¦å…¥ make å‚æ•°â€œ-nâ€æˆ–â€œ--just-printâ€ï¼Œé‚£ä¹ˆå…¶åªæ˜¯æ˜¾ç¤ºå‘½ä»¤ï¼Œä½†ä¸ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œè¿™ä¸ªåŠŸèƒ½å¾ˆæœ‰åˆ©äºæˆ‘ä»¬è°ƒè¯•æˆ‘ä»¬çš„ Makefileï¼Œçœ‹çœ‹æˆ‘ä»¬ä¹¦å†™çš„å‘½ä»¤æ˜¯æ‰§è¡Œèµ·æ¥æ˜¯ä»€ä¹ˆæ ·å­çš„æˆ–æ˜¯ä»€ä¹ˆé¡ºåºçš„ã€‚ è€Œ make å‚æ•°â€œ-sâ€æˆ–â€œ--slientâ€åˆ™æ˜¯å…¨é¢ç¦æ­¢å‘½ä»¤çš„æ˜¾ç¤ºã€‚ ç±»ä¼¼äº bash -x ä¸€æ · å‘½ä»¤æ‰§è¡Œå½“ä¾èµ–ç›®æ ‡æ–°äºç›®æ ‡æ—¶ï¼Œä¹Ÿå°±æ˜¯å½“è§„åˆ™çš„ç›®æ ‡éœ€è¦è¢«æ›´æ–°æ—¶ï¼Œmake ä¼šä¸€æ¡ä¸€æ¡çš„æ‰§è¡Œå…¶åçš„å‘½ä»¤ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ è¦è®©ä¸Šä¸€æ¡å‘½ä»¤çš„ç»“æœåº”ç”¨åœ¨ä¸‹ä¸€æ¡å‘½ä»¤æ—¶ï¼Œä½ åº”è¯¥ä½¿ç”¨åˆ†å·åˆ†éš”è¿™ä¸¤æ¡å‘½ä»¤ã€‚æ¯”å¦‚ä½ çš„ç¬¬ä¸€æ¡å‘½ä»¤æ˜¯ cd å‘½ä»¤ï¼Œä½ å¸Œæœ›ç¬¬äºŒæ¡å‘½ä»¤å¾—åœ¨ cd ä¹‹åçš„åŸºç¡€ä¸Šè¿è¡Œï¼Œé‚£ä¹ˆä½ å°±ä¸èƒ½æŠŠè¿™ä¸¤æ¡å‘½ä»¤å†™åœ¨ä¸¤è¡Œä¸Šï¼Œè€Œåº”è¯¥æŠŠè¿™ä¸¤æ¡å‘½ä»¤å†™åœ¨ä¸€è¡Œä¸Šï¼Œç”¨åˆ†å·åˆ†éš”ã€‚ é”™è¯¯ä¾‹å­ï¼š 123exec: cd /home/ccinn pwd æ­£ç¡®ä¾‹å­: 12exec: cd /home/ccinn; pwd å‘½ä»¤å‡ºé”™æ¯å½“å‘½ä»¤è¿è¡Œå®Œåï¼Œmake ä¼šæ£€æµ‹æ¯ä¸ªå‘½ä»¤çš„è¿”å›ç ï¼Œå¦‚æœå‘½ä»¤è¿”å›æˆåŠŸï¼Œé‚£ä¹ˆ make ä¼šæ‰§è¡Œä¸‹ä¸€æ¡å‘½ä»¤ï¼Œå½“è§„åˆ™ä¸­æ‰€æœ‰çš„å‘½ä»¤æˆåŠŸè¿”å›åï¼Œè¿™ä¸ªè§„åˆ™å°±ç®—æ˜¯æˆåŠŸå®Œæˆäº†ã€‚å¦‚æœä¸€ä¸ªè§„åˆ™ä¸­çš„æŸä¸ªå‘½ä»¤å‡ºé”™äº†ï¼ˆå‘½ä»¤é€€å‡ºç éé›¶ï¼‰ï¼Œé‚£ä¹ˆ make å°±ä¼šç»ˆæ­¢æ‰§è¡Œå½“å‰è§„åˆ™ï¼Œè¿™å°†æœ‰å¯èƒ½ç»ˆæ­¢æ‰€æœ‰è§„åˆ™çš„æ‰§è¡Œã€‚ æœ‰äº›æ—¶å€™ï¼Œå‘½ä»¤çš„å‡ºé”™å¹¶ä¸è¡¨ç¤ºå°±æ˜¯é”™è¯¯çš„ã€‚ä¾‹å¦‚ mkdir å‘½ä»¤ï¼Œæˆ‘ä»¬ä¸€å®šéœ€è¦å»ºç«‹ä¸€ä¸ªç›®å½•ï¼Œå¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆ mkdir å°±æˆåŠŸæ‰§è¡Œï¼Œä¸‡äº‹å¤§å‰ï¼Œå¦‚æœç›®å½•å­˜åœ¨ï¼Œé‚£ä¹ˆå°±å‡ºé”™äº†ã€‚æˆ‘ä»¬ä¹‹æ‰€ä»¥ä½¿ç”¨ mkdir çš„æ„æ€å°±æ˜¯ä¸€å®šè¦æœ‰è¿™æ ·çš„ä¸€ä¸ªç›®å½•ï¼Œäºæ˜¯æˆ‘ä»¬å°±ä¸å¸Œæœ› mkdir å‡ºé”™è€Œç»ˆæ­¢è§„åˆ™çš„è¿è¡Œã€‚ ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¿½ç•¥å‘½ä»¤çš„å‡ºé”™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Makefile çš„å‘½ä»¤è¡Œå‰åŠ ä¸€ä¸ªå‡å·â€œ-â€ï¼ˆåœ¨ Tab é”®ä¹‹åï¼‰ï¼Œæ ‡è®°ä¸ºä¸ç®¡å‘½ä»¤å‡ºä¸å‡ºé”™éƒ½è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚å¦‚ï¼š 12build: -mdkir /home/ccinn è¿˜æœ‰ä¸€ä¸ªå…¨å±€çš„åŠæ³•æ˜¯ï¼Œç»™ make åŠ ä¸Šâ€œ-iâ€æˆ–æ˜¯â€œ--ignore-errorsâ€å‚æ•°ï¼Œé‚£ä¹ˆï¼ŒMakefile ä¸­æ‰€æœ‰å‘½ä»¤éƒ½ä¼šå¿½ç•¥é”™è¯¯ã€‚è€Œå¦‚æœä¸€ä¸ªè§„åˆ™æ˜¯ä»¥â€œ.IGNOREâ€ä½œä¸ºç›®æ ‡çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªè§„åˆ™ä¸­çš„æ‰€æœ‰å‘½ä»¤å°†ä¼šå¿½ç•¥é”™è¯¯ã€‚è¿™äº›æ˜¯ä¸åŒçº§åˆ«çš„é˜²æ­¢å‘½ä»¤å‡ºé”™çš„æ–¹æ³•ï¼Œä½ å¯ä»¥æ ¹æ®ä½ çš„ä¸åŒå–œæ¬¢è®¾ç½®ã€‚ è¿˜æœ‰ä¸€ä¸ªè¦æä¸€ä¸‹çš„ make çš„å‚æ•°çš„æ˜¯â€œ-kâ€æˆ–æ˜¯â€œ--keep-goingâ€ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œå¦‚æœæŸè§„åˆ™ä¸­çš„å‘½ä»¤å‡ºé”™äº†ï¼Œé‚£ä¹ˆå°±ç»ˆç›®è¯¥è§„åˆ™çš„æ‰§è¡Œï¼Œä½†ç»§ç»­æ‰§è¡Œå…¶å®ƒè§„åˆ™ã€‚ åµŒå¥—æ‰§è¡Œ makeåœ¨ä¸€äº›å¤§çš„å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠæˆ‘ä»¬ä¸åŒæ¨¡å—æˆ–æ˜¯ä¸åŒåŠŸèƒ½çš„æºæ–‡ä»¶æ”¾åœ¨ä¸åŒçš„ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªç›®å½•ä¸­éƒ½ä¹¦å†™ä¸€ä¸ªè¯¥ç›®å½•çš„ Makefileï¼Œè¿™æœ‰åˆ©äºè®©æˆ‘ä»¬çš„ Makefile å˜å¾—æ›´åŠ åœ°ç®€æ´ï¼Œè€Œä¸è‡³äºæŠŠæ‰€æœ‰çš„ä¸œè¥¿å…¨éƒ¨å†™åœ¨ä¸€ä¸ª Makefile ä¸­ï¼Œè¿™æ ·ä¼šå¾ˆéš¾ç»´æŠ¤æˆ‘ä»¬çš„ Makefileï¼Œè¿™ä¸ªæŠ€æœ¯å¯¹äºæˆ‘ä»¬æ¨¡å—ç¼–è¯‘å’Œåˆ†æ®µç¼–è¯‘æœ‰ç€éå¸¸å¤§çš„å¥½å¤„ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå­ç›®å½•å« subdirï¼Œè¿™ä¸ªç›®å½•ä¸‹æœ‰ä¸ª Makefile æ–‡ä»¶ï¼Œæ¥æŒ‡æ˜äº†è¿™ä¸ªç›®å½•ä¸‹æ–‡ä»¶çš„ç¼–è¯‘è§„åˆ™ã€‚é‚£ä¹ˆæˆ‘ä»¬æ€»æ§çš„ Makefile å¯ä»¥è¿™æ ·ä¹¦å†™ï¼š 12subsystem: cd subdir &amp;&amp; $(MAKE) å…¶ç­‰ä»·äºï¼š 12subsystem: $(MAKE) -C subdir å®šä¹‰$(MAKE)å®å˜é‡çš„æ„æ€æ˜¯ï¼Œä¹Ÿè®¸æˆ‘ä»¬çš„ make éœ€è¦ä¸€äº›å‚æ•°ï¼Œæ‰€ä»¥å®šä¹‰æˆä¸€ä¸ªå˜é‡æ¯”è¾ƒåˆ©äºç»´æŠ¤ã€‚è¿™ä¸¤ä¸ªä¾‹å­çš„æ„æ€éƒ½æ˜¯å…ˆè¿›å…¥â€œsubdirâ€ç›®å½•ï¼Œç„¶åæ‰§è¡Œ make å‘½ä»¤ã€‚ æˆ‘ä»¬æŠŠè¿™ä¸ª Makefile å«åšâ€œæ€»æ§ Makefileâ€ï¼Œæ€»æ§ Makefile çš„å˜é‡å¯ä»¥ä¼ é€’åˆ°ä¸‹çº§çš„ Makefile ä¸­ï¼ˆå¦‚æœä½ æ˜¾ç¤ºçš„å£°æ˜ï¼‰ï¼Œä½†æ˜¯ä¸ä¼šè¦†ç›–ä¸‹å±‚çš„ Makefile ä¸­æ‰€å®šä¹‰çš„å˜é‡ï¼Œé™¤éæŒ‡å®šäº†â€œ-eâ€å‚æ•°ã€‚ å¦‚æœä½ è¦ä¼ é€’å˜é‡åˆ°ä¸‹çº§ Makefile ä¸­ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨è¿™æ ·çš„å£°æ˜ï¼š 1export&lt;variable ...&gt; å¦‚æœä½ ä¸æƒ³è®©æŸäº›å˜é‡ä¼ é€’åˆ°ä¸‹çº§ Makefile ä¸­ï¼Œé‚£ä¹ˆä½ å¯ä»¥è¿™æ ·å£°æ˜ï¼š 1unexport&lt;variable ...&gt; ç¤ºä¾‹ä¸€ï¼š1export variable = value å…¶ç­‰ä»·äºï¼š 123variable = valueexport variable å…¶ç­‰ä»·äºï¼š 1export variable := value å…¶ç­‰ä»·äºï¼š 123variable := valueexport variable ç¤ºä¾‹äºŒï¼š1export variable += value å…¶ç­‰ä»·äºï¼š 123variable += valueexport variable å¦‚æœä½ è¦ä¼ é€’æ‰€æœ‰çš„å˜é‡ï¼Œé‚£ä¹ˆï¼Œåªè¦ä¸€ä¸ªexportå°±è¡Œäº†ã€‚åé¢ä»€ä¹ˆä¹Ÿä¸ç”¨è·Ÿï¼Œè¡¨ç¤ºä¼ é€’æ‰€æœ‰çš„å˜é‡ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰ä¸¤ä¸ªå˜é‡ï¼Œä¸€ä¸ªæ˜¯ SHELLï¼Œä¸€ä¸ªæ˜¯MAKEFLAGSï¼Œè¿™ä¸¤ä¸ªå˜é‡ä¸ç®¡ä½ æ˜¯å¦ exportï¼Œå…¶æ€»æ˜¯è¦ä¼ é€’åˆ°ä¸‹å±‚ Makefile ä¸­ï¼Œç‰¹åˆ«æ˜¯ MAKEFILES å˜é‡ï¼Œå…¶ä¸­åŒ…å«äº† make çš„å‚æ•°ä¿¡æ¯ï¼Œå¦‚æœæˆ‘ä»¬æ‰§è¡Œâ€œæ€»æ§ Makefileâ€æ—¶æœ‰ make å‚æ•°æˆ–æ˜¯åœ¨ä¸Šå±‚ Makefile ä¸­å®šä¹‰äº†è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆ MAKEFILES å˜é‡å°†ä¼šæ˜¯è¿™äº›å‚æ•°ï¼Œå¹¶ä¼šä¼ é€’åˆ°ä¸‹å±‚ Makefile ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿçº§çš„ç¯å¢ƒå˜é‡ã€‚ ä½†æ˜¯ make å‘½ä»¤ä¸­çš„æœ‰å‡ ä¸ªå‚æ•°å¹¶ä¸å¾€ä¸‹ä¼ é€’ï¼Œå®ƒä»¬æ˜¯â€œ-Câ€,â€œ-fâ€,â€œ-hâ€â€œ-oâ€å’Œâ€œ-Wâ€ï¼ˆæœ‰å…³ Makefile å‚æ•°çš„ç»†èŠ‚å°†åœ¨åé¢è¯´æ˜ï¼‰ï¼Œå¦‚æœä½ ä¸æƒ³å¾€ä¸‹å±‚ä¼ é€’å‚æ•°ï¼Œé‚£ä¹ˆï¼Œä½ å¯ä»¥è¿™æ ·æ¥ï¼š 12subsystem: cd subdir &amp;&amp; $(MAKE) MAKEFLAGS= å¦‚æœä½ å®šä¹‰äº†ç¯å¢ƒå˜é‡ MAKEFLAGSï¼Œé‚£ä¹ˆä½ å¾—ç¡®ä¿¡å…¶ä¸­çš„é€‰é¡¹æ˜¯å¤§å®¶éƒ½ä¼šç”¨åˆ°çš„ï¼Œå¦‚æœå…¶ä¸­æœ‰â€œ-tâ€,â€œ-nâ€,å’Œâ€œ-qâ€å‚æ•°ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰è®©ä½ æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œæˆ–è®¸ä¼šè®©ä½ å¼‚å¸¸åœ°ææ…Œã€‚ è¿˜æœ‰ä¸€ä¸ªåœ¨â€œåµŒå¥—æ‰§è¡Œâ€ä¸­æ¯”è¾ƒæœ‰ç”¨çš„å‚æ•°ï¼Œâ€œ-wâ€æˆ–æ˜¯â€œ--print-directoryâ€ä¼šåœ¨ make çš„è¿‡ç¨‹ä¸­è¾“å‡ºä¸€äº›ä¿¡æ¯ï¼Œè®©ä½ çœ‹åˆ°ç›®å‰çš„å·¥ä½œç›®å½•ã€‚æ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬çš„ä¸‹çº§ make ç›®å½•æ˜¯â€œ/home/ccinn/gnu/makeâ€ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨â€œmake -wâ€æ¥æ‰§è¡Œï¼Œé‚£ä¹ˆå½“è¿›å…¥è¯¥ç›®å½•æ—¶ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼š 1make: Entering directory `/home/ccinn/gnu/make'. è€Œåœ¨å®Œæˆä¸‹å±‚ make åç¦»å¼€ç›®å½•æ—¶ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼š 1make: Leaving directory `/home/ccinn/gnu/make' å½“ä½ ä½¿ç”¨â€œ-Câ€å‚æ•°æ¥æŒ‡å®š make ä¸‹å±‚ Makefile æ—¶ï¼Œâ€œ-wâ€ä¼šè¢«è‡ªåŠ¨æ‰“å¼€çš„ã€‚ å¦‚æœå‚æ•°ä¸­æœ‰â€œ-sâ€ï¼ˆâ€œâ€“slientâ€ï¼‰æˆ–æ˜¯â€œâ€“no-print-directoryâ€ï¼Œé‚£ä¹ˆï¼Œâ€œ-wâ€æ€»æ˜¯å¤±æ•ˆçš„ã€‚","categories":[{"name":"Cè¯­è¨€","slug":"Cè¯­è¨€","permalink":"http://blog.crazylaw.cn/categories/C%E8%AF%AD%E8%A8%80/"}],"tags":[{"name":"Cè¯­è¨€","slug":"Cè¯­è¨€","permalink":"http://blog.crazylaw.cn/tags/C%E8%AF%AD%E8%A8%80/"}]},{"title":"ã€LeeCodeã€‘- æœ€é•¿å…¬å…¬å‰ç¼€","slug":"ç®—æ³•/leetcode/\bæœ€é•¿å…¬å…±å‰ç¼€","date":"2019-07-06T02:11:09.000Z","updated":"2021-03-20T16:25:01.821Z","comments":true,"path":"2019/07/06/ç®—æ³•/leetcode/\bæœ€é•¿å…¬å…±å‰ç¼€/","link":"","permalink":"http://blog.crazylaw.cn/2019/07/06/%E7%AE%97%E6%B3%95/leetcode/%08%E6%9C%80%E9%95%BF%E5%85%AC%E5%85%B1%E5%89%8D%E7%BC%80/","excerpt":"","text":"é¢˜ç›®ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥æŸ¥æ‰¾å­—ç¬¦ä¸²æ•°ç»„ä¸­çš„æœ€é•¿å…¬å…±å‰ç¼€ã€‚ å¦‚æœä¸å­˜åœ¨å…¬å…±å‰ç¼€ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸² â€œâ€ã€‚ ç¤ºä¾‹ 1: 12è¾“å…¥: [&quot;flower&quot;,&quot;flow&quot;,&quot;flight&quot;]è¾“å‡º: &quot;fl&quot; ç¤ºä¾‹ 2: 1234è¾“å…¥: [&quot;dog&quot;,&quot;racecar&quot;,&quot;car&quot;]è¾“å‡º: &quot;&quot;è§£é‡Š: è¾“å…¥ä¸å­˜åœ¨å…¬å…±å‰ç¼€ã€‚è¯´æ˜: æ‰€æœ‰è¾“å…¥åªåŒ…å«å°å†™å­—æ¯ a-z ã€‚ è§£æ³•è§£æ³•ä¸€ï¼šæ°´å¹³æ‰«ææ³•é¦–å…ˆï¼Œæˆ‘ä»¬å°†æè¿°ä¸€ç§æŸ¥è¯¢ä¸€ç»„å­—ç¬¦ä¸²çš„æœ€é•¿å…¬å…±å‰ç¼€ LCP(S1...Sn)ï¼Œæˆ‘ä»¬å¾—åˆ°ç»“è®ºæ˜¯ï¼š LCP(S1...Sn)=LCP(LCP(LCP(S1,S2),S3),...Sn) ä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œä¸¤ä¸¤æ¯”è¾ƒçš„å­—ç¬¦ä¸²çš„å…¬å…±å­—ç¬¦ä¸²å°±æ˜¯æˆ‘ä»¬çš„è¿ç®—è¿‡ç¨‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;stdlib.h&gt;char *longestCommonPrefix(char **strs, int strSize)&#123; int i, j; if (strSize == 0) &#123; return \"\"; &#125; char *str = (char *)malloc(sizeof(char) * 1000); strcpy(str, strs[0]); for (i = 1; i &lt; strSize; i++) &#123; j = 0; while (str[j] &amp;&amp; strs[i][j] &amp;&amp; str[j] == strs[i][j]) &#123; j++; &#125; str[j] = '\\0'; &#125; return str;&#125;int main()&#123; char *strs[] = &#123;\"lees\", \"leetcode\", \"leet\", \"leets\"&#125;; int size = sizeof(strs) / sizeof(char *); char *lcp; lcp = longestCommonPrefix(strs, size); printf(\"%s\\n\", lcp); return 0;&#125; å…·ä½“è¯·æŸ¥çœ‹æˆ‘çš„ github ä»“åº“é¡¹ç›® leetcode-practice","categories":[{"name":"LeeCode","slug":"LeeCode","permalink":"http://blog.crazylaw.cn/categories/LeeCode/"},{"name":"ç®—æ³•","slug":"LeeCode/ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/LeeCode/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"LeeCode","slug":"LeeCode","permalink":"http://blog.crazylaw.cn/tags/LeeCode/"}]},{"title":"ã€APIç½‘å…³ã€‘- Orange","slug":"APIç½‘å…³/orange","date":"2019-07-05T10:15:00.000Z","updated":"2021-03-20T16:25:01.797Z","comments":true,"path":"2019/07/05/APIç½‘å…³/orange/","link":"","permalink":"http://blog.crazylaw.cn/2019/07/05/API%E7%BD%91%E5%85%B3/orange/","excerpt":"å‰è¨€ ç‰ˆæœ¬ï¼š0.7 API ç½‘å…³/ç½‘å…³ï¼Œå……å½“çš„èŒè´£æ— éä»¥ä¸‹å‡ ç‚¹ï¼š é‰´æƒ é™æµ åˆ†æµ è´Ÿè½½å‡è¡¡ éšå«çš„åŠŸèƒ½å°±æ˜¯åŠ¨æ€ upstream å¤§å¤šä¸çš„ API ç½‘å…³éƒ½æ˜¯ç”¨åˆ©ç”¨ lua å®ç°çš„ Openresty æ¥å®ç°çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥å¾ˆå¥½çš„å’Œ nginx ç»“åˆåœ¨ä¸€èµ·ï¼Œå¯ä»¥åŒæ—¶è¿è¡Œ lua è„šæœ¬å’Œ C åº“ï¼Œå¹¶ä¸”ç”±äº lua åœ¨åç¨‹ä¸Šå®ç°å¾—ååˆ†æ—©ï¼Œå¯¹äº IO å¯†é›†å‹çš„å¤„ç†ååˆ†çš„é«˜æ•ˆã€‚ åœ¨ç»™äºˆ Openresty å®ç°çš„ API ç½‘å…³ä¸­ï¼Œæœ‰ä¸€äº›æ˜¯æ¯”è¾ƒå‡ºåçš„ï¼Œä¾‹å¦‚ kong/orange kong ç®—æ˜¯è¡Œä¸šè®¤ä¸ºæœ€å¼ºå¤§æˆç†Ÿçš„ä¸€ä¸ªç»„ä»¶çš„ï¼Œä½†æ˜¯è¿‡äºå¤æ‚äº†ã€‚ orange åˆ©ç”¨æ’ä»¶çš„å½¢å¼æ¥å¤„ç†è¯·æ±‚ï¼Œå¹¶ä¸”é—´æ¥ç›´æ¥ï¼Œæ˜“äºäºŒæ¬¡å¼€å‘å’Œæ‰©å±•","text":"å‰è¨€ ç‰ˆæœ¬ï¼š0.7 API ç½‘å…³/ç½‘å…³ï¼Œå……å½“çš„èŒè´£æ— éä»¥ä¸‹å‡ ç‚¹ï¼š é‰´æƒ é™æµ åˆ†æµ è´Ÿè½½å‡è¡¡ éšå«çš„åŠŸèƒ½å°±æ˜¯åŠ¨æ€ upstream å¤§å¤šä¸çš„ API ç½‘å…³éƒ½æ˜¯ç”¨åˆ©ç”¨ lua å®ç°çš„ Openresty æ¥å®ç°çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥å¾ˆå¥½çš„å’Œ nginx ç»“åˆåœ¨ä¸€èµ·ï¼Œå¯ä»¥åŒæ—¶è¿è¡Œ lua è„šæœ¬å’Œ C åº“ï¼Œå¹¶ä¸”ç”±äº lua åœ¨åç¨‹ä¸Šå®ç°å¾—ååˆ†æ—©ï¼Œå¯¹äº IO å¯†é›†å‹çš„å¤„ç†ååˆ†çš„é«˜æ•ˆã€‚ åœ¨ç»™äºˆ Openresty å®ç°çš„ API ç½‘å…³ä¸­ï¼Œæœ‰ä¸€äº›æ˜¯æ¯”è¾ƒå‡ºåçš„ï¼Œä¾‹å¦‚ kong/orange kong ç®—æ˜¯è¡Œä¸šè®¤ä¸ºæœ€å¼ºå¤§æˆç†Ÿçš„ä¸€ä¸ªç»„ä»¶çš„ï¼Œä½†æ˜¯è¿‡äºå¤æ‚äº†ã€‚ orange åˆ©ç”¨æ’ä»¶çš„å½¢å¼æ¥å¤„ç†è¯·æ±‚ï¼Œå¹¶ä¸”é—´æ¥ç›´æ¥ï¼Œæ˜“äºäºŒæ¬¡å¼€å‘å’Œæ‰©å±• Orangeç”±äº 3 ä¸ªéƒ¨åˆ†æ„æˆï¼š main-server: ä¸€ä¸ª location çš„è¡¨ç¤ºæ ¼å¼ api-server: orange çš„ api æœåŠ¡ dashboard: é¢æ¿ ä¾èµ–çš„å­˜å‚¨æœåŠ¡ï¼š mysql å‰ç«¯æŠ€æ ˆï¼š html css jquery Orange è„‘å›¾ æ’ä»¶BASE_AUTHåŸºäº Basic Authorization çš„æ’ä»¶ DIVIDEåˆ†æµæ’ä»¶ DYNAMIC_UPSTREAMåŠ¨æ€ upstream æ’ä»¶","categories":[{"name":"APIç½‘å…³","slug":"APIç½‘å…³","permalink":"http://blog.crazylaw.cn/categories/API%E7%BD%91%E5%85%B3/"}],"tags":[{"name":"APIç½‘å…³","slug":"APIç½‘å…³","permalink":"http://blog.crazylaw.cn/tags/API%E7%BD%91%E5%85%B3/"}]},{"title":"ã€æœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‘- Etcd","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°/etcd","date":"2019-07-05T03:15:00.000Z","updated":"2021-03-20T16:25:01.819Z","comments":true,"path":"2019/07/05/æœåŠ¡æ³¨å†Œå’Œå‘ç°/etcd/","link":"","permalink":"http://blog.crazylaw.cn/2019/07/05/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/etcd/","excerpt":"Etcd is a distributed, consistent key-value store for shared configuration and service discovery æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œä¸€è‡´çš„ key-value å­˜å‚¨ï¼Œä¸»è¦ç”¨é€”æ˜¯å…±äº«é…ç½®å’ŒæœåŠ¡å‘ç° æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°æ˜¯åœ¨åˆ†å¸ƒå¼æœåŠ¡æ¶æ„ä¸­å¸¸å¸¸ä¼šæ¶‰åŠåˆ°çš„ä¸œè¥¿ï¼Œä¸šç•Œå¸¸ç”¨çš„æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°å·¥å…·æœ‰ ZooKeeperã€etcdã€Consul å’Œ Eurekaã€‚","text":"Etcd is a distributed, consistent key-value store for shared configuration and service discovery æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œä¸€è‡´çš„ key-value å­˜å‚¨ï¼Œä¸»è¦ç”¨é€”æ˜¯å…±äº«é…ç½®å’ŒæœåŠ¡å‘ç° æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°æ˜¯åœ¨åˆ†å¸ƒå¼æœåŠ¡æ¶æ„ä¸­å¸¸å¸¸ä¼šæ¶‰åŠåˆ°çš„ä¸œè¥¿ï¼Œä¸šç•Œå¸¸ç”¨çš„æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°å·¥å…·æœ‰ ZooKeeperã€etcdã€Consul å’Œ Eurekaã€‚ \bEtcd æ¶æ„ ä» etcd çš„æ¶æ„å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œetcd ä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ã€‚ HTTP Serverï¼š ç”¨äºå¤„ç†ç”¨æˆ·å‘é€çš„ API è¯·æ±‚ä»¥åŠå…¶å®ƒ etcd èŠ‚ç‚¹çš„åŒæ­¥ä¸å¿ƒè·³ä¿¡æ¯è¯·æ±‚ã€‚ Storeï¼šç”¨äºå¤„ç† etcd æ”¯æŒçš„å„ç±»åŠŸèƒ½çš„äº‹åŠ¡ï¼ŒåŒ…æ‹¬æ•°æ®ç´¢å¼•ã€èŠ‚ç‚¹çŠ¶æ€å˜æ›´ã€ç›‘æ§ä¸åé¦ˆã€äº‹ä»¶å¤„ç†ä¸æ‰§è¡Œç­‰ç­‰ï¼Œæ˜¯ etcd å¯¹ç”¨æˆ·æä¾›çš„å¤§å¤šæ•° API åŠŸèƒ½çš„å…·ä½“å®ç°ã€‚ Raftï¼šRaft å¼ºä¸€è‡´æ€§ç®—æ³•çš„å…·ä½“å®ç°ï¼Œæ˜¯ etcd çš„æ ¸å¿ƒã€‚ WALï¼šWrite Ahead Logï¼ˆé¢„å†™å¼æ—¥å¿—ï¼‰ï¼Œæ˜¯ etcd çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚é™¤äº†åœ¨å†…å­˜ä¸­å­˜æœ‰æ‰€æœ‰æ•°æ®çš„çŠ¶æ€ä»¥åŠèŠ‚ç‚¹çš„ç´¢å¼•ä»¥å¤–ï¼Œetcd å°±é€šè¿‡ WAL è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚WAL ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®æäº¤å‰éƒ½ä¼šäº‹å…ˆè®°å½•æ—¥å¿—ã€‚Snapshot æ˜¯ä¸ºäº†é˜²æ­¢æ•°æ®è¿‡å¤šè€Œè¿›è¡Œçš„çŠ¶æ€å¿«ç…§ï¼›Entry è¡¨ç¤ºå­˜å‚¨çš„å…·ä½“æ—¥å¿—å†…å®¹ã€‚ å…¶å®åƒ RocketMq ä¹Ÿæ˜¯æ”¯æŒè¿™ç§é¢„å†™å¼æ¶ˆæ¯ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç”¨äºäºŒæ¬¡ç¡®è®¤ é€šå¸¸ï¼Œä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å‘é€è¿‡æ¥ï¼Œä¼šç»ç”± HTTP Server è½¬å‘ç»™ Store è¿›è¡Œå…·ä½“çš„äº‹åŠ¡å¤„ç†ï¼Œå¦‚æœæ¶‰åŠåˆ°èŠ‚ç‚¹çš„ä¿®æ”¹ï¼Œåˆ™äº¤ç»™ Raft æ¨¡å—è¿›è¡ŒçŠ¶æ€çš„å˜æ›´ã€æ—¥å¿—çš„è®°å½•ï¼Œç„¶åå†åŒæ­¥ç»™åˆ«çš„ etcd èŠ‚ç‚¹ä»¥ç¡®è®¤æ•°æ®æäº¤ï¼Œæœ€åè¿›è¡Œæ•°æ®çš„æäº¤ï¼Œå†æ¬¡åŒæ­¥ã€‚ Etcd æ¦‚å¿µè¯æ±‡è¡¨ Raftï¼šetcd æ‰€é‡‡ç”¨çš„ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿå¼ºä¸€è‡´æ€§çš„ç®—æ³•ã€‚ Nodeï¼šä¸€ä¸ª Raft çŠ¶æ€æœºå®ä¾‹ã€‚ Memberï¼š ä¸€ä¸ª etcd å®ä¾‹ã€‚å®ƒç®¡ç†ç€ä¸€ä¸ª Nodeï¼Œå¹¶ä¸”å¯ä»¥ä¸ºå®¢æˆ·ç«¯è¯·æ±‚æä¾›æœåŠ¡ã€‚ Clusterï¼šç”±å¤šä¸ª Member æ„æˆå¯ä»¥ååŒå·¥ä½œçš„ etcd é›†ç¾¤ã€‚ Peerï¼šå¯¹åŒä¸€ä¸ª etcd é›†ç¾¤ä¸­å¦å¤–ä¸€ä¸ª Member çš„ç§°å‘¼ã€‚ Clientï¼š å‘ etcd é›†ç¾¤å‘é€ HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚ WALï¼šé¢„å†™å¼æ—¥å¿—ï¼Œetcd ç”¨äºæŒä¹…åŒ–å­˜å‚¨çš„æ—¥å¿—æ ¼å¼ã€‚ snapshotï¼šetcd é˜²æ­¢ WAL æ–‡ä»¶è¿‡å¤šè€Œè®¾ç½®çš„å¿«ç…§ï¼Œå­˜å‚¨ etcd æ•°æ®çŠ¶æ€ã€‚ Proxyï¼šetcd çš„ä¸€ç§æ¨¡å¼ï¼Œä¸º etcd é›†ç¾¤æä¾›åå‘ä»£ç†æœåŠ¡ã€‚ Leaderï¼šRaft ç®—æ³•ä¸­é€šè¿‡ç«é€‰è€Œäº§ç”Ÿçš„å¤„ç†æ‰€æœ‰æ•°æ®æäº¤çš„èŠ‚ç‚¹ã€‚ Followerï¼šç«é€‰å¤±è´¥çš„èŠ‚ç‚¹ä½œä¸º Raft ä¸­çš„ä»å±èŠ‚ç‚¹ï¼Œä¸ºç®—æ³•æä¾›å¼ºä¸€è‡´æ€§ä¿è¯ã€‚ Candidateï¼šå½“ Follower è¶…è¿‡ä¸€å®šæ—¶é—´æ¥æ”¶ä¸åˆ° Leader çš„å¿ƒè·³æ—¶è½¬å˜ä¸º Candidate å¼€å§‹ç«é€‰ã€‚ Termï¼šæŸä¸ªèŠ‚ç‚¹æˆä¸º Leader åˆ°ä¸‹ä¸€æ¬¡ç«é€‰æ—¶é—´ï¼Œç§°ä¸ºä¸€ä¸ª Termã€‚ Indexï¼šæ•°æ®é¡¹ç¼–å·ã€‚Raft ä¸­é€šè¿‡ Term å’Œ Index æ¥å®šä½æ•°æ®ã€‚ ETCD æ•°æ®å­˜å‚¨etcd çš„å­˜å‚¨åˆ†ä¸ºå†…å­˜å­˜å‚¨å’ŒæŒä¹…åŒ–ï¼ˆç¡¬ç›˜ï¼‰å­˜å‚¨ä¸¤éƒ¨åˆ†ï¼Œå†…å­˜ä¸­çš„å­˜å‚¨é™¤äº†é¡ºåºåŒ–çš„è®°å½•ä¸‹æ‰€æœ‰ç”¨æˆ·å¯¹èŠ‚ç‚¹æ•°æ®å˜æ›´çš„è®°å½•å¤–ï¼Œè¿˜ä¼šå¯¹ç”¨æˆ·æ•°æ®è¿›è¡Œç´¢å¼•ã€å»ºå †ç­‰æ–¹ä¾¿æŸ¥è¯¢çš„æ“ä½œã€‚è€ŒæŒä¹…åŒ–åˆ™ä½¿ç”¨é¢„å†™å¼æ—¥å¿—ï¼ˆWALï¼šWrite Ahead Logï¼‰è¿›è¡Œè®°å½•å­˜å‚¨ã€‚ åœ¨ WAL çš„ä½“ç³»ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®åœ¨æäº¤ä¹‹å‰éƒ½ä¼šè¿›è¡Œæ—¥å¿—è®°å½•ã€‚åœ¨ etcd çš„æŒä¹…åŒ–å­˜å‚¨ç›®å½•ä¸­ï¼Œæœ‰ä¸¤ä¸ªå­ç›®å½•ã€‚ä¸€ä¸ªæ˜¯ WALï¼Œå­˜å‚¨ç€æ‰€æœ‰äº‹åŠ¡çš„å˜åŒ–è®°å½•ï¼›å¦ä¸€ä¸ªåˆ™æ˜¯ snapshotï¼Œç”¨äºå­˜å‚¨æŸä¸€ä¸ªæ—¶åˆ» etcd æ‰€æœ‰ç›®å½•çš„æ•°æ®ã€‚é€šè¿‡ WAL å’Œ snapshot ç›¸ç»“åˆçš„æ–¹å¼ï¼Œetcd å¯ä»¥æœ‰æ•ˆçš„è¿›è¡Œæ•°æ®å­˜å‚¨å’ŒèŠ‚ç‚¹æ•…éšœæ¢å¤ç­‰æ“ä½œã€‚ æ—¢ç„¶æœ‰äº† WAL å®æ—¶å­˜å‚¨äº†æ‰€æœ‰çš„å˜æ›´ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ snapshot å‘¢ï¼Ÿéšç€ä½¿ç”¨é‡çš„å¢åŠ ï¼ŒWAL å­˜å‚¨çš„æ•°æ®ä¼šæš´å¢ï¼Œä¸ºäº†é˜²æ­¢ç£ç›˜å¾ˆå¿«å°±çˆ†æ»¡ï¼Œetcd é»˜è®¤æ¯ 10000 æ¡è®°å½•åšä¸€æ¬¡ snapshotï¼Œç»è¿‡ snapshot ä»¥åçš„ WAL æ–‡ä»¶å°±å¯ä»¥åˆ é™¤ã€‚è€Œé€šè¿‡ API å¯ä»¥æŸ¥è¯¢çš„å†å² etcd æ“ä½œé»˜è®¤ä¸º 1000 æ¡ã€‚ é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œetcd ä¼šæŠŠå¯åŠ¨çš„é…ç½®ä¿¡æ¯å­˜å‚¨åˆ° data-dir å‚æ•°æŒ‡å®šçš„æ•°æ®ç›®å½•ä¸­ã€‚é…ç½®ä¿¡æ¯åŒ…æ‹¬æœ¬åœ°èŠ‚ç‚¹çš„ IDã€é›†ç¾¤ ID å’Œåˆå§‹æ—¶é›†ç¾¤ä¿¡æ¯ã€‚ç”¨æˆ·éœ€è¦é¿å… etcd ä»ä¸€ä¸ªè¿‡æœŸçš„æ•°æ®ç›®å½•ä¸­é‡æ–°å¯åŠ¨ï¼Œå› ä¸ºä½¿ç”¨è¿‡æœŸçš„æ•°æ®ç›®å½•å¯åŠ¨çš„èŠ‚ç‚¹ä¼šä¸é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹äº§ç”Ÿä¸ä¸€è‡´ï¼ˆå¦‚ï¼šä¹‹å‰å·²ç»è®°å½•å¹¶åŒæ„ Leader èŠ‚ç‚¹å­˜å‚¨æŸä¸ªä¿¡æ¯ï¼Œé‡å¯ååˆå‘ Leader èŠ‚ç‚¹ç”³è¯·è¿™ä¸ªä¿¡æ¯ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸ºäº†æœ€å¤§åŒ–é›†ç¾¤çš„å®‰å…¨æ€§ï¼Œä¸€æ—¦æœ‰ä»»ä½•æ•°æ®æŸåæˆ–ä¸¢å¤±çš„å¯èƒ½æ€§ï¼Œä½ å°±åº”è¯¥æŠŠè¿™ä¸ªèŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤ï¼Œç„¶ååŠ å…¥ä¸€ä¸ªä¸å¸¦æ•°æ®ç›®å½•çš„æ–°èŠ‚ç‚¹ã€‚ é¢„å†™å¼æ—¥å¿—ï¼ˆWALï¼‰WALï¼ˆWrite Ahead Logï¼‰æœ€å¤§çš„ä½œç”¨æ˜¯è®°å½•äº†æ•´ä¸ªæ•°æ®å˜åŒ–çš„å…¨éƒ¨å†ç¨‹ã€‚åœ¨ etcd ä¸­ï¼Œæ‰€æœ‰æ•°æ®çš„ä¿®æ”¹åœ¨æäº¤å‰ï¼Œéƒ½è¦å…ˆå†™å…¥åˆ° WAL ä¸­ã€‚ä½¿ç”¨ WAL è¿›è¡Œæ•°æ®çš„å­˜å‚¨ä½¿å¾— etcd æ‹¥æœ‰ä¸¤ä¸ªé‡è¦åŠŸèƒ½ã€‚ æ•…éšœå¿«é€Ÿæ¢å¤ï¼š å½“ä½ çš„æ•°æ®é­åˆ°ç ´åæ—¶ï¼Œå°±å¯ä»¥é€šè¿‡æ‰§è¡Œæ‰€æœ‰ WAL ä¸­è®°å½•çš„ä¿®æ”¹æ“ä½œï¼Œå¿«é€Ÿä»æœ€åŸå§‹çš„æ•°æ®æ¢å¤åˆ°æ•°æ®æŸåå‰çš„çŠ¶æ€ã€‚ æ•°æ®å›æ»šï¼ˆundoï¼‰/é‡åšï¼ˆredoï¼‰ï¼šå› ä¸ºæ‰€æœ‰çš„ä¿®æ”¹æ“ä½œéƒ½è¢«è®°å½•åœ¨ WAL ä¸­ï¼Œéœ€è¦å›æ»šæˆ–é‡åšï¼Œåªéœ€è¦æ–¹å‘æˆ–æ­£å‘æ‰§è¡Œæ—¥å¿—ä¸­çš„æ“ä½œå³å¯ã€‚ WAL ä¸ snapshot åœ¨ etcd ä¸­çš„å‘½åè§„åˆ™åœ¨ etcd çš„æ•°æ®ç›®å½•ä¸­ï¼ŒWAL æ–‡ä»¶ä»¥$seq-$index.wal çš„æ ¼å¼å­˜å‚¨ã€‚æœ€åˆå§‹çš„ WAL æ–‡ä»¶æ˜¯ 0000000000000000-0000000000000000.walï¼Œè¡¨ç¤ºæ˜¯æ‰€æœ‰ WAL æ–‡ä»¶ä¸­çš„ç¬¬ 0 ä¸ªï¼Œåˆå§‹çš„ Raft çŠ¶æ€ç¼–å·ä¸º 0ã€‚è¿è¡Œä¸€æ®µæ—¶é—´åå¯èƒ½éœ€è¦è¿›è¡Œæ—¥å¿—åˆ‡åˆ†ï¼ŒæŠŠæ–°çš„æ¡ç›®æ”¾åˆ°ä¸€ä¸ªæ–°çš„ WAL æ–‡ä»¶ä¸­ã€‚ å‡è®¾ï¼Œå½“é›†ç¾¤è¿è¡Œåˆ° Raft çŠ¶æ€ä¸º 20 æ—¶ï¼Œéœ€è¦è¿›è¡Œ WAL æ–‡ä»¶çš„åˆ‡åˆ†æ—¶ï¼Œä¸‹ä¸€ä»½ WAL æ–‡ä»¶å°±ä¼šå˜ä¸º 0000000000000001-0000000000000021.walã€‚å¦‚æœåœ¨ 10 æ¬¡æ“ä½œååˆè¿›è¡Œäº†ä¸€æ¬¡æ—¥å¿—åˆ‡åˆ†ï¼Œé‚£ä¹ˆåä¸€æ¬¡çš„ WAL æ–‡ä»¶åä¼šå˜ä¸º 0000000000000002-0000000000000031.walã€‚å¯ä»¥çœ‹åˆ°-ç¬¦å·å‰é¢çš„æ•°å­—æ˜¯æ¯æ¬¡åˆ‡åˆ†åè‡ªå¢ 1ï¼Œè€Œ-ç¬¦å·åé¢çš„æ•°å­—åˆ™æ˜¯æ ¹æ®å®é™…å­˜å‚¨çš„ Raft èµ·å§‹çŠ¶æ€æ¥å®šã€‚ snapshot çš„å­˜å‚¨å‘½ååˆ™æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä»¥$term-$index.wal æ ¼å¼è¿›è¡Œå‘½åå­˜å‚¨ã€‚term å’Œ index å°±è¡¨ç¤ºå­˜å‚¨ snapshot æ—¶æ•°æ®æ‰€åœ¨çš„ raft èŠ‚ç‚¹çŠ¶æ€ï¼Œå½“å‰çš„ä»»æœŸç¼–å·ä»¥åŠæ•°æ®é¡¹ä½ç½®ä¿¡æ¯ã€‚ å…³é”®éƒ¨åˆ†æºç è§£æä»ä»£ç é€»è¾‘ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒWAL æœ‰ä¸¤ç§æ¨¡å¼ï¼Œè¯»æ¨¡å¼ï¼ˆreadï¼‰å’Œæ•°æ®æ·»åŠ ï¼ˆappendï¼‰æ¨¡å¼ï¼Œä¸¤ç§æ¨¡å¼ä¸èƒ½åŒæ—¶æˆç«‹ã€‚ä¸€ä¸ªæ–°åˆ›å»ºçš„ WAL æ–‡ä»¶å¤„äº append æ¨¡å¼ï¼Œå¹¶ä¸”ä¸ä¼šè¿›å…¥åˆ° read æ¨¡å¼ã€‚ä¸€ä¸ªæœ¬æ¥å­˜åœ¨çš„ WAL æ–‡ä»¶è¢«æ‰“å¼€çš„æ—¶å€™å¿…ç„¶æ˜¯ read æ¨¡å¼ï¼Œå¹¶ä¸”åªæœ‰åœ¨æ‰€æœ‰è®°å½•éƒ½è¢«è¯»å®Œçš„æ—¶å€™ï¼Œæ‰èƒ½è¿›å…¥ append æ¨¡å¼ï¼Œè¿›å…¥ append æ¨¡å¼åä¹Ÿä¸ä¼šå†è¿›å…¥ read æ¨¡å¼ã€‚è¿™æ ·åšæœ‰åŠ©äºä¿è¯æ•°æ®çš„å®Œæ•´ä¸å‡†ç¡®ã€‚ é›†ç¾¤åœ¨è¿›å…¥åˆ° etcdserver/server.go çš„ NewServer å‡½æ•°å‡†å¤‡å¯åŠ¨ä¸€ä¸ª etcd èŠ‚ç‚¹æ—¶ï¼Œä¼šæ£€æµ‹æ˜¯å¦å­˜åœ¨ä»¥å‰çš„é—ç•™ WAL æ•°æ®ã€‚ æ£€æµ‹çš„ç¬¬ä¸€æ­¥æ˜¯æŸ¥çœ‹ snapshot æ–‡ä»¶å¤¹ä¸‹æ˜¯å¦æœ‰ç¬¦åˆè§„èŒƒçš„æ–‡ä»¶ï¼Œè‹¥æ£€æµ‹åˆ° snapshot æ ¼å¼æ˜¯ v0.4 çš„ï¼Œåˆ™è°ƒç”¨å‡½æ•°å‡çº§åˆ° v0.5ã€‚ä» snapshot ä¸­è·å¾—é›†ç¾¤çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ tokenã€å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯ç­‰ç­‰ï¼Œç„¶åè½½å…¥ WAL ç›®å½•çš„å†…å®¹ï¼Œä»å°åˆ°å¤§è¿›è¡Œæ’åºã€‚æ ¹æ® snapshot ä¸­å¾—åˆ°çš„ term å’Œ indexï¼Œæ‰¾åˆ° WAL ç´§æ¥ç€ snapshot ä¸‹ä¸€æ¡çš„è®°å½•ï¼Œç„¶åå‘åæ›´æ–°ï¼Œç›´åˆ°æ‰€æœ‰ WAL åŒ…çš„ entry éƒ½å·²ç»éå†å®Œæ¯•ï¼ŒEntry è®°å½•åˆ° ents å˜é‡ä¸­å­˜å‚¨åœ¨å†…å­˜é‡Œã€‚æ­¤æ—¶ WAL å°±è¿›å…¥ append æ¨¡å¼ï¼Œä¸ºæ•°æ®é¡¹æ·»åŠ è¿›è¡Œå‡†å¤‡ã€‚ å½“ WAL æ–‡ä»¶ä¸­æ•°æ®é¡¹å†…å®¹è¿‡å¤§è¾¾åˆ°è®¾å®šå€¼ï¼ˆé»˜è®¤ä¸º 10000ï¼‰æ—¶ï¼Œä¼šè¿›è¡Œ WAL çš„åˆ‡åˆ†ï¼ŒåŒæ—¶è¿›è¡Œ snapshot æ“ä½œã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åœ¨ etcdserver/server.go çš„ snapshot å‡½æ•°ä¸­çœ‹åˆ°ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šæ•°æ®ç›®å½•ä¸­æœ‰ç”¨çš„ snapshot å’Œ WAL æ–‡ä»¶å„åªæœ‰ä¸€ä¸ªï¼Œé»˜è®¤æƒ…å†µä¸‹ etcd ä¼šå„ä¿ç•™ 5 ä¸ªå†å²æ–‡ä»¶ã€‚ ä½¿ç”¨åœºæ™¯é›†åˆæœåŠ¡å‘ç°å’Œæ³¨å†Œï¼ˆService Discoveryï¼‰æœåŠ¡å‘ç°è¦è§£å†³çš„ä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ï¼Œå³åœ¨åŒä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤ä¸­çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œè¦å¦‚ä½•æ‰èƒ½æ‰¾åˆ°å¯¹æ–¹å¹¶å»ºç«‹è¿æ¥ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒæœåŠ¡å‘ç°å°±æ˜¯æƒ³è¦äº†è§£é›†ç¾¤ä¸­æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç›‘å¬ udp æˆ– tcp ç«¯å£ï¼Œå¹¶ä¸”é€šè¿‡åå­—å°±å¯ä»¥æŸ¥æ‰¾å’Œè¿æ¥ã€‚è¦è§£å†³æœåŠ¡å‘ç°çš„é—®é¢˜ï¼Œéœ€è¦æœ‰ä¸‹é¢ä¸‰å¤§æ”¯æŸ±ï¼Œç¼ºä¸€ä¸å¯ã€‚ ä¸€ä¸ªå¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•ã€‚åŸºäº Raft ç®—æ³•çš„ etcd å¤©ç”Ÿå°±æ˜¯è¿™æ ·ä¸€ä¸ªå¼ºä¸€è‡´æ€§é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•ã€‚ ä¸€ç§æ³¨å†ŒæœåŠ¡å’Œç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€çš„æœºåˆ¶ã€‚ç”¨æˆ·å¯ä»¥åœ¨ etcd ä¸­æ³¨å†ŒæœåŠ¡ï¼Œå¹¶ä¸”å¯¹æ³¨å†Œçš„æœåŠ¡è®¾ç½® key TTLï¼Œå®šæ—¶ä¿æŒæœåŠ¡çš„å¿ƒè·³ä»¥è¾¾åˆ°ç›‘æ§å¥åº·çŠ¶æ€çš„æ•ˆæœã€‚ ä¸€ç§æŸ¥æ‰¾å’Œè¿æ¥æœåŠ¡çš„æœºåˆ¶ã€‚é€šè¿‡åœ¨ etcd æŒ‡å®šçš„ä¸»é¢˜ä¸‹æ³¨å†Œçš„æœåŠ¡ä¹Ÿèƒ½åœ¨å¯¹åº”çš„ä¸»é¢˜ä¸‹æŸ¥æ‰¾åˆ°ã€‚ä¸ºäº†ç¡®ä¿è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªæœåŠ¡æœºå™¨ä¸Šéƒ½éƒ¨ç½²ä¸€ä¸ª Proxy æ¨¡å¼çš„ etcdï¼Œè¿™æ ·å°±å¯ä»¥ç¡®ä¿èƒ½è®¿é—® etcd é›†ç¾¤çš„æœåŠ¡éƒ½èƒ½äº’ç›¸è¿æ¥ã€‚ æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæœ€é€‚ç”¨çš„ä¸€ç§ç»„ä»¶é—´é€šä¿¡æ–¹å¼å°±æ˜¯æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…ã€‚å³æ„å»ºä¸€ä¸ªé…ç½®å…±äº«ä¸­å¿ƒï¼Œæ•°æ®æä¾›è€…åœ¨è¿™ä¸ªé…ç½®ä¸­å¿ƒå‘å¸ƒæ¶ˆæ¯ï¼Œè€Œæ¶ˆæ¯ä½¿ç”¨è€…åˆ™è®¢é˜…ä»–ä»¬å…³å¿ƒçš„ä¸»é¢˜ï¼Œä¸€æ—¦ä¸»é¢˜æœ‰æ¶ˆæ¯å‘å¸ƒï¼Œå°±ä¼šå®æ—¶é€šçŸ¥è®¢é˜…è€…ã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥åšåˆ°åˆ†å¸ƒå¼ç³»ç»Ÿé…ç½®çš„é›†ä¸­å¼ç®¡ç†ä¸åŠ¨æ€æ›´æ–°ã€‚ åº”ç”¨ä¸­ç”¨åˆ°çš„ä¸€äº›é…ç½®ä¿¡æ¯æ”¾åˆ° etcd ä¸Šè¿›è¡Œé›†ä¸­ç®¡ç†ã€‚è¿™ç±»åœºæ™¯çš„ä½¿ç”¨æ–¹å¼é€šå¸¸æ˜¯è¿™æ ·ï¼šåº”ç”¨åœ¨å¯åŠ¨çš„æ—¶å€™ä¸»åŠ¨ä» etcd è·å–ä¸€æ¬¡é…ç½®ä¿¡æ¯ï¼ŒåŒæ—¶ï¼Œåœ¨ etcd èŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€ä¸ª Watcher å¹¶ç­‰å¾…ï¼Œä»¥åæ¯æ¬¡é…ç½®æœ‰æ›´æ–°çš„æ—¶å€™ï¼Œetcd éƒ½ä¼šå®æ—¶é€šçŸ¥è®¢é˜…è€…ï¼Œä»¥æ­¤è¾¾åˆ°è·å–æœ€æ–°é…ç½®ä¿¡æ¯çš„ç›®çš„ã€‚ åˆ†å¸ƒå¼æœç´¢æœåŠ¡ä¸­ï¼Œç´¢å¼•çš„å…ƒä¿¡æ¯å’ŒæœåŠ¡å™¨é›†ç¾¤æœºå™¨çš„èŠ‚ç‚¹çŠ¶æ€å­˜æ”¾åœ¨ etcd ä¸­ï¼Œä¾›å„ä¸ªå®¢æˆ·ç«¯è®¢é˜…ä½¿ç”¨ã€‚ä½¿ç”¨ etcd çš„ key TTL åŠŸèƒ½å¯ä»¥ç¡®ä¿æœºå™¨çŠ¶æ€æ˜¯å®æ—¶æ›´æ–°çš„ã€‚ åˆ†å¸ƒå¼æ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚è¿™ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒå·¥ä½œæ˜¯æ”¶é›†åˆ†å¸ƒåœ¨ä¸åŒæœºå™¨çš„æ—¥å¿—ã€‚æ”¶é›†å™¨é€šå¸¸æ˜¯æŒ‰ç…§åº”ç”¨ï¼ˆæˆ–ä¸»é¢˜ï¼‰æ¥åˆ†é…æ”¶é›†ä»»åŠ¡å•å…ƒï¼Œå› æ­¤å¯ä»¥åœ¨ etcd ä¸Šåˆ›å»ºä¸€ä¸ªä»¥åº”ç”¨ï¼ˆä¸»é¢˜ï¼‰å‘½åçš„ç›®å½• Pï¼Œå¹¶å°†è¿™ä¸ªåº”ç”¨ï¼ˆä¸»é¢˜ç›¸å…³ï¼‰çš„æ‰€æœ‰æœºå™¨ ipï¼Œä»¥å­ç›®å½•çš„å½¢å¼å­˜å‚¨åˆ°ç›®å½• P ä¸Šï¼Œç„¶åè®¾ç½®ä¸€ä¸ª etcd é€’å½’çš„ Watcherï¼Œé€’å½’å¼çš„ç›‘æ§åº”ç”¨ï¼ˆä¸»é¢˜ï¼‰ç›®å½•ä¸‹æ‰€æœ‰ä¿¡æ¯çš„å˜åŠ¨ã€‚è¿™æ ·å°±å®ç°äº†æœºå™¨ IPï¼ˆæ¶ˆæ¯ï¼‰å˜åŠ¨çš„æ—¶å€™ï¼Œèƒ½å¤Ÿå®æ—¶é€šçŸ¥åˆ°æ”¶é›†å™¨è°ƒæ•´ä»»åŠ¡åˆ†é…ã€‚ ç³»ç»Ÿä¸­ä¿¡æ¯éœ€è¦åŠ¨æ€è‡ªåŠ¨è·å–ä¸äººå·¥å¹²é¢„ä¿®æ”¹ä¿¡æ¯è¯·æ±‚å†…å®¹çš„æƒ…å†µã€‚é€šå¸¸æ˜¯æš´éœ²å‡ºæ¥å£ï¼Œä¾‹å¦‚ JMX æ¥å£ï¼Œæ¥è·å–ä¸€äº›è¿è¡Œæ—¶çš„ä¿¡æ¯ã€‚å¼•å…¥ etcd ä¹‹åï¼Œå°±ä¸ç”¨è‡ªå·±å®ç°ä¸€å¥—æ–¹æ¡ˆäº†ï¼Œåªè¦å°†è¿™äº›ä¿¡æ¯å­˜æ”¾åˆ°æŒ‡å®šçš„ etcd ç›®å½•ä¸­å³å¯ï¼Œetcd çš„è¿™äº›ç›®å½•å°±å¯ä»¥é€šè¿‡ HTTP çš„æ¥å£åœ¨å¤–éƒ¨è®¿é—®ã€‚ è´Ÿè½½å‡è¡¡åœ¨åœºæ™¯ä¸€ä¸­ä¹Ÿæåˆ°äº†è´Ÿè½½å‡è¡¡ï¼Œæœ¬æ–‡æ‰€æŒ‡çš„è´Ÿè½½å‡è¡¡å‡ä¸ºè½¯è´Ÿè½½å‡è¡¡ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸ºäº†ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨ä»¥åŠæ•°æ®çš„ä¸€è‡´æ€§ï¼Œé€šå¸¸éƒ½ä¼šæŠŠæ•°æ®å’ŒæœåŠ¡éƒ¨ç½²å¤šä»½ï¼Œä»¥æ­¤è¾¾åˆ°å¯¹ç­‰æœåŠ¡ï¼Œå³ä½¿å…¶ä¸­çš„æŸä¸€ä¸ªæœåŠ¡å¤±æ•ˆäº†ï¼Œä¹Ÿä¸å½±å“ä½¿ç”¨ã€‚ç”±æ­¤å¸¦æ¥çš„åå¤„æ˜¯æ•°æ®å†™å…¥æ€§èƒ½ä¸‹é™ï¼Œè€Œå¥½å¤„åˆ™æ˜¯æ•°æ®è®¿é—®æ—¶çš„è´Ÿè½½å‡è¡¡ã€‚å› ä¸ºæ¯ä¸ªå¯¹ç­‰æœåŠ¡èŠ‚ç‚¹ä¸Šéƒ½å­˜æœ‰å®Œæ•´çš„æ•°æ®ï¼Œæ‰€ä»¥ç”¨æˆ·çš„è®¿é—®æµé‡å°±å¯ä»¥åˆ†æµåˆ°ä¸åŒçš„æœºå™¨ä¸Šã€‚ etcd æœ¬èº«åˆ†å¸ƒå¼æ¶æ„å­˜å‚¨çš„ä¿¡æ¯è®¿é—®æ”¯æŒè´Ÿè½½å‡è¡¡ã€‚etcd é›†ç¾¤åŒ–ä»¥åï¼Œæ¯ä¸ª etcd çš„æ ¸å¿ƒèŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ã€‚æ‰€ä»¥ï¼ŒæŠŠæ•°æ®é‡å°ä½†æ˜¯è®¿é—®é¢‘ç¹çš„æ¶ˆæ¯æ•°æ®ç›´æ¥å­˜å‚¨åˆ° etcd ä¸­ä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œå¦‚ä¸šåŠ¡ç³»ç»Ÿä¸­å¸¸ç”¨çš„äºŒçº§ä»£ç è¡¨ï¼ˆåœ¨è¡¨ä¸­å­˜å‚¨ä»£ç ï¼Œåœ¨ etcd ä¸­å­˜å‚¨ä»£ç æ‰€ä»£è¡¨çš„å…·ä½“å«ä¹‰ï¼Œä¸šåŠ¡ç³»ç»Ÿè°ƒç”¨æŸ¥è¡¨çš„è¿‡ç¨‹ï¼Œå°±éœ€è¦æŸ¥æ‰¾è¡¨ä¸­ä»£ç çš„å«ä¹‰ï¼‰ã€‚ åˆ©ç”¨ etcd ç»´æŠ¤ä¸€ä¸ªè´Ÿè½½å‡è¡¡èŠ‚ç‚¹è¡¨ã€‚etcd å¯ä»¥ç›‘æ§ä¸€ä¸ªé›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå½“æœ‰ä¸€ä¸ªè¯·æ±‚å‘è¿‡æ¥åï¼Œå¯ä»¥è½®è¯¢å¼çš„æŠŠè¯·æ±‚è½¬å‘ç»™å­˜æ´»ç€çš„å¤šä¸ªçŠ¶æ€ã€‚ç±»ä¼¼ Kafkaï¼Œé€šè¿‡ ZooKeeper æ¥ç»´æŠ¤ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„è´Ÿè½½å‡è¡¡ã€‚åŒæ ·ä¹Ÿå¯ä»¥ç”¨ etcd æ¥åš ZooKeeper çš„å·¥ä½œ åˆ†å¸ƒå¼é€šçŸ¥ä¸åè°ƒè¿™é‡Œè¯´åˆ°çš„åˆ†å¸ƒå¼é€šçŸ¥ä¸åè°ƒï¼Œä¸æ¶ˆæ¯å‘å¸ƒå’Œè®¢é˜…æœ‰äº›ç›¸ä¼¼ã€‚éƒ½ç”¨åˆ°äº† etcd ä¸­çš„ Watcher æœºåˆ¶ï¼Œé€šè¿‡æ³¨å†Œä¸å¼‚æ­¥é€šçŸ¥æœºåˆ¶ï¼Œå®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸åŒç³»ç»Ÿä¹‹é—´çš„é€šçŸ¥ä¸åè°ƒï¼Œä»è€Œå¯¹æ•°æ®å˜æ›´åšåˆ°å®æ—¶å¤„ç†ã€‚å®ç°æ–¹å¼é€šå¸¸æ˜¯è¿™æ ·ï¼šä¸åŒç³»ç»Ÿéƒ½åœ¨ etcd ä¸Šå¯¹åŒä¸€ä¸ªç›®å½•è¿›è¡Œæ³¨å†Œï¼ŒåŒæ—¶è®¾ç½® Watcher è§‚æµ‹è¯¥ç›®å½•çš„å˜åŒ–ï¼ˆå¦‚æœå¯¹å­ç›®å½•çš„å˜åŒ–ä¹Ÿæœ‰éœ€è¦ï¼Œå¯ä»¥è®¾ç½®é€’å½’æ¨¡å¼ï¼‰ï¼Œå½“æŸä¸ªç³»ç»Ÿæ›´æ–°äº† etcd çš„ç›®å½•ï¼Œé‚£ä¹ˆè®¾ç½®äº† Watcher çš„ç³»ç»Ÿå°±ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¹¶ä½œå‡ºç›¸åº”å¤„ç†ã€‚ é€šè¿‡ etcd è¿›è¡Œä½è€¦åˆçš„å¿ƒè·³æ£€æµ‹ã€‚æ£€æµ‹ç³»ç»Ÿå’Œè¢«æ£€æµ‹ç³»ç»Ÿé€šè¿‡ etcd ä¸ŠæŸä¸ªç›®å½•å…³è”è€Œéç›´æ¥å…³è”èµ·æ¥ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘ç³»ç»Ÿçš„è€¦åˆæ€§ã€‚ é€šè¿‡ etcd å®Œæˆç³»ç»Ÿè°ƒåº¦ã€‚æŸç³»ç»Ÿæœ‰æ§åˆ¶å°å’Œæ¨é€ç³»ç»Ÿä¸¤éƒ¨åˆ†ç»„æˆï¼Œæ§åˆ¶å°çš„èŒè´£æ˜¯æ§åˆ¶æ¨é€ç³»ç»Ÿè¿›è¡Œç›¸åº”çš„æ¨é€å·¥ä½œã€‚ç®¡ç†äººå‘˜åœ¨æ§åˆ¶å°ä½œçš„ä¸€äº›æ“ä½œï¼Œå®é™…ä¸Šæ˜¯ä¿®æ”¹äº† etcd ä¸ŠæŸäº›ç›®å½•èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œè€Œ etcd å°±æŠŠè¿™äº›å˜åŒ–é€šçŸ¥ç»™æ³¨å†Œäº† Watcher çš„æ¨é€ç³»ç»Ÿå®¢æˆ·ç«¯ï¼Œæ¨é€ç³»ç»Ÿå†ä½œå‡ºç›¸åº”çš„æ¨é€ä»»åŠ¡ã€‚ é€šè¿‡ etcd å®Œæˆå·¥ä½œæ±‡æŠ¥ã€‚å¤§éƒ¨åˆ†ç±»ä¼¼çš„ä»»åŠ¡åˆ†å‘ç³»ç»Ÿï¼Œå­ä»»åŠ¡å¯åŠ¨åï¼Œåˆ° etcd æ¥æ³¨å†Œä¸€ä¸ªä¸´æ—¶å·¥ä½œç›®å½•ï¼Œå¹¶ä¸”å®šæ—¶å°†è‡ªå·±çš„è¿›åº¦è¿›è¡Œæ±‡æŠ¥ï¼ˆå°†è¿›åº¦å†™å…¥åˆ°è¿™ä¸ªä¸´æ—¶ç›®å½•ï¼‰ï¼Œè¿™æ ·ä»»åŠ¡ç®¡ç†è€…å°±èƒ½å¤Ÿå®æ—¶çŸ¥é“ä»»åŠ¡è¿›åº¦ã€‚ åˆ†å¸ƒå¼é”å› ä¸º etcd ä½¿ç”¨ Raft ç®—æ³•ä¿æŒäº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼ŒæŸæ¬¡æ“ä½œå­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å€¼å¿…ç„¶æ˜¯å…¨å±€ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å®ç°åˆ†å¸ƒå¼é”ã€‚é”æœåŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€æ˜¯ä¿æŒç‹¬å ï¼ŒäºŒæ˜¯æ§åˆ¶æ—¶åºã€‚ ä¿æŒç‹¬å å³æ‰€æœ‰è·å–é”çš„ç”¨æˆ·æœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥å¾—åˆ°ã€‚etcd ä¸ºæ­¤æä¾›äº†ä¸€å¥—å®ç°åˆ†å¸ƒå¼é”åŸå­æ“ä½œ CASï¼ˆCompareAndSwapï¼‰çš„ APIã€‚é€šè¿‡è®¾ç½® prevExist å€¼ï¼Œå¯ä»¥ä¿è¯åœ¨å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å»åˆ›å»ºæŸä¸ªç›®å½•æ—¶ï¼Œåªæœ‰ä¸€ä¸ªæˆåŠŸã€‚è€Œåˆ›å»ºæˆåŠŸçš„ç”¨æˆ·å°±å¯ä»¥è®¤ä¸ºæ˜¯è·å¾—äº†é”ã€‚ æ§åˆ¶æ—¶åºï¼Œå³æ‰€æœ‰æƒ³è¦è·å¾—é”çš„ç”¨æˆ·éƒ½ä¼šè¢«å®‰æ’æ‰§è¡Œï¼Œä½†æ˜¯è·å¾—é”çš„é¡ºåºä¹Ÿæ˜¯å…¨å±€å”¯ä¸€çš„ï¼ŒåŒæ—¶å†³å®šäº†æ‰§è¡Œé¡ºåºã€‚etcd ä¸ºæ­¤ä¹Ÿæä¾›äº†ä¸€å¥— APIï¼ˆè‡ªåŠ¨åˆ›å»ºæœ‰åºé”®ï¼‰ï¼Œå¯¹ä¸€ä¸ªç›®å½•å»ºå€¼æ—¶æŒ‡å®šä¸º POST åŠ¨ä½œï¼Œè¿™æ · etcd ä¼šè‡ªåŠ¨åœ¨ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå½“å‰æœ€å¤§çš„å€¼ä¸ºé”®ï¼Œå­˜å‚¨è¿™ä¸ªæ–°çš„å€¼ï¼ˆå®¢æˆ·ç«¯ç¼–å·ï¼‰ã€‚åŒæ—¶è¿˜å¯ä»¥ä½¿ç”¨ API æŒ‰é¡ºåºåˆ—å‡ºæ‰€æœ‰å½“å‰ç›®å½•ä¸‹çš„é”®å€¼ã€‚æ­¤æ—¶è¿™äº›é”®çš„å€¼å°±æ˜¯å®¢æˆ·ç«¯çš„æ—¶åºï¼Œè€Œè¿™äº›é”®ä¸­å­˜å‚¨çš„å€¼å¯ä»¥æ˜¯ä»£è¡¨å®¢æˆ·ç«¯çš„ç¼–å·ã€‚ åˆ†å¸ƒå¼é˜Ÿåˆ—åˆ†å¸ƒå¼é˜Ÿåˆ—çš„å¸¸è§„ç”¨æ³•ä¸åœºæ™¯äº”ä¸­æ‰€æè¿°çš„åˆ†å¸ƒå¼é”çš„æ§åˆ¶æ—¶åºç”¨æ³•ç±»ä¼¼ï¼Œå³åˆ›å»ºä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œä¿è¯é¡ºåºã€‚ å¦ä¸€ç§æ¯”è¾ƒæœ‰æ„æ€çš„å®ç°æ˜¯åœ¨ä¿è¯é˜Ÿåˆ—è¾¾åˆ°æŸä¸ªæ¡ä»¶æ—¶å†ç»Ÿä¸€æŒ‰é¡ºåºæ‰§è¡Œã€‚è¿™ç§æ–¹æ³•çš„å®ç°å¯ä»¥åœ¨/queue è¿™ä¸ªç›®å½•ä¸­å¦å¤–å»ºç«‹ä¸€ä¸ª/queue/condition èŠ‚ç‚¹ã€‚ condition å¯ä»¥è¡¨ç¤ºé˜Ÿåˆ—å¤§å°ã€‚æ¯”å¦‚ä¸€ä¸ªå¤§çš„ä»»åŠ¡éœ€è¦å¾ˆå¤šå°ä»»åŠ¡å°±ç»ªçš„æƒ…å†µä¸‹æ‰èƒ½æ‰§è¡Œï¼Œæ¯æ¬¡æœ‰ä¸€ä¸ªå°ä»»åŠ¡å°±ç»ªï¼Œå°±ç»™è¿™ä¸ª condition æ•°å­—åŠ  1ï¼Œç›´åˆ°è¾¾åˆ°å¤§ä»»åŠ¡è§„å®šçš„æ•°å­—ï¼Œå†å¼€å§‹æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä¸€ç³»åˆ—å°ä»»åŠ¡ï¼Œæœ€ç»ˆæ‰§è¡Œå¤§ä»»åŠ¡ã€‚ condition å¯ä»¥è¡¨ç¤ºæŸä¸ªä»»åŠ¡åœ¨ä¸åœ¨é˜Ÿåˆ—ã€‚è¿™ä¸ªä»»åŠ¡å¯ä»¥æ˜¯æ‰€æœ‰æ’åºä»»åŠ¡çš„é¦–ä¸ªæ‰§è¡Œç¨‹åºï¼Œä¹Ÿå¯ä»¥æ˜¯æ‹“æ‰‘ç»“æ„ä¸­æ²¡æœ‰ä¾èµ–çš„ç‚¹ã€‚é€šå¸¸ï¼Œå¿…é¡»æ‰§è¡Œè¿™äº›ä»»åŠ¡åæ‰èƒ½æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å…¶ä»–ä»»åŠ¡ã€‚ condition è¿˜å¯ä»¥è¡¨ç¤ºå…¶å®ƒçš„ä¸€ç±»å¼€å§‹æ‰§è¡Œä»»åŠ¡çš„é€šçŸ¥ã€‚å¯ä»¥ç”±æ§åˆ¶ç¨‹åºæŒ‡å®šï¼Œå½“ condition å‡ºç°å˜åŒ–æ—¶ï¼Œå¼€å§‹æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ã€‚ é›†ç¾¤ç›‘æ§ä¸ Leader ç«é€‰é€šè¿‡ etcd æ¥è¿›è¡Œç›‘æ§å®ç°èµ·æ¥éå¸¸ç®€å•å¹¶ä¸”å®æ—¶æ€§å¼ºã€‚ å‰é¢å‡ ä¸ªåœºæ™¯å·²ç»æåˆ° Watcher æœºåˆ¶ï¼Œå½“æŸä¸ªèŠ‚ç‚¹æ¶ˆå¤±æˆ–æœ‰å˜åŠ¨æ—¶ï¼ŒWatcher ä¼šç¬¬ä¸€æ—¶é—´å‘ç°å¹¶å‘ŠçŸ¥ç”¨æˆ·ã€‚ èŠ‚ç‚¹å¯ä»¥è®¾ç½® TTL keyï¼Œæ¯”å¦‚æ¯éš” 30s å‘é€ä¸€æ¬¡å¿ƒè·³ä½¿ä»£è¡¨è¯¥æœºå™¨å­˜æ´»çš„èŠ‚ç‚¹ç»§ç»­å­˜åœ¨ï¼Œå¦åˆ™èŠ‚ç‚¹æ¶ˆå¤±ã€‚è¿™æ ·å°±å¯ä»¥ç¬¬ä¸€æ—¶é—´æ£€æµ‹åˆ°å„èŠ‚ç‚¹çš„å¥åº·çŠ¶æ€ï¼Œä»¥å®Œæˆé›†ç¾¤çš„ç›‘æ§è¦æ±‚ã€‚ å¦å¤–ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œå¯ä»¥å®Œæˆ Leader ç«é€‰ã€‚è¿™ç§åœºæ™¯é€šå¸¸æ˜¯ä¸€äº›é•¿æ—¶é—´ CPU è®¡ç®—æˆ–è€…ä½¿ç”¨ IO æ“ä½œçš„æœºå™¨ï¼Œåªéœ€è¦ç«é€‰å‡ºçš„ Leader è®¡ç®—æˆ–å¤„ç†ä¸€æ¬¡ï¼Œå°±å¯ä»¥æŠŠç»“æœå¤åˆ¶ç»™å…¶ä»–çš„ Followerã€‚ä»è€Œé¿å…é‡å¤åŠ³åŠ¨ï¼ŒèŠ‚çœè®¡ç®—èµ„æºã€‚ è¿™ä¸ªçš„ç»å…¸åœºæ™¯æ˜¯æœç´¢ç³»ç»Ÿä¸­å»ºç«‹å…¨é‡ç´¢å¼•ã€‚å¦‚æœæ¯ä¸ªæœºå™¨éƒ½è¿›è¡Œä¸€éç´¢å¼•çš„å»ºç«‹ï¼Œä¸ä½†è€—æ—¶è€Œä¸”å»ºç«‹ç´¢å¼•çš„ä¸€è‡´æ€§ä¸èƒ½ä¿è¯ã€‚é€šè¿‡åœ¨ etcd çš„ CAS æœºåˆ¶åŒæ—¶åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸçš„æœºå™¨ä½œä¸º Leaderï¼Œè¿›è¡Œç´¢å¼•è®¡ç®—ï¼Œç„¶åæŠŠè®¡ç®—ç»“æœåˆ†å‘åˆ°å…¶å®ƒèŠ‚ç‚¹ã€‚ å®æˆ˜æ“ä½œæœåŠ¡å‘ç°å’Œæ³¨å†Œ","categories":[{"name":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","permalink":"http://blog.crazylaw.cn/categories/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"}],"tags":[{"name":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","permalink":"http://blog.crazylaw.cn/tags/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"}]},{"title":"ã€æœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‘- Consul","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°/consul","date":"2019-07-04T03:15:00.000Z","updated":"2021-03-20T16:25:01.818Z","comments":true,"path":"2019/07/04/æœåŠ¡æ³¨å†Œå’Œå‘ç°/consul/","link":"","permalink":"http://blog.crazylaw.cn/2019/07/04/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/","excerpt":"æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°æ˜¯åœ¨åˆ†å¸ƒå¼æœåŠ¡æ¶æ„ä¸­å¸¸å¸¸ä¼šæ¶‰åŠåˆ°çš„ä¸œè¥¿ï¼Œä¸šç•Œå¸¸ç”¨çš„æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°å·¥å…·æœ‰ ZooKeeperã€etcdã€Consul å’Œ Eurekaã€‚Consul çš„ä¸»è¦åŠŸèƒ½æœ‰æœåŠ¡å‘ç°ã€å¥åº·æ£€æŸ¥ã€KV å­˜å‚¨ã€å®‰å…¨æœåŠ¡æ²Ÿé€šå’Œå¤šæ•°æ®ä¸­å¿ƒã€‚Consul ä¸å…¶ä»–å‡ ä¸ªå·¥å…·çš„åŒºåˆ«å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ Consul vs. Other Softwareã€‚","text":"æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°æ˜¯åœ¨åˆ†å¸ƒå¼æœåŠ¡æ¶æ„ä¸­å¸¸å¸¸ä¼šæ¶‰åŠåˆ°çš„ä¸œè¥¿ï¼Œä¸šç•Œå¸¸ç”¨çš„æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°å·¥å…·æœ‰ ZooKeeperã€etcdã€Consul å’Œ Eurekaã€‚Consul çš„ä¸»è¦åŠŸèƒ½æœ‰æœåŠ¡å‘ç°ã€å¥åº·æ£€æŸ¥ã€KV å­˜å‚¨ã€å®‰å…¨æœåŠ¡æ²Ÿé€šå’Œå¤šæ•°æ®ä¸­å¿ƒã€‚Consul ä¸å…¶ä»–å‡ ä¸ªå·¥å…·çš„åŒºåˆ«å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ Consul vs. Other Softwareã€‚ ä¸ºä»€ä¹ˆéœ€è¦æœ‰æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°ï¼Ÿå‡è®¾åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªæœåŠ¡ Service-A ï¼ˆä¸‹æ–‡ä»¥â€œS-Aâ€ä»£ç§°ï¼‰å’Œ Service-Bï¼ˆä¸‹æ–‡ä»¥â€œS-Bâ€ä»£ç§°ï¼‰ï¼Œå½“ S-A æƒ³è°ƒç”¨ S-B æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„æ—¶ç›´æ¥åœ¨ S-A ä¸­è¯·æ±‚ S-B æ‰€åœ¨æœåŠ¡å™¨çš„ IP åœ°å€å’Œç›‘å¬çš„ç«¯å£ï¼Œè¿™åœ¨æœåŠ¡è§„æ¨¡å¾ˆå°çš„æƒ…å†µä¸‹æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨æœåŠ¡è§„æ¨¡å¾ˆå¤§æ¯ä¸ªæœåŠ¡ä¸æ­¢éƒ¨ç½²ä¸€ä¸ªå®ä¾‹çš„æƒ…å†µä¸‹æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜çš„ï¼Œæ¯”å¦‚ S-B éƒ¨ç½²äº†ä¸‰ä¸ªå®ä¾‹ S-B-1ã€S-B-2 å’Œ S-B-3ï¼Œè¿™æ—¶å€™ S-A æƒ³è°ƒç”¨ S-B è¯¥è¯·æ±‚å“ªä¸€ä¸ªæœåŠ¡å®ä¾‹çš„ IP å‘¢ï¼Ÿè¿˜æ˜¯å°† 3 ä¸ªæœåŠ¡å®ä¾‹çš„ IP éƒ½å†™åœ¨ S-A çš„ä»£ç é‡Œï¼Œæ¯æ¬¡è°ƒç”¨ S-B æ—¶é€‰æ‹©å…¶ä¸­ä¸€ä¸ª IPï¼Ÿè¿™æ ·åšæ˜¾å¾—å¾ˆä¸çµæ´»ï¼Œè¿™æ—¶æˆ‘ä»¬æƒ³åˆ°äº† Nginx åˆšå¥½å°±èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥ Nginx åç°åœ¨çš„æ¶æ„å˜æˆäº†å¦‚ä¸‹å›¾è¿™æ ·ï¼š æˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸€ä¸ªåŠ¨æ€ upstreamï¼Œå°±æ˜¯å½“æˆ‘ä»¬çš„ S-B çš„æœåŠ¡æ¢äº†æœºå™¨æˆ–è€…æ›´æ¢æœºå™¨ IP ä¹‹åï¼Œä¾ç„¶èƒ½å¤Ÿçƒ­é‡å¯ nginxã€‚ åœ¨è¿™ä¸ªæ¶æ„ä¸­ï¼š é¦–å…ˆ S-B çš„å®ä¾‹å¯åŠ¨åå°†è‡ªèº«çš„æœåŠ¡ä¿¡æ¯ï¼ˆä¸»è¦æ˜¯æœåŠ¡æ‰€åœ¨çš„ IP åœ°å€å’Œç«¯å£å·ï¼‰æ³¨å†Œåˆ°æ³¨å†Œå·¥å…·ä¸­ã€‚ä¸åŒæ³¨å†Œå·¥å…·æœåŠ¡çš„æ³¨å†Œæ–¹å¼å„ä¸ç›¸åŒï¼Œåæ–‡ä¼šè®² Consul çš„å…·ä½“æ³¨å†Œæ–¹å¼ã€‚ æœåŠ¡å°†æœåŠ¡ä¿¡æ¯æ³¨å†Œåˆ°æ³¨å†Œå·¥å…·åï¼Œæ³¨å†Œå·¥å…·å°±å¯ä»¥å¯¹æœåŠ¡åšå¥åº·æ£€æŸ¥ï¼Œä»¥æ­¤æ¥ç¡®å®šå“ªäº›æœåŠ¡å®ä¾‹å¯ç”¨å“ªäº›ä¸å¯ç”¨ã€‚ S-A å¯åŠ¨åå°±å¯ä»¥é€šè¿‡æœåŠ¡æ³¨å†Œå’ŒæœåŠ¡å‘ç°å·¥å…·è·å–åˆ°æ‰€æœ‰å¥åº·çš„ S-B å®ä¾‹çš„ IP å’Œç«¯å£ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯æ”¾å…¥è‡ªå·±çš„å†…å­˜ä¸­ï¼ŒS-A å°±å¯ç”¨é€šè¿‡è¿™äº›ä¿¡æ¯æ¥è°ƒç”¨ S-Bã€‚ S-A å¯ä»¥é€šè¿‡ç›‘å¬ï¼ˆWatchï¼‰æ³¨å†Œå·¥å…·æ¥æ›´æ–°å­˜å…¥å†…å­˜ä¸­çš„ S-B çš„æœåŠ¡ä¿¡æ¯ã€‚æ¯”å¦‚ S-B-1 æŒ‚äº†ï¼Œå¥åº·æ£€æŸ¥æœºåˆ¶å°±ä¼šå°†å…¶æ ‡ä¸ºä¸å¯ç”¨ï¼Œè¿™æ ·çš„ä¿¡æ¯å˜åŠ¨å°±è¢« S-A ç›‘å¬åˆ°äº†ï¼ŒS-A å°±æ›´æ–°è‡ªå·±å†…å­˜ä¸­ S-B-1 çš„æœåŠ¡ä¿¡æ¯ã€‚ æ‰€ä»¥åŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°å·¥å…·é™¤äº†æœåŠ¡æœ¬èº«çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°åŠŸèƒ½å¤–è‡³å°‘è¿˜éœ€è¦æœ‰å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€å˜æ›´é€šçŸ¥çš„åŠŸèƒ½ã€‚ ConsulConsul ä½œä¸ºä¸€ç§åˆ†å¸ƒå¼æœåŠ¡å·¥å…·ï¼Œä¸ºäº†é¿å…å•ç‚¹æ•…éšœå¸¸å¸¸ä»¥é›†ç¾¤çš„æ–¹å¼è¿›è¡Œéƒ¨ç½²ï¼Œåœ¨ Consul é›†ç¾¤çš„èŠ‚ç‚¹ä¸­åˆ†ä¸º Server å’Œ Client ä¸¤ç§èŠ‚ç‚¹ï¼ˆæ‰€æœ‰çš„èŠ‚ç‚¹ä¹Ÿè¢«ç§°ä¸º Agentï¼‰ï¼ŒServer èŠ‚ç‚¹ä¿å­˜æ•°æ®ï¼ŒClient èŠ‚ç‚¹è´Ÿè´£å¥åº·æ£€æŸ¥åŠè½¬å‘æ•°æ®è¯·æ±‚åˆ° Serverï¼›Server èŠ‚ç‚¹æœ‰ä¸€ä¸ª Leader èŠ‚ç‚¹å’Œå¤šä¸ª Follower èŠ‚ç‚¹ï¼ŒLeader èŠ‚ç‚¹ä¼šå°†æ•°æ®åŒæ­¥åˆ° Follower èŠ‚ç‚¹ï¼Œåœ¨ Leader èŠ‚ç‚¹æŒ‚æ‰çš„æ—¶å€™ä¼šå¯åŠ¨é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ªæ–°çš„ Leaderã€‚ Client èŠ‚ç‚¹å¾ˆè½»é‡ä¸”æ— çŠ¶æ€ï¼Œå®ƒä»¥ RPC çš„æ–¹å¼å‘ Server èŠ‚ç‚¹åšè¯»å†™è¯·æ±‚çš„è½¬å‘ï¼Œæ­¤å¤–ä¹Ÿå¯ä»¥ç›´æ¥å‘ Server èŠ‚ç‚¹å‘é€è¯»å†™è¯·æ±‚ã€‚ä¸‹é¢æ˜¯ Consul çš„æ¶æ„å›¾ï¼š Consul çš„å®‰è£…å’Œå…·ä½“ä½¿ç”¨åŠå…¶ä»–è¯¦ç»†å†…å®¹å¯æµè§ˆå®˜æ–¹æ–‡æ¡£ã€‚ Consul é»˜è®¤ç«¯å£ Use Default Ports ç”¨é€”è¯´æ˜ DNS: The DNS server (TCP and UDP) 8600 ç”¨äºè§£æ DNS æŸ¥è¯¢ã€‚ HTTP: The HTTP API (TCP Only) 8500 å®¢æˆ·ç«¯ä½¿ç”¨å®ƒæ¥ä¸ HTTP API é€šä¿¡ã€‚ HTTPS: The HTTPs API disabled (8501)* ï¼ˆå¯é€‰ï¼‰é»˜è®¤æƒ…å†µä¸‹å¤„äºå…³é—­çŠ¶æ€ï¼Œä½†ç«¯å£ 8501 æ˜¯å„ç§å·¥å…·é»˜è®¤ä½¿ç”¨çš„çº¦å®šã€‚ gRPC: The gRPC API disabled (8502)* ï¼ˆå¯é€‰ï¼‰ã€‚ç›®å‰ gRPC ä»…ç”¨äºå°† xDS API å…¬å¼€ç»™ Envoy ä»£ç†ã€‚é»˜è®¤æƒ…å†µä¸‹å®ƒå¤„äºå…³é—­çŠ¶æ€ï¼Œä½†ç«¯å£ 8502 æ˜¯å„ç§å·¥å…·ç”¨ä½œé»˜è®¤å€¼çš„çº¦å®šã€‚åœ¨-dev æ¨¡å¼ä¸‹é»˜è®¤ä¸º 8502 ã€‚ LAN Serf: The Serf LAN port (TCP and UDP) 8301 ç”¨äºå¤„ç† LAN ä¸­çš„å…«å¦ã€‚æ‰€æœ‰ä»£ç†å•†éƒ½è¦æ±‚ã€‚ Wan Serf: The Serf WAN port TCP and UDP) 8302 æœåŠ¡å™¨ä½¿ç”¨å®ƒæ¥é€šè¿‡ WAN é—²èŠåˆ°å…¶ä»–æœåŠ¡å™¨ã€‚ä» Consul 0.8 å¼€å§‹ï¼ŒWAN åŠ å…¥æ³›æ´ªåŠŸèƒ½è¦æ±‚ Serf WAN ç«¯å£ï¼ˆTCP / UDPï¼‰åœ¨ WAN å’Œ LAN æ¥å£ä¸Šè¿›è¡Œç›‘å¬ã€‚ server: Server RPC address (TCP Only) 8300 æœåŠ¡å™¨ä½¿ç”¨å®ƒæ¥å¤„ç†æ¥è‡ªå…¶ä»–ä»£ç†çš„ä¼ å…¥è¯·æ±‚ã€‚ Sidecar Proxy Min: Inclusive min port number to use for automatically assigned sidecar service registrations. 21000 æ—  Sidecar Proxy Max: Inclusive max port number to use for automatically assigned sidecar service registrations.. 21255 æ—  é»˜è®¤ç«¯å£å¯ä»¥é€šè¿‡ agent configuration æ¥ä¿®æ”¹ è¿è¡Œ Consul æœåŠ¡ä¸‹é¢æ˜¯æˆ‘ç”¨ Docker çš„æ–¹å¼æ­å»ºäº†ä¸€ä¸ªæœ‰ 2 ä¸ª Server èŠ‚ç‚¹å’Œ 1 ä¸ª Client èŠ‚ç‚¹çš„ Consul é›†ç¾¤ã€‚ 12# è¿™æ˜¯ConsulæœåŠ¡ä¸»èŠ‚ç‚¹docker run -d --name=c1 -p 8500:8500 -e CONSUL_BIND_INTERFACE=eth0 consul agent --server=true --bootstrap-expect=2 --client=0.0.0.0 -ui 12345678910111213141516docker exec -it c1 ifconfigeth0 Link encap:Ethernet HWaddr 02:42:AC:11:00:03 inet addr:172.17.0.3 Bcast:172.17.255.255 Mask:255.255.0.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:24 errors:0 dropped:0 overruns:0 frame:0 TX packets:16 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0 RX bytes:5835 (5.6 KiB) TX bytes:1619 (1.5 KiB)lo Link encap:Local Loopback inet addr:127.0.0.1 Mask:255.0.0.0 UP LOOPBACK RUNNING MTU:65536 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1 RX bytes:0 (0.0 B) TX bytes:0 (0.0 B) è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„ server çš„ä¸»èŠ‚ç‚¹çš„ IP ä¸º:172.17.0.3 è®© follwer èŠ‚ç‚¹åŠ å…¥ leader èŠ‚ç‚¹ 1docker run -d --name=c2 -e CONSUL_BIND_INTERFACE=eth0 consul agent --server=true --client=0.0.0.0 --join 172.17.0.3 å¯åŠ¨ client èŠ‚ç‚¹ 12#ä¸‹é¢æ˜¯å¯åŠ¨ Client èŠ‚ç‚¹docker run -d --name=c3 -e CONSUL_BIND_INTERFACE=eth0 consul agent --server=false --client=0.0.0.0 --join 172.17.0.3 12345docker psCONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES262fcb21e07a consul \"docker-entrypoint.sâ€¦\" 28 seconds ago Up 27 seconds 8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp c3ffd0c626653f consul \"docker-entrypoint.sâ€¦\" 41 minutes ago Up 41 minutes 8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp c2d6bb5fee079d consul \"docker-entrypoint.sâ€¦\" 43 minutes ago Up 43 minutes 8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&gt;8500/tcp c1 æ“ä½œ Consul æœ‰ Commands å’Œ HTTP API ä¸¤ç§æ–¹å¼ï¼Œè¿›å…¥ä»»æ„ä¸€ä¸ªå®¹å™¨æ‰§è¡Œ consul members éƒ½å¯ä»¥æœ‰å¦‚ä¸‹çš„è¾“å‡ºï¼Œè¯´æ˜ Consul é›†ç¾¤å°±å·²ç»æ­å»ºæˆåŠŸäº†ã€‚ 12345docker exec -it c1 consul membersNode Address Status Type Build Protocol DC Segmentd6bb5fee079d 172.17.0.3:8301 alive server 1.5.2 2 dc1 &lt;all&gt;ffd0c626653f 172.17.0.4:8301 alive server 1.5.2 2 dc1 &lt;all&gt;262fcb21e07a 172.17.0.5:8301 alive client 1.5.2 2 dc1 &lt;default&gt; æœåŠ¡æ³¨å†ŒæœåŠ¡æ³¨å†Œå¯¹æ–¹å¼æœ‰ 2 ç§æ–¹å¼ é€šè¿‡ client çš„é…ç½®æ¥æ³¨å†Œ é€šè¿‡ Http-Api æ¥æ³¨å†ŒæœåŠ¡ ç”±äºæˆ‘ä»¬çš„éœ€æ±‚æ˜¯éœ€è¦ç”¨ Http api æ¥æ³¨å†ŒæœåŠ¡ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ä¾‹å­éƒ½æ˜¯ä»¥http-api-register-serviceä¸ºä¾‹å­ è¯·æ±‚ Methodï¼šPUT è¯·æ±‚ Pathï¼š/agent/server/register è¯·æ±‚ Content-type: application/json Blocking Queriesï¼šNo Consistency Modesï¼šNone Agent Cachingï¼šNone ACL Requiredï¼šservice:write ï¼ˆAcl éœ€è¦æ‹¥æœ‰å†™å…¥çš„æƒé™ï¼‰ å‚æ•°å‚æ•°ä¸ä»…ä»…åªæ”¯æŒ StudlyCapsï¼ˆé¦–å­—æ¯å¤§å†™çš„é©¼å³°å†™æ³•camel_caseï¼‰,è¿˜æ”¯æŒ è›‡å½¢å¤§å°å†™ï¼Œsnake_caseã€‚ Name (string: &lt;required&gt;): æŒ‡å®šæœåŠ¡çš„é€»è¾‘åç§°ã€‚è®¸å¤šæœåŠ¡å®ä¾‹å¯ä»¥å…±äº«ç›¸åŒçš„é€»è¾‘æœåŠ¡åç§°ã€‚ ID (string: â€œâ€) : æŒ‡å®šæ­¤æœåŠ¡çš„å”¯ä¸€ IDã€‚æ¯ä¸ªä»£ç†å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚Name å¦‚æœæœªæä¾›ï¼Œåˆ™é»˜è®¤ä¸ºå‚æ•°ã€‚ Tags (array&lt;string&gt;: nil) : æŒ‡å®šè¦åˆ†é…ç»™æœåŠ¡çš„æ ‡è®°åˆ—è¡¨ã€‚è¿™äº›æ ‡è®°å¯ç”¨äºä»¥åçš„è¿‡æ»¤ï¼Œå¹¶é€šè¿‡ API å…¬å¼€ã€‚ Address (string: â€œâ€) : æŒ‡å®šæœåŠ¡çš„åœ°å€ã€‚å¦‚æœæœªæä¾›ï¼Œåˆ™åœ¨ DNS æŸ¥è¯¢æœŸé—´å°†ä»£ç†çš„åœ°å€ç”¨ä½œæœåŠ¡çš„åœ°å€ã€‚ Meta (map&lt;string|string&gt;: nil) : æŒ‡å®šé“¾æ¥åˆ°æœåŠ¡å®ä¾‹çš„ä»»æ„ KV å…ƒæ•°æ®ã€‚ Port (int: 0) : æŒ‡å®šæœåŠ¡çš„ç«¯å£ã€‚ Kind (string: â€œâ€) : é»˜è®¤ä¸ºç©ºï¼Œä»£è¡¨å…¸å‹çš„ consul æœåŠ¡ï¼Œè¿™ä¸ªå€¼å¯å¡«å†™çš„ï¼šconnect-proxyï¼Œä»£è¡¨å¦ä¸€ä¸ªæœåŠ¡çš„æ”¯æŒ Connect çš„ä»£ç†æœåŠ¡ Connect (Connect: nil)- æŒ‡å®š Connect çš„ é…ç½®ã€‚æœ‰å…³æ”¯æŒçš„å­—æ®µï¼Œè¯·å‚é˜…ä¸‹é¢çš„è¿æ¥ç»“æ„ Check (Check: nil) - æŒ‡å®šæ£€æŸ¥ã€‚æœ‰å…³æ¥å—çš„å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ£€æŸ¥æ–‡æ¡£ã€‚å¦‚æœæ‚¨æ²¡æœ‰ä¸ºæ”¯ç¥¨æä¾›åç§°æˆ– IDï¼Œåˆ™ä¼šç”Ÿæˆå®ƒä»¬ã€‚è¦æä¾›è‡ªå®šä¹‰ ID å’Œ/æˆ–åç§°ï¼Œè¯·è®¾ç½® CheckID å’Œ/æˆ– Name å­—æ®µã€‚ Checks (array&lt;Check&amp;gt: nil) - æŒ‡å®šæ£€æŸ¥åˆ—è¡¨ã€‚æœ‰å…³æ¥å—çš„å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… æ£€æŸ¥æ–‡æ¡£ã€‚å¦‚æœæ‚¨æ²¡æœ‰ä¸ºæ”¯ç¥¨æä¾›åç§°æˆ– IDï¼Œåˆ™ä¼šç”Ÿæˆå®ƒä»¬ã€‚è¦æä¾›è‡ªå®šä¹‰ ID å’Œ/æˆ–åç§°ï¼Œè¯·è®¾ç½® CheckID å’Œ/æˆ– Name å­—æ®µã€‚è‡ªåŠ¨ç”Ÿæˆ Name å¹¶ CheckID ä¾èµ–äºæ•°ç»„ä¸­æ£€æŸ¥çš„ä½ç½®ï¼Œå› æ­¤å³ä½¿è¡Œä¸ºæ˜¯ç¡®å®šæ€§çš„ï¼Œå»ºè®®æ‰€æœ‰æ£€æŸ¥è¦ä¹ˆè®© consul CheckID é€šè¿‡å°†å­—æ®µç•™ç©º/çœç•¥æ¥è®¾ç½®ï¼Œæˆ–è€…æä¾›å”¯ä¸€å€¼ã€‚ EnableTagOverride (bool: false) - æŒ‡å®šç¦ç”¨æ­¤æœåŠ¡æ ‡ç­¾çš„åç†µåŠŸèƒ½ã€‚å¦‚æœ EnableTagOverride è®¾ç½®ä¸ºï¼Œtrue åˆ™å¤–éƒ¨ä»£ç†å¯ä»¥åœ¨ç›®å½•ä¸­æ›´æ–°æ­¤æœåŠ¡ å¹¶ä¿®æ”¹æ ‡è®°ã€‚æ­¤ä»£ç†çš„åç»­æœ¬åœ°åŒæ­¥æ“ä½œå°†å¿½ç•¥æ›´æ–°çš„æ ‡è®°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¤–éƒ¨ä»£ç†ä¿®æ”¹äº†æ­¤æœåŠ¡çš„æ ‡è®°å’Œç«¯å£ï¼Œå¹¶ä¸” EnableTagOverride è®¾ç½®ä¸º true åœ¨ä¸‹ä¸€ä¸ªåŒæ­¥å‘¨æœŸä¹‹åï¼Œåˆ™æœåŠ¡çš„ç«¯å£å°†æ¢å¤ä¸ºåŸå§‹å€¼ï¼Œä½†æ ‡è®°å°†ä¿æŒæ›´æ–°çš„å€¼ã€‚ä½œä¸ºä¸€ä¸ªåä¾‹ï¼Œå¦‚æœä¸€ä¸ªå¤–éƒ¨ä»£ç†ä¿®æ”¹äº†è¿™ä¸ªæœåŠ¡çš„æ ‡ç­¾å’Œç«¯å£ï¼Œå¹¶ EnableTagOverride è®¾ç½®ä¸º false åœ¨ä¸‹ä¸€ä¸ªåŒæ­¥å‘¨æœŸåæœåŠ¡çš„ç«¯å£å’Œ æ ‡ç­¾å°†æ¢å¤ä¸ºåŸå§‹å€¼ï¼Œå¹¶ä¸”æ‰€æœ‰ä¿®æ”¹éƒ½å°†ä¸¢å¤±ã€‚ Weights (Weights: nil) - æŒ‡å®šæœåŠ¡çš„æƒé‡ã€‚æœ‰å…³æƒé‡çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… æœåŠ¡æ–‡æ¡£ã€‚å¦‚æœæœªæä¾›æ­¤å­—æ®µï¼Œåˆ™æƒé™å°†é»˜è®¤ä¸º {â€œPassingâ€: 1, â€œWarningâ€: 1}ã€‚è¯·åŠ¡å¿…æ³¨æ„ï¼Œè¿™ä»…é€‚ç”¨äºæœ¬åœ°æ³¨å†Œçš„æœåŠ¡ã€‚å¦‚æœæ‚¨æœ‰å¤šä¸ªèŠ‚ç‚¹éƒ½æ³¨å†Œç›¸åŒçš„æœåŠ¡ï¼Œåˆ™å…¶ EnableTagOverride é…ç½®å’Œæ‰€æœ‰å…¶ä»–æœåŠ¡é…ç½®é¡¹å½¼æ­¤ç‹¬ç«‹ã€‚æ›´æ–°åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ³¨å†Œçš„æœåŠ¡çš„æ ‡è®°ä¸åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ³¨å†Œçš„ç›¸åŒæœåŠ¡ï¼ˆæŒ‰åç§°ï¼‰æ— å…³ã€‚å¦‚æœ EnableTagOverride æœªæŒ‡å®šï¼Œåˆ™é»˜è®¤å€¼ä¸º falseã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…åç†µåŒæ­¥ã€‚ æœåŠ¡æ³¨å†Œæ ·æœ¬è½½ä½“(Sample Payload)1234567891011121314151617181920212223## cat payload1.json&#123; \"ID\": \"redis1\", \"Name\": \"redis\", \"Tags\": [ \"primary\", \"v1\" ], \"Address\": \"127.0.0.1\", \"Port\": 8000, \"Meta\": &#123; \"redis_version\": \"4.0\" &#125;, \"EnableTagOverride\": false, \"Check\": &#123; \"HTTP\": \"http://127.0.0.1:5000/health\", \"Interval\": \"10s\" &#125;, \"Weights\": &#123; \"Passing\": 1, \"Warning\": 1 &#125;&#125; 12345678910111213141516171819## cat payload2.json&#123; \"ID\": \"redis2\", \"Name\": \"redis\", \"Tags\": [ \"primary\", \"v1\" ], \"Address\": \"127.0.0.1\", \"Port\": 8000, \"Meta\": &#123; \"redis_version\": \"4.0\" &#125;, \"EnableTagOverride\": false, \"Weights\": &#123; \"Passing\": 1, \"Warning\": 1 &#125;&#125; 12345678910111213141516171819## cat payload3.json&#123; \"ID\": \"redis3\", \"Name\": \"redis\", \"Tags\": [ \"primary\", \"v1\" ], \"Address\": \"127.0.0.1\", \"Port\": 8001, \"Meta\": &#123; \"redis_version\": \"4.0\" &#125;, \"EnableTagOverride\": false, \"Weights\": &#123; \"Passing\": 1, \"Warning\": 1 &#125;&#125; æ ·æœ¬è¯·æ±‚(Sample Request)1234curl \\ --request PUT \\ --data @payload1.json \\ http://127.0.0.1:8500/v1/agent/service/register 1234curl \\ --request PUT \\ --data @payload2.json \\ http://127.0.0.1:8500/v1/agent/service/register 1234curl \\ --request PUT \\ --data @payload3.json \\ http://127.0.0.1:8500/v1/agent/service/register åœ¨ consul-ui ä¸Šå¯ä»¥çœ‹åˆ°æ˜¯å¦æ³¨å†ŒæˆåŠŸï¼Œä¹Ÿå¯ä»¥é€šè¿‡ http-api æŸ¥çœ‹æ˜¯å¦æ³¨å†ŒæˆåŠŸ ä»ä¸Šå›¾çœ‹å‡ºï¼Œæœ‰checkæœºåˆ¶çš„é‚£ä¸ªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ç›®å‰æ˜¯å¿ƒè·³æ£€æµ‹å¤±è´¥çš„ã€‚ å¿ƒè·³æœºåˆ¶(check)Http çš„ check æœºåˆ¶åªè¦è¿”å›çš„çŠ¶æ€ä¸º2xxï¼Œå°±ç®—ä¸ºæˆåŠŸï¼Œå¦‚æœæ˜¯4xx,å°±ç®—ä¸ºå±é™©ï¼Œå…¶ä»–çŠ¶æ€ç ç®—ä¸ºä¸¥é‡. æœåŠ¡å‘ç°æœåŠ¡æ³¨å†Œä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦ä» consul ä¸­æ‹¿åˆ°è¿™äº›æœåŠ¡ä¿¡æ¯ Health ç›¸å…³çš„ API Health-service çš„ API 1curl http://127.0.0.1:8500/v1/health/service/redis?passing=true passing ï¼ˆè¿™ä¸ªå‚æ•°å¯ä»¥å¸®æˆ‘ä»¬åªæ˜¾ç¤ºå¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹ï¼‰ filter ï¼ˆæœåŠ¡éœ€è¦å®šåˆ¶è¿‡æ»¤çš„å¯ä»¥ä¼ å…¥è¿™ä¸ªå‚æ•°ï¼Œè¯¦æƒ…çœ‹æ–‡æ¡£ï¼‰ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°æ‰€æœ‰å¯ç”¨çš„æœåŠ¡åˆ—è¡¨ä¹‹åï¼Œéœ€è¦æ‰¾åˆ°åœ°æ–¹(å†…å­˜)æŠŠè¿™ä¸ª&quot;åˆ—è¡¨&quot;å­˜å‚¨èµ·æ¥ï¼Œåœ¨æˆ‘ä»¬çš„ Client æˆ–è€… API ç½‘å…³è¿›ç¨‹å†…éƒ¨å®ç°ä¸€ä¸ªå†…éƒ¨LBçš„æœºåˆ¶ï¼Œè¿™æ ·å­å°±ä¸éœ€è¦æ¯æ¬¡è¯·æ±‚éƒ½å»æ‹¿ä¸€æ¬¡è¿™ä¸ªå¯ç”¨æœåŠ¡çš„ä¿¡æ¯ã€‚ å†…éƒ¨çš„LBæœºåˆ¶ä¸€èˆ¬å°±æ˜¯è½®è®­æˆ–è€…éšæœºã€‚ æœåŠ¡æ›´æ–° LB ä¿¡æ¯(Watch)ç”±äºæˆ‘ä»¬çš„æœåŠ¡ä¸ä¸€å®šä¸€ç›´éƒ½å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è·Ÿéšè€…æœåŠ¡æ³¨å†Œä¸­å¿ƒæ¥æ›´æ–°æˆ‘ä»¬çš„å†…éƒ¨çš„LBå†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æœåŠ¡æ³¨å†Œä¸­å¿ƒå‘Šè¯‰æˆ‘ä»¬æˆ‘è¦è®¿é—®çš„é‚£äº›æœåŠ¡ï¼Œå“ªä¸€äº›æœåŠ¡å˜æˆä¸å¯ç”¨äº†ï¼Œæˆ‘è¦ç§»é™¤LBã€‚ æ‰€ä»¥ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ consul çš„watch æœºåˆ¶ã€‚ Consul æœ‰ä¸¤ç§ Watch çš„æ–¹å¼ script ï¼ˆè§¦å‘ client ç«¯æœ¬åœ°çš„è„šæœ¬ï¼‰ http (è§¦å‘è¿œç«¯çš„ urlï¼Œç±»ä¼¼é’©å­çš„è¡Œä¸º) è¿™é‡Œï¼Œæˆ‘ä»¬é€‰æ‹© http çš„æ–¹å¼ã€‚ Watch çš„ç±»å‹ key - Watch a specific KV pair keyprefix - Watch a prefix in the KV store services - Watch the list of available services nodes - Watch the list of nodes service- Watch the instances of a service checks - Watch the value of health checks event - Watch for custom user events \b\b è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ watch çš„æ˜¯serviceï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åŠ¨æ€çš„å»æ›´æ–°æˆ‘ä»¬è‡ªèº«çš„LBã€‚ 123456789101112&#123; &quot;type&quot;: &quot;service&quot;, &quot;service&quot;: &quot;redis&quot;, &quot;handler_type&quot;: &quot;http&quot;, &quot;http_handler_config&quot;: &#123; &quot;path&quot;:&quot;https:&#x2F;&#x2F;localhost:8000&#x2F;callBackWatch&quot;, &quot;method&quot;: &quot;POST&quot;, &quot;header&quot;: &#123;&quot;x-foo&quot;:[&quot;bar&quot;, &quot;baz&quot;]&#125;, &quot;timeout&quot;: &quot;10s&quot;, &quot;tls_skip_verify&quot;: false &#125;&#125; è¿™é‡Œï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªcallBackWatchçš„æœåŠ¡ç”¨äºæ¥æ‰‹ consul çš„ watch åˆ° service å˜åŒ–çš„ payloadï¼Œç”¨äºæ›´æ–°æˆ‘ä»¬è‡ªå·±çš„LB å†…å®¹ã€‚ å¸¸è§„éƒ¨ç½²æ¶æ„å›¾ é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªæ­£å¸¸çš„ Consul é›†ç¾¤ï¼Œæœ‰ Serverï¼Œæœ‰ Leaderã€‚è¿™é‡Œåœ¨æœåŠ¡å™¨ Server1ã€Server2ã€Server3 ä¸Šåˆ†åˆ«éƒ¨ç½²äº† Consul Serverï¼Œå‡è®¾ä»–ä»¬é€‰ä¸¾äº† Server2 ä¸Šçš„ Consul Server èŠ‚ç‚¹ä¸º Leaderã€‚è¿™äº›æœåŠ¡å™¨ä¸Šæœ€å¥½åªéƒ¨ç½² Consul ç¨‹åºï¼Œä»¥å°½é‡ç»´æŠ¤ Consul Server çš„ç¨³å®šã€‚ ç„¶ååœ¨æœåŠ¡å™¨ Server4 å’Œ Server5 ä¸Šé€šè¿‡ Consul Client åˆ†åˆ«æ³¨å†Œ Service Aã€Bã€Cï¼Œè¿™é‡Œæ¯ä¸ª Service åˆ†åˆ«éƒ¨ç½²åœ¨äº†ä¸¤ä¸ªæœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·å¯ä»¥é¿å… Service çš„å•ç‚¹é—®é¢˜ã€‚æœåŠ¡æ³¨å†Œåˆ° Consul å¯ä»¥é€šè¿‡ HTTP APIï¼ˆ8500 ç«¯å£ï¼‰çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Consul é…ç½®æ–‡ä»¶çš„æ–¹å¼ã€‚Consul Client å¯ä»¥è®¤ä¸ºæ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒå°†æ³¨å†Œä¿¡æ¯é€šè¿‡ RPC è½¬å‘åˆ° Consul Serverï¼ŒæœåŠ¡ä¿¡æ¯ä¿å­˜åœ¨ Server çš„å„ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”é€šè¿‡ Raft å®ç°äº†å¼ºä¸€è‡´æ€§ã€‚ æœ€ååœ¨æœåŠ¡å™¨ Server6 ä¸­ Program D éœ€è¦è®¿é—® Service Bï¼Œè¿™æ—¶å€™ Program D é¦–å…ˆè®¿é—®æœ¬æœº Consul Client æä¾›çš„ HTTP APIï¼Œæœ¬æœº Client ä¼šå°†è¯·æ±‚è½¬å‘åˆ° Consul Serverï¼ŒConsul Server æŸ¥è¯¢åˆ° Service B å½“å‰çš„ä¿¡æ¯è¿”å›ï¼Œæœ€ç»ˆ Program D æ‹¿åˆ°äº† Service B çš„æ‰€æœ‰éƒ¨ç½²çš„ IP å’Œç«¯å£ï¼Œç„¶åå°±å¯ä»¥é€‰æ‹© Service B çš„å…¶ä¸­ä¸€ä¸ªéƒ¨ç½²å¹¶å‘å…¶å‘èµ·è¯·æ±‚äº†ã€‚å¦‚æœæœåŠ¡å‘ç°é‡‡ç”¨çš„æ˜¯ DNS æ–¹å¼ï¼Œåˆ™ Program D ä¸­ç›´æ¥ä½¿ç”¨ Service B çš„æœåŠ¡å‘ç°åŸŸåï¼ŒåŸŸåè§£æè¯·æ±‚é¦–å…ˆåˆ°è¾¾æœ¬æœº DNS ä»£ç†ï¼Œç„¶åè½¬å‘åˆ°æœ¬æœº Consul Clientï¼Œæœ¬æœº Client ä¼šå°†è¯·æ±‚è½¬å‘åˆ° Consul Serverï¼ŒConsul Server æŸ¥è¯¢åˆ° Service B å½“å‰çš„ä¿¡æ¯è¿”å›ï¼Œæœ€ç»ˆ Program D æ‹¿åˆ°äº† Service B çš„æŸä¸ªéƒ¨ç½²çš„ IP å’Œç«¯å£ã€‚ éƒ¨ç½²æ¶æ„å®˜æ–¹æ¨èçš„æ˜¯é‚£ä¸ªä¸»æœºéƒ½å®‰è£…ä¸€ä¸ª clinetï¼Œè¿™ä¸ªæ˜¯ååˆ†ä¸ç§‘å­¦çš„åšæ³•ï¼Œå¦‚æœä½ å®åœ¨ä¸æƒ³åœ¨æ¯ä¸ªä¸»æœºéƒ¨ç½² Consul Clientï¼Œè¿˜æœ‰ä¸€ä¸ªå¤šè·¯æ³¨å†Œçš„æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨ä¸“é—¨çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½² Consul Clientï¼Œç„¶åæ¯ä¸ªæœåŠ¡éƒ½æ³¨å†Œåˆ°å¤šä¸ª Clientï¼Œè¿™é‡Œä¸ºäº†é¿å…æœåŠ¡å•ç‚¹é—®é¢˜è¿˜æ˜¯æ¯ä¸ªæœåŠ¡éƒ¨ç½²å¤šä»½ï¼Œéœ€è¦æœåŠ¡å‘ç°æ—¶ï¼Œç¨‹åºå‘ä¸€ä¸ªæä¾›è´Ÿè½½å‡è¡¡çš„ç¨‹åºå‘èµ·è¯·æ±‚ï¼Œè¯¥ç¨‹åºå°†è¯·æ±‚è½¬å‘åˆ°æŸä¸ª Consul Clientã€‚è¿™ç§æ–¹æ¡ˆéœ€è¦æ³¨æ„å°† Consul çš„ 8500 ç«¯å£ç»‘å®šåˆ°ç§ç½‘ IP ä¸Šï¼Œé»˜è®¤åªæœ‰ 127.0.0.1ã€‚ è¿™ä¸ªæ¶æ„çš„ä¼˜åŠ¿ï¼š Consul èŠ‚ç‚¹æœåŠ¡å™¨ä¸åº”ç”¨æœåŠ¡å™¨éš”ç¦»ï¼Œäº’ç›¸å¹²æ‰°å°‘ï¼› ä¸ç”¨æ¯å°ä¸»æœºéƒ½éƒ¨ç½² Consulï¼Œæ–¹ä¾¿ Consul çš„é›†ä¸­ç®¡ç†ï¼› æŸä¸ª Consul Client æŒ‚æ‰çš„æƒ…å†µä¸‹ï¼Œæ³¨å†Œåˆ°å…¶ä¸Šçš„æœåŠ¡ä»æœ‰æœºä¼šè¢«è®¿é—®åˆ°ï¼› ä½†ä¹Ÿéœ€è¦æ³¨æ„å…¶ç¼ºç‚¹ï¼š å¼•å…¥æ›´å¤šæŠ€æœ¯æ ˆï¼šè´Ÿè½½å‡è¡¡çš„å®ç°ï¼Œä¸ä»…è¦è€ƒè™‘ Consul Client çš„è´Ÿè½½å‡è¡¡ï¼Œè¿˜è¦è€ƒè™‘è´Ÿè½½å‡è¡¡æœ¬èº«çš„å•ç‚¹é—®é¢˜ã€‚ Client çš„èŠ‚ç‚¹æ•°é‡ï¼šå•ä¸ª Client å¦‚æœæ³¨å†Œçš„æœåŠ¡å¤ªå¤šï¼Œè´Ÿè½½è¾ƒé‡ï¼Œéœ€è¦æœ‰ä¸ªç®—æ³•ï¼ˆæ¯”å¦‚ hash ä¸€è‡´ï¼‰åˆç†åˆ†é…æ¯ä¸ª Client ä¸Šçš„æœåŠ¡æ•°é‡ï¼Œä»¥åŠç¡®å®š Client çš„æ€»ä½“æ•°é‡ã€‚ æœåŠ¡å‘ç°è¦è¿‡æ»¤æ‰é‡å¤çš„æ³¨å†Œï¼Œå› ä¸ºæ³¨å†Œåˆ°äº†å¤šä¸ªèŠ‚ç‚¹ä¼šè®¤ä¸ºæ˜¯å¤šä¸ªéƒ¨ç½²ï¼ˆDNS æ¥å£ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼‰ã€‚ è¿™ä¸ªæ–¹æ¡ˆå…¶å®è¿˜å¯ä»¥ä¼˜åŒ–ï¼ŒæœåŠ¡å‘ç°ä½¿ç”¨çš„è´Ÿè½½å‡è¡¡å¯ä»¥ç›´æ¥ä»£ç† Server èŠ‚ç‚¹ï¼Œå› ä¸ºç›¸å…³è¯·æ±‚è¿˜æ˜¯ä¼šè½¬å‘åˆ° Server èŠ‚ç‚¹ï¼Œä¸å¦‚ç›´æ¥å°±å‘åˆ° Serverã€‚ Consul çš„å¥åº·æ£€æŸ¥Consul åšæœåŠ¡å‘ç°æ˜¯ä¸“ä¸šçš„ï¼Œå¥åº·æ£€æŸ¥æ˜¯å…¶ä¸­ä¸€é¡¹å¿…ä¸å¯å°‘çš„åŠŸèƒ½ï¼Œå…¶æä¾› Script/TCP/HTTP+Intervalï¼Œä»¥åŠ TTL ç­‰å¤šç§æ–¹å¼ã€‚æœåŠ¡çš„å¥åº·æ£€æŸ¥ç”±æœåŠ¡æ³¨å†Œåˆ°çš„ Agent æ¥å¤„ç†ï¼Œè¿™ä¸ª Agent æ—¢å¯ä»¥æ˜¯ Client ä¹Ÿå¯ä»¥æ˜¯ Serverã€‚ å¾ˆå¤šåŒå­¦éƒ½ä½¿ç”¨ ZooKeeper æˆ–è€… etcd åšæœåŠ¡å‘ç°ï¼Œä½¿ç”¨ Consul æ—¶å‘ç°èŠ‚ç‚¹æŒ‚æ‰åæœåŠ¡çš„çŠ¶æ€å˜ä¸ºä¸å¯ç”¨äº†ï¼Œæ‰€ä»¥æœ‰åŒå­¦é—®æœåŠ¡ä¸ºä»€ä¹ˆä¸åœ¨å„ä¸ªèŠ‚ç‚¹ä¹‹é—´åŒæ­¥ï¼Ÿè¿™ä¸ªæ ¹æœ¬åŸå› æ˜¯æœåŠ¡å‘ç°çš„å®ç°åŸç†ä¸åŒã€‚ Consul ä¸ ZooKeeperã€etcd çš„åŒºåˆ«åè¾¹è¿™ä¸¤ä¸ªå·¥å…·æ˜¯é€šè¿‡é”®å€¼å­˜å‚¨æ¥å®ç°æœåŠ¡çš„æ³¨å†Œä¸å‘ç°ã€‚ ZooKeeper åˆ©ç”¨ä¸´æ—¶èŠ‚ç‚¹çš„æœºåˆ¶ï¼Œä¸šåŠ¡æœåŠ¡å¯åŠ¨æ—¶åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹åœ¨æœåŠ¡å°±åœ¨ï¼ŒèŠ‚ç‚¹ä¸å­˜åœ¨æœåŠ¡å°±ä¸å­˜åœ¨ã€‚ etcd åˆ©ç”¨ TTL æœºåˆ¶ï¼Œä¸šåŠ¡æœåŠ¡å¯åŠ¨æ—¶åˆ›å»ºé”®å€¼å¯¹ï¼Œå®šæ—¶æ›´æ–° ttlï¼Œttl è¿‡æœŸåˆ™æœåŠ¡ä¸å¯ç”¨ã€‚ ZooKeeper å’Œ etcd çš„é”®å€¼å­˜å‚¨éƒ½æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é”®å€¼å¯¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œåªè¦åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šå­˜åœ¨å°±å¯ä»¥è®¤ä¸ºå¯¹åº”çš„ä¸šåŠ¡æœåŠ¡æ˜¯å¯ç”¨çš„ã€‚ Consul çš„æ•°æ®åŒæ­¥ä¹Ÿæ˜¯å¼ºä¸€è‡´æ€§çš„ï¼ŒæœåŠ¡çš„æ³¨å†Œä¿¡æ¯ä¼šåœ¨ Server èŠ‚ç‚¹ä¹‹é—´åŒæ­¥ï¼Œç›¸æ¯” ZKã€etcdï¼ŒæœåŠ¡çš„ä¿¡æ¯è¿˜æ˜¯æŒä¹…åŒ–ä¿å­˜çš„ï¼Œå³ä½¿æœåŠ¡éƒ¨ç½²ä¸å¯ç”¨äº†ï¼Œä»æ—§å¯ä»¥æŸ¥è¯¢åˆ°è¿™ä¸ªæœåŠ¡éƒ¨ç½²ã€‚ä½†æ˜¯ä¸šåŠ¡æœåŠ¡çš„å¯ç”¨çŠ¶æ€æ˜¯ç”±æ³¨å†Œåˆ°çš„ Agent æ¥ç»´æŠ¤çš„ï¼ŒAgent å¦‚æœä¸èƒ½æ­£å¸¸å·¥ä½œäº†ï¼Œåˆ™æ— æ³•ç¡®å®šæœåŠ¡çš„çœŸå®çŠ¶æ€ï¼Œå¹¶ä¸” Consul æ˜¯ç›¸å½“ç¨³å®šäº†ï¼ŒAgent æŒ‚æ‰çš„æƒ…å†µä¸‹å¤§æ¦‚ç‡æœåŠ¡å™¨çš„çŠ¶æ€ä¹Ÿå¯èƒ½æ˜¯ä¸å¥½çš„ï¼Œæ­¤æ—¶å±è”½æ‰æ­¤èŠ‚ç‚¹ä¸Šçš„æœåŠ¡æ˜¯åˆç†çš„ã€‚Consul ä¹Ÿç¡®å®æ˜¯è¿™æ ·è®¾è®¡çš„ï¼ŒDNS æ¥å£ä¼šè‡ªåŠ¨å±è”½æŒ‚æ‰èŠ‚ç‚¹ä¸Šçš„æœåŠ¡ï¼ŒHTTP API ä¹Ÿè®¤ä¸ºæŒ‚æ‰èŠ‚ç‚¹ä¸Šçš„æœåŠ¡ä¸æ˜¯ passing çš„ã€‚ é‰´äº Consul å¥åº·æ£€æŸ¥çš„è¿™ç§æœºåˆ¶ï¼ŒåŒæ—¶é¿å…å•ç‚¹æ•…éšœï¼Œæ‰€æœ‰çš„ä¸šåŠ¡æœåŠ¡åº”è¯¥éƒ¨ç½²å¤šä»½ï¼Œå¹¶æ³¨å†Œåˆ°ä¸åŒçš„ Consul èŠ‚ç‚¹ã€‚éƒ¨ç½²å¤šä»½å¯èƒ½ä¼šç»™ä½ çš„è®¾è®¡å¸¦æ¥ä¸€äº›æŒ‘æˆ˜ï¼Œå› ä¸ºè°ƒç”¨æ–¹åŒæ—¶è®¿é—®å¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½ä¼šç”±äºä¼šè¯ä¸å…±äº«å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´ï¼Œè¿™ä¸ªæœ‰è®¸å¤šæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥å»æŸ¥è¯¢ï¼Œè¿™é‡Œä¸åšè¯´æ˜ã€‚ å¥åº·æ£€æŸ¥èƒ½ä¸èƒ½æ”¯æŒæ•…éšœè½¬ç§»ï¼Ÿä¸Šè¾¹æåˆ°å¥åº·æ£€æŸ¥æ˜¯ç”±æœåŠ¡æ³¨å†Œåˆ°çš„ Agent æ¥å¤„ç†çš„ï¼Œé‚£ä¹ˆå¦‚æœè¿™ä¸ª Agent æŒ‚æ‰äº†ï¼Œä¼šä¸ä¼šæœ‰åˆ«çš„ Agent æ¥æ¥ç®¡å¥åº·æ£€æŸ¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ ä»é—®é¢˜äº§ç”Ÿçš„åŸå› æ¥çœ‹ï¼Œåœ¨åº”ç”¨äºç”Ÿäº§ç¯å¢ƒä¹‹å‰ï¼Œè‚¯å®šéœ€è¦å¯¹å„ç§åœºæ™¯è¿›è¡Œæµ‹è¯•ï¼Œæ²¡æœ‰é—®é¢˜æ‰ä¼šä¸Šçº¿ï¼Œæ‰€ä»¥æ˜¾è€Œæ˜“è§çš„é—®é¢˜å¯ä»¥å±è”½æ‰ï¼›å¦‚æœæ˜¯æ–°ç‰ˆæœ¬ Consul çš„ BUG å¯¼è‡´çš„ï¼Œæ­¤æ—¶éœ€è¦é™çº§ï¼›å¦‚æœè¿™ä¸ª BUG æ˜¯å¶å‘çš„ï¼Œé‚£ä¹ˆåªéœ€è¦å°† Consul é‡æ–°æ‹‰èµ·æ¥å°±å¯ä»¥äº†ï¼Œè¿™æ ·æ¯”è¾ƒç®€å•ï¼›å¦‚æœæ˜¯ç¡¬ä»¶ã€ç½‘ç»œæˆ–è€…æ“ä½œç³»ç»Ÿæ•…éšœï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¸ŠæœåŠ¡çš„å¯ç”¨æ€§ä¹Ÿå¾ˆéš¾ä¿éšœï¼Œä¸éœ€è¦åˆ«çš„ Agent æ¥ç®¡å¥åº·æ£€æŸ¥ã€‚ ä»å®ç°ä¸Šçœ‹ï¼Œé€‰æ‹©å“ªä¸ªèŠ‚ç‚¹æ˜¯ä¸ªé—®é¢˜ï¼Œè¿™éœ€è¦å®æ—¶æˆ–å‡†å®æ—¶åŒæ­¥å„ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½çŠ¶æ€ï¼Œè€Œä¸”ç”±äºä¸šåŠ¡æœåŠ¡è¿è¡ŒçŠ¶æ€å¤šå˜ï¼Œå³ä½¿å½“æ—¶é€‰æ‹©å‡ºäº†è´Ÿè½½æ¯”è¾ƒè½»æ¾çš„èŠ‚ç‚¹ï¼Œæ— æ³•ä¿è¯æŸä¸ªæ—¶æ®µä»»åŠ¡åˆå˜å¾—ç¹é‡ï¼Œå¯èƒ½é€ æˆæ–°çš„æ›´å¤§èŒƒå›´çš„å´©æºƒã€‚å¦‚æœåŸæ¥çš„èŠ‚ç‚¹è¿˜è¦å¯åŠ¨èµ·æ¥ï¼Œé‚£ä¹ˆæ¥ç®¡çš„å¥åº·æ£€æŸ¥æ˜¯å¦è¿˜è¦æ’¤é”€ï¼Œå¦‚æœè¦ï¼Œéœ€è¦è®°å½•æœåŠ¡ä»¬æœ€åˆæ³¨å†Œçš„èŠ‚ç‚¹ï¼Œç„¶åæœ‰ä¸€ä¸ªç›‘å¬æœºåˆ¶æ¥è§¦å‘ï¼Œå¦‚æœä¸è¦ï¼Œé€šè¿‡æœåŠ¡å‘ç°å°±ä¼šè·å–åˆ°å¾ˆå¤šå†—ä½™çš„ä¿¡æ¯ï¼Œå¹¶ä¸”éšç€æ—¶é—´æ¨ç§»ï¼Œè¿™ç§æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šï¼Œç³»ç»Ÿå˜çš„æ— åºã€‚ ä»å®é™…åº”ç”¨çœ‹ï¼ŒèŠ‚ç‚¹ä¸Šçš„æœåŠ¡å¯èƒ½æ—¢è¦è¢«å‘ç°ï¼Œåˆè¦å‘ç°åˆ«çš„æœåŠ¡ï¼Œå¦‚æœèŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œä»…æä¾›è¢«å‘ç°çš„åŠŸèƒ½å®é™…ä¸ŠæœåŠ¡è¿˜æ˜¯ä¸å¯ç”¨çš„ã€‚å½“ç„¶å‘ç°åˆ«çš„æœåŠ¡ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨æœ¬æœºèŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡è®¿é—®ä¸€ä¸ª Nginx å®ç°çš„è‹¥å¹² Consul èŠ‚ç‚¹çš„è´Ÿè½½å‡è¡¡æ¥å®ç°ï¼Œè¿™æ— ç–‘åˆå¼•å…¥äº†æ–°çš„æŠ€æœ¯æ ˆã€‚ å¦‚æœä¸æ˜¯ä¸Šè¾¹æåˆ°çš„é—®é¢˜ï¼Œæˆ–è€…ä½ å¯ä»¥é€šè¿‡ä¸€äº›æ–¹å¼è§£å†³è¿™äº›é—®é¢˜ï¼Œå¥åº·æ£€æŸ¥æ¥ç®¡çš„å®ç°ä¹Ÿå¿…ç„¶æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„çŠ¶æ€åŒæ­¥æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚åŒæ—¶ä¸è¦å¿˜äº†æœåŠ¡éƒ¨ç½²äº†å¤šä»½ï¼ŒæŒ‚æ‰ä¸€ä¸ªä¸åº”è¯¥å½±å“ç³»ç»Ÿçš„å¿«é€Ÿæ¢å¤ï¼Œæ‰€ä»¥æ²¡å¿…è¦å»åšè¿™ä¸ªæ¥ç®¡ã€‚","categories":[{"name":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","permalink":"http://blog.crazylaw.cn/categories/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"}],"tags":[{"name":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","permalink":"http://blog.crazylaw.cn/tags/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"}]},{"title":"ã€Nginxã€‘map-è¯¦è§£","slug":"nginx/ã€Nginxã€‘map-è¯¦è§£","date":"2019-06-13T03:13:30.000Z","updated":"2021-03-20T16:25:01.812Z","comments":true,"path":"2019/06/13/nginx/ã€Nginxã€‘map-è¯¦è§£/","link":"","permalink":"http://blog.crazylaw.cn/2019/06/13/nginx/%E3%80%90Nginx%E3%80%91map-%E8%AF%A6%E8%A7%A3/","excerpt":"å‰è¨€map æŒ‡ä»¤æ˜¯ç”± ngx_http_map_module æ¨¡å—æä¾›çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹å®‰è£… nginx éƒ½ä¼šå®‰è£…è¯¥æ¨¡å—ã€‚ map çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºè‡ªå®šä¹‰å˜é‡ï¼Œé€šè¿‡ä½¿ç”¨ nginx çš„å†…ç½®å˜é‡ï¼Œå»åŒ¹é…æŸäº›ç‰¹å®šè§„åˆ™ï¼Œå¦‚æœåŒ¹é…æˆåŠŸåˆ™è®¾ç½®æŸä¸ªå€¼ç»™è‡ªå®šä¹‰å˜é‡ã€‚ è€Œè¿™ä¸ªè‡ªå®šä¹‰å˜é‡åˆå¯ä»¥ä½œäºä»–ç”¨ã€‚","text":"å‰è¨€map æŒ‡ä»¤æ˜¯ç”± ngx_http_map_module æ¨¡å—æä¾›çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹å®‰è£… nginx éƒ½ä¼šå®‰è£…è¯¥æ¨¡å—ã€‚ map çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºè‡ªå®šä¹‰å˜é‡ï¼Œé€šè¿‡ä½¿ç”¨ nginx çš„å†…ç½®å˜é‡ï¼Œå»åŒ¹é…æŸäº›ç‰¹å®šè§„åˆ™ï¼Œå¦‚æœåŒ¹é…æˆåŠŸåˆ™è®¾ç½®æŸä¸ªå€¼ç»™è‡ªå®šä¹‰å˜é‡ã€‚ è€Œè¿™ä¸ªè‡ªå®šä¹‰å˜é‡åˆå¯ä»¥ä½œäºä»–ç”¨ã€‚","categories":[{"name":"nginx","slug":"nginx","permalink":"http://blog.crazylaw.cn/categories/nginx/"}],"tags":[{"name":"nginx","slug":"nginx","permalink":"http://blog.crazylaw.cn/tags/nginx/"}]},{"title":"ã€kubernetesã€‘dashboard","slug":"k8s/k8s-dashboard","date":"2019-06-12T09:00:30.000Z","updated":"2021-03-20T16:25:01.806Z","comments":true,"path":"2019/06/12/k8s/k8s-dashboard/","link":"","permalink":"http://blog.crazylaw.cn/2019/06/12/k8s/k8s-dashboard/","excerpt":"å‰è¨€dashboard dashboard æ˜¯ä¸€æ¬¾åŸºäºå®¹å™¨çš„ç›‘æ§ k8s é›†ç¾¤æƒ…å†µçš„ä¸€ä¸ªä»ªè¡¨ç›˜é¡¹ç›® æœ¬æ–‡ä¸­ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºï¼šv1.10.1","text":"å‰è¨€dashboard dashboard æ˜¯ä¸€æ¬¾åŸºäºå®¹å™¨çš„ç›‘æ§ k8s é›†ç¾¤æƒ…å†µçš„ä¸€ä¸ªä»ªè¡¨ç›˜é¡¹ç›® æœ¬æ–‡ä¸­ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºï¼šv1.10.1 å®‰è£…ä»å›½å†…æ‰¾åˆ°ç‰ˆæœ¬å¯¹åº”çš„é•œåƒï¼Œæ‹‰å–åˆ°æœ¬åœ°å¹¶ä¸”é‡å‘½åé•œåƒ 1docker pull gcrxio/kubernetes-dashboard-amd64:v1.10.1 &amp;&amp; docker tag gcrxio/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1 &amp;&amp; docker rmi gcrxio/kubernetes-dashboard-amd64:v1.10.1 ç„¶åä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ yamlï¼Œä¿å­˜åœ¨ \b æœ¬åœ°ï¼Œä¸ä»¥è¡¥ä¸çš„å½¢å¼æ›´æ–°ï¼Œæˆ‘ä»¬ç”¨é…ç½®å¼çš„æ–¹å¼æ¥åˆ›å»º pods 1wget https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦è‡³å°‘ä¿®æ”¹ 1 ä¸ªç»†èŠ‚ service ä¸­æ·»åŠ  {â€œspecâ€:{â€œtypeâ€:â€NodePortâ€}}/{â€œspecâ€:{â€œportsâ€:{â€œnodePortâ€:30001}}} å¦‚æœä¸æŒ‡å®š nodeport çš„è¯ï¼Œä¼šéšæœºåˆ†é…ä¸€ä¸ª 30000 ä»¥ä¸Šçš„ç«¯å£ 1234567891011121314151617# ------------------- Dashboard Service ------------------- #kind: ServiceapiVersion: v1metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kube-systemspec: type: NodePort ports: - port: 443 targetPort: 8443 nodePort: 30001 selector: k8s-app: kubernetes-dashboard å®Œæ•´çš„æ¨¡æ¿å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165# Copyright 2017 The Kubernetes Authors.## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at## http://www.apache.org/licenses/LICENSE-2.0## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.# ------------------- Dashboard Secret ------------------- #apiVersion: v1kind: Secretmetadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard-certs namespace: kube-systemtype: Opaque---# ------------------- Dashboard Service Account ------------------- #apiVersion: v1kind: ServiceAccountmetadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kube-system---# ------------------- Dashboard Role &amp; Role Binding ------------------- #kind: RoleapiVersion: rbac.authorization.k8s.io/v1metadata: name: kubernetes-dashboard-minimal namespace: kube-systemrules: # Allow Dashboard to create 'kubernetes-dashboard-key-holder' secret. - apiGroups: [''] resources: ['secrets'] verbs: ['create'] # Allow Dashboard to create 'kubernetes-dashboard-settings' config map. - apiGroups: [''] resources: ['configmaps'] verbs: ['create'] # Allow Dashboard to get, update and delete Dashboard exclusive secrets. - apiGroups: [''] resources: ['secrets'] resourceNames: ['kubernetes-dashboard-key-holder', 'kubernetes-dashboard-certs'] verbs: ['get', 'update', 'delete'] # Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map. - apiGroups: [''] resources: ['configmaps'] resourceNames: ['kubernetes-dashboard-settings'] verbs: ['get', 'update'] # Allow Dashboard to get metrics from heapster. - apiGroups: [''] resources: ['services'] resourceNames: ['heapster'] verbs: ['proxy'] - apiGroups: [''] resources: ['services/proxy'] resourceNames: ['heapster', 'http:heapster:', 'https:heapster:'] verbs: ['get']---apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: kubernetes-dashboard-minimal namespace: kube-systemroleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: kubernetes-dashboard-minimalsubjects: - kind: ServiceAccount name: kubernetes-dashboard namespace: kube-system---# ------------------- Dashboard Deployment ------------------- #kind: DeploymentapiVersion: apps/v1metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kube-systemspec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: k8s-app: kubernetes-dashboard template: metadata: labels: k8s-app: kubernetes-dashboard spec: containers: - name: kubernetes-dashboard image: k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1 ports: - containerPort: 8443 protocol: TCP args: - --auto-generate-certificates # Uncomment the following line to manually specify Kubernetes API server Host # If not specified, Dashboard will attempt to auto discover the API server and connect # to it. Uncomment only if the default does not work. # - --apiserver-host=http://my-address:port volumeMounts: - name: kubernetes-dashboard-certs mountPath: /certs # Create on-disk volume to store exec logs - mountPath: /tmp name: tmp-volume livenessProbe: httpGet: scheme: HTTPS path: / port: 8443 initialDelaySeconds: 30 timeoutSeconds: 30 volumes: - name: kubernetes-dashboard-certs secret: secretName: kubernetes-dashboard-certs - name: tmp-volume emptyDir: &#123;&#125; serviceAccountName: kubernetes-dashboard # Comment the following tolerations if Dashboard must not be deployed on master tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule---# ------------------- Dashboard Service ------------------- #kind: ServiceapiVersion: v1metadata: labels: k8s-app: kubernetes-dashboard name: kubernetes-dashboard namespace: kube-systemspec: type: NodePort ports: - port: 443 targetPort: 8443 nodePort: 30001 selector: k8s-app: kubernetes-dashboard 1kubectl apply -f kubernetes-dashboard.yaml --record ç­‰ä¸€ä¼šå°±å¯ä»¥äº† 123[root@master ~]# kubectl get pods -n kube-systemNAME READY STATUS RESTARTS AGEkubernetes-dashboard-5f7b999d65-s2lgq 1&#x2F;1 Running 0 17h ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹å¯¹åº”ç­‰ç½‘ç»œç«¯å£ç›‘å¬ 12[root@master ~]# netstat -anp | grep 30001tcp6 0 0 :::30001 :::* LISTEN 27609/kube-proxy 123[root@master ~]# kubectl get svc -n kube-systemNAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGEkubernetes-dashboard NodePort 10.104.204.139 &lt;none&gt; 443:30001/TCP 17h å‘ç°ä¹Ÿç”Ÿæ•ˆäº†ã€‚\b æ³¨æ„ï¼šæˆ‘ä»¬è®¿é—®çš„æ—¶å€™æ˜¯é€šè¿‡&lt;NodeIPï¼šNodePort&gt;çš„æ–¹å¼æ¥è®¿é—®ï¼Œè€Œä¸”å¿…é¡»æ˜¯httpsçš„å½¢å¼ åœ¨æµè§ˆå™¨è¾“å…¥å¦‚ä¸‹ä¿¡æ¯ 1https://192.168.8.171:30001 å°±ä¼šè¿›å…¥åˆ°ç™»å½•é¡µé¢. è¿™é‡Œæœ‰ä¸€äº›äººä¼šè¯´è°·æ­Œæµè§ˆå™¨ç™»å½•ä¸äº†ï¼Œç›®å‰æ²¡é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæš‚æ—¶ä¸å¤ªäº†è§£è¿™ä¸ªæƒ…å†µã€‚ è¿™é‡Œï¼Œå¯ä»¥é€šè¿‡ kube-config æ–‡ä»¶æ¥ç™»å½•æˆ–è€…é€šè¿‡ token æ¥ç™»å½• ç™»å½•è®¤è¯æœ‰ä¸¤ç§æ–¹å¼ Token Kubeconfig Token1kubectl -n kube-system describe $(kubectl -n kube-system get secret -n kube-system -o name | grep namespace) | grep token ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° token çš„ä¿¡æ¯ï¼Œæ‰‹åŠ¨å¤åˆ¶å‡ºæ¥ä½¿ç”¨ 1234[root@master ~]# kubectl -n kube-system describe $(kubectl -n kube-system get secret -n kube-system -o name | grep namespace) | grep tokenName: namespace-controller-token-ghvr9Type: kubernetes.io/service-account-tokentoken: eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlci10b2tlbi1naHZyOSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjczZTg5OGJjLTgxMzEtMTFlOS1hNTdhLTAwNTA1NjlkMGYzMCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpuYW1lc3BhY2UtY29udHJvbGxlciJ9.S4nPVa2-JAmRX_yVtoA9sR-JAnmLF5XdqQwrPmtQiohswyHWaAtEJyCF5wc8SIQmXbqn3XpeGNMLcyGd5xfAR4pIG0ljk5z6zoDc18M0Icnx5If0hxs4fWrhSNYYfzK7YnYOe_cjlydhbgTQ0vJoAXMURnX5dLFuNcp8QNaesNNnapZS2GPrjRYLNHw_WyCyU4i_tIwfiHW4ktrGD8SuX5g564gDZ9Xdee4CVHFveWNOrgWkV63n0fy8eNu9S6QpTsRb32M3MaZwlsp-2SFzcJbmAUj3ZiJ8KuBmZtBF249007SxiGwWzP3YQ5sXU38orSf8n-Spv5r-7ZHIzt0brw 1eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlci10b2tlbi1naHZyOSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJuYW1lc3BhY2UtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjczZTg5OGJjLTgxMzEtMTFlOS1hNTdhLTAwNTA1NjlkMGYzMCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTpuYW1lc3BhY2UtY29udHJvbGxlciJ9.S4nPVa2-JAmRX_yVtoA9sR-JAnmLF5XdqQwrPmtQiohswyHWaAtEJyCF5wc8SIQmXbqn3XpeGNMLcyGd5xfAR4pIG0ljk5z6zoDc18M0Icnx5If0hxs4fWrhSNYYfzK7YnYOe_cjlydhbgTQ0vJoAXMURnX5dLFuNcp8QNaesNNnapZS2GPrjRYLNHw_WyCyU4i_tIwfiHW4ktrGD8SuX5g564gDZ9Xdee4CVHFveWNOrgWkV63n0fy8eNu9S6QpTsRb32M3MaZwlsp-2SFzcJbmAUj3ZiJ8KuBmZtBF249007SxiGwWzP3YQ5sXU38orSf8n-Spv5r-7ZHIzt0brw åœ¨ç™»å½•é¡µé¢ï¼Œè¾“å…¥è¿™ä¸ª tokenï¼Œå³å¯è¿›å…¥åˆ°ä»ªè¡¨ç›˜å†…éƒ¨ Kubeconfigåªéœ€è¦åœ¨ kubeadm ç”Ÿæˆçš„ admin.conf æ–‡ä»¶æœ«å°¾åŠ ä¸Šåˆšåˆšè·å–çš„ token å°±å¯ä»¥äº† 12345- name: kubernetes-admin user: client-certificate-data: xxxxxxxx client-key-data: xxxxxx token: \"åœ¨è¿™é‡ŒåŠ ä¸Štoken\" å†…éƒ¨ç³»ç»Ÿç»“æœå›¾è¿™æ ·å­ç®—æ˜¯å®Œæˆäº†åŸºæœ¬çš„éƒ¨ç½²å’Œå¤„ç†","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"}]},{"title":"ã€å¤§æ•°æ®ã€‘- Hadoop åŸºæœ¬æ¦‚å¿µ","slug":"å¤§æ•°æ®/HadoopåŸºæœ¬æ¦‚å¿µ","date":"2019-06-12T01:56:40.000Z","updated":"2021-03-20T16:25:01.815Z","comments":true,"path":"2019/06/12/å¤§æ•°æ®/HadoopåŸºæœ¬æ¦‚å¿µ/","link":"","permalink":"http://blog.crazylaw.cn/2019/06/12/%E5%A4%A7%E6%95%B0%E6%8D%AE/Hadoop%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/","excerpt":"å‰è¨€Hadoop æ˜¯ä¸€ä¸ªç”± Apache åŸºé‡‘ä¼šæ‰€å¼€å‘çš„åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€æ¶æ„ï¼Œå®ƒå¯ä»¥ä½¿ç”¨æˆ·åœ¨ä¸äº†è§£åˆ†å¸ƒå¼åº•å±‚ç»†èŠ‚çš„æƒ…æ³ä¸‹å¼€å‘åˆ†å¸ƒå¼ç¨‹åºï¼Œå……åˆ†åˆ©ç”¨é›†ç¾¤çš„å¨åŠ›è¿›è¡Œé«˜é€Ÿè¿ç®—å’Œå­˜å‚¨ã€‚ ä»å…¶å®šä¹‰å°±å¯ä»¥å‘ç°ï¼Œå®ƒè§£æ±ºäº†ä¸¤å¤§é—®é¢˜ï¼šå¤§æ•°æ®å­˜å‚¨ã€å¤§æ•°æ®åˆ†æã€‚ä¹Ÿå°±æ˜¯ Hadoop çš„ä¸¤å¤§æ ¸å¿ƒï¼šHDFS å’Œ MapReduceã€‚ HDFS(Hadoop Distributed File System)æ˜¯å¯æ‰©å±•ã€å®¹é”™ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå¼‚æ­¥å¤åˆ¶ï¼Œä¸€æ¬¡å†™å…¥å¤šæ¬¡è¯»å–ï¼Œä¸»è¦è´Ÿè´£å­˜å‚¨ã€‚ MapReduce ä¸ºåˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼ŒåŒ…å« map(æ˜ å°„)å’Œ reduce(å½’çº¦)è¿‡ç¨‹ï¼Œè´Ÿè´£åœ¨ HDFS ä¸Šè¿›è¡Œè®¡ç®—ã€‚ ä½†æ˜¯ç”±äºç›®å‰æˆ‘æ²¡æœ‰ç”¨åˆ° MapReduceï¼Œå¹¶ä¸” MapReduce èƒ½æ•ˆè¿‡äºåœ°ä¸‹å¹¶ä¸”å¾ˆå ç³»ç»Ÿèµ„æ–™ï¼Œæ‰€ä»¥ä¸€èˆ¬æ•°æ®åˆ†æéƒ½ä¼šç”¨å…¶ä»–çš„æ¥ä»£æ›¿ã€‚ æ‰€ä»¥è¿™é‡Œä»‹ç»çš„ Hadoopï¼Œä¼šé‡ç‚¹è®²è§£ HDFS å’Œå…¶å·¥ä½œåŸç†ã€‚","text":"å‰è¨€Hadoop æ˜¯ä¸€ä¸ªç”± Apache åŸºé‡‘ä¼šæ‰€å¼€å‘çš„åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€æ¶æ„ï¼Œå®ƒå¯ä»¥ä½¿ç”¨æˆ·åœ¨ä¸äº†è§£åˆ†å¸ƒå¼åº•å±‚ç»†èŠ‚çš„æƒ…æ³ä¸‹å¼€å‘åˆ†å¸ƒå¼ç¨‹åºï¼Œå……åˆ†åˆ©ç”¨é›†ç¾¤çš„å¨åŠ›è¿›è¡Œé«˜é€Ÿè¿ç®—å’Œå­˜å‚¨ã€‚ ä»å…¶å®šä¹‰å°±å¯ä»¥å‘ç°ï¼Œå®ƒè§£æ±ºäº†ä¸¤å¤§é—®é¢˜ï¼šå¤§æ•°æ®å­˜å‚¨ã€å¤§æ•°æ®åˆ†æã€‚ä¹Ÿå°±æ˜¯ Hadoop çš„ä¸¤å¤§æ ¸å¿ƒï¼šHDFS å’Œ MapReduceã€‚ HDFS(Hadoop Distributed File System)æ˜¯å¯æ‰©å±•ã€å®¹é”™ã€é«˜æ€§èƒ½çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå¼‚æ­¥å¤åˆ¶ï¼Œä¸€æ¬¡å†™å…¥å¤šæ¬¡è¯»å–ï¼Œä¸»è¦è´Ÿè´£å­˜å‚¨ã€‚ MapReduce ä¸ºåˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶ï¼ŒåŒ…å« map(æ˜ å°„)å’Œ reduce(å½’çº¦)è¿‡ç¨‹ï¼Œè´Ÿè´£åœ¨ HDFS ä¸Šè¿›è¡Œè®¡ç®—ã€‚ ä½†æ˜¯ç”±äºç›®å‰æˆ‘æ²¡æœ‰ç”¨åˆ° MapReduceï¼Œå¹¶ä¸” MapReduce èƒ½æ•ˆè¿‡äºåœ°ä¸‹å¹¶ä¸”å¾ˆå ç³»ç»Ÿèµ„æ–™ï¼Œæ‰€ä»¥ä¸€èˆ¬æ•°æ®åˆ†æéƒ½ä¼šç”¨å…¶ä»–çš„æ¥ä»£æ›¿ã€‚ æ‰€ä»¥è¿™é‡Œä»‹ç»çš„ Hadoopï¼Œä¼šé‡ç‚¹è®²è§£ HDFS å’Œå…¶å·¥ä½œåŸç†ã€‚ Hadoop å­˜å‚¨ - HDFSHadoop çš„å­˜å‚¨ç³»ç»Ÿæ˜¯ HDFS(Hadoop Distributed File System)åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¹å¤–éƒ¨å®¢æˆ·ç«¯è€Œè¨€ï¼ŒHDFS å°±åƒä¸€ä¸ªä¼ ç»Ÿçš„åˆ†çº§æ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥è¿›è¡Œåˆ›å»ºã€åˆ é™¤ã€ç§»åŠ¨æˆ–é‡å‘½åæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ç­‰æ“ä½œï¼Œä¸ Linux æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ã€‚ ä½†æ˜¯ï¼ŒHadoop HDFS çš„æ¶æ„æ˜¯åŸºäºä¸€ç»„ç‰¹å®šçš„èŠ‚ç‚¹æ„å»ºçš„ï¼Œåç§°èŠ‚ç‚¹ï¼ˆNameNodeï¼Œä»…ä¸€ä¸ª)ï¼Œå®ƒåœ¨ HDFS å†…éƒ¨æä¾›å…ƒæ•°æ®æœåŠ¡ï¼›ç¬¬äºŒåç§°èŠ‚ç‚¹(Secondary NameNode)ï¼Œåç§°èŠ‚ç‚¹çš„å¸®åŠ©èŠ‚ç‚¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ•´åˆå…ƒæ•°æ®æ“ä½œ(æ³¨æ„ä¸æ˜¯åç§°èŠ‚ç‚¹çš„å¤‡ä»½)ï¼›æ•°æ®èŠ‚ç‚¹(DataNode)ï¼Œå®ƒä¸º HDFS æä¾›å­˜å‚¨å—ã€‚ç”±äºä»…æœ‰ä¸€ä¸ª NameNodeï¼Œå› æ­¤è¿™æ˜¯ HDFS çš„ä¸€ä¸ªç¼ºç‚¹(å•ç‚¹å¤±è´¥ï¼Œåœ¨ Hadoop2.x åæœ‰è¾ƒå¤§æ”¹å–„)ã€‚ NameNodeå®ƒæ˜¯ä¸€ä¸ªé€šå¸¸åœ¨ HDFS æ¶æ„ä¸­å•ç‹¬æœºå™¨ä¸Šè¿è¡Œçš„ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†æ–‡ä»¶ç³»ç»Ÿåç§°ç©ºé—´å’Œæ§åˆ¶å¤–éƒ¨å®¢æˆ·æœºçš„è®¿é—®ã€‚NameNode å†³å®šæ˜¯å¦å°†æ–‡ä»¶æ˜ å°„åˆ° DataNode ä¸Šçš„å¤åˆ¶å—ä¸Šã€‚å¯¹äºæœ€å¸¸è§çš„ 3 ä¸ªå¤åˆ¶å—ï¼Œç¬¬ä¸€ä¸ªå¤åˆ¶å—å­˜å‚¨åœ¨åŒä¸€æœºæ¶çš„ä¸åŒèŠ‚ç‚¹ä¸Šï¼Œæœ€åä¸€ä¸ªå¤åˆ¶å—å­˜å‚¨åœ¨ä¸åŒæœºæ¶çš„æŸä¸ªèŠ‚ç‚¹ä¸Šã€‚ Secondary NameNodeç¬¬äºŒåç§°èŠ‚ç‚¹çš„ä½œç”¨åœ¨äºä¸º HDFS ä¸­çš„åç§°èŠ‚ç‚¹æä¾›ä¸€ä¸ª Checkpointï¼Œå®ƒåªæ˜¯åç§°èŠ‚ç‚¹çš„ä¸€ä¸ªåŠ©æ‰‹èŠ‚ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯å®ƒåœ¨ç¤¾åŒºå†…è¢«è®¤ä¸ºæ˜¯ Checkpoint Node çš„åŸå› ã€‚ DatabNodeæ•°æ®èŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªé€šå¸¸åœ¨ HDFS æ¶æ„ä¸­çš„å•ç‹¬æœºå™¨ä¸Šè¿è¡Œçš„ç»„ä»¶ã€‚Hadoop é›†ç¾¤åŒ…å«ä¸€ä¸ª NameNode å’Œå¤§é‡ DataNodeã€‚æ•°æ®èŠ‚ç‚¹é€šå¸¸ä»¥æœºæ¶çš„å½¢å¼ç»„ç»‡ï¼Œæœºæ¶é€šè¿‡ä¸€ä¸ªäº¤æ¢æœºå°†æ‰€æœ‰ç³»ç»Ÿè¿æ¥èµ·æ¥ã€‚ æ•°æ®èŠ‚ç‚¹å“åº”æ¥è‡ª HDFS å®¢æˆ·æœºçš„è¯»å†™è¯·æ±‚ã€‚å®ƒä»¬è¿˜å“åº”æ¥è‡ª NameNode çš„åˆ›å»ºã€åˆ é™¤å’Œå¤åˆ¶å—çš„å‘½ä»¤ã€‚åç§°èŠ‚ç‚¹ä¾èµ–æ¥è‡ªæ¯ä¸ªæ•°æ®èŠ‚ç‚¹çš„å®šæœŸå¿ƒè·³ï¼ˆheartbeatï¼‰æ¶ˆæ¯ã€‚æ¯æ¡æ¶ˆæ¯éƒ½åŒ…å«ä¸€ä¸ªå—æŠ¥å‘Šï¼Œåç§°èŠ‚ç‚¹å¯ä»¥æ ¹æ®è¿™ä¸ªæŠ¥å‘ŠéªŒè¯å—æ˜ å°„å’Œå…¶ä»–æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ã€‚å¦‚æœæ•°æ®èŠ‚ç‚¹ä¸èƒ½å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œåç§°èŠ‚ç‚¹å°†é‡‡å–ä¿®å¤æªæ–½ï¼Œé‡æ–°å¤åˆ¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šä¸¢å¤±çš„å—ã€‚","categories":[{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}],"tags":[{"name":"å¤§æ•°æ®ï¼ŒHadoop","slug":"å¤§æ•°æ®ï¼ŒHadoop","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%EF%BC%8CHadoop/"}]},{"title":"ã€kubernetesã€‘nginx-ingress","slug":"k8s/k8s-nginx-ingress","date":"2019-06-04T03:28:30.000Z","updated":"2021-03-20T16:25:01.807Z","comments":true,"path":"2019/06/04/k8s/k8s-nginx-ingress/","link":"","permalink":"http://blog.crazylaw.cn/2019/06/04/k8s/k8s-nginx-ingress/","excerpt":"å‰è¨€Ingress æ˜¯ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„ä¸œè¥¿ï¼Œå…¶ä¸»è¦ç”¨æ¥è§£å†³ä½¿ç”¨ NodePort æš´éœ² Service çš„ç«¯å£æ—¶ Node IP ä¼šæ¼‚ç§»çš„é—®é¢˜ã€‚åŒæ—¶ï¼Œè‹¥å¤§é‡ä½¿ç”¨ NodePort æš´éœ²ä¸»æœºç«¯å£ï¼Œç®¡ç†ä¼šéå¸¸æ··ä¹±ã€‚ å¥½çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯è®©å¤–ç•Œé€šè¿‡åŸŸåå»è®¿é—® Serviceï¼Œè€Œæ— éœ€å…³å¿ƒå…¶ Node IP åŠ Portã€‚é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ Nginxï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨ K8S é›†ç¾¤ä¸­ï¼Œå¦‚æœæ¯åŠ å…¥ä¸€ä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬éƒ½åœ¨ Nginx ä¸­æ·»åŠ ä¸€ä¸ªé…ç½®ï¼Œå…¶å®æ˜¯ä¸€ä¸ªé‡å¤æ€§çš„ä½“åŠ›æ´»ï¼Œåªè¦æ˜¯é‡å¤æ€§çš„ä½“åŠ›æ´»ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥é€šè¿‡æŠ€æœ¯å°†å®ƒå¹²æ‰ã€‚ Ingress å°±å¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œå…¶åŒ…å«ä¸¤ä¸ªç»„ä»¶ Ingress Controller å’Œ Ingressï¼š Ingress ï¼ˆå°† Nginx çš„é…ç½®æŠ½è±¡æˆä¸€ä¸ª Ingress å¯¹è±¡ï¼Œæ¯æ·»åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡åªéœ€å†™ä¸€ä¸ªæ–°çš„ Ingress çš„ yaml æ–‡ä»¶å³å¯ï¼‰ Ingress Controller ï¼ˆå°†æ–°åŠ å…¥çš„ Ingress è½¬åŒ–æˆ Nginx çš„é…ç½®æ–‡ä»¶å¹¶ä½¿ä¹‹ç”Ÿæ•ˆï¼‰","text":"å‰è¨€Ingress æ˜¯ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„ä¸œè¥¿ï¼Œå…¶ä¸»è¦ç”¨æ¥è§£å†³ä½¿ç”¨ NodePort æš´éœ² Service çš„ç«¯å£æ—¶ Node IP ä¼šæ¼‚ç§»çš„é—®é¢˜ã€‚åŒæ—¶ï¼Œè‹¥å¤§é‡ä½¿ç”¨ NodePort æš´éœ²ä¸»æœºç«¯å£ï¼Œç®¡ç†ä¼šéå¸¸æ··ä¹±ã€‚ å¥½çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯è®©å¤–ç•Œé€šè¿‡åŸŸåå»è®¿é—® Serviceï¼Œè€Œæ— éœ€å…³å¿ƒå…¶ Node IP åŠ Portã€‚é‚£ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ Nginxï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨ K8S é›†ç¾¤ä¸­ï¼Œå¦‚æœæ¯åŠ å…¥ä¸€ä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬éƒ½åœ¨ Nginx ä¸­æ·»åŠ ä¸€ä¸ªé…ç½®ï¼Œå…¶å®æ˜¯ä¸€ä¸ªé‡å¤æ€§çš„ä½“åŠ›æ´»ï¼Œåªè¦æ˜¯é‡å¤æ€§çš„ä½“åŠ›æ´»ï¼Œæˆ‘ä»¬éƒ½åº”è¯¥é€šè¿‡æŠ€æœ¯å°†å®ƒå¹²æ‰ã€‚ Ingress å°±å¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œå…¶åŒ…å«ä¸¤ä¸ªç»„ä»¶ Ingress Controller å’Œ Ingressï¼š Ingress ï¼ˆå°† Nginx çš„é…ç½®æŠ½è±¡æˆä¸€ä¸ª Ingress å¯¹è±¡ï¼Œæ¯æ·»åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡åªéœ€å†™ä¸€ä¸ªæ–°çš„ Ingress çš„ yaml æ–‡ä»¶å³å¯ï¼‰ Ingress Controller ï¼ˆå°†æ–°åŠ å…¥çš„ Ingress è½¬åŒ–æˆ Nginx çš„é…ç½®æ–‡ä»¶å¹¶ä½¿ä¹‹ç”Ÿæ•ˆï¼‰ é›†ç¾¤å†…éƒ¨è®¿é—® ClusterIp é›†ç¾¤å¤–è®¿é—®ï¼š NodePort Loadbalancer ï¼ˆäº‘æœåŠ¡å•†ï¼‰ Ingress Ingress-nginxIngress-nginx åœ¨æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œingress-nginx åˆ°æœ€æ–°ç‰ˆæœ¬ä¸ºï¼š0.24.1ï¼Œä½†æ˜¯ç§‰æ‰¿ç€ç¨³å®šçš„æƒ³æ³•ï¼Œæœ¬æ¬¡æˆ‘ä»¬ä½¿ç”¨0.20.0ä½œä¸ºæˆ‘ä»¬çš„ç‰ˆæœ¬ ç”±äºæˆ‘ä»¬æœåŠ¡å™¨å¹¶æ²¡æœ‰ç¿»å¢™ï¼Œæ‰€ä»¥æ‰¾äº†å›½å†…çš„å‡ ä¸ªé•œåƒä¸‹è½½ï¼Œé‡æ–°æ‰“ tag 1docker pull registry.cn-qingdao.aliyuncs.com/kubernetes_xingej/defaultbackend-amd64:1.5 &amp;&amp; docker pull registry.cn-qingdao.aliyuncs.com/kubernetes_xingej/nginx-ingress-controller:0.20.0 &amp;&amp; docker tag registry.cn-qingdao.aliyuncs.com/kubernetes_xingej/defaultbackend-amd64:1.5 k8s.gcr.io/defaultbackend-amd64:1.5 &amp;&amp; docker tag registry.cn-qingdao.aliyuncs.com/kubernetes_xingej/nginx-ingress-controller:0.20.0 quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.20.0 æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å»åˆ° ingress-nginx æ‰¾åˆ° å¯¹åº” 0.20.0çš„ç‰ˆæœ¬ï¼Œä¸‹è½½ k8s é…ç½®æ–‡ä»¶ã€‚ Ingress-nginx(v0.20.0) æˆ‘ä»¬åªéœ€è¦å…³æ³¨ mandatory.yaml å³å¯ 1wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.20.0/deploy/mandatory.yaml æˆ‘ä»¬éœ€è¦ä¿®æ”¹é‡ç‚¹éœ€è¦ä¿®æ”¹ hostNetwork: true (ç”¨æˆ·ä½¿å¾—å®¹å™¨çš„ç½‘ç»œ namespace å’Œå®¿ä¸»æœºçš„ namespaceï¼Œé€šè¿‡æš´éœ²å®¿ node èŠ‚ç‚¹çš„ 80 ç«¯å£æ¥ä½œä¸º ingress å…¥å£èŠ‚ç‚¹ç«¯å£) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324apiVersion: v1kind: Namespacemetadata: name: ingress-nginx---apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: default-http-backend labels: app.kubernetes.io/name: default-http-backend app.kubernetes.io/part-of: ingress-nginx namespace: ingress-nginxspec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: default-http-backend app.kubernetes.io/part-of: ingress-nginx template: metadata: labels: app.kubernetes.io/name: default-http-backend app.kubernetes.io/part-of: ingress-nginx spec: terminationGracePeriodSeconds: 60 containers: - name: default-http-backend # Any image is permissible as long as: # 1. It serves a 404 page at / # 2. It serves 200 on a /healthz endpoint image: k8s.gcr.io/defaultbackend-amd64:1.5 livenessProbe: httpGet: path: /healthz port: 8080 scheme: HTTP initialDelaySeconds: 30 timeoutSeconds: 5 ports: - containerPort: 8080 resources: limits: cpu: 10m memory: 20Mi requests: cpu: 10m memory: 20Mi---apiVersion: v1kind: Servicemetadata: name: default-http-backend namespace: ingress-nginx labels: app.kubernetes.io/name: default-http-backend app.kubernetes.io/part-of: ingress-nginxspec: ports: - port: 80 targetPort: 8080 selector: app.kubernetes.io/name: default-http-backend app.kubernetes.io/part-of: ingress-nginx---kind: ConfigMapapiVersion: v1metadata: name: nginx-configuration namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx---kind: ConfigMapapiVersion: v1metadata: name: tcp-services namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx---kind: ConfigMapapiVersion: v1metadata: name: udp-services namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx---apiVersion: v1kind: ServiceAccountmetadata: name: nginx-ingress-serviceaccount namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx---apiVersion: rbac.authorization.k8s.io/v1beta1kind: ClusterRolemetadata: name: nginx-ingress-clusterrole labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginxrules: - apiGroups: - '' resources: - configmaps - endpoints - nodes - pods - secrets verbs: - list - watch - apiGroups: - '' resources: - nodes verbs: - get - apiGroups: - '' resources: - services verbs: - get - list - watch - apiGroups: - 'extensions' resources: - ingresses verbs: - get - list - watch - apiGroups: - '' resources: - events verbs: - create - patch - apiGroups: - 'extensions' resources: - ingresses/status verbs: - update---apiVersion: rbac.authorization.k8s.io/v1beta1kind: Rolemetadata: name: nginx-ingress-role namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginxrules: - apiGroups: - '' resources: - configmaps - pods - secrets - namespaces verbs: - get - apiGroups: - '' resources: - configmaps resourceNames: # Defaults to \"&lt;election-id&gt;-&lt;ingress-class&gt;\" # Here: \"&lt;ingress-controller-leader&gt;-&lt;nginx&gt;\" # This has to be adapted if you change either parameter # when launching the nginx-ingress-controller. - 'ingress-controller-leader-nginx' verbs: - get - update - apiGroups: - '' resources: - configmaps verbs: - create - apiGroups: - '' resources: - endpoints verbs: - get---apiVersion: rbac.authorization.k8s.io/v1beta1kind: RoleBindingmetadata: name: nginx-ingress-role-nisa-binding namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginxroleRef: apiGroup: rbac.authorization.k8s.io kind: Role name: nginx-ingress-rolesubjects: - kind: ServiceAccount name: nginx-ingress-serviceaccount namespace: ingress-nginx---apiVersion: rbac.authorization.k8s.io/v1beta1kind: ClusterRoleBindingmetadata: name: nginx-ingress-clusterrole-nisa-binding labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginxroleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: nginx-ingress-clusterrolesubjects: - kind: ServiceAccount name: nginx-ingress-serviceaccount namespace: ingress-nginx---apiVersion: extensions/v1beta1kind: Deploymentmetadata: name: nginx-ingress-controller namespace: ingress-nginx labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginxspec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx template: metadata: labels: app.kubernetes.io/name: ingress-nginx app.kubernetes.io/part-of: ingress-nginx annotations: prometheus.io/port: '10254' prometheus.io/scrape: 'true' spec: serviceAccountName: nginx-ingress-serviceaccount hostNetwork: true containers: - name: nginx-ingress-controller imagePullPolicy: IfNotPresent image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.20.0 args: - /nginx-ingress-controller - --default-backend-service=$(POD_NAMESPACE)/default-http-backend - --configmap=$(POD_NAMESPACE)/nginx-configuration - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services - --udp-services-configmap=$(POD_NAMESPACE)/udp-services - --publish-service=$(POD_NAMESPACE)/ingress-nginx - --annotations-prefix=nginx.ingress.kubernetes.io securityContext: capabilities: drop: - ALL add: - NET_BIND_SERVICE # www-data -&gt; 33 runAsUser: 33 env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace ports: - name: http containerPort: 80 - name: https containerPort: 443 livenessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP initialDelaySeconds: 10 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1 readinessProbe: failureThreshold: 3 httpGet: path: /healthz port: 10254 scheme: HTTP periodSeconds: 10 successThreshold: 1 timeoutSeconds: 1--- ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œè¿™ä¸ª yaml 1kubectl apply -f mandatory.yaml 1234[root@master 20]# kubectl get pods -n ingress-nginxNAME READY STATUS RESTARTS AGEdefault-http-backend-5c9bb94849-fhlt8 1/1 Running 0 39hnginx-ingress-controller-84d5b54fdf-2hxbh 1/1 Running 0 39h è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†æœ‰ 2 ä¸ª pod äº†ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯é»˜è®¤çš„ http è¯·æ±‚ç«¯å£ï¼Œè¿™ä¸ª pod é‡Œé¢çš„æœåŠ¡çš„ä½œç”¨æ˜¯ï¼Œå½“æ²¡æœ‰ä¸€ä¸ª rule åŒ¹é…åˆ° ingress çš„æ—¶å€™ï¼Œå°±ä¼šè¢«åˆ†å‘åˆ°è¿™ä¸ª pod ä¸Šï¼Œç„¶åè¿”å› 404 åˆ°ç›¸å…³ä¿¡æ¯ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®æˆ‘ä»¬è‡ªå·±çš„åç«¯æœåŠ¡äº†ï¼Œä»¥ nginxæœåŠ¡ ä¸ºä¾‹å­: nginx.yaml 12345678910111213141516171819202122232425262728293031323334apiVersion: apps/v1kind: Deploymentmetadata: name: my-nginx labels: app: my-nginxspec: replicas: 1 selector: matchLabels: app: my-nginx template: metadata: labels: app: my-nginx spec: containers: - name: my-nginx image: nginx:1.7.9 ports: - containerPort: 80---apiVersion: v1kind: Servicemetadata: name: my-nginxspec: ports: - port: 80 targetPort: 80 protocol: TCP selector: app: my-nginx è¿™ä¸ªéƒ¨ç½²æ–‡ä»¶ä¸­ï¼Œé‡Œé¢è®¾ç½®äº† 2 ç§ kindï¼Œåˆ†åˆ«æ˜¯ Deploymentï¼Œä¸»è¦æ˜¯ç”¨äºè®¾ç½®å’Œå®¹å™¨ç›¸å…³çš„ä¿¡æ¯ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ Serviceï¼Œä¸»è¦æ˜¯ç”¨äºè®¾ç½®æœåŠ¡æš´éœ²ç«¯å£å’Œé›†ç¾¤å†…éƒ¨æœåŠ¡è½¬å‘ç›¸å…³çš„ä¿¡æ¯ã€‚ Deploymentï¼šè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘çš„é…ç½®æ˜¯ nginx:1.7.9 ä¸ºåŸºç¡€é•œåƒï¼Œå¹¶ä¸”å®¹å™¨æš´éœ²çš„ç«¯å£ä¸º 80 ç«¯å£Serviceï¼šè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘çš„é…ç½®æ˜¯ spec.ports[].port = 80ï¼Œspec.ports[].targetPort = 80(è¿™ä¸ªä¸è®¾ç½®çš„è¯ä¹Ÿå¯ä»¥ï¼Œé»˜è®¤å’Œportä¸€è‡´)ã€‚ è¿™æ ·å­ï¼Œæˆ‘ä»¬çš„ä¸€ä¸ªåŸºç¡€çš„ nginx æœåŠ¡å°±è®¾ç½®å®Œæ¯•äº†ã€‚ æ¥ä¸‹é‡Œï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ingress é…ç½®ï¼Œæ–‡ä»¶åä¸ºï¼šnginx-ingress.yaml 123456789101112131415apiVersion: extensions/v1beta1kind: Ingressmetadata: name: ingress-mynginx annotations: kubernetes.io/ingress.class: 'nginx'spec: rules: - host: k8s-nginx.mingchao.com http: paths: - path: backend: serviceName: my-nginx servicePort: 80 è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ç»‘å®šäº† k8s-nginx.mingchao.com è¿™ä¸ªhost(serviceName)(åŸŸå) æŒ‡å‘äº†åç«¯æœåŠ¡åå­—å« my-nginxï¼Œå¹¶ä¸”ç«¯å£ä¸º 80 çš„æœåŠ¡ã€‚å…¶å®è¿™é‡Œå°±æ˜¯æŒ‡å‘äº†æˆ‘ä»¬åˆšæ‰è®¾ç½®çš„ nginxæœåŠ¡ æˆ‘ä»¬å¯åŠ¨ä¸€ä¸‹è¿™ä¸ªé…ç½® 1kubectl apply -f nginx-ingress.yaml æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»“æœï¼š 123[root@master nginx]# kubectl get ingressNAME HOSTS ADDRESS PORTS AGEingress-mynginx k8s-nginx.mingchao.com 80 16h å‘ç°è¿™ä¸ª Ingress å·²ç»ç”Ÿæ•ˆäº†ã€‚ç”±äºæˆ‘ä»¬æ˜¯åœ¨æœ¬åœ°æµ‹è¯•ï¼Œå¹¶æ²¡æœ‰ç”¨å…¬ç½‘çš„åŸŸåï¼Œæ‰€ä»¥å…¬ç½‘çš„ DNS æ˜¯æ‰¾åˆ°æˆ‘ä»¬çš„åŸŸåï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åšæœ¬åœ° Hostï¼Œæ‰“å¼€ /etc/hosts æ–‡ä»¶ï¼Œè¿›è¡Œæ·»åŠ  host ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨æµè§ˆå™¨æ‰“å¼€äº†ã€‚ ä½†æ˜¯è¿™é‡Œä¸ºäº†å·æ‡’ï¼Œæˆ‘ç›´æ¥ç”¨ curl æŒ‡å®š host çš„æ–¹æ³•è®¿é—®è¯•è¯•ï¼Œç»“æœå¦‚ä¸‹ è®°å¾—ï¼Œè®¿é—®çš„æ˜¯ node èŠ‚ç‚¹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546[root@master nginx]# curl -v http://192.168.8.174 -H 'host: k8s-nginx.mingchao.com'* About to connect() to 192.168.8.174 port 80 (#0)* Trying 192.168.8.174...* Connected to 192.168.8.174 (192.168.8.174) port 80 (#0)&gt; GET / HTTP/1.1&gt; User-Agent: curl/7.29.0&gt; Accept: */*&gt; host: k8s-nginx.mingchao.com&gt;&lt; HTTP/1.1 200 OK&lt; Server: nginx/1.15.5&lt; Date: Fri, 07 Jun 2019 01:51:22 GMT&lt; Content-Type: text/html&lt; Content-Length: 612&lt; Connection: keep-alive&lt; Vary: Accept-Encoding&lt; Last-Modified: Tue, 23 Dec 2014 16:25:09 GMT&lt; ETag: \"54999765-264\"&lt; Accept-Ranges: bytes&lt;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Welcome to nginx!&lt;/title&gt;&lt;style&gt; body &#123; width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; &#125;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;&lt;p&gt;If you see this page, the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p&gt;&lt;p&gt;For online documentation and support please refer to&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;Commercial support is available at&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;* Connection #0 to host 192.168.8.174 left intact è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æˆ‘ä»¬å°±å¯ä»¥å‘ç°ï¼Œå·²ç»è®¿é—®æˆåŠŸäº†ï¼Œå°±è¿™æ ·å­ï¼Œé€šè¿‡ ingress-nginx è¿™ä¸ªç»„ä»¶ä¿®æ”¹ hostNetwork = trueï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®ç°ï¼Œé€šè¿‡åŸŸåè®¿é—® 80 ç«¯å£ä»è€Œè½¬å‘åˆ°æˆ‘ä»¬åç«¯çš„ä»»æ„ä¸€ç§åç«¯æœåŠ¡ è¿™æ ·å­ï¼Œæˆ‘ä»¬çš„ ingress-nginx åŸºæœ¬å°±ç®—æ˜¯å®Œæˆäº†ã€‚","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"}]},{"title":"ã€Dockerã€‘æ­å»ºdockerç§æœ‰ä»“åº“","slug":"docker/æ­å»ºdockerç§æœ‰ä»“åº“","date":"2019-05-31T03:28:30.000Z","updated":"2021-03-20T16:25:01.805Z","comments":true,"path":"2019/05/31/docker/æ­å»ºdockerç§æœ‰ä»“åº“/","link":"","permalink":"http://blog.crazylaw.cn/2019/05/31/docker/%E6%90%AD%E5%BB%BAdocker%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93/","excerpt":"å‰è¨€ä¸ºäº†é…åˆ k8sï¼Œéœ€è¦æ­å»ºä¸€ä¸ªç§æœ‰ä»“åº“ï¼Œé˜²æ­¢é•œåƒæ³„æ¼å‡ºå»ã€‚","text":"å‰è¨€ä¸ºäº†é…åˆ k8sï¼Œéœ€è¦æ­å»ºä¸€ä¸ªç§æœ‰ä»“åº“ï¼Œé˜²æ­¢é•œåƒæ³„æ¼å‡ºå»ã€‚ æœºå™¨å‡†å¤‡æœ€å°åŒ–åˆ†å¸ƒå¼é›†ç¾¤å®‰è£…ï¼Œä¸€å°masterï¼Œä¸€å°nodeã€‚åç»­å¯ä»¥è°ƒæ•´ä¸ºå¤šmasterï¼Œè§£å†³å•ç‚¹é—®é¢˜ï¼Œnodeçš„è¯ä¹Ÿå¯ä»¥å¢åŠ ä»¥åŠ å…¥é›†ç¾¤ã€‚ hostname IP é…ç½® æ“ä½œç³»ç»Ÿ matser 192.168.8.171 4æ ¸8G CentOS Linux release 7.2.1511 (Core)ï¼ŒLinux version 3.10.0-327.el7.x86_64ï¼Œgcc version 4.8.3 20140911 (Red Hat 4.8.3-9) (GCC) node1 192.168.8.174 4æ ¸8G CentOS Linux release 7.2.1511 (Core) ï¼ŒLinux version 3.10.0-327.el7.x86_64ï¼Œgcc version 4.8.3 20140911 (Red Hat 4.8.3-9) (GCC) \b## å®‰è£… registryè¿™ä¸ªæ˜¯ docker å®˜æ–¹æä¾›çš„ä»“åº“é•œåƒï¼Œç°åœ¨å·²ç»è¿›å…¥äº†2.xçš„æ—¶ä»£ï¼Œå¯¹åº”çš„ä»“åº“åœ¨ github ä¸Šå¹¶ä¸æ˜¯docker-registryï¼Œdocker-registry å·²ç»å½’æ¡£äº†ï¼Œå¹¶ä¸”ä¸è¿›è¡Œç»´æŠ¤äº†ï¼Œæ‰€ä»¥ç›®å‰hub.docker ä¸Šçš„ registry å¯¹åº”åœ¨ github ä¸Šçš„ä»“åº“åå­—å«åš docker/distribution å®‰è£… registry 1docker run -d -p 5000:5000 -v `pwd`/data:/tmp/registry-dev --restart=always --name registry registry:2 12CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES15d7f8c43400 registry:2 \"/entrypoint.sh /e...\" 12 minutes ago Up 50 seconds 0.0.0.0:5000-&gt;5000/tcp registry è¿™ä¸ªæ—¶å€™ç§æœ‰ä»“åº“é•œåƒæˆåŠŸå»ºç«‹äº†ï¼Œæˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ã€‚ æ‹‰å–é•œåƒ 1docker pull busybox:latest é‡æ–°æ‰“tag 1docker tag busybox:latest 192.168.8.171:5000/tonybai/busybox:latest æ¨é€åˆ°æŒ‡å®šä»“åº“ , ç»“æœå‘ç°æ¨é€ å¤±è´¥ 123[root@master registry]# docker push 192.168.8.171:5000/tonybai/busyboxThe push refers to a repository [192.168.8.171:5000/tonybai/busybox]Get https://192.168.8.171:5000/v1/_ping: http: server gave HTTP response to HTTPS client é‚£æ˜¯å› ä¸ºæˆ‘ä»¬çš„dockerï¼Œå¹¶æ²¡æœ‰è®¾ç½®ä¸å®‰å…¨ç§æœ‰ä»“åº“ç™½åå• æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ä¿®æ”¹/etc/docker/daemon.json 123456&#123; \"registry-mirrors\": [\"https://registry.docker-cn.com\"], \"insecure-registries\": [ \"192.168.8.171:5000\" ]&#125; ç„¶åæˆ‘ä»¬é‡å¯dockerå³å¯ï¼Œå®¹å™¨ä¼šéšä¹‹å¯åŠ¨ 1systemctl restart docker å¯åŠ¨æˆåŠŸåï¼Œç„¶åå†æ¨é€ä¸€æ¬¡. 12[root@master registry]# docker rmi 10.10.105.71:5000/tonybai/busyboxUntagged: 10.10.105.71:5000/tonybai/busybox:latest æˆåŠŸäº†ï¼Œä¸è¿‡ä»–å‘Šè¯‰æˆ‘æˆ‘æ²¡æœ‰æŒ‡å®štagsæ‰€ä»¥é»˜è®¤çš„ä»–åŠ ä¸Šäº†latestæ ‡ç­¾ã€‚ secure registry è‡ªç­¾åè¯ä¹¦ è¯ä¹¦æœåŠ¡æä¾›å•† è¿™é‡Œï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œæ‰€ä»¥éœ€è¦åœ¨æ¯ä¸ªæ‹‰å–æˆ‘ä»¬ç§æœ‰ä»“åº“çš„é•œåƒçš„æ—¶å€™ï¼Œéƒ½éœ€è¦æ‹¥æœ‰æˆ‘ä»¬è¯ä¹¦æ‰å¯ä»¥æ‹‰å– 1234567891011121314151617181920[root@master ~]# mkdir ~&#x2F;openssl&#x2F;certs&#x2F; &amp;&amp; cd ~&#x2F;openssl&#x2F;certs&#x2F; &amp;&amp; openssl req -newkey rsa:2048 -nodes -sha256 -keyout certs&#x2F;domain.key -x509 -days 365 -out certs&#x2F;domain.crtGenerating a 2048 bit RSA private key.....+++...................................................................................................................................................+++writing new private key to &#39;certs&#x2F;domain.key&#39;-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &#39;.&#39;, the field will be left blank.-----Country Name (2 letter code) [XX]:CNState or Province Name (full name) []:GuangdongLocality Name (eg, city) [Default City]:GuangzhouOrganization Name (eg, company) [Default Company Ltd]:xxxOrganizational Unit Name (eg, section) []:xxCommon Name (eg, your name or your server&#39;s hostname) []:mcdockerhub.comEmail Address []:471113744@qq.com ç”±äºæˆ‘ä»¬çš„ Common Name è®¾ç½®äº† mcdockerhub.comï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹hostsï¼ˆé™¤éä½ æœ‰å…¬ç½‘è§£æåˆ°è¿™ä¸ªIPï¼‰ 123vim /etc/hosts/192.168.8.171 master mcdockerhub.com ç§»é™¤ä¹‹å‰æˆ‘ä»¬åˆ›å»ºçš„ registyï¼Œç„¶åæˆ‘ä»¬é‡æ–°åˆ›å»ºä¸€ä¸ª 1docker stop registy &amp;&amp; docker rm registy 1docker run -d -p 5000:5000 --restart=always --name registry -v /root/openssl/data:/tmp/registry-dev -v /root/openssl/certs:/certs -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key docker.io/registry:2 æ¥ç€æˆ‘ä»¬é‡æ–°æ‰“ä¸€ä¸ªå¯¹åº”registyçš„tag 1docker tag docker.io/busybox mcdockerhub.com:5000/tonybai/busybox æ¨é€é•œåƒåˆ°åŸŸåä»“åº“ 123[root@master ~]# docker push mcdockerhub.com:5000/tonybai/busyboxThe push refers to a repository [mcdockerhub.com:5000/tonybai/busybox]Get https://mcdockerhub.com:5000/v1/_ping: x509: certificate signed by unknown authority æˆ‘ä»¬å‘ç°æŠ¥é”™äº†ã€‚è¿™æ˜¯å› ä¸º æ²¡æœ‰æŠŠè¯ä¹¦ å¯¹åº”èµ·æ¥ã€‚ æŠŠè¯ä¹¦æ”¾åœ¨dockerè¯·æ±‚çš„è¯ä¹¦ç›®å½• 1mkdir -p &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;mcdockerhub.com:5000 &amp;&amp; cp ~&#x2F;openssl&#x2F;certs&#x2F;domain.crt &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;mcdockerhub.com:5000&#x2F;ca.crt å†æ¨é€ä¸€æ¬¡ 1234[root@master ~]# docker push mcdockerhub.com:5000/tonybai/busyboxThe push refers to a repository [mcdockerhub.com:5000/tonybai/busybox]d1156b98822d: Pushedlatest: digest: sha256:4fe8827f51a5e11bb83afa8227cbccb402df840d32c6b633b7ad079bc8144100 size: 527 æ¥ç€å°±æ˜¯æˆåŠŸäº†ã€‚å¦‚æœå…¶ä»–æœºå™¨éœ€è¦æ¨é€æˆ–è€…æ‹‰å–çš„è¯ï¼Œè®°å¾—è¦æŠŠè¯ä¹¦æ”¾åœ¨å¯¹åº”çš„æœºå™¨çš„å¯¹åº”ç›®å½•ä¸‹ï¼Œå¦åˆ™è¢«è§†ä¸ºæ²¡æœ‰è¢«æˆæƒã€‚","categories":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/categories/Docker/"}],"tags":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/tags/Docker/"}]},{"title":"ã€kubernetesã€‘æµ‹è¯•é›†ç¾¤éƒ¨ç½²","slug":"k8s/k8sæµ‹è¯•é›†ç¾¤éƒ¨ç½²","date":"2019-05-28T03:28:30.000Z","updated":"2021-03-20T16:25:01.807Z","comments":true,"path":"2019/05/28/k8s/k8sæµ‹è¯•é›†ç¾¤éƒ¨ç½²/","link":"","permalink":"http://blog.crazylaw.cn/2019/05/28/k8s/k8s%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","excerpt":"å‰è¨€ä¸ºäº†åœ¨å…¬å¸æ¨å¹¿ docker å’Œ k8sï¼Œæ–¹ä¾¿æˆ‘ä»¬å¼€å‘äººå‘˜å»æ›´å¥½çš„ç»´æŠ¤è‡ªå·±çš„å¯¹åº”çš„ç”Ÿäº§ç¯å¢ƒç›®å‰ç”¨ k8s æ„å»ºæˆ‘ä»¬è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒï¼Œç”¨äºæ¥å£æµ‹è¯•å’ŒåŠŸèƒ½æµ‹è¯•ä¸“ç”¨ã€‚æœ¬æ–‡è®°å½•ä¸€ä¸‹é›†ç¾¤éƒ¨ç½²çš„æƒ…å†µ","text":"å‰è¨€ä¸ºäº†åœ¨å…¬å¸æ¨å¹¿ docker å’Œ k8sï¼Œæ–¹ä¾¿æˆ‘ä»¬å¼€å‘äººå‘˜å»æ›´å¥½çš„ç»´æŠ¤è‡ªå·±çš„å¯¹åº”çš„ç”Ÿäº§ç¯å¢ƒç›®å‰ç”¨ k8s æ„å»ºæˆ‘ä»¬è‡ªå·±çš„æµ‹è¯•ç¯å¢ƒï¼Œç”¨äºæ¥å£æµ‹è¯•å’ŒåŠŸèƒ½æµ‹è¯•ä¸“ç”¨ã€‚æœ¬æ–‡è®°å½•ä¸€ä¸‹é›†ç¾¤éƒ¨ç½²çš„æƒ…å†µ æœºå™¨å‡†å¤‡æœ€å°åŒ–åˆ†å¸ƒå¼é›†ç¾¤å®‰è£…ï¼Œä¸€å°masterï¼Œä¸€å°nodeã€‚åç»­å¯ä»¥è°ƒæ•´ä¸ºå¤šmasterï¼Œè§£å†³å•ç‚¹é—®é¢˜ï¼Œnodeçš„è¯ä¹Ÿå¯ä»¥å¢åŠ ä»¥åŠ å…¥é›†ç¾¤ã€‚ hostname IP é…ç½® æ“ä½œç³»ç»Ÿ matser 192.168.8.171 4æ ¸8G CentOS Linux release 7.2.1511 (Core)ï¼ŒLinux version 3.10.0-327.el7.x86_64ï¼Œgcc version 4.8.3 20140911 (Red Hat 4.8.3-9) (GCC) node1 192.168.8.174 4æ ¸8G CentOS Linux release 7.2.1511 (Core) ï¼ŒLinux version 3.10.0-327.el7.x86_64ï¼Œgcc version 4.8.3 20140911 (Red Hat 4.8.3-9) (GCC) å®‰è£…k8sé›†ç¾¤\b### æ£€æŸ¥å„æœºå™¨é˜²ç«å¢™çŠ¶æ€ 1systemctl list-unit-files | grep firewalld.service å¦‚æœé˜²ç«å¢™çš„çŠ¶æ€æ˜¯ enabled çš„è¯ï¼Œæš‚æ—¶å…ˆå…³é—­é˜²ç«å¢™ï¼Œä¸ºäº†ä¸å½±å“æˆ‘ä»¬çš„æµ‹è¯•éƒ¨ç½² å…³é—­é˜²ç«å¢™ &amp;&amp; ç¦æ­¢éšå¼€æœºå¯åŠ¨ 1systemctl stop firewalld.service &amp;&amp; systemctl disable firewalld.service å…³é—­å„æœºå™¨ä¸Šçš„SELINUX1setenforce 0 &amp;&amp; sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config åŒæ­¥å„æœºå™¨æ—¶é—´å·®1yum install -y ntpdate &amp;&amp; ntpdate -u ntp.api.bz ä¿®æ”¹å„ä¸ªæœºå™¨çš„hostnameå’Œhostsæ–‡ä»¶ä¿®æ”¹ etc/hosts 1master_ip=192.168.8.171;node1_ip=192.168.8.174;echo -e \"\\n$&#123;master_ip&#125; master\\n$&#123;node1_ip&#125; node1\" &gt;&gt; /etc/hosts ä¿®æ”¹ master çš„ hostname 1hostnamectl set-hostname master ä¿®æ”¹ node1 çš„ hostname 1hostnamectl set-hostname node1 é…ç½®ç›¸å…³çš„yumä»“åº“é…ç½®é˜¿é‡Œäº‘docker-ceä»“åº“1wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo é…ç½®é˜¿é‡Œäº‘k8sä»“åº“12345678cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF[kubernetes]name=Kubernetes Repobaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgenable=1EOF å®‰è£…docker kubelet kubeadm kubectlå½“å‰æœ€æ–°ç‰ˆï¼š1.14.2 ä¸ºäº†ç¨³å®šæ€§è€ƒè™‘ï¼Œç›®å‰æš‚æ—¶è€ƒè™‘æœ€æ–°ç‰ˆçš„å‰ä¸€ä¸ªç‰ˆæœ¬1.14.1 kubeadm kubectl kubelet kubeadm-1.14.1-0.x86_64 kubectl-1.14.1-0.x86_64 kubelet-1.14.1-0.x86_64 ç”±äºåˆ©ç”¨kubeadméƒ¨ç½²é›†ç¾¤ï¼ŒæŸ¥çœ‹kubeadmæ‰€æœ‰ç‰ˆæœ¬ï¼Œå› ä¸ºkuadmå’Œkubectlå’Œkubeletéƒ½è¦å¯¹åº”å¥½ç‰ˆæœ¬ï¼Œæ‰€ä»¥å¦‚æœç‰ˆæœ¬ä¸å¯¹åº”çš„è¯ï¼Œå¯èƒ½éœ€è¦é™çº§æˆ–è€…å‡çº§æ“ä½œ 1yum list --showduplicates | grep kubeadm 12345yum install -y docker kubelet-1.14.1-0 kubeadm-1.14.1-0 kubectl-1.14.1-0``` ```shellrpm -qa | grep kubeadm &amp;&amp; rpm -qa | grep kubelet &amp;&amp; rpm -qa | grep kubectl ä¿®æ”¹ç³»ç»Ÿå†…æ ¸å‚æ•°ç”±äºdockeréšåä¼šå¤§é‡çš„æ“ä½œiptablesï¼Œæ‰€æœ‰nf-callçš„å€¼è¦è®¾ç½®ä¸º1ï¼Œå°½é‡ä¸ä½¿ç”¨swap 12345cat &gt; /etc/sysctl.d/k8s-sysctl.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-iptables = 1net.bridge.bridge-nf-call-ip6tables = 1vm.swappiness = 0EOF åˆ·æ–°å†…æ ¸é…ç½®å‚æ•° 1sysctl --system æŸ¥çœ‹å‚æ•°ä¿¡æ¯ 1cat /proc/sys/net/bridge/bridge-nf-call-iptables è®¾ç½®éšå¼€æœºå¯åŠ¨1systemctl enable docker &amp;&amp; systemctl enable kubelet è®¾ç½®kubeletå¿½ç•¥swap1echo 'KUBELET_EXTRA_ARGS=\"--fail-swap-on=false\"' &gt; /etc/sysconfig/kubelet å…³é—­swap1swapoff -a å¯åŠ¨docker1234567systemctl start docker``` ç¡®ä¿dockerå·²å¯åŠ¨```shellsystemctl status docker ä¸‹è½½k8sæ ¸å¿ƒç»„ä»¶é•œåƒç”±äºk8sçš„é•œåƒåœ¨è°·æ­Œäº‘ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å›½å†…çš„é•œåƒæºä¸­è·å–é•œåƒï¼Œä¸‹é¢æ˜¯ä¸ºä»å›½å†…é•œåƒæºä¸­æ‰¾åˆ°çš„é•œåƒæºï¼Œåç»­ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ç§æœ‰ä»“åº“ï¼Œä¿å­˜è¿™é‡Œé•œåƒ 1234567891011121314151617181920212223242526272829303132333435cat &gt; deploy.sh &lt;&lt;EOF#/usr/bin/env bash## k8s-coreimages=( kube-proxy:v1.14.1 kube-apiserver:v1.14.1 kube-controller-manager:v1.14.1 kube-scheduler:v1.14.1 etcd:3.3.10 pause:3.1)for imageName in \\$&#123;images[@]&#125;; do docker pull mirrorgooglecontainers/\\$&#123;imageName&#125; docker tag mirrorgooglecontainers/\\$&#123;imageName&#125; k8s.gcr.io/\\$&#123;imageName&#125; docker rmi mirrorgooglecontainers/\\$&#123;imageName&#125;done## k8s-network-managerimages=( coredns:1.3.1)for imageName in \\$&#123;images[@]&#125;; do docker pull coredns/\\$&#123;imageName&#125; docker tag coredns/\\$&#123;imageName&#125; k8s.gcr.io/\\$&#123;imageName&#125; docker rmi coredns/\\$&#123;imageName&#125;done ## k8s-web-ui## docker pull gcrxio/kubernetes-dashboard-amd64:v1.10.1 &amp;&amp; docker tag gcrxio/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1 &amp;&amp; docker rmi gcrxio/kubernetes-dashboard-amd64:v1.10.1## nginx-ingress-controller## docker pull bitnami/nginx-ingress-controller:0.24.1 &amp;&amp; docker tag bitnami/nginx-ingress-controller:0.24.1 quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.24.1 &amp;&amp; docker rmi bitnami/nginx-ingress-controller:0.24.1EOF 1chmod +x deploy.sh æ‰§è¡Œ deploy.sh è„šæœ¬ ç­‰å¾…ä¸‹è½½å®‰è£…ï¼Œå®Œæ¯•ä¹‹åï¼ŒæŸ¥çœ‹ä¸€ä¸‹é•œåƒæ˜¯å¦å·²ç»ä¸‹è½½å¥½äº† 123456789[root@master ~]# docker imagesREPOSITORY TAG IMAGE ID CREATED SIZEk8s.gcr.io/kube-proxy v1.14.1 20a2d7035165 7 weeks ago 82.1 MBk8s.gcr.io/kube-apiserver v1.14.1 cfaa4ad74c37 7 weeks ago 210 MBk8s.gcr.io/kube-scheduler v1.14.1 8931473d5bdb 7 weeks ago 81.6 MBk8s.gcr.io/kube-controller-manager v1.14.1 efb3887b411d 7 weeks ago 158 MBk8s.gcr.io/coredns 1.3.1 eb516548c180 4 months ago 40.3 MBk8s.gcr.io/etcd 3.3.10 2c4adeb21b4f 5 months ago 258 MBk8s.gcr.io/pause 3.1 da86e6ba6ca1 17 months ago 742 kB ä¸‹è½½å¥½äº†ä¹‹åï¼Œæˆ‘ä»¬å°±å¼€å§‹éƒ¨ç½²æˆ‘ä»¬çš„k8sé›†ç¾¤ åˆå§‹åŒ–k8s-matseråœ¨ master èŠ‚ç‚¹åˆå§‹åŒ–æ“ä½œ 1kubeadm init --kubernetes-version=v1.14.1 --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=Swap è¿‡ç¨‹å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465[init] Using Kubernetes version: v1.14.1[preflight] Running pre-flight checks[preflight] Pulling images required for setting up a Kubernetes cluster[preflight] This might take a minute or two, depending on the speed of your internet connection[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"[kubelet-start] Activating the kubelet service[certs] Using certificateDir folder \"/etc/kubernetes/pki\"[certs] Generating \"ca\" certificate and key[certs] Generating \"apiserver\" certificate and key[certs] apiserver serving cert is signed for DNS names [master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.8.171][certs] Generating \"apiserver-kubelet-client\" certificate and key[certs] Generating \"front-proxy-ca\" certificate and key[certs] Generating \"front-proxy-client\" certificate and key[certs] Generating \"etcd/ca\" certificate and key[certs] Generating \"etcd/server\" certificate and key[certs] etcd/server serving cert is signed for DNS names [master localhost] and IPs [192.168.8.171 127.0.0.1 ::1][certs] Generating \"etcd/healthcheck-client\" certificate and key[certs] Generating \"etcd/peer\" certificate and key[certs] etcd/peer serving cert is signed for DNS names [master localhost] and IPs [192.168.8.171 127.0.0.1 ::1][certs] Generating \"apiserver-etcd-client\" certificate and key[certs] Generating \"sa\" key and public key[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"[kubeconfig] Writing \"admin.conf\" kubeconfig file[kubeconfig] Writing \"kubelet.conf\" kubeconfig file[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file[kubeconfig] Writing \"scheduler.conf\" kubeconfig file[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"[control-plane] Creating static Pod manifest for \"kube-apiserver\"[control-plane] Creating static Pod manifest for \"kube-controller-manager\"[control-plane] Creating static Pod manifest for \"kube-scheduler\"[etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\"[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\". This can take up to 4m0s[apiclient] All control plane components are healthy after 25.053527 seconds[upload-config] storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace[kubelet] Creating a ConfigMap \"kubelet-config-1.14\" in namespace kube-system with the configuration for the kubelets in the cluster[upload-certs] Skipping phase. Please see --experimental-upload-certs[mark-control-plane] Marking the node master as control-plane by adding the label \"node-role.kubernetes.io/master=''\"[mark-control-plane] Marking the node master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule][bootstrap-token] Using token: f1agmt.o01kvgt0slzlj7y6[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster[bootstrap-token] creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace[addons] Applied essential addon: CoreDNS[addons] Applied essential addon: kube-proxyYour Kubernetes control-plane has initialized successfully!To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/configYou should now deploy a pod network to the cluster.Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/Then you can join any number of worker nodes by running the following on each as root:kubeadm join 192.168.8.171:6443 --token f1agmt.o01kvgt0slzlj7y6 \\ --discovery-token-ca-cert-hash sha256:a6bc1cbed5084d136237f7bfb469f82c3dfbfbdef0f967602d015b5fb5a6447d éœ€è¦ç”¨åˆ°kubectlçš„ç”¨æˆ·éƒ½éœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ 1mkdir -p $HOME/.kube &amp;&amp; sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config &amp;&amp; sudo chown $(id -u):$(id -g) $HOME/.kube/config å®‰è£…ç½‘ç»œç»„ä»¶-flannelè¿™ä¸ªæ—¶å€™å¯ä»¥çœ‹ä¸€ä¸‹masterèŠ‚ç‚¹çš„çŠ¶æ€ 123[root@master ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONmaster NotReady master 15h v1.14.1 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667[root@master ~]# kubectl describe nodes masterName: masterRoles: masterLabels: beta.kubernetes.io/arch=amd64 beta.kubernetes.io/os=linux kubernetes.io/arch=amd64 kubernetes.io/hostname=master kubernetes.io/os=linux node-role.kubernetes.io/master=Annotations: kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock node.alpha.kubernetes.io/ttl: 0 volumes.kubernetes.io/controller-managed-attach-detach: trueCreationTimestamp: Tue, 28 May 2019 18:14:37 +0800Taints: node.kubernetes.io/not-ready:NoExecute node-role.kubernetes.io/master:NoSchedule node.kubernetes.io/not-ready:NoScheduleUnschedulable: falseConditions: Type Status LastHeartbeatTime LastTransitionTime Reason Message ---- ------ ----------------- ------------------ ------ ------- MemoryPressure False Wed, 29 May 2019 09:15:07 +0800 Tue, 28 May 2019 18:14:28 +0800 KubeletHasSufficientMemory kubelet has sufficient memory available DiskPressure False Wed, 29 May 2019 09:15:07 +0800 Tue, 28 May 2019 18:14:28 +0800 KubeletHasNoDiskPressure kubelet has no disk pressure PIDPressure False Wed, 29 May 2019 09:15:07 +0800 Tue, 28 May 2019 18:14:28 +0800 KubeletHasSufficientPID kubelet has sufficient PID available Ready False Wed, 29 May 2019 09:15:07 +0800 Tue, 28 May 2019 18:14:28 +0800 KubeletNotReady runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitializedAddresses: InternalIP: 192.168.8.171 Hostname: masterCapacity: cpu: 4 ephemeral-storage: 51175Mi hugepages-2Mi: 0 memory: 8009192Ki pods: 110Allocatable: cpu: 4 ephemeral-storage: 48294789041 hugepages-2Mi: 0 memory: 7906792Ki pods: 110System Info: Machine ID: fae837ec0d8a402ab8085d2e0ae4624f System UUID: 421D57E8-3C84-52D4-17F1-7D87F3BF8FF8 Boot ID: b6c7d535-ad5f-41b1-9636-4e46e96adaf0 Kernel Version: 3.10.0-957.el7.x86_64 OS Image: CentOS Linux 7 (Core) Operating System: linux Architecture: amd64 Container Runtime Version: docker://1.13.1 Kubelet Version: v1.14.1 Kube-Proxy Version: v1.14.1PodCIDR: 10.244.0.0/24Non-terminated Pods: (5 in total) Namespace Name CPU Requests CPU Limits Memory Requests Memory Limits AGE --------- ---- ------------ ---------- --------------- ------------- --- kube-system etcd-master 0 (0%) 0 (0%) 0 (0%) 0 (0%) 14h kube-system kube-apiserver-master 250m (6%) 0 (0%) 0 (0%) 0 (0%) 14h kube-system kube-controller-manager-master 200m (5%) 0 (0%) 0 (0%) 0 (0%) 14h kube-system kube-proxy-nz9h6 0 (0%) 0 (0%) 0 (0%) 0 (0%) 15h kube-system kube-scheduler-master 100m (2%) 0 (0%) 0 (0%) 0 (0%) 14hAllocated resources: (Total limits may be over 100 percent, i.e., overcommitted.) Resource Requests Limits -------- -------- ------ cpu 550m (13%) 0 (0%) memory 0 (0%) 0 (0%) ephemeral-storage 0 (0%) 0 (0%)Events: &lt;none&gt; æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œå‘Šè¯‰æˆ‘ä»¬ç½‘ç»œæ’ä»¶å¹¶æ²¡æœ‰å‡†å¤‡å¥½ã€‚æ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å®‰è£…ç½‘ç»œæ’ä»¶ 1kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml è¿‡ä¸€ä¼šå„¿æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹èŠ‚ç‚¹çš„ä¿¡æ¯ 123[root@master ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONmaster Ready master 16h v1.14.1 å‘ç°æˆ‘ä»¬çš„ masterèŠ‚ç‚¹å·²ç»æ˜¯ Ready çŠ¶æ€äº†ã€‚ åŠ å…¥nodeå·¥ä½œèŠ‚ç‚¹è¿˜è®°å¾—æˆ‘ä»¬å†åˆå§‹åŒ–masterçš„æ—¶å€™æœ‰ï¼Œæœ‰å¦‚ä¸‹æç¤ºï¼š 1234Then you can join any number of worker nodes by running the following on each as root:kubeadm join 192.168.8.171:6443 --token f1agmt.o01kvgt0slzlj7y6 \\ --discovery-token-ca-cert-hash sha256:a6bc1cbed5084d136237f7bfb469f82c3dfbfbdef0f967602d015b5fb5a6447d è¿™ä¸ªéœ€è¦æˆ‘ä»¬åœ¨node èŠ‚ç‚¹æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¸€å®šè¦ä¿å­˜å¥½ï¼Œä»¥åæ‰©å±•nodeèŠ‚ç‚¹çš„æ—¶å€™ï¼Œéƒ½è¦ç”¨è¿™ä¸ª token å’Œ discovery-token-ca-cert-hash åœ¨node1çš„æœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ 12kubeadm join 192.168.8.171:6443 --token f1agmt.o01kvgt0slzlj7y6 \\ --discovery-token-ca-cert-hash sha256:a6bc1cbed5084d136237f7bfb469f82c3dfbfbdef0f967602d015b5fb5a6447d è¿‡ç¨‹å¦‚ä¸‹ 1234567891011121314[preflight] Running pre-flight checks[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'[kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-1.14\" ConfigMap in the kube-system namespace[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"[kubelet-start] Activating the kubelet service[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run 'kubectl get nodes' on the control-plane to see this node join the cluster. åœ¨ master çš„æœºå™¨ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ 1234[root@master ~]# kubectl get nodesNAME STATUS ROLES AGE VERSIONmaster Ready master 16h v1.14.1node1 Ready &lt;none&gt; 2m39s v1.14.1 å‘ç°node1èŠ‚ç‚¹å·²ç»åŠ å…¥è¿›æ¥äº†ï¼Œå¹¶ä¸”çŠ¶æ€å·²ç»æ˜¯ Ready 123456789101112[root@master ~]# kubectl get pods -n kube-system -o wideNAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATEScoredns-fb8b8dccf-cr7t4 1/1 Running 0 16h 10.244.0.2 master &lt;none&gt; &lt;none&gt;coredns-fb8b8dccf-hn5kh 1/1 Running 0 16h 10.244.0.3 master &lt;none&gt; &lt;none&gt;etcd-master 1/1 Running 0 16h 192.168.8.171 master &lt;none&gt; &lt;none&gt;kube-apiserver-master 1/1 Running 0 16h 192.168.8.171 master &lt;none&gt; &lt;none&gt;kube-controller-manager-master 1/1 Running 0 16h 192.168.8.171 master &lt;none&gt; &lt;none&gt;kube-flannel-ds-amd64-27cts 1/1 Running 0 3m29s 192.168.8.174 node1 &lt;none&gt; &lt;none&gt;kube-flannel-ds-amd64-wk4c9 1/1 Running 0 91m 192.168.8.171 master &lt;none&gt; &lt;none&gt;kube-proxy-mfjlr 1/1 Running 0 3m29s 192.168.8.174 node1 &lt;none&gt; &lt;none&gt;kube-proxy-nz9h6 1/1 Running 0 16h 192.168.8.171 master &lt;none&gt; &lt;none&gt;kube-scheduler-master 1/1 Running 0 16h 192.168.8.171 master &lt;none&gt; &lt;none&gt; è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„k8sç»„ä»¶podséƒ½å·²ç»å‡†å¤‡å°±ç»ªï¼Œåˆ°æ­¤ä½ç½®ï¼Œä¸€ä¸ªmasterä¸€ä¸ªnodeçš„k8så·²ç»éƒ¨ç½²å®Œæ¯•ã€‚ é‡åˆ°çš„å‘SELinux is not supported with the overlay2 graph driver on this kernelæ„æ€æ˜¯ï¼š æ­¤linuxçš„å†…æ ¸ä¸­çš„SELinuxä¸æ”¯æŒ overlay2 graph driver ï¼Œè§£å†³æ–¹æ³•æœ‰ä¸¤ä¸ªï¼Œè¦ä¹ˆå¯åŠ¨ä¸€ä¸ªæ–°å†…æ ¸ï¼Œè¦ä¹ˆå°±åœ¨dockeré‡Œç¦ç”¨selinuxï¼Œâ€“selinux-enabled=false æ‰“å¼€dockeré…ç½®æ–‡ä»¶ vim /etc/sysconfig/docker 1234OPTIONS='--selinux-enabled --log-driver=journald --signature-verification=false'if [ -z \"$&#123;DOCKER_CERT_PATH&#125;\" ]; then DOCKER_CERT_PATH=/etc/dockerfi æ”¹ä¸ºå¦‚ä¸‹: 1234OPTIONS='--selinux-enabled=false --log-driver=journald --signature-verification=false'if [ -z \"$&#123;DOCKER_CERT_PATH&#125;\" ]; then DOCKER_CERT_PATH=/etc/dockerfi \u001eæ”¹å®Œä¹‹åå†å¯åŠ¨dockerå³å¯ã€‚ [kubelet-check] connection refused[kubelet-check] The HTTP call equal to â€˜curl -sSL http://localhost:10255/healthz&#39; failed with error: Get http://localhost:10255/healthz: dial tcp [::1]:10255: connection refused åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œmasteråˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°æ€»æ˜¯åœ¨æ ¡éªŒkubeletæœåŠ¡çš„æ—¶å€™å¤±è´¥ï¼Œä¼šæŠ¥å¦‚ä¸Šå†…å®¹ã€‚ æŸ¥çœ‹kubeletæœåŠ¡æ˜¯å¦å¯åŠ¨äº† 1systemctl status kubelet å‘ç°æœåŠ¡æ˜¯æ²¡æœ‰å¯åŠ¨çš„ã€‚ ç”±äºæ²¡æœ‰è¯¦ç»†çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1journalctl -xeu kubelet å¾—åˆ°å¦‚ä¸‹ç»“æœï¼š 1Failed to find subsystem mount for required subsystem: pid æˆ‘ä»¬çš„ cgroup ä¸æ”¯æŒ pidsï¼Œæ‰€ä»¥è¿è¡Œä¸èµ·æ¥ã€‚ æŸ¥çœ‹å½“å‰ç³»ç»Ÿæ”¯æŒå“ªäº›subsystem 123456789101112cat /proc/cgroups#subsys_name hierarchy num_cgroups enabledcpuset 5 11 1cpu 4 104 1cpuacct 4 104 1memory 6 104 1devices 3 104 1freezer 2 11 1net_cls 8 11 1blkio 9 104 1perf_event 10 11 1hugetlb 7 11 1 å‘ç°ç¡®å®æ²¡æœ‰pidsã€‚æŸ¥çœ‹å½“å‰ç³»ç»Ÿå†…æ ¸ã€‚ 12uname -r3.10.0-327.el7.x86_64 è¿™ä¸ªå†…æ ¸æ­£æ˜¯å¼€å¤´æ‰€è¯´çš„å†…æ ¸ç‰ˆæœ¬ã€‚é‚£æˆ‘ä»¬åªèƒ½å‡çº§å†…æ ¸ç‰ˆæœ¬äº†ã€‚çœ‹ä¸€ä¸‹æœ‰ä»€ä¹ˆå†…æ ¸ç‰ˆæœ¬å¯ä»¥å‡çº§ã€‚ 123456789101112131415yum list kernel.x86_64 --showduplicates | sort -r* updates: ap.stykers.moeLoading mirror speeds from cached hostfileLoaded plugins: fastestmirror, langpackskernel.x86_64 3.10.0-957.el7 base kernel.x86_64 3.10.0-957.5.1.el7 updates kernel.x86_64 3.10.0-957.1.3.el7 updates kernel.x86_64 3.10.0-957.10.1.el7 updates kernel.x86_64 3.10.0-327.el7 @anacondaInstalled Packages * extras: mirrors.huaweicloud.com * epel: mirrors.aliyun.com * elrepo: mirrors.tuna.tsinghua.edu.cn * base: ap.stykers.moeAvailable Packages 1yum install kernel-3.10.0-957.el7.x86_64 -y CentOS 7ä½¿ç”¨grub2ä½œä¸ºå¼•å¯¼ç¨‹åºï¼ŒæŸ¥çœ‹æœ‰å“ªäº›å†…æ ¸é€‰é¡¹ 12345678cat /boot/grub2/grub.cfg |grep menuentry ##æŸ¥çœ‹æœ‰å“ªäº›å†…æ ¸é€‰é¡¹if [ x\"$&#123;feature_menuentry_id&#125;\" = xy ]; then menuentry_id_option=\"--id\" menuentry_id_option=\"\"export menuentry_id_optionmenuentry 'CentOS Linux (3.10.0-957.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-327.el7.x86_64-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8' &#123;menuentry 'CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-3.10.0-327.el7.x86_64-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8' &#123;menuentry 'CentOS Linux (0-rescue-d918a8d2df0e481a820b4e5554fed3b5) 7 (Core)' --class centos --class gnu-linux --class gnu --class os --unrestricted $menuentry_id_option 'gnulinux-0-rescue-d918a8d2df0e481a820b4e5554fed3b5-advanced-7787952f-c2d4-4216-ae09-5188e7fd88b8' &#123; æŸ¥çœ‹é»˜è®¤å¯åŠ¨å†…æ ¸ 1grub2-editenv list é‡å¯ç³»ç»Ÿï¼Œæ›´æ¢å†…æ ¸ç‰ˆæœ¬ 1reboot é‡å¯ååœ¨æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬æ¢äº†æ²¡ï¼Œsubsystemä¸­æ˜¯å¦æœ‰pids 1uname -r 1234567891011121314cat /proc/cgroups#subsys_name hierarchy num_cgroups enabledcpuset 5 11 1cpu 4 110 1cpuacct 4 110 1memory 3 110 1devices 6 110 1freezer 7 11 1net_cls 2 11 1blkio 10 110 1perf_event 8 11 1hugetlb 9 11 1pids 11 110 1net_prio 2 11 1 okï¼Œè¿™ä¸ªæ—¶å€™æ”¯æŒäº†pidsï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªé—®é¢˜å°±è§£å†³äº†ã€‚ æ¯æ¬¡é‡å¯éƒ½éœ€è¦å…³é—­swap1swapoff -a","categories":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"},{"name":"Docker","slug":"kubernetes/Docker","permalink":"http://blog.crazylaw.cn/categories/kubernetes/Docker/"}],"tags":[{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"}]},{"title":"PHP-CS-Fixer é…ç½®è¯¦ç»†å¯¹æ¯”","slug":"php-cs-fixeré…ç½®é¡¹è¯¦ç»†å¯¹æ¯”è¯´æ˜","date":"2019-05-21T01:50:00.000Z","updated":"2021-03-20T16:25:01.812Z","comments":true,"path":"2019/05/21/php-cs-fixeré…ç½®é¡¹è¯¦ç»†å¯¹æ¯”è¯´æ˜/","link":"","permalink":"http://blog.crazylaw.cn/2019/05/21/php-cs-fixer%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%AF%A6%E7%BB%86%E5%AF%B9%E6%AF%94%E8%AF%B4%E6%98%8E/","excerpt":"å‰è¨€ç”±äºæˆ‘ä»¬é¡¹ç›®æ¯”è¾ƒå¤šï¼Œè€Œä¸”æ¯ä¸ªäººçš„ç¼–å†™ä»£ç çš„é£æ ¼ä¹Ÿä¸å¤ªä¸€è‡´ï¼Œæˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½åœ¨æ ¼å¼ä¸Šå¾—åˆ°ç»Ÿä¸€ï¼Œè¿™æ ·å­çš„å¥½å¤„æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š éµå¾ª PSR2 codereview çš„æ—¶å€™å¯ä»¥å…é™¤æ ¼å¼å·®å¼‚æ‰€å¸¦æ¥çš„å¹²æ‰° ç»Ÿä¸€æ ¼å¼æœ‰åˆ©äºå¤§å®¶åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå†™å‡ºæ›´ä¸ºä¼˜é›…çš„ä»£ç æ ¼å¼ å› æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ç”¨äºçš„ç»Ÿä¸€æ ¼å¼åŒ–é…å¥—çš„å·¥å…·é“¾ï¼š husky-phpï¼šç”¨äºå®ç°å®¢æˆ·ç«¯ githook é’©å­ï¼Œç”¨äºæ‰§è¡Œè§¦å‘æˆ‘ä»¬çš„ husky é¡¹ç›®ï¼ˆé»˜è®¤æ”¯æŒè‡ªåŠ¨æ ¼å¼åŒ–ï¼Œå†²çªæ ¡éªŒï¼‰ composer-husky-pluginï¼šä¸“é—¨ç”± husky-php å®šåˆ¶çš„ composer æ’ä»¶ï¼Œç”¨äºè‡ªåŠ¨éƒ¨ç½²husky-php php-cs-fixer-configï¼šä¸“é—¨å®šä¹‰ php-cs-fixer æ ¼å¼é…ç½®çš„ç»„ä»¶","text":"å‰è¨€ç”±äºæˆ‘ä»¬é¡¹ç›®æ¯”è¾ƒå¤šï¼Œè€Œä¸”æ¯ä¸ªäººçš„ç¼–å†™ä»£ç çš„é£æ ¼ä¹Ÿä¸å¤ªä¸€è‡´ï¼Œæˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½åœ¨æ ¼å¼ä¸Šå¾—åˆ°ç»Ÿä¸€ï¼Œè¿™æ ·å­çš„å¥½å¤„æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š éµå¾ª PSR2 codereview çš„æ—¶å€™å¯ä»¥å…é™¤æ ¼å¼å·®å¼‚æ‰€å¸¦æ¥çš„å¹²æ‰° ç»Ÿä¸€æ ¼å¼æœ‰åˆ©äºå¤§å®¶åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå†™å‡ºæ›´ä¸ºä¼˜é›…çš„ä»£ç æ ¼å¼ å› æ­¤ï¼Œæˆ‘ä»¬å®ç°äº†ç”¨äºçš„ç»Ÿä¸€æ ¼å¼åŒ–é…å¥—çš„å·¥å…·é“¾ï¼š husky-phpï¼šç”¨äºå®ç°å®¢æˆ·ç«¯ githook é’©å­ï¼Œç”¨äºæ‰§è¡Œè§¦å‘æˆ‘ä»¬çš„ husky é¡¹ç›®ï¼ˆé»˜è®¤æ”¯æŒè‡ªåŠ¨æ ¼å¼åŒ–ï¼Œå†²çªæ ¡éªŒï¼‰ composer-husky-pluginï¼šä¸“é—¨ç”± husky-php å®šåˆ¶çš„ composer æ’ä»¶ï¼Œç”¨äºè‡ªåŠ¨éƒ¨ç½²husky-php php-cs-fixer-configï¼šä¸“é—¨å®šä¹‰ php-cs-fixer æ ¼å¼é…ç½®çš„ç»„ä»¶ PHP_CS_Fixerè¿™æ˜¯ä¸€ä¸ªä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œå¹¶ä¸”æ”¯æŒå¾ˆå¤šé«˜çº§æ ¼å¼å†…å®¹ã€‚ PHP_CS_FIXER é…ç½®é¡¹@PSR2éµå¾ª PSR2 çš„æ ‡å‡† 123$rules = [ '@PSR2' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1234function A($args1,$args2=0)&#123; $a=2; var_dump($args1,$args2);&#125; æ ¼å¼åŒ–åï¼š 12345function A($args1, $args2=0)&#123; $a=2; var_dump($args1, $args2);&#125; align_multiline_comment [@PhpCsFixer]æ¯è¡Œå¤šè¡Œ DocComments å¿…é¡»æœ‰ä¸€ä¸ªæ˜Ÿå·ï¼ˆPSR-5ï¼‰ï¼Œå¹¶ä¸”å¿…é¡»ä¸ç¬¬ä¸€è¡Œå¯¹é½ã€‚ å¯é€‰é…ç½®é¡¹ comment_type phpdocs_only ï¼ˆé»˜è®¤ï¼‰ phpdocs_like all_multiline æš‚æ—¶æœªçŸ¥ä¸‰ä¸ªé€‰é¡¹çš„å…·ä½“åŒºåˆ«ï¼Œç›®å‰æ¥çœ‹æ•ˆæœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œä¾‹å­å¦‚ä¸‹ 12345$rules = [ 'align_multiline_comment' =&gt; [ 'comment_type' =&gt; 'phpdocs_only' ]]; åŸå§‹æ ¼å¼ï¼š 12345678/** * @param $args1@param int $args2 */function A($args1, $args2=0)&#123; $a=2;&#125; æ ¼å¼åŒ–åï¼š 12345678/** * @param $args1 * @param int $args2 */function A($args1, $args2=0)&#123; $a=2;&#125; array_indentation [@PhpCsFixer]æ•°ç»„çš„æ¯ä¸ªå…ƒç´ å¿…é¡»ç¼©è¿›ä¸€æ¬¡ã€‚ 123$rules = [ 'array_indentation'=&gt;true]; åŸå§‹æ ¼å¼ï¼š 12345678910/** * @param $args1 * @param int $args2 */function A($args1, $args2=0)&#123; $array=[ '1' ];&#125; æ ¼å¼åŒ–åï¼š 12345678910/** * @param $args1 * @param int $args2 */function A($args1, $args2=0)&#123; $array=[ '1' ];&#125; array_syntax [@PhpCsFixer]åº”ä½¿ç”¨é…ç½®çš„è¯­æ³•å£°æ˜ PHP æ•°ç»„ã€‚ å¯é€‰é…ç½®é¡¹ syntax long (é»˜è®¤ï¼Œç”¨arrayå…³é”®å­—æ¥å®šä¹‰æ•°ç»„) short (ç”¨[]å…³é”®å­—æ¥å®šä¹‰æ•°ç»„) 12345$rules = [ 'array_syntax' =&gt; [ 'syntax' =&gt; 'short', ]]; åŸå§‹æ ¼å¼ï¼š 12345678/** * @param $args1 * @param int $args2 */function A($args1, $args2=0)&#123; $array=array();&#125; æ ¼å¼åŒ–åï¼š 12345678/** * @param $args1 * @param int $args2 */function A($args1, $args2=0)&#123; $array=[];&#125; backtick_to_shell_execå°†åå¼•å·è¿ç®—ç¬¦è½¬æ¢ä¸º shell_exec è°ƒç”¨ã€‚ 123$rules = [ 'backtick_to_shell_exec' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1234567function A()&#123; $out = `echo Hello`; var_dump($out);&#125;A(); æ ¼å¼åŒ–åï¼š 1234567function A()&#123; $out = shell_exec(\"echo Hello\"); var_dump($out);&#125;A(); binary_operator_spaces [@Symfony, @PhpCsFixer]â€œ=â€, â€œâ€œ, â€œ/â€œ, â€œ%â€, â€œ&lt;â€, â€œ&gt;â€, â€œ|â€, â€œ^â€, â€œ+â€, â€œ-â€œ, â€œ&amp;â€, â€œ&amp;=â€, â€œ&amp;&amp;â€, â€œ||â€, â€œ.=â€, â€œ/=â€, â€œ=&gt;â€, â€œ==â€, â€œ&gt;=â€, â€œ===â€, â€œ!=â€, â€œ&lt;&gt;â€, â€œ!==â€, â€œ&lt;=â€, â€œandâ€, â€œorâ€, â€œxorâ€, â€œ-=â€, â€œ%=â€, â€œ=â€, â€œ|=â€, â€œ+=â€, â€œ&lt;&lt;â€, â€œ&lt;&lt;=â€, â€œ&gt;&gt;â€, â€œ&gt;&gt;=â€, â€œ^=â€, â€œâ€œ, â€œ=â€, â€œ&lt;=&gt;â€, â€œ??â€è¿™ä¸€ç±»çš„äºŒè¿›åˆ¶è¿ç®—ç¬¦åº”æŒ‰é…ç½®åŒ…å«çš„ç©ºæ ¼ã€‚ å¯é€‰é…ç½®é¡¹ align_double_arrow (åŒç®­å¤´å±…ä¸­æ ¼å¼ï¼Œå°†ä¼šä¸ºåºŸå¼ƒï¼Œç”¨ default/operators æ¥ä»£æ›¿æ›´è¯¦ç»†çš„é…ç½®) false null true align_equals (ç­‰äºå·å±…ä¸­æ ¼å¼ï¼Œå°†ä¼šä¸ºåºŸå¼ƒï¼Œç”¨ default/operators æ¥ä»£æ›¿æ›´è¯¦ç»†çš„é…ç½®) false null true default (é»˜è®¤) align ï¼ˆå±…ä¸­ï¼‰ align_single_space ï¼ˆé»˜è®¤ï¼Œå•ç©ºæ ¼å±…ä¸­ï¼‰ align_single_space_minimal (å’Œ align_single_space çš„åŒºåˆ«æ˜¯å¦‚æœç©ºæ ¼å¤§äº 1 ä¸ªçš„æ—¶å€™ï¼Œä¼šç¼©å‡åˆ° 1 ä¸ª) no_space ï¼ˆæ²¡æœ‰ç©ºæ ¼ï¼‰ single_space (å•ç©ºæ ¼ï¼Œä¸å±…ä¸­) null (ä¸åšä»»ä½•æ”¹å˜) operatorsï¼ˆarrayï¼‰ ï¼ˆé’ˆå¯¹ç‰¹æ®Šçš„æ“ä½œç¬¦åšç‰¹æ®Šçš„å¤„ç†ï¼‰ key ï¼šâ€=â€, â€œâ€œ, â€œ/â€œ, â€œ%â€, â€œ&lt;â€, â€œ&gt;â€, â€œ|â€, â€œ^â€, â€œ+â€, â€œ-â€œ, â€œ&amp;â€, â€œ&amp;=â€, â€œ&amp;&amp;â€, â€œ||â€, â€œ.=â€, â€œ/=â€, â€œ=&gt;â€, â€œ==â€, â€œ&gt;=â€, â€œ===â€, â€œ!=â€, â€œ&lt;&gt;â€, â€œ!==â€, â€œ&lt;=â€, â€œandâ€, â€œorâ€, â€œxorâ€, â€œ-=â€, â€œ%=â€, â€œ=â€, â€œ|=â€, â€œ+=â€, â€œ&lt;&lt;â€, â€œ&lt;&lt;=â€, â€œ&gt;&gt;â€, â€œ&gt;&gt;=â€, â€œ^=â€, â€œâ€œ, â€œ=â€, â€œ&lt;=&gt;â€, â€œ??â€ value åŒ default è¿™é‡Œå°±ä¸æµ‹è¯• align_double_arrow å’Œ align_equals äº†ï¼Œå› ä¸ºè¿™ 2 ä¸ªå‚æ•°ä¼šè¢«åºŸå¼ƒ 12345$rules = [ 'binary_operator_spaces' =&gt; [ 'default' =&gt; 'align' ]]; åŸå§‹æ ¼å¼ï¼š 12345678function A()&#123; $a = 1&gt;&gt;2; $a = 12&gt;&gt;2; $a = 12&lt;&lt;1; $a = 12&amp;1; $bb=1112|1;&#125; æ ¼å¼åŒ–åï¼š 12345678function A()&#123; $a = 1 &gt;&gt;2; $a = 12&gt;&gt;2; $a = 12&lt;&lt;1; $a = 12&amp;1; $bb=1112|1;&#125; 12345$rules = [ 'binary_operator_spaces' =&gt; [ 'default' =&gt; 'align_single_space' ]]; åŸå§‹æ ¼å¼ï¼š 12345678function A()&#123; $a = 1&gt;&gt;2; $a = 12&gt;&gt;2; $a = 12&lt;&lt;1; $a = 12&amp;1; $bb=1112|1;&#125; æ ¼å¼åŒ–åï¼š 12345678function A()&#123; $a = 1 &gt;&gt; 2; $a = 12 &gt;&gt; 2; $a = 12 &lt;&lt; 1; $a = 12 &amp; 1; $bb = 1112 | 1;&#125; 12345$rules = [ 'binary_operator_spaces' =&gt; [ 'default' =&gt; 'align_single_space_minimal' ]]; åŸå§‹æ ¼å¼ï¼š 12345678function A()&#123; $a = 1 &gt;&gt; 2; $a = 12 &gt;&gt; 2; $a = 12 &lt;&lt; 1; $a = 12 &amp; 1; $bb = 1112 | 1;&#125; æ ¼å¼åŒ–åï¼š 12345678function A()&#123; $a = 1 &gt;&gt; 2; $a = 12 &gt;&gt; 2; $a = 12 &lt;&lt; 1; $a = 12 &amp; 1; $bb = 1112 | 1;&#125; 12345$rules = [ 'binary_operator_spaces' =&gt; [ 'default' =&gt; 'no_space' ]]; åŸå§‹æ ¼å¼ï¼š 12345678function A()&#123; $a = 1 &gt;&gt; 2; $a = 12 &gt;&gt; 2; $a = 12 &lt;&lt; 1; $a = 12 &amp; 1; $bb = 1112 | 1;&#125; æ ¼å¼åŒ–åï¼š 12345678function A()&#123; $a=1&gt;&gt;2; $a=12&gt;&gt;2; $a=12&lt;&lt;1; $a=12&amp;1; $bb=1112|1;&#125; 12345$rules = [ 'binary_operator_spaces' =&gt; [ 'default' =&gt; 'single_space' ]]; åŸå§‹æ ¼å¼ï¼š 12345678function A()&#123; $a=1&gt;&gt;2; $a=12&gt;&gt;2; $a=12&lt;&lt;1; $a=12&amp;1; $bb=1112|1;&#125; æ ¼å¼åŒ–åï¼š 12345678function A()&#123; $a = 1 &gt;&gt; 2; $a = 12 &gt;&gt; 2; $a = 12 &lt;&lt; 1; $a = 12 &amp; 1; $bbbb = 1112 | 1;&#125; 1234567$rules = [ 'binary_operator_spaces' =&gt; [ 'operators' =&gt; [ '=' =&gt; 'no_space' ] ]]; åŸå§‹æ ¼å¼ï¼š 12345678function A()&#123; $array = [ 'a'=&gt;1, 'bb'=&gt;2, 'ccc'=&gt;3 ];&#125; æ ¼å¼åŒ–åï¼š 12345678function A()&#123; $array=[ 'a' =&gt; 1, 'bb' =&gt; 2, 'ccc' =&gt; 3 ];&#125; blank_line_after_namespace [@PSR2, @Symfony, @PhpCsFixer]å‘½åç©ºé—´ä¹‹åç©ºä¸€è¡Œ 123$rules = [ 'blank_line_after_namespace' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1234namespace Test;function A()&#123;&#125; æ ¼å¼åŒ–åï¼š 12345namespace Test;function A()&#123;&#125; blank_line_after_opening_tag [@Symfony, @PhpCsFixer]&lt;?php åé¢åŠ ä¸€ä¸ªç©ºè¡Œ 123$rules = [ 'blank_line_after_namespace' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123456&lt;?phpnamespace Test;function A()&#123;&#125; æ ¼å¼åŒ–åï¼š 1234567&lt;?phpnamespace Test;function A()&#123;&#125; blank_line_before_returnreturn å‰é¢åŠ ä¸€ä¸ªç©ºç™½è¡Œï¼ˆå¼ƒç”¨ï¼ç”¨ blank_line_before_statement ä»£æ›¿ï¼‰ 123$rules = [ 'blank_line_before_return' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 12345function A()&#123; $a = '123' return $a;&#125; æ ¼å¼åŒ–åï¼š 123456function A()&#123; $a = '123' return $a;&#125; blank_line_before_statement [@Symfony, @PhpCsFixer]ç©ºè¡Œæ¢è¡Œå¿…é¡»åœ¨ä»»ä½•å·²é…ç½®çš„è¯­å¥ä¹‹å‰ 1234567891011$rules = [ 'blank_line_before_statement' =&gt; [ 'statements' =&gt; [ 'break', 'continue', 'declare', 'return', 'throw', 'try' ]]; å¯é€‰é…ç½®é¡¹ statements (èµ‹å€¼æ•°ç»„) break case continue declare default die do exit for foreach goto if include include_once require require_once return switch throw try while yield é»˜è®¤é…ç½®é¡¹çš„å€¼ä¸ºï¼š[â€˜breakâ€™, â€˜continueâ€™, â€˜declareâ€™, â€˜returnâ€™, â€˜throwâ€™, â€˜tryâ€™] åŸå§‹æ ¼å¼ï¼š 123456789101112131415161718function A()&#123; $a = 1; switch ($a) &#123; case 1: break; default: &#125; while (true) &#123; if ($a == true)&#123; $a = 2; continue; &#125; &#125; throw new \\Exception(); return 1;&#125; æ ¼å¼åŒ–åï¼š 123456789101112131415161718192021function A()&#123; $a = 1; switch ($a) &#123; case 1: break; default: &#125; while (true) &#123; if ($a == true) &#123; $a = 2; continue; &#125; &#125; throw new \\Exception(); return 1;&#125; braces [@PSR2, @Symfony, @PhpCsFixer]æ¯ä¸ªç»“æ„çš„ä¸»ä½“å¿…é¡»ç”¨å¤§æ‹¬å·æ‹¬èµ·æ¥ã€‚å¤§æ‹¬å·åº”å¦¥å–„æ”¾ç½®ã€‚å¤§æ‹¬å·åº”é€‚å½“ç¼©è¿›ã€‚ å¯é€‰é…ç½®é¡¹ allow_single_line_closure (æ˜¯å¦åº”è¯¥å…è®¸å•è¡Œ lambda è¡¨ç¤ºæ³•) true false (é»˜è®¤) position_after_anonymous_constructs (åœ¨åŒ¿åæ„é€ ï¼ˆåŒ¿åç±»å’Œ lambda å‡½æ•°ï¼‰ä¹‹åæ˜¯å¦åº”å°†å¼€æ‹¬å·æ”¾åœ¨â€œnextâ€æˆ–â€œsameâ€è¡Œ) next same (é»˜è®¤) position_after_functions_and_oop_constructs åœ¨ä¼˜é›…ç»“æ„ï¼ˆéåŒ¿åç±»ï¼Œæ¥å£ï¼Œç‰¹å¾ï¼Œæ–¹æ³•å’Œé lambda å‡½æ•°ï¼‰ä¹‹åï¼Œæ˜¯å¦åº”å°†å¼€æ‹¬å·æ”¾åœ¨â€œnextâ€æˆ–â€œsameâ€è¡Œä¸Š next ï¼ˆé»˜è®¤ï¼‰ same è¿™ä¸ªè§„åˆ™å°±ä¸å†™äº†ï¼Œå› ä¸ºè¿™ä¸ªå°±æ˜¯æœ€ä½³çš„äº†ï¼Œå› ä¸ºæ˜¯ PSR2 æ ‡å‡†ï¼ˆå·æ‡’ï¼‰ åŸå§‹æ ¼å¼ï¼š 12345class A&#123; public function __construct()&#123; $a = function()&#123; echo 1;&#125;; &#125;&#125; æ ¼å¼åŒ–åï¼š 123456789class A&#123; public function __construct() &#123; $a = function () &#123; echo 1; &#125;; &#125;&#125; cast_spaces [@Symfony, @PhpCsFixer]ç±»å‹è½¬æ¢çš„æ—¶å€™ï¼Œæ˜¯å¦éœ€è¦åœ¨ä¸­é—´åŠ ç©ºæ ¼ å¯é€‰é…ç½®é¡¹ space none single (é»˜è®¤) 123456$rules = [ 'cast_spaces' =&gt; [ 'space' =&gt; [ 'single', ]]; åŸå§‹æ ¼å¼ï¼š 123function A()&#123; echo (int)1;&#125; æ ¼å¼åŒ–åï¼š 1234function A()&#123; echo (int) 1;&#125; class_attributes_separation [@Symfony, @PhpCsFixer]Class, trait å’Œ interface çš„å±æ€§æ˜¯å¦éœ€è¦ä¸€ä¸ªç©ºè¡Œéš”å¼€ å¯é€‰é…ç½®é¡¹ elements ï¼ˆæ•°ç»„ï¼‰ const method property é»˜è®¤é…ç½®é¡¹çš„å€¼ä¸ºï¼š[â€˜constâ€™, â€˜methodâ€™, â€˜propertyâ€™] 12345$rules = [ 'class_attributes_separation' =&gt; [ 'elements' =&gt; ['const', 'method', 'property'] ]]; åŸå§‹æ ¼å¼ï¼š 12345class A&#123; private $a; private $b;&#125; æ ¼å¼åŒ–åï¼š 123456class A&#123; private $a; private $b;&#125; class_definition [@PSR2, @Symfony, @PhpCsFixer]class,trait,interface å…³é”®å­—å‘¨å›´æ˜¯å¦åªæœ‰ä¸€ä¸ªç©ºæ ¼ å¯é€‰é…ç½®é¡¹ multi_line_extends_each_single_line true false (é»˜è®¤) single_item_single_line true false (é»˜è®¤) single_line true false (é»˜è®¤) PSR2 æ ‡å‡†çš„å°±ä¸å…·ä½“é…ç½®äº† åŸå§‹æ ¼å¼ï¼š 12345class A&#123; private $a; private $b;&#125; æ ¼å¼åŒ–åï¼š 123456class A&#123; private $a; private $b;&#125; class_keyword_remove::class å…³é”®å­—ç§»é™¤ï¼Œè½¬æˆå­—ç¬¦ä¸² 123$rules = [ 'class_keyword_remove' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 12345class A&#123;&#125;echo A::class; æ ¼å¼åŒ–åï¼š 12345class A&#123;&#125;echo 'A'; combine_consecutive_issets [@PhpCsFixer]å½“å¤šä¸ª isset é€šè¿‡&amp;&amp;è¿æ¥çš„æ—¶å€™ï¼Œåˆå¹¶å¤„ç† 123$rules = [ 'combine_consecutive_issets' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1isset($a) &amp;&amp; isset($b) &amp;&amp; isset($c); æ ¼å¼åŒ–åï¼š 1isset($a, $b, $c); combine_consecutive_unsets [@PhpCsFixer]å½“å¤šä¸ª unset ä½¿ç”¨çš„æ—¶å€™ï¼Œåˆå¹¶å¤„ç† 123$rules = [ 'combine_consecutive_unsets' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123unset($a);unset($b);unset($c); æ ¼å¼åŒ–åï¼š 1unset($a, $b, $c); combine_nested_dirname [@PHP70Migration:risky, @PHP71Migration:risky]Replace multiple nested calls of dirname by only one call with second $level parameter. Requires PHP &gt;= 7.0. Risky rule: risky when the function dirname is overridden. comment_to_phpdoc [@PhpCsFixer:risky]Comments with annotation should be docblock when used on structural elements. Risky rule: risky as new docblocks might mean more, e.g. a Doctrine entity might have a new column in database. compact_nullable_typehint [@PhpCsFixer] æš‚æ—¶ä¸å¤ªæ¸…æ¥šä»€ä¹ˆåŒºåˆ« concat_space [@Symfony, @PhpCsFixer]è¿æ¥å­—ç¬¦æ˜¯å¦éœ€è¦ç©ºæ ¼ å¯é€‰é…ç½®é¡¹ spacing none (é»˜è®¤) one 12345$rules = [ 'concat_space' =&gt; [ 'spacing' =&gt; 'one' ]]; åŸå§‹æ ¼å¼ï¼š 123$a = '';$c = 'c';$b = $a.$c; æ ¼å¼åŒ–åï¼š 123$a = '';$c = 'c';$b = $a . $c; date_time_immutableClass DateTimeImmutable should be used instead of DateTime. Risky rule: risky when the code relies on modifying DateTime objects or if any of the date_create* functions are overridden. declare_equal_normalize [@Symfony, @PhpCsFixer]declare è¯­å¥ä¸­çš„ç­‰äºå·æ˜¯å¦éœ€è¦ç©ºæ ¼ å¯é€‰é…ç½®é¡¹ space none singleï¼ˆé»˜è®¤ï¼‰ 12345$rules = [ 'declare_equal_normalize' =&gt; [ 'space' =&gt; 'single' ]]; åŸå§‹æ ¼å¼ï¼š 12declare(ticks=1) &#123;&#125; æ ¼å¼åŒ–åï¼š 12declare(ticks = 1) &#123;&#125; declare_strict_types [@PHP70Migration:risky, @PHP71Migration:risky]Force strict types declaration in all files. Requires PHP &gt;= 7.0. Risky rule: forcing strict types will stop non strict code from working. dir_constant [@Symfony:risky, @PhpCsFixer:risky]Replaces dirname(__FILE__) expression with equivalent __DIR__ constant. Risky rule: risky when the function dirname is overridden. doctrine_annotation_array_assignment [@DoctrineAnnotation]Doctrine annotations must use configured operator for assignment in arrays. Configuration options: ignored_tags (array): list of tags that must not be treated as Doctrine Annotations; defaults to [â€˜abstractâ€™, â€˜accessâ€™, â€˜codeâ€™, â€˜deprecâ€™, â€˜encodeâ€™, â€˜exceptionâ€™, â€˜finalâ€™, â€˜ingroupâ€™, â€˜inheritdocâ€™, â€˜inheritDocâ€™, â€˜magicâ€™, â€˜nameâ€™, â€˜tocâ€™, â€˜tutorialâ€™, â€˜privateâ€™, â€˜staticâ€™, â€˜staticvarâ€™, â€˜staticVarâ€™, â€˜throwâ€™, â€˜apiâ€™, â€˜authorâ€™, â€˜categoryâ€™, â€˜copyrightâ€™, â€˜deprecatedâ€™, â€˜exampleâ€™, â€˜filesourceâ€™, â€˜globalâ€™, â€˜ignoreâ€™, â€˜internalâ€™, â€˜licenseâ€™, â€˜linkâ€™, â€˜methodâ€™, â€˜packageâ€™, â€˜paramâ€™, â€˜propertyâ€™, â€˜property-readâ€™, â€˜property-writeâ€™, â€˜returnâ€™, â€˜seeâ€™, â€˜sinceâ€™, â€˜sourceâ€™, â€˜subpackageâ€™, â€˜throwsâ€™, â€˜todoâ€™, â€˜TODOâ€™, â€˜usedByâ€™, â€˜usesâ€™, â€˜varâ€™, â€˜versionâ€™, â€˜afterâ€™, â€˜afterClassâ€™, â€˜backupGlobalsâ€™, â€˜backupStaticAttributesâ€™, â€˜beforeâ€™, â€˜beforeClassâ€™, â€˜codeCoverageIgnoreâ€™, â€˜codeCoverageIgnoreStartâ€™, â€˜codeCoverageIgnoreEndâ€™, â€˜coversâ€™, â€˜coversDefaultClassâ€™, â€˜coversNothingâ€™, â€˜dataProviderâ€™, â€˜dependsâ€™, â€˜expectedExceptionâ€™, â€˜expectedExceptionCodeâ€™, â€˜expectedExceptionMessageâ€™, â€˜expectedExceptionMessageRegExpâ€™, â€˜groupâ€™, â€˜largeâ€™, â€˜mediumâ€™, â€˜preserveGlobalStateâ€™, â€˜requiresâ€™, â€˜runTestsInSeparateProcessesâ€™, â€˜runInSeparateProcessâ€™, â€˜smallâ€™, â€˜testâ€™, â€˜testdoxâ€™, â€˜ticketâ€™, â€˜usesâ€™, â€˜SuppressWarningsâ€™, â€˜noinspectionâ€™, â€˜package_versionâ€™, â€˜endumlâ€™, â€˜startumlâ€™, â€˜fixâ€™, â€˜FIXMEâ€™, â€˜fixmeâ€™, â€˜overrideâ€™]operator (â€˜:â€™, â€˜=â€™): the operator to use; defaults to â€˜=â€™ doctrine_annotation_braces [@DoctrineAnnotation]Doctrine annotations without arguments must use the configured syntax. Configuration options: ignored_tags (array): list of tags that must not be treated as Doctrine Annotations; defaults to [â€˜abstractâ€™, â€˜accessâ€™, â€˜codeâ€™, â€˜deprecâ€™, â€˜encodeâ€™, â€˜exceptionâ€™, â€˜finalâ€™, â€˜ingroupâ€™, â€˜inheritdocâ€™, â€˜inheritDocâ€™, â€˜magicâ€™, â€˜nameâ€™, â€˜tocâ€™, â€˜tutorialâ€™, â€˜privateâ€™, â€˜staticâ€™, â€˜staticvarâ€™, â€˜staticVarâ€™, â€˜throwâ€™, â€˜apiâ€™, â€˜authorâ€™, â€˜categoryâ€™, â€˜copyrightâ€™, â€˜deprecatedâ€™, â€˜exampleâ€™, â€˜filesourceâ€™, â€˜globalâ€™, â€˜ignoreâ€™, â€˜internalâ€™, â€˜licenseâ€™, â€˜linkâ€™, â€˜methodâ€™, â€˜packageâ€™, â€˜paramâ€™, â€˜propertyâ€™, â€˜property-readâ€™, â€˜property-writeâ€™, â€˜returnâ€™, â€˜seeâ€™, â€˜sinceâ€™, â€˜sourceâ€™, â€˜subpackageâ€™, â€˜throwsâ€™, â€˜todoâ€™, â€˜TODOâ€™, â€˜usedByâ€™, â€˜usesâ€™, â€˜varâ€™, â€˜versionâ€™, â€˜afterâ€™, â€˜afterClassâ€™, â€˜backupGlobalsâ€™, â€˜backupStaticAttributesâ€™, â€˜beforeâ€™, â€˜beforeClassâ€™, â€˜codeCoverageIgnoreâ€™, â€˜codeCoverageIgnoreStartâ€™, â€˜codeCoverageIgnoreEndâ€™, â€˜coversâ€™, â€˜coversDefaultClassâ€™, â€˜coversNothingâ€™, â€˜dataProviderâ€™, â€˜dependsâ€™, â€˜expectedExceptionâ€™, â€˜expectedExceptionCodeâ€™, â€˜expectedExceptionMessageâ€™, â€˜expectedExceptionMessageRegExpâ€™, â€˜groupâ€™, â€˜largeâ€™, â€˜mediumâ€™, â€˜preserveGlobalStateâ€™, â€˜requiresâ€™, â€˜runTestsInSeparateProcessesâ€™, â€˜runInSeparateProcessâ€™, â€˜smallâ€™, â€˜testâ€™, â€˜testdoxâ€™, â€˜ticketâ€™, â€˜usesâ€™, â€˜SuppressWarningsâ€™, â€˜noinspectionâ€™, â€˜package_versionâ€™, â€˜endumlâ€™, â€˜startumlâ€™, â€˜fixâ€™, â€˜FIXMEâ€™, â€˜fixmeâ€™, â€˜overrideâ€™]syntax (â€˜with_bracesâ€™, â€˜without_bracesâ€™): whether to add or remove braces; defaults to â€˜without_bracesâ€™ doctrine_annotation_indentation [@DoctrineAnnotation]Doctrine annotations must be indented with four spaces. Configuration options: ignored_tags (array): list of tags that must not be treated as Doctrine Annotations; defaults to [â€˜abstractâ€™, â€˜accessâ€™, â€˜codeâ€™, â€˜deprecâ€™, â€˜encodeâ€™, â€˜exceptionâ€™, â€˜finalâ€™, â€˜ingroupâ€™, â€˜inheritdocâ€™, â€˜inheritDocâ€™, â€˜magicâ€™, â€˜nameâ€™, â€˜tocâ€™, â€˜tutorialâ€™, â€˜privateâ€™, â€˜staticâ€™, â€˜staticvarâ€™, â€˜staticVarâ€™, â€˜throwâ€™, â€˜apiâ€™, â€˜authorâ€™, â€˜categoryâ€™, â€˜copyrightâ€™, â€˜deprecatedâ€™, â€˜exampleâ€™, â€˜filesourceâ€™, â€˜globalâ€™, â€˜ignoreâ€™, â€˜internalâ€™, â€˜licenseâ€™, â€˜linkâ€™, â€˜methodâ€™, â€˜packageâ€™, â€˜paramâ€™, â€˜propertyâ€™, â€˜property-readâ€™, â€˜property-writeâ€™, â€˜returnâ€™, â€˜seeâ€™, â€˜sinceâ€™, â€˜sourceâ€™, â€˜subpackageâ€™, â€˜throwsâ€™, â€˜todoâ€™, â€˜TODOâ€™, â€˜usedByâ€™, â€˜usesâ€™, â€˜varâ€™, â€˜versionâ€™, â€˜afterâ€™, â€˜afterClassâ€™, â€˜backupGlobalsâ€™, â€˜backupStaticAttributesâ€™, â€˜beforeâ€™, â€˜beforeClassâ€™, â€˜codeCoverageIgnoreâ€™, â€˜codeCoverageIgnoreStartâ€™, â€˜codeCoverageIgnoreEndâ€™, â€˜coversâ€™, â€˜coversDefaultClassâ€™, â€˜coversNothingâ€™, â€˜dataProviderâ€™, â€˜dependsâ€™, â€˜expectedExceptionâ€™, â€˜expectedExceptionCodeâ€™, â€˜expectedExceptionMessageâ€™, â€˜expectedExceptionMessageRegExpâ€™, â€˜groupâ€™, â€˜largeâ€™, â€˜mediumâ€™, â€˜preserveGlobalStateâ€™, â€˜requiresâ€™, â€˜runTestsInSeparateProcessesâ€™, â€˜runInSeparateProcessâ€™, â€˜smallâ€™, â€˜testâ€™, â€˜testdoxâ€™, â€˜ticketâ€™, â€˜usesâ€™, â€˜SuppressWarningsâ€™, â€˜noinspectionâ€™, â€˜package_versionâ€™, â€˜endumlâ€™, â€˜startumlâ€™, â€˜fixâ€™, â€˜FIXMEâ€™, â€˜fixmeâ€™, â€˜overrideâ€™]indent_mixed_lines (bool): whether to indent lines that have content before closing parenthesis; defaults to false doctrine_annotation_spaces [@DoctrineAnnotation]Fixes spaces in Doctrine annotations. Configuration options: after_argument_assignments (null, bool): whether to add, remove or ignore spaces after argument assignment operator; defaults to falseafter_array_assignments_colon (null, bool): whether to add, remove or ignore spaces after array assignment : operator; defaults to trueafter_array_assignments_equals (null, bool): whether to add, remove or ignore spaces after array assignment = operator; defaults to truearound_argument_assignments (bool): whether to fix spaces around argument assignment operator; defaults to true. DEPRECATED: use options before_argument_assignments and after_argument_assignments insteadaround_array_assignments (bool): whether to fix spaces around array assignment operators; defaults to true. DEPRECATED: use options before_array_assignments_equals, after_array_assignments_equals, before_array_assignments_colon and after_array_assignments_colon insteadaround_commas (bool): whether to fix spaces around commas; defaults to truearound_parentheses (bool): whether to fix spaces around parentheses; defaults to truebefore_argument_assignments (null, bool): whether to add, remove or ignore spaces before argument assignment operator; defaults to falsebefore_array_assignments_colon (null, bool): whether to add, remove or ignore spaces before array : assignment operator; defaults to truebefore_array_assignments_equals (null, bool): whether to add, remove or ignore spaces before array = assignment operator; defaults to trueignored_tags (array): list of tags that must not be treated as Doctrine Annotations; defaults to [â€˜abstractâ€™, â€˜accessâ€™, â€˜codeâ€™, â€˜deprecâ€™, â€˜encodeâ€™, â€˜exceptionâ€™, â€˜finalâ€™, â€˜ingroupâ€™, â€˜inheritdocâ€™, â€˜inheritDocâ€™, â€˜magicâ€™, â€˜nameâ€™, â€˜tocâ€™, â€˜tutorialâ€™, â€˜privateâ€™, â€˜staticâ€™, â€˜staticvarâ€™, â€˜staticVarâ€™, â€˜throwâ€™, â€˜apiâ€™, â€˜authorâ€™, â€˜categoryâ€™, â€˜copyrightâ€™, â€˜deprecatedâ€™, â€˜exampleâ€™, â€˜filesourceâ€™, â€˜globalâ€™, â€˜ignoreâ€™, â€˜internalâ€™, â€˜licenseâ€™, â€˜linkâ€™, â€˜methodâ€™, â€˜packageâ€™, â€˜paramâ€™, â€˜propertyâ€™, â€˜property-readâ€™, â€˜property-writeâ€™, â€˜returnâ€™, â€˜seeâ€™, â€˜sinceâ€™, â€˜sourceâ€™, â€˜subpackageâ€™, â€˜throwsâ€™, â€˜todoâ€™, â€˜TODOâ€™, â€˜usedByâ€™, â€˜usesâ€™, â€˜varâ€™, â€˜versionâ€™, â€˜afterâ€™, â€˜afterClassâ€™, â€˜backupGlobalsâ€™, â€˜backupStaticAttributesâ€™, â€˜beforeâ€™, â€˜beforeClassâ€™, â€˜codeCoverageIgnoreâ€™, â€˜codeCoverageIgnoreStartâ€™, â€˜codeCoverageIgnoreEndâ€™, â€˜coversâ€™, â€˜coversDefaultClassâ€™, â€˜coversNothingâ€™, â€˜dataProviderâ€™, â€˜dependsâ€™, â€˜expectedExceptionâ€™, â€˜expectedExceptionCodeâ€™, â€˜expectedExceptionMessageâ€™, â€˜expectedExceptionMessageRegExpâ€™, â€˜groupâ€™, â€˜largeâ€™, â€˜mediumâ€™, â€˜preserveGlobalStateâ€™, â€˜requiresâ€™, â€˜runTestsInSeparateProcessesâ€™, â€˜runInSeparateProcessâ€™, â€˜smallâ€™, â€˜testâ€™, â€˜testdoxâ€™, â€˜ticketâ€™, â€˜usesâ€™, â€˜SuppressWarningsâ€™, â€˜noinspectionâ€™, â€˜package_versionâ€™, â€˜endumlâ€™, â€˜startumlâ€™, â€˜fixâ€™, â€˜FIXMEâ€™, â€˜fixmeâ€™, â€˜overrideâ€™] elseif [@PSR2, @Symfony, @PhpCsFixer]ç”¨elseifæ¥ä»£æ›¿else if ç”±äºæ˜¯ PSR2 çš„æ ‡å‡†ï¼Œæ‰€ä»¥å°±ä¸é…ç½®äº† åŸå§‹æ ¼å¼ï¼š 123if ($a = 1) &#123;&#125; else if (true) &#123;&#125; æ ¼å¼åŒ–åï¼š 123if ($a = 1) &#123;&#125; elseif (true) &#123;&#125; encoding [@PSR1, @PSR2, @Symfony, @PhpCsFixer]PHP ä»£ç å¿…é¡»åªä½¿ç”¨æ²¡æœ‰ BOM çš„ UTF-8ï¼ˆåˆ é™¤ BOMï¼‰ã€‚ ç”±äºæ˜¯ PSR2 çš„æ ‡å‡†ï¼Œæ‰€ä»¥å°±ä¸é…ç½®äº† è¿™ä¸ªä¹Ÿæ²¡ä»€ä¹ˆå¥½æ¼”ç¤ºçš„äº† ereg_to_preg [@Symfony:risky, @PhpCsFixer:risky]Replace deprecated ereg regular expression functions with preg. Risky rule: risky if the ereg function is overridden. error_suppression [@Symfony:risky, @PhpCsFixer:risky]Error control operator should be added to deprecation notices and/or removed from other cases. Risky rule: risky because adding/removing @ might cause changes to code behaviour or if trigger_error function is overridden. Configuration options: mute_deprecation_error (bool): whether to add @ in deprecation notices; defaults to truenoise_remaining_usages (bool): whether to remove @ in remaining usages; defaults to falsenoise_remaining_usages_exclude (array): list of global functions to exclude from removing @; defaults to [] escape_implicit_backslashes [@PhpCsFixer]æ˜¯å¦éœ€è¦è‡ªåŠ¨å¸®å¿™æ·»åŠ è½¬ä¹‰å­—ç¬¦ å¯é€‰é…ç½®é¡¹ double_quoted (åŒå¼•å·) true ï¼ˆé»˜è®¤ï¼‰ false heredoc_syntax ï¼ˆheredoc çš„è¯­æ³•ï¼‰ true ï¼ˆé»˜è®¤ï¼‰ false single_quoted (å•å¼•å·) true false ï¼ˆé»˜è®¤ï¼‰ 1234567$rules = [ 'escape_implicit_backslashes' =&gt; [ 'double_quoted' =&gt; true, 'heredoc_syntax' =&gt; true, 'single_quoted' =&gt; false ]]; åŸå§‹æ ¼å¼ï¼š 12345$a = \"\\d\";$a = &lt;&lt;&lt;HEREDOC\\dHEREDOC;$a = '\\d'; æ ¼å¼åŒ–åï¼š 12345$a = \"\\\\d\";$a = &lt;&lt;&lt;HEREDOC\\\\dHEREDOC;$a = '\\d'; explicit_indirect_variable [@PhpCsFixer]Add curly braces to indirect variables to make them clear to understand. Requires PHP &gt;= 7.0. explicit_string_variable [@PhpCsFixer]æŠŠåŒå¼•å·æˆ–è€… heredoc å­—ç¬¦ä¸²å†…éƒ¨çš„éšå½¢å˜é‡è½¬æˆæ˜¾æ€§ 123$rules = [ 'explicit_string_variable' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 12345$b = 'b';$a = \"\\d $b\";$a = &lt;&lt;&lt;HEREDOC\\d $bHEREDOC; æ ¼å¼åŒ–åï¼š 12345$b = 'b';$a = \"\\d $&#123;b&#125;\";$a = &lt;&lt;&lt;HEREDOC\\d $&#123;b&#125;HEREDOC; final_classAll classes must be final, except abstract ones and Doctrine entities. Risky rule: risky when subclassing non-abstract classes. final_internal_class [@PhpCsFixer:risky]Internal classes should be final. Risky rule: changing classes to final might cause code execution to break. Configuration options: annotation-black-list (array): class level annotations tags that must be omitted to fix the class, even if all of the white list ones are used as well. (case insensitive); defaults to [â€˜@finalâ€™, â€˜@Entityâ€™, â€˜@ORM\\Entityâ€™]annotation-white-list (array): class level annotations tags that must be set in order to fix the class. (case insensitive); defaults to [â€˜@internalâ€™]consider-absent-docblock-as-internal-class (bool): should classes without any DocBlock be fixed to final?; defaults to false fopen_flag_order [@Symfony:risky, @PhpCsFixer:risky]Order the flags in fopen calls, b and t must be last. Risky rule: risky when the function fopen is overridden. fopen_flags [@Symfony:risky, @PhpCsFixer:risky]The flags in fopen calls must omit t, and b must be omitted or included consistently. Risky rule: risky when the function fopen is overridden. Configuration options: b_mode (bool): the b flag must be used (true) or omitted (false); defaults to true fopen_flags [@Symfony:risky, @PhpCsFixer:risky]The flags in fopen calls must omit t, and b must be omitted or included consistently. Risky rule: risky when the function fopen is overridden. Configuration options: b_mode (bool): the b flag must be used (true) or omitted (false); defaults to true full_opening_tag [@PSR1, @PSR2, @Symfony, @PhpCsFixer]php ä»£ç å¿…é¡»ç”¨ &lt;?php æˆ–è€… &lt;?= ä¸èƒ½æ˜¯å…¶ä»– è¿™ä¸ªåœ¨ä»¥å‰çš„å‰åæ®µä»£ç ä¸€èµ·çš„æ—¶å€™å¯èƒ½éœ€è¦æ³¨æ„çš„é—®é¢˜ï¼Œåœ¨è¿™é‡Œä¸åšè¿‡å¤šçš„æ¼”ç¤º fully_qualified_strict_types [@PhpCsFixer]Transforms imported FQCN parameters and return types in function arguments to short version. function_declaration [@PSR2, @Symfony, @PhpCsFixer]å¿…åŒ…å‡½æ•°å…³é”®å­—functionåé¢æ˜¯å¦éœ€è¦ç©ºæ ¼ å¯é€‰é…ç½®é¡¹ closure_function_spacing ï¼ˆé—­åŒ…å‡½æ•° function æ˜¯å¦éœ€è¦ç©ºæ ¼ï¼‰ none one (é»˜è®¤) 12345$rules = [ 'function_declaration' =&gt; [ 'closure_function_spacing' =&gt; 'one' ]]; åŸå§‹æ ¼å¼ï¼š 12$a = function($a, $b) &#123;&#125;; æ ¼å¼åŒ–åï¼š 12$a = function ($a, $b) &#123;&#125;; function_to_constant [@Symfony:risky, @PhpCsFixer:risky]Replace core functions calls returning constants with the constants. Risky rule: risky when any of the configured functions to replace are overridden. Configuration options: functions (a subset of [â€˜get_called_classâ€™, â€˜get_classâ€™, â€˜php_sapi_nameâ€™, â€˜phpversionâ€™, â€˜piâ€™]): list of function names to fix; defaults to [â€˜get_classâ€™, â€˜php_sapi_nameâ€™, â€˜phpversionâ€™, â€˜piâ€™] function_typehint_space [@Symfony, @PhpCsFixer]åœ¨é—­åŒ…å‡½æ•°çš„å‚æ•°ç±»å‹çº¦æŸçš„æ—¶å€™ï¼Œæ˜¯å¦éœ€è¦ç©ºæ ¼ 123$rules = [ 'function_typehint_space' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 12$a = function(array$a, $b) &#123;&#125;; æ ¼å¼åŒ–åï¼š 12$a = function (array $a, $b) &#123;&#125;; general_phpdoc_annotation_removeåœ¨ phpdoc ä¸­åº”è¯¥å¿½ç•¥çš„æ³¨è§£ å¯é€‰é…ç½®é¡¹ annotations(æ•°ç»„) author â€¦ é»˜è®¤å¯é€‰é…ç½®é¡¹çš„å€¼ï¼š[] 1234567$rules = [ 'general_phpdoc_annotation_remove' =&gt; [ 'annotations' =&gt; [ 'author' ] ]]; åŸå§‹æ ¼å¼ï¼š 123456/** * @copyright 471113744@qq.com * @author caiwenhui */$a = '1'; æ ¼å¼åŒ–åï¼š 12345/** * @copyright caiwenhui */$a = '1'; hash_to_slash_commentSingle line comments should use double slashes // and not hash #. DEPRECATED: use single_line_comment_style instead. header_commentAdd, replace or remove header comment. Configuration options: comment_type (â€˜commentâ€™, â€˜PHPDocâ€™): comment syntax type; defaults to â€˜commentâ€™; DEPRECATED alias: commentTypeheader (string): proper header content; requiredlocation (â€˜after_declare_strictâ€™, â€˜after_openâ€™): the location of the inserted header; defaults to â€˜after_declare_strictâ€™separate (â€˜bothâ€™, â€˜bottomâ€™, â€˜noneâ€™, â€˜topâ€™): whether the header should be separated from the file content with a new line; defaults to â€˜bothâ€™ heredoc_indentation [@PHP73Migration]Heredoc/nowdoc content must be properly indented. Requires PHP &gt;= 7.3. heredoc_to_nowdoc [@PhpCsFixer]å½“ä¸€ä¸ª heredoc é‡Œé¢æ²¡æœ‰å˜é‡å½“æ—¶å€™ï¼Œå¯ä»¥è½¬æˆ nowdoc 123$rules = [ 'heredoc_to_nowdoc' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 12345678$b = 'a';$a = &lt;&lt;&lt;HEREDOC$&#123;b&#125;HEREDOC;$c = &lt;&lt;&lt;CNOWDOC\\$bCNOWDOC; æ ¼å¼åŒ–åï¼š 12345678$b = 'a';$a = &lt;&lt;&lt;HEREDOC$&#123;b&#125;HEREDOC;$c = &lt;&lt;&lt;'CNOWDOC'$bCNOWDOC; implode_call [@Symfony:risky, @PhpCsFixer:risky]Function implode must be called with 2 arguments in the documented order. Risky rule: risky when the function implode is overridden. include [@Symfony, @PhpCsFixer]Include/Require çš„æ—¶å€™ï¼Œä¸åº”è¯¥ç”¨æ‹¬å·æ‰©èµ·æ¥ï¼Œåº”è¯¥ç”¨ç©ºæ ¼åˆ†å‰² 123$rules = [ 'include' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1include('test.php'); æ ¼å¼åŒ–åï¼š 1include 'test.php'; increment_style [@Symfony, @PhpCsFixer]Pre- or post-increment and decrement operators should be used if possible. Configuration options: style (â€˜postâ€™, â€˜preâ€™): whether to use pre- or post-increment and decrement operators; defaults to â€˜preâ€™ indentation_type [@PSR2, @Symfony, @PhpCsFixer]Code MUST use configured indentation type. is_null [@Symfony:risky, @PhpCsFixer:risky]Replaces is_null($var) expression with null === $var. Risky rule: risky when the function is_null is overridden. Configuration options: use_yoda_style (bool): whether Yoda style conditions should be used; defaults to true. DEPRECATED: use yoda_style fixer instead line_ending [@PSR2, @Symfony, @PhpCsFixer]æ‰€æœ‰çš„ PHP æ–‡ä»¶ç¼–ç å¿…é¡»ä¸€è‡´ linebreak_after_opening_tagåœ¨&lt;?php æ ‡ç­¾æ‰€åœ¨çš„è¡Œä¸å…è®¸å­˜åœ¨ä»£ç  123$rules = [ 'linebreak_after_opening_tag' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123&lt;?php $a = 2;$a = 0; æ ¼å¼åŒ–åï¼š 12345&lt;?php$a = 2;$a = 0; list_syntaxList (array destructuring) assignment should be declared using the configured syntax. Requires PHP &gt;= 7.1. Configuration options: syntax (â€˜longâ€™, â€˜shortâ€™): whether to use the long or short list syntax; defaults to â€˜longâ€™ logical_operators [@PhpCsFixer:risky]Use &amp;&amp; and || logical operators instead of and and or. Risky rule: risky, because you must double-check if using and/or with lower precedence was intentional. lowercase_cast [@Symfony, @PhpCsFixer]æ•°æ®ç±»å‹è½¬æ¢å¿…é¡»å°å†™ 123$rules = [ 'lowercase_cast' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123&lt;?php$a = (INT)2; æ ¼å¼åŒ–åï¼š 123&lt;?php$a = (int)2; lowercase_constants [@PSR2, @Symfony, @PhpCsFixer]true, false, null è¿™å‡ ä¸ª php å¸¸é‡å¿…é¡»ä¸ºå°å†™ 123$rules = [ 'lowercase_constants' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123$a = TRUE;$a = FALSE;$a = NULL; æ ¼å¼åŒ–åï¼š 123$a = true;$a = false;$a = null; lowercase_keywords [@PSR2, @Symfony, @PhpCsFixer]PHP å…³é”®å­—å¿…é¡»å°å†™ 123$rules = [ 'lowercase_keywords' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123CLASS A &#123;&#125; æ ¼å¼åŒ–åï¼š 123class A &#123;&#125; lowercase_static_reference [@Symfony, @PhpCsFixer]é™æ€è°ƒç”¨å¿…é¡»å°å†™,ä¾‹å¦‚ï¼šself, static, parent 123$rules = [ 'lowercase_static_reference' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123456789class A&#123; public static $b; public function __construct() &#123; STATIC::$b; &#125;&#125; æ ¼å¼åŒ–åï¼š 123456789class A&#123; public static $b; public function __construct() &#123; static::$b; &#125;&#125; magic_constant_casing [@Symfony, @PhpCsFixer]Magic constants should be referred to using the correct casing. magic_method_casing [@Symfony, @PhpCsFixer]Magic method definitions and calls must be using the correct casing. mb_str_functionsReplace non multibyte-safe functions with corresponding mb function. Risky rule: risky when any of the functions are overridden. method_argument_space [@PSR2, @Symfony, @PhpCsFixer]åœ¨æ–¹æ³•å‚æ•°å’Œæ–¹æ³•è°ƒç”¨ä¸­ï¼Œæ¯ä¸ªé€—å·ä¹‹å‰ä¸èƒ½æœ‰ç©ºæ ¼ï¼Œæ¯ä¸ªé€—å·åå¿…é¡»æœ‰ä¸€ä¸ªç©ºæ ¼ã€‚å‚æ•°åˆ—è¡¨å¯ä»¥åˆ†ä¸ºå¤šè¡Œï¼Œæ¯è¡Œåç»­è¡Œç¼©è¿›ä¸€æ¬¡ã€‚è¿™æ ·åšæ—¶ï¼Œåˆ—è¡¨ä¸­çš„ç¬¬ä¸€é¡¹å¿…é¡»åœ¨ä¸‹ä¸€è¡Œï¼Œå¹¶ä¸”æ¯è¡Œå¿…é¡»åªæœ‰ä¸€ä¸ªå‚æ•°ã€‚ å¯é€‰é…ç½®é¡¹ after_heredoc (æ˜¯å¦åº”åˆ é™¤ heredoc end å’Œé€—å·ä¹‹é—´çš„ç©ºæ ¼) true false (é»˜è®¤) ensure_fully_multiline (ç¡®ä¿å¤šè¡Œå‚æ•°åˆ—è¡¨çš„æ¯ä¸ªå‚æ•°éƒ½åœ¨å…¶è‡ªå·±çš„è¡Œä¸Š,åºŸå¼ƒï¼Œon_multiline æ”¹ä¸ºä½¿ç”¨é€‰é¡¹) true false ï¼ˆé»˜è®¤ï¼‰ keep_multiple_spaces_after_comma ï¼ˆé€—å·åæ˜¯å¦ä¿ç•™å¤šä¸ªç©ºæ ¼ï¼‰ true falseï¼ˆé»˜è®¤ï¼‰ on_multiline ï¼ˆå®šä¹‰å¦‚ä½•å¤„ç†åŒ…å«æ¢è¡Œç¬¦å‡½æ•°çš„å‚æ•°åˆ—è¡¨ï¼‰ ensure_fully_multiline ensure_single_line ignore ï¼ˆé»˜è®¤ï¼‰ è¿™ä¸ªä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦ï¼Œæ¯”è¾ƒç¹çï¼Œä½†æ˜¯å®¹æ˜“ç†è§£ï¼Œè¿™é‡Œå°±ä¸å…·ä½“ä¸¾ä¾‹å­äº† method_chaining_indentation [@PhpCsFixer]Method chaining MUST be properly indented. Method chaining with different levels of indentation is not supported. modernize_types_casting [@Symfony:risky, @PhpCsFixer:risky]Replaces intval, floatval, doubleval, strval and boolval function calls with according type casting operator. multiline_comment_opening_closing [@PhpCsFixer]DocBlocks å¿…é¡»ä»¥ä¸¤ä¸ªæ˜Ÿå·å¼€å¤´ï¼Œå¤šè¡Œæ³¨é‡Šå¿…é¡»ä»¥å•ä¸ªæ˜Ÿå·å¼€å¤´ï¼Œåœ¨å¼€å¤´çš„æ–œçº¿åé¢ã€‚ä¸¤è€…å¿…é¡»åœ¨ç»“æŸæ–œæ ä¹‹å‰ä»¥å•ä¸ªæ˜Ÿå·ç»“å°¾ multiline_whitespace_before_semicolons [@PhpCsFixer]åœ¨ç»“æŸåˆ†å·ä¹‹å‰ç¦æ­¢å¤šè¡Œç©ºæ ¼æˆ–å°†åˆ†å·ç§»åŠ¨åˆ°é“¾æ¥è°ƒç”¨çš„æ–°è¡Œã€‚ 12345$rules = [ 'multiline_whitespace_before_semicolons' =&gt; [ 'strategy' =&gt; 'no_multi_line' ]]; åŸå§‹æ ¼å¼ï¼š 123$a = 1; æ ¼å¼åŒ–åï¼š 1$a = 1; native_constant_invocation [@Symfony:risky, @PhpCsFixer:risky]Add leading \\ before constant invocation of internal constant to speed up resolving. Constant name match is case-sensitive, except for null, false and true. Risky rule: risky when any of the constants are namespaced or overridden. Configuration options: exclude (array): list of constants to ignore; defaults to [â€˜nullâ€™, â€˜falseâ€™, â€˜trueâ€™]fix_built_in (bool): whether to fix constants returned by get_defined_constants. User constants are not accounted in this list and must be specified in the include one; defaults to trueinclude (array): list of additional constants to fix; defaults to []scope (â€˜allâ€™, â€˜namespacedâ€™): only fix constant invocations that are made within a namespace or fix all; defaults to â€˜allâ€™ native_function_casing [@Symfony, @PhpCsFixer]Function defined by PHP should be called using the correct casing. native_function_invocation [@Symfony:risky, @PhpCsFixer:risky]Add leading \\ before function invocation to speed up resolving. Risky rule: risky when any of the functions are overridden. Configuration options: exclude (array): list of functions to ignore; defaults to []include (array): list of function names or sets to fix. Defined sets are @internal (all native functions), @all (all global functions) and @compiler_optimized (functions that are specially optimized by Zend); defaults to [â€˜@internalâ€™]scope (â€˜allâ€™, â€˜namespacedâ€™): only fix function calls that are made within a namespace or fix all; defaults to â€˜allâ€™strict (bool): whether leading \\ of function call not meant to have it should be removed; defaults to false native_function_type_declaration_casing [@Symfony, @PhpCsFixer]Native type hints for functions should use the correct case. new_with_braces [@Symfony, @PhpCsFixer]ä½¿ç”¨ new å…³é”®å­—åˆ›å»ºçš„æ‰€æœ‰å®ä¾‹å¿…é¡»åè·Ÿæ‹¬å·ã€‚ 123$rules = [ 'new_with_braces' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 12345class A&#123;&#125;$a = new A; æ ¼å¼åŒ–åï¼š 12345class A&#123;&#125;$a = new A(); no_alias_functions [@Symfony:risky, @PhpCsFixer:risky]Master functions shall be used instead of aliases. Risky rule: risky when any of the alias functions are overridden. Configuration options: sets (a subset of [â€˜@internalâ€™, â€˜@IMAPâ€™, â€˜@mbregâ€™, â€˜@allâ€™]): list of sets to fix. Defined sets are @internal (native functions), @IMAP (IMAP functions), @mbreg (from ext-mbstring) @all (all listed sets); defaults to [â€˜@internalâ€™, â€˜@IMAPâ€™] no_alternative_syntax [@PhpCsFixer]ä¸€èˆ¬æ˜¯ç»“åˆåœ¨ html é¡µé¢å†™ php çš„æ—¶å€™æ‰ç”¨åˆ° (alternative_syntax)[https://www.php.net/manual/zh/control-structures.alternative-syntax.php] no_binary_string [@PhpCsFixer]There should not be a binary flag before strings. no_blank_lines_after_class_opening [@Symfony, @PhpCsFixer]class å¼€æ ‡ç­¾åé¢ä¸åº”è¯¥æœ‰ç©º 123$rules = [ 'no_blank_lines_after_class_opening' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 12345class A&#123; private $d;&#125; æ ¼å¼åŒ–åï¼š 1234class A&#123; private $d;&#125; no_blank_lines_after_phpdoc [@Symfony, @PhpCsFixer]phpdoc åé¢ä¸åº”è¯¥æœ‰ç©ºè¡Œ 123$rules = [ 'no_blank_lines_after_phpdoc' =&gt; true]; 123456789/** * A class */class A&#123; private $d;&#125; æ ¼å¼åŒ–åï¼š 12345678/** * A class */class A&#123; private $d;&#125; no_blank_lines_before_namespaceå‘½åç©ºé—´ä¹‹å‰ä¸åº”è¯¥æœ‰ç©ºè¡Œ 123$rules = [ 'no_blank_lines_before_namespace' =&gt; true]; 12345678&lt;?phpnamespace caiwenhuiclass A&#123; private $d;&#125; æ ¼å¼åŒ–åï¼š 1234567&lt;?phpnamespace caiwenhuiclass A&#123; private $d;&#125; no_break_comment [@PSR2, @Symfony, @PhpCsFixer]There must be a comment when fall-through is intentional in a non-empty case body. Configuration options: comment_text (string): the text to use in the added comment and to detect it; defaults to â€˜no breakâ€™ no_closing_tag [@PSR2, @Symfony, @PhpCsFixer]?&gt; å…³é—­æ ‡ç­¾å¿…é¡»åœ¨ PHP æ–‡ä»¶ä¸­å»æ‰ no_empty_comment [@Symfony, @PhpCsFixer]ä¸åº”è¯¥å­˜åœ¨ç©ºæ³¨é‡Š no_empty_phpdoc [@Symfony, @PhpCsFixer]ä¸åº”è¯¥å­˜åœ¨ç©ºçš„ phpdoc no_empty_statement [@Symfony, @PhpCsFixer]ä¸åº”è¯¥å­˜åœ¨ç©ºçš„ç»“æ„ä½“ no_extra_blank_lines [@Symfony, @PhpCsFixer]ç§»é™¤é¢å¤–çš„ç©ºè¡Œï¼Œåœ¨[â€˜breakâ€™, â€˜caseâ€™, â€˜continueâ€™, â€˜curly_brace_blockâ€™, â€˜defaultâ€™, â€˜extraâ€™, â€˜parenthesis_brace_blockâ€™, â€˜returnâ€™, â€˜square_brace_blockâ€™, â€˜switchâ€™, â€˜throwâ€™, â€˜useâ€™, â€˜useTraitâ€™, â€˜use_traitâ€™ä¸­ 1234567$rules = [ 'no_extra_blank_lines' =&gt; [ 'tokens' =&gt; [ 'return' ] ]]; å¯é€‰é…ç½®é¡¹ tokens ï¼ˆæ•°ç»„ï¼‰ break case continue curly_brace_block default extra ( é»˜è®¤) parenthesis_brace_block return square_brace_block switch throw use useTrait use_trait å¯é€‰é…ç½®é¡¹é»˜è®¤å€¼ï¼š[â€˜extraâ€™] åŸå§‹æ ¼å¼ï¼š 12345678910function a()&#123; echo 1; return 1;&#125; æ ¼å¼åŒ–åï¼š 123456function a()&#123; echo 1; return 1;&#125; no_homoglyph_names [@Symfony:risky, @PhpCsFixer:risky]Replace accidental usage of homoglyphs (non ascii characters) in names. Risky rule: renames classes and cannot rename the files. You might have string references to renamed code ($$name). no_leading_import_slash [@Symfony, @PhpCsFixer]åœ¨ use è¯­å¥ä¸­ï¼Œå–æ¶ˆå‰ç½®æ–œæ  123$rules = [ 'no_leading_import_slash' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1use \\A; æ ¼å¼åŒ–åï¼š 1use A; no_leading_namespace_whitespace [@Symfony, @PhpCsFixer]åœ¨å£°æ˜å‘½ä»¤ç©ºé—´çš„æ—¶å€™ï¼Œä¸å…è®¸æœ‰å‰ç½®ç©ºæ ¼ 123$rules = [ 'no_leading_namespace_whitespace' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1namespace A; æ ¼å¼åŒ–åï¼š 1namespace A; no_mixed_echo_print [@Symfony, @PhpCsFixer]ä¸å…è®¸æ··åˆä½¿ç”¨echoå’Œprintè¯­å¥ å¯é€‰é…ç½®é¡¹ use echo (é»˜è®¤) print 12345$rules = [ 'no_mixed_echo_print' =&gt; [ 'use' =&gt; 'echo' ]]; åŸå§‹æ ¼å¼ï¼š 12echo 1;print 1; æ ¼å¼åŒ–åï¼š 12echo 1;echo 1; no_multiline_whitespace_around_double_arrow [@Symfony, @PhpCsFixer]è¿ç®—ç¬¦ =&gt; ä¸åº”è¢«å¤šè¡Œç©ºæ ¼åŒ…å›´ã€‚ 123$rules = [ 'no_multiline_whitespace_around_double_arrow' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123456$a = [ 1 =&gt; '33',]; æ ¼å¼åŒ–åï¼š 123$a = [ 1 =&gt; '33',]; no_null_property_initialization [@PhpCsFixer]å±æ€§ä¸èƒ½ç”¨æ˜¾å¼åˆå§‹åŒ– null 123$rules = [ 'no_null_property_initialization' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1234class A&#123; private $dd = null;&#125; æ ¼å¼åŒ–åï¼š 1234class A&#123; private $dd;&#125; no_php4_constructorConvert PHP4-style constructors to __construct. Risky rule: risky when old style constructor being fixed is overridden or overrides parent one. no_short_bool_cast [@Symfony, @PhpCsFixer]Short cast bool using double exclamation mark should not be used. no_short_echo_tag [@PhpCsFixer]ç”¨ &lt;?php echo æ¥ä»£æ›¿ &lt;?= no_singleline_whitespace_before_semicolons [@Symfony, @PhpCsFixer]ç¦æ­¢åœ¨å…³é—­åˆ†å·å‰ä½¿ç”¨å•è¡Œç©ºæ ¼ã€‚ no_spaces_after_function_name [@PSR2ï¼Œ@Symfonyï¼Œ@PhpCsFixer]åœ¨å‡½æ•°æˆ–è€…æ–¹æ³•å®šä¹‰çš„æ—¶å€™ï¼Œä¸å…è®¸å‡½æ•°å’Œå·¦æ‹¬å·ä¹‹é—´æœ‰ç©ºæ ¼ 123$rules = [ 'no_spaces_after_function_name' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1234function a ()&#123;&#125; æ ¼å¼åŒ–åï¼š 1234function a()&#123;&#125; no_spaces_around_offset [@Symfony, @PhpCsFixer]There MUST NOT be spaces around offset braces. Configuration options: positions (a subset of [â€˜insideâ€™, â€˜outsideâ€™]): whether spacing should be fixed inside and/or outside the offset braces; defaults to [â€˜insideâ€™, â€˜outsideâ€™] no_spaces_inside_parenthesis [@PSR2, @Symfony, @PhpCsFixer]åœ¨å·¦æ‹¬å·åé¢ä¸èƒ½æœ‰ç©ºæ ¼ã€‚åœ¨å³æ‹¬å·ä¹‹å‰ä¸èƒ½æœ‰ç©ºæ ¼ã€‚ no_superfluous_elseif [@PhpCsFixer]Replaces superfluous elseif with if. no_superfluous_phpdoc_tagsåˆ é™¤æ²¡æœ‰æä¾›æœ‰æ•ˆä¿¡æ¯çš„@param å’Œ@return æ³¨è§£ \b å¯é€‰é…ç½®é¡¹ allow_mixed ï¼ˆæ˜¯å¦å…è®¸ mixed æ³¨è§£å­˜åœ¨ï¼‰ true false ï¼ˆé»˜è®¤ï¼‰ 12345$rules = [ 'no_superfluous_phpdoc_tags' =&gt; [ 'allow_mixed' =&gt; false ]]; åŸå§‹æ ¼å¼ï¼š 123456/** * @param $c */function a($b)&#123;&#125; æ ¼å¼åŒ–åï¼š 12345/** */function a($b)&#123;&#125; no_trailing_comma_in_list_call [@Symfonyï¼Œ@ PhpCsFixer]Remove trailing commas in list function calls. no_trailing_comma_in_singleline_array [@Symfony, @PhpCsFixer]PHP å•è¡Œæ•°ç»„ä¸åº”è¯¥æœ‰é€—å·ã€‚ 123$rules = [ 'no_trailing_comma_in_singleline_array' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1$array = [1,2,]; æ ¼å¼åŒ–åï¼š 1$array = [1,2]; no_trailing_whitespace [@PSR2ï¼Œ@Symfonyï¼Œ@PhpCsFixer]åˆ é™¤éç©ºè¡Œæœ«å°¾çš„å°¾éšç©ºæ ¼ã€‚ æ„æ€å¦‚æè¿° no_trailing_whitespace_in_comment [@PSR2ï¼Œ@Soundfonyï¼Œ@PhpCsFixer]æ³¨é‡Šæˆ– PHPDoc ä¸­å¿…é¡»æ²¡æœ‰å°¾éšç©ºæ ¼ã€‚ æ„æ€å¦‚æè¿° no_unneeded_control_parentheses [@Symfonyï¼Œ@PhpCsFixer]åˆ é™¤æ§åˆ¶è¯­å¥å‘¨å›´ä¸éœ€è¦çš„æ‹¬å·ã€‚ å¯é€‰é…ç½®é¡¹ statements ï¼ˆæ•°ç»„ï¼‰ break clone continue echo_print return switch_case yield å¯é€‰é…ç½®é¡¹é»˜è®¤å€¼ï¼š[â€˜breakâ€™, â€˜cloneâ€™, â€˜continueâ€™, â€˜echo_printâ€™, â€˜returnâ€™, â€˜switch_caseâ€™, â€˜yieldâ€™] 12345$rules = [ 'no_unneeded_curly_braces' =&gt; [ 'statements' =&gt; ['break', 'clone', 'continue', 'echo_print', 'return', 'switch_case', 'yield'] ]]; åŸå§‹æ ¼å¼ï¼š 1234function a()&#123; return(1);&#125; æ ¼å¼åŒ–åï¼š 1234function a()&#123; return 1;&#125; no_unneeded_curly_braces [@Symfonyï¼Œ@PhpCsFixer]åˆ é™¤ä¸éœ€è¦çš„èŠ±æ‹¬å·ï¼Œè¿™äº›èŠ±æ‹¬å·æ˜¯å¤šä½™çš„ï¼Œä¸å±äºæ§åˆ¶ç»“æ„çš„ä¸»ä½“ã€‚ 123$rules = [ 'no_unneeded_curly_braces' =&gt; true]; 1234&lt;?php&#123; echo 1;&#125; æ ¼å¼åŒ–åï¼š 123&lt;?php echo 1; no_unneeded_final_method [@Symfonyï¼Œ@PhpCsFixer]ç»ˆæ€ç±»ä¸€å®šä¸èƒ½æœ‰ç»ˆæ€æ–¹æ³• 123$rules = [ 'no_unneeded_final_method' =&gt; true]; 123456final class A&#123; final public function echoA() &#123; &#125;&#125; æ ¼å¼åŒ–åï¼š 123456final class A&#123; public function echoA() &#123; &#125;&#125; no_unreachable_default_argument_value [@PhpCsFixer:risky]In function arguments there must not be arguments with default values before non-default ones. Risky rule: modifies the signature of functions; therefore risky when using systems (such as some Symfony components) that rely on those (for example through reflection). no_unset_cast [@PhpCsFixer]å¿…é¡»è®¾ç½®å˜é‡ null è€Œä¸æ˜¯ä½¿ç”¨(unset)å¼ºåˆ¶è½¬æ¢ã€‚ 123$rules = [ 'no_unset_cast' =&gt; true]; 1$a = (unset)$b; æ ¼å¼åŒ–åï¼š 1$a = null; no_unset_on_property [@PhpCsFixer:risky]Properties should be set to null instead of using unset. Risky rule: changing variables to null instead of unsetting them will mean they still show up when looping over class variables. no_unused_imports [@Symfony, @PhpCsFixer]å¼•å…¥ use åä½†æ˜¯æ²¡æœ‰ç”¨åˆ°çš„ç±»è¦åˆ é™¤ å¦‚æè¿° no_useless_else [@PhpCsFixer]ä¸éœ€è¦æ²¡æœ‰ç”¨çš„ else åˆ†æ”¯ 123$rules = [ 'no_useless_else' =&gt; true]; 12345678function a($a, $b)&#123; if ($a) &#123; return $a; &#125; else &#123; return $b; &#125;&#125; æ ¼å¼åŒ–åï¼š 12345678function a($a, $b)&#123; if ($a) &#123; return $a; &#125; return $b;&#125; no_whitespace_before_comma_in_array [@Symfonyï¼Œ@PhpCsFixer]åœ¨æ•°ç»„å£°æ˜ä¸­ï¼Œæ¯ä¸ªé€—å·å‰ä¸å¾—æœ‰ç©ºæ ¼ã€‚ å¯é€‰é…ç½®é¡¹ after_heredoc ï¼ˆæ˜¯å¦åº”åˆ é™¤ heredoc end å’Œé€—å·ä¹‹é—´çš„ç©ºæ ¼ï¼‰ true false ï¼ˆé»˜è®¤ï¼‰ 123$rules = [ 'no_whitespace_before_comma_in_array' =&gt; true]; 1$a = [1 , 2 , 3]; æ ¼å¼åŒ–åï¼š 1$a = [1, 2, 3]; no_whitespace_in_blank_line [@Symfonyï¼Œ@PhpCsFixer]åˆ é™¤ç©ºè¡Œä¸­çš„ç©ºæ ¼ å¦‚æè¿° non_printable_character [@Symfony:risky, @PhpCsFixer:risky, @PHP70Migration:risky, @PHP71Migration:risky]Remove Zero-width space (ZWSP), Non-breaking space (NBSP) and other invisible unicode symbols. Risky rule: risky when strings contain intended invisible characters. Configuration options: use_escape_sequences_in_strings (bool): whether characters should be replaced with escape sequences in strings; defaults to false normalize_index_brace [@Symfony, @PhpCsFixer]Array index should always be written by using square braces. not_operator_with_spaceé€»è¾‘ NOT è¿ç®—ç¬¦ï¼ˆ!ï¼‰åº”è¯¥å…·æœ‰å‰å¯¼å’Œå°¾éšç©ºæ ¼ã€‚ å¦‚æè¿° not_operator_with_successor_spaceé€»è¾‘ NOT è¿ç®—ç¬¦ï¼ˆ!ï¼‰åº”è¯¥æœ‰ä¸€ä¸ªå°¾éšç©ºæ ¼ã€‚ å¦‚æè¿° phpdoc_align [@Symfonyï¼Œ@PhpCsFixer]ç»™å®š phpdoc æ ‡ç­¾çš„æ‰€æœ‰é¡¹ç›®å¿…é¡»å·¦å¯¹é½æˆ–ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰å‚ç›´å¯¹é½ã€‚ é…ç½®é€‰é¡¹ï¼š alignï¼ˆâ€™leftâ€™ï¼Œâ€™verticalâ€™ï¼‰ï¼šå¯¹é½è¯„è®º; é»˜è®¤ä¸ºâ€™verticalâ€™tagsï¼ˆå­é›†[â€˜paramâ€™, â€˜propertyâ€™, â€˜returnâ€™, â€˜throwsâ€™, â€˜typeâ€™, â€˜varâ€™, â€˜methodâ€™]ï¼‰ï¼šåº”è¯¥å¯¹é½çš„æ ‡ç­¾; é»˜è®¤ä¸º [â€˜paramâ€™, â€˜returnâ€™, â€˜throwsâ€™, â€˜typeâ€™, â€˜varâ€™ phpdoc_annotation_without_dot [@Symfonyï¼Œ@PhpCsFixer]PHPDoc æ³¨é‡Šæè¿°ä¸åº”è¯¥æ˜¯ä¸€ä¸ªå¥å­ã€‚ phpdoc_indent [@Symfonyï¼Œ@PhpCsFixer]Docblock åº”ä¸æ–‡æ¡£ä¸»é¢˜å…·æœ‰ç›¸åŒçš„ç¼©è¿›ã€‚ phpdoc_inline_tag [@Symfonyï¼Œ@PhpCsFixer]ä¿®å¤ PHPDoc å†…è”æ ‡è®°ï¼Œä½¿@inheritdoc å†…è”å§‹ç»ˆã€‚ phpdoc_no_empty_return [@Symfonyï¼Œ@ PhpCsFixer]@return void å’Œ@return null æ³¨é‡Šåº”è¯¥ PHPDoc çš„è¢«çœç•¥ã€‚ phpdoc_no_package [@Symfonyï¼Œ@ PhpCsFixer]@package å’Œ@subpackage æ³¨é‡Šåº”è¯¥ PHPDoc çš„è¢«çœç•¥ã€‚ phpdoc_order [@PhpCsFixer]åº”è¯¥å¯¹ PHPDoc ä¸­çš„@param æ³¨é‡Šè¿›è¡Œæ’åºï¼Œä»¥ä¾¿é¦–å…ˆ@throws æ³¨é‡Šï¼Œç„¶åæ˜¯@return æ³¨é‡Šï¼Œç„¶åæ˜¯æ³¨é‡Šã€‚ phpdoc_return_self_reference [@Symfonyï¼Œ@ PhpCsFixer]@return è¿”å›å¯¹è‡ªèº«çš„å¼•ç”¨çš„æ–¹æ³•çš„æ³¨é‡Šç±»å‹å¿…é¡»æ˜¯å·²é…ç½®çš„æ³¨é‡Šã€‚ é…ç½®é€‰é¡¹ï¼š replacementsï¼ˆarrayï¼‰ï¼šæ›¿æ¢çš„è¿”å›ç±»å‹ä¸æ–°çš„è¿”å›ç±»å‹ä¹‹é—´çš„æ˜ å°„; é»˜è®¤ä¸º[â€˜thisâ€™ =&gt; â€˜$thisâ€™, â€˜@thisâ€™ =&gt; â€˜$thisâ€™, â€˜$selfâ€™ =&gt; â€˜selfâ€™, â€˜@selfâ€™ =&gt; â€˜selfâ€™, â€˜$staticâ€™ =&gt; â€˜staticâ€™, â€˜@staticâ€™ =&gt; â€˜staticâ€™] phpdoc_scalar [@Symfonyï¼Œ@PhpCsFixer]æ ‡é‡ç±»å‹åº”å§‹ç»ˆä»¥ç›¸åŒçš„å½¢å¼ç¼–å†™ã€‚int ä¸ integerï¼Œbool ä¸ booleanï¼Œfloat ä¸æ˜¯ real æˆ– doubleã€‚ é…ç½®é€‰é¡¹ï¼š typesï¼ˆå­é›†[â€˜booleanâ€™, â€˜callbackâ€™, â€˜doubleâ€™, â€˜integerâ€™, â€˜realâ€™, â€˜strâ€™]ï¼‰ï¼šè¦ä¿®å¤çš„ç±»å‹çš„æ˜ å°„; é»˜è®¤ä¸º[â€˜booleanâ€™, â€˜doubleâ€™, â€˜integerâ€™, â€˜realâ€™, â€˜strâ€™] phpdoc_separation [@Symfonyï¼Œ@ PhpCsFixer]PHPDoc ä¸­çš„æ³¨é‡Šåº”è¯¥ç»„åˆåœ¨ä¸€èµ·ï¼Œä»¥ä¾¿ç›¸åŒç±»å‹çš„æ³¨é‡Šç´§è·Ÿåœ¨ä¸€èµ·ï¼Œå¹¶ä¸”ä¸åŒç±»å‹çš„æ³¨é‡Šç”±å•ä¸ªç©ºè¡Œåˆ†éš”ã€‚ phpdoc_single_line_var_spacing [@Symfonyï¼Œ@ PhpCsFixer]å•è¡Œ@varPHPDoc åº”è¯¥æœ‰é€‚å½“çš„é—´è·ã€‚ phpdoc_summary [@Symfonyï¼Œ@ PhpCsFixer]PHPDoc æ‘˜è¦åº”ä»¥å¥å·ï¼Œæ„Ÿå¹å·æˆ–é—®å·ç»“å°¾ã€‚ phpdoc_to_comment [@Symfonyï¼Œ@ PhpCsFixer]Docblock åªåº”ç”¨äºç»“æ„å…ƒç´ ã€‚ phpdoc_trim [@Symfonyï¼Œ@ PhpCsFixer]PHPDoc åº”è¯¥ä»¥å†…å®¹å¼€å¤´å’Œç»“å°¾ï¼Œä¸åŒ…æ‹¬ docblock çš„ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œã€‚ phpdoc_trim_consecutive_blank_line_separation [@PhpCsFixer]åœ¨æ‘˜è¦ä¹‹åå’Œ PHPDoc ä¸­çš„æè¿°ä¹‹ååˆ é™¤é¢å¤–çš„ç©ºç™½è¡Œã€‚ phpdoc_var_annotation_correct_order [@PhpCsFixer]@var å’Œ@type æ³¨é‡Šå¿…é¡»å…·æœ‰æ­£ç¡®é¡ºåºçš„ç±»å‹å’Œåç§°ã€‚ phpdoc_var_without_name [@Symfonyï¼Œ@ PhpCsFixer]@var å’Œ@type æ³¨é‡Šä¸åº”åŒ…å«å˜é‡åç§°ã€‚ protected_to_private [@Symfonyï¼Œ@ PhpCsFixer]å°½å¯èƒ½å°† protected å˜é‡å’Œæ–¹æ³•è½¬æ¢ privateã€‚ single_blank_line_at_eof [@ PSR2ï¼Œ@ Soundfonyï¼Œ@ PhpCsFixer]æ²¡æœ‰ç»“æŸæ ‡è®°çš„ PHP æ–‡ä»¶å¿…é¡»å§‹ç»ˆä»¥å•ä¸ªç©ºè¡Œæ¢å¤´ç»“æŸã€‚ single_import_per_statement [@ PSR2ï¼Œ@ Symfonyï¼Œ@ PhpCsFixer]æ¯ä¸ªå£°æ˜å¿…é¡»æœ‰ä¸€ä¸ª use å…³é”®å­—ã€‚(é’ˆå¯¹ PHP7 å¯ä»¥å¤šä¸ª use) single_line_after_imports [@ PSR2ï¼Œ@ Symfonyï¼Œ@ PhpCsFixer]æ¯ä¸ªå‘½åç©ºé—´ä½¿ç”¨å¿…é¡»åœ¨å®ƒè‡ªå·±çš„è¡Œä¸Šï¼Œå¹¶ä¸”åœ¨ use è¯­å¥å—ä¹‹åå¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œã€‚ single_line_comment_style [@Symfonyï¼Œ@PhpCsFixer]åªæœ‰ä¸€è¡Œå®é™…å†…å®¹çš„å•è¡Œæ³¨é‡Šå’Œå¤šè¡Œæ³¨é‡Šåº”ä½¿ç”¨//è¯­æ³•ã€‚ é…ç½®é€‰é¡¹ï¼š comment_typesï¼ˆå­é›†[â€˜asteriskâ€™, â€˜hashâ€™]ï¼‰ï¼šè¦ä¿®å¤çš„æ³¨é‡Šç±»å‹åˆ—è¡¨; é»˜è®¤ä¸º[â€˜asteriskâ€™, â€˜hashâ€™] space_after_semicolon [@Symfonyï¼Œ@PhpCsFixer]åˆ†å·åä¿®å¤ç©ºæ ¼ å¯é€‰é…ç½®é¡¹ remove_in_empty_for_expressions ï¼ˆæ˜¯å¦åº”åˆ é™¤ç©º for è¡¨è¾¾å¼çš„ç©ºæ ¼ï¼‰ true false (é»˜è®¤) 12345$rules = [ 'space_after_semicolon' =&gt; [ 'remove_in_empty_for_expressions' =&gt; true ]]; åŸå§‹æ ¼å¼ï¼š 123for ($i = 0; $i &lt; 10; $i++) &#123; echo $i;&#125; æ ¼å¼åŒ–åï¼š 123for ($i = 0; $i &lt; 10; $i++) &#123; echo $i;&#125; standardize_increment [@Symfonyï¼Œ@PhpCsFixer]å¦‚æœå¯èƒ½ï¼Œåº”ä½¿ç”¨é€’å¢å’Œé€’å‡è¿ç®—ç¬¦ã€‚ 123$rules = [ 'standardize_increment' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123$a = 0;$a += 1;$a -= 1; æ ¼å¼åŒ–åï¼š 123$a = 0;++$a;--$a; switch_case_semicolon_to_colon [@PSR2ï¼Œ@Symfonyï¼Œ@PhpCsFixer]case ä¹‹ååº”è¯¥æ˜¯å†’å·è€Œä¸æ˜¯åˆ†å·ã€‚ 123$rules = [ 'switch_case_semicolon_to_colon' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123456789$type = 1;switch ($type) &#123; case 1; echo 2; break; default; echo 1;&#125; æ ¼å¼åŒ–åï¼š 123456789$type = 1;switch ($type) &#123; case 1: echo 2; break; default: echo 1;&#125; switch_case_space [@PSR2ï¼Œ@Symfonyï¼Œ@PhpCsFixer]åˆ é™¤ case å†’å·å’Œå¤§å°å†™å€¼ä¹‹é—´çš„é¢å¤–ç©ºæ ¼ã€‚ 123$rules = [ 'switch_case_space' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 123456789$type = 1;switch ($type) &#123; case 1 : echo 2; break; default : echo 1;&#125; æ ¼å¼åŒ–åï¼š 123456789$type = 1;switch ($type) &#123; case 1: echo 2; break; default: echo 1;&#125; ternary_operator_spaces [@Symfony, @PhpCsFixer]ä¸‰å…ƒæ“ä½œç¬¦å‘¨å›´æœ‰æ ‡å‡†ç©ºæ ¼ 123$rules = [ 'ternary_operator_spaces' =&gt; true]; åŸå§‹æ ¼å¼ï¼š 1$a = empty($e)?true:false; æ ¼å¼åŒ–åï¼š 1$a = empty($e) ? true : false; ternary_to_null_coalescing [@PHP70Migration, @PHP71Migration, @PHP73Migration]Use null coalescing operator ?? where possible. Requires PHP &gt;= 7.0. trailing_comma_in_multiline_array [@Symfonyï¼Œ@PhpCsFixer]PHP å¤šè¡Œæ•°ç»„åº”è¯¥æœ‰ä¸€ä¸ªå°¾éšé€—å·ã€‚ é…ç½®é€‰é¡¹ï¼š after_heredocï¼ˆboolï¼‰ï¼šæ˜¯å¦ä¹Ÿåº”è¯¥åœ¨ heredoc ç»“æŸåæ”¾ç½®ä¸€ä¸ªå°¾éšé€—å·; é»˜è®¤ä¸º false trim_array_spaces [@Symfonyï¼Œ@ PhpCsFixer]æ•°ç»„åº”è¯¥åƒå‡½æ•°/æ–¹æ³•å‚æ•°ä¸€æ ·æ ¼å¼åŒ–ï¼Œä¸å¸¦å‰å¯¼æˆ–å°¾éšå•è¡Œç©ºæ ¼ã€‚ unary_operator_spaces [@Symfonyï¼Œ@ PhpCsFixer]ä¸€å…ƒè¿ç®—ç¬¦åº”æ”¾åœ¨å…¶æ“ä½œæ•°æ—è¾¹ã€‚ whitespace_after_comma_in_array [@Symfonyï¼Œ@ PhpCsFixer]åœ¨æ•°ç»„å£°æ˜ä¸­ï¼Œæ¯ä¸ªé€—å·åå¿…é¡»æœ‰ä¸€ä¸ªç©ºæ ¼ã€‚ æ€»ç»“ä»¥ä¸Šå‡ä¸º php-cs-fixer çš„é…ç½®è¯¦ï¼Œæœ‰ä¸€äº›é£é™©çš„é…ç½®ï¼Œæˆ‘ä»¬ä¸æå€¡ä½¿ç”¨ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç¿»è¯‘ï¼Œè€Œä¸”ä¸€äº›æ²¡æœ‰ç»™å‡ºä¾‹å­ã€‚æƒ…å†µæœ‰ 2 ç§ï¼Œä¸€ç§æ˜¯ï¼šæš‚æ—¶ä¸äº†è§£å…·ä½“ç”¨æ³•ã€‚ä¸€ç§æ˜¯å­—é¢æ„æ€å¯æ‡‚ã€‚ æ¯ä¸ªé…ç½®é¡¹åé¢çš„ä¸­æ‹¬å·ä¸­çš„@xxxçš„å†™æ³•ä»£è¡¨è¿™ä¸ªé…ç½®åœ¨ä»€ä¹ˆ tag ä¸­ç”Ÿæ•ˆï¼Œå…·ä½“ç›¸å…³çš„å¯ä»¥æŸ¥çœ‹ php-cs-fixer çš„å®˜ç½‘æ–‡æ¡£ã€‚","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"}]},{"title":"k8s ã® åŸºç¡€çŸ¥è¯†","slug":"k8sçŸ¥è¯†ç‚¹ä¸€","date":"2019-05-16T06:24:00.000Z","updated":"2021-03-20T16:25:01.807Z","comments":true,"path":"2019/05/16/k8sçŸ¥è¯†ç‚¹ä¸€/","link":"","permalink":"http://blog.crazylaw.cn/2019/05/16/k8s%E7%9F%A5%E8%AF%86%E7%82%B9%E4%B8%80/","excerpt":"k8s çŸ¥è¯†ç‚¹ä¸€k8s æ€»æ¶æ„ç”±äº 2 ä¸ªæ¦‚å¿µæ„æˆ Master Node Master å’Œ Node éƒ½æ˜¯æœåŠ¡å™¨ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœº, éƒ½å¯ä»¥ç”±äºä¸€å°æˆ–è€…å¤šå°ç»„æˆï¼Œå¦‚æœ Master ä¸è€ƒè™‘HA(é«˜å¯ç”¨)çš„æƒ…å†µä¸‹ã€‚ä¸€èˆ¬éƒ½æ˜¯ 1 å° Master + N å° Nodeã€‚ Master ä¸Šæ‰€éœ€è¦çš„æœåŠ¡ etcd Api Server Controller Manager Scheduler åä¸‰ä¸ªç»„ä»¶æ„æˆäº† Kubernetes çš„æ€»æ§ä¸­å¿ƒï¼Œè¿™äº›è¿›ç¨‹å®ç°äº†æ•´ä¸ªé›†ç¾¤çš„èµ„æºç®¡ç†ã€Pod è°ƒåº¦ã€å¼¹æ€§ä¼¸ç¼©ã€å®‰å…¨æ§åˆ¶ã€ç³»ç»Ÿç›‘æ§å’Œçº é”™ç­‰ç®¡ç†åŠŸèƒ½ï¼Œå¹¶ä¸”å…¨éƒ½æ˜¯è‡ªåŠ¨å®Œæˆã€‚ Node ä¸Šæ‰€éœ€è¦çš„æœåŠ¡ kubelet proxy","text":"k8s çŸ¥è¯†ç‚¹ä¸€k8s æ€»æ¶æ„ç”±äº 2 ä¸ªæ¦‚å¿µæ„æˆ Master Node Master å’Œ Node éƒ½æ˜¯æœåŠ¡å™¨ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœº, éƒ½å¯ä»¥ç”±äºä¸€å°æˆ–è€…å¤šå°ç»„æˆï¼Œå¦‚æœ Master ä¸è€ƒè™‘HA(é«˜å¯ç”¨)çš„æƒ…å†µä¸‹ã€‚ä¸€èˆ¬éƒ½æ˜¯ 1 å° Master + N å° Nodeã€‚ Master ä¸Šæ‰€éœ€è¦çš„æœåŠ¡ etcd Api Server Controller Manager Scheduler åä¸‰ä¸ªç»„ä»¶æ„æˆäº† Kubernetes çš„æ€»æ§ä¸­å¿ƒï¼Œè¿™äº›è¿›ç¨‹å®ç°äº†æ•´ä¸ªé›†ç¾¤çš„èµ„æºç®¡ç†ã€Pod è°ƒåº¦ã€å¼¹æ€§ä¼¸ç¼©ã€å®‰å…¨æ§åˆ¶ã€ç³»ç»Ÿç›‘æ§å’Œçº é”™ç­‰ç®¡ç†åŠŸèƒ½ï¼Œå¹¶ä¸”å…¨éƒ½æ˜¯è‡ªåŠ¨å®Œæˆã€‚ Node ä¸Šæ‰€éœ€è¦çš„æœåŠ¡ kubelet proxy è´Ÿè´£å¯¹æœ¬èŠ‚ç‚¹ä¸Šçš„ Pod çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ï¼Œä»¥åŠå®ç°æœåŠ¡ä»£ç†çš„åŠŸèƒ½ æµç¨‹é€šè¿‡ Kubectl æäº¤ä¸€ä¸ªåˆ›å»º RC çš„è¯·æ±‚ï¼Œè¯¥è¯·æ±‚é€šè¿‡ API Server è¢«å†™å…¥ etcd ä¸­ï¼Œæ­¤æ—¶ Controller Manager é€šè¿‡ API Server çš„ç›‘å¬èµ„æºå˜åŒ–çš„æ¥å£ç›‘å¬åˆ°è¿™ä¸ª RC äº‹ä»¶ï¼Œåˆ†æä¹‹åï¼Œå‘ç°å½“å‰é›†ç¾¤ä¸­è¿˜æ²¡æœ‰å®ƒæ‰€å¯¹åº”çš„ Pod å®ä¾‹ï¼Œäºæ˜¯æ ¹æ® RC é‡Œçš„ Pod æ¨¡æ¿å®šä¹‰ç”Ÿæˆä¸€ä¸ª Pod å¯¹è±¡ï¼Œé€šè¿‡ API Server å†™å…¥ etcdï¼Œæ¥ä¸‹æ¥ï¼Œæ­¤äº‹ä»¶è¢« Scheduler å‘ç°ï¼Œå®ƒç«‹å³æ‰§è¡Œä¸€ä¸ªå¤æ‚çš„è°ƒåº¦æµç¨‹ï¼Œä¸ºè¿™ä¸ªæ–° Pod é€‰å®šä¸€ä¸ªè½æˆ·çš„ Nodeï¼Œç„¶åé€šè¿‡ API Server è®²è¿™ä¸€ç»“æœå†™å…¥åˆ° etcd ä¸­ï¼Œéšåï¼Œç›®æ ‡ Node ä¸Šè¿è¡Œçš„ Kubelet è¿›ç¨‹é€šè¿‡ API Server ç›‘æµ‹åˆ°è¿™ä¸ªâ€œæ–°ç”Ÿçš„â€Podï¼Œå¹¶æŒ‰ç…§å®ƒçš„å®šä¹‰ï¼Œå¯åŠ¨è¯¥ Pod å¹¶ä»»åŠ³ä»»æ€¨åœ°è´Ÿè´£å®ƒçš„ä¸‹åŠç”Ÿï¼Œç›´åˆ° Pod çš„ç”Ÿå‘½ç»“æŸã€‚ éšåï¼Œæˆ‘ä»¬é€šè¿‡ Kubectl æäº¤ä¸€ä¸ªæ–°çš„æ˜ å°„åˆ°è¯¥ Pod çš„ Service çš„åˆ›å»ºè¯·æ±‚ï¼ŒController Manager ä¼šé€šè¿‡ Label æ ‡ç­¾æŸ¥è¯¢åˆ°ç›¸å…³è”çš„ Pod å®ä¾‹ï¼Œç„¶åç”Ÿæˆ Service çš„ Endpoints ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ API Server å†™å…¥åˆ° etcd ä¸­ï¼Œæ¥ä¸‹æ¥ï¼Œæ‰€æœ‰ Node ä¸Šè¿è¡Œçš„ Proxy è¿›ç¨‹é€šè¿‡ API Server æŸ¥è¯¢å¹¶ç›‘å¬ Service å¯¹è±¡ä¸å…¶å¯¹åº”çš„ Endpoints ä¿¡æ¯ï¼Œå»ºç«‹ä¸€ä¸ªè½¯ä»¶æ–¹å¼çš„è´Ÿè½½å‡è¡¡å™¨æ¥å®ç° Service è®¿é—®åˆ°åç«¯ Pod çš„æµé‡è½¬å‘åŠŸèƒ½ã€‚ etcdç”¨äºæŒä¹…åŒ–å­˜å‚¨é›†ç¾¤ä¸­æ‰€æœ‰çš„èµ„æºå¯¹è±¡ï¼Œå¦‚ Nodeã€Serviceã€Podã€RCã€Namespace ç­‰ï¼›API Server æä¾›äº†æ“ä½œ etcd çš„å°è£…æ¥å£ APIï¼Œè¿™äº› API åŸºæœ¬ä¸Šéƒ½æ˜¯é›†ç¾¤ä¸­èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥åŠç›‘å¬èµ„æºå˜åŒ–çš„æ¥å£ã€‚ API Serveræä¾›äº†èµ„æºå¯¹è±¡çš„å”¯ä¸€æ“ä½œå…¥å£ï¼Œå…¶ä»–æ‰€æœ‰ç»„ä»¶éƒ½å¿…é¡»é€šè¿‡å®ƒæä¾›çš„ API æ¥æ“ä½œèµ„æºæ•°æ®ï¼Œé€šè¿‡å¯¹ç›¸å…³çš„èµ„æºæ•°æ®â€œå…¨é‡æŸ¥è¯¢â€+â€œå˜åŒ–ç›‘å¬â€ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥å¾ˆâ€œå®æ—¶â€åœ°å®Œæˆç›¸å…³çš„ä¸šåŠ¡åŠŸèƒ½ã€‚ Controller Manageré›†ç¾¤å†…éƒ¨çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯å®ç° Kubernetes é›†ç¾¤çš„æ•…éšœæ£€æµ‹å’Œæ¢å¤çš„è‡ªåŠ¨åŒ–å·¥ä½œï¼Œæ¯”å¦‚æ ¹æ® RC çš„å®šä¹‰å®Œæˆ Pod çš„å¤åˆ¶æˆ–ç§»é™¤ï¼Œä»¥ç¡®ä¿ Pod å®ä¾‹æ•°ç¬¦åˆ RC å‰¯æœ¬çš„å®šä¹‰ï¼›æ ¹æ® Service ä¸ Pod çš„ç®¡ç†å…³ç³»ï¼Œå®ŒæˆæœåŠ¡çš„ Endpoints å¯¹è±¡çš„åˆ›å»ºå’Œæ›´æ–°ï¼›å…¶ä»–è¯¸å¦‚ Node çš„å‘ç°ã€ç®¡ç†å’ŒçŠ¶æ€ç›‘æ§ã€æ­»äº¡å®¹å™¨æ‰€å ç£ç›˜ç©ºé—´åŠæœ¬åœ°ç¼“å­˜çš„é•œåƒæ–‡ä»¶çš„æ¸…ç†ç­‰å·¥ä½œä¹Ÿæ˜¯ç”± Controller Manager å®Œæˆçš„ã€‚ Scheduleré›†ç¾¤ä¸­çš„è°ƒåº¦å™¨ï¼Œè´Ÿè´£ Pod åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­çš„è°ƒåº¦åˆ†é…ã€‚ Kubeletè´Ÿè´£æœ¬ Node èŠ‚ç‚¹ä¸Šçš„ Pod çš„åˆ›å»ºã€ä¿®æ”¹ã€ç›‘æ§ã€åˆ é™¤ç­‰å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒæ—¶ Kubelet å®šæ—¶â€œä¸ŠæŠ¥â€æœ¬ Node çš„çŠ¶æ€ä¿¡æ¯åˆ° API Server é‡Œã€‚ Proxyå®ç°äº† Service çš„ä»£ç†ä¸è½¯ä»¶æ¨¡å¼çš„è´Ÿè½½å‡è¡¡å™¨ã€‚ å®¢æˆ·ç«¯é€šè¿‡ Kubectl å‘½ä»¤è¡Œå·¥å…·æˆ– Kubectl Proxy æ¥è®¿é—® Kubernetes ç³»ç»Ÿï¼Œåœ¨ Kubernetes é›†ç¾¤å†…éƒ¨çš„å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥ä½¿ç”¨ Kuberctl å‘½ä»¤ç®¡ç†é›†ç¾¤ã€‚Kubectl Proxy æ˜¯ API Server çš„ä¸€ä¸ªåå‘ä»£ç†ï¼Œåœ¨ Kubernetes é›†ç¾¤å¤–éƒ¨çš„å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ Kubernetes Proxy æ¥è®¿é—® API Serverã€‚","categories":[{"name":"k8s","slug":"k8s","permalink":"http://blog.crazylaw.cn/categories/k8s/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://blog.crazylaw.cn/tags/k8s/"}]},{"title":"rust-for-docker","slug":"rust-for-docker","date":"2019-04-02T12:49:59.000Z","updated":"2021-03-20T16:25:01.814Z","comments":true,"path":"2019/04/02/rust-for-docker/","link":"","permalink":"http://blog.crazylaw.cn/2019/04/02/rust-for-docker/","excerpt":"è¯´æ˜ä»Šå¤©ï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹ ä¸€ä¸‹ Rustï¼Œå¸Œæœ›å°†æ¥åœ¨å…¬å¸å¯ä»¥æ¨å¹¿ Rust è¯­è¨€ï¼Œå¹¶ä¸”ç”¨ Rust è¯­è¨€åšæ›´å¤šçš„äº‹æƒ…ã€‚ åœ¨æ­¤ï¼Œ\b è¿›å…¥æˆ‘ä»¬çš„å…¥å­¦ç¯‡ã€‚ Rust for Dockeræ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„ Rust 1docker pull rust:latest ç”±äºå®˜æ–¹ä¸Šçš„å‘½ä»¤æœ‰ç‚¹é—®é¢˜ï¼Œå¹¶ä¸”æˆ‘å¸Œæœ›æˆ‘æœ‰ä¸€ä¸ªäº¤äº’çš„ç»ˆç«¯ç¯å¢ƒï¼Œæ‰€ä»¥ï¼Œç»è¿‡ä¿®æ”¹åï¼Œè¿›å…¥ Rust å®¹å™¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š 1docker run -it --rm -e &quot;USER&#x3D;$(whoami)&quot; -e &quot;RUST_BACKTRACE&#x3D;1&quot; -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp -w &#x2F;usr&#x2F;src&#x2F;myapp rust:latest bash USER: cargo æ‰“åŒ…çš„æ—¶å€™ä¼šç”¨è¿™ä¸ªå‘½å RUST_BACKTRACEï¼šç»ˆç«¯è°ƒè¯•çš„æ—¶å€™ï¼Œä¼šæ‰“å°å‡ºé”™è¯¯æ ˆ è¿›å…¥åˆ°å®¹å™¨åï¼Œæˆ‘ä»¬åˆ›å»ºå±äºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼šHelloï¼ŒWorld åˆ©ç”¨ Rust çš„åŒ…ç®¡ç†å·¥å…·ï¼šCargo è¿›è¡Œå¼€å‘å’Œç¼–è¯‘ 123cargo new hello_world&#x2F;&#x2F; car new --lib &lt;package_name&gt; è¿™ä¸ªæ˜¯åˆ›å»ºç±»åº“çš„å‘½ä»¤ï¼Œæš‚æ—¶ç”¨ä¸åˆ°ï¼Œæ‰€ä»¥å¿½ç•¥å…ˆ","text":"è¯´æ˜ä»Šå¤©ï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹ ä¸€ä¸‹ Rustï¼Œå¸Œæœ›å°†æ¥åœ¨å…¬å¸å¯ä»¥æ¨å¹¿ Rust è¯­è¨€ï¼Œå¹¶ä¸”ç”¨ Rust è¯­è¨€åšæ›´å¤šçš„äº‹æƒ…ã€‚ åœ¨æ­¤ï¼Œ\b è¿›å…¥æˆ‘ä»¬çš„å…¥å­¦ç¯‡ã€‚ Rust for Dockeræ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„ Rust 1docker pull rust:latest ç”±äºå®˜æ–¹ä¸Šçš„å‘½ä»¤æœ‰ç‚¹é—®é¢˜ï¼Œå¹¶ä¸”æˆ‘å¸Œæœ›æˆ‘æœ‰ä¸€ä¸ªäº¤äº’çš„ç»ˆç«¯ç¯å¢ƒï¼Œæ‰€ä»¥ï¼Œç»è¿‡ä¿®æ”¹åï¼Œè¿›å…¥ Rust å®¹å™¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š 1docker run -it --rm -e &quot;USER&#x3D;$(whoami)&quot; -e &quot;RUST_BACKTRACE&#x3D;1&quot; -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp -w &#x2F;usr&#x2F;src&#x2F;myapp rust:latest bash USER: cargo æ‰“åŒ…çš„æ—¶å€™ä¼šç”¨è¿™ä¸ªå‘½å RUST_BACKTRACEï¼šç»ˆç«¯è°ƒè¯•çš„æ—¶å€™ï¼Œä¼šæ‰“å°å‡ºé”™è¯¯æ ˆ è¿›å…¥åˆ°å®¹å™¨åï¼Œæˆ‘ä»¬åˆ›å»ºå±äºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼šHelloï¼ŒWorld åˆ©ç”¨ Rust çš„åŒ…ç®¡ç†å·¥å…·ï¼šCargo è¿›è¡Œå¼€å‘å’Œç¼–è¯‘ 123cargo new hello_world&#x2F;&#x2F; car new --lib &lt;package_name&gt; è¿™ä¸ªæ˜¯åˆ›å»ºç±»åº“çš„å‘½ä»¤ï¼Œæš‚æ—¶ç”¨ä¸åˆ°ï¼Œæ‰€ä»¥å¿½ç•¥å…ˆ ç„¶ååˆ›å»ºå¥½äº†ä¹‹åã€‚å¯ä»¥çœ‹åˆ° ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š srcï¼šéœ€è¦å¼€å‘çš„æºç ç›®å½• target: åˆ©ç”¨ cargo build è¿è¡Œä¹‹åçš„ç»“æœ tree ç»“æ„å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728.â”œâ”€â”€ Cargo.lockâ”œâ”€â”€ Cargo.tomlâ”œâ”€â”€ srcâ”‚ â””â”€â”€ main.rsâ””â”€â”€ target â””â”€â”€ debug â”œâ”€â”€ build â”œâ”€â”€ deps â”‚ â”œâ”€â”€ hello_world-fe752e96abed129f â”‚ â””â”€â”€ hello_world-fe752e96abed129f.d â”œâ”€â”€ examples â”œâ”€â”€ hello_world â”œâ”€â”€ hello_world.d â”œâ”€â”€ incremental â”‚ â””â”€â”€ hello_world-a3apxnpw89q3 â”‚ â”œâ”€â”€ s-fax5vd6s7z-mo2l8f-2iq1v3vohkxfu â”‚ â”‚ â”œâ”€â”€ 1lpqxcu6kfhnj0ty.o â”‚ â”‚ â”œâ”€â”€ 1z70i4nrjlg4y6gh.o â”‚ â”‚ â”œâ”€â”€ 2qa4nktsifidbpri.o â”‚ â”‚ â”œâ”€â”€ 3k2rwqf2cnq9zjxc.o â”‚ â”‚ â”œâ”€â”€ 4is0vkl128fgpc6l.o â”‚ â”‚ â”œâ”€â”€ dep-graph.bin â”‚ â”‚ â”œâ”€â”€ g5tl0es1ce46vid.o â”‚ â”‚ â”œâ”€â”€ query-cache.bin â”‚ â”‚ â””â”€â”€ work-products.bin â”‚ â””â”€â”€ s-fax5vd6s7z-mo2l8f.lock â””â”€â”€ native åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œæ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼š 1.&#x2F;target&#x2F;debug&#x2F;hello_world ç»“æœå¦‚ä¸‹ï¼š 12root@66c4794c7528:&#x2F;usr&#x2F;src&#x2F;myapp&#x2F;hello_world# .&#x2F;target&#x2F;debug&#x2F;hello_worldHello, world æˆ–è€…åˆ©ç”¨ cargo è¿è¡Œå¯åŠ¨: 1cargo run ç»“æœå¦‚ä¸‹: 1234root@66c4794c7528:&#x2F;usr&#x2F;src&#x2F;myapp&#x2F;hello_world# cargo run Finished dev [unoptimized + debuginfo] target(s) in 0.06s Running &#96;target&#x2F;debug&#x2F;hello_world&#96;Hello, world! åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ç« èŠ‚ Hello World å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥è¦ç§¯ç´¯ç‚¹æ‰å¯ä»¥äº†","categories":[{"name":"Rust","slug":"Rust","permalink":"http://blog.crazylaw.cn/categories/Rust/"}],"tags":[{"name":"Rust","slug":"Rust","permalink":"http://blog.crazylaw.cn/tags/Rust/"}]},{"title":"ã€å·¥å…·ã€‘oh-my-zsh æ¢è¡Œè¡¥å¿","slug":"linux-shell-huanhangbuchong","date":"2018-11-15T04:06:01.000Z","updated":"2021-03-20T16:25:01.809Z","comments":true,"path":"2018/11/15/linux-shell-huanhangbuchong/","link":"","permalink":"http://blog.crazylaw.cn/2018/11/15/linux-shell-huanhangbuchong/","excerpt":"oh-my-zsh æ¢è¡Œè¡¥å¿å¤§å®¶åº”è¯¥ä¹Ÿæ˜¯ç»å¸¸ä¼šç”¨åˆ° linux æˆ–è€… macOSï¼Œå¤§å®¶åº”è¯¥éƒ½æœ‰äº†è§£ macos å¿…å¤‡è½¯ä»¶ä¹‹é—´ï¼Œoh-my-zshï¼Œå®ƒå¯ä»¥ä¸ºæˆ‘ä»¬çš„ç»ˆç«¯æä¾›ä¸°å¯Œçš„ä¸»é¢˜ï¼Œå½“ç„¶ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚ç°åœ¨ä¸»è¦è¯´ä¸€ä¸‹å…¶ä¸­ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œoh-my-zsh çš„ æ¢è¡Œè¡¥å¿æœºåˆ¶ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨ç»ˆç«¯æœ‰æ—¶å€™ä¼šå‘ç°ä¼šå­˜åœ¨ %ï¼Œä¾‹å¦‚ï¼š root è´¦å·çš„æ—¶å€™æ˜¯ # å·é root è´¦å·æ˜¯ % å·","text":"oh-my-zsh æ¢è¡Œè¡¥å¿å¤§å®¶åº”è¯¥ä¹Ÿæ˜¯ç»å¸¸ä¼šç”¨åˆ° linux æˆ–è€… macOSï¼Œå¤§å®¶åº”è¯¥éƒ½æœ‰äº†è§£ macos å¿…å¤‡è½¯ä»¶ä¹‹é—´ï¼Œoh-my-zshï¼Œå®ƒå¯ä»¥ä¸ºæˆ‘ä»¬çš„ç»ˆç«¯æä¾›ä¸°å¯Œçš„ä¸»é¢˜ï¼Œå½“ç„¶ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚ç°åœ¨ä¸»è¦è¯´ä¸€ä¸‹å…¶ä¸­ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œoh-my-zsh çš„ æ¢è¡Œè¡¥å¿æœºåˆ¶ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨ç»ˆç«¯æœ‰æ—¶å€™ä¼šå‘ç°ä¼šå­˜åœ¨ %ï¼Œä¾‹å¦‚ï¼š root è´¦å·çš„æ—¶å€™æ˜¯ # å·é root è´¦å·æ˜¯ % å· åé¢ä¼šå¤šä¸€ä¸ªç™¾åˆ†å·ï¼Œæ˜¾å¾—æ˜¯å¦ä¸èˆ’æœï¼Œä½†æ˜¯è¿™ä¸ªæ°å·§å°±æ˜¯ zsh çš„æ¢è¡Œè¡¥å¿æœºåˆ¶ã€‚æ„ä¹‰åœ¨äºï¼Œå½“æˆ‘ä»¬è¾“å‡ºçš„å­—ç¬¦ä¸²å¿˜è®°åœ¨ç»ˆç«¯æ˜¾ç¤ºæ¢è¡Œç¬¦å· \\n çš„æ—¶å€™ï¼Œä»–å°±ä¼šè‡ªåŠ¨åœ¨è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºä¹‹å‰æ·»åŠ ä¸€ä¸ªç™¾åˆ†å·æ¥å‘Šè¯‰æˆ‘ä»¬ï¼Œä½ çš„è¾“å‡ºå¿˜è®°æ¢è¡Œäº†ï¼Œæˆ‘å¸®ä½ æ¢è¡Œäº†ï¼Œç”¨çš„æ˜¯ % ç¬¦å·ã€‚ çœ‹ä¼¼æŒºå‹å¥½ï¼Œä½†æ˜¯å®åœ¨æ˜¯ä¸ä¹ æƒ¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç°åœ¨çš„ç›®çš„æ˜¯è¦å±è”½ã€‚ éœ€è¦ç”¨çš„æ˜¯ç¯å¢ƒå˜é‡ PROMPT_EOL_MARK æˆ‘ä»¬åªéœ€è¦åœ¨ shell ä¸­è®¾ç½® 1PROMPT_EOL_MARK&#x3D;&#39;&#39; é‚£ä¹ˆå®ƒçš„æ¢è¡Œè¡¥å¿æœºåˆ¶çš„æ›¿æ¢ç¬¦å·å°±ä¼šæ˜¯ä¸ºç©ºï¼Œé‚£å°±æ˜¯ä¸å­˜åœ¨äº†ã€‚ è¿™ä¸ªç¯å¢ƒå˜é‡åŠ åœ¨å“ªé‡Œï¼ŸåŠ åœ¨~/.zshrc é‡Œé¢ä¹Ÿå¯ä»¥ï¼Œæˆ–è€…ä½ ä¸æƒ³æ°¸ä¹…ç”Ÿæ•ˆçš„è¯ï¼Œå°±ç›´æ¥åœ¨ç»ˆç«¯è¾“å…¥å°±å¯ä»¥äº†ã€‚ å‹æƒ…æç¤ºï¼šè®°å¾—ä¸è¦å¿˜è®° source ä¸€ä¸‹é…ç½®å“¦ï½","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘edå‘½ä»¤","slug":"linux-shell-ed","date":"2018-10-25T12:22:00.000Z","updated":"2021-03-20T16:25:01.809Z","comments":true,"path":"2018/10/25/linux-shell-ed/","link":"","permalink":"http://blog.crazylaw.cn/2018/10/25/linux-shell-ed/","excerpt":"è¯´æ˜ed æ˜¯ linux ä¸‹åŸå§‹çš„ç¼–è¾‘å™¨ï¼Œç±»ä¼¼äºä¸€ä¸ªè¡Œä¸ºè®°å½•å™¨ ed çš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥ç”¨ä¸€ä¸ªæ–‡æœ¬æ¥è®°å½• é‡Œé¢çš„å†…å®¹æ˜¯æ‰€æœ‰çš„æ“ä½œï¼Œæœ‰ç‚¹ç±»ä¼¼äº dockerfile çš„å½¢å¼","text":"è¯´æ˜ed æ˜¯ linux ä¸‹åŸå§‹çš„ç¼–è¾‘å™¨ï¼Œç±»ä¼¼äºä¸€ä¸ªè¡Œä¸ºè®°å½•å™¨ ed çš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥ç”¨ä¸€ä¸ªæ–‡æœ¬æ¥è®°å½• é‡Œé¢çš„å†…å®¹æ˜¯æ‰€æœ‰çš„æ“ä½œï¼Œæœ‰ç‚¹ç±»ä¼¼äº dockerfile çš„å½¢å¼ ä½¿ç”¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105. å½“å‰è¡Œ$ æ–‡æœ¬æœ€åä¸€è¡Œn æ–‡æœ¬ç¬¬ n è¡Œï¼ˆ n ä¸ºæ•°å­—ï¼Œä¸‹åŒï¼›m äº¦æ˜¯ ï¼‰-n ä»æ–‡æœ¬å½“å‰è¡Œæ•°èµ·ï¼Œå‘å‰ç¬¬ n è¡Œ+n ä»æ–‡æœ¬å½“å‰è¡Œæ•°èµ·ï¼Œå‘åç¬¬ n è¡Œ- ç›¸å½“äº -1 è¡Œåœ°å€+ ç›¸å½“äº +1 è¡Œåœ°å€mï¼Œn æ–‡æœ¬çš„ç¬¬ m åˆ° n è¡Œ, æ–‡æœ¬çš„æ‰€æœ‰è¡Œ; æ–‡æœ¬å½“å‰è¡Œåˆ°æœ€åä¸€è¡Œ&#x2F;reg&#x2F; ä»æ–‡æœ¬å½“å‰è¡Œæ•°èµ·ï¼Œä¸‹ä¸€ä¸ªåŒ¹é… reg çš„è¡Œ?reg? ä»æ–‡æœ¬å½“å‰è¡Œæ•°èµ·ï¼Œä¸Šä¸€ä¸ªåŒ¹é… reg çš„è¡Œ&#39;x ç”± k å‘½ä»¤æ ‡è®°çš„è¡Œï¼ˆ x ä¸ºä¸€å°å†™å­—æ¯ ï¼‰æ­£åˆ™è¡¨è¾¾å¼å¦‚ä¸‹ï¼š(åªæ¶‰åŠ ed æ‰€æ”¯æŒçš„æ­£åˆ™è¡¨è¾¾å¼). åŒ¹é…ä»»ä½•å•ä¸ªå­—ç¬¦ã€‚[char-class] åŒ¹é…ä»»ä½•ä¸€ä¸ªåœ¨ char-class é‡Œçš„å•ä¸ªå­—ç¬¦ã€‚å¦‚æœä¸­é—´å‡ºç° &#39;-&#39; ï¼Œåˆ™æ„ä¸ºå…¶å·¦è¾¹çš„å­—ç¬¦å’Œå…¶å³è¾¹çš„å­—ç¬¦ä¹‹é—´çš„æ‰€æœ‰å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œ[abc] åŒ¹é… a æˆ– b æˆ– cï¼›[a-z] åŒ¹é…ä»»æ„ä¸€ä¸ªå°å†™å­—æ¯(aã€bã€cã€...ã€z)ï¼Œ[0-9] åŒ¹é…ä»»æ„ä¸€ä¸ªæ•°å­—(0ã€1ã€2ã€...ã€9)ã€‚char-class ä¹Ÿå¯ä»¥ä¸ºä¸€äº›å­—ç¬¦é›†ã€‚å¦‚ä¸‹ï¼š[:alpha:] ç›¸å½“äº [a-zA-Z][:lower:] ç›¸å½“äº [a-z][:upper:] ç›¸å½“äº [A-Z][:digit:] ç›¸å½“äº [0-9][:alnum:] ç›¸å½“äº [a-zA-Z0-9][:blank:] åŒ¹é… &#39; &#39;(ç©ºæ ¼)ã€ &#39;\\t&#39;(åˆ¶è¡¨ç¬¦)[:space:] åŒ¹é… &#39; &#39;(ç©ºæ ¼)ã€&#39;\\t&#39;(åˆ¶è¡¨ç¬¦)ã€&#39;\\n&#39;(æ–°è¡Œ)ã€&#39;\\f&#39;()ã€&#39;\\v&#39;(å‚ç›´åˆ¶è¡¨ç¬¦)ã€&#39;\\r&#39;(å›è½¦ç¬¦)[:cntrl:] åŒ¹é…æ§åˆ¶å­—ç¬¦ã€‚åœ¨ ASCII ç ä¸­ï¼Œè¿™äº›æ§åˆ¶å­—ç¬¦æ˜¯ä»å…«è¿›åˆ¶æ•°å­— 000 åˆ° 037, å’Œ 177 (DEL)[:print:] åŒ¹é… ç›¸å½“äº [:alnum:]ã€[:punct:] å’Œ ç©ºæ ¼[:graph:] åŒ¹é… ç›¸å½“äº [:alnum:] ã€ [:punct:][:punct:] åŒ¹é… &#96;! &quot; # $ % &amp; &#39; ( ) * + , - . &#x2F; : ; &lt; &#x3D; &gt; ? @ [ \\ ] ^ _ &#96; &#123; | &#125; ~ &#39; ç­‰æ ‡ç‚¹ç¬¦å·[:xdigit:] åŒ¹é…åå…­è¿›åˆ¶å­—ç¬¦ &#39;0 1 2 3 4 5 6 7 8 9 A B C D E F a b c d e f&#39;[^char-class] åŒ¹é… [char-class] çš„è¡¥é›†ï¼Œå³åŒ¹é…ä»»æ„ä¸€ä¸ªä¸åœ¨ char-class é‡Œçš„å•ä¸ªå­—ç¬¦* åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–å¤šæ¬¡ã€‚ä¾‹å¦‚ï¼Œ&#39;ab*&#39; èƒ½åŒ¹é… &quot;a&quot; ä»¥åŠ &quot;abb&quot;ã€‚ * ç­‰ä»·äº&#39;\\&#123;0,\\&#125;&#39;\\+ åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼ä¸€æ¬¡æˆ–å¤šæ¬¡ã€‚ä¾‹å¦‚ï¼Œ&#39;ab\\+&#39; èƒ½åŒ¹é… &quot;ab&quot; ä»¥åŠ &quot;abb&quot;ï¼Œä½†ä¸èƒ½åŒ¹é… &quot;a&quot;ã€‚\\+ ç­‰ä»·äº \\&#123;1,\\&#125;\\? åŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–ä¸€æ¬¡ã€‚ä¾‹å¦‚ï¼Œ&quot;word(s)\\?&quot; å¯ä»¥åŒ¹é… &quot;word&quot; æˆ– &quot;words&quot; ã€‚\\? ç­‰ä»·äº\\&#123;0,1\\&#125;\\&#123;n,m\\&#125; m å’Œ n å‡ä¸ºéè´Ÿæ•´æ•°ï¼Œå…¶ä¸­n &lt;&#x3D; mã€‚æœ€å°‘åŒ¹é… n æ¬¡ä¸”æœ€å¤šåŒ¹é… m æ¬¡ã€‚ &quot;a&#123;1,3&#125;&quot; å°†åŒ¹é… &quot;baaaaab&quot;ä¸­çš„å‰ä¸‰ä¸ª aã€‚&#39;a&#123;0,1&#125;&#39; ç­‰ä»·äº &#39;a\\?&#39;ã€‚è¯·æ³¨æ„åœ¨é€—å·å’Œä¸¤ä¸ªæ•°ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼\\&#123;n,\\&#125; n æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚è‡³å°‘åŒ¹é…n æ¬¡ã€‚ä¾‹å¦‚ï¼Œ&#39;a\\&#123;2,\\&#125;&#39; ä¸èƒ½åŒ¹é… &quot;abc&quot; ä¸­çš„ &#39;a&#39;ï¼Œä½†èƒ½åŒ¹é…&quot;baaaaab&quot;ä¸­çš„æ‰€æœ‰ aã€‚&#39;a\\&#123;1,\\&#125;&#39; ç­‰ä»·äº &#39;a\\+&#39;ã€‚&#39;a\\&#123;0,\\&#125;&#39; åˆ™ç­‰ä»·äº &#39;a*&#39;\\&#123;n\\&#125; n æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ã€‚åŒ¹é…ç¡®å®šçš„ n æ¬¡ã€‚ä¾‹å¦‚ï¼Œ&#39;a\\&#123;2\\&#125;&#39; ä¸èƒ½åŒ¹é… &quot;bab&quot; ä¸­çš„ &#39;a&#39;ï¼Œä½†æ˜¯èƒ½åŒ¹é…&quot;baab&quot;ä¸­çš„ä¸¤ä¸ª a^ åŒ¹é…è¾“å…¥å­—ç¬¦ä¸²çš„å¼€å§‹ä½ç½®$ åŒ¹é…è¾“å…¥å­—ç¬¦ä¸²çš„ç»“æŸä½ç½®\\&lt; åŒ¹é…ä¸€ä¸ªå•è¯çš„å‰è¾¹ç•Œã€‚ä¾‹å¦‚ï¼Œ&#39;\\&lt;el&#39; åŒ¹é… &quot;element&quot;,ä½†ä¸èƒ½åŒ¹é… &quot;help&quot;\\&gt; åŒ¹é…ä¸€ä¸ªå•è¯çš„åè¾¹ç•Œã€‚ä¾‹å¦‚ï¼Œ&#39;ly\\&gt;&#39; åŒ¹é… &quot;lovely&quot;ï¼Œä½†ä¸åŒ¹é… &quot;lying&quot;\\b åŒ¹é…ä¸€ä¸ªå•è¯è¾¹ç•Œï¼Œä¹Ÿå°±æ˜¯æŒ‡å•è¯å’Œç©ºæ ¼é—´çš„ä½ç½®ã€‚ä¾‹å¦‚ï¼Œ &#39;er\\b&#39; å¯ä»¥åŒ¹é…&quot;never&quot; ä¸­çš„ &#39;er&#39;ï¼Œä½†ä¸èƒ½åŒ¹é…&quot;verb&quot; ä¸­çš„ &#39;er&#39;\\B åŒ¹é…éå•è¯è¾¹ç•Œã€‚&#39;er\\B&#39; èƒ½åŒ¹é… &quot;verb&quot; ä¸­çš„ &#39;er&#39;ï¼Œä½†ä¸èƒ½åŒ¹é… &quot;never&quot; ä¸­çš„ &#39;er&#39;\\w åŒ¹é…ä»»ä½•éå•è¯å­—ç¬¦ã€‚ç­‰ä»·äº &#39;[^A-Za-z0-9_]&#39;\\W åŒ¹é…ä»»ä½•éå•è¯å­—ç¬¦ã€‚ç­‰ä»·äº &#39;[^A-Za-z0-9_]&#39;\\&#96; åŒ¹é…ä¸€ä¸ªå¥å­çš„è¾¹ç•Œ å®šä¹‰å‘åå¼•ç”¨ã€‚&#39;\\n&#39;(nä¸ºä¸€æ­£æ•´æ•°)ä»£è¡¨ç¬¬ n ä¸ªæ‹¬å·ä¸­åŒ¹é…çš„å­—ç¬¦ä¸²ed å‘½ä»¤ï¼šed å‘½ä»¤éƒ½æ˜¯å•ä¸ªå­—ç¬¦ï¼Œå…¶ä¸­ä¸€äº›å‘½ä»¤æœ‰ä¸€äº›é€‰é¡¹ã€‚å¦‚æœä¸€å‘½ä»¤è¶…è¿‡ä¸€è¡Œï¼Œåº”ä½¿ &#39;\\&#39; ç»“æŸæ¯ä¸€è¡Œã€‚å‘½ä»¤å¦‚ä¸‹ï¼š(æ‹¬å·å†…ä¸ºé»˜è®¤åœ°å€)(.)a åˆ‡æ¢åˆ°è¾“å…¥æ¨¡å¼,å°†æ–°è¾“å…¥çš„æ–‡æœ¬è¿½åŠ åˆ°æŒ‡å®šè¡Œçš„åé¢ï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºè¾“å…¥æ–‡æœ¬çš„æœ€åä¸€è¡Œ(.)i åˆ‡æ¢åˆ°è¾“å…¥æ¨¡å¼,å°†æ–°è¾“å…¥çš„æ–‡æœ¬æ’å…¥åˆ°æŒ‡å®šè¡Œçš„å‰é¢ï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºè¾“å…¥æ–‡æœ¬çš„æœ€åä¸€è¡Œ(.,.)c åˆ‡æ¢åˆ°è¾“å…¥æ¨¡å¼,å°†æ–°è¾“å…¥çš„æ–‡æœ¬æ›¿æ¢æˆæŒ‡å®šè¡Œï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºè¾“å…¥æ–‡æœ¬çš„æœ€åä¸€è¡Œ(.,.)d åˆ é™¤æŒ‡å®šè¡Œï¼Œå¦‚æœè¢«åˆ é™¤çš„æ–‡æœ¬åè¿˜æœ‰æ–‡æœ¬è¡Œï¼Œåˆ™å½“å‰è¡Œè¢«è®¾ä¸ºè¯¥è¡Œï¼Œå¦åˆ™è®¾ä¸ºè¢«åˆ é™¤çš„æ–‡æœ¬çš„ä¸Šä¸€è¡Œ(.+1) æ— å‘½ä»¤æ—¶ï¼Œé»˜è®¤ p å‘½ä»¤ï¼Œä½†æ‰“å°ä¸‹ä¸€è¡Œå†…å®¹ï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºæ‰“å°è¡Œ(.+1)zn ä¸€æ¬¡è·³åŠ¨ n è¡Œï¼Œå¦‚æœæœªæŒ‡å‡º n ï¼Œé»˜è®¤å½“å‰ç»ˆç«¯å±å¹•å¤§å°ï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºæœ€åè¢«æ‰“å°çš„è¡Œ(.,.)p æ‰“å°æŒ‡å®šè¡Œï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºæ‰“å°è¡Œçš„æœ€åä¸€è¡ŒP ed å‘½ä»¤æ¨¡å¼ä¸‹æç¤ºç¬¦å¼€å…³å‘½ä»¤ï¼Œé»˜è®¤æç¤ºç¬¦ä¸º &#39;*&#39;(.,.)l åœ¨æ¯è¡Œæœ€ååŠ ä¸€ &#39;$&#39; ç¬¦å·æŒ‡å®šç»“å°¾ï¼Œå¹¶æ‰“å°è¾“å‡º(.,.)n æ‰“å°æŒ‡å®šè¡Œå·å’Œå†…å®¹ï¼Œè¡Œå·ä¸è¡Œå†…å®¹ç”¨åˆ¶è¡¨ç¬¦åˆ†å‰²,å½“å‰è¡Œè¢«è®¾ä¸ºæ‰“å°è¡Œçš„æœ€åä¸€è¡Œ($)&#x3D; æ‰“å°æŒ‡å®šè¡Œè¡Œå·(.,.)# æ³¨é‡Šè¡Œï¼Œå°†è¢«å¿½ç•¥(.)k char ç”¨ä¸€å°å†™å­—æ¯æ ‡è®°æŒ‡å®šè¡Œ(.,.)s&#x2F;reg&#x2F;replacement&#x2F;(.,.)s&#x2F;reg&#x2F;replacement&#x2F;g(.,.)s&#x2F;reg&#x2F;replacement&#x2F;næ›¿æ¢æŒ‡å®šè¡Œå‘½ä»¤(.,.)s é‡å¤ä¸Šä¸€æ¬¡æ›¿æ¢å‘½ä»¤ï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºæœ€åä¸€ä¸ªè¢«æ”¹å˜çš„è¡Œ(1,$)g&#x2F;reg&#x2F;cmd-list æ‰€æœ‰åŒ¹é… &#39;&#x2F;reg&#x2F;&#39; çš„è¡Œæ‰§è¡Œ cmd-list å‘½ä»¤ï¼Œåœ¨å‘½ä»¤æ‰§è¡Œå‰ï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºåŒ¹é…è¡Œã€‚å½“æ‰€æœ‰åŒ¹é…è¡Œæ‰§è¡Œå®Œå‘½ä»¤åï¼Œå½“å‰è¡Œè¢«è®¾å®šä¸ºæœ€åä¸€ä¸ªåŒ¹é…è¡Œã€‚cmd-list ä¸­æ¯ä¸€è¡Œåªèƒ½æœ‰ä¸€ä¸ªå‘½ä»¤ï¼Œä½†æœ‰å¤šä¸ªå‘½ä»¤æ—¶ï¼Œåº”ä»¥ &#39;\\&#39; ç»“æŸæ¯ä¸€è¡Œ(1,$)G&#x2F;reg&#x2F; ä¸ g&#x2F;reg&#x2F;cmd-list ç›¸ä¼¼ï¼Œä½†åŒ¹é…çš„æ¯ä¸€è¡Œæ‰€æ‰§è¡Œçš„å‘½ä»¤ç”±ç”¨æˆ·å„ä¸ªå®šä¹‰ã€‚(1,$)v&#x2F;reg&#x2F;cmd-list ä¸ g&#x2F;reg&#x2F;cmd-list ç›¸åï¼ŒæŒ‡ä¸åŒ¹é…è¡Œ(1,$)V&#x2F;reg&#x2F; ä¸ G&#x2F;reg&#x2F; ç›¸åï¼ŒæŒ‡ä¸åŒ¹é…è¡Œ(.,.+1)j åˆå¹¶æŒ‡å®šè¡Œå†…å®¹,å½“å‰è¡Œè¢«è®¾ä¸ºåˆå¹¶è¡Œ(.,.)m(.) ç§»åŠ¨å·¦è¾¹æºæŒ‡å®šè¡Œåˆ°å³è¾¹ç›®çš„æŒ‡å®šè¡Œå,å½“å‰è¡Œè¢«è®¾ä¸ºç§»åŠ¨è¡Œçš„æœ€åä¸€è¡Œ(.,.)t(.) å¤åˆ¶å·¦è¾¹æºæŒ‡å®šè¡Œåˆ°å³è¾¹ç›®çš„æŒ‡å®šè¡Œåï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºå¤åˆ¶è¡Œçš„æœ€åä¸€è¡Œ(.,.)y å¤åˆ¶æŒ‡å®šè¡Œåˆ°ç¼“å­˜ï¼Œå½“å‰è¡Œä¸æ”¹å˜(.)x å¤åˆ¶ç¼“å­˜å†…å®¹åˆ°æŒ‡å®šè¡Œåï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºå¤åˆ¶è¡Œçš„æœ€åä¸€è¡Œu æ’¤é”€ä¸Šä¸€æ¬¡å‘½ä»¤ï¼Œå½“å‰åœ°å€è¢«è®¾ä¸ºä¸Šä¸€æ¬¡åœ°å€h æ‰“å°æœ€åä¸€ä¸ªé”™è¯¯è¯´æ˜H é”™è¯¯è¯´æ˜å¼€å…³ï¼Œé»˜è®¤ä¸è¾“å‡ºe file ç¼–è¾‘æ–‡ä»¶å¹¶è®¾å®šæ–‡ä»¶åE file å¼ºåˆ¶ç¼–è¾‘æ–‡ä»¶ï¼ŒåŒ e fileï¼Œä½†ä¸¢å¤±ä»¥å‰çš„ä¿®æ”¹ï¼Œä¸åšè­¦å‘Š!cmd æ‰§è¡Œ shell å‘½ä»¤ cmde !cmd å…ˆå°†ed ç¼“å†²åŒºæ¸…é™¤ï¼Œæ›¿æ¢ cmd å‘½ä»¤çš„è¾“å‡ºf file è®¾ç½®æ–‡ä»¶åï¼Œå¦‚æœæ¯ç»™å‡º file å‚æ•°ï¼Œåˆ™æ‰“å°æ–‡ä»¶å($)r file æŠŠæŒ‡å®šæ–‡ä»¶å†…å®¹è¿½åŠ åˆ°æŒ‡å®šè¡Œåï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºè¿½åŠ æ–‡æœ¬çš„æœ€åä¸€è¡Œ($)r !cmd æŠŠå‘½ä»¤çš„è¾“å‡ºè¿½åŠ åˆ°æŒ‡å®šè¡Œåï¼Œå½“å‰è¡Œè¢«è®¾ä¸ºè¿½åŠ æ–‡æœ¬çš„æœ€åä¸€è¡Œ(1,$)w file ä¿å­˜æŒ‡å®šæ–‡æœ¬å†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶(è¦†ç›–ä¿å­˜)(1,$)W file ä¿å­˜æŒ‡å®šæ–‡æœ¬å†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶(è¿½åŠ ä¿å­˜)ï¼Œå½“å‰è¡Œä¸æ”¹å˜(1,$)w !cmd è¾“å‡ºæŒ‡å®šæ–‡æœ¬å†…å®¹åˆ° cmd çš„æ ‡å‡†è¾“å…¥ï¼Œå½“å‰è¡Œä¸æ”¹å˜(1,$)wq flie ä¿å­˜æŒ‡å®šæ–‡æœ¬å†…å®¹åˆ°æŒ‡å®šæ–‡ä»¶(è¦†ç›–ä¿å­˜)ï¼Œå¹¶é€€å‡ºç¼–è¾‘å™¨q é€€å‡º ed ç¼–è¾‘å™¨ï¼Œé€€å‡ºå‰è‹¥æ‰€ä½œçš„ä¿®æ”¹æ²¡ä¿å­˜ï¼Œå‘å‡ºè­¦å‘ŠQ å¼ºåˆ¶é€€å‡º ed ç¼–è¾‘å™¨ï¼ŒåŒ q å‘½ä»¤ï¼Œä½†é€€å‡ºå‰è‹¥æ‰€ä½œçš„ä¿®æ”¹æ²¡ä¿å­˜ï¼Œä¸è­¦å‘ŠP ed å‘½ä»¤æç¤ºç¬¦æ˜¾ç¤ºå¼€å…³ã€‚ &#39;*&#39; ä¸º ed é»˜è®¤æç¤ºç¬¦ï¼Œåˆ©ç”¨ ed å‘½ä»¤ -p é€‰é¡¹ï¼Œå…¶å¯è¢«æ›´æ”¹ä¸ºä»»æ„å­—ç¬¦æ›´ä¸ºè¯¦ç»†ä¹‹å¤„è¯·å‚é˜… man info æ‰‹å†Œ 12345678910111213$ ed &lt;- æ¿€æ´» ed å‘½ä»¤a &lt;- å‘Šè¯‰ ed æˆ‘è¦ç¼–è¾‘æ–°æ–‡ä»¶My name is Titan. &lt;- è¾“å…¥ç¬¬ä¸€è¡Œå†…å®¹And I love Perl very much. &lt;- è¾“å…¥ç¬¬äºŒè¡Œå†…å®¹. &lt;- è¿”å› ed çš„å‘½ä»¤è¡ŒçŠ¶æ€i &lt;- å‘Šè¯‰ ed æˆ‘è¦åœ¨æœ€åä¸€è¡Œä¹‹å‰æ’å…¥å†…å®¹I am 24. &lt;- å°†â€œI am 24.â€æ’å…¥â€œMy name is Titan.â€å’Œâ€œAnd I love Perl very much.â€ä¹‹é—´. &lt;- è¿”å› ed çš„å‘½ä»¤è¡ŒçŠ¶æ€c &lt;- å‘Šè¯‰ ed æˆ‘è¦æ›¿æ¢æœ€åä¸€è¡Œè¾“å…¥å†…å®¹I am 24 years old. &lt;- å°†â€œI am 24.â€æ›¿æ¢æˆâ€œI am 24 years old.â€ï¼ˆæ³¨æ„ï¼šè¿™é‡Œæ›¿æ¢çš„æ˜¯æœ€åè¾“çš„å†…å®¹ï¼‰. &lt;- è¿”å› ed çš„å‘½ä»¤è¡ŒçŠ¶æ€w readme.text &lt;- å°†æ–‡ä»¶å‘½åä¸ºâ€œreadme.textâ€å¹¶ä¿å­˜ï¼ˆæ³¨æ„ï¼šå¦‚æœæ˜¯ç¼–è¾‘å·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼Œåªéœ€è¦æ•²å…¥ w å³å¯ï¼‰q &lt;- å®Œå…¨é€€å‡º ed ç¼–è¾‘å™¨ 1234$ cat readme.textMy name is Titan.I am 24 years old.And I love Perl vrey much.","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘diff - colordiff","slug":"linux-shell-colordiff","date":"2018-10-25T11:44:00.000Z","updated":"2021-03-20T16:25:01.809Z","comments":true,"path":"2018/10/25/linux-shell-colordiff/","link":"","permalink":"http://blog.crazylaw.cn/2018/10/25/linux-shell-colordiff/","excerpt":"å‰è¨€æˆ‘ä»¬ç»å¸¸ç”¨ git çš„å®¢æˆ·ç«¯æ¥å¯¹æ¯”æ–‡ä»¶å·®å¼‚ï¼Œæˆ–è€…ç”¨ä¸€ä¸‹å…¶ä»–çš„å¯¹æ¯”æ–‡ä»¶çš„å·®å¼‚çš„è½¯ä»¶ï¼Œä¾‹å¦‚å¸¸ç”¨çš„ Beyond Compareï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸æƒ³å€ŸåŠ©å…¶ä»–çš„å·¥å…·ï¼Œç”¨ linux è‡ªå¸¦çš„å‘½ä»¤è¦å¦‚ä½•å®ç°å‘¢ã€‚ è¿™é‡Œå’Œå¤§å®¶è¯´ä¸€ä¸‹ diff å‘½ä»¤ ä½¿ç”¨diff åˆ†æä¸¤ä¸ªæ–‡ä»¶ï¼Œå¹¶è¾“å‡ºä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒçš„è¡Œã€‚diff çš„è¾“å‡ºç»“æœè¡¨æ˜éœ€è¦å¯¹ä¸€ä¸ªæ–‡ä»¶åšæ€æ ·çš„æ“ä½œä¹‹åæ‰èƒ½ä¸ç¬¬äºŒä¸ªæ–‡ä»¶ç›¸åŒ¹é…ã€‚diff å¹¶ä¸ä¼šæ”¹å˜æ–‡ä»¶çš„å†…å®¹ï¼Œä½†æ˜¯ diff å¯ä»¥è¾“å‡ºä¸€ä¸ª ed è„šæœ¬æ¥åº”ç”¨è¿™äº›æ”¹å˜ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ diff æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š","text":"å‰è¨€æˆ‘ä»¬ç»å¸¸ç”¨ git çš„å®¢æˆ·ç«¯æ¥å¯¹æ¯”æ–‡ä»¶å·®å¼‚ï¼Œæˆ–è€…ç”¨ä¸€ä¸‹å…¶ä»–çš„å¯¹æ¯”æ–‡ä»¶çš„å·®å¼‚çš„è½¯ä»¶ï¼Œä¾‹å¦‚å¸¸ç”¨çš„ Beyond Compareï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸æƒ³å€ŸåŠ©å…¶ä»–çš„å·¥å…·ï¼Œç”¨ linux è‡ªå¸¦çš„å‘½ä»¤è¦å¦‚ä½•å®ç°å‘¢ã€‚ è¿™é‡Œå’Œå¤§å®¶è¯´ä¸€ä¸‹ diff å‘½ä»¤ ä½¿ç”¨diff åˆ†æä¸¤ä¸ªæ–‡ä»¶ï¼Œå¹¶è¾“å‡ºä¸¤ä¸ªæ–‡ä»¶çš„ä¸åŒçš„è¡Œã€‚diff çš„è¾“å‡ºç»“æœè¡¨æ˜éœ€è¦å¯¹ä¸€ä¸ªæ–‡ä»¶åšæ€æ ·çš„æ“ä½œä¹‹åæ‰èƒ½ä¸ç¬¬äºŒä¸ªæ–‡ä»¶ç›¸åŒ¹é…ã€‚diff å¹¶ä¸ä¼šæ”¹å˜æ–‡ä»¶çš„å†…å®¹ï¼Œä½†æ˜¯ diff å¯ä»¥è¾“å‡ºä¸€ä¸ª ed è„šæœ¬æ¥åº”ç”¨è¿™äº›æ”¹å˜ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ diff æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼š 123456789101112131415161718192021222324&#x2F;&#x2F;file1.txtI need to buy apples.I need to run the laundry.I need to wash the dog.I need to get the car detailed.&#x2F;&#x2F;file2.txtI need to buy apples.I need to do the laundry.I need to wash the car.I need to get the dog detailed.æˆ‘ä»¬ä½¿ç”¨diffæ¯”è¾ƒä»–ä»¬çš„ä¸åŒï¼šdiff file1.txt file2.txtè¾“å‡ºå¦‚ä¸‹ç»“æœï¼š2,4c2,4&lt; I need to run the laundry.&lt; I need to wash the dog.&lt; I need to get the car detailed.---&gt; I need to do the laundry.&gt; I need to wash the car.&gt; I need to get the dog detailed. æˆ‘ä»¬æ¥è¯´æ˜ä¸€ä¸‹è¯¥è¾“å‡ºç»“æœçš„å«ä¹‰ï¼Œè¦æ˜ç™½ diff æ¯”è¾ƒç»“æœçš„å«ä¹‰ï¼Œæˆ‘ä»¬å¿…é¡»ç‰¢è®°ä¸€ç‚¹ï¼Œdiff æè¿°ä¸¤ä¸ªæ–‡ä»¶ä¸åŒçš„æ–¹å¼æ˜¯å‘Šè¯‰æˆ‘ä»¬æ€ä¹ˆæ ·æ”¹å˜ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¹‹åä¸ç¬¬äºŒä¸ªæ–‡ä»¶åŒ¹é…ã€‚æˆ‘ä»¬çœ‹çœ‹ä¸Šé¢çš„æ¯”è¾ƒç»“æœä¸­çš„ç¬¬ä¸€è¡Œ 2,4c2,4 å‰é¢çš„æ•°å­— 2,4 è¡¨ç¤ºç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸­çš„è¡Œï¼Œä¸­é—´æœ‰ä¸€ä¸ªå­—æ¯ c è¡¨ç¤ºéœ€è¦åœ¨ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸Šåšçš„æ“ä½œ(a=add,c=change,d=delete)ï¼Œåé¢çš„æ•°å­— 2,4 è¡¨ç¤ºç¬¬äºŒä¸ªæ–‡ä»¶ä¸­çš„è¡Œã€‚ 2,4c2,4 çš„å«ä¹‰æ˜¯ï¼šç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸­çš„ç¬¬[2,4]è¡Œ(æ³¨æ„è¿™æ˜¯ä¸€ä¸ªé—­åˆåŒºé—´ï¼ŒåŒ…æ‹¬ç¬¬ 2 è¡Œå’Œç¬¬ 4 è¡Œ)éœ€è¦åšå‡ºä¿®æ”¹æ‰èƒ½ä¸ç¬¬äºŒä¸ªæ–‡ä»¶ä¸­çš„[2,4]è¡Œç›¸åŒ¹é…ã€‚æ¥ä¸‹æ¥çš„å†…å®¹åˆ™å‘Šè¯‰æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼Œå‰é¢å¸¦ &lt; çš„éƒ¨åˆ†è¡¨ç¤ºå·¦è¾¹æ–‡ä»¶çš„ç¬¬[2,4]è¡Œçš„å†…å®¹ï¼Œè€Œå¸¦&gt; çš„éƒ¨åˆ†è¡¨ç¤ºå³è¾¹æ–‡ä»¶çš„ç¬¬[2,4]è¡Œçš„å†…å®¹ï¼Œä¸­é—´çš„ â€” åˆ™æ˜¯ä¸¤ä¸ªæ–‡ä»¶å†…å®¹çš„åˆ†éš”ç¬¦å·ã€‚ æ¨¡å¼ Normal ï¼ˆé»˜è®¤ï¼‰ Contextï¼ˆè®¡ç®—æœºæ¨¡å¼ï¼‰ã€-cã€‘ Unified ï¼ˆç±»ä¼¼ githubï¼‰ã€-uã€‘ Gui (ç±»ä¼¼äºå®¢æˆ·ç«¯) ã€-yã€‘ diff è¿˜æä¾›äº†ä¸€äº›æœ‰ç”¨çš„å‚æ•°æ¥æ§åˆ¶æ¯”è¾ƒè¡Œä¸ºä¸è¾“å‡ºç»“æœï¼Œä¸€äº›å¸¸ç”¨çš„å‚æ•°å¦‚ä¸‹ï¼š -b â€“ignore-space-change å¿½ç•¥ç©ºæ ¼ï¼Œå¦‚æœä¸¤è¡Œè¿›è¡Œæ¯”è¾ƒï¼Œå¤šä¸ªè¿ç»­çš„ç©ºæ ¼ä¼šè¢«å½“ä½œä¸€ä¸ªç©ºæ ¼å¤„ç†ï¼ŒåŒæ—¶ä¼šå¿½ç•¥æ‰è¡Œå°¾çš„ç©ºæ ¼å·®å¼‚ã€‚ -w â€“ignore-all-space å¿½ç•¥æ‰€æœ‰ç©ºæ ¼ï¼Œå¿½ç•¥èŒƒå›´æ¯”-b æ›´å¤§ï¼ŒåŒ…æ‹¬å¾ˆå¤šä¸å¯è§çš„å­—ç¬¦éƒ½ä¼šå¿½ç•¥ã€‚ -B å¿½ç•¥ç©ºç™½è¡Œã€‚ -y è¾“å‡ºä¸¤åˆ—ï¼Œä¸€ä¸ªæ–‡ä»¶ä¸€åˆ—ï¼Œæœ‰ç‚¹ç±»ä¼¼ GUI çš„è¾“å‡ºå¤–è§‚äº†ï¼Œè¿™ç§æ–¹å¼è¾“å‡ºæ›´åŠ ç›´è§‚ã€‚ -W å¤§å†™ Wï¼Œå½“æŒ‡å®š-y çš„æ—¶å€™è®¾ç½®åˆ—çš„å®½åº¦ï¼Œé»˜è®¤æ˜¯ 130 -x, â€“exclude=PAT æ¯”è¾ƒç›®å½•çš„æ—¶å€™æ’é™¤æŒ‡å®š PAT æ¨¡å¼çš„æ–‡ä»¶åçš„æ¯”è¾ƒ -i, â€“ignore-case å¿½ç•¥ä¸¤ä¸ªæ–‡ä»¶ä¸­å¤§å°å†™çš„ä¸åŒ -e å°†æ¯”è¾ƒçš„ç»“æœä¿å­˜æˆä¸€ä¸ª ed è„šæœ¬ï¼Œä¹‹å ed ç¨‹åºå¯ä»¥æ‰§è¡Œè¯¥è„šæœ¬æ–‡ä»¶ï¼Œä»è€Œå°† file1 ä¿®æ”¹æˆä¸ file2 çš„å†…å®¹ç›¸åŒï¼Œè¿™ä¸€èˆ¬åœ¨ patch çš„æ—¶å€™æœ‰ç”¨ã€‚ -r å¦‚æœæ¯”è¾ƒä¸¤ä¸ªç›®å½•ï¼Œ-r å‚æ•°ä¼šæ¯”è¾ƒå…¶ä¸‹åŒåçš„å­ç›®å½• -q è¾“å‡ºç»“æœä¸­ï¼ŒåªæŒ‡å‡ºä¸¤ä¸ªæ–‡ä»¶ä¸åŒï¼Œè€Œä¸è¾“å‡ºä¸¤ä¸ªæ–‡ä»¶å…·ä½“å†…å®¹çš„æ¯”è¾ƒï¼Œè¿™åœ¨æ¯”è¾ƒä¸¤ä¸ªç›®å½•çš„æ—¶å€™å¾ˆå¥½ç”¨ã€‚æˆ‘ä»¬åªéœ€è¦çŸ¥é“ä¸¤ä¸ªç›®å½•ä¸‹é‚£äº›æ–‡ä»¶åšäº†ä¿®æ”¹ï¼Œè€Œä¸éœ€è¦çŸ¥é“æ¯ä¸ªæ–‡ä»¶å…·ä½“ä¿®æ”¹äº†é‚£äº›å†…å®¹ã€‚ç‰¹åˆ«æ˜¯å½“ä¸¤ä¸ªç›®å½•æ–‡ä»¶å¾ˆå¤šçš„æ—¶å€™ã€‚ diff -e 1.txt 2.txt &gt; script.txt è¿™æ ·å°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ª ed å¯ä»¥æ‰§è¡Œçš„è„šæœ¬æ–‡ä»¶ script.txtï¼Œç”Ÿæˆè„šæœ¬æ–‡ä»¶ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦åšä¸€ä¸ªæ“ä½œï¼Œ åœ¨è„šæœ¬æ–‡ä»¶æœ«å°¾æ·»åŠ  ed çš„ write æŒ‡ä»¤ï¼Œåªéœ€è¦æ‰§è¡Œecho &quot;w&quot; &gt;&gt;script.txt å°† w æŒ‡ä»¤é™„åŠ åˆ°è„šæœ¬æ–‡ä»¶çš„æœ€åä¸€è¡Œå³å¯ã€‚é‚£ä¹ˆå¦‚ä½•åº”ç”¨è¯¥è„šæœ¬æ–‡ä»¶å‘¢ï¼Œå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼šed - 1.txt &lt; script.txtæ³¨æ„ä¸­é—´çš„ â€“ ç¬¦å·è¡¨ç¤ºä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ï¼Œè€Œ &lt; script.txt åˆ™é‡å®šå‘ script.txt çš„å†…å®¹åˆ°æ ‡å‡†è¾“å…¥ã€‚è¿™æ ·æ‰§è¡Œä¹‹å 1.txt çš„å†…å®¹å°†ä¸ 2.txt å®Œå…¨ç›¸åŒã€‚","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"docker-python-httpruner","slug":"docker-python-httpruner","date":"2018-08-22T11:56:00.000Z","updated":"2021-03-20T16:25:01.805Z","comments":true,"path":"2018/08/22/docker-python-httpruner/","link":"","permalink":"http://blog.crazylaw.cn/2018/08/22/docker-python-httpruner/","excerpt":"Httprunneræœ€è¿‘ï¼Œç”±äºæŸäº›åŸå› ï¼Œäº†è§£åˆ°äº† httprunnerã€‚ å…ˆè´´ä¸Šæˆ‘çš„æœ¬æ¬¡æ–‡ç« çš„ä¸»é¢˜ï¼š æ”¯æŒ docker ç¯å¢ƒ æ”¯æŒ jsonschema ç²—ç•¥å°è£…æˆäº†åº”ç”¨å‹æ¡†æ¶ import python-file çš„æ—¶å€™ï¼Œè¯·å†™åŸºäºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„ ç›®æ ‡ï¼š[Github:httprunner-docker] [HubDocker:httprunner-docker]","text":"Httprunneræœ€è¿‘ï¼Œç”±äºæŸäº›åŸå› ï¼Œäº†è§£åˆ°äº† httprunnerã€‚ å…ˆè´´ä¸Šæˆ‘çš„æœ¬æ¬¡æ–‡ç« çš„ä¸»é¢˜ï¼š æ”¯æŒ docker ç¯å¢ƒ æ”¯æŒ jsonschema ç²—ç•¥å°è£…æˆäº†åº”ç”¨å‹æ¡†æ¶ import python-file çš„æ—¶å€™ï¼Œè¯·å†™åŸºäºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„ ç›®æ ‡ï¼š[Github:httprunner-docker] [HubDocker:httprunner-docker] å‰è¨€æºè‡ªäºï¼š[httprunner] å¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”± python å†™çš„æµ‹è¯•æ¡†æ¶ã€‚ HttpRunner æ˜¯ä¸€æ¬¾é¢å‘ HTTP(S) åè®®çš„é€šç”¨æµ‹è¯•æ¡†æ¶ï¼Œåªéœ€ç¼–å†™ç»´æŠ¤ä¸€ä»½ YAML/JSON è„šæœ¬ï¼Œå³å¯å®ç°è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€çº¿ä¸Šç›‘æ§ã€æŒç»­é›†æˆç­‰å¤šç§æµ‹è¯•éœ€æ±‚ã€‚ ä½œä¸ºä¸€ååç«¯è¯­è¨€å¼€å‘äººå‘˜ï¼Œpython èƒ½åŠ›ä¸ç®—å¤ªå¼ºï¼Œä¸€è¾¹å†™ï¼Œä¸€éå­¦ä¹ ã€‚åœ¨æœ¬æœºä¸Šå¼€å‘ä¸Šé‡åˆ°äº†å„ç§ç“¶é¢ˆï¼Œå¯ä»¥è¯´æ˜¯çœ‹å¾—æ‡‚å’Œè‡ªå·±å†™æ˜¯äºŒå›äº‹ã€‚äºæ˜¯ï¼Œè¿™é‡Œå¯ä»¥æŠŠæˆ‘å½“ä½œä¸€ä¸ªæµ‹è¯•æ–°æ‰‹äººå‘˜ï¼Œå’Œå¤§å®¶ä¸€èµ·è®°å½•å­¦ä¹ çš„è¿‡ç¨‹ã€‚ é¦–å…ˆï¼Œæˆ‘é€‰æ‹©äº† pycharm è¿™ä¸€æ¬¾ JB çš„äº§å“ä½œä¸ºæˆ‘çš„ ideã€‚ æˆ‘å‘ç°å®ƒæœ‰ä¸€äº›æ™ºèƒ½çš„åœ°æ–¹ï¼Œæ¯”å¦‚è‡ªå¸¦ python ç­‰ç¯å¢ƒï¼Œä½†æ˜¯è¿™ä¹Ÿæ˜¯è‡´å‘½éº»çƒ¦çš„åœ°æ–¹ï¼ˆå¯èƒ½æ˜¯æˆ‘å­¤é™‹å¯¡é—»äº†ï¼‰ï¼Œå°±æ˜¯æƒ³ç€å¦‚æœæˆ‘æœ‰ä¸€ä¸ªé¡¹ç›®ï¼Œç”¨åˆ° httprunner ä½œä¸ºæµ‹è¯•æ¡†æ¶ï¼Œé‚£ä¹ˆæˆ‘çš„ç›®å½•ä¸å›ºå®šï¼Œæˆ‘è¦åˆ°å¤„å¼•å…¥ __init__.pyçš„æ–‡ä»¶ï¼Œæ˜¾å¾—å¾ˆç—›è‹¦ã€‚è€Œä¸”ï¼Œpython æˆ‘æ‰€äº†è§£åˆ°çš„æ˜¯ 3.x å’Œ 2.x è¿˜æ˜¯æœ‰ä¸€äº›åŒºåˆ«çš„ã€‚ é»˜è®¤å®ƒå®‰è£…çš„æ˜¯ 2.xï¼Œä½†æ˜¯ä½œä¸ºå¼€å‘äººå‘˜ï¼Œåœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œå½“ç„¶æœŸå¾…æ˜¯æœ€æ–°çš„ï¼Œåç»­ï¼Œç”±äºéœ€æ±‚çš„åŸå› ï¼Œæˆ‘åˆå»çœ‹äº†ä¸€ä¸‹ 2.x å’Œ 3.x å…¼å®¹çš„é—®é¢˜ï¼Œä½†æ˜¯è¿™é‡Œå°±ä¸åšå™è¿°äº†ã€‚ æˆ‘ä»¬å¤§å®¶å¹³æ—¶ç”¨çš„ç¯å¢ƒæ¯”è¾ƒå¤šçš„æ˜¯ 2 ä¸­ï¼Œä¸€ç§æ˜¯windowï¼Œä¸€ç§æ˜¯maxOSï¼Œä¸‡ä¸€æˆ‘åœ¨ ide ç¯å¢ƒä¸‹è¿è¡Œå¾—å¥½å¥½çš„ï¼Œå»åˆ°æˆ‘çš„ç”Ÿæˆç¯å¢ƒå´æ— æ³•è¿è¡Œäº†æ€ä¹ˆåŠï¼Ÿæˆ–è€…è¯´ï¼Œæƒ³è¦æ¨¡æ‹ŸæœåŠ¡å™¨ä¸Šè¿è¡Œçš„è¯ï¼Œæˆ–è€…æ–¹ä¾¿ç§»æ¤çš„è¯ï¼Œæ€ä¹ˆå¤„ç†ï¼Ÿç­”æ¡ˆæ˜¯ï¼šdockerã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ docker æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ ä½†æ˜¯æˆ‘ç¿»çœ‹äº†ä¸€ä¸‹httprunnerçš„å®˜æ–¹ï¼Œå¹¶æ²¡æœ‰æä¾›å‡ºdockeræ–‡ä»¶ï¼Œäºæ˜¯é‚£å¥½å§ï¼Œé‚£æˆ‘å°±è‡ªå·±æ’¸ä¸€ä¸ªå§ï¼Œå†åŠ ä¸Šå‚è€ƒäº†å‡ ä¸ªæ–‡ç« ï¼Œæ„å»ºå‡ºäº†ä¸€å¥—åŸºäºhttprunnerçš„æµ‹è¯•å¼€å‘æ¡†æ¶ï¼Œæ•´å¥—ä½“ç³»å°±åœ¨æˆ‘çš„ github ä¸­ï¼Œå¤§å®¶å¯ä»¥å»çœ‹çœ‹ã€‚ é¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627â”œâ”€â”€ .env ## demoæ‰€ä½¿ç”¨çš„ç¯å¢ƒå˜é‡â”œâ”€â”€ .env.exampleâ”œâ”€â”€ Dockerfile ## æœ¬é¡¹ç›®çš„Dockerfileâ”œâ”€â”€ README.MDâ”œâ”€â”€ configâ”‚ â”œâ”€â”€ demo_data.ini ## å¯å˜æ•°æ®çš„è®¾ç½®â”‚ â””â”€â”€ test_data.ini ## å¤šä¸ªå¯å˜æ•°æ®çš„è®¾ç½®â”œâ”€â”€ docker-entrypoint.sh ## Dockerfileçš„å…¥å£ç‚¹â”œâ”€â”€ jsonschemas ## ç”¨äºæ”¯æŒjson-schemaâ”‚ â””â”€â”€ demo-jsonschemaâ”‚ â””â”€â”€ user.schema.jsonâ”œâ”€â”€ lib ## å­˜æ”¾è‡ªå·±æµ‹è¯•æ¡†æ¶æ‰€éœ€è¦ç”¨åˆ°çš„ç±»åº“ï¼ˆä¾‹å¦‚ç”Ÿæˆtokençš„ç®—æ³•ï¼‰â”œâ”€â”€ parameters ## ç”¨äºè§£æiniæ•°æ®â”‚ â”œâ”€â”€ common.pyâ”‚ â””â”€â”€ header.pyâ”œâ”€â”€ reports ## æŠ¥å‘Šé»˜è®¤ç”Ÿæˆçš„åœ°æ–¹â”‚ â””â”€â”€ 1534933506.htmlâ”œâ”€â”€ requirements.txt ## é¡¹ç›®åˆå§‹åŒ–ä¾èµ–å®‰è£…åˆ—è¡¨â”œâ”€â”€ run-all.sh ## å¤§å®¶æ‰¹é‡è¿è¡Œç”¨ä¾‹å†™çš„ä¸€ä¸ªååˆ†ç®€å•çš„shellè„šæœ¬â”œâ”€â”€ testcases ## ï¼ˆé‡ç‚¹ï¼‰å­˜æ”¾æˆ‘ä»¬çš„ç”¨ä¾‹â”‚ â”œâ”€â”€ debugtalk.pyâ”‚ â””â”€â”€ demo.jsonâ””â”€â”€ util ## æœ¬é¡¹ç›®å®˜æ–¹æ‰€ç”¨çš„å·¥å…·ç±»å’Œè‡ªå®šä¹‰å…¬å…±å‡½æ•° â”œâ”€â”€ common_config.py â”œâ”€â”€ env.py â”œâ”€â”€ function.py â””â”€â”€ validation_json_schema.py è¿™é‡Œï¼Œæˆ‘åœ¨ä¸Šé¢å·²ç»å¤§è‡´å†™äº†æ¯ä¸ªç›®å½•æ‰€å¹²ä»€ä¹ˆçš„äº†ã€‚ èµ·æ­¥ä½ éœ€è¦å®‰è£…å¥½ dockerï¼Œdocker ä½œä¸ºè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå»ºè®®å¤§å®¶éƒ½å¤šå­¦å­¦ã€‚å³ä½¿æ˜¯æµ‹è¯•çš„åŒå­¦ï¼Œä¹Ÿè¦ç§¯ææ‹¥æŠ±å„ç§å‰æ²¿çš„æŠ€æœ¯å“¦ã€‚åŠ æ²¹ï½ï¼ 1. å®‰è£… dockerç•¥è¿‡â€¦. 2. ä¸‹è½½é¡¹ç›®1git clone https:&#x2F;&#x2F;github.com&#x2F;whiteCcinn&#x2F;httprunner-docker.git 3. è¿›å…¥é¡¹ç›®1cd httprunner-docker 4. ç¼–è¯‘ dockerfile ç”Ÿæˆé¡¹ç›®é•œåƒ1docker build -t httprunner . 5. é€šè¿‡é•œåƒè¿è¡Œå®¹å™¨ä»£æ›¿ httprunner1docker run -it --rm -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp httprunner ä¸ºäº†å¸®åŠ©ä¸ç†Ÿæ‚‰ docker çš„åŒå­¦åœ¨è¿™é‡Œå¼ºè°ƒä¸€ä¸‹å‚æ•° -it è®© docker å®¹å™¨æ‹¥æœ‰äº¤äº’çš„èƒ½åŠ›ã€‚ï¼ˆé‡è¦çš„æ˜¯åŠ äº†è¿™ä¸ªå‚æ•°ï¼Œä½ å¯ä»¥é€šè¿‡ /bin/sh è¿›å…¥å®¹å™¨æ‰§è¡Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè€Œä¸”åŠ äº†è¿™ä¸ªå‚æ•°ï¼Œå®¹å™¨å†…éƒ¨çš„é¢œè‰²æ ·å¼æ‰ä¼šè¢«æ‰“å°å‡ºæ¥ï¼Œä¸ç„¶ä¼šå…¨éƒ¨ç™½è‰²ï¼Œååˆ†éš¾ä»¥è¾¨åˆ« ï¼‰ --rm å¯ä»¥ç†è§£ä¸ºä¸´æ—¶åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨è¿è¡Œç»“æŸåä¾¿ä¼šè‡ªè¡Œé”€æ¯ï¼Œè¿™ä¸ªå¤§å®¶å¯ä»¥ä¸ç”¨ç†è§£ï¼Œä½†æ˜¯åŠ äº†è¿™ä¸ªå‚æ•°å­—é¢çš„æ„æ€å°±æ˜¯å®ƒä¸ä¼šé‡å¤ new å¾ˆå¤šéšæœºå‘½åçš„å®¹å™¨ã€‚ -v è¿™ä¸ªæ˜¯ docker ä¸­ç›¸å¯¹æ¥è¯´æ¯”è¾ƒé‡è¦çš„å‘½ä»¤ï¼Œç”¨äº†è¿™ä¸ªå‘½ä»¤ï¼Œä½ çš„ docker å®¹å™¨å’Œä½ çš„æœ¬æœºç›®å½•å°†ä¼šå˜æˆå…±äº«å·ï¼Œé€šä¿—ä¸€ç‚¹å°±æ˜¯åŠ äº†è¿™ä¸ªå‘½ä»¤ï¼Œä½ æ–°åŠ çš„ç”¨ä¾‹ json æ–‡ä»¶ï¼Œæ‰ä¼šå’Œ docker å®¹å™¨é‡Œé¢çš„ç›®å½•åŒæ­¥ï¼Œå¹¶ä¸”ä½ æ‰€ç”Ÿæˆçš„æµ‹è¯•æŠ¥å‘Šï¼Œæ‰å¯ä»¥åœ¨æœ¬åœ°ç›´æ¥è®¿é—®ã€‚ç”±äºæˆ‘ä»¬æ˜¯åœ¨é¡¹ç›®ä¸‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨$PWDå‘½ä»¤æ¥å¿«é€Ÿè·å–å½“å‰ç›®å½•çš„è·¯å¾„ï¼Œç„¶åæ˜ å°„åˆ°æˆ‘ä»¬çš„å®¹å™¨é‡Œé¢çš„è·¯å¾„/usr/src/myappï¼ˆå› ä¸ºæˆ‘ä»¬çš„ docker é¡¹ç›®çš„å·¥ä½œè·¯å¾„å°±æ˜¯åœ¨è¿™é‡Œï¼Œè¿™ä¸ªä¸éœ€è¦ä¿®æ”¹ï¼‰ httprunner è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬åˆšæ‰ç”¨docker build -t httprunner .æ‰“å°å‡ºæ¥çš„httprunnerçš„åå­—ã€‚ 6. ç»“æœå¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œé»˜è®¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°hrunæä¾›ç»™æˆ‘ä»¬çš„å‘½ä»¤æç¤ºä¿¡æ¯ã€‚å…·ä½“çš„å¤§å®¶ï¼Œå¯ä»¥è§‚çœ‹ httprunner å®˜æ–¹æ–‡æ¡£ã€‚ è¿è¡Œå®˜æ–¹ demoæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤: 1docker run -it --rm -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp httprunner .&#x2F;testcases&#x2F;demo.json è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„å®˜æ–¹ demo æˆåŠŸè¿è¡Œäº†ï¼Œå¹¶ä¸”ç”Ÿæˆçš„æµ‹è¯•æŠ¥å‘Šå°±åœ¨reportsç›®å½•ä¸­ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œdemo ä¸­ï¼Œè¿è¡Œäº† 2 ä¸ªç”¨ä¾‹ã€‚ /user - use jsonschema ï¼ˆè¯¥ç”¨ä¾‹è¿ç”¨äº† jsonschema æ¥æ ¡éªŒå…·ä½“æ•°æ®æ˜¯å¦æ­£å¸¸ï¼‰ /favicon.ico - not use jsonschema ï¼ˆè¯¥ç”¨ä¾‹æ²¡æœ‰ç”¨ jsonschema æ¥æ ¡éªŒå…·ä½“æ•°æ®ï¼Œä»…ä»…ç”¨äº† httprunner æä¾›çš„æ ¡éªŒï¼‰ å¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”¨åˆ° json-schema æ¥ä½œä¸ºæ ¡éªŒçš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„ Validators ä¸­ jsonschema_errorä¸ºç©ºçš„æ—¶å€™ï¼Œå°±æ˜¯ä»£è¡¨æ•°æ®ä¿¡æ¯é€šè¿‡äº†json-schemaçš„æ ¡éªŒã€‚ å°è¯•ä¸€ä¸‹ä¸é€šè¿‡ json-schema çš„ç»“æœ12345678910&quot;message&quot;: &#123; &quot;$id&quot;: &quot;#&#x2F;properties&#x2F;message&quot;, &quot;type&quot;: &quot;string&quot;, ## æŠŠè¿™é‡Œæ”¹æˆ&quot;object&quot; &quot;title&quot;: &quot;The Message Schema&quot;, &quot;default&quot;: &quot;&quot;, &quot;examples&quot;: [ &quot;Requires authentication&quot; ], &quot;pattern&quot;: &quot;^(.*)$&quot;&#125;, ç»ˆç«¯ï¼š è¿™é‡Œå¯ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç»ˆç«¯ä¼šæŠ›å‡ºä¸€ä¸¢çº¢è‰²çš„é”™è¯¯ä¿¡æ¯ã€‚ æˆ‘ä»¬æå–ä¸€æ®µå…³é”®ä¿¡æ¯ 1234567891011ERROR validate: jsonschema_error equals (str) &#x3D;&#x3D;&gt; failTraceback (most recent call last):jsonschema.exceptions.ValidationError: &#39;Requires authentication&#39; is not of type &#39;object&#39;Failed validating &#39;type&#39; in schema[&#39;properties&#39;][&#39;message&#39;]: &#123;&#39;$id&#39;: &#39;#&#x2F;properties&#x2F;message&#39;, &#39;default&#39;: &#39;&#39;, &#39;examples&#39;: [&#39;Requires authentication&#39;], &#39;pattern&#39;: &#39;^(.*)$&#39;, &#39;title&#39;: &#39;The Message Schema&#39;, &#39;type&#39;: &#39;object&#39;&#125; è¿™æ®µä¿¡æ¯å‘Šè¯‰æˆ‘ä»¬ï¼Œmessage ä¸æ˜¯ object ç±»å‹ï¼Œæ‰€ä»¥æŠ¥é”™äº†ã€‚ æµ‹è¯•æŠ¥å‘Šçš„ç»“æœï¼š è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªæµ‹è¯•æŠ¥å‘Šï¼Œå˜æˆäº†æˆ‘ä»¬æ‰€æœŸå¾…çš„é”™è¯¯çš„æ ·å­ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥å…·ä½“çš„ä¿¡æ¯ã€‚ æ€»ç»“start1docker build -t httprunner . è¿è¡Œå•ç‹¬æµ‹è¯•ç”¨ä¾‹ï¼š12345docker run -it --rm -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp httprunner testcases&#x2F;you-json-file.jsondocker run -it --rm -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp httprunner .&#x2F;testcases&#x2F;you-json-file.jsondocker run -it --rm -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp httprunner hrun testcases&#x2F;you-json-file.json æ‰¹é‡è¿è¡Œï¼š1docker run -it --rm -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp httprunner run-all.sh è¿›å…¥å®¹å™¨å†…éƒ¨æ“ä½œï¼š1docker run -it --rm -v &quot;$PWD&quot;:&#x2F;usr&#x2F;src&#x2F;myapp httprunner &#x2F;bin&#x2F;sh æœ¬é¡¹ç›®çš„å‘½ä»¤éƒ½åšäº†å…¼å®¹å¤„ç†ï¼Œé¿å…äº†ä¸€äº›å‘½ä»¤é”™è¯¯ï¼Œè¯·å¤§å®¶æ”¾å¿ƒä½¿ç”¨ï¼Œä½œä¸ºä¸€åå¼€å‘äººå‘˜ï¼Œå¸Œæœ›æœ¬æ–‡ç« å¯¹å¤§å®¶çš„æµ‹è¯•æœ‰æ‰€å¸®åŠ©ã€‚å¦‚æœä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œç¯å¢ƒåœ¨æœ¬ github é¡¹ç›®ä¸­æ issueã€‚ æˆ‘ä¹Ÿç›¸å½“äºæ˜¯ä¸ªæµ‹è¯•æ–°æ‰‹ï¼Œå¤§å®¶è§‰å¾—æ–‡ç« å¥½çš„è¯ï¼Œè®°å¾—åœ¨ github ç»™é¡¹ç›® Star ä¸€ä¸ªå“¦ã€‚ åç»­ï¼Œæˆ‘ä¼šé’ˆå¯¹ httprunner å¼€å‘è€…æ¨¡å¼ï¼Œè¿›è¡Œç ”ç©¶ï¼Œçœ‹çœ‹ httprunner è¿˜å¯ä»¥æ€ä¹ˆä¼˜åŒ–ã€‚æ¥ä¸‹æ¥å¤§å®¶ä¸€èµ·æœŸå¾…å§ï½","categories":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/categories/Docker/"},{"name":"Python","slug":"Docker/Python","permalink":"http://blog.crazylaw.cn/categories/Docker/Python/"},{"name":"æµ‹è¯•","slug":"Docker/Python/æµ‹è¯•","permalink":"http://blog.crazylaw.cn/categories/Docker/Python/%E6%B5%8B%E8%AF%95/"}],"tags":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/tags/Docker/"},{"name":"Python","slug":"Python","permalink":"http://blog.crazylaw.cn/tags/Python/"},{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"http://blog.crazylaw.cn/tags/%E6%B5%8B%E8%AF%95/"},{"name":"jsonschema","slug":"jsonschema","permalink":"http://blog.crazylaw.cn/tags/jsonschema/"}]},{"title":"ã€Laravelã€‘Service Providers æœåŠ¡æä¾›è€…","slug":"php-laravel-2","date":"2018-07-08T06:10:46.000Z","updated":"2021-03-20T16:25:01.812Z","comments":true,"path":"2018/07/08/php-laravel-2/","link":"","permalink":"http://blog.crazylaw.cn/2018/07/08/php-laravel-2/","excerpt":"å‰è¨€æœåŠ¡æä¾›è€…å’ŒæœåŠ¡å®¹å™¨æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œåœ¨æˆ‘çœ‹æ¥ï¼ŒæœåŠ¡æä¾›è€…æ˜¯ Laravel åº”ç”¨å¯åŠ¨çš„ä¸­å¿ƒï¼Œä½ è‡ªå·±çš„åº”ç”¨ä»¥åŠæ‰€æœ‰ Laravel çš„æ ¸å¿ƒæœåŠ¡éƒ½æ˜¯é€šè¿‡æœåŠ¡æä¾›è€…å¯åŠ¨ã€‚ æ­£æ–‡é‡Œé¢æœ‰ 2 ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ registerï¼ˆä¸€èˆ¬ç”¨äºå°†æœåŠ¡çš„å¯¹è±¡ç»‘å®šåˆ°æœåŠ¡å®¹å™¨ä¸­ï¼Œä¸åšå…¶ä»–äº‹æƒ…ã€‚ï¼‰ boot ï¼ˆåœ¨ register ä¹‹åï¼Œå°†ä¼šè°ƒç”¨è¿™ä¸ª boot æ–¹æ³•ï¼Œè¿™ä¸ª boot æ–¹æ³•å…è®¸ä¾èµ–æ³¨å…¥ã€‚ï¼‰ é‡Œé¢ 2 ä¸ªæ ¸å¿ƒçš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯ bindings singletons å…·ä½“çš„ç”¨å¤„å°±æ˜¯ç”¨äºæœåŠ¡å™¨å®¹å™¨ä¾èµ–æ³¨å…¥ç”¨çš„ã€‚","text":"å‰è¨€æœåŠ¡æä¾›è€…å’ŒæœåŠ¡å®¹å™¨æ˜¯ä¸¤ä¸ªä¸åŒçš„æ¦‚å¿µï¼Œåœ¨æˆ‘çœ‹æ¥ï¼ŒæœåŠ¡æä¾›è€…æ˜¯ Laravel åº”ç”¨å¯åŠ¨çš„ä¸­å¿ƒï¼Œä½ è‡ªå·±çš„åº”ç”¨ä»¥åŠæ‰€æœ‰ Laravel çš„æ ¸å¿ƒæœåŠ¡éƒ½æ˜¯é€šè¿‡æœåŠ¡æä¾›è€…å¯åŠ¨ã€‚ æ­£æ–‡é‡Œé¢æœ‰ 2 ä¸ªæ ¸å¿ƒçš„æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ registerï¼ˆä¸€èˆ¬ç”¨äºå°†æœåŠ¡çš„å¯¹è±¡ç»‘å®šåˆ°æœåŠ¡å®¹å™¨ä¸­ï¼Œä¸åšå…¶ä»–äº‹æƒ…ã€‚ï¼‰ boot ï¼ˆåœ¨ register ä¹‹åï¼Œå°†ä¼šè°ƒç”¨è¿™ä¸ª boot æ–¹æ³•ï¼Œè¿™ä¸ª boot æ–¹æ³•å…è®¸ä¾èµ–æ³¨å…¥ã€‚ï¼‰ é‡Œé¢ 2 ä¸ªæ ¸å¿ƒçš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯ bindings singletons å…·ä½“çš„ç”¨å¤„å°±æ˜¯ç”¨äºæœåŠ¡å™¨å®¹å™¨ä¾èµ–æ³¨å…¥ç”¨çš„ã€‚ å®˜æ–¹æä¾›çš„ä¾‹å­å¦‚ä¸‹ï¼š 1234567891011121314151617181920class AppServiceProvider extends ServiceProvider&#123; /** * All of the container bindings that should be registered. * * @var array */ public $bindings = [ ServerProvider::class =&gt; DigitalOceanServerProvider::class, ]; /** * All of the container singletons that should be registered. * * @var array */ public $singletons = [ DowntimeNotifier::class =&gt; PingdomDowntimeNotifier::class, ];&#125; æˆ‘ä»¬å®šä¹‰å¥½äº†ä¹‹åéœ€è¦æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ï¼Œæ‰¾åˆ°config/app.php 1234'providers' =&gt; [ // å…¶å®ƒæœåŠ¡æä¾›è€… App\\Providers\\ComposerServiceProvider::class,], è¿™æ ·å­å°±æ³¨å†Œå¥½äº†ã€‚ æ³¨å†Œå¥½äº†ä¹‹åï¼Œç³»ç»Ÿä¼šåœ¨å¯åŠ¨çš„æ—¶å€™å°±åˆå§‹åŒ–æœåŠ¡æä¾›è€…ã€‚ å½“ç„¶ï¼Œå¦‚æœä½ è§‰å¾—è¿™æ ·å­ååˆ†çœ¼ä¸­å½±å“æ€§èƒ½çš„è¯ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå»¶è¿ŸåŠ è½½çš„å±æ€§ 123456/** * æœåŠ¡æä¾›è€…åŠ æ˜¯å¦å»¶è¿ŸåŠ è½½. * * @var bool */protected $defer = true; å®šä¹‰äº†è¿™ä¸ªå±æ€§ä¹‹åï¼Œåœ¨ä½ ç”¨åˆ°è¿™äº›æœåŠ¡æä¾›è€…çš„æ—¶å€™æ‰ä¼šå»åŠ è½½ã€‚","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"Laravel","slug":"Laravel","permalink":"http://blog.crazylaw.cn/tags/Laravel/"}]},{"title":"ã€Laravelã€‘Service Container æœåŠ¡å®¹å™¨ç”¨æ³•","slug":"php-laravel","date":"2018-07-08T04:50:00.000Z","updated":"2021-03-20T16:25:01.813Z","comments":true,"path":"2018/07/08/php-laravel/","link":"","permalink":"http://blog.crazylaw.cn/2018/07/08/php-laravel/","excerpt":"å‰è¨€Laravel æ˜¯ä¸€æ¬¾ PHP å¼€æºæ¡†æ¶ï¼Œæœ€è¿‘å­¦ä¹ äº†ä¸€ä¸‹ Symfonyï¼Œç°åœ¨æ¥äº†è§£ä¸€ä¸‹ Laravel çš„æœ€æ–°ç‰ˆæœ¬çš„ä¸€äº›ä¸œè¥¿ã€‚ å…¶å®è¯´åˆ°æœåŠ¡å™¨å®¹å™¨ï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¼šç›´æ¥æåˆ°ä¾èµ–æ³¨å…¥çš„æ¦‚å¿µï¼Œå…¶å®æœåŠ¡å®¹å™¨çš„æ¦‚å¿µï¼Œå°±å’Œæˆ‘ä»¬è®¾è®¡æ¨¡å¼ä¸­çš„å¯¹è±¡æ± å·®ä¸å¤šï¼ŒæŠŠæ‰€æœ‰çš„å¯¹è±¡éƒ½æ”¾åœ¨ä¸€ä¸ªæ± å­é‡Œé¢å»ï¼Œè€Œä¸å¿…ä¸€ä¸ªä¸ªå» new äº†ã€‚è€Œä¸”æ”¯æŒæ¯æ¬¡éƒ½æ–°å»ºå’Œå•ä¾‹ï¼Œç­‰ç­‰ã€‚ åœ¨è¿™äº›çš„åŸºç¡€ä¹‹ä¸Šï¼Œè¡ç”Ÿå‡ºäº† 2 ä¸ªæ¦‚å¿µIocï¼šæ§åˆ¶åè½¬ï¼ŒDiï¼šä¾èµ–æ³¨å…¥ï¼Œè¿™äº›æ¦‚å¿µï¼Œåœ¨æˆ‘çš„è®¤çŸ¥é‡Œï¼Œæ—©èµ·å‡ºè‡ª java æ¡†æ¶ä¹‹ä¸­ã€‚ä¸»è¦çš„ç›®çš„å°±æ˜¯å®ç°å¯¹è±¡ä¾èµ–è§£è€¦ã€‚å…·ä½“çš„è®¾è®¡æ¨¡å¼çš„ç†å¿µï¼Œå¯ä»¥å‚è€ƒæˆ‘åšå®¢ä¸­çš„è®¾è®¡æ¨¡å¼ä¸€ç³»åˆ—çš„æ–‡ç« ã€‚ ä¸‹è¿°ä¸»è¦å‚è€ƒäº†è°‹ç¯‡ laravel æœåŠ¡å®¹å™¨ä»‹ç»æ‘˜å½•+éƒ¨åˆ†è‡ªæˆ‘å®è·µæ•´ç†ã€‚å¯¹æ¯”äº†ä¸€ä¸‹å’Œå®˜ç½‘çš„ä»‹ç»å·®ä¸å¤šï¼Œæ›´å¤šçš„ä¸»è¦æ˜¯ä¾‹å­çš„è¯´æ˜ã€‚ æ­£é¢˜Laravel ä¸­æœ‰ä¸€å¤§å †è®¿é—® Container å®ä¾‹çš„å§¿åŠ¿ï¼Œæ¯”å¦‚æœ€ç®€å•çš„ï¼š 1$container = app();","text":"å‰è¨€Laravel æ˜¯ä¸€æ¬¾ PHP å¼€æºæ¡†æ¶ï¼Œæœ€è¿‘å­¦ä¹ äº†ä¸€ä¸‹ Symfonyï¼Œç°åœ¨æ¥äº†è§£ä¸€ä¸‹ Laravel çš„æœ€æ–°ç‰ˆæœ¬çš„ä¸€äº›ä¸œè¥¿ã€‚ å…¶å®è¯´åˆ°æœåŠ¡å™¨å®¹å™¨ï¼Œç›¸ä¿¡å¤§å®¶éƒ½ä¼šç›´æ¥æåˆ°ä¾èµ–æ³¨å…¥çš„æ¦‚å¿µï¼Œå…¶å®æœåŠ¡å®¹å™¨çš„æ¦‚å¿µï¼Œå°±å’Œæˆ‘ä»¬è®¾è®¡æ¨¡å¼ä¸­çš„å¯¹è±¡æ± å·®ä¸å¤šï¼ŒæŠŠæ‰€æœ‰çš„å¯¹è±¡éƒ½æ”¾åœ¨ä¸€ä¸ªæ± å­é‡Œé¢å»ï¼Œè€Œä¸å¿…ä¸€ä¸ªä¸ªå» new äº†ã€‚è€Œä¸”æ”¯æŒæ¯æ¬¡éƒ½æ–°å»ºå’Œå•ä¾‹ï¼Œç­‰ç­‰ã€‚ åœ¨è¿™äº›çš„åŸºç¡€ä¹‹ä¸Šï¼Œè¡ç”Ÿå‡ºäº† 2 ä¸ªæ¦‚å¿µIocï¼šæ§åˆ¶åè½¬ï¼ŒDiï¼šä¾èµ–æ³¨å…¥ï¼Œè¿™äº›æ¦‚å¿µï¼Œåœ¨æˆ‘çš„è®¤çŸ¥é‡Œï¼Œæ—©èµ·å‡ºè‡ª java æ¡†æ¶ä¹‹ä¸­ã€‚ä¸»è¦çš„ç›®çš„å°±æ˜¯å®ç°å¯¹è±¡ä¾èµ–è§£è€¦ã€‚å…·ä½“çš„è®¾è®¡æ¨¡å¼çš„ç†å¿µï¼Œå¯ä»¥å‚è€ƒæˆ‘åšå®¢ä¸­çš„è®¾è®¡æ¨¡å¼ä¸€ç³»åˆ—çš„æ–‡ç« ã€‚ ä¸‹è¿°ä¸»è¦å‚è€ƒäº†è°‹ç¯‡ laravel æœåŠ¡å®¹å™¨ä»‹ç»æ‘˜å½•+éƒ¨åˆ†è‡ªæˆ‘å®è·µæ•´ç†ã€‚å¯¹æ¯”äº†ä¸€ä¸‹å’Œå®˜ç½‘çš„ä»‹ç»å·®ä¸å¤šï¼Œæ›´å¤šçš„ä¸»è¦æ˜¯ä¾‹å­çš„è¯´æ˜ã€‚ æ­£é¢˜Laravel ä¸­æœ‰ä¸€å¤§å †è®¿é—® Container å®ä¾‹çš„å§¿åŠ¿ï¼Œæ¯”å¦‚æœ€ç®€å•çš„ï¼š 1$container = app(); ä½†æˆ‘ä»¬è¿˜æ˜¯å…ˆå…³æ³¨ä¸‹ Container ç±»æœ¬èº«ã€‚ 1Laravel å®˜æ–¹æ–‡æ¡£ä¸­ä¸€èˆ¬ä½¿ç”¨ $this-&gt;app ä»£æ›¿ $containerã€‚å®ƒæ˜¯ Application ç±»çš„å®ä¾‹ï¼Œè€Œ Application ç±»ç»§æ‰¿è‡ª Container ç±»ã€‚ ç”¨æ³•ä¸€ï¼šåŸºæœ¬ç”¨æ³•ï¼Œç”¨type hint (ç±»å‹æç¤º) æ³¨å…¥ ä¾èµ–ï¼š123456789101112131415161718192021222324&lt;?phpinclude './vendor/autoload.php';use Illuminate\\Container\\Container;$container = Container::getInstance();class MyClass&#123; private $dependency; public function __construct(AnotherClass $dependency) &#123; $this-&gt;dependency = $dependency; &#125;&#125;class AnotherClass&#123;&#125;$instance = $container-&gt;make(MyClass::class);var_dump($instance) æ¥ä¸‹æ¥ç”¨ Container çš„ make æ–¹æ³•æ¥ä»£æ›¿ new MyClass: 1$instance = $container-&gt;make(MyClass::class); Container ä¼šè‡ªåŠ¨å®ä¾‹åŒ–ä¾èµ–çš„å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒç­‰åŒäºï¼š 1$instance = new MyClass(new AnotherClass()); å¦‚æœ AnotherClass ä¹Ÿæœ‰ ä¾èµ–ï¼Œé‚£ä¹ˆ Container ä¼šé€’å½’æ³¨å…¥å®ƒæ‰€éœ€çš„ä¾èµ–ã€‚ Container ä½¿ç”¨ Reflection (åå°„) æ¥æ‰¾åˆ°å¹¶å®ä¾‹åŒ–æ„é€ å‡½æ•°å‚æ•°ä¸­çš„é‚£äº›ç±»ã€‚ ç”¨æ³•äºŒï¼šBinding Interfaces to Implementations (ç»‘å®šæ¥å£åˆ°å®ç°)ç”¨ Container å¯ä»¥è½»æ¾åœ°å†™ä¸€ä¸ªæ¥å£ï¼Œç„¶ååœ¨è¿è¡Œæ—¶å®ä¾‹åŒ–ä¸€ä¸ªå…·ä½“çš„å®ä¾‹ã€‚ é¦–å…ˆå®šä¹‰æ¥å£ï¼š 12interface MyInterface &#123; /* ... */ &#125;interface AnotherInterface &#123; /* ... */ &#125; ç„¶åå£°æ˜å®ç°è¿™äº›æ¥å£çš„å…·ä½“ç±»ã€‚ä¸‹é¢è¿™ä¸ªç±»ä¸ä½†å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œè¿˜ä¾èµ–äº†å®ç°å¦ä¸€ä¸ªæ¥å£çš„ç±»å®ä¾‹ï¼š 12345678910class MyClass implements MyInterface&#123; private $dependency; // ä¾èµ–äº†ä¸€ä¸ªå®ç° AnotherInterface æ¥å£çš„ç±»çš„å®ä¾‹ public function __construct(AnotherInterface $dependency) &#123; $this-&gt;dependency = $dependency; &#125;&#125; ç°åœ¨ç”¨ Container çš„ bind() æ–¹æ³•æ¥è®©æ¯ä¸ª æ¥å£ å’Œå®ç°å®ƒçš„ç±»ä¸€ä¸€å¯¹åº”èµ·æ¥ï¼š 12$container-&gt;bind(MyInterface::class, MyClass::class);$container-&gt;bind(AnotherInterface::class, AnotherClass::class); æœ€åï¼Œç”¨æ¥å£å è€Œä¸æ˜¯ ç±»å æ¥ä¼ ç»™ make(): 1$instance = $container-&gt;make(MyInterface::class); æ³¨æ„ï¼šå¦‚æœä½ å¿˜è®°ç»‘å®šå®ƒä»¬ï¼Œä¼šå¯¼è‡´ä¸€ä¸ª Fatal Error:â€Uncaught ReflectionException: Class MyInterface does not existâ€ã€‚ å®æˆ˜ ä¸‹é¢æ˜¯å¯å°è£…çš„ Cache å±‚ï¼š 123456789101112131415161718192021222324252627282930313233343536interface Cache&#123; public function get($key); public function put($key, $value);&#125;class Worker&#123; private $cache; public function __construct(Cache $cache) &#123; $this-&gt;cache = $cache; &#125; public function result() &#123; // å»ç¼“å­˜é‡ŒæŸ¥è¯¢ $result = $this-&gt;cache-&gt;get('worker'); if ($result === null) &#123; // å¦‚æœç¼“å­˜é‡Œæ²¡æœ‰ï¼Œå°±å»åˆ«çš„åœ°æ–¹æŸ¥è¯¢ï¼Œç„¶åå†æ”¾è¿›ç¼“å­˜ä¸­ $result = do_something_slow(); $this-&gt;cache-&gt;put('worker', $result); &#125; return $result; &#125;&#125;use Illuminate\\Container\\Container;$container = Container::getInstance();$container-&gt;bind(Cache::class, RedisCache::class);$result = $container-&gt;make(Worker::class)-&gt;result();// è¿™é‡Œç”¨ Redis åšç¼“å­˜ï¼Œå¦‚æœæ”¹ç”¨å…¶ä»–ç¼“å­˜ï¼Œåªè¦æŠŠ RedisCache æ¢æˆåˆ«çš„å°±è¡Œäº†ï¼Œeasy! ç”¨æ³•ä¸‰ï¼šBinding Abstract &amp; Concret Classes ï¼ˆç»‘å®šæŠ½è±¡ç±»å’Œå…·ä½“ç±»ï¼‰ç»‘å®šè¿˜å¯ä»¥ç”¨åœ¨æŠ½è±¡ç±»ï¼š 1$container-&gt;bind(MyAbstract::class, MyConcreteClass::class); æˆ–è€…ç»§æ‰¿çš„ç±»ä¸­ï¼š 1$container-&gt;bind(MySQLDatabase::class, CustomMySQLDatabase::class); ç”¨æ³•å››ï¼šè‡ªå®šä¹‰ç»‘å®šå¦‚æœç±»éœ€è¦ä¸€äº›é™„åŠ çš„é…ç½®é¡¹ï¼Œå¯ä»¥æŠŠ bind() æ–¹æ³•ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°æ¢æˆ Closure (é—­åŒ…å‡½æ•°)ï¼š 123$container-&gt;bind(Database::class, function (Container $container) &#123; return new MySQLDatabase(MYSQL_HOST, MYSQL_PORT, MYSQL_USER, MYSQL_PASS);&#125;); é—­åŒ…ä¹Ÿå¯ç”¨äºå®šåˆ¶ å…·ä½“ç±» çš„å®ä¾‹åŒ–æ–¹å¼ï¼š 12345$container-&gt;bind(GitHub\\Client::class, function (Container $container) &#123; $client = new GitHub\\Client; $client-&gt;setEnterpriseUrl(GITHUB_HOST); return $client;&#125;); ç”¨æ³•äº”ï¼šResolving Callbacks (å›è°ƒ)å¯ç”¨ resolveing()æ–¹æ³•æ¥æ³¨å†Œä¸€ä¸ª callback (å›è°ƒå‡½æ•°)ï¼Œè€Œä¸æ˜¯ç›´æ¥è¦†ç›–æ‰ä¹‹å‰çš„ ç»‘å®šã€‚ è¿™ä¸ªå‡½æ•°ä¼šåœ¨ç»‘å®šçš„ç±»è§£æå®Œæˆä¹‹åè°ƒç”¨ã€‚ æ³¨æ„æ­¤æ—¶çš„å›è°ƒå‡½æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¯¹åº”è¢«è§£æçš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å®¹å™¨(container)&lt;=&gt;åº”ç”¨(app). 123$container-&gt;resolving(GitHub\\Client::class, function ($client, Container $container) &#123; $client-&gt;setEnterpriseUrl(GITHUB_HOST);&#125;); å¦‚æœæœ‰ä¸€å¤§å † callbacksï¼Œä»–ä»¬å…¨éƒ¨éƒ½ä¼šè¢«è°ƒç”¨ã€‚å¯¹äº æ¥å£ å’Œ æŠ½è±¡ç±» ä¹Ÿå¯ä»¥è¿™ä¹ˆç”¨ï¼š 1234567891011$container-&gt;resolving(Logger::class, function (Logger $logger) &#123; $logger-&gt;setLevel('debug');&#125;);$container-&gt;resolving(FileLogger::class, function (FileLogger $logger) &#123; $logger-&gt;setFilename('logs/debug.log');&#125;);$container-&gt;bind(Logger::class, FileLogger::class);$logger = $container-&gt;make(Logger::class); æ›´ diao çš„æ˜¯ï¼Œè¿˜å¯ä»¥æ³¨å†Œæˆã€Œä»€ä¹ˆç±»è§£æå®Œä¹‹åéƒ½è°ƒç”¨ã€ï¼š 123$container-&gt;resolving(function ($object, Container $container) &#123; &#x2F;&#x2F; ...&#125;); ä½†è¿™ä¸ªä¼°è®¡åªæœ‰ loggingå’Œ debugging æ‰ä¼šç”¨åˆ°ã€‚ ç”¨æ³•å…­ï¼šExtending a Class (æ‰©å±•ä¸€ä¸ªç±»)ä½¿ç”¨ extend() æ–¹æ³•ï¼Œå¯ä»¥å°è£…ä¸€ä¸ªç±»ç„¶åè¿”å›ä¸€ä¸ªä¸åŒçš„å¯¹è±¡ (ä»£ç†æ¨¡å¼)ï¼š ï¼ˆä¸ºä»€ä¹ˆä¸æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Ÿï¼Œå› ä¸ºè£…é¥°å™¨æ¨¡å¼ä¸éœ€è¦å®ç°ä¸€æ ·çš„æ¥å£ï¼Œä½†æ˜¯ä»£ç†æ¨¡å¼ä¸‹ï¼Œä»£ç†ç±»éœ€è¦å’ŒåŸæ¥çš„ç±»ä¸€æ ·å®ç°åŒä¸€æ¥å£ï¼‰. 123$container-&gt;extend(APIClient::class, function ($client, Container $container) &#123; return new APIClientProxy($client);&#125;); æ³¨æ„ï¼šè¿™ä¸¤ä¸ªç±»è¦å®ç°ç›¸åŒçš„ æ¥å£ï¼Œä¸ç„¶ç”¨ç±»å‹æç¤ºçš„æ—¶å€™ä¼šå‡ºé”™ï¼š. 12345678910111213141516171819202122232425262728293031323334353637383940414243interface Getable&#123; public function get();&#125;class APIClient implements Getable&#123; public function get() &#123; return 'yes!'; &#125;&#125;class APIClentProxy implements Getable&#123; private $client; public function __construct(APIClient $client) &#123; $this-&gt;client = $client; &#125; public function get() &#123; return 'no!'; &#125;&#125;class User&#123; private $client; public function __construct(Getable $client) &#123; $this-&gt;client = $client; &#125;&#125;$container-&gt;extend(APIClient::class, function ($client, Container $container) &#123; return new APIClentProxy($client);&#125;);$container-&gt;bind(Getable::class, APIClient::class);// æ­¤æ—¶ $instance çš„ $client å±æ€§å·²ç»æ˜¯ APIClentProxy ç±»å‹äº†$instance = $container-&gt;make(User::class); ç”¨æ³•ä¸ƒï¼šå•ä¾‹ä½¿ç”¨ bind() æ–¹æ³•ç»‘å®šåï¼Œæ¯æ¬¡è§£ææ—¶éƒ½ä¼šæ–°å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡(æˆ–é‡æ–°è°ƒç”¨é—­åŒ…)ï¼Œå¦‚æœæƒ³è·å– å•ä¾‹ ï¼Œåˆ™ç”¨ singleton() æ–¹æ³•ä»£æ›¿ bind()ï¼š 1$container-&gt;singleton(Cache::class, RedisCache::class); ç»‘å®šå•ä¾‹ é—­åŒ… 123$container-&gt;singleton(Database::class, function (Container $container) &#123; return new MySQLDatabase('localhost', 'testdb', 'user', 'pass');&#125;); ç»‘å®š å…·ä½“ç±» çš„æ—¶å€™ï¼Œä¸éœ€è¦ç¬¬äºŒä¸ªå‚æ•°ï¼š 1$container-&gt;singleton(MySQLDatabase::class); åœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œå•ä¾‹ å¯¹è±¡å°†åœ¨ç¬¬ä¸€æ¬¡éœ€è¦æ—¶åˆ›å»ºï¼Œç„¶ååœ¨åç»­é‡å¤ä½¿ç”¨ã€‚ å¦‚æœä½ å·²ç»æœ‰ä¸€ä¸ª å®ä¾‹ å¹¶ä¸”æƒ³é‡å¤ä½¿ç”¨ï¼Œå¯ä»¥ç”¨ instance() æ–¹æ³•ã€‚ 1$container-&gt;instance(Container::class, $container); Laravel å°±æ˜¯ç”¨è¿™ç§æ–¹æ³•æ¥ç¡®ä¿æ¯æ¬¡è·å–åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ª Container å®ä¾‹ï¼š ç”¨æ³•ä¸ƒï¼šArbitrary Binding Names (ä»»æ„ç»‘å®šåç§°)Container è¿˜å¯ä»¥ç»‘å®šä»»æ„å­—ç¬¦ä¸²è€Œä¸æ˜¯ ç±»/æ¥å£åç§°ã€‚ä½†è¿™ç§æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨ç±»å‹æç¤ºï¼Œå¹¶ä¸”åªèƒ½ç”¨ make() æ¥è·å–å®ä¾‹ã€‚ 12$container-&gt;bind('database', MySQLDatabase::class);$db = $container-&gt;make('database'); ä¸ºäº†åŒæ—¶æ”¯æŒç±»/æ¥å£åç§°å’ŒçŸ­åç§°ï¼Œå¯ä»¥ä½¿ç”¨ alias()ï¼š 1234567$container-&gt;singleton(Cache::class, RedisCache::class);$container-&gt;alias(Cache::class, 'cache');$cache1 = $container-&gt;make(Cache::class);$cache2 = $container-&gt;make('cache');assert($cache1 === $cache2); ç”¨æ³•å…«ï¼šä¿å­˜ä»»ä½•å€¼Container è¿˜å¯ä»¥ç”¨æ¥ä¿å­˜ä»»ä½•å€¼ï¼Œä¾‹å¦‚ configuration æ•°æ®ï¼š 12$container-&gt;instance('database.name', 'testdb');$db_name = $container-&gt;make('database.name'); å®ƒæ”¯æŒæ•°ç»„è®¿é—®è¯­æ³•ï¼Œè¿™æ ·ç”¨èµ·æ¥æ›´è‡ªç„¶ï¼š 12$container['database.name'] = 'testdb';$db_name = $container['database.name']; è¿™æ˜¯å› ä¸º Container å®ç°äº† PHP çš„ ArrayAccess æ¥å£ã€‚ å½“å¤„ç† Closure ç»‘å®šçš„æ—¶å€™ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªæ–¹å¼éå¸¸å¥½ç”¨ï¼š 12345678$container-&gt;singleton('database', function (Container $container) &#123; return new MySQLDatabase( $container['database.host'], $container['database.name'], $container['database.user'], $container['database.pass'] );&#125;); Laravel è‡ªå·±æ²¡æœ‰ç”¨è¿™ç§æ–¹å¼æ¥å¤„ç†é…ç½®é¡¹ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªå•ç‹¬çš„ Config ç±»æœ¬èº«ã€‚ PHP-DI ç”¨äº†ã€‚ æ•°ç»„è®¿é—®è¯­æ³•è¿˜å¯ä»¥ä»£æ›¿ make() æ¥å®ä¾‹åŒ–å¯¹è±¡ï¼š. 1$db = $container['database']; ç”¨æ³•ä¹ï¼šDependency Injection for Functions &amp; Methods (ç»™å‡½æ•°æˆ–æ–¹æ³•æ³¨å…¥ä¾èµ–)é™¤äº†ç»™æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼ŒLaravel è¿˜å¯ä»¥å¾€ä»»æ„å‡½æ•°ä¸­æ³¨å…¥ï¼š 12function do_something(Cache $cache) &#123; /* ... */ &#125;$result = $container-&gt;call('do_something'); å‡½æ•°çš„é™„åŠ å‚æ•°å¯ä»¥ä½œä¸ºç´¢å¼•æˆ–å…³è”æ•°ç»„ä¼ é€’ï¼š 123456789function show_product(Cache $cache, $id, $tab = 'details') &#123; /* ... */ &#125;// show_product($cache, 1)$container-&gt;call('show_product', [1]);$container-&gt;call('show_product', ['id' =&gt; 1]);// show_product($cache, 1, 'spec')$container-&gt;call('show_product', [1, 'spec']);$container-&gt;call('show_product', ['id' =&gt; 1, 'tab' =&gt; 'spec']); é™¤æ­¤ä¹‹å¤–ï¼Œé—­åŒ…ï¼š 12$closure = function (Cache $cache) &#123; /* ... */ &#125;;$container-&gt;call($closure); é™æ€æ–¹æ³•ï¼š 1234567class SomeClass&#123; public static function staticMethod(Cache $cache) &#123; /* ... */ &#125;&#125;$container-&gt;call(['SomeClass', 'staticMethod']);// or:$container-&gt;call('SomeClass::staticMethod'); å®ä¾‹çš„æ–¹æ³•ï¼š 123456789class PostController&#123; public function index(Cache $cache) &#123; /* ... */ &#125; public function show(Cache $cache, $id) &#123; /* ... */ &#125;&#125;$controller = $container-&gt;make(PostController::class);$container-&gt;call([$controller, 'index']);$container-&gt;call([$controller, 'show'], ['id' =&gt; 1]); éƒ½å¯ä»¥æ³¨å…¥ã€‚ ç”¨æ³•å: è°ƒç”¨å®ä¾‹æ–¹æ³•çš„å¿«æ·æ–¹å¼ä½¿ç”¨ ClassName@methodName è¯­æ³•å¯ä»¥å¿«æ·è°ƒç”¨å®ä¾‹ä¸­çš„æ–¹æ³•ï¼š 12$container-&gt;call('PostController@index');$container-&gt;call('PostController@show', ['id' =&gt; 4]); å› ä¸º Container è¢«ç”¨æ¥å®ä¾‹åŒ–ç±»ã€‚æ„å‘³ç€ï¼š ä¾èµ– è¢«æ³¨å…¥è¿›æ„é€ å‡½æ•°ï¼ˆæˆ–è€…æ–¹æ³•ï¼‰ï¼›å¦‚æœéœ€è¦å¤ç”¨å®ä¾‹ï¼Œå¯ä»¥å®šä¹‰ä¸ºå•ä¾‹ï¼›å¯ä»¥ç”¨æ¥å£æˆ–ä»»ä½•åç§°æ¥ä»£æ›¿å…·ä½“ç±»ã€‚æ‰€ä»¥è¿™æ ·è°ƒç”¨ä¹Ÿå¯ä»¥ç”Ÿæ•ˆï¼š 1234567class PostController&#123; public function __construct(Request $request) &#123; /* ... */ &#125; public function index(Cache $cache) &#123; /* ... */ &#125;&#125;$container-&gt;singleton('post', PostController::class);$container-&gt;call('post@index'); æœ€åï¼Œè¿˜å¯ä»¥ä¼ ä¸€ä¸ªã€Œé»˜è®¤æ–¹æ³•ã€ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ã€‚å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ²¡æœ‰æŒ‡å®šæ–¹æ³•çš„ç±»åç§°ï¼Œåˆ™å°†è°ƒç”¨é»˜è®¤æ–¹æ³•ã€‚ Laravel ç”¨è¿™ç§æ–¹å¼æ¥å¤„ç† event handlers: 1234$container-&gt;call(MyEventHandler::class, $parameters, 'handle');// ç›¸å½“äº:$container-&gt;call('MyEventHandler@handle', $parameters); ç”¨æ³•åä¸€ï¼šMethod Call Bindings (æ–¹æ³•è°ƒç”¨ç»‘å®š)bindMethod() æ–¹æ³•å¯ç”¨æ¥è¦†ç›–æ–¹æ³•ï¼Œä¾‹å¦‚ç”¨æ¥ä¼ é€’å…¶ä»–å‚æ•°ï¼š 12345$container-&gt;bindMethod('PostController@index', function ($controller, $container) &#123; $posts = get_posts(...); return $controller-&gt;index($posts);&#125;); ä¸‹é¢çš„æ–¹å¼éƒ½æœ‰æ•ˆï¼Œè°ƒç”¨é—­åŒ…æ¥ä»£æ›¿è°ƒç”¨åŸå§‹çš„æ–¹æ³•ï¼š 123$container-&gt;call('PostController@index');$container-&gt;call('PostController', [], 'index');$container-&gt;call([new PostController, 'index']); ä½†æ˜¯ï¼Œcall() çš„ä»»ä½•å…¶ä»–å‚æ•°éƒ½ä¸ä¼šä¼ é€’åˆ°é—­åŒ…ä¸­ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨å®ƒä»¬ã€‚ 1$container-&gt;call('PostController@index', ['Not used :-(']); ç”¨æ³•åäºŒï¼šContextual Bindings (ä¸Šä¸‹æ–‡ç»‘å®š)æœ‰æ—¶å€™ä½ æƒ³åœ¨ä¸åŒçš„åœ°æ–¹ç»™æ¥å£ä¸åŒçš„å®ç°ã€‚è¿™é‡Œæœ‰ Laravel æ–‡æ¡£ é‡Œçš„ä¸€ä¸ªä¾‹å­ï¼š 123456789$container -&gt;when(PhotoController::class) -&gt;needs(Filesystem::class) -&gt;give(LocalFilesystem::class);$container -&gt;when(VideoController::class) -&gt;needs(Filesystem::class) -&gt;give(S3Filesystem::class); ç°åœ¨ PhotoController å’Œ VideoController éƒ½ä¾èµ–äº† Filesystem æ¥å£ï¼Œä½†æ˜¯æ”¶åˆ°äº†ä¸åŒçš„å®ä¾‹ã€‚ å¯ä»¥åƒ bind() é‚£æ ·ï¼Œç»™ give() ä¼ é—­åŒ…ï¼š 12345-&gt;when(VideoController::class)-&gt;needs(Filesystem::class)-&gt;give(function () &#123; return Storage::disk('s3');&#125;); æˆ–è€…çŸ­åç§°ï¼š 123456$container-&gt;instance('s3', $s3Filesystem);$container -&gt;when(VideoController::class) -&gt;needs(Filesystem::class) -&gt;give('s3'); ç”¨æ³•åä¸‰ï¼šBinding Parameters to Primitives (ç»‘å®šåˆå§‹æ•°æ®)å½“æœ‰ä¸€ä¸ªç±»ä¸ä»…éœ€è¦æ¥å—ä¸€ä¸ªæ³¨å…¥ç±»ï¼Œè¿˜éœ€è¦æ³¨å…¥ä¸€ä¸ªåŸºæœ¬å€¼ï¼ˆæ¯”å¦‚æ•´æ•°ï¼‰ã€‚è¿˜å¯ä»¥é€šè¿‡å°†å˜é‡åç§° (è€Œä¸æ˜¯æ¥å£) ä¼ é€’ç»™ needs() å¹¶å°†å€¼ä¼ é€’ç»™ give() æ¥æ³¨å…¥éœ€è¦çš„ä»»ä½•å€¼ (å­—ç¬¦ä¸²ã€æ•´æ•°ç­‰) ï¼š 1234$container -&gt;when(MySQLDatabase::class) -&gt;needs('$username') -&gt;give(DB_USER); è¿˜å¯ä»¥ä½¿ç”¨é—­åŒ…å®ç°å»¶æ—¶åŠ è½½ï¼Œåªåœ¨éœ€è¦çš„æ—¶å€™å–å›è¿™ä¸ª å€¼ ã€‚ 123456$container -&gt;when(MySQLDatabase::class) -&gt;needs('$username') -&gt;give(function () &#123; return config('database.user'); &#125;); è¿™ç§æƒ…å†µä¸‹ï¼Œä¸èƒ½ä¼ é€’ç±»æˆ–å‘½åçš„ä¾èµ–å…³ç³»ï¼ˆä¾‹å¦‚ï¼Œgive(â€˜database.userâ€™)ï¼‰ï¼Œå› ä¸ºå®ƒå°†ä½œä¸ºå­—é¢å€¼è¿”å›ã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨é—­åŒ…ï¼š 123456$container -&gt;when(MySQLDatabase::class) -&gt;needs('$username') -&gt;give(function (Container $container) &#123; return $container['database.user']; &#125;); ç”¨æ³•åå››: Tagging (æ ‡è®°)Container å¯ä»¥ç”¨æ¥ã€Œæ ‡è®°ã€æœ‰å…³ç³»çš„ç»‘å®šï¼š 12$container-&gt;tag(MyPlugin::class, 'plugin');$container-&gt;tag(AnotherPlugin::class, 'plugin'); è¿™æ ·ä¼šä»¥æ•°ç»„çš„å½¢å¼å–å›æ‰€æœ‰ã€Œæ ‡è®°ã€çš„å®ä¾‹ï¼š 123foreach ($container-&gt;tagged('plugin') as $plugin) &#123; $plugin-&gt;init();&#125; tag() æ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°éƒ½å¯ä»¥æ¥å—æ•°ç»„ï¼š 12$container-&gt;tag([MyPlugin::class, AnotherPlugin::class], 'plugin');$container-&gt;tag(MyPlugin::class, ['plugin', 'plugin.admin']);","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"Laravel","slug":"Laravel","permalink":"http://blog.crazylaw.cn/tags/Laravel/"}]},{"title":"ã€OpenRestyã€‘ å¸¦ä½ å…¥é—¨é«˜æ€§èƒ½httpä»£ç†æœåŠ¡å™¨åº”ç”¨","slug":"openresty-1","date":"2018-07-07T16:23:00.000Z","updated":"2021-03-20T16:25:01.812Z","comments":true,"path":"2018/07/08/openresty-1/","link":"","permalink":"http://blog.crazylaw.cn/2018/07/08/openresty-1/","excerpt":"å‰è¨€OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginx ä¸ Lua çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œå…¶å†…éƒ¨é›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—ä»¥åŠå¤§å¤šæ•°çš„ä¾èµ–é¡¹ã€‚ç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚ OpenRestyÂ® é€šè¿‡æ±‡èšå„ç§è®¾è®¡ç²¾è‰¯çš„ Nginx æ¨¡å—ï¼ˆä¸»è¦ç”± OpenResty å›¢é˜Ÿè‡ªä¸»å¼€å‘ï¼‰ï¼Œä»è€Œå°† Nginx æœ‰æ•ˆåœ°å˜æˆä¸€ä¸ªå¼ºå¤§çš„é€šç”¨ Web åº”ç”¨å¹³å°ã€‚è¿™æ ·ï¼ŒWeb å¼€å‘äººå‘˜å’Œç³»ç»Ÿå·¥ç¨‹å¸ˆå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬è¯­è¨€è°ƒåŠ¨ Nginx æ”¯æŒçš„å„ç§ C ä»¥åŠ Lua æ¨¡å—ï¼Œå¿«é€Ÿæ„é€ å‡ºè¶³ä»¥èƒœä»» 10K ä¹ƒè‡³ 1000K ä»¥ä¸Šå•æœºå¹¶å‘è¿æ¥çš„é«˜æ€§èƒ½ Web åº”ç”¨ç³»ç»Ÿã€‚ OpenRestyÂ® çš„ç›®æ ‡æ˜¯è®©ä½ çš„ Web æœåŠ¡ç›´æ¥è·‘åœ¨ Nginx æœåŠ¡å†…éƒ¨ï¼Œå……åˆ†åˆ©ç”¨ Nginx çš„éé˜»å¡ I/O æ¨¡å‹ï¼Œä¸ä»…ä»…å¯¹ HTTP å®¢æˆ·ç«¯è¯·æ±‚,ç”šè‡³äºå¯¹è¿œç¨‹åç«¯è¯¸å¦‚ MySQLã€PostgreSQLã€Memcached ä»¥åŠ Redis ç­‰éƒ½è¿›è¡Œä¸€è‡´çš„é«˜æ€§èƒ½å“åº”ã€‚ ä»¥ä¸Šéƒ½æ˜¯å®˜æ–¹è¯´è¾","text":"å‰è¨€OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginx ä¸ Lua çš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œå…¶å†…éƒ¨é›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—ä»¥åŠå¤§å¤šæ•°çš„ä¾èµ–é¡¹ã€‚ç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚ OpenRestyÂ® é€šè¿‡æ±‡èšå„ç§è®¾è®¡ç²¾è‰¯çš„ Nginx æ¨¡å—ï¼ˆä¸»è¦ç”± OpenResty å›¢é˜Ÿè‡ªä¸»å¼€å‘ï¼‰ï¼Œä»è€Œå°† Nginx æœ‰æ•ˆåœ°å˜æˆä¸€ä¸ªå¼ºå¤§çš„é€šç”¨ Web åº”ç”¨å¹³å°ã€‚è¿™æ ·ï¼ŒWeb å¼€å‘äººå‘˜å’Œç³»ç»Ÿå·¥ç¨‹å¸ˆå¯ä»¥ä½¿ç”¨ Lua è„šæœ¬è¯­è¨€è°ƒåŠ¨ Nginx æ”¯æŒçš„å„ç§ C ä»¥åŠ Lua æ¨¡å—ï¼Œå¿«é€Ÿæ„é€ å‡ºè¶³ä»¥èƒœä»» 10K ä¹ƒè‡³ 1000K ä»¥ä¸Šå•æœºå¹¶å‘è¿æ¥çš„é«˜æ€§èƒ½ Web åº”ç”¨ç³»ç»Ÿã€‚ OpenRestyÂ® çš„ç›®æ ‡æ˜¯è®©ä½ çš„ Web æœåŠ¡ç›´æ¥è·‘åœ¨ Nginx æœåŠ¡å†…éƒ¨ï¼Œå……åˆ†åˆ©ç”¨ Nginx çš„éé˜»å¡ I/O æ¨¡å‹ï¼Œä¸ä»…ä»…å¯¹ HTTP å®¢æˆ·ç«¯è¯·æ±‚,ç”šè‡³äºå¯¹è¿œç¨‹åç«¯è¯¸å¦‚ MySQLã€PostgreSQLã€Memcached ä»¥åŠ Redis ç­‰éƒ½è¿›è¡Œä¸€è‡´çš„é«˜æ€§èƒ½å“åº”ã€‚ ä»¥ä¸Šéƒ½æ˜¯å®˜æ–¹è¯´è¾ å®è·µè¿™é‡Œæˆ‘ä½¿ç”¨éƒ½ mac ç³»ç»Ÿéƒ½ brew å®‰è£…éƒ½ openrestyï¼Œç±»ä¼¼äº centos ä¸‹éƒ½ yum å®‰è£…ã€‚é»˜è®¤éƒ½æƒ…å†µä¸‹ï¼Œopenresty å·²ç»å¸®å¿™å®‰è£…å¥½äº† luajitï¼ˆlua è§£æå™¨ï¼‰ï¼Œå’Œ MySQLã€PostgreSQLã€Memcached ä»¥åŠ Redis ç­‰æ‰©å±•çš„ lua æ–‡ä»¶ï¼Œå…·ä½“å¦‚ä¸‹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364â”œâ”€â”€ cjson.soâ”œâ”€â”€ ngxâ”‚ â”œâ”€â”€ balancer.luaâ”‚ â”œâ”€â”€ base64.luaâ”‚ â”œâ”€â”€ errlog.luaâ”‚ â”œâ”€â”€ ocsp.luaâ”‚ â”œâ”€â”€ process.luaâ”‚ â”œâ”€â”€ re.luaâ”‚ â”œâ”€â”€ resp.luaâ”‚ â”œâ”€â”€ semaphore.luaâ”‚ â”œâ”€â”€ sslâ”‚ â”‚ â””â”€â”€ session.luaâ”‚ â””â”€â”€ ssl.luaâ”œâ”€â”€ redisâ”‚ â””â”€â”€ parser.soâ””â”€â”€ resty â”œâ”€â”€ aes.lua â”œâ”€â”€ core â”‚ â”œâ”€â”€ base.lua â”‚ â”œâ”€â”€ base64.lua â”‚ â”œâ”€â”€ ctx.lua â”‚ â”œâ”€â”€ exit.lua â”‚ â”œâ”€â”€ hash.lua â”‚ â”œâ”€â”€ misc.lua â”‚ â”œâ”€â”€ phase.lua â”‚ â”œâ”€â”€ regex.lua â”‚ â”œâ”€â”€ request.lua â”‚ â”œâ”€â”€ response.lua â”‚ â”œâ”€â”€ shdict.lua â”‚ â”œâ”€â”€ time.lua â”‚ â”œâ”€â”€ uri.lua â”‚ â”œâ”€â”€ var.lua â”‚ â””â”€â”€ worker.lua â”œâ”€â”€ core.lua â”œâ”€â”€ dns â”‚ â””â”€â”€ resolver.lua â”œâ”€â”€ limit â”‚ â”œâ”€â”€ conn.lua â”‚ â”œâ”€â”€ count.lua â”‚ â”œâ”€â”€ req.lua â”‚ â””â”€â”€ traffic.lua â”œâ”€â”€ lock.lua â”œâ”€â”€ lrucache â”‚ â””â”€â”€ pureffi.lua â”œâ”€â”€ lrucache.lua â”œâ”€â”€ md5.lua â”œâ”€â”€ memcached.lua â”œâ”€â”€ mysql.lua â”œâ”€â”€ random.lua â”œâ”€â”€ redis.lua â”œâ”€â”€ sha.lua â”œâ”€â”€ sha1.lua â”œâ”€â”€ sha224.lua â”œâ”€â”€ sha256.lua â”œâ”€â”€ sha384.lua â”œâ”€â”€ sha512.lua â”œâ”€â”€ string.lua â”œâ”€â”€ upload.lua â”œâ”€â”€ upstream â”‚ â””â”€â”€ healthcheck.lua â””â”€â”€ websocket â”œâ”€â”€ client.lua â”œâ”€â”€ protocol.lua â””â”€â”€ server.lua æˆ‘ä»¬éœ€è¦åšçš„æ­¥éª¤å¾ˆç®€å•ã€‚æ‰¾åˆ°é…ç½®æ–‡ä»¶ã€‚ ç„¶åéœ€è¦å…³æ³¨çš„ä¸»è¦ç›®å½•åªæœ‰ 1 ä¸ªã€‚ lualib ï¼Œä¸Šå›¾ä¸­çš„ tree ç»“æ„å°±æ˜¯ç”±è¿™ä¸ªç›®å½•ä¸‹æ˜¾ç¤ºçš„ã€‚ æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å¯¹åº” openresty çš„ nginx å¯åŠ¨çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ æˆ‘ä»¬è¿›å…¥åˆ°binç›®å½•ã€‚ å‘ç°äº† openrestry è¿™ä¸ªè½¯è¿æ¥ï¼ŒæŒ‡å‘åˆ°æ˜¯æˆ‘ä»¬ä¸Šçº§ç›®å½• nginx ä¸­åˆ° sbin ä¸­åˆ° nginx å¯æ‰§è¡Œæ–‡ä»¶ã€‚ æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å¯¹åº”åˆ°é…ç½®æ–‡ä»¶å’Œè·¯å¾„ã€‚ 1.&#x2F;openresty -t ä»ç»“æœä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†é…ç½®æ–‡ä»¶åˆ°è·¯å¾„ï¼Œå¹¶ä¸”æ‰“å¼€é…ç½®æ–‡ä»¶ï¼Œè¿›è¡Œæ·»åŠ éƒ¨åˆ†å†…å®¹ã€‚ ï¼ˆå…¶å®å°±æ˜¯ nginx åˆ°é…ç½®ï¼Œåªä¸è¿‡éœ€è¦åŠ ä¸Šä¸€äº›å†…å®¹æ¥åŠ è½½ lua ç›¸å…³çš„åŒ…å’Œæ‰©å±•ï¼‰ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸Šè¿™ 2 è¡Œä»£ç ï¼Œè¿™æ˜¯ lua çš„æ ‡å‡†é…ç½®ã€‚ 123# luaé…ç½®lua_package_path &quot;&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openresty&#x2F;lualib&#x2F;?.lua;;&quot;; #lua æ¨¡å—lua_package_cpath &quot;&#x2F;usr&#x2F;local&#x2F;opt&#x2F;openresty&#x2F;lualib&#x2F;?.so;;&quot;; #cæ¨¡å— é‡Œé¢çš„è·¯å¾„å°±æ˜¯åˆšæ‰æˆ‘ä»¬æ‰¾åˆ°çš„lualibçš„è·¯å¾„ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯;;å‘¢ï¼Œè¿™é‡Œä»£è¡¨ç€æ‰¾çš„æ˜¯ 2 ä¸ªè·¯å¾„ï¼Œä¸€ä¸ªæ˜¯é»˜è®¤è·¯å¾„ï¼Œä¸€ä¸ªæ˜¯æŒ‡å®šè·¯å¾„ã€‚ å†™å®Œä¹‹åï¼Œå°±å¯ä»¥å†™æˆ‘ä»¬çš„ lua ä»£ç äº†ã€‚ è¿™é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªserveræ®µï¼Œç«¯å£è®¾ç½®ä¸º8080ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯charset utf-8;ï¼Œè¿™ä¸ªé…ç½®é¡¹åŠ¡å¿…å†™ä¸Šï¼Œå¦åˆ™åœ¨ä½  lua ä»£ç ä¸­è¾“å‡ºçš„ä¸­æ–‡ï¼Œå°†ä¼šä¹±ç ã€‚ ç„¶åæˆ‘ä»¬é…ç½®äº† locationï¼Œè®¾ç½®äº†é»˜è®¤çš„å“åº”ç±»å‹ä¸º text/html. lua_code_cache offè¿™ä¸ªä¹Ÿæ˜¯ååˆ†é‡è¦çš„ï¼Œåœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬æ·»åŠ ä¸Šè¿™å¥è¯ï¼Œæˆ‘ä»¬å°±ä¸å¿…æ¯æ¬¡å†™å®Œ lua æ–‡ä»¶éƒ½é‡å¯ä¸€é nginxï¼Œè¿™é‡Œå¦‚æœæ²¡æœ‰ cache éƒ½è¯ï¼Œæ¯æ¬¡éƒ½ä¼šå»ç”±äº luajit æ¥ä»å¤´è§£æä¸€é luaï¼Œç±»ä¼¼äºæˆ‘ä»¬ php ä¸­éƒ½ opcache éƒ½ä½œç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒåŠ¡å¿…è®¾ç½®ä¸º onï¼Œæˆ–è€…åˆ æ‰è¿™å¥è¯ï¼ˆé»˜è®¤ä¸º:lua_code_cache onï¼‰ã€‚ æ¥ä¸‹æ¥å°±æ˜¯ nginx é…ç½®ä¸­ï¼ŒæŒ‚è½½ lua æ–‡ä»¶éƒ½ä¸€ä¸ªé‡è¦è¯­å¥äº†ï¼Œé‚£å°±æ˜¯content_by_lua_fileï¼Œè¿™é‡Œæˆ‘ä»¬éƒ½è„šæœ¬è¯­è¨€ lua å°±å¯ä»¥åµŒå…¥åˆ° nginx ä¸­å»äº†ã€‚ æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘å†™åˆ°ä¸€ä¸ªå’Œredisé€šä¿¡åˆ°ä¸€ä¸ªä¾‹å­ã€‚ 12345678910111213141516171819202122232425262728local redis &#x3D; require &quot;resty.redis&quot;local red &#x3D; redis:new()red:set_timeout(1000)local ok, err &#x3D; red:connect(&quot;127.0.0.1&quot;, 6379)if not ok then ngx.say(&quot;failed to connect: &quot;, err) returnendlocal clientIp &#x3D; ngx.req.get_headers()[&quot;X-Real-Ip&quot;]if clientIP &#x3D;&#x3D; nil then clientIp &#x3D; ngx.req.get_headers()[&quot;x_forwarded_for&quot;]endif clientIP &#x3D;&#x3D; nil then clientIP &#x3D; ngx.var.remote_addrendlocal incrKey &#x3D; &quot;user:&quot;..clientIP..&quot;:freq&quot;local blockKey &#x3D; &quot;user:&quot;..clientIP..&quot;:block&quot;local is_block,err &#x3D; red:get(blockKey)if tonumber(is_block) &#x3D;&#x3D; 1 then ngx.say(blockKey..&quot;ä½ è¢«é™æµäº†ï¼&quot;) ngx.exit(ngx.HTTP_FORBIDDEN)endngx.say(blockKey..&quot;è°ƒç”¨æˆåŠŸï¼&quot;) å…·ä½“åˆ° lua è¯­æ³•å°±ä¸è¯¦ç»†è¯´æ˜äº†ï¼Œè¿™é‡Œéœ€è¦å¤§å®¶å»å­¦ä¸€ä¸‹ lua çš„åŸºæœ¬è¯­æ³•ã€‚ å½“æˆ‘ä»¬æ‰§è¡Œçš„æ—¶å€™ï¼Œå°±å¯ä»¥çœ‹åˆ°äº†è¿™ä¹ˆä¸€ä¸²ä¸œè¥¿äº†ï¼Œå½“æˆ‘åœ¨ redis ä¸­è®¾ç½®å¯¹åº”å½“ key å½“æ—¶å€™ã€‚ æˆ‘ä»¬å†æ¥è®¿é—®ä¸€ä¸‹ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‘ç°ï¼Œæœ‰å˜åŒ–äº†ã€‚ ç»è¿‡è¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°±å¯ä»¥æƒ³åˆ°ï¼Œæˆ‘ä»¬ç»å¸¸è¯´åœ¨è¦ http ä»£ç†æœåŠ¡å™¨ä¸­å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæˆ–è€…ä¸€äº›é«˜å¹¶å‘ä¾‹å¦‚ç§’æ€ç­‰æ‹¦æˆªçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥å€ŸåŠ© openresty æ¥è¿›è¡Œä¸€ä¸ªæµé‡å‰Šå³°ï¼Œç­‰è¯·æ±‚çœŸæ­£åˆ°è¾¾æˆ‘ä»¬ç­‰ä¸‹æ¸¸æœåŠ¡å™¨ç­‰æ—¶å€™ï¼Œçˆ†ç‚¸äº†è¯·æ±‚å·²ç»è¢«è¿‡æ»¤æ‰äº† 80%æ— ç”¨çš„è¯·æ±‚ã€‚","categories":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/categories/Nginx/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"},{"name":"Openresty","slug":"Openresty","permalink":"http://blog.crazylaw.cn/tags/Openresty/"}]},{"title":"ã€è¿›åˆ¶ã€‘æ•°æ®åº“åº”ç”¨","slug":"jinzhi-1","date":"2018-05-10T15:05:00.000Z","updated":"2021-03-20T16:25:01.806Z","comments":true,"path":"2018/05/10/jinzhi-1/","link":"","permalink":"http://blog.crazylaw.cn/2018/05/10/jinzhi-1/","excerpt":"æ¦‚è¦ æœ€è¿‘åŠ äº†ä¸€ä¸ªæœˆçš„ç­ï¼Œå¾ˆå¿™ï¼Œåšå®¢å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å†™äº†ï¼Œå¿ƒé‡Œå¾ˆä¸æ˜¯æ»‹å‘³ï¼Œä»Šæ™šå†³å¿ƒï¼Œå†æ™šï¼Œä¹Ÿè¦å†™ä¸€ç¯‡ã€‚ æˆ‘ä»¬å¹³æ—¶å„ç§ç³»ç»Ÿæœ€å¸¸æ‰“äº¤é“çš„ç³»ç»Ÿå°±æ˜¯æ•°æ®åº“äº†ï¼Œæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­ï¼Œå¯èƒ½å°±æ˜¯æœ€ç›´è§‚ï¼Œæœ€ç›´æ¥çš„ç”¨æ³•ï¼Œå¾ˆå°‘ç”¨åˆ°ä¸€äº›è¿›åˆ¶ç›¸å…³çš„çŸ¥è¯†åœ¨é‡Œé¢ï¼Œå…¶å®è¿›åˆ¶åœ¨æˆ‘ä»¬çš„ç”Ÿæ´»ä¸­å¤„å¤„éƒ½åœ¨æ¸—é€ï¼Œä»Šå¤©æˆ‘ä»¬é‡ç‚¹æ•´ç†ä¸€ä¸‹æ•°æ®åº“å’Œè¿›åˆ¶ç›¸å…³çš„å†…å®¹ã€‚ åˆ†åº“åˆ†è¡¨æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®åº“çš„ä¼˜åŒ–ç­–ç•¥ä¹‹ä¸€å°±æ˜¯åˆ†åº“åˆ†è¡¨ï¼Œä½†æ˜¯è¿™ä¸ªåˆ†åº“åˆ†è¡¨éœ€è¦æ€ä¹ˆåˆ†æ‰ç®—å¥½å‘¢ï¼Œè¿™é‡Œæˆ‘ä¹Ÿæ²¡æœ‰æ‰“åŒ…ç¥¨è¯´æœ‰ä¸€ä¸ªå›ºå®šçš„æ¨¡å¼ï¼Œå› ä¸ºè¿™ç§æ‰€è°“çš„â€œæœ€ä¼˜â€æ˜¯è¦ç»“åˆå…·ä½“çš„éœ€æ±‚æ¥è¯´æ˜çš„ã€‚ åœ¨è¿™é‡Œæˆ‘ä¼šåˆ—ä¸¾å…¶ä¸­çš„ä¸€äº›åœºæ™¯æ¥å…·ä½“è¯´ä¸€ä¸‹ã€‚å¤§éƒ¨åˆ†å…¬å¸çš„è®¢å•å·æ‰€ä»¥æ²¡æœ‰ä¸€ä¸ªå¥½çš„æ¶æ„å¸ˆæˆ–è€…æ¯”è¾ƒèµ„æ·±çš„ç¨‹åºå‘˜ï¼Œè®¢å•å·ä¸€èˆ¬éƒ½æ˜¯æœ€å®¹æ˜“å¿½ç•¥çš„ä¸€ä¸ªå…³é”®ï¼Œä¸€èˆ¬æ¯•ä¸šç”Ÿæˆ–è€…åˆå­¦è€…éƒ½ä¼šæŠŠè®¢å•å·è®¾ç½®æˆç®€å•çš„ int å¹¶ä¸” autoincreaseï¼Œè¿™æ ·å­çš„åšæ³•ï¼Œç®€å•ç²—æš´æœ‰æ•ˆï¼Œå®šä¹‰å¥½äº†ä¹‹åå°±å¯ä»¥æ’¸èµ·è¢–å­å¹²äº†ã€‚","text":"æ¦‚è¦ æœ€è¿‘åŠ äº†ä¸€ä¸ªæœˆçš„ç­ï¼Œå¾ˆå¿™ï¼Œåšå®¢å·²ç»æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰å†™äº†ï¼Œå¿ƒé‡Œå¾ˆä¸æ˜¯æ»‹å‘³ï¼Œä»Šæ™šå†³å¿ƒï¼Œå†æ™šï¼Œä¹Ÿè¦å†™ä¸€ç¯‡ã€‚ æˆ‘ä»¬å¹³æ—¶å„ç§ç³»ç»Ÿæœ€å¸¸æ‰“äº¤é“çš„ç³»ç»Ÿå°±æ˜¯æ•°æ®åº“äº†ï¼Œæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­ï¼Œå¯èƒ½å°±æ˜¯æœ€ç›´è§‚ï¼Œæœ€ç›´æ¥çš„ç”¨æ³•ï¼Œå¾ˆå°‘ç”¨åˆ°ä¸€äº›è¿›åˆ¶ç›¸å…³çš„çŸ¥è¯†åœ¨é‡Œé¢ï¼Œå…¶å®è¿›åˆ¶åœ¨æˆ‘ä»¬çš„ç”Ÿæ´»ä¸­å¤„å¤„éƒ½åœ¨æ¸—é€ï¼Œä»Šå¤©æˆ‘ä»¬é‡ç‚¹æ•´ç†ä¸€ä¸‹æ•°æ®åº“å’Œè¿›åˆ¶ç›¸å…³çš„å†…å®¹ã€‚ åˆ†åº“åˆ†è¡¨æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°æ®åº“çš„ä¼˜åŒ–ç­–ç•¥ä¹‹ä¸€å°±æ˜¯åˆ†åº“åˆ†è¡¨ï¼Œä½†æ˜¯è¿™ä¸ªåˆ†åº“åˆ†è¡¨éœ€è¦æ€ä¹ˆåˆ†æ‰ç®—å¥½å‘¢ï¼Œè¿™é‡Œæˆ‘ä¹Ÿæ²¡æœ‰æ‰“åŒ…ç¥¨è¯´æœ‰ä¸€ä¸ªå›ºå®šçš„æ¨¡å¼ï¼Œå› ä¸ºè¿™ç§æ‰€è°“çš„â€œæœ€ä¼˜â€æ˜¯è¦ç»“åˆå…·ä½“çš„éœ€æ±‚æ¥è¯´æ˜çš„ã€‚ åœ¨è¿™é‡Œæˆ‘ä¼šåˆ—ä¸¾å…¶ä¸­çš„ä¸€äº›åœºæ™¯æ¥å…·ä½“è¯´ä¸€ä¸‹ã€‚å¤§éƒ¨åˆ†å…¬å¸çš„è®¢å•å·æ‰€ä»¥æ²¡æœ‰ä¸€ä¸ªå¥½çš„æ¶æ„å¸ˆæˆ–è€…æ¯”è¾ƒèµ„æ·±çš„ç¨‹åºå‘˜ï¼Œè®¢å•å·ä¸€èˆ¬éƒ½æ˜¯æœ€å®¹æ˜“å¿½ç•¥çš„ä¸€ä¸ªå…³é”®ï¼Œä¸€èˆ¬æ¯•ä¸šç”Ÿæˆ–è€…åˆå­¦è€…éƒ½ä¼šæŠŠè®¢å•å·è®¾ç½®æˆç®€å•çš„ int å¹¶ä¸” autoincreaseï¼Œè¿™æ ·å­çš„åšæ³•ï¼Œç®€å•ç²—æš´æœ‰æ•ˆï¼Œå®šä¹‰å¥½äº†ä¹‹åå°±å¯ä»¥æ’¸èµ·è¢–å­å¹²äº†ã€‚ æˆ‘ä»¬ä¸€èˆ¬çš„è®¢å•ç»“æ„éƒ½ä¼šé¢ä¸´å‡ ä¸ªéœ€æ±‚ é€šè¿‡ orderId æŸ¥è¯¢è®¢å•ï¼Œç»å¤§å¤šæ•°éƒ½æ˜¯è¿™ç±»éœ€æ±‚ï¼ˆwhere orderId = :orderIdï¼‰ æŸä¸ªç”¨æˆ·è¦æŸ¥æ‰¾è‡ªå·±çš„è®¢å•ä¿¡æ¯(where userId = :userId) æœç´¢è®¢å•æ•°æ®æ˜¯ä¸€ä¸ªé«˜é¢‘çš„éœ€æ±‚ï¼Œæ•°æ®é‡å¤§äº†ä¹‹åï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿæ…¢æŸ¥è¯¢ï¼Œåœ¨é«˜ååé‡ï¼Œåˆè¦ä¿è¯æœåŠ¡é«˜å¯ç”¨ï¼Œæˆ‘ä»¬æœ‰æ²¡æœ‰ä¸€äº›æ‰‹æ®µå¯ä»¥ä¼˜åŒ–ä¸€ä¸‹ï¼Ÿç­”æ¡ˆæœ‰ï¼šåˆ†åº“åˆ†è¡¨ã€‚ ç®€å•çš„åˆ†åº“åˆ†è¡¨æ–¹æ³• ï¼ˆåœ¨ç´¢å¼•è¡¨å’Œè¯¦æƒ…è¡¨éƒ½åœ¨ä¸€èµ·çš„æƒ…å†µä¸‹ï¼‰é€šè¿‡ OrderId æ±‚ä½™ï¼Œä¾‹å¦‚ OrderId%10ï¼Œé‚£ä¹ˆçš„å‡ºæ¥çš„ç»“æœå°±æ˜¯[0-9]åä½æ•°ï¼Œç„¶åæˆ‘ä»¬çš„åº“æˆ–è€…è¡¨å°±é€šè¿‡è¿™ä¹ˆä¸€ä¸ª[0-9 åŠ ç›¸åº”çš„åç¼€]ï¼Œè¿™æ ·å­æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡ç®€å•çš„ OrderId%10 ä¹‹åï¼Œæ‰¾åˆ°å¯¹åº”çš„åº“æˆ–è€…è¡¨æ¥è¿›è¡ŒæŸ¥è¯¢ï¼Œéç§‘å­¦çš„æ¯”å–»ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æŠŠä¸€ä¸ªè€—æ—¶ 100s çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œæœ€åç”¨äº† 10s æ¥å®Œæˆï¼Œåœ¨æŸ¥è¯¢ä¸Šæˆ‘ä»¬é€šè¿‡ç±»ä¼¼äºåˆ†åŒºçš„æ¦‚å¿µï¼Œæ¥æå‡äº†æˆ‘ä»¬æŸ¥è¯¢ sql çš„æ€§èƒ½ã€‚ æˆ–è®¸ä¹äºæ€è€ƒçš„åŒå­¦å¼€å§‹å‘ç°é—®é¢˜äº†ï¼Œè¿™æ ·å­åšçš„ç»“æœå°±æ˜¯å¦‚æœæˆ‘è¦æ‰¾â€œæˆ‘çš„è®¢å•â€å‘¢ï¼Ÿæ€ä¹ˆåŠï¼Ÿæ²¡é”™ï¼Œè¿™å°±æ˜¯åˆ†åº“æˆ–è€…åˆ†è¡¨çš„ä¸€ä¸ªæœ€å¤§çš„å¼Šç«¯ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¯èƒ½ä½ å°±è¦é€šè¿‡éå†æ‰€æœ‰çš„è¡¨æ¥æŸ¥è¯¢â€œæˆ‘çš„è®¢å•â€äº†ï¼Œå› ä¸ºåŸºäº OrderId çš„åˆ†åº“åˆ†è¡¨åœ¨ UserId ä¸Šä¸€ç‚¹å…³ç³»éƒ½æ²¡æœ‰ã€‚ é‚£ä¹ˆæˆ‘åè¿‡æ¥æ€è€ƒä¸€ä¸‹ï¼Œé‚£æˆ‘æ¢ä¸€ç§æ€ç»´ï¼Œç”¨ UserId åˆ†åº“åˆ†è¡¨å‘¢ï¼Œè¿™ä¸ªæ—¶å€™ç¡®å®æ˜¯å¯ä»¥å¿«é€ŸæŸ¥è¯¢åˆ°äº†â€œæˆ‘çš„è®¢å•â€ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæ˜¯è¦é€šè¿‡ OrderId æ¥æŸ¥æ•°æ®å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™å°±æƒ¨äº†ï¼Œä½ å¯èƒ½è¿˜æ˜¯éœ€è¦éå†å…¨é‡æ•°æ®æ¥æ‰¾åˆ°è¿™ä¸ªæ•°æ®ï¼Œè¿æ°”å¥½çš„è¯ï¼Œå¯èƒ½å°±åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„æ—¶å€™åˆšå¥½å°±æŸ¥åˆ°äº†ï¼Œè¿æ°”ä¸å¥½çš„è¯ï¼Œå¯èƒ½å°±æ˜¯æŸ¥å…¨é‡æ•°æ®äº†ã€‚ åŸºå› æ³•é¡¾åæ€ä¹‰ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦å°†çš„å°±æ˜¯å’Œâ€œåŸºå› â€æœ‰å…³ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æŠŠ UserId å’Œ OrderId é€šè¿‡æŸç§æ–¹å¼è®©ä»–ä»¬äº§ç”Ÿå…³è”ã€‚ ä¸¾ä¸ªå…·ä½“çš„ä¾‹å­ï¼š OrderId = 32 ï¼Œ UserId = 666ï¼ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çš„åˆ†åº“æ ‡å¿—æ˜¯ UserId çš„æœ€åä¸€ä¸ªåè¿›åˆ¶ä½ï¼Œä¹Ÿå°±æ˜¯ 6ï¼‰ æˆ‘ä»¬çš„ orderId æ˜¯ä¸æ˜¯å¯ä»¥*100ï¼Œç„¶å+666ï¼Ÿ ç»“æœï¼š32666ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘çš„éœ€æ±‚çš„é€šè¿‡ UserId æ¥çš„è¯ï¼Œé‚£å°±æˆªå–æœ€åä¸€ä½ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥å¿«é€ŸæŸ¥è¯¢ï¼Ÿæ˜¯çš„ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æ»¡è¶³â€œæˆ‘çš„è®¢å•â€ï¼Œâ€œå¯¹åº”çš„ OrderIdâ€ï¼Œè½åœ¨äº†åŒä¸€ä¸ªè¡¨é‡Œé¢äº†ã€‚ æˆ–è®¸ï¼ï¼ï¼ä½ ä»¥ä¸ºè¿™å°±å®Œäº†ï¼Œå–„äºæ€è€ƒçš„åŒå­¦è¿™ä¸ªæ—¶å€™å‘ç°é—®é¢˜äº†ï¼Œè¿™æ ·å­çš„åšæ³•ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¼šè®©æˆ‘çš„ OrderId çš„å­—æ®µè¿…é€Ÿè¾¾åˆ°æœ€å¤§å€¼ï¼Œæˆ–è®¸ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä½ å°±è¦è€ƒè™‘ bigint äº†ï¼Œå†ä¸æµï¼Œæœ‰å¯èƒ½ç¢ç‰ OrderId å’Œ UserID çš„å¢åŠ ï¼Œè¿™ä¸ªå€¼æœ‰å¯èƒ½è¿ bigint éƒ½å­˜ä¸ä¸‹äº†ã€‚è¿™ç®€ç›´å°±æ˜¯ä¸ªç¾éš¾ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œæˆ–è®¸ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥æ¢ä¸€ç§æ€ç»´ï¼Œåˆ©ç”¨äºŒè¿›åˆ¶å‘¢ï¼Ÿæˆ‘ä»¬è¦è€ƒè™‘åˆ°è¿™ä¸€ç‚¹çš„å‰ææ˜¯åè¿›åˆ¶å’ŒäºŒè¿›åˆ¶çš„å…³ç³»ï¼Œåè¿›åˆ¶å’ŒäºŒè¿›åˆ¶æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Œåè¿›åˆ¶æ˜¯é€¢åè¿›ä¸€ï¼ŒäºŒè¿›åˆ¶æ˜¯é€¢äºŒè¿›ä¸€ï¼Œæˆ–è®¸è¿™ä¸ªæ—¶å€™ä½ è¿˜å¥½æ²¡æœ‰å‘ç°å¥‡å¦™çš„åœ°æ–¹ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šä¸€ä¸ªåè¿›åˆ¶çš„ 9ï¼Œè½¬æˆäºŒè¿›åˆ¶å°±æ˜¯ 1001 æ¥ç€ä¸Šé¢çš„ä¾‹å­ã€‚ OrderId = 32 ï¼Œ UserId = 17 OrderId äºŒè¿›åˆ¶å°±æ˜¯ï¼š100000 UserId äºŒè¿›åˆ¶å°±æ˜¯ï¼š10001 æˆ‘ä»¬å¯¹ UserId%16ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒUserId å¾—åˆ°çš„ç»“æœåˆ 16 ç§å¯èƒ½[0-15] è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“ 16 ä¸€å…±æ˜¯ 4bitï¼Œæˆ‘ä»¬æŠŠè¿™ 4bit æ‹¼æ¥åˆ° 100000 åé¢ï¼Œé‚£å°±æ˜¯ï¼š10 0000 0001 ï¼Œåè¿›åˆ¶çš„å†™æ³•ä¹Ÿå°±æ˜¯è¯´(32 &lt;&lt; 4) | 1 ç»“æœç­‰äº 513ã€‚ (32 &lt;&lt; 4) | 1 è¯¦è§£ï¼š&lt;&lt; 4 ä»£è¡¨å‘å·¦ç§»åŠ¨ 4 ä½ï¼Œå¾€é«˜ä½ç§»åŠ¨ï¼Œ| 1 æ˜¯å› ä¸º 0001 çš„åè¿›åˆ¶æ˜¯ 1ï¼Œå¹¶ä¸”æˆ‘ä»¬ç›¸åŠ æ˜¯é€šè¿‡é€»è¾‘æˆ–å®Œæˆã€‚ æˆ‘ä»¬è¯•ä¸€ä¸‹ï¼š 513 % 16 = 1 17 % 16 = 1 è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†äºŒè¿›åˆ¶çš„åŸºå› æ³•ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœä¸‹äº†å¾ˆå¤šçš„ç©ºé—´ï¼Œå› ä¸ºä¸€ä¸ª int æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œ32 ä½ã€‚æœ€å¤§å€¼å°±æ˜¯ 2 çš„ 32 æ¬¡æ–¹-1ï¼Œå¦‚æœä¸æ”¾å¿ƒçš„è¯ç”¨ bitintï¼ŒåŸºæœ¬ä¸Šæ˜¯è‚¯å®šå¤Ÿäº†ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬çš„æ ‡å¿—ä½éƒ½æ˜¯ 1ï¼Œé‚£ä¹ˆä¹…å¯ä»¥åœ¨åŒä¸€ä¸ªè¡¨ä¸­æŸ¥è¯¢æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼ å¦‚æœåœ¨åŠ å¤šä¸€ç§å±æ€§ï¼Œé‚£ä¹ˆå¯èƒ½å°±éœ€è¦é‡‡ç”¨å†—ä½™çš„æ–¹æ³•æ¥äº†ï¼Œä¸€èˆ¬åŸºå› æ³•ç”¨äº 1 å¯¹å¤šçš„åœºæ™¯ï¼Œå¸¸åœ¨å¤šçš„ä¸€æ–¹åµŒå…¥ 1 çš„åŸºå› ã€‚ å•å­—æ®µå­˜å‚¨å¤šä¸ª 0-1 å…³ç³»çš„å±æ€§â€¦åç»­è¡¥å……","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"è¿›åˆ¶","slug":"è¿›åˆ¶","permalink":"http://blog.crazylaw.cn/tags/%E8%BF%9B%E5%88%B6/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ã€SSLã€‘ä½¿ç”¨certbotå·¥å…·ç”³è¯·letsencryptçš„sslè¯ä¹¦","slug":"nginx-certbot-ssl","date":"2018-04-08T02:55:00.000Z","updated":"2021-03-20T16:25:01.811Z","comments":true,"path":"2018/04/08/nginx-certbot-ssl/","link":"","permalink":"http://blog.crazylaw.cn/2018/04/08/nginx-certbot-ssl/","excerpt":"","text":"ç”³è¯· ssl è¯ä¹¦ä¹‹å‰ï¼Œå…ˆæ¢³ç†å‡ ä¸ªè¦ç‚¹ï¼š1ã€ç¡®å®šå¥½æ‹Ÿç”³è¯· ssl è¯ä¹¦çš„åŸŸåï¼Œè¿™é‡Œä¸ºäº†ä¾¿äºè¯´æ˜å‡è®¾ç”³è¯· ssl çš„åŸŸåä¸ºï¼ša.baicai.comï¼Œwww.baicai.comã€account.baicai.com ç­‰å…¶ä»–åŸŸåï¼ˆå’Œä¸»æœºï¼‰ï¼Œæ²¡æœ‰æœ¬è´¨ä¸Šçš„åŒºåˆ«ï¼Œä»…åç§°ä¸Šçš„å·®å¼‚ï¼› 2ã€ç¡®å®šæ‹Ÿç”³è¯· ssl è¯ä¹¦çš„åŸŸåæ­£ç¡®è§£æåˆ°å½“å‰ä¸»æœºï¼Œæœ¬ä¾‹ä¹Ÿå°±æ˜¯é€šè¿‡http://blog.crazylaw.com èƒ½å¤Ÿæ­£ç¡®è§£æåˆ°å½“å‰ä¸»æœºï¼ˆæ³¨æ„æ˜¯æ­£ç¡®è§£æï¼Œè‡³äºæ˜¯ä¸æ˜¯èƒ½æ­£ç¡®è®¿é—®ä¾æ® certbot çš„æ¨¡å¼ä¸åŒè¦æ±‚ä¹Ÿä¸åŒï¼‰ï¼› 3ã€ç¡®å®šå¥½æ‹Ÿç”³è¯· ssl è¯ä¹¦åŸŸåè§£æåˆ°å½“å‰ä¸»æœºåçš„ web æ ¹ç›®å½•ï¼Œå‡è®¾ä¸ºï¼š/www/blog/ Github ä¸Šæ‹‰å– cerbot1git clone https:&#x2F;&#x2F;github.com&#x2F;certbot&#x2F;certbot ç„¶åè¿›å…¥ 1cd cerbot æ¥ç€çœ‹åˆ°cerbot-autoçš„å¯æ‰§è¡Œæ–‡ä»¶ ç„¶åç”Ÿæˆè¯ä¹¦ã€‚ æ³¨æ„ï¼Œå¦‚æœä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨ letsencrypy çš„è¯ï¼Œä¸€èˆ¬éœ€è¦æŒ‡å®šé‚®ç®±ï¼Œå¹¶ä¸” letsencrypy ä¼šå‘é€è¯ä¹¦åˆ°ä½ çš„é‚®ç®±ï¼Œè¯·ç¡®è®¤è®¢é˜… letsencrypyï¼Œä¸‹é¢çš„å‘½ä»¤æ˜¯å¸¦ä¸Šäº†é‚®ç®±ä¿¡æ¯çš„ï¼ æ³¨æ„ï¼Œéœ€è¦æš‚æ—¶åœæ­¢ nginxï¼ standalone æ¨¡å¼ç”³è¯· ssl è¯ä¹¦standalone æ¨¡å¼ä¸éœ€è¦ä¸Šè¿°æ¢³ç†å‡ºçš„ 3 ä¸ªè¦ç‚¹ä¸­çš„ç¬¬ä¸‰æ¡ï¼Œä¹Ÿå°±æ„å‘³ç€å¦‚æœä½ çš„ä¸»æœºéœ€è¦å…³åœ 80 ç«¯å£ï¼ˆæˆ–å’Œ 443 ç«¯å£ï¼‰çš„ web æœåŠ¡ï¼Œè­¬å¦‚æ­£åœ¨è¿è¡Œçš„ nginxã€Apache éœ€è¦å…³åœã€‚ 123##standaloneæ¨¡å¼ï¼Œå…¶ä¸­-då‚æ•°æŒ‡å®šæ‹Ÿç”³è¯·sslè¯ä¹¦çš„åŸŸå #å¯ä»¥é€šè¿‡å¤šä¸ª-då‚æ•°æŒ‡å®šå¤šä¸ªåŸŸåï¼Œä½†ä½ å¾—ç¡®ä¿è¿™äº›æŒ‡å®šçš„å¤šä¸ªåŸŸåå‡èƒ½æ­£å¸¸è§£æåˆ°å½“å‰ä¸»æœº.&#x2F;certbot-auto certonly --standalone --email you@email.com -d example.com -d www.example.com -d other.example.net é standalone æ¨¡å¼ç”³è¯· ssl è¯ä¹¦è¿™ç§æ¨¡å¼éœ€è¦ä½¿ç”¨-w å‚æ•°ï¼ˆæˆ–è€…â€“webroot-path å‚æ•°ï¼‰æŒ‡å®šå½“å‰æ­£åœ¨è¿è¡Œçš„ web æœåŠ¡å™¨çš„æ ¹ç›®å½•ã€‚â€“webroot-path å‚æ•°æŒ‡å®š web æ ¹ç›®å½•åï¼Œcertbotå·¥å…·ä¼šè‡ªåŠ¨åœ¨è¯¥ç›®å½•ä¸‹ç”Ÿæˆ.well-knownçš„éšè—ç›®å½•ï¼Œä»¥åŠç”¨äºæ•ˆéªŒåŸŸåæ‰€æœ‰è€…çš„ç‰¹å®šæ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶ Letâ€™s Encrypt çš„æœåŠ¡å™¨ä¼šä¸»åŠ¨å‘èµ· http è¯·æ±‚å»è¯»å–ä»è¾¾åˆ°æ•ˆéªŒåŸŸåæ‰€æœ‰è€…æˆ–è€…ç®¡ç†è€…å°±æ˜¯æœ¬æ¬¡æ“ä½œ certbot å·¥å…·çš„äººï¼›certbot å·¥å…·è‡ªåŠ¨ç”Ÿæˆçš„å®Œæ•´ç›®å½•ä¸ºï¼š-w å‚æ•°æŒ‡å®šçš„æ ¹ç›®å½•/.well-known/acme-challengeï¼Œå¯¹äº nginx è€Œè¨€ web æ ¹ç›®å½•ä¸‹çš„éšè—ç›®å½•é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸å…è®¸è®¿é—®çš„ï¼Œæ‰€ä»¥ nginx æƒ…å†µä¸‹å†æ‰§è¡Œé standalone æ¨¡å¼ç”³è¯· ssl è¯ä¹¦ä¹‹å‰ï¼Œéœ€è¦å°†nginxç½‘ç«™æ ¹ç›®å½•ä¸‹çš„.well-knownéšè—ç›®å½•è®¾ç½®æˆå…è®¸è®¿é—®ã€‚ 12345##nginxå¯¹åº”ä¸»æœºçš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å…è®¸.well-knownéšè—ç›®å½•çš„è®¿é—®#æ³¨æ„é…ç½®æ–‡ä»¶ä¸­ç¦æ­¢æµè§ˆéšè—æ–‡ä»¶çš„ç›¸å…³ä»£ç å¼•èµ·å†²çªlocation ~ &#x2F;.well-known &#123; allow all;&#125; å¦‚æœç†Ÿæ‚‰ nginxï¼Œç”šè‡³å¯ä»¥ä¸º.well-known éšè—ç›®å½•æŒ‡å®šå•ç‹¬çš„ root å…¥å£ï¼›è¿™å°±æ˜¯ nginx æœ‰å…³çš„åˆç†åˆ©ç”¨äº†ï¼Œä¸å†è¡¥å……ã€‚ 12##--webrootæŒ‡å®šå½“å‰æ­£åœ¨è¿è¡Œçš„web serverçš„æ ¹ç›®å½•certbot certonly --webroot -w &#x2F;var&#x2F;www&#x2F; -d c1c2.test.com ä¸€èˆ¬ä½¿ç”¨ standalone æ¨¡å¼ï¼Œç»§ç»­æ¥ç€å¦‚æœä½ æ²¡è®¢é˜…è¿‡çš„è¯ï¼Œä¼šåœ¨é‚®ç®±æ”¶åˆ°é‚®ä»¶ï¼Œç„¶åä½ è¦é€‰æ‹©è®¢é˜…ã€‚æ¥ç€ä½ ä¼šçœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼Œé€‰æ‹© a å’Œ y ä¹‹åã€‚ é»˜è®¤è·¯å¾„å¦‚ä¸‹ï¼š 1234&#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;&#123;you.domain&#125;&#x2F;fullchain.pem&#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;&#123;you.domain&#125;&#x2F;privkey.pem å¦‚ä½•æ›´æ–°ï¼Ÿè¿™é‡Œæˆªå›¾å†™å¾—å¾ˆæ¸…æ¥šäº†ï¼Œå†æ‰§è¡Œä¸€æ¬¡ certbot-auto å‘½ä»¤+å‚æ•°å³å¯ï¼Œå¦‚æœä½ æƒ³å…¨éƒ¨é‡æ–°æ‰§è¡Œä¸€è¾¹çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ certbot-auto renewã€‚ nginx é…ç½®ç„¶åæˆ‘ä»¬é‡å¯ nginxï¼Œå³å¯ã€‚ï¼ å¦‚ä½•å®ç°è‡ªåŠ¨åŒ–ï¼Ÿ åœæ­¢ nginx æ‰§è¡Œ certbot-auto é‡å¯ nginx","categories":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/categories/Nginx/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"},{"name":"ssl","slug":"ssl","permalink":"http://blog.crazylaw.cn/tags/ssl/"}]},{"title":"ã€æ­£åˆ™è¡¨è¾¾å¼ã€‘- è´ªå©ªå’Œéè´ªå©ªæ¨¡å¼","slug":"regular-3","date":"2018-03-12T06:11:56.000Z","updated":"2021-03-20T16:25:01.814Z","comments":true,"path":"2018/03/12/regular-3/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/12/regular-3/","excerpt":"æ¨¡å¼ï¼šåœ¨ä½¿ç”¨ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·æ—¶ï¼Œæœ‰å‡ ç§è¡¨ç¤ºæ–¹æ³•å¯ä»¥ä½¿åŒä¸€ä¸ªè¡¨è¾¾å¼èƒ½å¤ŸåŒ¹é…ä¸åŒçš„æ¬¡æ•°ï¼Œæ¯”å¦‚ï¼šâ€{m,n}â€, â€œ{m,}â€, â€œ?â€, â€œ*â€, â€œ+â€ï¼Œå…·ä½“åŒ¹é…çš„æ¬¡æ•°éšè¢«åŒ¹é…çš„å­—ç¬¦ä¸²è€Œå®šã€‚è¿™ç§é‡å¤åŒ¹é…ä¸å®šæ¬¡æ•°çš„è¡¨è¾¾å¼åœ¨åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯å°½å¯èƒ½å¤šçš„åŒ¹é…ã€‚æ¯”å¦‚ï¼Œé’ˆå¯¹æ–‡æœ¬ â€œdxxxdxxxdâ€ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š è´ªå©ªæ¨¡å¼ï¼š è¡¨è¾¾å¼ åŒ¹é…ç»“æœ (d)(\\w+) â€œ\\w+â€ å°†åŒ¹é…ç¬¬ä¸€ä¸ª â€œdâ€ ä¹‹åçš„æ‰€æœ‰å­—ç¬¦ â€œxxxdxxxdâ€ (d)(\\w+)(d) â€œ\\w+â€ å°†åŒ¹é…ç¬¬ä¸€ä¸ª â€œdâ€ å’Œæœ€åä¸€ä¸ª â€œdâ€ ä¹‹é—´çš„æ‰€æœ‰å­—ç¬¦ â€œxxxdxxxâ€ã€‚ è™½ç„¶ â€œ\\w+â€ ä¹Ÿèƒ½å¤ŸåŒ¹é…ä¸Šæœ€åä¸€ä¸ª â€œdâ€ï¼Œä½†æ˜¯ä¸ºäº†ä½¿æ•´ä¸ªè¡¨è¾¾å¼åŒ¹é…æˆåŠŸï¼Œâ€œ\\w+â€ å¯ä»¥ â€œè®©å‡ºâ€ å®ƒæœ¬æ¥èƒ½å¤ŸåŒ¹é…çš„æœ€åä¸€ä¸ª â€œdâ€","text":"æ¨¡å¼ï¼šåœ¨ä½¿ç”¨ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·æ—¶ï¼Œæœ‰å‡ ç§è¡¨ç¤ºæ–¹æ³•å¯ä»¥ä½¿åŒä¸€ä¸ªè¡¨è¾¾å¼èƒ½å¤ŸåŒ¹é…ä¸åŒçš„æ¬¡æ•°ï¼Œæ¯”å¦‚ï¼šâ€{m,n}â€, â€œ{m,}â€, â€œ?â€, â€œ*â€, â€œ+â€ï¼Œå…·ä½“åŒ¹é…çš„æ¬¡æ•°éšè¢«åŒ¹é…çš„å­—ç¬¦ä¸²è€Œå®šã€‚è¿™ç§é‡å¤åŒ¹é…ä¸å®šæ¬¡æ•°çš„è¡¨è¾¾å¼åœ¨åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯å°½å¯èƒ½å¤šçš„åŒ¹é…ã€‚æ¯”å¦‚ï¼Œé’ˆå¯¹æ–‡æœ¬ â€œdxxxdxxxdâ€ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š è´ªå©ªæ¨¡å¼ï¼š è¡¨è¾¾å¼ åŒ¹é…ç»“æœ (d)(\\w+) â€œ\\w+â€ å°†åŒ¹é…ç¬¬ä¸€ä¸ª â€œdâ€ ä¹‹åçš„æ‰€æœ‰å­—ç¬¦ â€œxxxdxxxdâ€ (d)(\\w+)(d) â€œ\\w+â€ å°†åŒ¹é…ç¬¬ä¸€ä¸ª â€œdâ€ å’Œæœ€åä¸€ä¸ª â€œdâ€ ä¹‹é—´çš„æ‰€æœ‰å­—ç¬¦ â€œxxxdxxxâ€ã€‚ è™½ç„¶ â€œ\\w+â€ ä¹Ÿèƒ½å¤ŸåŒ¹é…ä¸Šæœ€åä¸€ä¸ª â€œdâ€ï¼Œä½†æ˜¯ä¸ºäº†ä½¿æ•´ä¸ªè¡¨è¾¾å¼åŒ¹é…æˆåŠŸï¼Œâ€œ\\w+â€ å¯ä»¥ â€œè®©å‡ºâ€ å®ƒæœ¬æ¥èƒ½å¤ŸåŒ¹é…çš„æœ€åä¸€ä¸ª â€œdâ€ ç”±æ­¤å¯è§ï¼Œâ€\\w+â€ åœ¨åŒ¹é…çš„æ—¶å€™ï¼Œæ€»æ˜¯å°½å¯èƒ½å¤šçš„åŒ¹é…ç¬¦åˆå®ƒè§„åˆ™çš„å­—ç¬¦ã€‚è™½ç„¶ç¬¬äºŒä¸ªä¸¾ä¾‹ä¸­ï¼Œå®ƒæ²¡æœ‰åŒ¹é…æœ€åä¸€ä¸ª â€œdâ€ï¼Œä½†é‚£ä¹Ÿæ˜¯ä¸ºäº†è®©æ•´ä¸ªè¡¨è¾¾å¼èƒ½å¤ŸåŒ¹é…æˆåŠŸã€‚åŒç†ï¼Œå¸¦ â€œ*â€ å’Œ â€œ{m,n}â€ çš„è¡¨è¾¾å¼éƒ½æ˜¯å°½å¯èƒ½åœ°å¤šåŒ¹é…ï¼Œå¸¦ â€œ?â€ çš„è¡¨è¾¾å¼åœ¨å¯åŒ¹é…å¯ä¸åŒ¹é…çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å°½å¯èƒ½çš„ â€œè¦åŒ¹é…â€ã€‚è¿™ ç§åŒ¹é…åŸåˆ™å°±å«ä½œ â€œè´ªå©ªâ€ æ¨¡å¼ ã€‚ éè´ªå©ªæ¨¡å¼ï¼šåœ¨ä¿®é¥°åŒ¹é…æ¬¡æ•°çš„ç‰¹æ®Šç¬¦å·åå†åŠ ä¸Šä¸€ä¸ª â€œ?â€ å·ï¼Œåˆ™å¯ä»¥ä½¿åŒ¹é…æ¬¡æ•°ä¸å®šçš„è¡¨è¾¾å¼å°½å¯èƒ½å°‘çš„åŒ¹é…ï¼Œä½¿å¯åŒ¹é…å¯ä¸åŒ¹é…çš„è¡¨è¾¾å¼ï¼Œå°½å¯èƒ½çš„ â€œä¸åŒ¹é…â€ã€‚è¿™ç§åŒ¹é…åŸåˆ™å«ä½œ â€œéè´ªå©ªâ€ æ¨¡å¼ï¼Œä¹Ÿå«ä½œ â€œå‹‰å¼ºâ€ æ¨¡å¼ã€‚å¦‚æœå°‘åŒ¹é…å°±ä¼šå¯¼è‡´æ•´ä¸ªè¡¨è¾¾å¼åŒ¹é…å¤±è´¥çš„æ—¶å€™ï¼Œä¸è´ªå©ªæ¨¡å¼ç±»ä¼¼ï¼Œéè´ªå©ªæ¨¡å¼ä¼šæœ€å°é™åº¦çš„å†åŒ¹é…ä¸€äº›ï¼Œä»¥ä½¿æ•´ä¸ªè¡¨è¾¾å¼åŒ¹é…æˆåŠŸã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼Œé’ˆå¯¹æ–‡æœ¬ â€œdxxxdxxxdâ€ ä¸¾ä¾‹ï¼š è¡¨è¾¾å¼ åŒ¹é…ç»“æœ (d)(\\w+?) â€œ\\w+?â€ å°†å°½å¯èƒ½å°‘çš„åŒ¹é…ç¬¬ä¸€ä¸ª â€œdâ€ ä¹‹åçš„å­—ç¬¦ï¼Œç»“æœæ˜¯ï¼šâ€\\w+?â€ åªåŒ¹é…äº†ä¸€ä¸ª â€œxâ€ (d)(\\w+?)(d) ä¸ºäº†è®©æ•´ä¸ªè¡¨è¾¾å¼åŒ¹é…æˆåŠŸï¼Œâ€\\w+?â€ ä¸å¾—ä¸åŒ¹é… â€œxxxâ€ æ‰å¯ä»¥è®©åè¾¹çš„ â€œdâ€ åŒ¹é…ï¼Œä»è€Œä½¿æ•´ä¸ªè¡¨è¾¾å¼åŒ¹é…æˆåŠŸã€‚å› æ­¤ï¼Œç»“æœæ˜¯ï¼šâ€\\w+?â€ åŒ¹é… â€œxxxâ€","categories":[{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/categories/%E6%AD%A3%E5%88%99/"}],"tags":[{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/tags/%E6%AD%A3%E5%88%99/"}]},{"title":"ã€æ­£åˆ™è¡¨è¾¾å¼ã€‘ - è¶…ç®€å•ç»ƒä¹ é¢˜","slug":"regular-2","date":"2018-03-12T05:58:00.000Z","updated":"2021-03-20T16:25:01.814Z","comments":true,"path":"2018/03/12/regular-2/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/12/regular-2/","excerpt":"1. åŒ¹é…ä¸€æ®µæ–‡æœ¬ä¸­çš„æ¯è¡Œçš„é‚®ç®±12345$str &#x3D; &#39;123@qq.comaaa@163.combbb@126.comasdfasfs33333@adfcom&#39;;preg_match_all(&quot;&#x2F;\\w+@(?:qq|126|163)\\.com&#x2F;&quot;, $str, $matches);var_dump($matches);","text":"1. åŒ¹é…ä¸€æ®µæ–‡æœ¬ä¸­çš„æ¯è¡Œçš„é‚®ç®±12345$str &#x3D; &#39;123@qq.comaaa@163.combbb@126.comasdfasfs33333@adfcom&#39;;preg_match_all(&quot;&#x2F;\\w+@(?:qq|126|163)\\.com&#x2F;&quot;, $str, $matches);var_dump($matches); 2. åŒ¹é…ä¸€æ®µæ–‡æœ¬ä¸­çš„æ¯è¡Œçš„æ—¶é—´å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ï¼šâ€˜1990-07-12â€™12345$str &#x3D; &#39;asfasf1990-07-12asdfAAAbbbb434241&#39;;preg_match_all(&quot;&#x2F;(?P&lt;year&gt;19[0-9]&#123;2&#125;)-(?P&lt;month&gt;\\d+)-(?P&lt;day&gt;\\d+)&#x2F;&quot;, $str, $matches);var_dump($matches); 3. åŒ¹é…ä¸€æ®µæ–‡æœ¬ä¸­çš„ 1-12 çš„å€¼12345$str &#x3D; &#39;23123156865423150506087111009&#39;;preg_match_all(&#39;&#x2F;1[0-2]|[1-9]&#x2F;&#39;,$str, $matches);var_dump($matches);","categories":[{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/categories/%E6%AD%A3%E5%88%99/"}],"tags":[{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/tags/%E6%AD%A3%E5%88%99/"}]},{"title":"ã€æ­£åˆ™è¡¨è¾¾å¼ã€‘- åˆ†ç»„æ¦‚å¿µ","slug":"regular","date":"2018-03-12T05:56:00.000Z","updated":"2021-03-20T16:25:01.814Z","comments":true,"path":"2018/03/12/regular/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/12/regular/","excerpt":"æ­£åˆ™æˆ‘ä»¬ç»å¸¸ç”¨ï¼Œä½†æ˜¯å¯¹äºå‡ ä¸ªç‰¹æ®Šçš„ç”¨é€”ï¼Œå¯ä»¥è®°å½•ä¸€ä¸‹ã€‚ (exp) åŒ¹é… exp,å¹¶æ•è·æ–‡æœ¬åˆ°è‡ªåŠ¨å‘½åçš„ç»„é‡Œ (?&lt;name&gt;exp) åŒ¹é… exp,å¹¶æ•è·æ–‡æœ¬åˆ°åç§°ä¸º name çš„ç»„é‡Œï¼Œä¹Ÿå¯ä»¥å†™æˆ(?â€™nameâ€™exp) (?P&lt;name&gt;exp) å’Œ (?&lt;name&gt;exp)ä¸€ä¸ªæ„æ€ (?:exp) åŒ¹é… exp,ä¸æ•è·åŒ¹é…çš„æ–‡æœ¬ (?=exp) åŒ¹é… exp å‰é¢çš„ä½ç½® (?&lt;=exp) åŒ¹é… exp åé¢çš„ä½ç½® (?!exp) åŒ¹é…åé¢è·Ÿçš„ä¸æ˜¯ exp çš„ä½ç½® (?&lt;!exp) åŒ¹é…å‰é¢ä¸æ˜¯ exp çš„ä½ç½® (?#comment) è¿™ç§ç±»å‹çš„ç»„ä¸å¯¹æ­£åˆ™è¡¨è¾¾å¼çš„å¤„ç†äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªæ˜¯ä¸ºäº†æä¾›è®©äººé˜…è¯»æ³¨é‡Š","text":"æ­£åˆ™æˆ‘ä»¬ç»å¸¸ç”¨ï¼Œä½†æ˜¯å¯¹äºå‡ ä¸ªç‰¹æ®Šçš„ç”¨é€”ï¼Œå¯ä»¥è®°å½•ä¸€ä¸‹ã€‚ (exp) åŒ¹é… exp,å¹¶æ•è·æ–‡æœ¬åˆ°è‡ªåŠ¨å‘½åçš„ç»„é‡Œ (?&lt;name&gt;exp) åŒ¹é… exp,å¹¶æ•è·æ–‡æœ¬åˆ°åç§°ä¸º name çš„ç»„é‡Œï¼Œä¹Ÿå¯ä»¥å†™æˆ(?â€™nameâ€™exp) (?P&lt;name&gt;exp) å’Œ (?&lt;name&gt;exp)ä¸€ä¸ªæ„æ€ (?:exp) åŒ¹é… exp,ä¸æ•è·åŒ¹é…çš„æ–‡æœ¬ (?=exp) åŒ¹é… exp å‰é¢çš„ä½ç½® (?&lt;=exp) åŒ¹é… exp åé¢çš„ä½ç½® (?!exp) åŒ¹é…åé¢è·Ÿçš„ä¸æ˜¯ exp çš„ä½ç½® (?&lt;!exp) åŒ¹é…å‰é¢ä¸æ˜¯ exp çš„ä½ç½® (?#comment) è¿™ç§ç±»å‹çš„ç»„ä¸å¯¹æ­£åˆ™è¡¨è¾¾å¼çš„å¤„ç†äº§ç”Ÿä»»ä½•å½±å“ï¼Œåªæ˜¯ä¸ºäº†æä¾›è®©äººé˜…è¯»æ³¨é‡Š ä¾‹å­æ¯”å¦‚ 12345var m = \"abcabc\".match(/(?:a)(b)(c)/)//ç»“æœ [\"abc\", \"b\", \"c\"]// m[0] æ˜¯/(?:a)(b)(c)/åŒ¹é…åˆ°çš„æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™é‡ŒåŒ…æ‹¬äº†a// m[1] æ˜¯æ•è·ç»„1ï¼Œå³(b)åŒ¹é…çš„å­å­—ç¬¦ä¸²substring or sub sequence// m[2] æ˜¯æ•è·ç»„2ï¼Œå³(c)åŒ¹é…åˆ°çš„ å¦‚æœè¿™æ · 12var m = \"abcabc\".match(/(a)(b)(c)/)//ç»“æœ [\"abc\", \"a\", \"b\", \"c\"] ç¬¬ä¸€å°é¢˜åº”è¯¥æ˜¯è¿™æ ·çš„æ­£åˆ™è¡¨è¾¾å¼ 1/(\\w)((?=111)(1))+/ è¿™é‡Œæœ‰ä¸€ä¸ªçŸ¥è¯†ç‚¹ zero-width positive lookaheadï¼Œé›¶å®½æ–­è¨€ï¼Œæ­£å‘å‰ç»ï¼ˆåæ­£æˆ‘è®°ä¸ä½æ„æ€æ˜¯(?=X)åŒ¹é…æŸä¸ªä½ç½®ï¼Œå³è¾¹ï¼ˆæ­£å‘ï¼‰æ˜¯ Xï¼Œå®ƒä¸çœŸæ­£åŒ¹é…æ•è·å­ä¸²ã€‚çœ‹å‡ ä¸ªåŒ¹é…çš„æµ‹è¯•ä¾‹å­ 12/(\\w)((?=111)(1))+/.test(\"1111\") // true/(\\w)((?=111)(1))+/.test(\"2222\") // false åŒ¹é…é‡å¤ 4 æ¬¡ä»¥ä¸Šçš„å­—æ¯æˆ–æ•°å­—å¯ä»¥è¿™ä¹ˆå†™ 12/(\\w)(?=\\1&#123;3,&#125;)/.test(\"AAAAAAAA\") //true/(\\w)(?=\\1&#123;3,&#125;)/.test(\"AAAB\") //false","categories":[{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/categories/%E6%AD%A3%E5%88%99/"}],"tags":[{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/tags/%E6%AD%A3%E5%88%99/"}]},{"title":"ã€Gitã€‘- åˆ©ç”¨git-hookå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²","slug":"git-auto-deploy","date":"2018-03-12T03:03:37.000Z","updated":"2021-03-20T16:25:01.805Z","comments":true,"path":"2018/03/12/git-auto-deploy/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/12/git-auto-deploy/","excerpt":"","text":"è¦æ±‚å®ç° git push ç›´æ¥å®Œæˆä»£ç éƒ¨ç½²åˆ°æœåŠ¡å™¨çš„ç›®å½•å®ç°æ–¹å¼ åˆ©ç”¨ git çš„ hooks ä¸­çš„post-receive æ¥å®ç°ä»£ç æäº¤å®Œæˆä¹‹åçš„åŠ¨ä½œã€‚å°†ä»“åº“æŒ‡å®šä¸€ä¸ª--work-treeç„¶åè¿›è¡Œæ£€å‡ºæ“ä½œcheckout --forceç›®å½•ç»“æ„ æˆ‘è‡ªå·±çš„é¡¹ç›®ç»“æ„æ˜¯è¿™æ ·çš„ï¼Œæ¯ä¸€ä¸ªä»“åº“å¯¹åº”ä¸€ä¸ªé¡¹ç›®ï¼Œä¾‹å¦‚ public/wx é¡¹ç›®å¯¹åº” repo/wx.git ä»“åº“ 123456789101112131415161718.â”œâ”€â”€ publicâ”‚ â””â”€â”€ wx &#x2F;&#x2F; è¿™æ˜¯æˆ‘ä»¬çš„webä»£ç éƒ¨ç½²ç›®å½•â”‚ â”œâ”€â”€ index.phpâ”‚ â”œâ”€â”€ test2.phpâ”‚ â”œâ”€â”€ test3.phpâ”‚ â””â”€â”€ test.phpâ””â”€â”€ repo &#x2F;&#x2F; è¿™ä¸ªæ˜¯æˆ‘ä»¬çš„ä»“åº“ç›®å½• â””â”€â”€ wx.git &#x2F;&#x2F; è¿™ä¸ªå¯¹åº”wxé¡¹ç›®çš„ä»“åº“ â”œâ”€â”€ branches â”œâ”€â”€ config â”œâ”€â”€ description â”œâ”€â”€ HEAD â”œâ”€â”€ hooks &#x2F;&#x2F; post-receiveé’©å­ä»£ç å†™åœ¨è¿™é‡Œé¢ â”œâ”€â”€ index â”œâ”€â”€ info â”œâ”€â”€ objects â””â”€â”€ refs å†çœ‹ä¸‹ hooks æ–‡ä»¶ç›®å½• 123456789101112.â”œâ”€â”€ applypatch-msg.sampleâ”œâ”€â”€ commit-msg.sampleâ”œâ”€â”€ post-commit.sampleâ”œâ”€â”€ post-receiveâ”œâ”€â”€ post-receive.sampleâ”œâ”€â”€ post-update.sampleâ”œâ”€â”€ pre-applypatch.sampleâ”œâ”€â”€ pre-commit.sampleâ”œâ”€â”€ prepare-commit-msg.sampleâ”œâ”€â”€ pre-rebase.sampleâ””â”€â”€ update.sample æˆ‘ä»¬å°† post-receive.sample å¤åˆ¶ä¸€ä»½ post-receiveï¼Œå¹¶ä¸”ç¼–å†™ä»£ç å¦‚ä¸‹ æŒ‡å®šæˆ‘çš„ä»£ç æ£€å‡ºç›®å½•1234DIR=/www/public/wxgit --work-tree=$&#123;DIR&#125; clean -fd# ç›´æ¥å¼ºåˆ¶æ£€å‡ºgit --work-tree=$&#123;DIR&#125; checkout --force å¦‚ä½•ç”Ÿæˆç›®å½•ä¸Šé¢çœ‹åˆ°çš„ repo ç›®å½•ä¸­çš„ wx.git å®é™…ä¸Šæ˜¯ä¸€ä¸ªè£¸ä»“åº“ï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥ç”Ÿæˆè¿™æ ·ä¸€ä¸ªä»“åº“ã€‚ 12cd &#x2F;www&#x2F;repogit init --bare wx.git å¯¹äºä»£ç éƒ¨ç½²ç›®å½•å’Œä»“åº“æˆ‘ä»¬å·²ç»é€šè¿‡ post-receive è¿›è¡Œäº†å…³è”äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸€æ—¦å°†ä»£ç  push åˆ°ä»“åº“ï¼Œé‚£ä¹ˆä¼šè‡ªåŠ¨æ£€å‡ºåˆ° publish/wx ç›®å½•ä¸‹ã€‚ è¿œç¨‹éƒ¨ç½²åœ¨æœ¬åœ°ç”µè„‘ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ è¿œç¨‹ä»“åº“ 12git initgit remote add origin root@xxx.xxx.xxx.xxx:&#x2F;www&#x2F;repo&#x2F;wx.git è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ·»åŠ äº†è¿œç¨‹ä»“åº“ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹ push æ“ä½œ 1234touch index.phpgit add .git commit -m &#39;test&#39;git push å¯èƒ½ä¼šæç¤ºä¸€ä¸ªâ€“set-upstreamï¼Œç›´æ¥æ‰§è¡Œä¸‹å°±å¥½äº†ã€‚æ‰§è¡Œå®Œä¹‹åæˆ‘ä»¬ç™»é™†æœåŠ¡å™¨ï¼Œä¼šå‘ç°æ–‡ä»¶å·²ç»å‡ºç°åœ¨ public/wx/index.php æ³¨æ„ç‚¹ å¦‚æœæˆ‘ä»¬æ²¡æœ‰é…ç½® ssh å…å¯†ç ç™»é™†çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ push ä»£ç çš„æ—¶å€™è¾“å…¥å¯†ç  å¦‚æœæˆ‘ä»¬æ·»åŠ çš„è¿œç¨‹ä»“åº“ä¸æ˜¯ root@xxx.xxx.xx.xxï¼Œä¾‹å¦‚æ˜¯ abc@xx.xx.xx.xxï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ç¡®ä¿ abc ç”¨æˆ·å¯¹ wx.git ç›®å½•ä¸‹çš„æ–‡ä»¶æœ‰ 777 æƒé™ã€‚ æ–°å¢ä»“åº“ éœ€è¦ç™»é™†è¿œç¨‹æœåŠ¡å™¨è¿›è¡Œåˆå§‹åŒ– repo_name.git ä»“åº“ éœ€è¦æ‰‹åŠ¨åˆ›å»º public/repo_name æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”ä¿®æ”¹æƒé™ä¸º 777 éœ€è¦é‡æ–°ç¼–å†™ hooks/post-recieve æ–‡ä»¶ï¼Œä¿®æ”¹é‡Œé¢çš„ DIR è·¯å¾„ä¸º public/repo_name","categories":[{"name":"Git","slug":"Git","permalink":"http://blog.crazylaw.cn/categories/Git/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Git","slug":"Git","permalink":"http://blog.crazylaw.cn/tags/Git/"}]},{"title":"ã€LeeCodeã€‘- Add digital","slug":"ç®—æ³•/leetcode/leecode-1","date":"2018-03-09T10:13:43.000Z","updated":"2021-03-20T16:25:01.821Z","comments":true,"path":"2018/03/09/ç®—æ³•/leetcode/leecode-1/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/09/%E7%AE%97%E6%B3%95/leetcode/leecode-1/","excerpt":"ç»™å®šä¸€ä¸ªéè´Ÿæ•´æ•° numï¼Œé‡å¤æ·»åŠ å…¶æ‰€æœ‰æ•°å­—ï¼Œç›´åˆ°ç»“æœåªæœ‰ä¸€ä¸ªæ•°å­—ã€‚ ä¾‹å¦‚ï¼š é‰´äº num = 38ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±åƒï¼š3 + 8 = 11ï¼Œ1 + 1 = 2ã€‚ç”±äº 2 åªæœ‰ä¸€ä½æ•°å­—ï¼Œè¯·å°†å…¶è¿”å›ã€‚ åç»­å·¥ä½œï¼šä½ å¯ä»¥åœ¨ Oï¼ˆ1ï¼‰è¿è¡Œæ—¶æ²¡æœ‰ä»»ä½•å¾ªç¯/é€’å½’å—ï¼Ÿ 123function digital($num) &#123; return ($num - 1) % 9 +1;&#125;","text":"ç»™å®šä¸€ä¸ªéè´Ÿæ•´æ•° numï¼Œé‡å¤æ·»åŠ å…¶æ‰€æœ‰æ•°å­—ï¼Œç›´åˆ°ç»“æœåªæœ‰ä¸€ä¸ªæ•°å­—ã€‚ ä¾‹å¦‚ï¼š é‰´äº num = 38ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±åƒï¼š3 + 8 = 11ï¼Œ1 + 1 = 2ã€‚ç”±äº 2 åªæœ‰ä¸€ä½æ•°å­—ï¼Œè¯·å°†å…¶è¿”å›ã€‚ åç»­å·¥ä½œï¼šä½ å¯ä»¥åœ¨ Oï¼ˆ1ï¼‰è¿è¡Œæ—¶æ²¡æœ‰ä»»ä½•å¾ªç¯/é€’å½’å—ï¼Ÿ 123function digital($num) &#123; return ($num - 1) % 9 +1;&#125; è§£æï¼š å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªæ•°:1000A+100B+10*C+Dï¼Œåˆ†åˆ«è¡¨ç¤ºäº†å‰ä½ã€ç™¾ä½ã€åä½ã€ä¸ªä½ï¼ˆAã€Bã€Cã€Dï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†è§£æˆ ï¼ˆA+B+C+Dï¼‰+ ï¼ˆ999A + 99B + 9Cï¼‰ã€‚è¿™æ ·å­çš„è¯ï¼Œæˆ‘ä»¬å¾—åˆ°äº† 1y &#x3D; ï¼ˆA+B+C+Dï¼‰+ ï¼ˆ999A + 99B + 9Cï¼‰; ï¼ˆ999A + 99B + 9C + Dï¼‰ä¸€å®šæ˜¯ 9 çš„å€æ•°ï¼Œæ‰€ä»¥ A+B+C+D = y % 9","categories":[{"name":"LeeCode","slug":"LeeCode","permalink":"http://blog.crazylaw.cn/categories/LeeCode/"},{"name":"ç®—æ³•","slug":"LeeCode/ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/LeeCode/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"LeeCode","slug":"LeeCode","permalink":"http://blog.crazylaw.cn/tags/LeeCode/"}]},{"title":"ã€åŸºç¡€ç®—æ³•ã€‘- æ’åº - å †æ’åº","slug":"ç®—æ³•/algorithm-base-heap-sort","date":"2018-03-02T04:52:14.000Z","updated":"2021-03-20T16:25:01.820Z","comments":true,"path":"2018/03/02/ç®—æ³•/algorithm-base-heap-sort/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/02/%E7%AE%97%E6%B3%95/algorithm-base-heap-sort/","excerpt":"é€‰æ‹©æ’åºæ˜¯ä¸€ç§ä¸ç¨³å®šçš„ç®—æ³•ã€‚åŸºæœ¬æ€è·¯æ˜¯ï¼šä»–æ˜¯å°†æ¯æ¬¡ 2 ä¸ªæ•°æ®éƒ½æ¯”è¾ƒå®Œä¹‹åï¼Œè®°å½•ä¸€ä¸ªæœ€å¤§å€¼æˆ–è€…æœ€å°å€¼ï¼Œä¸æ€¥ç€äº¤æ¢ï¼Œï¼ˆè¿™æ˜¯å’Œå†’æ³¡æ’åºçš„å·®åˆ«ï¼Œå‡å°‘äº†äº¤æ¢çš„æ¬¡æ•°ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šé«˜ï¼‰ï¼Œç­‰ä¸€è½®å¾ªç¯æ¯”è¾ƒå®Œæ¯•ä¹‹åï¼Œå†æŠŠæ— åºåŒºæœ€é è¿‘æœ‰åºåŒºçš„é‚£ä¸ªæ•°å’Œå½“å‰è®°å½•çš„å€¼äº¤æ¢ï¼Œæ¯æ¬¡å¾ªç¯åªäº¤æ¢ä¸€æ¬¡ã€‚","text":"é€‰æ‹©æ’åºæ˜¯ä¸€ç§ä¸ç¨³å®šçš„ç®—æ³•ã€‚åŸºæœ¬æ€è·¯æ˜¯ï¼šä»–æ˜¯å°†æ¯æ¬¡ 2 ä¸ªæ•°æ®éƒ½æ¯”è¾ƒå®Œä¹‹åï¼Œè®°å½•ä¸€ä¸ªæœ€å¤§å€¼æˆ–è€…æœ€å°å€¼ï¼Œä¸æ€¥ç€äº¤æ¢ï¼Œï¼ˆè¿™æ˜¯å’Œå†’æ³¡æ’åºçš„å·®åˆ«ï¼Œå‡å°‘äº†äº¤æ¢çš„æ¬¡æ•°ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šé«˜ï¼‰ï¼Œç­‰ä¸€è½®å¾ªç¯æ¯”è¾ƒå®Œæ¯•ä¹‹åï¼Œå†æŠŠæ— åºåŒºæœ€é è¿‘æœ‰åºåŒºçš„é‚£ä¸ªæ•°å’Œå½“å‰è®°å½•çš„å€¼äº¤æ¢ï¼Œæ¯æ¬¡å¾ªç¯åªäº¤æ¢ä¸€æ¬¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435class Select&#123; public function __invoke(array $args) &#123; $length = count($args) - 1; for ($i = 0; $i &lt; $length; $i++) &#123; $k = $i; // 1 for ($j = $i + 1; $j &lt; $length; $j++) &#123; if ($args[$j] &lt; $args[$k]) &#123; $k = $j; &#125; &#125; if ($k != $i) &#123; $tmp = $args[$i]; $args[$i] = $args[$k]; $args[$k] = $tmp; &#125;// foreach ($args as $v) &#123;// echo $v . ' - ';// &#125;// echo PHP_EOL; &#125; return $args; &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Select();$sortData = $sort($data);print_r($sortData);","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ã€åŸºç¡€ç®—æ³•ã€‘- æ’åº - é€‰æ‹©æ’åº","slug":"ç®—æ³•/algorithm-base-select-sort","date":"2018-03-01T09:22:01.000Z","updated":"2021-03-20T16:25:01.821Z","comments":true,"path":"2018/03/01/ç®—æ³•/algorithm-base-select-sort/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/01/%E7%AE%97%E6%B3%95/algorithm-base-select-sort/","excerpt":"é€‰æ‹©æ’åºæ˜¯ä¸€ç§ä¸ç¨³å®šçš„ç®—æ³•ã€‚åŸºæœ¬æ€è·¯æ˜¯ï¼šä»–æ˜¯å°†æ¯æ¬¡ 2 ä¸ªæ•°æ®éƒ½æ¯”è¾ƒå®Œä¹‹åï¼Œè®°å½•ä¸€ä¸ªæœ€å¤§å€¼æˆ–è€…æœ€å°å€¼ï¼Œä¸æ€¥ç€äº¤æ¢ï¼Œï¼ˆè¿™æ˜¯å’Œå†’æ³¡æ’åºçš„å·®åˆ«ï¼Œå‡å°‘äº†äº¤æ¢çš„æ¬¡æ•°ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šé«˜ï¼‰ï¼Œç­‰ä¸€è½®å¾ªç¯æ¯”è¾ƒå®Œæ¯•ä¹‹åï¼Œå†æŠŠæ— åºåŒºæœ€é è¿‘æœ‰åºåŒºçš„é‚£ä¸ªæ•°å’Œå½“å‰è®°å½•çš„å€¼äº¤æ¢ï¼Œæ¯æ¬¡å¾ªç¯åªäº¤æ¢ä¸€æ¬¡ã€‚","text":"é€‰æ‹©æ’åºæ˜¯ä¸€ç§ä¸ç¨³å®šçš„ç®—æ³•ã€‚åŸºæœ¬æ€è·¯æ˜¯ï¼šä»–æ˜¯å°†æ¯æ¬¡ 2 ä¸ªæ•°æ®éƒ½æ¯”è¾ƒå®Œä¹‹åï¼Œè®°å½•ä¸€ä¸ªæœ€å¤§å€¼æˆ–è€…æœ€å°å€¼ï¼Œä¸æ€¥ç€äº¤æ¢ï¼Œï¼ˆè¿™æ˜¯å’Œå†’æ³¡æ’åºçš„å·®åˆ«ï¼Œå‡å°‘äº†äº¤æ¢çš„æ¬¡æ•°ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šé«˜ï¼‰ï¼Œç­‰ä¸€è½®å¾ªç¯æ¯”è¾ƒå®Œæ¯•ä¹‹åï¼Œå†æŠŠæ— åºåŒºæœ€é è¿‘æœ‰åºåŒºçš„é‚£ä¸ªæ•°å’Œå½“å‰è®°å½•çš„å€¼äº¤æ¢ï¼Œæ¯æ¬¡å¾ªç¯åªäº¤æ¢ä¸€æ¬¡ã€‚ 1234567891011121314151617181920212223242526272829303132333435class Select&#123; public function __invoke(array $args) &#123; $length = count($args) - 1; for ($i = 0; $i &lt; $length; $i++) &#123; $k = $i; // 1 for ($j = $i + 1; $j &lt; $length; $j++) &#123; if ($args[$j] &lt; $args[$k]) &#123; $k = $j; &#125; &#125; if ($k != $i) &#123; $tmp = $args[$i]; $args[$i] = $args[$k]; $args[$k] = $tmp; &#125;// foreach ($args as $v) &#123;// echo $v . ' - ';// &#125;// echo PHP_EOL; &#125; return $args; &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Select();$sortData = $sort($data);print_r($sortData);","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ã€åŸºç¡€ç®—æ³•ã€‘- æ’åº - äºŒåˆ†æ’å…¥æ’åº","slug":"ç®—æ³•/algorithm-base-binary-sort","date":"2018-03-01T07:15:00.000Z","updated":"2021-03-20T16:25:01.820Z","comments":true,"path":"2018/03/01/ç®—æ³•/algorithm-base-binary-sort/","link":"","permalink":"http://blog.crazylaw.cn/2018/03/01/%E7%AE%97%E6%B3%95/algorithm-base-binary-sort/","excerpt":"äºŒåˆ†æ’å…¥æ’åºå¯ä»¥è¯´æ˜¯ç›´æ¥æ’å…¥æ’åºçš„å‡çº§ç‰ˆï¼Œå¯¹äºæ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼ŒäºŒåˆ†æ’å…¥æ’åºå¯ä»¥æœ‰æ•ˆçš„å‡å°‘æ¯”è¾ƒçš„æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚ è¿™é‡Œå€ŸåŠ©äº†äºŒåˆ†çš„æ€æƒ³ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªåªæ˜¯äºŒåˆ†æ€æƒ³ï¼Œå’ŒäºŒåˆ†æœç´¢å¹¶éä¸€è‡´ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°äºŒåˆ†æŸ¥è¯¢çš„è¯ï¼Œå‰æå¿…é¡»æ˜¯æœ‰åºæ•°æ®ï¼Œä½†æ˜¯è¿™é‡Œåªæ˜¯å€ŸåŠ©äº†è¿™ä¸ªæ€æƒ³ï¼ŒæŠŠæœ€é è¿‘æœ‰åºåŒºçš„ä¸€ä¸ªé€šè¿‡äºŒåˆ†æŸ¥æ‰¾éœ€è¦æ’å…¥çš„ä½ç½®ï¼Œå¹¶ä¸”ä¸€æ¬¡æ€§ç§»åŠ¨æ‰€æœ‰å¤§äºç›®æ ‡æ•°çš„æ‰€æœ‰å…ƒç´ ã€‚","text":"äºŒåˆ†æ’å…¥æ’åºå¯ä»¥è¯´æ˜¯ç›´æ¥æ’å…¥æ’åºçš„å‡çº§ç‰ˆï¼Œå¯¹äºæ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼ŒäºŒåˆ†æ’å…¥æ’åºå¯ä»¥æœ‰æ•ˆçš„å‡å°‘æ¯”è¾ƒçš„æ¬¡æ•°ï¼Œä»è€Œæé«˜æ•ˆç‡ã€‚ è¿™é‡Œå€ŸåŠ©äº†äºŒåˆ†çš„æ€æƒ³ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªåªæ˜¯äºŒåˆ†æ€æƒ³ï¼Œå’ŒäºŒåˆ†æœç´¢å¹¶éä¸€è‡´ï¼Œå¦‚æœéœ€è¦ç”¨åˆ°äºŒåˆ†æŸ¥è¯¢çš„è¯ï¼Œå‰æå¿…é¡»æ˜¯æœ‰åºæ•°æ®ï¼Œä½†æ˜¯è¿™é‡Œåªæ˜¯å€ŸåŠ©äº†è¿™ä¸ªæ€æƒ³ï¼ŒæŠŠæœ€é è¿‘æœ‰åºåŒºçš„ä¸€ä¸ªé€šè¿‡äºŒåˆ†æŸ¥æ‰¾éœ€è¦æ’å…¥çš„ä½ç½®ï¼Œå¹¶ä¸”ä¸€æ¬¡æ€§ç§»åŠ¨æ‰€æœ‰å¤§äºç›®æ ‡æ•°çš„æ‰€æœ‰å…ƒç´ ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849class BinSearch&#123; public function __invoke(array $args) &#123; $length = count($args); for ($i = 1; $i &lt; $length; $i++) &#123; $j = $i - 1; $k = $args[$i]; $loc = $this-&gt;_binSearch($args, $k, 0, $j); while ($j &gt;= $loc) &#123; $args[$j + 1] = $args[$j]; $j--; &#125; $args[$j + 1] = $k; &#125; return $args; &#125; public function _binSearch( $args, $key, $low, $high ) &#123; while ($low &lt;= $high) &#123; $mid = ceil(($low + $high) / 2); if ($key &gt; $args[$mid]) &#123; $low = $mid + 1; &#125; else &#123; $high = $mid - 1; &#125; &#125; return $low; &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new BinSearch();$sortData = $sort($data);print_r($sortData);","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ã€PHPã€‘- php7çš„æ–°ç‰¹æ€§","slug":"php7","date":"2018-02-28T15:58:00.000Z","updated":"2021-03-20T16:25:01.813Z","comments":true,"path":"2018/02/28/php7/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/php7/","excerpt":"php7 å‡ºæ¥çš„æ—¶å€™ï¼Œå¤šäº†å“ªäº›ç‰¹æ€§å‘¢ï¼Œåœ¨è¿™é‡Œæ€»ç»“ä¸€ä¸‹ ä¸ºä»€ä¹ˆ PHP7 æ¯” PHP5 æ€§èƒ½æå‡äº†ï¼Ÿ å˜é‡å­˜å‚¨å­—èŠ‚å‡å°ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼Œæå‡å˜é‡æ“ä½œé€Ÿåº¦ æ”¹å–„æ•°ç»„ç»“æ„ï¼Œæ•°ç»„å…ƒç´ å’Œ hash æ˜ å°„è¡¨è¢«åˆ†é…åœ¨åŒä¸€å—å†…å­˜é‡Œï¼Œé™ä½äº†å†…å­˜å ç”¨ã€æå‡äº† cpu ç¼“å­˜å‘½ä¸­ç‡ï¼ˆä»¥å¾€çš„ zval æ˜¯ä¸€ä¸ª 24 å­—èŠ‚çš„ç»“æ„ä½“ï¼Œç°åœ¨çš„å›ºå®šæ˜¯ 16 ä¸ªå­—èŠ‚ï¼‰ æ”¹è¿›äº†å‡½æ•°çš„è°ƒç”¨æœºåˆ¶ï¼Œé€šè¿‡ä¼˜åŒ–å‚æ•°ä¼ é€’çš„ç¯èŠ‚ï¼Œå‡å°‘äº†ä¸€äº›æŒ‡ä»¤ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ å¤ªç©ºèˆ¹æ“ä½œç¬¦1&lt;&#x3D;&gt; å·¦è¾¹å¤§äºå³è¾¹çš„æ—¶å€™ï¼Œè¿”å› 1 å³è¾¹å¤§äºå·¦è¾¹çš„æ—¶å€™ï¼Œè¿”å›-1 ä¸¤è¾¹ç›¸ç­‰çš„æ—¶å€™ï¼Œè¿”å› 0","text":"php7 å‡ºæ¥çš„æ—¶å€™ï¼Œå¤šäº†å“ªäº›ç‰¹æ€§å‘¢ï¼Œåœ¨è¿™é‡Œæ€»ç»“ä¸€ä¸‹ ä¸ºä»€ä¹ˆ PHP7 æ¯” PHP5 æ€§èƒ½æå‡äº†ï¼Ÿ å˜é‡å­˜å‚¨å­—èŠ‚å‡å°ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼Œæå‡å˜é‡æ“ä½œé€Ÿåº¦ æ”¹å–„æ•°ç»„ç»“æ„ï¼Œæ•°ç»„å…ƒç´ å’Œ hash æ˜ å°„è¡¨è¢«åˆ†é…åœ¨åŒä¸€å—å†…å­˜é‡Œï¼Œé™ä½äº†å†…å­˜å ç”¨ã€æå‡äº† cpu ç¼“å­˜å‘½ä¸­ç‡ï¼ˆä»¥å¾€çš„ zval æ˜¯ä¸€ä¸ª 24 å­—èŠ‚çš„ç»“æ„ä½“ï¼Œç°åœ¨çš„å›ºå®šæ˜¯ 16 ä¸ªå­—èŠ‚ï¼‰ æ”¹è¿›äº†å‡½æ•°çš„è°ƒç”¨æœºåˆ¶ï¼Œé€šè¿‡ä¼˜åŒ–å‚æ•°ä¼ é€’çš„ç¯èŠ‚ï¼Œå‡å°‘äº†ä¸€äº›æŒ‡ä»¤ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ å¤ªç©ºèˆ¹æ“ä½œç¬¦1&lt;&#x3D;&gt; å·¦è¾¹å¤§äºå³è¾¹çš„æ—¶å€™ï¼Œè¿”å› 1 å³è¾¹å¤§äºå·¦è¾¹çš„æ—¶å€™ï¼Œè¿”å›-1 ä¸¤è¾¹ç›¸ç­‰çš„æ—¶å€™ï¼Œè¿”å› 0 12345$a = 1;$b = 2;$result = $a &lt;=&gt; $becho $result;// -1 null åˆå¹¶ç¬¦1$a = $var['var'] ?? 'null'; ç›¸å½“äº isset($var[â€˜varâ€™])?$var:â€™nullâ€™ å¼ºåˆ¶è¿”å›ç±»å‹123public function myFunc(): int &#123; return 1;&#125; å½“ä¸€ä¸ªæ–¹æ³•ç¡®è®¤æ•°æ®ç±»å‹çš„æ—¶å€™ï¼Œå¯ä»¥å†™ä¸Šå¼ºåˆ¶è¿”å›ç±»å‹ï¼Œè¿™å¯ä»¥ä½¿å¾— php7 çš„è§£æä»£ç é€»è¾‘æ›´å¿«ã€‚ define å®šä¹‰æ•°ç»„1define('defineArray',['a' =&gt; 1, 'b' =&gt; 2]); è¿™ä¸ªçš„å‡ºç°ï¼Œå¯ä»¥ä½¿å¾—ä½ ä¸€å¼€å§‹å°±å®šä¹‰å…¨å±€é™æ€æ•°ç»„ åŒ¿åç±»123456789$b = new class &#123; public function __invoke() &#123; echo 'ç”¨åå³ç„š'; &#125;&#125;$b();// å‡å°‘å¼•ç”¨ï¼ˆè¿˜éœ€è¦å›æ”¶å‘¨æœŸæ‰§è¡Œï¼šgc_collect_cycles()ï¼Œæ‰‹åŠ¨å¼ºåˆ¶æ‰§è¡Œgcå›æ”¶å‘¨æœŸï¼‰unset($b); å’ŒåŒ¿åå‡½æ•°å·®ä¸å¤šï¼Œéƒ½å¯ä»¥å®ç°ç”¨åå³ç„šï¼Œä½†æ˜¯è¿™ä¸ªæ¶‰åŠåˆ° gc åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 å¹¶ä¸”åˆšå¥½åˆ°äº† gc å›æ”¶å‘¨æœŸçš„æ—¶å€™ï¼Œè¯¥ä¾¿å°†å°±å°†ä¼šé”€æ¯ use é›†åˆåŒ–123456use some\\namespace\\A;use some\\namespace\\B;use some\\namespace\\C;use some\\namespace\\&#123;A,B,C&#125;; æ•æŠ“è‡´å‘½é”™è¯¯ç±»PHP 5 çš„ try â€¦ catch â€¦ finally æ— æ³•å¤„ç†ä¼ ç»Ÿé”™è¯¯ï¼Œå¦‚æœéœ€è¦ï¼Œä½ é€šå¸¸ä¼šè€ƒè™‘ç”¨ set_error_handler() æ¥ Hack ä¸€ä¸‹ã€‚ä½†æ˜¯ä»æœ‰å¾ˆå¤šé”™è¯¯ç±»å‹æ˜¯ set_error_handler() æ•æ‰ä¸åˆ°çš„ã€‚PHP 7 å¼•å…¥ Throwable æ¥å£ï¼Œé”™è¯¯åŠå¼‚å¸¸éƒ½å®ç°äº† Throwableï¼Œæ— æ³•ç›´æ¥å®ç° Throwableï¼Œä½†å¯ä»¥æ‰©å±• \\Exception å’Œ \\Error ç±»ã€‚å¯ä»¥ç”¨ Throwable æ•æ‰å¼‚å¸¸è·Ÿé”™è¯¯ã€‚\\Exception æ˜¯æ‰€æœ‰ PHP åŠç”¨æˆ·å¼‚å¸¸çš„åŸºç±»ï¼›\\Error æ˜¯æ‰€æœ‰å†…éƒ¨ PHP é”™è¯¯çš„åŸºç±»ã€‚ 123456789101112131415161718$name = \"Tony\";try &#123; $name = $name-&gt;method();&#125; catch (\\Error $e) &#123; echo \"å‡ºé”™æ¶ˆæ¯ --- \", $e-&gt;getMessage(), PHP_EOL;&#125;try &#123; $name = $name-&gt;method();&#125; catch (\\Throwable $e) &#123; echo \"å‡ºé”™æ¶ˆæ¯ --- \", $e-&gt;getMessage(), PHP_EOL;&#125;try &#123; intdiv(5, 0);&#125; catch (\\DivisionByZeroError $e) &#123; echo \"å‡ºé”™æ¶ˆæ¯ --- \", $e-&gt;getMessage(), PHP_EOL;&#125; åç»­é™†ç»­æä¾› 7.1 æ‰æœ‰çš„ç‰¹æ€§â€¦.","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"}]},{"title":"CGI - php-cgi - Fastcgi - php-fpm - nginxçš„å…³ç³»","slug":"php-cgi-fastcgi","date":"2018-02-28T14:03:00.000Z","updated":"2021-03-20T16:25:01.812Z","comments":true,"path":"2018/02/28/php-cgi-fastcgi/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/php-cgi-fastcgi/","excerpt":"","text":"CGIï¼šCGI çš„è‹±æ–‡æ˜¯ï¼ˆCOMMON GATEWAY INTERFACEï¼‰å…¬å…±ç½‘å…³æ¥å£ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å¸®åŠ©æœåŠ¡å™¨ä¸è¯­è¨€é€šä¿¡ï¼Œè¿™é‡Œå°±æ˜¯ nginx å’Œ php è¿›è¡Œé€šä¿¡ï¼Œå› ä¸º nginx å’Œ php çš„è¯­è¨€ä¸é€šï¼Œå› æ­¤éœ€è¦ä¸€ä¸ªæ²Ÿé€šè½¬æ¢çš„è¿‡ç¨‹ï¼Œè€Œ CGI å°±æ˜¯è¿™ä¸ªæ²Ÿé€šçš„åè®®ã€‚ nginx æœåŠ¡å™¨åœ¨æ¥å—åˆ°æµè§ˆå™¨ä¼ é€’è¿‡æ¥çš„æ•°æ®åï¼Œå¦‚æœè¯·æ±‚çš„æ˜¯é™æ€çš„é¡µé¢æˆ–è€…å›¾ç‰‡ç­‰æ— éœ€åŠ¨æ€å¤„ç†çš„åˆ™ä¼šç›´æ¥æ ¹æ®è¯·æ±‚çš„ url æ‰¾åˆ°å…¶ä½ç½®ç„¶åè¿”å›ç»™æµè§ˆå™¨ï¼Œè¿™é‡Œæ— éœ€ php å‚ä¸ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä¸€ä¸ªåŠ¨æ€çš„é¡µé¢è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™ nginx å°±å¿…é¡»ä¸ php é€šä¿¡ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šéœ€è¦ç”¨åˆ° cgi åè®®ï¼Œå°†è¯·æ±‚æ•°æ®è½¬æ¢æˆ php èƒ½ç†è§£çš„ä¿¡æ¯ï¼Œç„¶å php æ ¹æ®è¿™äº›ä¿¡æ¯è¿”å›çš„ä¿¡æ¯ä¹Ÿè¦é€šè¿‡ cgi åè®®è½¬æ¢æˆ nginx å¯ä»¥ç†è§£çš„ä¿¡æ¯ï¼Œæœ€å nginx æ¥åˆ°è¿™äº›ä¿¡æ¯å†è¿”å›ç»™æµè§ˆå™¨ã€‚ fast-cgiï¼šä¼ ç»Ÿçš„ cgi åè®®åœ¨æ¯æ¬¡è¿æ¥è¯·æ±‚æ—¶ï¼Œä¼šå¼€å¯ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œæ¯•ä¼šå…³é—­è¯¥è¿›ç¨‹ï¼Œå› æ­¤ä¸‹æ¬¡è¿æ¥ï¼Œåˆè¦å†æ¬¡å¼€å¯ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œå¤„ç†ï¼Œå› æ­¤æœ‰å¤šå°‘ä¸ªè¿æ¥å°±æœ‰å¤šå°‘ä¸ª cgi è¿›ç¨‹ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¼ ç»Ÿçš„ cgi ä¼šæ˜¾å¾—ç¼“æ…¢çš„åŸå› ï¼Œå› æ­¤è¿‡å¤šçš„è¿›ç¨‹ä¼šæ¶ˆè€—èµ„æºå’Œå†…å­˜ã€‚ è€Œ fast-cgi åˆ™æ˜¯ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œå’Œä¸Šé¢çš„ cgi åè®®å®Œå…¨ä¸ä¸€æ ·ï¼Œcgi æ˜¯ä¸€ä¸ªè¿›ç¨‹åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´å¤§é‡çš„ cgi ç¨‹åºï¼Œå› æ­¤ä¼šç»™æœåŠ¡å™¨å¸¦æ¥è´Ÿæ‹…ã€‚ php-cgiï¼šphp-cgi æ˜¯ php æä¾›ç»™ web serve ä¹Ÿå°±æ˜¯ http å‰ç«¯æœåŠ¡å™¨çš„ cgi åè®®æ¥å£ç¨‹åºï¼Œå½“æ¯æ¬¡æ¥åˆ° http å‰ç«¯æœåŠ¡å™¨çš„è¯·æ±‚éƒ½ä¼šå¼€å¯ä¸€ä¸ª php-cgi è¿›ç¨‹è¿›è¡Œå¤„ç†ï¼Œè€Œä¸”å¼€å¯çš„ php-cgi çš„è¿‡ç¨‹ä¸­ä¼šå…ˆè¦é‡è½½é…ç½®ï¼Œæ•°æ®ç»“æ„ä»¥åŠåˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼Œå¦‚æœæ›´æ–°äº† php é…ç½®ï¼Œé‚£ä¹ˆå°±éœ€è¦é‡å¯ php-cgi æ‰èƒ½ç”Ÿæ•ˆï¼Œä¾‹å¦‚ phpstudy å°±æ˜¯è¿™ç§æƒ…å†µã€‚ php-fpm:php-fpm æ˜¯ php æä¾›ç»™ web serve ä¹Ÿå°±æ˜¯ http å‰ç«¯æœåŠ¡å™¨çš„ fastcgi åè®®æ¥å£ç¨‹åºï¼Œå®ƒä¸ä¼šåƒ php-cgi ä¸€æ ·æ¯æ¬¡è¿æ¥éƒ½ä¼šé‡æ–°å¼€å¯ä¸€ä¸ªè¿›ç¨‹ï¼Œå¤„ç†å®Œè¯·æ±‚åˆå…³é—­è¿™ä¸ªè¿›ç¨‹ï¼Œè€Œæ˜¯å…è®¸ä¸€ä¸ªè¿›ç¨‹å¯¹å¤šä¸ªè¿æ¥è¿›è¡Œå¤„ç†ï¼Œè€Œä¸ä¼šç«‹å³å…³é—­è¿™ä¸ªè¿›ç¨‹ï¼Œè€Œæ˜¯ä¼šæ¥ç€å¤„ç†ä¸‹ä¸€ä¸ªè¿æ¥ã€‚å®ƒå¯ä»¥è¯´æ˜¯ php-cgi çš„ä¸€ä¸ªç®¡ç†ç¨‹åºï¼Œæ˜¯å¯¹ php-cgi çš„æ”¹è¿›ã€‚ php-fpm ä¼šå¼€å¯å¤šä¸ª php-cgi ç¨‹åºï¼Œå¹¶ä¸” php-fpm å¸¸é©»å†…å­˜ï¼Œæ¯æ¬¡ web serve æœåŠ¡å™¨å‘é€è¿æ¥è¿‡æ¥çš„æ—¶å€™ï¼Œphp-fpm å°†è¿æ¥ä¿¡æ¯åˆ†é…ç»™ä¸‹é¢å…¶ä¸­çš„ä¸€ä¸ªå­ç¨‹åº php-cgi è¿›è¡Œå¤„ç†ï¼Œå¤„ç†å®Œæ¯•è¿™ä¸ª php-cgi å¹¶ä¸ä¼šå…³é—­ï¼Œè€Œæ˜¯ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥ï¼Œè¿™ä¹Ÿæ˜¯ fast-cgi åŠ é€Ÿçš„åŸç†ï¼Œä½†æ˜¯ç”±äº php-fpm æ˜¯å¤šè¿›ç¨‹çš„ï¼Œè€Œä¸€ä¸ª php-cgi åŸºæœ¬æ¶ˆè€— 7-25M å†…å­˜ï¼Œå› æ­¤å¦‚æœè¿æ¥è¿‡å¤šå°±ä¼šå¯¼è‡´å†…å­˜æ¶ˆè€—è¿‡å¤§ï¼Œå¼•å‘ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ nginx é‡Œçš„ 502 é”™è¯¯ã€‚ åŒæ—¶ php-fpm è¿˜é™„å¸¦ä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼š ä¾‹å¦‚å¹³æ»‘è¿‡æ¸¡é…ç½®æ›´æ”¹ï¼Œæ™®é€šçš„ php-cgi åœ¨æ¯æ¬¡æ›´æ”¹é…ç½®åï¼Œéœ€è¦é‡æ–°å¯åŠ¨æ‰èƒ½åˆå§‹åŒ–æ–°çš„é…ç½®ï¼Œè€Œ php-fpm æ˜¯ä¸éœ€è¦ï¼Œphp-fpm åˆ†å°†æ–°çš„è¿æ¥å‘é€ç»™æ–°çš„å­ç¨‹åº php-cgiï¼Œè¿™ä¸ªæ—¶å€™åŠ è½½çš„æ˜¯æ–°çš„é…ç½®ï¼Œè€ŒåŸå…ˆæ­£åœ¨è¿è¡Œçš„ php-cgi è¿˜æ˜¯ä½¿ç”¨çš„åŸå…ˆçš„é…ç½®ï¼Œç­‰åˆ°è¿™ä¸ªè¿æ¥åä¸‹ä¸€æ¬¡è¿æ¥çš„æ—¶å€™ä¼šä½¿ç”¨æ–°çš„é…ç½®åˆå§‹åŒ–ï¼Œè¿™å°±æ˜¯å¹³æ»‘è¿‡æ¸¡ã€‚","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"},{"name":"Nginx","slug":"PHP/Nginx","permalink":"http://blog.crazylaw.cn/categories/PHP/Nginx/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"}]},{"title":"ã€åè®®ã€‘httpåè®®1/2çš„åŒºåˆ«","slug":"http-d","date":"2018-02-28T13:34:54.000Z","updated":"2021-03-20T16:25:01.806Z","comments":true,"path":"2018/02/28/http-d/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/http-d/","excerpt":"http åè®®å±äºåº”ç”¨å±‚çš„åè®®ï¼Œæ˜¯æˆ‘ä»¬æ—¥å¸¸ç»å¸¸æ‰“äº¤é“çš„ä¸€ç§åè®®ï¼Œå±äºä¸€ç§æ–‡æœ¬åè®®ï¼Œhttp åè®®ç»å†äº† 3 ä¸ªæ¯”è¾ƒå¤§çš„ç‰ˆæœ¬æ”¹å˜ã€‚ http åè®®åŸºäº tcp åè®®å®ç°ï¼ˆåº”ç”¨å±‚åè®®åŸºäºä¼ è¾“å±‚åè®®ï¼Œè¿™ä¸ªæ˜¯æ­£å¸¸çš„å˜›ï¼‰ï¼Œä¸ºäº†æ•°æ®çš„å®‰å…¨æ€§ï¼Œæœ‰æ—¶å€™å¯èƒ½å»ºç«‹åœ¨ tls æˆ–è€… ssl åè®®ä¹‹ä¸Šã€‚ http1.0http1.0 ä½¿ç”¨çš„æ˜¯éæŒä¹…åŒ–è¿æ¥ï¼Œå°±æ˜¯æ¯æ¬¡è¯·æ±‚ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œç½‘ç»œ io è¾ƒé«˜ éæŒä¹…åŒ–è¿æ¥ æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿æ¥ http1.1","text":"http åè®®å±äºåº”ç”¨å±‚çš„åè®®ï¼Œæ˜¯æˆ‘ä»¬æ—¥å¸¸ç»å¸¸æ‰“äº¤é“çš„ä¸€ç§åè®®ï¼Œå±äºä¸€ç§æ–‡æœ¬åè®®ï¼Œhttp åè®®ç»å†äº† 3 ä¸ªæ¯”è¾ƒå¤§çš„ç‰ˆæœ¬æ”¹å˜ã€‚ http åè®®åŸºäº tcp åè®®å®ç°ï¼ˆåº”ç”¨å±‚åè®®åŸºäºä¼ è¾“å±‚åè®®ï¼Œè¿™ä¸ªæ˜¯æ­£å¸¸çš„å˜›ï¼‰ï¼Œä¸ºäº†æ•°æ®çš„å®‰å…¨æ€§ï¼Œæœ‰æ—¶å€™å¯èƒ½å»ºç«‹åœ¨ tls æˆ–è€… ssl åè®®ä¹‹ä¸Šã€‚ http1.0http1.0 ä½¿ç”¨çš„æ˜¯éæŒä¹…åŒ–è¿æ¥ï¼Œå°±æ˜¯æ¯æ¬¡è¯·æ±‚ï¼Œéƒ½æ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œç½‘ç»œ io è¾ƒé«˜ éæŒä¹…åŒ–è¿æ¥ æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿æ¥ http1.1 http1.1 æä¾›äº† Keep-Alive çš„å‚æ•°æ¥è®¾ç½®æŒä¹…åŒ–è¿æ¥ï¼Œå¹¶ä¸”ä¸€ä¸ªè¿æ¥å¯ä»¥è¿›è¡Œå¤šæ¬¡è¯·æ±‚ï¼ˆä¸€ä¸ªé¡µé¢åŠ è½½çš„æ—¶å€™ï¼Œcssã€js ç­‰è¯·æ±‚å¯ä»¥åœ¨åŒä¸€ä¸ªè¿æ¥ä¸‹å®Œæˆï¼‰ï¼Œæ— é¡»é‡æ–°å»ºç«‹è¿æ¥ï¼Œé™ä½äº†ç½‘ç»œ ioã€‚å¹¶ä¸”è¿˜å…è®¸å®¢æˆ·ç«¯ä¸ç”¨ç­‰å¾…ä¸Šä¸€æ¬¡è¯·æ±‚ç»“æœè¿”å›ï¼Œå°±å¯ä»¥å‘å‡ºä¸‹ä¸€æ¬¡è¯·æ±‚ï¼ˆä½†æœåŠ¡å™¨ç«¯å¿…é¡»æŒ‰ç…§æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚çš„å…ˆåé¡ºåºä¾æ¬¡å›é€å“åº”ç»“æœï¼Œä»¥ä¿è¯å®¢æˆ·ç«¯èƒ½å¤ŸåŒºåˆ†å‡ºæ¯æ¬¡è¯·æ±‚çš„å“åº”å†…å®¹ï¼Œè¿™æ ·ä¹Ÿæ˜¾è‘—åœ°å‡å°‘äº†æ•´ä¸ªä¸‹è½½è¿‡ç¨‹æ‰€éœ€è¦çš„æ—¶é—´ï¼‰ã€‚http1.1 å¼€å§‹å…è®¸è®¾ç½® host è¯·æ±‚å¤´å­—æ®µï¼ˆä½¿å¾— web æµè§ˆå™¨å¯ä»¥é€šè¿‡å‘é€ host æ¥æ˜ç¡®æœåŠ¡å™¨è¦è¯·æ±‚çš„æ˜¯å“ªä¸ªç«™ç‚¹é¡¹ç›®ï¼‰ï¼Œè¿˜æä¾›äº†èº«ä»½è®¤è¯ï¼ŒCache ç®¡ç†ç­‰è¯·æ±‚å¤´å­—æ®µ æŒä¹…åŒ–è¿æ¥ï¼ˆKeep-Aliveï¼‰ æ¯ä¸ªè¿æ¥å¯ä»¥æ¥å—å¤šä¸ªè¯·æ±‚ï¼ˆä½†æ˜¯å¿…é¡»æŒ‰ç…§è¯·æ±‚é¡ºåºè¿”å›å†…å®¹ï¼‰ è®¾ç½®äº† hostã€cacheã€èº«ä»½è®¤è¯ç­‰è¯·æ±‚å¤´å­—æ®µ http2.0è¿™æ˜¯ä¸€ä¸ªè´¨çš„æ”¹å˜ï¼Œç”±æ–‡æœ¬åè®®è½¬å˜ç¨‹äº†äºŒè¿›åˆ¶åè®®ï¼Œå¹¶ä¸”å¿…é¡»å»ºç«‹åœ¨ tls æˆ–è€… ssl ä¹‹ä¸Šã€‚ äºŒè¿›åˆ¶åè®®ç›¸å¯¹æ¯”æ–‡æœ¬åè®®æ¥è¯´ï¼Œæ›´åŠ ç®€æ´ï¼Œä¼ è¾“çš„æˆæœ¬é™ä½äº†ï¼ˆå¸¦å®½ï¼‰ï¼Œå¯¹è®¡ç®—å™¨æ›´åŠ å‹å¥½ï¼Œå¹¶ä¸”æ›´åŠ å®‰å…¨ äºŒè¿›åˆ¶åè®® å¿…é¡»å»ºç«‹åœ¨ tls æˆ–è€… ssl ä¹‹ä¸Š IO å¤šè·¯å¤ç”¨ è¯·æ±‚åˆ’åˆ†ä¼˜å…ˆçº§ ç”¨ HPACK ç®—æ³•å¯¹è¯·æ±‚å¤´ä¿¡æ¯è¿›è¡Œäº†å‹ç¼© æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯","categories":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C/"},{"name":"åè®®","slug":"ç½‘ç»œ/åè®®","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C/%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/tags/%E7%BD%91%E7%BB%9C/"}]},{"title":"ã€Linuxã€‘- å®šæ—¶ä»»åŠ¡ - crontab","slug":"linux-crontab","date":"2018-02-28T07:13:00.000Z","updated":"2021-03-20T16:25:01.808Z","comments":true,"path":"2018/02/28/linux-crontab/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/linux-crontab/","excerpt":"","text":"crontab å®šæ—¶ä»»åŠ¡é€šè¿‡ crontab å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å›ºå®šçš„é—´éš”æ—¶é—´æ‰§è¡ŒæŒ‡å®šçš„ç³»ç»ŸæŒ‡ä»¤æˆ– shell script è„šæœ¬ã€‚æ—¶é—´é—´éš”çš„å•ä½å¯ä»¥æ˜¯åˆ†é’Ÿã€å°æ—¶ã€æ—¥ã€æœˆã€å‘¨åŠä»¥ä¸Šçš„ä»»æ„ç»„åˆã€‚è¿™ä¸ªå‘½ä»¤éå¸¸é€‚åˆå‘¨æœŸæ€§çš„æ—¥å¿—åˆ†ææˆ–æ•°æ®å¤‡ä»½ç­‰å·¥ä½œã€‚ åœ¨ Linux ç³»ç»Ÿä¸­ï¼ŒLinux ä»»åŠ¡è°ƒåº¦çš„å·¥ä½œä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š1ã€ç³»ç»Ÿæ‰§è¡Œçš„å·¥ä½œï¼šç³»ç»Ÿå‘¨æœŸæ€§æ‰€è¦æ‰§è¡Œçš„å·¥ä½œï¼Œå¦‚å¤‡ä»½ç³»ç»Ÿæ•°æ®ã€æ¸…ç†ç¼“å­˜2ã€ä¸ªäººæ‰§è¡Œçš„å·¥ä½œï¼šæŸä¸ªç”¨æˆ·å®šæœŸè¦åšçš„å·¥ä½œï¼Œä¾‹å¦‚æ¯éš” 10 åˆ†é’Ÿæ£€æŸ¥é‚®ä»¶æœåŠ¡å™¨æ˜¯å¦æœ‰æ–°ä¿¡ï¼Œè¿™äº›å·¥ä½œå¯ç”±æ¯ä¸ªç”¨æˆ·è‡ªè¡Œè®¾ç½® ä¸€ã€/etc/crontabã€/etc/cron.deny ã€ /etc/cron.allow æ–‡ä»¶ä»‹ç» ç³»ç»Ÿè°ƒåº¦çš„ä»»åŠ¡ä¸€èˆ¬å­˜æ”¾åœ¨/etc/crontab è¿™ä¸ªæ–‡ä»¶ä¸‹ï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€äº›ç³»ç»Ÿè¿è¡Œçš„è°ƒåº¦ç¨‹åºï¼Œé€šè¿‡å‘½ä»¤æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹é‡Œé¢çš„å†…å®¹ï¼š 1234567891011121314151617[root@caiwh ~]# cat &#x2F;etc&#x2F;crontabSHELL&#x3D;&#x2F;bin&#x2F;bashPATH&#x3D;&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;binMAILTO&#x3D;rootHOME&#x3D;&#x2F;# For details see man 4 crontabs# Example of job definition:# .---------------- minute (0 - 59)# | .------------- hour (0 - 23)# | | .---------- day of month (1 - 31)# | | | .------- month (1 - 12) OR jan,feb,mar,apr ...# | | | | .---- day of week (0 - 6) (Sunday&#x3D;0 or 7) OR sun,mon,tue,wed,thu,fri,sat# | | | | |# * * * * * user-name command to be executed ä¸€å®šè¦æ³¨æ„é»˜è®¤çš„ç¯å¢ƒå˜é‡ï¼Œå¦åˆ™ç›´æ¥å†™åœ¨ crontab -e å†™çš„å‘½ä»¤ï¼Œç”±äºä¸åœ¨å½“å‰çš„é»˜è®¤çš„ç¯å¢ƒå˜é‡ä¸­ã€‚æ‰€ä»¥ä¼šå¯èƒ½æ‰¾ä¸åˆ°ã€‚. è¿™äº›ä»»åŠ¡éƒ½ä¼šæ˜¯ç³»ç»Ÿåœ¨è¿è¡Œèµ·æ¥åè‡ªåŠ¨è¿›è¡Œè°ƒåº¦çš„ã€‚åŒæ—¶åœ¨/etc ç›®å½•ä¸‹è¿˜å­˜æ”¾äº†/etc/cron.deny å’Œ /etc/cron.allow æ–‡ä»¶ /etc/cron.deny è¡¨ç¤ºä¸èƒ½ä½¿ç”¨ crontab å‘½ä»¤çš„ç”¨æˆ· /etc/cron.allow è¡¨ç¤ºèƒ½ä½¿ç”¨ crontab çš„ç”¨æˆ·ã€‚ å¦‚æœä¸¤ä¸ªæ–‡ä»¶åŒæ—¶å­˜åœ¨ï¼Œé‚£ä¹ˆ/etc/cron.allow ä¼˜å…ˆã€‚ å¦‚æœä¸¤ä¸ªæ–‡ä»¶éƒ½ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåªæœ‰ root ç”¨æˆ·å¯ä»¥å®‰æ’ä½œä¸šã€‚ å‘½ä»¤æ ¼å¼12crontab [-u user] filecrontab [-u user] [ -e | -l | -r ] å‘½ä»¤å‚æ•° -u userï¼šç”¨æ¥è®¾å®šæŸä¸ªç”¨æˆ·çš„ crontab æœåŠ¡ï¼› fileï¼šfile æ˜¯å‘½ä»¤æ–‡ä»¶çš„åå­—,è¡¨ç¤ºå°† file åšä¸º crontab çš„ä»»åŠ¡åˆ—è¡¨æ–‡ä»¶å¹¶è½½å…¥ crontabã€‚å¦‚æœåœ¨å‘½ä»¤è¡Œä¸­æ²¡æœ‰æŒ‡å®šè¿™ä¸ªæ–‡ä»¶ï¼Œcrontab å‘½ä»¤å°†æ¥å—æ ‡å‡†è¾“å…¥ï¼ˆé”®ç›˜ï¼‰ä¸Šé”®å…¥çš„å‘½ä»¤ï¼Œå¹¶å°†å®ƒä»¬è½½å…¥ crontabã€‚ -eï¼šç¼–è¾‘æŸä¸ªç”¨æˆ·çš„ crontab æ–‡ä»¶å†…å®¹ã€‚å¦‚æœä¸æŒ‡å®šç”¨æˆ·ï¼Œåˆ™è¡¨ç¤ºç¼–è¾‘å½“å‰ç”¨æˆ·çš„ crontab æ–‡ä»¶ã€‚ -lï¼šæ˜¾ç¤ºæŸä¸ªç”¨æˆ·çš„ crontab æ–‡ä»¶å†…å®¹ï¼Œå¦‚æœä¸æŒ‡å®šç”¨æˆ·ï¼Œåˆ™è¡¨ç¤ºæ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„ crontab æ–‡ä»¶å†…å®¹ã€‚ -rï¼šä»/var/spool/cron ç›®å½•ä¸­åˆ é™¤æŸä¸ªç”¨æˆ·çš„ crontab æ–‡ä»¶ï¼Œå¦‚æœä¸æŒ‡å®šç”¨æˆ·ï¼Œåˆ™é»˜è®¤åˆ é™¤å½“å‰ç”¨æˆ·çš„ crontab æ–‡ä»¶ã€‚ -iï¼šåœ¨åˆ é™¤ç”¨æˆ·çš„ crontab æ–‡ä»¶æ—¶ç»™ç¡®è®¤æç¤ºã€‚ crontab çš„æ–‡ä»¶æ ¼å¼åˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸ è¦è¿è¡Œçš„å‘½ä»¤ ç¬¬ 1 åˆ—åˆ†é’Ÿ 0 ï½ 59 ç¬¬ 2 åˆ—å°æ—¶ 0 ï½ 23ï¼ˆ0 è¡¨ç¤ºå­å¤œï¼‰ ç¬¬ 3 åˆ—æ—¥ 1 ï½ 31 ç¬¬ 4 åˆ—æœˆ 1 ï½ 12 ç¬¬ 5 åˆ—æ˜ŸæœŸ 0 ï½ 7ï¼ˆ0 å’Œ 7 è¡¨ç¤ºæ˜ŸæœŸå¤©ï¼‰ ç¬¬ 6 åˆ—è¦è¿è¡Œçš„å‘½ä»¤ å¸¸ç”¨æ–¹æ³• åˆ›å»ºä¸€ä¸ªæ–°çš„ crontab æ–‡ä»¶ å‘ cron è¿›ç¨‹æäº¤ä¸€ä¸ª crontab æ–‡ä»¶ä¹‹å‰ï¼Œé¦–å…ˆè¦è®¾ç½®ç¯å¢ƒå˜é‡ EDITORã€‚cron è¿›ç¨‹æ ¹æ®å®ƒæ¥ç¡®å®šä½¿ç”¨å“ªä¸ªç¼–è¾‘å™¨ç¼–è¾‘ crontab æ–‡ä»¶ã€‚99%çš„ UNIX å’Œ LINUX ç”¨æˆ·éƒ½ä½¿ç”¨ viï¼Œå¦‚æœä½ ä¹Ÿæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆä½ å°±ç¼–è¾‘$HOME ç›®å½•ä¸‹çš„. profile æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­åŠ å…¥è¿™æ ·ä¸€è¡Œ 1EDITOR&#x3D;vi; export EDITOR ç„¶åä¿å­˜å¹¶é€€å‡ºã€‚ä¸å¦¨åˆ›å»ºä¸€ä¸ªåä¸º cron çš„æ–‡ä»¶ï¼Œå…¶ä¸­æ˜¯ç”¨æˆ·åï¼Œä¾‹å¦‚ï¼Œ davecronã€‚åœ¨è¯¥æ–‡ä»¶ä¸­åŠ å…¥å¦‚ä¸‹çš„å†…å®¹ã€‚ 123# (put your own initials here)echo the date to the console every# 15minutes between 6pm and 6am0,15,30,45 18-06 * * * &#x2F;bin&#x2F;echo &#39;date&#39; &gt; &#x2F;dev&#x2F;console ä¿å­˜å¹¶é€€å‡ºã€‚æ³¨æ„å‰é¢ 5 ä¸ªåŸŸç”¨ç©ºæ ¼åˆ†éš”ã€‚ åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç³»ç»Ÿå°†æ¯éš” 15 åˆ†é’Ÿå‘æ§åˆ¶å°è¾“å‡ºä¸€æ¬¡å½“å‰æ—¶é—´ã€‚å¦‚æœç³»ç»Ÿå´©æºƒæˆ–æŒ‚èµ·ï¼Œä»æœ€åæ‰€æ˜¾ç¤ºçš„æ—¶é—´å°±å¯ä»¥ä¸€çœ¼çœ‹å‡ºç³»ç»Ÿæ˜¯ä»€ä¹ˆæ—¶é—´åœæ­¢å·¥ä½œçš„ã€‚åœ¨æœ‰äº›ç³»ç»Ÿä¸­ï¼Œç”¨ tty1 æ¥è¡¨ç¤ºæ§åˆ¶å°ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µå¯¹ä¸Šé¢çš„ä¾‹å­è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ã€‚ä¸ºäº†æäº¤ä½ åˆšåˆšåˆ›å»ºçš„ crontab æ–‡ä»¶ï¼Œå¯ä»¥æŠŠè¿™ä¸ªæ–°åˆ›å»ºçš„æ–‡ä»¶ä½œä¸º cron å‘½ä»¤çš„å‚æ•° 1$ crontab davecron ç°åœ¨è¯¥æ–‡ä»¶å·²ç»æäº¤ç»™ cron è¿›ç¨‹ï¼Œå®ƒå°†æ¯éš” 1 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ã€‚åŒæ—¶ï¼Œæ–°åˆ›å»ºæ–‡ä»¶çš„ä¸€ä¸ªå‰¯æœ¬å·²ç»è¢«æ”¾åœ¨/var/spool/cron ç›®å½•ä¸­ï¼Œæ–‡ä»¶åå°±æ˜¯ç”¨æˆ·å(å³ dave)ã€‚ åˆ—å‡º crontab æ–‡ä»¶ä½¿ç”¨-l å‚æ•°åˆ—å‡º crontab æ–‡ä»¶ 12$ crontab -l0,15,30,45 18-06 * * * &#x2F;bin&#x2F;echo &#96;date&#96; &gt; dev&#x2F;tty1 å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•åœ¨$HOME ç›®å½•ä¸­å¯¹ crontab æ–‡ä»¶åšä¸€å¤‡ä»½ 1$ crontab -l &gt; $HOME&#x2F;mycron è¿™æ ·ï¼Œä¸€æ—¦ä¸å°å¿ƒè¯¯åˆ äº† crontab æ–‡ä»¶ï¼Œå¯ä»¥ç”¨ä¸Šä¸€èŠ‚æ‰€è®²è¿°çš„æ–¹æ³•è¿…é€Ÿæ¢å¤ã€‚ ç¼–è¾‘ crontab æ–‡ä»¶å¦‚æœå¸Œæœ›æ·»åŠ ã€åˆ é™¤æˆ–ç¼–è¾‘ crontab æ–‡ä»¶ä¸­çš„æ¡ç›®ï¼Œè€Œ EDITOR ç¯å¢ƒå˜é‡åˆè®¾ç½®ä¸º viï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨ vi æ¥ç¼–è¾‘ crontab æ–‡ä»¶ 1$ crontab -e å¯ä»¥åƒä½¿ç”¨ vi ç¼–è¾‘å…¶ä»–ä»»ä½•æ–‡ä»¶é‚£æ ·ä¿®æ”¹ crontab æ–‡ä»¶å¹¶é€€å‡ºã€‚å¦‚æœä¿®æ”¹äº†æŸäº›æ¡ç›®æˆ–æ·»åŠ äº†æ–°çš„æ¡ç›®ï¼Œé‚£ä¹ˆåœ¨ä¿å­˜è¯¥æ–‡ä»¶æ—¶ï¼Œ cron ä¼šå¯¹å…¶è¿›è¡Œå¿…è¦çš„å®Œæ•´æ€§æ£€æŸ¥ã€‚å¦‚æœå…¶ä¸­çš„æŸä¸ªåŸŸå‡ºç°äº†è¶…å‡ºå…è®¸èŒƒå›´çš„å€¼ï¼Œå®ƒä¼šæç¤ºä½ ã€‚æˆ‘ä»¬åœ¨ç¼–è¾‘ crontab æ–‡ä»¶æ—¶ï¼Œæ²¡å‡†ä¼šåŠ å…¥æ–°çš„æ¡ç›®ã€‚ä¾‹å¦‚ï¼ŒåŠ å…¥ä¸‹é¢çš„ä¸€æ¡ 12# DT:delete core files,at 3.30am on 1,7,14,21,26,26 days of each month 30 3 1,7,14,21,26 * * &#x2F;bin&#x2F;find -name &#39;core&#39; -exec rm &#123;&#125; \\; ä¿å­˜å¹¶é€€å‡ºã€‚ note æœ€å¥½åœ¨crontabæ–‡ä»¶çš„æ¯ä¸€ä¸ªæ¡ç›®ä¹‹ä¸ŠåŠ å…¥ä¸€æ¡æ³¨é‡Šï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“å®ƒçš„åŠŸèƒ½ã€è¿è¡Œæ—¶é—´ï¼Œæ›´ä¸ºé‡è¦çš„æ˜¯ï¼ŒçŸ¥é“è¿™æ˜¯å“ªä½ç”¨æˆ·çš„å®šæ—¶ä½œä¸šã€‚åˆ é™¤ crontab æ–‡ä»¶ 1$crontab -r ä½¿ç”¨å®ä¾‹å®ä¾‹ 1ï¼šæ¯ 1 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ myCommand 1* * * * * myCommand å®ä¾‹ 2ï¼šæ¯å°æ—¶çš„ç¬¬ 3 å’Œç¬¬ 15 åˆ†é’Ÿæ‰§è¡Œ 13,15 * * * * myCommand å®ä¾‹ 3ï¼šåœ¨ä¸Šåˆ 8 ç‚¹åˆ° 11 ç‚¹çš„ç¬¬ 3 å’Œç¬¬ 15 åˆ†é’Ÿæ‰§è¡Œ 13,15 8-11 * * * myCommand å®ä¾‹ 4ï¼šæ¯éš”ä¸¤å¤©çš„ä¸Šåˆ 8 ç‚¹åˆ° 11 ç‚¹çš„ç¬¬ 3 å’Œç¬¬ 15 åˆ†é’Ÿæ‰§è¡Œ 1234567 3,15 8-11 *&#x2F;2 * * myCommand&#96;&#96;&#96;å®ä¾‹ 5ï¼šæ¯å‘¨ä¸€ä¸Šåˆ 8 ç‚¹åˆ° 11 ç‚¹çš„ç¬¬ 3 å’Œç¬¬ 15 åˆ†é’Ÿæ‰§è¡Œ&#96;&#96;&#96;shell 3,15 8-11 * * 1 myCommand å®ä¾‹ 6ï¼šæ¯æ™šçš„ 21:30 é‡å¯ smb 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293 30 21 * * * &#x2F;etc&#x2F;init.d&#x2F;smb restart&#96;&#96;&#96;å®ä¾‹7ï¼šæ¯æœˆ1ã€10ã€22æ—¥çš„4 : 45é‡å¯smb&#96;&#96;&#96;&#96; 45 4 1,10,22 * * &#x2F;etc&#x2F;init.d&#x2F;smb restart&#96;&#96;&#96;å®ä¾‹ 8ï¼šæ¯å‘¨å…­ã€å‘¨æ—¥çš„ 1 : 10 é‡å¯ smb&#96;&#96;&#96; 10 1 * * 6,0 &#x2F;etc&#x2F;init.d&#x2F;smb restart&#96;&#96;&#96;å®ä¾‹9ï¼šæ¯å¤©18 : 00è‡³23 : 00ä¹‹é—´æ¯éš”30åˆ†é’Ÿé‡å¯smb&#96;&#96;&#96; 0,30 18-23 * * * &#x2F;etc&#x2F;init.d&#x2F;smb restart&#96;&#96;&#96;å®ä¾‹ 10ï¼šæ¯æ˜ŸæœŸå…­çš„æ™šä¸Š 11 : 00 pm é‡å¯ smb&#96;&#96;&#96; 0 23 * * 6 &#x2F;etc&#x2F;init.d&#x2F;smb restart&#96;&#96;&#96;å®ä¾‹11ï¼šæ¯ä¸€å°æ—¶é‡å¯smb&#96;&#96;&#96; * *&#x2F;1 * * * &#x2F;etc&#x2F;init.d&#x2F;smb restart&#96;&#96;&#96;å®ä¾‹12ï¼šæ™šä¸Š11ç‚¹åˆ°æ—©ä¸Š7ç‚¹ä¹‹é—´ï¼Œæ¯éš”ä¸€å°æ—¶é‡å¯smb&#96;&#96;&#96; 0 23-7 * * * &#x2F;etc&#x2F;init.d&#x2F;smb restart&#96;&#96;&#96;## ä½¿ç”¨æ³¨æ„äº‹é¡¹æ³¨æ„ç¯å¢ƒå˜é‡é—®é¢˜&#96;&#96;&#96;æœ‰æ—¶æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªcrontabï¼Œä½†æ˜¯è¿™ä¸ªä»»åŠ¡å´æ— æ³•è‡ªåŠ¨æ‰§è¡Œï¼Œè€Œæ‰‹åŠ¨æ‰§è¡Œè¿™ä¸ªä»»åŠ¡å´æ²¡æœ‰é—®é¢˜ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯ç”±äºåœ¨crontabæ–‡ä»¶ä¸­æ²¡æœ‰é…ç½®ç¯å¢ƒå˜é‡å¼•èµ·çš„ã€‚åœ¨crontabæ–‡ä»¶ä¸­å®šä¹‰å¤šä¸ªè°ƒåº¦ä»»åŠ¡æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨ç¯å¢ƒå˜é‡çš„è®¾ç½®ï¼Œå› ä¸ºæˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡ŒæŸä¸ªä»»åŠ¡æ—¶ï¼Œæ˜¯åœ¨å½“å‰shellç¯å¢ƒä¸‹è¿›è¡Œçš„ï¼Œç¨‹åºå½“ç„¶èƒ½æ‰¾åˆ°ç¯å¢ƒå˜é‡ï¼Œè€Œç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œä»»åŠ¡è°ƒåº¦æ—¶ï¼Œæ˜¯ä¸ä¼šåŠ è½½ä»»ä½•ç¯å¢ƒå˜é‡çš„ï¼Œå› æ­¤ï¼Œå°±éœ€è¦åœ¨crontabæ–‡ä»¶ä¸­æŒ‡å®šä»»åŠ¡è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œè¿™æ ·ï¼Œç³»ç»Ÿæ‰§è¡Œä»»åŠ¡è°ƒåº¦æ—¶å°±æ²¡æœ‰é—®é¢˜äº†ã€‚ä¸è¦å‡å®šcronçŸ¥é“æ‰€éœ€è¦çš„ç‰¹æ®Šç¯å¢ƒï¼Œå®ƒå…¶å®å¹¶ä¸çŸ¥é“ã€‚æ‰€ä»¥ä½ è¦ä¿è¯åœ¨shelllè„šæœ¬ä¸­æä¾›æ‰€æœ‰å¿…è¦çš„è·¯å¾„å’Œç¯å¢ƒå˜é‡ï¼Œé™¤äº†ä¸€äº›è‡ªåŠ¨è®¾ç½®çš„å…¨å±€å˜é‡ã€‚æ‰€ä»¥æ³¨æ„å¦‚ä¸‹3ç‚¹ï¼š1. è„šæœ¬ä¸­æ¶‰åŠæ–‡ä»¶è·¯å¾„æ—¶å†™å…¨å±€è·¯å¾„ï¼›2. è„šæœ¬æ‰§è¡Œè¦ç”¨åˆ°javaæˆ–å…¶ä»–ç¯å¢ƒå˜é‡æ—¶ï¼Œé€šè¿‡sourceå‘½ä»¤å¼•å…¥ç¯å¢ƒå˜é‡ï¼Œå¦‚::&#96;&#96;&#96; cat start_cbp.sh !&#x2F;bin&#x2F;sh source &#x2F;etc&#x2F;profile export RUN_CONF&#x3D;&#x2F;home&#x2F;d139&#x2F;conf&#x2F;platform&#x2F;cbp&#x2F;cbp_jboss.conf &#x2F;usr&#x2F;local&#x2F;jboss-4.0.5&#x2F;bin&#x2F;run.sh -c mev &amp;&#96;&#96;&#96;3. å½“æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬OKï¼Œä½†æ˜¯crontabæ­»æ´»ä¸æ‰§è¡Œæ—¶,å¾ˆå¯èƒ½æ˜¯ç¯å¢ƒå˜é‡æƒ¹çš„ç¥¸ï¼Œå¯å°è¯•åœ¨crontabä¸­ç›´æ¥å¼•å…¥ç¯å¢ƒå˜é‡è§£å†³é—®é¢˜ã€‚&#96;&#96;&#96; 0 * * * * . &#x2F;etc&#x2F;profile;&#x2F;bin&#x2F;sh &#x2F;var&#x2F;www&#x2F;java&#x2F;audit_no_count&#x2F;bin&#x2F;restart_audit.sh&#96;&#96;&#96;æ³¨æ„æ¸…ç†ç³»ç»Ÿç”¨æˆ·çš„é‚®ä»¶æ—¥å¿—æ¯æ¡ä»»åŠ¡è°ƒåº¦æ‰§è¡Œå®Œæ¯•ï¼Œç³»ç»Ÿéƒ½ä¼šå°†ä»»åŠ¡è¾“å‡ºä¿¡æ¯é€šè¿‡ç”µå­é‚®ä»¶çš„å½¢å¼å‘é€ç»™å½“å‰ç³»ç»Ÿç”¨æˆ·ï¼Œè¿™æ ·æ—¥ç§¯æœˆç´¯ï¼Œæ—¥å¿—ä¿¡æ¯ä¼šéå¸¸å¤§ï¼Œå¯èƒ½ä¼šå½±å“ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œï¼Œå› æ­¤ï¼Œå°†æ¯æ¡ä»»åŠ¡è¿›è¡Œé‡å®šå‘å¤„ç†éå¸¸é‡è¦ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åœ¨ crontab æ–‡ä»¶ä¸­è®¾ç½®å¦‚ä¸‹å½¢å¼ï¼Œå¿½ç•¥æ—¥å¿—è¾“å‡º::&#96;&#96;&#96; 0 *&#x2F;3 * * * &#x2F;usr&#x2F;local&#x2F;apache2&#x2F;apachectl restart &gt;&#x2F;dev&#x2F;null 2&gt;&amp;1&#96;&#96;&#96;&quot;&#x2F;dev&#x2F;null 2&gt;&amp;1&quot;è¡¨ç¤ºå…ˆå°†æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°&#x2F;dev&#x2F;nullï¼Œç„¶åå°†æ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œç”±äºæ ‡å‡†è¾“å‡ºå·²ç»é‡å®šå‘åˆ°äº†&#x2F;dev&#x2F;nullï¼Œå› æ­¤æ ‡å‡†é”™è¯¯ä¹Ÿä¼šé‡å®šå‘åˆ°&#x2F;dev&#x2F;nullï¼Œè¿™æ ·æ—¥å¿—è¾“å‡ºé—®é¢˜å°±è§£å†³äº†ã€‚ç³»ç»Ÿçº§ä»»åŠ¡è°ƒåº¦ä¸ç”¨æˆ·çº§ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿçº§ä»»åŠ¡è°ƒåº¦ä¸»è¦å®Œæˆç³»ç»Ÿçš„ä¸€äº›ç»´æŠ¤æ“ä½œï¼Œç”¨æˆ·çº§ä»»åŠ¡è°ƒåº¦ä¸»è¦å®Œæˆç”¨æˆ·è‡ªå®šä¹‰çš„ä¸€äº›ä»»åŠ¡ï¼Œå¯ä»¥å°†ç”¨æˆ·çº§ä»»åŠ¡è°ƒåº¦æ”¾åˆ°ç³»ç»Ÿçº§ä»»åŠ¡è°ƒåº¦æ¥å®Œæˆï¼ˆä¸å»ºè®®è¿™ä¹ˆåšï¼‰ï¼Œä½†æ˜¯åè¿‡æ¥å´ä¸è¡Œï¼Œrootç”¨æˆ·çš„ä»»åŠ¡è°ƒåº¦æ“ä½œå¯ä»¥é€šè¿‡&quot;crontab â€“uroot â€“e&quot;æ¥è®¾ç½®ï¼Œä¹Ÿå¯ä»¥å°†è°ƒåº¦ä»»åŠ¡ç›´æ¥å†™å…¥&#x2F;etc&#x2F;crontabæ–‡ä»¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¦å®šä¹‰ä¸€ä¸ªå®šæ—¶é‡å¯ç³»ç»Ÿçš„ä»»åŠ¡ï¼Œå°±å¿…é¡»å°†ä»»åŠ¡æ”¾åˆ°&#x2F;etc&#x2F;crontabæ–‡ä»¶ï¼Œå³ä½¿åœ¨rootç”¨æˆ·ä¸‹åˆ›å»ºä¸€ä¸ªå®šæ—¶é‡å¯ç³»ç»Ÿçš„ä»»åŠ¡ä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚å…¶ä»–æ³¨æ„äº‹é¡¹æ–°åˆ›å»ºçš„cron jobï¼Œä¸ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè‡³å°‘è¦è¿‡2åˆ†é’Ÿæ‰æ‰§è¡Œã€‚å¦‚æœé‡å¯cronåˆ™é©¬ä¸Šæ‰§è¡Œã€‚å½“crontabå¤±æ•ˆæ—¶ï¼Œå¯ä»¥å°è¯•&#x2F;etc&#x2F;init.d&#x2F;crond restartè§£å†³é—®é¢˜ã€‚æˆ–è€…æŸ¥çœ‹æ—¥å¿—çœ‹æŸä¸ªjobæœ‰æ²¡æœ‰æ‰§è¡Œ&#x2F;æŠ¥é”™tail -f &#x2F;var&#x2F;log&#x2F;cronã€‚åƒä¸‡åˆ«ä¹±è¿è¡Œcrontab -rã€‚å®ƒä»Crontabç›®å½•ï¼ˆ&#x2F;var&#x2F;spool&#x2F;cronï¼‰ä¸­åˆ é™¤ç”¨æˆ·çš„Crontabæ–‡ä»¶ã€‚åˆ é™¤äº†è¯¥ç”¨æˆ·çš„æ‰€æœ‰crontabéƒ½æ²¡äº†ã€‚åœ¨crontabä¸­%æ˜¯æœ‰ç‰¹æ®Šå«ä¹‰çš„ï¼Œè¡¨ç¤ºæ¢è¡Œçš„æ„æ€ã€‚å¦‚æœè¦ç”¨çš„è¯å¿…é¡»è¿›è¡Œè½¬ä¹‰\\%ï¼Œå¦‚ç»å¸¸ç”¨çš„date â€˜+%Y%m%dâ€™åœ¨crontabé‡Œæ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œåº”è¯¥æ¢æˆdate â€˜+\\%Y\\%m\\%dâ€™ã€‚æ›´æ–°ç³»ç»Ÿæ—¶é—´æ—¶åŒºåéœ€è¦é‡å¯cron,åœ¨ubuntuä¸­æœåŠ¡åä¸ºcron::&#96;&#96;&#96; $service cron restart&#96;&#96;&#96;ubuntuä¸‹å¯åŠ¨ã€åœæ­¢ä¸é‡å¯cron::&#96;&#96;&#96; $sudo &#x2F;etc&#x2F;init.d&#x2F;cron start $sudo &#x2F;etc&#x2F;init.d&#x2F;cron stop $sudo &#x2F;etc&#x2F;init.d&#x2F;cron restart&#96;&#96;&#96;Centsoç³»ç»Ÿä¸‹ç®¡ç†crond&#96;&#96;&#96;systemctl restart crond&#96;&#96;&#96;","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Crontab","slug":"Crontab","permalink":"http://blog.crazylaw.cn/tags/Crontab/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘- æ€§èƒ½ä¼˜åŒ–","slug":"linux-shell-performance-2","date":"2018-02-28T07:10:06.000Z","updated":"2021-03-20T16:25:01.810Z","comments":true,"path":"2018/02/28/linux-shell-performance-2/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/linux-shell-performance-2/","excerpt":"æ€§èƒ½ä¼˜åŒ–contents:: ç›®å½• æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯æ‰¾å‡ºç³»ç»Ÿçš„ç“¶é¢ˆç‚¹ï¼Œé—®é¢˜æ‰¾åˆ°äº†ï¼Œä¼˜åŒ–çš„å·¥ä½œä¹Ÿå°±å®Œæˆäº†å¤§åŠï¼›è¿™é‡Œä»‹ç»çš„æ€§èƒ½ä¼˜åŒ–ä¸»è¦ä»ä¸¤ä¸ªå±‚é¢æ¥ä»‹ç»ï¼šç³»ç»Ÿå±‚é¢å’Œç¨‹åºå±‚é¢ï¼› åˆ†æç³»ç»Ÿç“¶é¢ˆç³»ç»Ÿå“åº”å˜æ…¢ï¼Œé¦–å…ˆå¾—å®šä½å¤§è‡´çš„é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Œæ˜¯ IO ç“¶é¢ˆã€CPU ç“¶é¢ˆã€å†…å­˜ç“¶é¢ˆè¿˜æ˜¯ç¨‹åºå¯¼è‡´çš„ç³»ç»Ÿé—®é¢˜ï¼› ä½¿ç”¨ top å·¥å…·èƒ½å¤Ÿæ¯”è¾ƒå…¨é¢çš„æŸ¥çœ‹æˆ‘ä»¬å…³æ³¨çš„ç‚¹::","text":"æ€§èƒ½ä¼˜åŒ–contents:: ç›®å½• æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯æ‰¾å‡ºç³»ç»Ÿçš„ç“¶é¢ˆç‚¹ï¼Œé—®é¢˜æ‰¾åˆ°äº†ï¼Œä¼˜åŒ–çš„å·¥ä½œä¹Ÿå°±å®Œæˆäº†å¤§åŠï¼›è¿™é‡Œä»‹ç»çš„æ€§èƒ½ä¼˜åŒ–ä¸»è¦ä»ä¸¤ä¸ªå±‚é¢æ¥ä»‹ç»ï¼šç³»ç»Ÿå±‚é¢å’Œç¨‹åºå±‚é¢ï¼› åˆ†æç³»ç»Ÿç“¶é¢ˆç³»ç»Ÿå“åº”å˜æ…¢ï¼Œé¦–å…ˆå¾—å®šä½å¤§è‡´çš„é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Œæ˜¯ IO ç“¶é¢ˆã€CPU ç“¶é¢ˆã€å†…å­˜ç“¶é¢ˆè¿˜æ˜¯ç¨‹åºå¯¼è‡´çš„ç³»ç»Ÿé—®é¢˜ï¼› ä½¿ç”¨ top å·¥å…·èƒ½å¤Ÿæ¯”è¾ƒå…¨é¢çš„æŸ¥çœ‹æˆ‘ä»¬å…³æ³¨çš„ç‚¹:: 1234567891011$toptop - 09:14:56 up 264 days, 20:56, 1 user, load average: 0.02, 0.04, 0.00Tasks: 87 total, 1 running, 86 sleeping, 0 stopped, 0 zombieCpu(s): 0.0%us, 0.2%sy, 0.0%ni, 99.7%id, 0.0%wa, 0.0%hi, 0.0%si, 0.2%stMem: 377672k total, 322332k used, 55340k free, 32592k buffersSwap: 397308k total, 67192k used, 330116k free, 71900k cachedPID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND1 root 20 0 2856 656 388 S 0.0 0.2 0:49.40 init2 root 20 0 0 0 0 S 0.0 0.0 0:00.00 kthreadd3 root 20 0 0 0 0 S 0.0 0.0 7:15.20 ksoftirqd&#x2F;04 root RT 0 0 0 0 S 0.0 0.0 0:00.00 migration&#x2F; è¿›å…¥äº¤äº’æ¨¡å¼å: - è¾“å…¥ Mï¼Œè¿›ç¨‹åˆ—è¡¨æŒ‰å†…å­˜ä½¿ç”¨å¤§å°é™åºæ’åºï¼Œä¾¿äºæˆ‘ä»¬è§‚å¯Ÿæœ€å¤§å†…å­˜ä½¿ç”¨è€…ä½¿ç”¨æœ‰é—®é¢˜ï¼ˆæ£€æµ‹å†…å­˜æ³„æ¼é—®é¢˜ï¼‰; - è¾“å…¥ Pï¼Œè¿›ç¨‹åˆ—è¡¨æŒ‰ CPU ä½¿ç”¨å¤§å°é™åºæ’åºï¼Œä¾¿äºæˆ‘ä»¬è§‚å¯Ÿæœ€è€— CPU èµ„æºçš„ä½¿ç”¨è€…æ˜¯å¦æœ‰é—®é¢˜ï¼› top ç¬¬ä¸‰è¡Œæ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªå€¼å¾ˆå…³é”®: - %idï¼šç©ºé—² CPU æ—¶é—´ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¿™ä¸ªå€¼è¿‡ä½ï¼Œè¡¨æ˜ç³»ç»Ÿ CPU å­˜åœ¨ç“¶é¢ˆï¼› - %waï¼šç­‰å¾… I/O çš„ CPU æ—¶é—´ç™¾åˆ†æ¯”ï¼Œå¦‚æœè¿™ä¸ªå€¼è¿‡é«˜ï¼Œè¡¨æ˜ IO å­˜åœ¨ç“¶é¢ˆï¼› åˆ†æå†…å­˜ç“¶é¢ˆæŸ¥çœ‹å†…å­˜æ˜¯å¦å­˜åœ¨ç“¶é¢ˆï¼Œä½¿ç”¨ top æŒ‡ä»¤çœ‹æ¯”è¾ƒéº»çƒ¦ï¼Œè€Œ free å‘½ä»¤æ›´ä¸ºç›´è§‚:: 1234567891011[&#x2F;home&#x2F;weber#]free total used free shared buffers cachedMem: 501820 452028 49792 37064 5056 136732-&#x2F;+ buffers&#x2F;cache: 310240 191580Swap: 0 0 0[&#x2F;home&#x2F;weber#]toptop - 17:52:17 up 42 days, 7:10, 1 user, load average: 0.02, 0.02, 0.05Tasks: 80 total, 1 running, 79 sleeping, 0 stopped, 0 zombie%Cpu(s): 0.0 us, 0.0 sy, 0.0 ni,100.0 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 stKiB Mem: 501820 total, 452548 used, 49272 free, 5144 buffersKiB Swap: 0 total, 0 used, 0 free. 136988 cached Mem top å·¥å…·æ˜¾ç¤ºäº† free å·¥å…·çš„ç¬¬ä¸€è¡Œæ‰€æœ‰ä¿¡æ¯ï¼Œä½†çœŸå®å¯ç”¨çš„å†…å­˜ï¼Œè¿˜éœ€è¦è‡ªå·±è®¡ç®—æ‰çŸ¥é“;ç³»ç»Ÿå®é™…å¯ç”¨çš„å†…å­˜ä¸º free å·¥å…·è¾“å‡ºç¬¬äºŒè¡Œçš„ free+buffer+cachedï¼›ä¹Ÿå°±æ˜¯ç¬¬ä¸‰è¡Œçš„ free å€¼ 191580ï¼›å…³äº free å‘½ä»¤å„ä¸ªå€¼çš„è¯¦æƒ…è§£è¯»ï¼Œè¯·å‚è€ƒè¿™ç¯‡æ–‡ç«  :ref:free ; å¦‚æœæ˜¯å› ä¸ºç¼ºå°‘å†…å­˜ï¼Œç³»ç»Ÿå“åº”å˜æ…¢å¾ˆæ˜æ˜¾ï¼Œå› ä¸ºè¿™ä½¿å¾—ç³»ç»Ÿä¸åœçš„åšæ¢å…¥æ¢å‡ºçš„å·¥ä½œ; è¿›ä¸€æ­¥çš„ç›‘è§†å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå¯ä½¿ç”¨ vmstat å·¥å…·ï¼Œå®æ—¶åŠ¨æ€ç›‘è§†æ“ä½œç³»ç»Ÿçš„å†…å­˜å’Œè™šæ‹Ÿå†…å­˜çš„åŠ¨æ€å˜åŒ–ã€‚å‚è€ƒï¼š :ref:vmstat ; åˆ†æ IO ç“¶é¢ˆå¦‚æœ IO å­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼Œtop å·¥å…·ä¸­çš„%wa ä¼šåé«˜ï¼› è¿›ä¸€æ­¥åˆ†æä½¿ç”¨ iostat å·¥å…·:: 12345678&#x2F;root$iostat -d -x -k 1 1Linux 2.6.32-279.el6.x86_64 (colin) 07&#x2F;16&#x2F;2014 _x86_64_ (4 CPU)Device: rrqm&#x2F;s wrqm&#x2F;s r&#x2F;s w&#x2F;s rkB&#x2F;s wkB&#x2F;s avgrq-sz avgqu-sz await svctm %utilsda 0.02 7.25 0.04 1.90 0.74 35.47 37.15 0.04 19.13 5.58 1.09dm-0 0.00 0.00 0.04 3.05 0.28 12.18 8.07 0.65 209.01 1.11 0.34dm-1 0.00 0.00 0.02 5.82 0.46 23.26 8.13 0.43 74.33 1.30 0.76dm-2 0.00 0.00 0.00 0.01 0.00 0.02 8.00 0.00 5.41 3.28 0.00 å¦‚æœ%iowait çš„å€¼è¿‡é«˜ï¼Œè¡¨ç¤ºç¡¬ç›˜å­˜åœ¨ I/O ç“¶é¢ˆã€‚ å¦‚æœ %util æ¥è¿‘ 100%ï¼Œè¯´æ˜äº§ç”Ÿçš„ I/O è¯·æ±‚å¤ªå¤šï¼ŒI/O ç³»ç»Ÿå·²ç»æ»¡è´Ÿè·ï¼Œè¯¥ç£ç›˜å¯èƒ½å­˜åœ¨ç“¶é¢ˆã€‚ å¦‚æœ svctm æ¯”è¾ƒæ¥è¿‘ awaitï¼Œè¯´æ˜ I/O å‡ ä¹æ²¡æœ‰ç­‰å¾…æ—¶é—´ï¼› å¦‚æœ await è¿œå¤§äº svctmï¼Œè¯´æ˜ I/O é˜Ÿåˆ—å¤ªé•¿ï¼Œio å“åº”å¤ªæ…¢ï¼Œåˆ™éœ€è¦è¿›è¡Œå¿…è¦ä¼˜åŒ–ã€‚ å¦‚æœ avgqu-sz æ¯”è¾ƒå¤§ï¼Œä¹Ÿè¡¨ç¤ºæœ‰å¤§é‡ io åœ¨ç­‰å¾…ã€‚ æ›´å¤šå‚æ•°è¯´æ˜è¯·å‚è€ƒ :ref:iostat ; åˆ†æè¿›ç¨‹è°ƒç”¨é€šè¿‡ top ç­‰å·¥å…·å‘ç°ç³»ç»Ÿæ€§èƒ½é—®é¢˜æ˜¯ç”±æŸä¸ªè¿›ç¨‹å¯¼è‡´çš„ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦åˆ†æè¿™ä¸ªè¿›ç¨‹ï¼›ç»§ç»­æŸ¥è¯¢é—®é¢˜åœ¨å“ªï¼› è¿™é‡Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªå¥½ç”¨çš„å·¥å…·ï¼špstack å’Œ pstrace pstack ç”¨æ¥è·Ÿè¸ªè¿›ç¨‹æ ˆï¼Œè¿™ä¸ªå‘½ä»¤åœ¨æ’æŸ¥è¿›ç¨‹é—®é¢˜æ—¶éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å‘ç°ä¸€ä¸ªæœåŠ¡ä¸€ç›´å¤„äº work çŠ¶æ€ï¼ˆå¦‚å‡æ­»çŠ¶æ€ï¼Œå¥½ä¼¼æ­»å¾ªç¯ï¼‰ï¼Œä½¿ç”¨è¿™ä¸ªå‘½ä»¤å°±èƒ½è½»æ¾å®šä½é—®é¢˜æ‰€åœ¨ï¼›å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œå¤šæ‰§è¡Œå‡ æ¬¡ pstackï¼Œè‹¥å‘ç°ä»£ç æ ˆæ€»æ˜¯åœåœ¨åŒä¸€ä¸ªä½ç½®ï¼Œé‚£ä¸ªä½ç½®å°±éœ€è¦é‡ç‚¹å…³æ³¨ï¼Œå¾ˆå¯èƒ½å°±æ˜¯å‡ºé—®é¢˜çš„åœ°æ–¹ï¼› ç¤ºä¾‹ï¼šæŸ¥çœ‹ bash ç¨‹åºè¿›ç¨‹æ ˆ:: 123456789101112131415161718&#x2F;opt&#x2F;app&#x2F;tdev1$ps -fe| grep bashtdev1 7013 7012 0 19:42 pts&#x2F;1 00:00:00 -bashtdev1 11402 11401 0 20:31 pts&#x2F;2 00:00:00 -bashtdev1 11474 11402 0 20:32 pts&#x2F;2 00:00:00 grep bash&#x2F;opt&#x2F;app&#x2F;tdev1$pstack 7013#0 0x00000039958c5620 in __read_nocancel () from &#x2F;lib64&#x2F;libc.so.6#1 0x000000000047dafe in rl_getc ()#2 0x000000000047def6 in rl_read_key ()#3 0x000000000046d0f5 in readline_internal_char ()#4 0x000000000046d4e5 in readline ()#5 0x00000000004213cf in ?? ()#6 0x000000000041d685 in ?? ()#7 0x000000000041e89e in ?? ()#8 0x00000000004218dc in yyparse ()#9 0x000000000041b507 in parse_command ()#10 0x000000000041b5c6 in read_command ()#11 0x000000000041b74e in reader_loop ()#12 0x000000000041b2aa in main () è€Œ strace ç”¨æ¥è·Ÿè¸ªè¿›ç¨‹ä¸­çš„ç³»ç»Ÿè°ƒç”¨ï¼›è¿™ä¸ªå·¥å…·èƒ½å¤ŸåŠ¨æ€çš„è·Ÿè¸ªè¿›ç¨‹æ‰§è¡Œæ—¶çš„ç³»ç»Ÿè°ƒç”¨å’Œæ‰€æ¥æ”¶çš„ä¿¡å·ã€‚æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ•ˆçš„æ£€æµ‹ã€æŒ‡å¯¼å’Œè°ƒè¯•å·¥å…·ã€‚ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é€šè¿‡è¯¥å‘½ä»¤å®¹æ˜“åœ°è§£å†³ç¨‹åºé—®é¢˜ã€‚ å‚è€ƒï¼š :ref:strace ; ä¼˜åŒ–ç¨‹åºä»£ç ä¼˜åŒ–è‡ªå·±å¼€å‘çš„ç¨‹åºï¼Œå»ºè®®é‡‡ç”¨ä»¥ä¸‹å‡†åˆ™:: äºŒå…«æ³•åˆ™ï¼šåœ¨ä»»ä½•ä¸€ç»„ä¸œè¥¿ä¸­ï¼Œæœ€é‡è¦çš„åªå å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼Œçº¦ 20%ï¼Œå…¶ä½™ 80%çš„å°½ç®¡æ˜¯å¤šæ•°ï¼Œå´æ˜¯æ¬¡è¦çš„ï¼›åœ¨ä¼˜åŒ–å®è·µä¸­ï¼Œæˆ‘ä»¬å°†ç²¾åŠ›é›†ä¸­åœ¨ä¼˜åŒ–é‚£ 20%æœ€è€—æ—¶çš„ä»£ç ä¸Šï¼Œæ•´ä½“æ€§èƒ½å°†æœ‰æ˜¾è‘—çš„æå‡ï¼›è¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚å‡½æ•° A è™½ç„¶ä»£ç é‡å¤§ï¼Œä½†åœ¨ä¸€æ¬¡æ­£å¸¸æ‰§è¡Œæµç¨‹ä¸­ï¼Œåªè°ƒç”¨äº†ä¸€æ¬¡ã€‚è€Œå¦ä¸€ä¸ªå‡½æ•° B ä»£ç é‡æ¯” A å°å¾ˆå¤šï¼Œä½†è¢«è°ƒç”¨äº† 1000 æ¬¡ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬æ›´åº”å…³æ³¨ B çš„ä¼˜åŒ–ã€‚ ç¼–å®Œä»£ç ï¼Œå†ä¼˜åŒ–ï¼›ç¼–ç çš„æ—¶å€™æ€»æ˜¯è€ƒè™‘æœ€ä½³æ€§èƒ½æœªå¿…æ€»æ˜¯å¥½çš„ï¼›åœ¨å¼ºè°ƒæœ€ä½³æ€§èƒ½çš„ç¼–ç æ–¹å¼çš„åŒæ—¶ï¼Œå¯èƒ½å°±æŸå¤±äº†ä»£ç çš„å¯è¯»æ€§å’Œå¼€å‘æ•ˆç‡ï¼› gprof ä½¿ç”¨æ­¥éª¤ ç”¨ gccã€g++ã€xlC ç¼–è¯‘ç¨‹åºæ—¶ï¼Œä½¿ç”¨-pg å‚æ•°ï¼Œå¦‚ï¼šg++ -pg -o test.exe test.cpp ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨ç›®æ ‡ä»£ç ä¸­æ’å…¥ç”¨äºæ€§èƒ½æµ‹è¯•çš„ä»£ç ç‰‡æ–­ï¼Œè¿™äº›ä»£ç åœ¨ç¨‹åºè¿è¡Œæ—¶é‡‡é›†å¹¶è®°å½•å‡½æ•°çš„è°ƒç”¨å…³ç³»å’Œè°ƒç”¨æ¬¡æ•°ï¼Œå¹¶è®°å½•å‡½æ•°è‡ªèº«æ‰§è¡Œæ—¶é—´å’Œè¢«è°ƒç”¨å‡½æ•°çš„æ‰§è¡Œæ—¶é—´ã€‚ æ‰§è¡Œç¼–è¯‘åçš„å¯æ‰§è¡Œç¨‹åºï¼Œå¦‚ï¼š./test.exeã€‚è¯¥æ­¥éª¤è¿è¡Œç¨‹åºçš„æ—¶é—´ä¼šç¨æ…¢äºæ­£å¸¸ç¼–è¯‘çš„å¯æ‰§è¡Œç¨‹åºçš„è¿è¡Œæ—¶é—´ã€‚ç¨‹åºè¿è¡Œç»“æŸåï¼Œä¼šåœ¨ç¨‹åºæ‰€åœ¨è·¯å¾„ä¸‹ç”Ÿæˆä¸€ä¸ªç¼ºçœæ–‡ä»¶åä¸º gmon.out çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯è®°å½•ç¨‹åºè¿è¡Œçš„æ€§èƒ½ã€è°ƒç”¨å…³ç³»ã€è°ƒç”¨æ¬¡æ•°ç­‰ä¿¡æ¯çš„æ•°æ®æ–‡ä»¶ã€‚ ä½¿ç”¨ gprof å‘½ä»¤æ¥åˆ†æè®°å½•ç¨‹åºè¿è¡Œä¿¡æ¯çš„ gmon.out æ–‡ä»¶ï¼Œå¦‚ï¼šgprof test.exe gmon.out åˆ™å¯ä»¥åœ¨æ˜¾ç¤ºå™¨ä¸Šçœ‹åˆ°å‡½æ•°è°ƒç”¨ç›¸å…³çš„ç»Ÿè®¡ã€åˆ†æä¿¡æ¯ã€‚ä¸Šè¿°ä¿¡æ¯ä¹Ÿå¯ä»¥é‡‡ç”¨ gprof test.exe gmon.out&gt; gprofresult.txt é‡å®šå‘åˆ°æ–‡æœ¬æ–‡ä»¶ä»¥ä¾¿äºåç»­åˆ†æã€‚ å…³äº gprof çš„ä½¿ç”¨æ¡ˆä¾‹ï¼Œè¯·å‚è€ƒ [f1]_ ; å…¶å®ƒå·¥å…·è°ƒè¯•å†…å­˜æ³„æ¼çš„å·¥å…· valgrindï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ google äº†è§£ï¼› OProfile: Linux å¹³å°ä¸Šçš„ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æ€§èƒ½åˆ†æå·¥å…·,ä½¿ç”¨å‚è€ƒ [f2]_ ; é™¤äº†ä¸Šé¢ä»‹ç»çš„å·¥å…·ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒå…¨é¢çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œæ¯”å¦‚ sarï¼ˆLinux ç³»ç»Ÿä¸Šé»˜è®¤ä¸å®‰è£…ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ä¸‹ï¼‰ï¼›å°† sar çš„å¸¸é©»ç›‘æ§å·¥å…·æ‰“å¼€åï¼Œèƒ½å¤Ÿæ”¶é›†æ¯”è¾ƒå…¨é¢çš„æ€§èƒ½åˆ†ææ•°æ®ï¼› å…³äº sar çš„ä½¿ç”¨ï¼Œå‚è€ƒ :ref:sar ; .. [f1] C++çš„æ€§èƒ½ä¼˜åŒ–å®è·µ http://www.cnblogs.com/me115/archive/2013/06/05/3117967.html.. [f2] ç”¨ OProfile å½»åº•äº†è§£æ€§èƒ½ http://www.ibm.com/developerworks/cn/linux/l-oprof/.. [f3] Linux ä¸Šçš„ free å‘½ä»¤è¯¦è§£ http://www.cnblogs.com/coldplayerest/archive/2010/02/20/1669949.html","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘- æ€§èƒ½ç›‘æ§","slug":"linux-shell-performance","date":"2018-02-28T07:00:50.000Z","updated":"2021-03-20T16:25:01.810Z","comments":true,"path":"2018/02/28/linux-shell-performance/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/linux-shell-performance/","excerpt":"ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æŸ¥çœ‹å½“å‰çš„æ€§èƒ½å¦‚ä½•ï¼Œéœ€è¦äº†è§£ CPUã€å†…å­˜å’Œç¡¬ç›˜çš„ä½¿ç”¨æƒ…å†µï¼›æœ¬èŠ‚ä»‹ç»çš„è¿™å‡ ä¸ªå·¥å…·èƒ½æ»¡è¶³æ—¥å¸¸å·¥ä½œè¦æ±‚ï¼› ç›‘æ§ CPU1top æŸ¥è¯¢å†…å­˜1free -m","text":"ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æŸ¥çœ‹å½“å‰çš„æ€§èƒ½å¦‚ä½•ï¼Œéœ€è¦äº†è§£ CPUã€å†…å­˜å’Œç¡¬ç›˜çš„ä½¿ç”¨æƒ…å†µï¼›æœ¬èŠ‚ä»‹ç»çš„è¿™å‡ ä¸ªå·¥å…·èƒ½æ»¡è¶³æ—¥å¸¸å·¥ä½œè¦æ±‚ï¼› ç›‘æ§ CPU1top æŸ¥è¯¢å†…å­˜1free -m å½“ç³»ç»Ÿä¸­ sar ä¸å¯ç”¨æ—¶(sar æœ€å¥½ç”¨)ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·æ›¿ä»£ï¼šlinux ä¸‹æœ‰ vmstatã€Unix ç³»ç»Ÿæœ‰ prstat egï¼šæŸ¥çœ‹ cpuã€å†…å­˜ã€ä½¿ç”¨æƒ…å†µï¼švmstat n m ï¼ˆn ä¸ºç›‘æ§é¢‘ç‡ã€m ä¸ºç›‘æ§æ¬¡æ•°ï¼‰ 123456[&#x2F;home&#x2F;weber#]vmstat 1 3procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----r b swpd free buff cache si so bi bo in cs us sy id wa0 0 86560 42300 9752 63556 0 1 1 1 0 0 0 0 99 01 0 86560 39936 9764 63544 0 0 0 52 66 95 5 0 95 00 0 86560 42168 9772 63556 0 0 0 20 127 231 13 2 84 0 ä½¿ç”¨ watch å·¥å…·ç›‘æ§å˜åŒ–å½“éœ€è¦æŒç»­çš„ç›‘æ§åº”ç”¨çš„æŸä¸ªæ•°æ®å˜åŒ–æ—¶ï¼Œwatch å·¥å…·èƒ½æ»¡è¶³è¦æ±‚ï¼›æ‰§è¡Œ watch å‘½ä»¤åï¼Œä¼šè¿›å…¥åˆ°ä¸€ä¸ªç•Œé¢ï¼Œè¾“å‡ºå½“å‰è¢«ç›‘æ§çš„æ•°æ®ï¼Œä¸€æ—¦æ•°æ®å˜åŒ–ï¼Œä¾¿ä¼šé«˜äº®æ˜¾ç¤ºå˜åŒ–æƒ…å†µï¼› egï¼šæ“ä½œ redis æ—¶ï¼Œç›‘æ§å†…å­˜å˜åŒ–ï¼š 123456789$watch -d -n 1 &#39;.&#x2F;redis-cli info | grep memory&#39;(ä»¥ä¸‹ä¸ºwatchå·¥å…·ä¸­çš„ç•Œé¢å†…å®¹ï¼Œä¸€æ—¦å†…å­˜å˜åŒ–ï¼Œå³å®æ—¶é«˜äº®æ˜¾ç¤ºå˜åŒ–ï¼‰Every 1.0s: .&#x2F;redis-cli info | grep memory Mon Apr 28 16:10:36 2014used_memory:45157376used_memory_human:43.07Mused_memory_rss:47628288used_memory_peak:49686080used_memory_peak_human:47.38M æ€»ç»“top / sar / free / watch","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘- è¿›ç¨‹ç®¡ç†å·¥å…·","slug":"linux-shell-processor","date":"2018-02-28T06:50:53.000Z","updated":"2021-03-20T16:25:01.810Z","comments":true,"path":"2018/02/28/linux-shell-processor/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/linux-shell-processor/","excerpt":"æŸ¥è¯¢è¿›ç¨‹123456789101112ps -ef// æŸ¥çœ‹æŸç”¨æˆ·çš„è¿›ç¨‹ps -u phper// æŸ¥çœ‹è¿›ç¨‹å®Œæ•´ä¿¡æ¯ps -ajx// æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯ï¼Œå¹¶å®æ—¶æ›´æ–°top","text":"æŸ¥è¯¢è¿›ç¨‹123456789101112ps -ef// æŸ¥çœ‹æŸç”¨æˆ·çš„è¿›ç¨‹ps -u phper// æŸ¥çœ‹è¿›ç¨‹å®Œæ•´ä¿¡æ¯ps -ajx// æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯ï¼Œå¹¶å®æ—¶æ›´æ–°top åˆ†æçº¿ç¨‹æ ˆ1pmap PID","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘- ç£ç›˜ç®¡ç†","slug":"linux-shell-disk","date":"2018-02-28T06:15:00.000Z","updated":"2021-03-20T16:25:01.809Z","comments":true,"path":"2018/02/28/linux-shell-disk/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/28/linux-shell-disk/","excerpt":"df æŸ¥çœ‹ç£ç›˜ç©ºé—´ -h å‹å¥½çš„æ–¹å¼æ˜¾ç¤ºï¼ˆé»˜è®¤æ˜¯ bytesï¼‰ 1df -h du æŸ¥çœ‹ç›®å½•æ‰€å ç©ºé—´å¤§å° -s é€’å½’ç›®å½•æ€»å’Œ -h å‹å¥½çš„æ–¹å¼æ˜¾ç¤ºï¼ˆé»˜è®¤æ˜¯ bytesï¼‰ 1du -sh","text":"df æŸ¥çœ‹ç£ç›˜ç©ºé—´ -h å‹å¥½çš„æ–¹å¼æ˜¾ç¤ºï¼ˆé»˜è®¤æ˜¯ bytesï¼‰ 1df -h du æŸ¥çœ‹ç›®å½•æ‰€å ç©ºé—´å¤§å° -s é€’å½’ç›®å½•æ€»å’Œ -h å‹å¥½çš„æ–¹å¼æ˜¾ç¤ºï¼ˆé»˜è®¤æ˜¯ bytesï¼‰ 1du -sh æŸ¥çœ‹å½“å‰ç›®å½•æ‰€æœ‰â€œæ–‡ä»¶ï¼ˆåŒ…å«ç›®å½•ï¼‰â€çš„å¤§å°ï¼Œå¹¶ä¸”æŒ‰ç…§å¤§åˆ°å°æ’åºï¼Œæ˜¾ç¤ºå‰ 3 ä¸ª 12345du -s * | sort -nr | head -3ordu -s * | sort -n | tail -3 æ‰“åŒ…/å‹ç¼©æ‰“åŒ…æ˜¯å°†å¤šä¸ªæ–‡ä»¶å½’å¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶:: 1tar -cvf etc.tar /etc &lt;==ä»…æ‰“åŒ…ï¼Œä¸å‹ç¼©! -c :æ‰“åŒ…é€‰é¡¹ -v :æ˜¾ç¤ºæ‰“åŒ…è¿›åº¦ -f :ä½¿ç”¨æ¡£æ¡ˆæ–‡ä»¶æ³¨ï¼šæœ‰çš„ç³»ç»Ÿä¸­æŒ‡å®šå‚æ•°æ—¶ä¸éœ€è¦åœ¨å‰é¢åŠ ä¸Š-ï¼Œç›´æ¥ä½¿ç”¨ tar xvf å‹ç¼©1gzip demo.txt è§£åŒ… -z è§£å‹ gz æ–‡ä»¶ -j è§£å‹ bz2 æ–‡ä»¶ -J è§£å‹ xz æ–‡ä»¶ 1tar -xvf demo.tar 12å¸¸ç”¨ï¼štar -zxvf demo.tar æ€»ç»“æŸ¥çœ‹ç£ç›˜ç©ºé—´ df -h æŸ¥çœ‹ç›®å½•å¤§å° du -sh æ‰“åŒ… tar -cvf è§£åŒ… tar -xvf(z/j/J) å‹ç¼© gzip è§£å‹ç¼© gunzip bzip","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘- æ–‡æœ¬å¤„ç†","slug":"linux-shell-text","date":"2018-02-27T09:29:00.000Z","updated":"2021-03-20T16:25:01.810Z","comments":true,"path":"2018/02/27/linux-shell-text/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/27/linux-shell-text/","excerpt":"find æ–‡ä»¶æŸ¥æ‰¾find é»˜è®¤æ˜¯ä¼šæŠŠæ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶éƒ½ä¸€èµ·è¾“å‡ºï¼Œé™¤éåŠ äº†type -fï¼Œæ­¤æ—¶å°±åªä¼šè¾“å‡ºæ–‡ä»¶ï¼Œtype -dï¼Œæ­¤æ—¶å°±åªä¼šè¾“å‡ºç›®å½• æŸ¥æ‰¾ txt å’Œ pdf æ–‡ä»¶ 1234find ./ \\( -name \"*.php\" -o -name \"*.p\" \\)find ./ \\( -name \"*.php\" -or -name \"*.p\" \\)// åŒæ—¶åŒ…å«å‘½åfind ./ \\( -name \"*.php\" -and -name \"*.p\" \\) æ­£åˆ™æ–¹å¼æŸ¥æ‰¾.txt å’Œ.pdf 1find ./ -regex \".*\\(php\\|p\\)\" iregexï¼šå¿½ç•¥å¤§å°å†™çš„æ­£åˆ™ å¦å®šå‚æ•°ï¼ŒæŸ¥æ‰¾æ‰€æœ‰é txt æ–‡ä»¶ 1find ./ -name \"*.txtx\" æŒ‡å®šæœç´¢æ·±åº¦,æ‰“å°å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶ï¼ˆæ·±åº¦ä¸º 1ï¼Œé»˜è®¤ä¸º 1ï¼‰: 1find ./ -maxdepth 1 -type f","text":"find æ–‡ä»¶æŸ¥æ‰¾find é»˜è®¤æ˜¯ä¼šæŠŠæ‰€æœ‰ç›®å½•å’Œæ–‡ä»¶éƒ½ä¸€èµ·è¾“å‡ºï¼Œé™¤éåŠ äº†type -fï¼Œæ­¤æ—¶å°±åªä¼šè¾“å‡ºæ–‡ä»¶ï¼Œtype -dï¼Œæ­¤æ—¶å°±åªä¼šè¾“å‡ºç›®å½• æŸ¥æ‰¾ txt å’Œ pdf æ–‡ä»¶ 1234find ./ \\( -name \"*.php\" -o -name \"*.p\" \\)find ./ \\( -name \"*.php\" -or -name \"*.p\" \\)// åŒæ—¶åŒ…å«å‘½åfind ./ \\( -name \"*.php\" -and -name \"*.p\" \\) æ­£åˆ™æ–¹å¼æŸ¥æ‰¾.txt å’Œ.pdf 1find ./ -regex \".*\\(php\\|p\\)\" iregexï¼šå¿½ç•¥å¤§å°å†™çš„æ­£åˆ™ å¦å®šå‚æ•°ï¼ŒæŸ¥æ‰¾æ‰€æœ‰é txt æ–‡ä»¶ 1find ./ -name \"*.txtx\" æŒ‡å®šæœç´¢æ·±åº¦,æ‰“å°å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶ï¼ˆæ·±åº¦ä¸º 1ï¼Œé»˜è®¤ä¸º 1ï¼‰: 1find ./ -maxdepth 1 -type f å®šåˆ¶æœç´¢ æŒ‰ç±»å‹æœç´¢ 1find . -type d -print //åªåˆ—å‡ºæ‰€æœ‰ç›®å½• -type f æ–‡ä»¶ / l ç¬¦å·é“¾æ¥ / d ç›®å½• find æ”¯æŒçš„æ–‡ä»¶æ£€ç´¢ç±»å‹å¯ä»¥åŒºåˆ†æ™®é€šæ–‡ä»¶å’Œç¬¦å·é“¾æ¥ã€ç›®å½•ç­‰ï¼Œä½†æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ–‡æœ¬æ–‡ä»¶æ— æ³•ç›´æ¥é€šè¿‡ find çš„ç±»å‹åŒºåˆ†å‡ºæ¥ï¼› æŒ‰å¤§å°æœç´¢ï¼šw å­— k M Gå¯»æ‰¾å¤§äº 2k çš„æ–‡ä»¶ 1find . -type f -size +2k æŒ‰æƒé™æŸ¥æ‰¾ 1find . -type f -perm 644 -print //æ‰¾å…·æœ‰å¯æ‰§è¡Œæƒé™çš„æ‰€æœ‰æ–‡ä»¶ æŒ‰ç”¨æˆ·æŸ¥æ‰¾ 1find . -type f -user weber -print// æ‰¾ç”¨æˆ·weberæ‰€æ‹¥æœ‰çš„æ–‡ä»¶ æ‰§è¡ŒåŠ¨ä½œï¼ˆå¼ºå¤§çš„ execï¼‰å°†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æƒå˜æ›´ä¸º weber:: 1find . -type f -user root -exec chown weber &#123;&#125; \\; æ³¨ï¼š{}æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å­—ç¬¦ä¸²ï¼Œå¯¹äºæ¯ä¸€ä¸ªåŒ¹é…çš„æ–‡ä»¶ï¼Œ{}ä¼šè¢«æ›¿æ¢æˆç›¸åº”çš„æ–‡ä»¶åï¼› å°†æ‰¾åˆ°çš„æ–‡ä»¶å…¨éƒ½ copy åˆ°å¦ä¸€ä¸ªç›®å½•:: 1find . -type f -mtime +10 -name \"*.txt\" -exec cp &#123;&#125; OLD \\; grep æ–‡æœ¬æœç´¢1grep match_patten file // é»˜è®¤è®¿é—®åŒ¹é…è¡Œ å¸¸ç”¨å‚æ•° -o åªè¾“å‡ºåŒ¹é…çš„æ–‡æœ¬è¡Œ VS -v åªè¾“å‡ºæ²¡æœ‰åŒ¹é…çš„æ–‡æœ¬è¡Œ -c ç»Ÿè®¡æ–‡ä»¶ä¸­åŒ…å«æ–‡æœ¬çš„æ¬¡æ•°grep -c â€œtextâ€ filename -n æ‰“å°åŒ¹é…çš„è¡Œå· -i æœç´¢æ—¶å¿½ç•¥å¤§å°å†™ -l åªæ‰“å°æ–‡ä»¶å -A æ‰“å°æœç´¢åˆ°ç›®æ ‡çš„å‰å‡ è¡Œ -B æ‰“å°æœç´¢åˆ°ç›®æ ‡çš„åå‡ è¡Œ -C æ‰“å°æœç´¢åˆ°ç›®æ ‡çš„å‰åå‡ è¡Œ åœ¨å¤šçº§ç›®å½•ä¸­å¯¹æ–‡æœ¬é€’å½’æœç´¢(ç¨‹åºå‘˜æœä»£ç çš„æœ€çˆ±ï¼‰ 12// åœ¨å¤šçº§ç›®å½•ä¸‹æœç´¢æ–‡æœ¬å†…å®¹åŒ…å«classçš„ï¼Œå¹¶ä¸”æ‰“å°è¡Œæ•°ï¼Œå¹¶ä¸”æ˜¾ç¤ºå‰å3è¡Œgrep \"class\" . -R -n -C 3 ç»¼åˆåº”ç”¨ï¼šå°†æ—¥å¿—ä¸­çš„æ‰€æœ‰å¸¦ where æ¡ä»¶çš„ sql æŸ¥æ‰¾æŸ¥æ‰¾å‡ºæ¥ 1cat *sql.log | tr [a-z] [A-Z] | grep \"FROM\" | grep \"WHERE\" &gt; temp.log xargs å‘½ä»¤è¡Œå‚æ•°è½¬æ¢å•è¡Œè¾“å‡º 1cat file.txt | xargs å•è¡Œä¹‹åå†ä»¥ n ä¸ªå…ƒç´ ä¸ºä¸€è¡Œ 1cat file.txt | -n 2 xargs å‚æ•°è¯´æ˜ -d å®šä¹‰å®šç•Œç¬¦ ï¼ˆé»˜è®¤ä¸ºç©ºæ ¼ å¤šè¡Œçš„å®šç•Œç¬¦ä¸º \\nï¼‰ -n æŒ‡å®šè¾“å‡ºä¸ºå¤šè¡Œ -I {} æŒ‡å®šæ›¿æ¢å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²åœ¨ xargs æ‰©å±•æ—¶ä¼šè¢«æ›¿æ¢æ‰,ç”¨äºå¾…æ‰§è¡Œçš„å‘½ä»¤éœ€è¦å¤šä¸ªå‚æ•°æ—¶ -0ï¼šæŒ‡å®š\\0 ä¸ºè¾“å…¥å®šç•Œç¬¦ sort æ’åº -n æŒ‰æ•°å­—è¿›è¡Œæ’åº VS -d æŒ‰å­—å…¸åºè¿›è¡Œæ’åº -r é€†åºæ’åº -k N æŒ‡å®šæŒ‰ç¬¬ N åˆ—æ’åº -R éšæœºæ’åˆ— -f å¿½ç•¥å¤§å°å†™ -b å¿½ç•¥å‰ç½®æ— ç”¨ 12345// å‡åºæ’åˆ—sort a.p// éšæœºæ’åˆ—sort -R a.p uniq é‡å¤è¡Œæ“ä½œ -d åªæ˜¾ç¤ºé‡å¤è¡Œ -u åªæ˜¾ç¤ºä¸é‡å¤çš„è¡Œ -c è¦†ç›–é‡å¤ï¼Œä½†æ˜¯æ˜¾ç¤ºæ¯è¡Œè®°å½•çš„é‡å¤æ•°ï¼Œé»˜è®¤ä¸ºï¼š1 -i å¿½ç•¥å¤§å°å†™ å¯æŒ‡å®šæ¯è¡Œä¸­éœ€è¦æ¯”è¾ƒçš„é‡å¤å†…å®¹ï¼š-s å¼€å§‹ä½ç½® -w æ¯”è¾ƒå­—ç¬¦æ•° 1sort unsort.txt | uniq tr sed ç®€åŒ–ç‰ˆæ³¨æ„[set1]å’Œ[set2]æ˜¯å•å­—ç¬¦ä¸€å¯¹ä¸€æ›¿æ¢ PSï¼šå…³é”®æ˜¯é»˜è®¤æ˜¯å•å­—ç¬¦æ“ä½œï¼Œé™¤éåŠ äº†-s -d åˆ é™¤æŸäº›å­—ç¬¦ -s åˆ é™¤æŸä¸ªå­—ç¬¦ä¸² -c è·å–æ–‡æœ¬ä¸­æŒ‡å®šçš„å­—ç¬¦ 123echo 12345 | tr '0-9' '9876543210' //åŠ è§£å¯†è½¬æ¢ï¼Œæ›¿æ¢å¯¹åº”å­—ç¬¦cat text| tr '\\t' ' ' //åˆ¶è¡¨ç¬¦è½¬ç©ºæ ¼ tr ä¸­å¯ç”¨å„ç§å­—ç¬¦ç±»ï¼š * alnumï¼šå­—æ¯å’Œæ•°å­— * alphaï¼šå­—æ¯ * digitï¼šæ•°å­— * spaceï¼šç©ºç™½å­—ç¬¦ * lowerï¼šå°å†™ * upperï¼šå¤§å†™ * cntrlï¼šæ§åˆ¶ï¼ˆéå¯æ‰“å°ï¼‰å­—ç¬¦ * printï¼šå¯æ‰“å°å­—ç¬¦ä½¿ç”¨æ–¹æ³•ï¼štr [:class:] [:class:] 12// å°å†™æ›¿æ¢æˆå¤§å†™tr '[:lower:]' '[:upper:]' sed æ–‡æœ¬æ›¿æ¢åˆ©å™¨æ ¼å¼ï¼š 1sed [options] &#39;[command]&lt;content&gt;[command2]&#39; file optionsï¼š -iï¼šæ›¿æ¢åŸæœ¬çš„å†…å®¹ commandï¼š sï¼šæ›¿æ¢æ–‡æœ¬: s/{text}/{replatce_text}/[command2] command2ï¼š gï¼šå…¨å±€åŒ¹é… Ngï¼šN = \\dï¼šä»ç¬¬ N åˆ—å¼€å§‹é€è¡ŒåŒ¹é… 12echo sksksksksksk | sed 's/sk/SK/2g'skSKSKSKSKSK dï¼šåˆ é™¤æ“ä½œ 1234567891011åˆ é™¤ç©ºç™½è¡Œï¼šsed '/^$/d' fileåˆ é™¤æ–‡ä»¶çš„ç¬¬2è¡Œï¼šsed '2d' fileåˆ é™¤æ–‡ä»¶çš„ç¬¬2è¡Œåˆ°æœ«å°¾æ‰€æœ‰è¡Œï¼šsed '2,$d' file","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"ã€Linuxå‘½ä»¤ã€‘- æ–‡ä»¶åŠç›®å½•ç®¡ç†","slug":"linux-shell-file-dir","date":"2018-02-27T08:04:00.000Z","updated":"2021-03-20T16:25:01.809Z","comments":true,"path":"2018/02/27/linux-shell-file-dir/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/27/linux-shell-file-dir/","excerpt":"åˆ›å»ºå’Œåˆ é™¤ åˆ›å»ºï¼šmkdir åˆ é™¤ï¼šrm åˆ é™¤ç›®å½•ï¼ˆé€’å½’+å¼ºåˆ¶ï¼‰ï¼šrm -rf dir åˆ é™¤æ–‡ä»¶ï¼ˆå¼ºåˆ¶ï¼‰ rm -f file åˆ é™¤ç»Ÿä¸€åç¼€ rm *log(ç­‰ä»·äºï¼šfind ./ -name &quot;*log&quot; -exec rm -f {}ï¼Œfind ./ -name &quot;*.log&quot; -exec rm -f {} \\;)(æ³¨æ„ï¼Œ\\;å¿…é¡»åŠ ï¼Œå¦åˆ™æŠ¥é”™) ç§»åŠ¨ï¼šmv file å¤åˆ¶ï¼ˆç›®å½•ï¼‰ï¼šcpï¼ˆ-rï¼‰ file[dir] æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸ªæ•° find ./ | wc -l å¤åˆ¶ç›®å½•ï¼š","text":"åˆ›å»ºå’Œåˆ é™¤ åˆ›å»ºï¼šmkdir åˆ é™¤ï¼šrm åˆ é™¤ç›®å½•ï¼ˆé€’å½’+å¼ºåˆ¶ï¼‰ï¼šrm -rf dir åˆ é™¤æ–‡ä»¶ï¼ˆå¼ºåˆ¶ï¼‰ rm -f file åˆ é™¤ç»Ÿä¸€åç¼€ rm *log(ç­‰ä»·äºï¼šfind ./ -name &quot;*log&quot; -exec rm -f {}ï¼Œfind ./ -name &quot;*.log&quot; -exec rm -f {} \\;)(æ³¨æ„ï¼Œ\\;å¿…é¡»åŠ ï¼Œå¦åˆ™æŠ¥é”™) ç§»åŠ¨ï¼šmv file å¤åˆ¶ï¼ˆç›®å½•ï¼‰ï¼šcpï¼ˆ-rï¼‰ file[dir] æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸ªæ•° find ./ | wc -l å¤åˆ¶ç›®å½•ï¼š cp -r source_dir dest_dir ç›®å½•åˆ‡æ¢ è·³è½¬ï¼šcd åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå·¥ä½œç›®å½•ï¼šcd - åˆ‡æ¢åˆ° home ç›®å½•ï¼šcd ~ æ˜¾ç¤ºå½“å‰ç›®å½•ï¼špwd åˆ—å‡ºç›®å½•é¡¹ ç°å®å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼šls æŒ‰æ—¶é—´æ’åºé™åºï¼Œä»¥åˆ—è¡¨çš„æ–¹å¼ç°å®ç›®å½•é¡¹ï¼šls -lrtï¼ˆlï¼šåˆ—è¡¨ï¼Œtï¼šæ—¶é—´å‡åºï¼Œrï¼šæ’åˆ—ååºï¼‰ æ˜¾ç¤ºéšè—ç›®å½•ã€åˆ—è¡¨æ˜¾ç¤ºæ–¹å¼ã€åˆ†é¡µæ˜¾ç¤ºï¼ˆé™åˆ¶ 12 è¡Œï¼‰ï¼šls -al | more -12 ç»™æ¯é¡¹æ–‡ä»¶å‰é¢å¢åŠ ä¸€ä¸ª id ç¼–å·ï¼šls -l | cat -n æŸ¥çœ‹æ–‡ä»¶å†…å®¹ æŸ¥çœ‹å‰é¢çš„å†…å®¹(n é»˜è®¤ 10)ï¼šhead [-n] &lt;file&gt; æŸ¥çœ‹åé¢çš„å†…å®¹(n é»˜è®¤ 10)ï¼štail [-n] &lt;file&gt; æŸ¥çœ‹ 2 ä¸ªæ–‡ä»¶çš„å·®åˆ«ï¼šdiff &lt;file1&gt; &lt;file2&gt; æ–‡ä»¶ä¸ç›®å½•æƒé™ä¿®æ”¹ æ”¹å˜æ–‡ä»¶çš„æ‹¥æœ‰è€…ï¼šchown æ”¹å˜æ–‡ä»¶è¯»ã€å†™ã€æ‰§è¡Œç­‰å±æ€§ï¼šchmod é€’å½’å­ç›®å½•ä¿®æ”¹ï¼šchown -R tuxapp source/ å¢åŠ è„šæœ¬å¯æ‰§è¡Œæƒé™ï¼š chmod a+x myscript ç»™æ–‡ä»¶å¢åŠ åˆ«åï¼ˆè½¯é“¾æ¥/ç¡¬é“¾æ¥ï¼‰12ln cc ccAgain :ç¡¬è¿æ¥ï¼›åˆ é™¤ä¸€ä¸ªï¼Œå°†ä»èƒ½æ‰¾åˆ°ï¼›ln -s cc ccTo :ç¬¦å·é“¾æ¥(è½¯é“¾æ¥)ï¼›åˆ é™¤æºï¼Œå¦ä¸€ä¸ªæ— æ³•ä½¿ç”¨ï¼›ï¼ˆåé¢ä¸€ä¸ªccTo ä¸ºæ–°å»ºçš„æ–‡ä»¶ï¼‰ é‡å®šå‘ é‡å®šå‘æ ‡å‡†è¾“å‡ºåˆ°æ–‡ä»¶ï¼šcat foo &gt; foo.txt é‡å®šå‘æ ‡å‡†é”™è¯¯åˆ°æ–‡ä»¶ï¼šcat foo 2&gt; foot.txt é‡å®šå‘æ ‡å‡†è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯ï¼šcat foo 1&gt;&amp;2 é‡å®šå‘æ ‡å‡†é”™è¯¯åˆ°æ ‡å‡†è¾“å‡ºï¼šcat foo 2&gt;&amp;1 é‡å®šå‘æ ‡å‡†è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯åˆ°åŒä¸€ä¸ªæ–‡ä»¶ï¼šcat foo 1&gt;&amp;2 foo.txt æˆ–è€…(ä¹Ÿä¸èƒ½è¯´æˆ–è€…ï¼Œåªæ˜¯æ•ˆæœä¸€æ ·) cat foo &amp;&gt; foo.txt æ¸…ç©ºæ–‡ä»¶ï¼š:&gt; foo.php è¿½åŠ å†…å®¹åˆ°æ–‡ä»¶ï¼šecho a &gt;&gt; foo.php è¦†ç›–å†…å®¹åˆ°æ–‡ä»¶ï¼šecho a &gt; foo.php ç»¼åˆåº”ç”¨æŸ¥æ‰¾ record.log ä¸­åŒ…å« AAAï¼Œä½†ä¸åŒ…å« BBB çš„è®°å½•çš„æ€»æ•°: 1234567# record.logAAABBBCCCAAACCCBBBCCCCCCAAABBB cat record.log | grep &quot;AAA&quot; | grep -v &quot;BBB&quot; | wc -l","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"}]},{"title":"ã€åŸºç¡€ç®—æ³•ã€‘- æ’åº - ç›´æ¥æ’å…¥æ’åº","slug":"ç®—æ³•/algorithm-base-insert","date":"2018-02-24T05:52:00.000Z","updated":"2021-03-20T16:25:01.820Z","comments":true,"path":"2018/02/24/ç®—æ³•/algorithm-base-insert/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/24/%E7%AE%97%E6%B3%95/algorithm-base-insert/","excerpt":"è¯´æ˜ç›´æ¥æ’å…¥æ’åºç®—æ³• ç¨³å®šæ’åº PHP å®ç°123456789101112131415161718192021222324class Insert&#123; public function __invoke(array $args) &#123; $length = count($args); for ($i = 1; $i &lt; $length; $i++) &#123; if ($args[$i] &lt; $args[$i - 1]) &#123; $k = $args[$i]; for ($j = $i - 1; $j &gt;= 0 &amp;&amp; $args[$j] &gt; $k; $j--) &#123; $args[$j + 1] = $args[$j]; &#125; $args[$j + 1] = $k; &#125; &#125; return $args; &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Insert();$sortData = $sort($data);print_r($sortData);","text":"è¯´æ˜ç›´æ¥æ’å…¥æ’åºç®—æ³• ç¨³å®šæ’åº PHP å®ç°123456789101112131415161718192021222324class Insert&#123; public function __invoke(array $args) &#123; $length = count($args); for ($i = 1; $i &lt; $length; $i++) &#123; if ($args[$i] &lt; $args[$i - 1]) &#123; $k = $args[$i]; for ($j = $i - 1; $j &gt;= 0 &amp;&amp; $args[$j] &gt; $k; $j--) &#123; $args[$j + 1] = $args[$j]; &#125; $args[$j + 1] = $k; &#125; &#125; return $args; &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Insert();$sortData = $sort($data);print_r($sortData); ç›´æ¥æ’å…¥æ’åºï¼šé¡¾åæ€ä¹‰ï¼Œç›´æ¥æ’å…¥æ’åºï¼Œæ˜¯ä»å‰å¾€åæ’å‡ºä¸€ä¸ªæœ‰åºåŒºé—´ï¼Œæœ€é è¿‘åŒºé—´çš„ä¸€ä¸ªæ•°åœ¨æœ‰åºåŒºé—´ä¸­ä»åå¾€å‰ä¸æ–­æ¯”è¾ƒï¼Œå¦‚æœå¾…æ’å…¥çš„æ•°å°äºå½“å‰çš„æ•°ï¼Œä¸æ–­å‘åç§»åŠ¨ä¸€ä¸ªå…ƒç´ ã€‚ç›´åˆ°å¾…æ’å…¥çš„æ•°å¤§äºå½“å‰æœ‰åºåŒºé—´ä¸­çš„æ•° æˆ‘ä»¬ç°åœ¨æœ‰ä¸€æ‰¹æ•°å­—ï¼š[3, 5, 1, 2, 8, 6, 7, 9] æœ‰åºåŒºé—´ä¸ºï¼š [|3| , 5 , 1 , 2 , 8 , 6 , 7 , 9] ç„¶åæ‹¿åˆ° 5 å»å’Œ|3|é‡Œé¢çš„æ•°æ¯”è¾ƒï¼Œå‘ç° 5&gt;3 æ‰€ä»¥æ— éœ€åŠ¨ã€‚ [|3 ,5| , 1 , 2 , 8, 6 , 7 , 9] ç„¶åæ‹¿åˆ° 1 å»å’Œ|3,5|æ¯”è¾ƒï¼Œå‘ç° 5&gt;1ï¼Œç„¶å 5 å‘åç§»åŠ¨ä¸€ä½ï¼Œç„¶åå‘ç° 3&gt;1ï¼Œç„¶å 3 å‘åç§»åŠ¨ä¸€ä½ï¼Œç„¶ååˆ°äº†å°½å¤´äº†ï¼Œæ‰€ä»¥æœ‰åºåŒºé—´å›ºå®šäº†ã€‚ [|1 , 3 , 5| , 2 , 8, 6 , 7 , 9] åŒç†â€¦ï¼ˆæ—¶é—´æœ‰é™ï¼Œä¸å†™äº†ï¼Œé€ƒï¼ï¼‰ ç„¶åæ•´ä¸ªæµç¨‹ä¸‹æ¥ï¼Œå°±å®Œæˆäº†æ’åºäº†ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ‰ä¸€ä¸ªç¨³å®šçš„æœ‰åºåŒºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠæ•´ä¸ªç®—æ³•å«åšç¨³å®šç®—æ³•ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ã€åŸºç¡€ç®—æ³•ã€‘- æ’åº - å¿«æ’","slug":"ç®—æ³•/algorithm-base-quick","date":"2018-02-24T05:46:00.000Z","updated":"2021-03-20T16:25:01.821Z","comments":true,"path":"2018/02/24/ç®—æ³•/algorithm-base-quick/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/24/%E7%AE%97%E6%B3%95/algorithm-base-quick/","excerpt":"è¯´æ˜å¿«æ’ç®—æ³•ï¼Œæ¯”æ™®é€šçš„å†’æ³¡æ’åºè¦å¿«ï¼ŒåŸå› è¯´æ˜å°†åœ¨æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦çš„æ–‡ç« ä¸­è¯´æ˜ã€‚ PHP å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869&lt;?php/** * Created by PhpStorm. * User: admin * Date: 2018/2/24 * Time: 9:39 */class Quick&#123; public function __invoke(array $args) &#123; $length = count($args); if ($length &lt; 1) &#123; return; &#125; $this-&gt;quickSort($args, 0, $length - 1); return $args; &#125; public function quickSort(array &amp;$args, int $low, int $high) &#123; if ($low &gt; $high) &#123; return; &#125; $frist = $low; $last = $high; $k = $args[$low];// $i = 0; while ($frist &lt; $last) &#123;// $i++; while ($frist &lt; $last &amp;&amp; $args[$last] &gt;= $k) &#123; $last--; &#125; $args[$frist] = $args[$last];// echo '[' . $i . ']last -- : $frist ' . $frist . ' . $last ' . $last . PHP_EOL;// foreach ($args as $value)&#123;// echo $value . ' ';// &#125; echo PHP_EOL; while ($frist &lt; $last &amp;&amp; $args[$frist] &lt;= $k) &#123; $frist++; &#125; $args[$last] = $args[$frist];// echo '[' . $i . ']last -- : $frist ' . $frist . ' . $last ' . $last . PHP_EOL;// foreach ($args as $value)&#123;// echo $value . ' ';// &#125;// echo PHP_EOL; &#125; $args[$frist] = $k;// print_r($args);// exit; $this-&gt;quickSort($args, $low, $frist - 1); $this-&gt;quickSort($args, $frist + 1, $high); &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Quick();$sortData = $sort($data);print_r($sortData);","text":"è¯´æ˜å¿«æ’ç®—æ³•ï¼Œæ¯”æ™®é€šçš„å†’æ³¡æ’åºè¦å¿«ï¼ŒåŸå› è¯´æ˜å°†åœ¨æ—¶é—´å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦çš„æ–‡ç« ä¸­è¯´æ˜ã€‚ PHP å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869&lt;?php/** * Created by PhpStorm. * User: admin * Date: 2018/2/24 * Time: 9:39 */class Quick&#123; public function __invoke(array $args) &#123; $length = count($args); if ($length &lt; 1) &#123; return; &#125; $this-&gt;quickSort($args, 0, $length - 1); return $args; &#125; public function quickSort(array &amp;$args, int $low, int $high) &#123; if ($low &gt; $high) &#123; return; &#125; $frist = $low; $last = $high; $k = $args[$low];// $i = 0; while ($frist &lt; $last) &#123;// $i++; while ($frist &lt; $last &amp;&amp; $args[$last] &gt;= $k) &#123; $last--; &#125; $args[$frist] = $args[$last];// echo '[' . $i . ']last -- : $frist ' . $frist . ' . $last ' . $last . PHP_EOL;// foreach ($args as $value)&#123;// echo $value . ' ';// &#125; echo PHP_EOL; while ($frist &lt; $last &amp;&amp; $args[$frist] &lt;= $k) &#123; $frist++; &#125; $args[$last] = $args[$frist];// echo '[' . $i . ']last -- : $frist ' . $frist . ' . $last ' . $last . PHP_EOL;// foreach ($args as $value)&#123;// echo $value . ' ';// &#125;// echo PHP_EOL; &#125; $args[$frist] = $k;// print_r($args);// exit; $this-&gt;quickSort($args, $low, $frist - 1); $this-&gt;quickSort($args, $frist + 1, $high); &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Quick();$sortData = $sort($data);print_r($sortData); å¿«é€Ÿæ’åºï¼šé¡¾åæ€ä¹‰ï¼Œå¿«é€Ÿæ’åºçš„åŸºæœ¬æ€è·¯æ˜¯åˆ†æ²»çš„æ€è·¯ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œå› ä¸ºä»–æ˜¯ä¸€ä¸ªæ•´ä½“æ’åºçš„è¿‡ç¨‹ï¼Œä½†æ˜¯ä»–æŠŠæ•°æ®åˆ†æˆäº†å­æ•°æ®æ®µçš„æ’åº ç›¸ä¿¡å¾ˆå¤šäººçœ‹åˆ°è¿™é‡Œè¿˜æ˜¯ä¸€å¤´é›¾æ°´ï¼Œæˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªè¯´æ³•ï¼Œçœ‹çœ‹ä¸Šé¢çš„ä¾‹å­ã€‚ æˆ‘ä»¬ç°åœ¨æœ‰ä¸€æ‰¹æ•°å­—ï¼š[3, 5, 1, 2, 8, 6, 7, 9] æˆ‘ä»¬æ‹¿åˆ°åŸºæœ¬æ•°æ®å…ƒç´ :3ã€‚ä»åå¼€å§‹å¾€å‰çœ‹ï¼Œç›´åˆ°æ‰¾åˆ°æ¯” 3 å°çš„æ•°æ®ï¼Œæˆ‘ä» 9-7-6-8-2(ä¸‹æ ‡ç´¢å¼• j:7-6-5-4-3ã€‚j=3)çœ‹åˆ° 2 æ¯” 3 å°ï¼Œè¿™ä¸ªæ—¶å€™ 3ã€2 äº¤æ¢ä½ç½®ã€‚ [2,5,1,3,8,6,7,9] ç„¶åä»å‰å¼€å§‹å¾€åçœ‹ï¼Œç›´åˆ°æ‰¾åˆ°æ¯” 3 å¤§çš„æ•°æ®æˆ‘ä» 2-5ï¼ˆä¸‹æ ‡ç´¢å¼• iï¼š0ï¼Œ1ã€‚i=1ï¼‰çœ‹åˆ° 5 æ¯” 3 å¤§ï¼Œè¿™ä¸ªæ—¶å€™ 5ã€3 äº¤æ¢ä½ç½®ã€‚ [2,3,1,5,8,6,7,9] è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å‘ç° j ä¸ç­‰äº iï¼Œæ‰€ä»¥éœ€è¦è®¡ç®—è®¡ç®—ï¼Œç›´åˆ° i=j ä½ç½®ã€‚ è¿™ä¸ªæ—¶å€™ï¼ˆj=3ï¼Œi=1ï¼‰ã€‚æˆ‘ä»¬æŒ‰ç…§ä»åå¼€å§‹å¾€å‰æ‰¾çš„è§„å¾‹ã€‚ä» 5-1ï¼ˆä¸‹æ ‡ç´¢å¼• jï¼š3-2ã€‚j=2ï¼‰çœ‹åˆ° 1 æ¯” 3 å°ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œ1ï¼Œ3 äº¤æ¢ä½ç½®ã€‚ [2,1,3,5,8,6,7,9] è¿™ä¸ªæ—¶å€™ï¼ˆj=2ï¼Œi=1ï¼‰ã€‚æˆ‘ä»¬æŒ‰ç…§ä»å‰å¼€å§‹å¾€åæ‰¾çš„è§„å¾‹ã€‚å½“è¯» 1 çš„æ—¶å€™ï¼ˆi=j=2ï¼‰ï¼Œå·²ç»ç¬¦åˆäº†æˆ‘ä»¬çš„ j=iï¼Œè¿™ä¸ªæ—¶å€™ï¼Œè¯´æ˜å·²ç»å®Œæˆäº†ä¸€è½®å¾ªç¯ã€‚ ä»¥ä¸Šè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºä¸€è½®å¾ªç¯ï¼ˆä»åé¢å¼€å§‹æ‰¾å°çš„ï¼Œä»å‰é¢å¼€å§‹æ‰¾å¤§çš„ï¼‰,è¿™ä¸ªæ—¶å€™,ä¼šå‘ç°ï¼ŒåŸºç¡€æ•°æ® 3 å·¦è¾¹éƒ½æ˜¯å°äº 3 çš„ï¼Œå³è¾¹éƒ½æ˜¯å¤§äº 3 çš„ã€‚ä»¥æ­¤å¾ªç¯ï¼Œå°±æ˜¯å¿«æ’çš„åŸºæœ¬æ€è·¯ã€‚ å¦‚æœæƒ³çœ‹æ•°æ®å˜åŠ¨çš„è¿‡ç¨‹ï¼Œå¯ä»¥æŠŠæ³¨é‡Šåˆ æ‰ï¼Œå°±å¯ä»¥çœ‹åˆ°æ¯ä¸€æ¬¡æ•°æ®å˜åŠ¨çš„æƒ…å†µäº†ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ã€åŸºç¡€ç®—æ³•ã€‘- æ’åº - å†’æ³¡","slug":"ç®—æ³•/algorithm-base-bubble","date":"2018-02-24T04:13:00.000Z","updated":"2021-03-20T16:25:01.820Z","comments":true,"path":"2018/02/24/ç®—æ³•/algorithm-base-bubble/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/24/%E7%AE%97%E6%B3%95/algorithm-base-bubble/","excerpt":"è¯´æ˜æ„Ÿè§‰ä¸€äº›åŸºç¡€çš„æ’åºç®—æ³•ï¼Œè²Œä¼¼æˆ‘çš„åšå®¢å¹¶æ²¡æœ‰è¯´æ˜ï¼Œè™½ç„¶æˆ‘ä¹Ÿå¾ˆå¤šäº†ï¼Œä½†æ˜¯è¿˜ä¼šè®°å½•ä¸€ä¸‹ï¼Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œå¹¶ä¸”ç»ˆç»“ä¸€ä¸‹æˆ‘æ¯æ¬¡çš„å†™æ’åºç®—æ³•çš„å¿ƒå¾—ã€‚ å…ˆè´´ä»£ç ï¼Œå†è®²åŸç†ã€‚ PHP å®ç°123456789101112131415161718192021222324class Bubble&#123; public function __invoke(array $args) &#123; $length = count($args); for ($i = 0; $i &lt; $length - 1; $i++) &#123; for ($j = 0; $j &lt; $length - 1 - $i; $j++) &#123; if ($args[$j] &gt; $args[$j + 1]) &#123; $tmp = $args[$j]; $args[$j] = $args[$j + 1]; $args[$j + 1] = $tmp; &#125; &#125; &#125; return $args; &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Bubble();$sortData = $sort($data);print_r($sortData);","text":"è¯´æ˜æ„Ÿè§‰ä¸€äº›åŸºç¡€çš„æ’åºç®—æ³•ï¼Œè²Œä¼¼æˆ‘çš„åšå®¢å¹¶æ²¡æœ‰è¯´æ˜ï¼Œè™½ç„¶æˆ‘ä¹Ÿå¾ˆå¤šäº†ï¼Œä½†æ˜¯è¿˜ä¼šè®°å½•ä¸€ä¸‹ï¼Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œå¹¶ä¸”ç»ˆç»“ä¸€ä¸‹æˆ‘æ¯æ¬¡çš„å†™æ’åºç®—æ³•çš„å¿ƒå¾—ã€‚ å…ˆè´´ä»£ç ï¼Œå†è®²åŸç†ã€‚ PHP å®ç°123456789101112131415161718192021222324class Bubble&#123; public function __invoke(array $args) &#123; $length = count($args); for ($i = 0; $i &lt; $length - 1; $i++) &#123; for ($j = 0; $j &lt; $length - 1 - $i; $j++) &#123; if ($args[$j] &gt; $args[$j + 1]) &#123; $tmp = $args[$j]; $args[$j] = $args[$j + 1]; $args[$j + 1] = $tmp; &#125; &#125; &#125; return $args; &#125;&#125;$data = [3, 5, 1, 2, 8, 6, 7, 9];$sort = new Bubble();$sortData = $sort($data);print_r($sortData); å†’æ³¡æ’åºï¼šé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ„æ€å°±æ˜¯åƒæ³¡æ³¡ä¸€æ ·ä¸€å±‚å±‚çš„å‘ä¸Šæµ®ï¼ˆé’ˆå¯¹å‡åºï¼šä»å°åˆ°å¤§æ’åºï¼Œé¦–å…ˆç¡®å®šçš„æ˜¯æœ€å¤§å€¼ï¼‰ï¼ŒåŸºæœ¬æ€è·¯å°±æ˜¯ä¸¤ä¸¤æ¯”è¾ƒï¼Œåªè®°å¾—ä¸¤è€…ä¹‹é—´å¤§çš„å€¼ï¼Œç›´åˆ°æœ€åä¸€æ¬¡æ¯”è¾ƒï¼Œå³å¯ç¡®å®šè¯¥å€¼ä¸ºæœ€å¤§å€¼ï¼Œè¿™æ ·å­å°±å®Œæˆäº†ä¸€æ¬¡å¾ªç¯æ¯”è¾ƒï¼Œå‰©ä¸‹çš„æ•°å­—ä¹ŸåŒæ ·çš„æ€è·¯å¾ªç¯ä¸‹å»å³å¯ã€‚ æŒ‰ç…§è¿™ä¸ªè¯´æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸Šé¢çš„ä¾‹å­ã€‚ æˆ‘ä»¬ç°åœ¨æœ‰ä¸€æ‰¹æ•°å­—ï¼š[3, 5, 1, 2, 8, 6, 7, 9] ç¬¬ä¸€æ¬¡æ¯”è¾ƒ:3,5ã€‚å‘ç° 5 æ¯” 3 å¤§ï¼Œæ— éœ€äº¤æ¢ä½ç½®ã€‚ 3ï¼Œ5ï¼Œ1ï¼Œ2ï¼Œ8ï¼Œ6ï¼Œ7ï¼Œ9 ç¬¬äºŒæ¬¡æ¯”è¾ƒï¼š5ï¼Œ1ã€‚å‘ç° 1 æ¯” 5 å°ï¼Œäº¤æ¢ä½ç½®ã€‚ 3ï¼Œ1ï¼Œ5ï¼Œ2ï¼Œ8ï¼Œ6ï¼Œ7ï¼Œ9 ç¬¬ä¸‰æ¬¡æ¯”è¾ƒï¼š5ï¼Œ2ã€‚å‘ç° 2 æ¯” 5 å°ï¼Œäº¤æ¢ä½ç½®ã€‚ 3ï¼Œ1ï¼Œ2ï¼Œ5ï¼Œ8ï¼Œ6ï¼Œ7ï¼Œ9 ç¬¬å››æ¬¡æ¯”è¾ƒï¼š5ï¼Œ8ã€‚å‘ç° 8 æ¯” 5 å¤§ï¼Œæ— éœ€äº¤æ¢ä½ç½®ã€‚ 3ï¼Œ1ï¼Œ2ï¼Œ5ï¼Œ8ï¼Œ6ï¼Œ7ï¼Œ9 ç¬¬äº”æ¬¡æ¯”è¾ƒï¼š8ï¼Œ6ã€‚å‘ç° 6 æ¯” 8 å°ï¼Œäº¤æ¢ä½ç½®ã€‚ 3ï¼Œ1ï¼Œ2ï¼Œ5ï¼Œ6ï¼Œ8ï¼Œ7ï¼Œ9 ç¬¬å…­æ¬¡æ¯”è¾ƒï¼š8ï¼Œ7ã€‚å‘ç° 7 æ¯” 8 å°ï¼Œäº¤æ¢ä½ç½®ã€‚ 3ï¼Œ1ï¼Œ2ï¼Œ5ï¼Œ6ï¼Œ7ï¼Œ8ï¼Œ9 ç¬¬ 7 æ¬¡æ¯”è¾ƒï¼š8ï¼Œ9ã€‚å‘ç° 9 æ¯” 8 å¤§ï¼Œæ— éœ€äº¤æ¢ä½ç½®ã€‚ å®Œæˆäº†ç¬¬ä¸€è½®æ¯”è¾ƒï¼Œä»è€Œå¾—å‡ºäº†9æ˜¯è¿™æ‰¹æ•°æ®ä¸­çš„æœ€å¤§å€¼ã€‚ ç¬¬äºŒè½®ï¼ˆä¸ç”¨æ¯”è¾ƒ 9ï¼Œå·²ç»ç¡®å®šæœ€å¤§å€¼ï¼‰ï¼Œç¬¬ä¸‰è½®ï¼ˆä¸ç”¨æ¯”è¾ƒ 8ï¼Œ9 å·²ç»ç¡®è®¤æœ€å¤§å€¼å’Œç¬¬äºŒå¤§çš„å€¼ï¼‰â€¦ç›´åˆ°ç¬¬ 7 è½®ï¼ˆå°‘äº†ä¸€è½®æ˜¯å› ä¸ºï¼Œä¸ç”¨æ¯”è¾ƒæœ€å°å€¼ï¼Œå› ä¸ºå·²ç»æ¯”è¾ƒå¾—å‡ºäº†æœ€å¤§çš„ 7 ä½ï¼Œï¼‰ã€‚å¾—å‡ºäº†ï¼š 1ï¼Œ2ï¼Œ3ï¼Œ5ï¼Œ6ï¼Œ7ï¼Œ8ï¼Œ9 çš„å‡åºæ•°æ®ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ã€Mongodbã€‘- çŸ¥è¯†æ•´ç†","slug":"mogodb-info","date":"2018-02-23T09:07:00.000Z","updated":"2021-03-20T16:25:01.810Z","comments":true,"path":"2018/02/23/mogodb-info/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/23/mogodb-info/","excerpt":"è¯´æ˜Mongodb ä½œä¸º nosql æ•°æ®åº“çš„ä»£è¡¨ï¼Œå’Œä¼ ç»Ÿçš„ mysql çš„å…³ç³»å‹æ•°æ®åº“ä¸åŒï¼Œä»–çš„æ•°æ®ç»“æ„åªæœ‰ä¸€ç§ï¼Œé‚£å°±æ˜¯ BSONï¼Œæ²¡æœ‰å›ºå®šçš„ schemaï¼Œæ‰€ä»¥ä»–æ˜¯ no schema çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMongodb åªæ”¯æŒå•æ–‡æ¡£äº‹åŠ¡ï¼Œæ‰€ä»¥ç”¨åˆ°çš„ä¸šåŠ¡ä¸­ä¸åº”è¯¥æœ‰äº‹åŠ¡æ€§å¼ºçš„æ•°æ®æºã€‚ è¿™ä¹ˆè¯´æ¯”è¾ƒç›´ç™½ã€‚å…·ä½“ä¸¾ä¾‹å‡ ä¸ªåº”ç”¨åœºæ™¯ï¼š æ¸¸æˆåœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨æ¸¸æˆç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·çš„è£…å¤‡ã€ç§¯åˆ†ç­‰ç›´æ¥ä»¥å†…åµŒæ–‡æ¡£çš„å½¢å¼å­˜å‚¨ï¼Œæ–¹ä¾¿æŸ¥è¯¢ã€æ›´æ–° ç‰©æµåœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨è®¢å•ä¿¡æ¯ï¼Œè®¢å•çŠ¶æ€åœ¨è¿é€è¿‡ç¨‹ä¸­ä¼šä¸æ–­æ›´æ–°ï¼Œä»¥ MongoDB å†…åµŒæ•°ç»„çš„å½¢å¼æ¥å­˜å‚¨ï¼Œä¸€æ¬¡æŸ¥è¯¢å°±èƒ½å°†è®¢å•æ‰€æœ‰çš„å˜æ›´è¯»å–å‡ºæ¥ã€‚ ç¤¾äº¤åœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥åŠç”¨æˆ·å‘è¡¨çš„æœ‹å‹åœˆä¿¡æ¯ï¼Œé€šè¿‡åœ°ç†ä½ç½®ç´¢å¼•å®ç°é™„è¿‘çš„äººã€åœ°ç‚¹ç­‰åŠŸèƒ½ ç­‰ç­‰","text":"è¯´æ˜Mongodb ä½œä¸º nosql æ•°æ®åº“çš„ä»£è¡¨ï¼Œå’Œä¼ ç»Ÿçš„ mysql çš„å…³ç³»å‹æ•°æ®åº“ä¸åŒï¼Œä»–çš„æ•°æ®ç»“æ„åªæœ‰ä¸€ç§ï¼Œé‚£å°±æ˜¯ BSONï¼Œæ²¡æœ‰å›ºå®šçš„ schemaï¼Œæ‰€ä»¥ä»–æ˜¯ no schema çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMongodb åªæ”¯æŒå•æ–‡æ¡£äº‹åŠ¡ï¼Œæ‰€ä»¥ç”¨åˆ°çš„ä¸šåŠ¡ä¸­ä¸åº”è¯¥æœ‰äº‹åŠ¡æ€§å¼ºçš„æ•°æ®æºã€‚ è¿™ä¹ˆè¯´æ¯”è¾ƒç›´ç™½ã€‚å…·ä½“ä¸¾ä¾‹å‡ ä¸ªåº”ç”¨åœºæ™¯ï¼š æ¸¸æˆåœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨æ¸¸æˆç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·çš„è£…å¤‡ã€ç§¯åˆ†ç­‰ç›´æ¥ä»¥å†…åµŒæ–‡æ¡£çš„å½¢å¼å­˜å‚¨ï¼Œæ–¹ä¾¿æŸ¥è¯¢ã€æ›´æ–° ç‰©æµåœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨è®¢å•ä¿¡æ¯ï¼Œè®¢å•çŠ¶æ€åœ¨è¿é€è¿‡ç¨‹ä¸­ä¼šä¸æ–­æ›´æ–°ï¼Œä»¥ MongoDB å†…åµŒæ•°ç»„çš„å½¢å¼æ¥å­˜å‚¨ï¼Œä¸€æ¬¡æŸ¥è¯¢å°±èƒ½å°†è®¢å•æ‰€æœ‰çš„å˜æ›´è¯»å–å‡ºæ¥ã€‚ ç¤¾äº¤åœºæ™¯ï¼Œä½¿ç”¨ MongoDB å­˜å‚¨å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥åŠç”¨æˆ·å‘è¡¨çš„æœ‹å‹åœˆä¿¡æ¯ï¼Œé€šè¿‡åœ°ç†ä½ç½®ç´¢å¼•å®ç°é™„è¿‘çš„äººã€åœ°ç‚¹ç­‰åŠŸèƒ½ ç­‰ç­‰ Mongodb çš„ä¼˜åŠ¿ æ›´é«˜çš„å†™è´Ÿè½½é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹æ¯”äº‹åŠ¡å®‰å…¨ï¼ŒMongoDB æ›´å…³æ³¨é«˜çš„æ’å…¥é€Ÿåº¦ã€‚å¦‚æœä½ éœ€è¦åŠ è½½å¤§é‡ä½ä»·å€¼çš„ä¸šåŠ¡æ•°æ®ï¼Œæ¯”å¦‚æ—¥å¿—æ”¶é›†ï¼Œé‚£ä¹ˆ MongoDB å°†å¾ˆé€‚åˆä½ çš„ç”¨ä¾‹ï¼Œä½†æ˜¯å¿…é¡»é¿å…åœ¨è¦æ±‚é«˜äº‹åŠ¡å®‰å…¨çš„æƒ…æ™¯ä¸‹ä½¿ç”¨ MongoDBï¼Œæ¯”å¦‚ä¸€ä¸ª 1000 ä¸‡ç¾å…ƒçš„äº¤æ˜“ã€‚ å¤„ç†å¾ˆå¤§çš„è§„æ¨¡çš„å•è¡¨ï¼šæ•°æ®åº“æ‰©å±•æ˜¯éå¸¸æœ‰æŒ‘æˆ˜æ€§çš„ï¼Œå½“å•è¡¨æ ¼å¤§å°è¾¾åˆ° 5-10GB æ—¶ï¼ŒMySQL è¡¨æ ¼æ€§èƒ½ä¼šæ¯«æ— ç–‘é—®çš„é™ä½ã€‚å¦‚æœä½ éœ€è¦åˆ†ç‰‡å¹¶ä¸”åˆ†å‰²ä½ çš„æ•°æ®åº“ï¼ŒMongoDB å°†å¾ˆå®¹æ˜“å®ç°è¿™ä¸€ç‚¹ã€‚ ä¸å¯é ç¯å¢ƒä¿è¯é«˜å¯ç”¨æ€§è®¾ç½®å‰¯æœ¬é›†ï¼ˆä¸»-ä»æœåŠ¡å™¨è®¾ç½®ï¼‰ä¸ä»…æ–¹ä¾¿è€Œä¸”å¾ˆå¿«ï¼Œæ­¤å¤–ï¼Œä½¿ç”¨ MongoDB è¿˜å¯ä»¥å¿«é€Ÿã€å®‰å…¨åŠè‡ªåŠ¨åŒ–çš„å®ç°èŠ‚ç‚¹ï¼ˆæˆ–æ•°æ®ä¸­å¿ƒï¼‰æ•…éšœè½¬ç§»ã€‚ ä½¿ç”¨åŸºäºä½ç½®çš„æ•°æ®æŸ¥è¯¢ï¼ŒæŸ¥çš„æ›´å¿«MongoDB æ”¯æŒäºŒç»´ç©ºé—´ç´¢å¼•ï¼Œæ¯”å¦‚ç®¡é“ï¼Œå› æ­¤å¯ä»¥å¿«é€ŸåŠç²¾ç¡®çš„ä»æŒ‡å®šä½ç½®è·å–æ•°æ®ã€‚MongoDB åœ¨å¯åŠ¨åä¼šå°†æ•°æ®åº“ä¸­çš„æ•°æ®ä»¥æ–‡ä»¶æ˜ å°„çš„æ–¹å¼åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å¦‚æœå†…å­˜èµ„æºç›¸å½“ä¸°å¯Œçš„è¯ï¼Œè¿™å°†æå¤§åœ°æé«˜æ•°æ®åº“çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œæ¯•ç«Ÿå†…å­˜çš„ I/O æ•ˆç‡æ¯”ç£ç›˜é«˜å¤šäº† éç»“æ„åŒ–æ•°æ®çš„çˆ†å‘å¢é•¿å¢åŠ åˆ—åœ¨æœ‰äº›æƒ…å†µä¸‹å¯èƒ½é”å®šæ•´ä¸ªæ•°æ®è¡¨ï¼Œæˆ–è€…å¢åŠ è´Ÿè½½ä»è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œè¿™ä¸ªé—®é¢˜é€šå¸¸å‘ç”Ÿåœ¨è¡¨æ ¼å¤§äº 1GB çš„æƒ…å†µä¸‹ã€‚é‰´äº MongoDB çš„å¼±æ•°æ®ç»“æ„æ¨¡å¼ï¼Œæ·»åŠ  1 ä¸ªæ–°å­—æ®µä¸ä¼šå¯¹æ—§è¡¨æ ¼æœ‰ä»»ä½•å½±å“ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šéå¸¸å¿«é€Ÿï¼›å› æ­¤ï¼Œåœ¨åº”ç”¨ç¨‹åºå‘ç”Ÿæ”¹å˜æ—¶ï¼Œä½ ä¸éœ€è¦ä¸“é—¨çš„ 1 ä¸ª DBA å»ä¿®æ”¹æ•°æ®åº“æ¨¡å¼ã€‚ æ€»ç»“ åŠ¨æ€æŸ¥è¯¢ å…¨ç´¢å¼•æ”¯æŒ,æ‰©å±•åˆ°å†…éƒ¨å¯¹è±¡å’Œå†…åµŒæ•°ç»„ æŸ¥è¯¢è®°å½•åˆ†æ å¿«é€Ÿ,å°±åœ°æ›´æ–° é«˜æ•ˆå­˜å‚¨äºŒè¿›åˆ¶å¤§å¯¹è±¡ (æ¯”å¦‚ç…§ç‰‡å’Œè§†é¢‘) å¤åˆ¶å’Œæ•…éšœåˆ‡æ¢æ”¯æŒ Auto- Sharding è‡ªåŠ¨åˆ†ç‰‡æ”¯æŒäº‘çº§æ‰©å±•æ€§ MapReduce æ”¯æŒå¤æ‚èšåˆ å•†ä¸šæ”¯æŒ,åŸ¹è®­å’Œå’¨è¯¢ ç¼ºç‚¹ï¼š ä¸æ”¯æŒå¤æ‚çš„çœŸæ­£çš„äº‹åŠ¡ ä¸æ”¯æŒå¤šè¡¨è”æŸ¥ MongoDB å ç”¨ç©ºé—´è¿‡å¤§","categories":[{"name":"MongoDb","slug":"MongoDb","permalink":"http://blog.crazylaw.cn/categories/MongoDb/"}],"tags":[{"name":"MongoDb","slug":"MongoDb","permalink":"http://blog.crazylaw.cn/tags/MongoDb/"}]},{"title":"ã€Redisã€‘- é…ç½®ç®¡ç†","slug":"redis-config","date":"2018-02-23T07:28:00.000Z","updated":"2021-03-20T16:25:01.813Z","comments":true,"path":"2018/02/23/redis-config/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/23/redis-config/","excerpt":"è¯´æ˜redis çš„å¸¸ç”¨çŸ¥è¯†å°±ä¸è¯¦ç»†è¯´äº†ã€‚è®°å½•ä¸€ä¸‹æˆ‘è®¤ä¸ºå€¼å¾—è®°å½•çš„çŸ¥è¯†ç‚¹ åŸºæœ¬å¸¸ç”¨çš„é…ç½®å‚æ•°ã€å‘½ä»¤ daemonize noé…ç½® redis æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œé»˜è®¤ nopidfile /var/run/redis.pid Redis ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œæ—¶ï¼Œpid çš„å†™å…¥æ–‡ä»¶ã€‚é»˜è®¤ä¸º/var/run/redis.pid port 6379ç›‘å¬ç«¯å£,é»˜è®¤ä¸º 6379 bind 127.0.0.1ç»‘å®šçš„ä¸»æœºåœ°å€ timeout 300å®¢æˆ·ç«¯é™åˆ¶å¤šé•¿æ—¶é—´åå…³é—­è¿æ¥ loglevel verboseæ—¥å¿—çº§åˆ«ï¼Œæ”¯æŒ debug/verbos/notice/warningï¼Œé»˜è®¤ä¸º verbose","text":"è¯´æ˜redis çš„å¸¸ç”¨çŸ¥è¯†å°±ä¸è¯¦ç»†è¯´äº†ã€‚è®°å½•ä¸€ä¸‹æˆ‘è®¤ä¸ºå€¼å¾—è®°å½•çš„çŸ¥è¯†ç‚¹ åŸºæœ¬å¸¸ç”¨çš„é…ç½®å‚æ•°ã€å‘½ä»¤ daemonize noé…ç½® redis æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œé»˜è®¤ nopidfile /var/run/redis.pid Redis ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œæ—¶ï¼Œpid çš„å†™å…¥æ–‡ä»¶ã€‚é»˜è®¤ä¸º/var/run/redis.pid port 6379ç›‘å¬ç«¯å£,é»˜è®¤ä¸º 6379 bind 127.0.0.1ç»‘å®šçš„ä¸»æœºåœ°å€ timeout 300å®¢æˆ·ç«¯é™åˆ¶å¤šé•¿æ—¶é—´åå…³é—­è¿æ¥ loglevel verboseæ—¥å¿—çº§åˆ«ï¼Œæ”¯æŒ debug/verbos/notice/warningï¼Œé»˜è®¤ä¸º verbose databases 16æ•°æ®åº“çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 0.å¯ä»¥ä½¿ç”¨ SELECT &lt;dbid&gt;å‘½ä»¤åœ¨è¿æ¥ä¸ŠæŒ‡å®šæ•°æ®åº“ id saveæŒ‡å®šåœ¨å¤šé•¿æ—¶é—´å†…ï¼Œæœ‰å¤šå°‘æ¬¡æ›´æ–°æ“ä½œï¼Œå°±å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®æ–‡ä»¶ã€‚ï¼ˆRedis é»˜è®¤çš„æŒä¹…åŒ–æ–¹å¼ï¼šRDB æ–¹å¼ï¼‰redis é»˜è®¤é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†ä¸‰ä¸ªæ¡ä»¶: 123save 900 1save 300 10save 60 10000 è¡¨ç¤º 900 ç§’å†…æœ‰ 1 ä¸ªæ›´æ”¹ã€300 ç§’å†…æœ‰ 10 ä¸ªæ›´æ”¹ä»¥åŠ 60 ç§’å†…æœ‰ 10000 ä¸ªæ›´æ”¹ã€‚å¯ä»¥å­˜åœ¨å¤šä¸ªæ¡ä»¶ï¼Œæ¡ä»¶ä¹‹é—´æ˜¯â€œæˆ–â€çš„å…³ç³»ï¼Œåªè¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶ï¼Œå°±ä¼šè¿›è¡Œå¿«ç…§ã€‚ å¦‚æœæƒ³è¦ç¦ç”¨è‡ªåŠ¨å¿«ç…§ï¼Œåªéœ€è¦å°†æ‰€æœ‰çš„ save å‚æ•°åˆ é™¤å³å¯ã€‚ rdbcompression yesæŒ‡å®šå­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤ yesã€‚redis é‡‡ç”¨ LZF å‹ç¼©ï¼Œè‹¥éœ€èŠ‚çœ CPU æ—¶é—´å¯ä»¥å…³é—­ï¼Œä½†ä¼šå¯¼è‡´æ•°æ®åº“æ–‡ä»¶å˜å¤§ã€‚ dbfilenam dump.rdbåˆ¶å®šæœ¬åœ°æ•°æ®åº“æ–‡ä»¶å é»˜è®¤ä¸º dump.rdb dir ./åˆ¶å®šæœ¬åœ°æ•°æ®åº“å­˜æ”¾ç›®å½• slaveofè®¾ç½®å½“æœ¬æœºä¸º slave æœåŠ¡æ—¶ï¼Œè®¾ç½® master æœåŠ¡çš„ IP åœ°å€åŠç«¯å£ï¼Œåœ¨ Redis å¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä» master è¿›è¡Œæ•°æ®åŒæ­¥ masterauthå½“ master æœåŠ¡è®¾ç½®äº†å¯†ç ä¿æŠ¤æ—¶ï¼Œslave æœåŠ¡è¿æ¥ master çš„å¯†ç  requirepass boobaredè®¾ç½® redis è¿æ¥å¯†ç ï¼Œå¦‚æœé…ç½®äº†è¿æ¥å¯†ç ï¼Œå®¢æˆ·ç«¯åœ¨è¿æ¥ redis æ—¶éœ€è¦é€šè¿‡AUTH &lt;password&gt;å‘½ä»¤æä¾›å¯†ç ï¼Œé»˜è®¤å…³é—­ maxclients 128æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤æ— é™åˆ¶ã€‚0 è¡¨ç¤ºä¸é™åˆ¶è¶…è¿‡é™åˆ¶æ—¶ï¼Œredis ä¼šéå†æ–°çš„è¿æ¥å¹¶å‘å®¢æˆ·ç«¯è¿”å› max number of clients reached maxmemoryæœ€å¤§å†…å­˜é™åˆ¶è¾¾åˆ°æœ€å¤§å†…å­˜åï¼ŒRedis ä¼šå…ˆå°è¯•æ¸…é™¤å·²åˆ°æœŸæ´»å³å°†åˆ°æœŸçš„ keyã€‚å½“æ­¤æ–¹æ³•å¤„ç†åï¼Œä»ç„¶åˆ°è¾¾æœ€å¤§å†…å­˜è®¾ç½®ï¼Œå°†æ— æ³•å†è¿›è¡Œå†™å…¥æ“ä½œï¼Œä»å¯ä»¥è¿›è¡Œè¯»å–æ“ä½œã€‚Redis æ–°çš„ vm æœºåˆ¶ä¼šæŠŠ key å­˜æ”¾åœ¨å†…å­˜ï¼Œvalue å­˜æ”¾åœ¨ swap åŒº appendonly noæ˜¯å¦æ¯æ¬¡æ›´æ–°æ“ä½œåè¿›è¡Œæ—¥å¿—è®°å½•(æŒä¹…åŒ–ï¼šAOF)redis é»˜è®¤æƒ…å†µä¸‹å¼‚æ­¥æŠŠæ•°æ®å†™å…¥ç£ç›˜ï¼Œå¦‚æœä¸å¼€å¯ï¼Œå¯èƒ½ä¼šåœ¨æ–­ç”µæ—¶ä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ã€‚ appendfilename appendonly.aofæ›´æ–°æ—¥å¿—æ–‡ä»¶å appendfsync everysecæ—¥å¿—æ›´æ–°æ¡ä»¶ï¼Œå¯é€‰ noï¼šç­‰æ“ä½œç³»ç»Ÿè¿›è¡Œæ•°æ®ç¼“å­˜åŒæ­¥åˆ°ç£ç›˜ï¼ˆ30s ä¸€æ¬¡ï¼‰ - å¿« alwaysï¼šæ¯æ¬¡æ›´æ–°æ“ä½œåéƒ½ä¼šç³»ç»Ÿè°ƒç”¨ fsync()å°†æ•°æ®å†™ åˆ°ç£ç›˜ - æ…¢ï¼Œå®‰å…¨ everysec ï¼šæ¯ç§’ä¸€æ¬¡ - æŠ˜ä¸­ï¼Œé»˜è®¤ auto-aof-rewrite-percentage 100å½“ç›®å‰çš„ AOF æ–‡ä»¶å¤§å°è¶…è¿‡ä¸Šä¸€æ¬¡é‡å†™æ—¶çš„ AOF æ–‡ä»¶å¤§å°çš„ç™¾åˆ†ä¹‹å¤šå°‘æ—¶ä¼šå†æ¬¡è¿›è¡Œé‡å†™ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰é‡å†™è¿‡ï¼Œåˆ™ä»¥å¯åŠ¨æ—¶çš„ AOF æ–‡ä»¶å¤§å°ä¸ºä¾æ® auto-aof-rewrite-min-size 64mbå…è®¸é‡å†™çš„æœ€å° AOF æ–‡ä»¶å¤§å° vm-enabled noæŒ‡å®šæ˜¯å¦å¯ç”¨è™šæ‹Ÿå†…å­˜æœºåˆ¶ï¼Œé»˜è®¤ no vm-swap-file /tmp/redis.swapè™šæ‹Ÿå†…å­˜æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸º/temp/redis.swapï¼Œä¸å¯å¤šä¸ª Redis å®ä¾‹å…±äº« vm-max-memory 0å°†æ‰€æœ‰å¤§äºè¯¥å€¼çš„æ•°æ®å­˜å…¥è™šæ‹Ÿå†…å­˜ï¼Œæ— è®º vm-max-memory è®¾ç½®å¤šå°ï¼Œæ‰€æœ‰ç´¢å¼•æ•°æ®éƒ½æ˜¯å†…å­˜å­˜å‚¨çš„ï¼ˆkeysï¼‰ã€‚å½“ vm-max-memory è®¾ç½®ä¸º 0 æ—¶ï¼Œæ‰€æœ‰ value éƒ½å­˜å‚¨äºç£ç›˜ä¸­ vm-page-size 32redis swap æ–‡ä»¶åˆ†æˆäº†å¾ˆå¤šçš„ pageï¼Œä¸€ä¸ªå¯¹è±¡å¯ä»¥ä¿å­˜åœ¨å¤šä¸ª page ä¸Šï¼Œä½†ä¸€ä¸ª page ä¸Šä¸èƒ½è¢«å¤šä¸ªå¯¹è±¡å…±äº«ï¼Œvm-page-size è¦æ ¹æ®å­˜å‚¨çš„æ•°æ®å¤§å°æ¥è®¾å®šï¼Œå¦‚æœå­˜å‚¨å¾ˆå¤šå°å¯¹è±¡ï¼Œpage å¤§å°æœ€å¥½è®¾ç½®ä¸º 32 æˆ– 64bytesï¼›å¦‚æœå­˜å‚¨å¤§å¯¹è±¡ï¼Œåˆ™å¯ä½¿ç”¨æ›´å¤§çš„ page å¦‚æœä¸ç¡®å®šï¼Œå°±ä½¿ç”¨é»˜è®¤å€¼ vm-pages 134217728è®¾ç½® swap æ–‡ä»¶ä¸­çš„ page æ•°é‡ï¼Œç”±äºé¡µè¡¨æ˜¯å­˜æ”¾åœ¨å†…å­˜ä¸­çš„ï¼Œåœ¨ç£ç›˜ä¸Šæ²¡ 9 ä¸ª pages å°†æ¶ˆè€— 1byte çš„å†…å­˜ vm-maxthreads 4swap æ–‡ä»¶çš„çº¿ç¨‹æ•°ï¼Œæœ€å¥½ä¸è¦è¶…è¿‡æœºå™¨çš„æ ¸å¿ƒæ•°ï¼Œå¦‚æœè®¾ç½®ä¸º 0ï¼Œé‚£ä¹ˆæ‰€æœ‰å¯¹ swap æ–‡ä»¶çš„æ“ä½œéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆæ¯”è¾ƒé•¿æ—¶é—´çš„å»¶è¿Ÿã€‚é»˜è®¤ä¸º 4 glueoutputbuf yesè®¾ç½®åœ¨å‘å®¢æˆ·ç«¯åº”ç­”æ—¶ï¼Œæ˜¯å¦æŠŠè¾ƒå°çš„åŒ…åˆå¹¶ä¸ºä¸€ä¸ªåŒ…å‘é€ï¼Œé»˜è®¤å¼€å¯ hash-max-zipmap-entries 64hash-max-zipmap-value 512åœ¨è¶…è¿‡ä¸€å®šçš„æ•°é‡æˆ–è€…æœ€å¤§çš„å…ƒç´ è¶…è¿‡æŸä¸€ä¸´ç•Œå€¼æ—¶ï¼Œé‡‡ç”¨ä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œç®—æ³• include /path/to/local.confæŒ‡å®šåŒ…å«å…¶ä»–çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥åœ¨åŒä¸€ä¸»æœºä¸Šå¤šä¸ª Redis å®ä¾‹ä¹‹é—´ä½¿ç”¨åŒä¸€ä»½é…ç½®æ–‡ä»¶ï¼Œè€ŒåŒæ—¶å„ä¸ªå®ä¾‹åˆæ‹¥æœ‰è‡ªå·±çš„ç‰¹å®šé…ç½®æ–‡ä»¶ äº”ç§åŸºæœ¬æ•°æ®ç±»å‹1.String ç±»å‹ ä¸€ä¸ª keyï¼Œä¸€ä¸ª value äºŒè¿›åˆ¶å®‰å…¨ ä¸€ä¸ª key æœ€å¤§å­˜å‚¨ 512mb åŸºæœ¬å‘½ä»¤ï¼šsetã€get åº”ç”¨åœºæ™¯ï¼šString æ˜¯æœ€å¸¸ç”¨çš„ä¸€ç§æ•°æ®ç±»å‹ï¼Œæ™®é€šçš„ key/ value å­˜å‚¨éƒ½å¯ä»¥å½’ä¸ºæ­¤ç±».å³å¯ä»¥å®Œå…¨å®ç°ç›®å‰ Memcached çš„åŠŸèƒ½ï¼Œå¹¶ä¸”æ•ˆç‡æ›´é«˜ã€‚è¿˜å¯ä»¥äº«å— Redis çš„å®šæ—¶æŒä¹…åŒ–ï¼Œæ“ä½œæ—¥å¿—åŠ Replication ç­‰åŠŸèƒ½ã€‚é™¤äº†æä¾›ä¸ Memcached ä¸€æ ·çš„ getã€setã€incrã€decr ç­‰. æ™®é€šç¼“å­˜çš„ç”¨å¤„ã€‚ 2.List ç±»å‹ ç®€å•çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œç±»ä¼¼äºé˜Ÿåˆ—ï¼Œä½†æ˜¯æ˜¯åŒå‘çš„ï¼Œå› ä¸ºæ˜¯åŒé“¾è¡¨ æœ‰åº ä¸å»é‡ åŸºæœ¬å‘½ä»¤ï¼šlpushã€lpopã€rpushã€rpopã€lrange åº”ç”¨åœºæ™¯ï¼šRedis list çš„åº”ç”¨åœºæ™¯éå¸¸å¤šï¼Œä¹Ÿæ˜¯ Redis æœ€é‡è¦çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œæ¯”å¦‚ twitter çš„å…³æ³¨åˆ—è¡¨ï¼Œç²‰ä¸åˆ—è¡¨ç­‰éƒ½å¯ä»¥ç”¨ Redis çš„ list ç»“æ„æ¥å®ç°ã€‚Lists å°±æ˜¯é“¾è¡¨ï¼Œç›¸ä¿¡ç•¥æœ‰æ•°æ®ç»“æ„çŸ¥è¯†çš„äººéƒ½åº”è¯¥èƒ½ç†è§£å…¶ç»“æ„ã€‚ä½¿ç”¨ Lists ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å®ç°æœ€æ–°æ¶ˆæ¯æ’è¡Œç­‰åŠŸèƒ½ã€‚Lists çš„å¦ä¸€ä¸ªåº”ç”¨å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥åˆ©ç”¨ Lists çš„ PUSH æ“ä½œï¼Œå°†ä»»åŠ¡å­˜åœ¨ Lists ä¸­ï¼Œç„¶åå·¥ä½œçº¿ç¨‹å†ç”¨ POP æ“ä½œå°†ä»»åŠ¡å–å‡ºè¿›è¡Œæ‰§è¡Œã€‚Redis è¿˜æä¾›äº†æ“ä½œ Lists ä¸­æŸä¸€æ®µçš„ apiï¼Œä½ å¯ä»¥ç›´æ¥æŸ¥è¯¢ï¼Œåˆ é™¤ Lists ä¸­æŸä¸€æ®µçš„å…ƒç´ ã€‚ 3.Set ç±»å‹ æ— åº å»é‡ å“ˆå¸Œè¡¨å®ç°ï¼Œæ·»åŠ ï¼Œåˆ é™¤ï¼ŒæŸ¥è¯¢çš„å¤æ‚åº¦éƒ½æ˜¯ O(1) åŸºæœ¬å‘½ä»¤ï¼šsaddã€smembers åº”ç”¨åœºæ™¯ï¼šRedis set å¯¹å¤–æä¾›çš„åŠŸèƒ½ä¸ list ç±»ä¼¼æ˜¯ä¸€ä¸ªåˆ—è¡¨çš„åŠŸèƒ½ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äº set æ˜¯å¯ä»¥è‡ªåŠ¨æ’é‡çš„ï¼Œå½“ä½ éœ€è¦å­˜å‚¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ï¼Œåˆä¸å¸Œæœ›å‡ºç°é‡å¤æ•°æ®æ—¶ï¼Œset æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸” set æä¾›äº†åˆ¤æ–­æŸä¸ªæˆå‘˜æ˜¯å¦åœ¨ä¸€ä¸ª set é›†åˆå†…çš„é‡è¦æ¥å£ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ list æ‰€ä¸èƒ½æä¾›çš„ã€‚Sets é›†åˆçš„æ¦‚å¿µå°±æ˜¯ä¸€å †ä¸é‡å¤å€¼çš„ç»„åˆã€‚åˆ©ç”¨ Redis æä¾›çš„ Sets æ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜å‚¨ä¸€äº›é›†åˆæ€§çš„æ•°æ®ï¼Œæ¯”å¦‚åœ¨å¾®åšåº”ç”¨ä¸­ï¼Œå¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚Redis è¿˜ä¸ºé›†åˆæä¾›äº†æ±‚äº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰æ“ä½œï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¦‚å…±åŒå…³æ³¨ã€å…±åŒå–œå¥½ã€äºŒåº¦å¥½å‹ç­‰åŠŸèƒ½ï¼Œå¯¹ä¸Šé¢çš„æ‰€æœ‰é›†åˆæ“ä½œï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‘½ä»¤é€‰æ‹©å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯è¿˜æ˜¯å­˜é›†åˆ°ä¸€ä¸ªæ–°çš„é›†åˆä¸­ã€‚ 4.Zset ç±»å‹ æ ¹æ® Score ä»å°åˆ°å¤§æ’åºï¼ˆæœ‰åºï¼‰ å»é‡ï¼ˆä½†æ˜¯ä¼šæ›´æ–° Scoreï¼‰ åŸºæœ¬å‘½ä»¤ï¼šzaddã€zrangebyscore ä½¿ç”¨åœºæ™¯ï¼šRedis sorted set çš„ä½¿ç”¨åœºæ™¯ä¸ set ç±»ä¼¼ï¼ŒåŒºåˆ«æ˜¯ set ä¸æ˜¯è‡ªåŠ¨æœ‰åºçš„ï¼Œè€Œ sorted set å¯ä»¥é€šè¿‡ç”¨æˆ·é¢å¤–æä¾›ä¸€ä¸ªä¼˜å…ˆçº§(score)çš„å‚æ•°æ¥ä¸ºæˆå‘˜æ’åºï¼Œå¹¶ä¸”æ˜¯æ’å…¥æœ‰åºçš„ï¼Œå³è‡ªåŠ¨æ’åºã€‚å½“ä½ éœ€è¦ä¸€ä¸ªæœ‰åºçš„å¹¶ä¸”ä¸é‡å¤çš„é›†åˆåˆ—è¡¨ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹© sorted set æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ twitter çš„ public timeline å¯ä»¥ä»¥å‘è¡¨æ—¶é—´ä½œä¸º score æ¥å­˜å‚¨ï¼Œè¿™æ ·è·å–æ—¶å°±æ˜¯è‡ªåŠ¨æŒ‰æ—¶é—´æ’å¥½åºçš„ã€‚å¦å¤–è¿˜å¯ä»¥ç”¨ Sorted Sets æ¥åšå¸¦æƒé‡çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚æ™®é€šæ¶ˆæ¯çš„ score ä¸º 1ï¼Œé‡è¦æ¶ˆæ¯çš„ score ä¸º 2ï¼Œç„¶åå·¥ä½œçº¿ç¨‹å¯ä»¥é€‰æ‹©æŒ‰ score çš„å€’åºæ¥è·å–å·¥ä½œä»»åŠ¡ã€‚è®©é‡è¦çš„ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚ 5.Hash ç±»å‹ ç±»ä¼¼äº nosqlï¼Œä¸€ä¸ª key é‡Œé¢å¯ä»¥æœ‰å¤šä¸ª field å’Œ value çš„æ˜ å°„ åŸºæœ¬å‘½ä»¤ï¼šhmsetã€hgetall åº”ç”¨åœºæ™¯ï¼šåœ¨ Memcached ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸å°†ä¸€äº›ç»“æ„åŒ–çš„ä¿¡æ¯æ‰“åŒ…æˆ HashMapï¼Œåœ¨å®¢æˆ·ç«¯åºåˆ—åŒ–åå­˜å‚¨ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²çš„å€¼ï¼Œæ¯”å¦‚ç”¨æˆ·çš„æ˜µç§°ã€å¹´é¾„ã€æ€§åˆ«ã€ç§¯åˆ†ç­‰ï¼Œè¿™æ—¶å€™åœ¨éœ€è¦ä¿®æ”¹å…¶ä¸­æŸä¸€é¡¹æ—¶ï¼Œé€šå¸¸éœ€è¦å°†æ‰€æœ‰å€¼å–å‡ºååºåˆ—åŒ–åï¼Œä¿®æ”¹æŸä¸€é¡¹çš„å€¼ï¼Œå†åºåˆ—åŒ–å­˜å‚¨å›å»ã€‚è¿™æ ·ä¸ä»…å¢å¤§äº†å¼€é”€ï¼Œä¹Ÿä¸é€‚ç”¨äºä¸€äº›å¯èƒ½å¹¶å‘æ“ä½œçš„åœºåˆï¼ˆæ¯”å¦‚ä¸¤ä¸ªå¹¶å‘çš„æ“ä½œéƒ½éœ€è¦ä¿®æ”¹ç§¯åˆ†ï¼‰ã€‚è€Œ Redis çš„ Hash ç»“æ„å¯ä»¥ä½¿ä½ åƒåœ¨æ•°æ®åº“ä¸­ Update ä¸€ä¸ªå±æ€§ä¸€æ ·åªä¿®æ”¹æŸä¸€é¡¹å±æ€§å€¼ã€‚ redis çš„æŒä¹…åŒ– RDB å¿«ç…§ï¼Œå…¨é‡å¤‡ä»½ AOF append only file å¢é‡å¤‡ä»½ Redis å…è®¸åŒæ—¶å¼€å¯ AOF å’Œ RDBï¼Œæ—¢ä¿è¯äº†æ•°æ®å®‰å…¨åˆä½¿å¾—è¿›è¡Œå¤‡ä»½ç­‰æ“ä½œååˆ†å®¹æ˜“ã€‚æ­¤æ—¶é‡æ–°å¯åŠ¨ Redis å Redis ä¼šä½¿ç”¨ AOF æ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œå› ä¸º AOF æ–¹å¼çš„æŒä¹…åŒ–å¯èƒ½ä¸¢å¤±çš„æ•°æ®æ›´å°‘ save å’Œ bgsave çš„åŒºåˆ«ã€‚ save ä¼šé˜»å¡ä¸»è¿›ç¨‹ bgsave ä¼š fork ä¸€ä¸ªå­è¿›ç¨‹è¿›è¡Œå¿«ç…§å¤‡ä»½ï¼Œä¸ä¼šé˜»å¡ä¸»è¿›ç¨‹ aof æ–‡ä»¶å¤‡ä»½ä¸ dump æ–‡ä»¶å¤‡ä»½ä¸åŒã€‚dump æ–‡ä»¶çš„ç¼–ç æ ¼å¼å’Œå­˜å‚¨æ ¼å¼ä¸æ•°æ®åº“ä¸€è‡´ï¼Œè€Œä¸” dump æ–‡ä»¶ä¸­å¤‡ä»½çš„æ˜¯æ•°æ®åº“çš„å½“å‰å¿«ç…§ï¼Œæ„æ€å°±æ˜¯ï¼Œä¸ç®¡æ•°æ®ä¹‹å‰ä»€ä¹ˆæ ·ï¼Œåªè¦ BGSAVE äº†ï¼Œdump æ–‡ä»¶å°±ä¼šåˆ·æ–°æˆå½“å‰æ•°æ®åº“æ•°æ®ã€‚ å½“ redis é‡å¯æ—¶ï¼Œä¼šæŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§è¿›è¡Œå¯åŠ¨ï¼š å¦‚æœåªé…ç½® AOF,é‡å¯æ—¶åŠ è½½ AOF æ–‡ä»¶æ¢å¤æ•°æ®ï¼›å¦‚æœåŒæ—¶ é…ç½®äº† RBD å’Œ AOF,å¯åŠ¨æ˜¯åªåŠ è½½ AOF æ–‡ä»¶æ¢å¤æ•°æ®;å¦‚æœåªé…ç½® RBD,å¯åŠ¨æ—¶å°†åŠ è½½ dump æ–‡ä»¶æ¢å¤æ•°æ®ã€‚ æ³¨æ„ï¼šåªè¦é…ç½®äº† aofï¼Œä½†æ˜¯æ²¡æœ‰ aof æ–‡ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å¯åŠ¨çš„æ•°æ®åº“ä¼šæ˜¯ç©ºçš„ redis é›†ç¾¤123456port 7001 #ä¿®æ”¹ç«¯å£å·ï¼Œä»7001åˆ°7006cluster-enabled yes #å¼€å¯clusterï¼Œå»æ‰æ³¨é‡Šcluster-config-file nodes.confcluster-node-timeout 15000appendonly yes å¤åˆ¶å…­ä»½ï¼Œä¿®æ”¹å¯¹åº”çš„ç«¯å£å· å¯åŠ¨ 6 ä¸ªæœåŠ¡ï¼Œåˆ†åˆ«åŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œå³å¯å®ç° redis é›†ç¾¤ã€‚ å®¢æˆ·ç«¯è¿æ¥é›†ç¾¤ redis-cli éœ€è¦å¸¦ä¸Š -c","categories":[{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/categories/Redis/"}],"tags":[{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/tags/Redis/"}]},{"title":"ã€ç½‘ç»œç¼–ç¨‹ã€‘socketé˜»å¡ä¸éé˜»å¡ï¼ŒåŒæ­¥ä¸å¼‚æ­¥ã€I/Oæ¨¡å‹ï¼Œselectä¸pollã€epollæ¯”è¾ƒ","slug":"network-model","date":"2018-02-23T05:54:00.000Z","updated":"2021-03-20T16:25:01.811Z","comments":true,"path":"2018/02/23/network-model/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/23/network-model/","excerpt":"","text":"è¯´æ˜ä½œä¸ºphperï¼Œå…¶å®å¾ˆå¤šä¸äº†è§£ç½‘ç»œç¼–ç¨‹çš„äººæ¥è¯´ï¼Œå¾ˆå®¹æ˜“å¿½ç•¥ä¸€äº›æ¦‚å¿µï¼Œåœ¨è¿™é‡Œï¼Œè¿™äº›ç½‘ç»œåŸºæœ¬æ¦‚å¿µï¼Œæœ‰å¿…è¦æ¢³ç†ä¸€ä¸‹ã€‚ Sync åŒæ­¥ Async å¼‚æ­¥ Block é˜»å¡ Unblock éé˜»å¡ åŒæ­¥ã€å¼‚æ­¥çš„æ¦‚å¿µï¼Œä¸»è¦é’ˆå¯¹Cç«¯åŒæ­¥ï¼š æ‰€è°“åŒæ­¥ï¼Œå°±æ˜¯åœ¨cç«¯å‘å‡ºä¸€ä¸ªåŠŸèƒ½è°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨å°±ä¸è¿”å›ã€‚ä¹Ÿå°±æ˜¯å¿…é¡»ä¸€ä»¶ä¸€ä»¶äº‹åš,ç­‰å‰ä¸€ä»¶åšå®Œäº†æ‰èƒ½åšä¸‹ä¸€ä»¶äº‹ã€‚ ä¾‹å¦‚æ™®é€šhttpè¯·æ±‚ï¼ŒB/Sæ¨¡å¼ï¼ˆåŒæ­¥ï¼‰ï¼šæäº¤è¯·æ±‚-&gt;ç­‰å¾…æœåŠ¡å™¨å¤„ç†-&gt;å¤„ç†å®Œæ¯•è¿”å› è¿™ä¸ªæœŸé—´å®¢æˆ·ç«¯æµè§ˆå™¨ä¸èƒ½å¹²ä»»ä½•äº‹ å¼‚æ­¥ï¼š å¼‚æ­¥çš„æ¦‚å¿µå’ŒåŒæ­¥ç›¸å¯¹ã€‚å½“cç«¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„éƒ¨ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…ã€‚ ä¾‹å¦‚ ajaxè¯·æ±‚ï¼ˆå¼‚æ­¥ï¼‰: è¯·æ±‚é€šè¿‡äº‹ä»¶è§¦å‘-&gt;æœåŠ¡å™¨å¤„ç†ï¼ˆè¿™æ˜¯æµè§ˆå™¨ä»ç„¶å¯ä»¥ä½œå…¶ä»–äº‹æƒ…ï¼‰-&gt;å¤„ç†å®Œæ¯• é˜»å¡ã€éé˜»å¡çš„æ¦‚å¿µï¼Œä¸»è¦é’ˆå¯¹Sç«¯é˜»å¡/éé˜»å¡ä¸»è¦é’ˆå¯¹Sç«¯: é˜»å¡ï¼š é˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ˆçº¿ç¨‹è¿›å…¥éå¯æ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œcpuä¸ä¼šç»™çº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡ï¼Œå³çº¿ç¨‹æš‚åœè¿è¡Œï¼‰ã€‚å‡½æ•°åªæœ‰åœ¨å¾—åˆ°ç»“æœä¹‹åæ‰ä¼šè¿”å›ã€‚ æœ‰äººä¹Ÿè®¸ä¼šæŠŠé˜»å¡è°ƒç”¨å’ŒåŒæ­¥è°ƒç”¨ç­‰åŒèµ·æ¥ï¼Œå®é™…ä¸Šä»–æ˜¯ä¸åŒçš„ã€‚å¯¹äºåŒæ­¥è°ƒç”¨æ¥è¯´ï¼Œå¾ˆå¤šæ—¶å€™å½“å‰çº¿ç¨‹è¿˜æ˜¯æ¿€æ´»çš„ï¼Œåªæ˜¯ä»é€»è¾‘ä¸Šå½“å‰å‡½æ•°æ²¡æœ‰è¿”å›è€Œå·²ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨socketä¸­è°ƒç”¨recvå‡½æ•°ï¼Œå¦‚æœç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ•°æ®æ‰è¿”å›ã€‚è€Œæ­¤æ—¶ï¼Œå½“å‰çº¿ç¨‹è¿˜ä¼šç»§ç»­å¤„ç†å„ç§å„æ ·çš„æ¶ˆæ¯ã€‚ å¿«é€’çš„ä¾‹å­ï¼šæ¯”å¦‚åˆ°ä½ æŸä¸ªæ—¶å€™åˆ°Aæ¥¼ä¸€å±‚ï¼ˆå‡å¦‚æ˜¯å†…æ ¸ç¼“å†²åŒºï¼‰å–å¿«é€’ï¼Œä½†æ˜¯ä½ ä¸çŸ¥é“å¿«é€’ä»€ä¹ˆæ—¶å€™è¿‡æ¥ï¼Œä½ åˆä¸èƒ½å¹²åˆ«çš„äº‹ï¼Œåªèƒ½æ­»ç­‰ç€ã€‚ä½†ä½ å¯ä»¥ç¡è§‰ï¼ˆè¿›ç¨‹å¤„äºä¼‘çœ çŠ¶æ€ï¼‰ï¼Œå› ä¸ºä½ çŸ¥é“å¿«é€’æŠŠè´§é€æ¥æ—¶ä¸€å®šä¼šç»™ä½ æ‰“ä¸ªç”µè¯ï¼ˆå‡å®šä¸€å®šèƒ½å«é†’ä½ ï¼‰ã€‚ éé˜»å¡ï¼š éé˜»å¡å’Œé˜»å¡çš„æ¦‚å¿µç›¸å¯¹åº”ï¼ŒæŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥å‡½æ•°ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œä¼šç«‹åˆ»è¿”å›ã€‚ è¿˜æ˜¯ç­‰å¿«é€’çš„ä¾‹å­ï¼šå¦‚æœç”¨å¿™è½®è¯¢çš„æ–¹æ³•ï¼Œæ¯éš”5åˆ†é’Ÿåˆ°Aæ¥¼ä¸€å±‚(å†…æ ¸ç¼“å†²åŒºï¼‰å»çœ‹å¿«é€’æ¥äº†æ²¡æœ‰ã€‚å¦‚æœæ²¡æ¥ï¼Œç«‹å³è¿”å›ã€‚è€Œå¿«é€’æ¥äº†ï¼Œå°±æ”¾åœ¨Aæ¥¼ä¸€å±‚ï¼Œç­‰ä½ å»å–ã€‚ åŒæ­¥IOå’Œå¼‚æ­¥IOçš„åŒºåˆ«å°±åœ¨äºï¼šæ•°æ®è®¿é—®çš„æ—¶å€™è¿›ç¨‹æ˜¯å¦é˜»å¡ï¼ é˜»å¡IOå’Œéé˜»å¡IOçš„åŒºåˆ«å°±åœ¨äºï¼šåº”ç”¨ç¨‹åºçš„è°ƒç”¨æ˜¯å¦ç«‹å³è¿”å›ï¼ åŒæ­¥å’Œå¼‚æ­¥éƒ½åªé’ˆå¯¹äºæœ¬æœºSOCKETè€Œè¨€çš„ã€‚ åŒæ­¥å’Œå¼‚æ­¥,é˜»å¡å’Œéé˜»å¡,æœ‰äº›æ··ç”¨,å…¶å®å®ƒä»¬å®Œå…¨ä¸æ˜¯ä¸€å›äº‹,è€Œä¸”å®ƒä»¬ä¿®é¥°çš„å¯¹è±¡ä¹Ÿä¸ç›¸åŒã€‚ é˜»å¡å’Œéé˜»å¡æ˜¯æŒ‡å½“serverç«¯çš„è¿›ç¨‹è®¿é—®çš„æ•°æ®å¦‚æœå°šæœªå°±ç»ª,è¿›ç¨‹æ˜¯å¦éœ€è¦ç­‰å¾…,ç®€å•è¯´è¿™ç›¸å½“äºå‡½æ•°å†…éƒ¨çš„å®ç°åŒºåˆ«,ä¹Ÿå°±æ˜¯æœªå°±ç»ªæ—¶æ˜¯ç›´æ¥è¿”å›è¿˜æ˜¯ç­‰å¾…å°±ç»ª; è€ŒåŒæ­¥å’Œå¼‚æ­¥æ˜¯æŒ‡clientç«¯è®¿é—®æ•°æ®çš„æœºåˆ¶ï¼ŒåŒæ­¥ä¸€èˆ¬æŒ‡ä¸»åŠ¨è¯·æ±‚å¹¶ç­‰å¾…I/Oæ“ä½œå®Œæ¯•çš„æ–¹å¼ï¼Œå½“æ•°æ®å°±ç»ªååœ¨è¯»å†™çš„æ—¶å€™å¿…é¡»é˜»å¡(åŒºåˆ«å°±ç»ªä¸è¯»å†™äºŒä¸ªé˜¶æ®µ,åŒæ­¥çš„è¯»å†™å¿…é¡»é˜»å¡)ï¼Œå¼‚æ­¥åˆ™æŒ‡ä¸»åŠ¨è¯·æ±‚æ•°æ®åä¾¿å¯ä»¥ç»§ç»­å¤„ç†å…¶å®ƒä»»åŠ¡,éšåç­‰å¾…I/O,æ“ä½œå®Œæ¯•çš„é€šçŸ¥,è¿™å¯ä»¥ä½¿è¿›ç¨‹åœ¨æ•°æ®è¯»å†™æ—¶ä¹Ÿä¸é˜»å¡ã€‚(ç­‰å¾…â€é€šçŸ¥â€) åŒæ­¥å°±æ˜¯åŒæ­¥ï¼Œå¼‚æ­¥å°±æ˜¯å¼‚æ­¥! ç›®å‰åº”ç”¨ä¸­é˜»å¡å’Œéé˜»å¡æ˜¯é’ˆå¯¹åŒæ­¥åº”ç”¨è€Œè¨€ã€‚ Linuxä¸‹çš„äº”ç§I/Oæ¨¡å‹ é˜»å¡I/O (blocking I/O) éé˜»å¡I/O (nonblocking I/O) I/Oå¤ç”¨ ï¼ˆselectå’Œpollï¼‰ï¼ˆI/O multplexingï¼‰ ä¿¡å·é©±åŠ¨I/O å¼‚æ­¥I/O ï¼ˆå‰é¢å››ç§éƒ½æ˜¯åŒæ­¥ï¼Œåªæœ‰æœ€åä¸€ç§æ‰æ˜¯å¼‚æ­¥IOï¼‰ é˜»å¡I/Oæ¨¡å‹ ç®€ä»‹ï¼šè¿›ç¨‹ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æ•°æ®æ‹·è´å®Œæˆ åº”ç”¨ç¨‹åºè°ƒç”¨ä¸€ä¸ªIOå‡½æ•°ï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºé˜»å¡ï¼Œç­‰å¾…æ•°æ®å‡†å¤‡å¥½ã€‚ å¦‚æœæ•°æ®æ²¡æœ‰å‡†å¤‡å¥½ï¼Œä¸€ç›´ç­‰å¾…â€¦.æ•°æ®å‡†å¤‡å¥½äº†ï¼Œä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´,IOå‡½æ•°è¿”å›æˆåŠŸæŒ‡ç¤ºã€‚ æˆ‘ä»¬ ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°çš„ç½‘ç»œç¼–ç¨‹éƒ½æ˜¯ä» listen()ã€send()ã€recv()ç­‰æ¥å£å¼€å§‹çš„ã€‚ä½¿ç”¨è¿™äº›æ¥å£å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ„å»ºæœåŠ¡å™¨ /å®¢æˆ·æœºçš„æ¨¡å‹ã€‚ é˜»å¡I/Oæ¨¡å‹å›¾ï¼šåœ¨è°ƒç”¨recv()/recvfromï¼ˆï¼‰å‡½æ•°æ—¶ï¼Œå‘ç”Ÿåœ¨å†…æ ¸ä¸­ç­‰å¾…æ•°æ®å’Œå¤åˆ¶æ•°æ®çš„è¿‡ç¨‹ã€‚ å½“è°ƒç”¨recv()å‡½æ•°æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆæŸ¥æ˜¯å¦æœ‰å‡†å¤‡å¥½çš„æ•°æ®ã€‚å¦‚æœæ•°æ®æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±å¤„äºç­‰å¾…çŠ¶æ€ã€‚å½“æ•°æ®å‡†å¤‡å¥½åï¼Œå°†æ•°æ®ä»ç³»ç»Ÿç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç„¶åè¯¥å‡½æ•°è¿”å›ã€‚åœ¨å¥—æ¥åº”ç”¨ç¨‹åºä¸­ï¼Œå½“è°ƒç”¨recv()å‡½æ•°æ—¶ï¼Œæœªå¿…ç”¨æˆ·ç©ºé—´å°±å·²ç»å­˜åœ¨æ•°æ®ï¼Œé‚£ä¹ˆæ­¤æ—¶recv()å‡½æ•°å°±ä¼šå¤„äºç­‰å¾…çŠ¶æ€ã€‚ å½“ä½¿ç”¨socket()å‡½æ•°åˆ›å»ºå¥—æ¥å­—æ—¶ï¼Œé»˜è®¤çš„å¥—æ¥å­—éƒ½æ˜¯é˜»å¡çš„ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰ Sockets APIä»¥é˜»å¡å¥—æ¥å­—ä¸ºå‚æ•°è°ƒç”¨éƒ½ä¼šå‘ç”Ÿé˜»å¡ã€‚ä¾‹å¦‚ï¼Œä»¥é˜»å¡æ¨¡å¼çš„å¥—æ¥å­—ä¸ºå‚æ•°è°ƒç”¨bind()ã€listen()å‡½æ•°æ—¶ï¼Œå‡½æ•°ä¼šç«‹å³è¿”å›ã€‚ 1ï¼è¾“å…¥æ“ä½œï¼š recv()ã€recvfrom()å‡½æ•°ã€‚ä»¥é˜»å¡å¥—æ¥å­—ä¸ºå‚æ•°è°ƒç”¨è¯¥å‡½æ•°æ¥æ”¶æ•°æ®ã€‚å¦‚æœæ­¤æ—¶å¥—æ¥å­—ç¼“å†²åŒºå†…æ²¡æœ‰æ•°æ®å¯è¯»ï¼Œåˆ™è°ƒç”¨çº¿ç¨‹åœ¨æ•°æ®åˆ°æ¥å‰ä¸€ç›´ç¡çœ ã€‚ 2ï¼è¾“å‡ºæ“ä½œï¼š send()ã€sendto()å‡½æ•°ã€‚ä»¥é˜»å¡å¥—æ¥å­—ä¸ºå‚æ•°è°ƒç”¨è¯¥å‡½æ•°å‘é€æ•°æ®ã€‚å¦‚æœå¥—æ¥å­—ç¼“å†²åŒºæ²¡æœ‰å¯ç”¨ç©ºé—´ï¼Œçº¿ç¨‹ä¼šä¸€ç›´ç¡çœ ï¼Œç›´åˆ°æœ‰ç©ºé—´ã€‚ 3ï¼æ¥å—è¿æ¥ï¼šaccept()å‡½æ•°ã€‚ä»¥é˜»å¡å¥—æ¥å­—ä¸ºå‚æ•°è°ƒç”¨è¯¥å‡½æ•°ï¼Œç­‰å¾…æ¥å—å¯¹æ–¹çš„è¿æ¥è¯·æ±‚ã€‚å¦‚æœæ­¤æ—¶æ²¡æœ‰è¿æ¥è¯·æ±‚ï¼Œçº¿ç¨‹å°±ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ã€‚ 4ï¼å¤–å‡ºè¿æ¥ï¼šconnect()å‡½æ•°ã€‚å¯¹äºTCPè¿æ¥ï¼Œå®¢æˆ·ç«¯ä»¥é˜»å¡å¥—æ¥å­—ä¸ºå‚æ•°ï¼Œè°ƒç”¨è¯¥å‡½æ•°å‘æœåŠ¡å™¨å‘èµ·è¿æ¥ã€‚è¯¥å‡½æ•°åœ¨æ”¶åˆ°æœåŠ¡å™¨çš„åº”ç­”å‰ï¼Œä¸ä¼šè¿”å›ã€‚è¿™æ„å‘³ç€TCPè¿æ¥æ€»ä¼šç­‰å¾…è‡³å°‘åˆ°æœåŠ¡å™¨çš„ä¸€æ¬¡å¾€è¿”æ—¶é—´ã€‚ ä½¿ç”¨é˜»å¡æ¨¡å¼çš„å¥—æ¥å­—ï¼Œå¼€å‘ç½‘ç»œç¨‹åºæ¯”è¾ƒç®€å•ï¼Œå®¹æ˜“å®ç°ã€‚å½“å¸Œæœ›èƒ½å¤Ÿç«‹å³å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œä¸”å¤„ç†çš„å¥—æ¥å­—æ•°é‡æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨é˜»å¡æ¨¡å¼æ¥å¼€å‘ç½‘ç»œç¨‹åºæ¯”è¾ƒåˆé€‚ã€‚ é˜»å¡æ¨¡å¼å¥—æ¥å­—çš„ä¸è¶³è¡¨ç°ä¸ºï¼Œåœ¨å¤§é‡å»ºç«‹å¥½çš„å¥—æ¥å­—çº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡æ—¶æ¯”è¾ƒå›°éš¾ã€‚å½“ä½¿ç”¨â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€æ¨¡å‹å¼€å‘ç½‘ç»œç¨‹åºæ—¶ï¼Œä¸ºæ¯ä¸ªå¥—æ¥å­—éƒ½åˆ†åˆ«åˆ†é…ä¸€ä¸ªè¯»çº¿ç¨‹ã€ä¸€ä¸ªå¤„ç†æ•°æ®çº¿ç¨‹å’Œä¸€ä¸ªç”¨äºåŒæ­¥çš„äº‹ä»¶ï¼Œé‚£ä¹ˆè¿™æ ·æ— ç–‘åŠ å¤§ç³»ç»Ÿçš„å¼€é”€ã€‚å…¶æœ€å¤§çš„ç¼ºç‚¹æ˜¯å½“å¸Œæœ›åŒæ—¶å¤„ç†å¤§é‡å¥—æ¥å­—æ—¶ï¼Œå°†æ— ä»ä¸‹æ‰‹ï¼Œå…¶æ‰©å±•æ€§å¾ˆå·®. é˜»å¡æ¨¡å¼ç»™ç½‘ç»œç¼–ç¨‹å¸¦æ¥äº†ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå¦‚åœ¨è°ƒç”¨ send()çš„åŒæ—¶ï¼Œçº¿ç¨‹å°†è¢«é˜»å¡ï¼Œåœ¨æ­¤æœŸé—´ï¼Œçº¿ç¨‹å°†æ— æ³•æ‰§è¡Œä»»ä½•è¿ç®—æˆ–å“åº”ä»»ä½•çš„ç½‘ç»œè¯·æ±‚ã€‚è¿™ç»™å¤šå®¢æˆ·æœºã€å¤šä¸šåŠ¡é€»è¾‘çš„ç½‘ç»œç¼–ç¨‹å¸¦æ¥äº†æŒ‘æˆ˜ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé€‰æ‹©å¤šçº¿ç¨‹çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ åº”å¯¹å¤šå®¢æˆ·æœºçš„ç½‘ç»œåº”ç”¨ï¼Œæœ€ç®€å•çš„è§£å†³æ–¹å¼æ˜¯åœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨å¤šçº¿ç¨‹ï¼ˆæˆ–å¤šè¿›ç¨‹ï¼‰ã€‚å¤šçº¿ç¨‹ï¼ˆæˆ–å¤šè¿›ç¨‹ï¼‰çš„ç›®çš„æ˜¯è®©æ¯ä¸ªè¿æ¥éƒ½æ‹¥æœ‰ç‹¬ç«‹çš„çº¿ç¨‹ï¼ˆæˆ–è¿›ç¨‹ï¼‰ï¼Œè¿™æ ·ä»»ä½•ä¸€ä¸ªè¿æ¥çš„é˜»å¡éƒ½ä¸ä¼šå½±å“å…¶ä»–çš„è¿æ¥ã€‚ å…·ä½“ä½¿ç”¨å¤šè¿›ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªç‰¹å®šçš„æ¨¡å¼ã€‚ä¼ ç»Ÿæ„ä¹‰ä¸Šï¼Œè¿›ç¨‹çš„å¼€é”€è¦è¿œè¿œå¤§äºçº¿ç¨‹ï¼Œæ‰€ä»¥ï¼Œå¦‚æœéœ€è¦åŒæ—¶ä¸ºè¾ƒå¤šçš„å®¢æˆ·æœºæä¾›æœåŠ¡ï¼Œåˆ™ä¸æ¨èä½¿ç”¨å¤šè¿›ç¨‹ï¼›å¦‚æœå•ä¸ªæœåŠ¡æ‰§è¡Œä½“éœ€è¦æ¶ˆè€—è¾ƒå¤šçš„ CPU èµ„æºï¼Œè­¬å¦‚éœ€è¦è¿›è¡Œå¤§è§„æ¨¡æˆ–é•¿æ—¶é—´çš„æ•°æ®è¿ç®—æˆ–æ–‡ä»¶è®¿é—®ï¼Œåˆ™è¿›ç¨‹è¾ƒä¸ºå®‰å…¨ã€‚é€šå¸¸ï¼Œä½¿ç”¨ pthread_create () åˆ›å»ºæ–°çº¿ç¨‹ï¼Œfork() åˆ›å»ºæ–°è¿›ç¨‹ã€‚ å¤šçº¿ç¨‹/è¿›ç¨‹æœåŠ¡å™¨åŒæ—¶ä¸ºå¤šä¸ªå®¢æˆ·æœºæä¾›åº”ç­”æœåŠ¡ã€‚æ¨¡å‹å¦‚ä¸‹ï¼š ä¸»çº¿ç¨‹æŒç»­ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¦‚æœæœ‰è¿æ¥ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå¹¶åœ¨æ–°çº¿ç¨‹ä¸­æä¾›ä¸ºå‰ä¾‹åŒæ ·çš„é—®ç­”æœåŠ¡ã€‚ ä¸Šè¿°å¤šçº¿ç¨‹çš„æœåŠ¡å™¨æ¨¡å‹ä¼¼ä¹å®Œç¾çš„è§£å†³äº†ä¸ºå¤šä¸ªå®¢æˆ·æœºæä¾›é—®ç­”æœåŠ¡çš„è¦æ±‚ï¼Œä½†å…¶å®å¹¶ä¸å°½ç„¶ã€‚å¦‚æœè¦åŒæ—¶å“åº”æˆç™¾ä¸Šåƒè·¯çš„è¿æ¥è¯·æ±‚ï¼Œåˆ™æ— è®ºå¤šçº¿ç¨‹è¿˜æ˜¯å¤šè¿›ç¨‹éƒ½ä¼šä¸¥é‡å æ®ç³»ç»Ÿèµ„æºï¼Œé™ä½ç³»ç»Ÿå¯¹å¤–ç•Œå“åº”æ•ˆç‡ï¼Œè€Œçº¿ç¨‹ä¸è¿›ç¨‹æœ¬èº«ä¹Ÿæ›´å®¹æ˜“è¿›å…¥å‡æ­»çŠ¶æ€ã€‚ ç”±æ­¤å¯èƒ½ä¼šè€ƒè™‘ä½¿ç”¨â€œçº¿ç¨‹æ± â€æˆ–â€œè¿æ¥æ± â€ã€‚â€œçº¿ç¨‹æ± â€æ—¨åœ¨å‡å°‘åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„é¢‘ç‡ï¼Œå…¶ç»´æŒä¸€å®šåˆç†æ•°é‡çš„çº¿ç¨‹ï¼Œå¹¶è®©ç©ºé—²çš„çº¿ç¨‹é‡æ–°æ‰¿æ‹…æ–°çš„æ‰§è¡Œä»»åŠ¡ã€‚â€œè¿æ¥æ± â€ç»´æŒè¿æ¥çš„ç¼“å­˜æ± ï¼Œå°½é‡é‡ç”¨å·²æœ‰çš„è¿æ¥ã€å‡å°‘åˆ›å»ºå’Œå…³é—­è¿æ¥çš„é¢‘ç‡ã€‚è¿™ä¸¤ç§æŠ€æœ¯éƒ½å¯ä»¥å¾ˆå¥½çš„é™ä½ç³»ç»Ÿå¼€é”€ï¼Œéƒ½è¢«å¹¿æ³›åº”ç”¨å¾ˆå¤šå¤§å‹ç³»ç»Ÿï¼Œå¦‚apacheï¼ŒMySQLæ•°æ®åº“ç­‰ã€‚ ä½†æ˜¯ï¼Œâ€œçº¿ç¨‹æ± â€å’Œâ€œè¿æ¥æ± â€æŠ€æœ¯ä¹Ÿåªæ˜¯åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£äº†é¢‘ç¹è°ƒç”¨ IO æ¥å£å¸¦æ¥çš„èµ„æºå ç”¨ã€‚è€Œä¸”ï¼Œæ‰€è°“â€œæ± â€å§‹ç»ˆæœ‰å…¶ä¸Šé™ï¼Œå½“è¯·æ±‚å¤§å¤§è¶…è¿‡ä¸Šé™æ—¶ï¼Œâ€œæ± â€æ„æˆçš„ç³»ç»Ÿå¯¹å¤–ç•Œçš„å“åº”å¹¶ä¸æ¯”æ²¡æœ‰æ± çš„æ—¶å€™æ•ˆæœå¥½å¤šå°‘ã€‚æ‰€ä»¥ä½¿ç”¨â€œæ± â€å¿…é¡»è€ƒè™‘å…¶é¢ä¸´çš„å“åº”è§„æ¨¡ï¼Œå¹¶æ ¹æ®å“åº”è§„æ¨¡è°ƒæ•´â€œæ± â€çš„å¤§å°ã€‚. å¯¹åº”ä¸Šä¾‹ä¸­çš„æ‰€é¢ä¸´çš„å¯èƒ½åŒæ—¶å‡ºç°çš„ä¸Šåƒç”šè‡³ä¸Šä¸‡æ¬¡çš„å®¢æˆ·ç«¯è¯·æ±‚ï¼Œâ€œçº¿ç¨‹æ± â€æˆ–â€œè¿æ¥æ± â€æˆ–è®¸å¯ä»¥ç¼“è§£éƒ¨åˆ†å‹åŠ›ï¼Œä½†æ˜¯ä¸èƒ½è§£å†³æ‰€æœ‰é—®é¢˜ã€‚ éé˜»å¡IOæ¨¡å‹ï¼šç®€ä»‹ï¼šéé˜»å¡IOé€šè¿‡è¿›ç¨‹åå¤è°ƒç”¨IOå‡½æ•°ï¼ˆå¤šæ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶é©¬ä¸Šè¿”å›ï¼‰ï¼›åœ¨æ•°æ®æ‹·è´çš„è¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹æ˜¯é˜»å¡çš„ã€‚ æˆ‘ä»¬æŠŠä¸€ä¸ªSOCKETæ¥å£è®¾ç½®ä¸ºéé˜»å¡å°±æ˜¯å‘Šè¯‰å†…æ ¸ï¼Œå½“æ‰€è¯·æ±‚çš„I/Oæ“ä½œæ— æ³•å®Œæˆæ—¶ï¼Œä¸è¦å°†è¿›ç¨‹ç¡çœ ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚è¿™æ ·æˆ‘ä»¬çš„I/Oæ“ä½œå‡½æ•°å°†ä¸æ–­çš„æµ‹è¯•æ•°æ®æ˜¯å¦å·²ç»å‡†å¤‡å¥½ï¼Œå¦‚æœæ²¡æœ‰å‡†å¤‡å¥½ï¼Œç»§ç»­æµ‹è¯•ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ä¸ºæ­¢ã€‚åœ¨è¿™ä¸ªä¸æ–­æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¤§é‡çš„å ç”¨CPUçš„æ—¶é—´ã€‚ æŠŠSOCKETè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå³é€šçŸ¥ç³»ç»Ÿå†…æ ¸ï¼šåœ¨è°ƒç”¨Sockets APIæ—¶ï¼Œä¸è¦è®©çº¿ç¨‹ç¡çœ ï¼Œè€Œåº”è¯¥è®©å‡½æ•°ç«‹å³è¿”å›ã€‚åœ¨è¿”å›æ—¶ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç ã€‚å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªéé˜»å¡æ¨¡å¼å¥—æ¥å­—å¤šæ¬¡è°ƒç”¨recv()å‡½æ•°çš„è¿‡ç¨‹ã€‚å‰ä¸‰æ¬¡è°ƒç”¨recv()å‡½æ•°æ—¶ï¼Œå†…æ ¸æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ã€‚å› æ­¤ï¼Œè¯¥å‡½æ•°ç«‹å³è¿”å›EWOULDBLOCKé”™è¯¯ä»£ç ã€‚ç¬¬å››æ¬¡è°ƒç”¨recv()å‡½æ•°æ—¶ï¼Œæ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œè¢«å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºä¸­ï¼Œrecv()å‡½æ•°è¿”å›æˆåŠŸæŒ‡ç¤ºï¼Œåº”ç”¨ç¨‹åºå¼€å§‹å¤„ç†æ•°æ®ã€‚ å½“ä½¿ç”¨socket()å‡½æ•°å’ŒWSASocket()å‡½æ•°åˆ›å»ºå¥—æ¥å­—æ—¶ï¼Œé»˜è®¤éƒ½æ˜¯é˜»å¡çš„ã€‚åœ¨åˆ›å»ºå¥—æ¥å­—ä¹‹åï¼Œé€šè¿‡è°ƒç”¨å‡½æ•°fcntl()ï¼Œå°†è¯¥å¥—æ¥å­—è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ã€‚å¥—æ¥å­—è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼åï¼Œåœ¨è°ƒSockets APIå‡½æ•°æ—¶ï¼Œè°ƒç”¨å‡½æ•°ä¼šç«‹å³è¿”å›ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™äº›å‡½æ•°è°ƒç”¨éƒ½ä¼šè°ƒç”¨â€œå¤±è´¥â€ï¼Œå¹¶è¿”å›EWOULDBLOCKé”™è¯¯ä»£ç ã€‚è¯´æ˜è¯·æ±‚çš„æ“ä½œåœ¨è°ƒç”¨æœŸé—´å†…æ²¡æœ‰æ—¶é—´å®Œæˆã€‚é€šå¸¸ï¼Œåº”ç”¨ç¨‹åºéœ€è¦é‡å¤è°ƒç”¨è¯¥å‡½æ•°ï¼Œç›´åˆ°è·å¾—æˆåŠŸè¿”å›ä»£ç ã€‚ éœ€è¦è¯´æ˜çš„æ˜¯å¹¶éæ‰€æœ‰çš„Sockets APIåœ¨éé˜»å¡æ¨¡å¼ä¸‹è°ƒç”¨ï¼Œéƒ½ä¼šè¿”å›EWOULDBLOCKé”™è¯¯ã€‚ä¾‹å¦‚ï¼Œä»¥éé˜»å¡æ¨¡å¼çš„å¥—æ¥å­—ä¸ºå‚æ•°è°ƒç”¨bind()å‡½æ•°æ—¶ï¼Œå°±ä¸ä¼šè¿”å›è¯¥é”™è¯¯ä»£ç ã€‚å› ä¸ºè¯¥å‡½æ•°æ˜¯åº”ç”¨ç¨‹åºç¬¬ä¸€è°ƒç”¨çš„å‡½æ•°ï¼Œå½“ç„¶ä¸ä¼šè¿”å›è¿™æ ·çš„é”™è¯¯ä»£ç ã€‚ ç”±äºä½¿ç”¨éé˜»å¡å¥—æ¥å­—åœ¨è°ƒç”¨å‡½æ•°æ—¶ï¼Œä¼šç»å¸¸è¿”å›EWOULDBLOCKé”™è¯¯ã€‚æ‰€ä»¥åœ¨ä»»ä½•æ—¶å€™ï¼Œéƒ½åº”ä»”ç»†æ£€æŸ¥è¿”å›ä»£ç å¹¶ä½œå¥½å¯¹â€œå¤±è´¥â€çš„å‡†å¤‡ã€‚åº”ç”¨ç¨‹åºè¿ç»­ä¸æ–­åœ°è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œç›´åˆ°å®ƒè¿”å›æˆåŠŸæŒ‡ç¤ºä¸ºæ­¢ã€‚ä¸Šé¢çš„ç¨‹åºæ¸…å•ä¸­ï¼Œåœ¨Whileå¾ªç¯ä½“å†…ä¸æ–­åœ°è°ƒç”¨recv()å‡½æ•°ï¼Œä»¥è¯»å…¥1024ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚è¿™ç§åšæ³•å¾ˆæµªè´¹ç³»ç»Ÿèµ„æºã€‚ è¦å®Œæˆè¿™æ ·çš„æ“ä½œï¼Œæœ‰äººä½¿ç”¨MSG_PEEKæ ‡å¿—è°ƒç”¨recv()å‡½æ•°æŸ¥çœ‹ç¼“å†²åŒºä¸­æ˜¯å¦æœ‰æ•°æ®å¯è¯»ã€‚åŒæ ·ï¼Œè¿™ç§æ–¹æ³•ä¹Ÿä¸å¥½ã€‚å› ä¸ºè¯¥åšæ³•å¯¹ç³»ç»Ÿé€ æˆçš„å¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºè‡³å°‘è¦è°ƒç”¨recv()å‡½æ•°ä¸¤æ¬¡ï¼Œæ‰èƒ½å®é™…åœ°è¯»å…¥æ•°æ®ã€‚è¾ƒå¥½çš„åšæ³•æ˜¯ï¼Œä½¿ç”¨å¥—æ¥å­—çš„â€œI/Oæ¨¡å‹â€æ¥åˆ¤æ–­éé˜»å¡å¥—æ¥å­—æ˜¯å¦å¯è¯»å¯å†™ã€‚ éé˜»å¡æ¨¡å¼å¥—æ¥å­—ä¸é˜»å¡æ¨¡å¼å¥—æ¥å­—ç›¸æ¯”ï¼Œä¸å®¹æ˜“ä½¿ç”¨ã€‚ä½¿ç”¨éé˜»å¡æ¨¡å¼å¥—æ¥å­—ï¼Œéœ€è¦ç¼–å†™æ›´å¤šçš„ä»£ç ï¼Œä»¥ä¾¿åœ¨æ¯ä¸ªSockets APIå‡½æ•°è°ƒç”¨ä¸­ï¼Œå¯¹æ”¶åˆ°çš„EWOULDBLOCKé”™è¯¯è¿›è¡Œå¤„ç†ã€‚å› æ­¤ï¼Œéé˜»å¡å¥—æ¥å­—ä¾¿æ˜¾å¾—æœ‰äº›éš¾äºä½¿ç”¨ã€‚ ä½†æ˜¯ï¼Œéé˜»å¡å¥—æ¥å­—åœ¨æ§åˆ¶å»ºç«‹çš„å¤šä¸ªè¿æ¥ï¼Œåœ¨æ•°æ®çš„æ”¶å‘é‡ä¸å‡ï¼Œæ—¶é—´ä¸å®šæ—¶ï¼Œæ˜æ˜¾å…·æœ‰ä¼˜åŠ¿ã€‚è¿™ç§å¥—æ¥å­—åœ¨ä½¿ç”¨ä¸Šå­˜åœ¨ä¸€å®šéš¾åº¦ï¼Œä½†åªè¦æ’é™¤äº†è¿™äº›å›°éš¾ï¼Œå®ƒåœ¨åŠŸèƒ½ä¸Šè¿˜æ˜¯éå¸¸å¼ºå¤§çš„ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯è€ƒè™‘ä½¿ç”¨å¥—æ¥å­—çš„â€œI/Oæ¨¡å‹â€ï¼Œå®ƒæœ‰åŠ©äºåº”ç”¨ç¨‹åºé€šè¿‡å¼‚æ­¥æ–¹å¼ï¼ŒåŒæ—¶å¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå¥—æ¥å­—çš„é€šä¿¡åŠ ä»¥ç®¡ç†ã€‚ IOå¤ç”¨æ¨¡å‹(é‡è¦)ï¼šç®€ä»‹ï¼šä¸»è¦æ˜¯selectå’Œepollï¼›å¯¹ä¸€ä¸ªIOç«¯å£ï¼Œä¸¤æ¬¡è°ƒç”¨ï¼Œä¸¤æ¬¡è¿”å›ï¼Œæ¯”é˜»å¡IOå¹¶æ²¡æœ‰ä»€ä¹ˆä¼˜è¶Šæ€§ï¼›å…³é”®æ˜¯èƒ½å®ç°åŒæ—¶å¯¹å¤šä¸ªIOç«¯å£è¿›è¡Œç›‘å¬. I/Oå¤ç”¨æ¨¡å‹ä¼šç”¨åˆ°selectã€pollã€epollå‡½æ•°ï¼Œè¿™å‡ ä¸ªå‡½æ•°ä¹Ÿä¼šä½¿è¿›ç¨‹é˜»å¡ï¼Œä½†æ˜¯å’Œé˜»å¡I/Oæ‰€ä¸åŒçš„çš„ï¼Œè¿™å‡ ä¸ªå‡½æ•°å¯ä»¥åŒæ—¶é˜»å¡å¤šä¸ªI/Oæ“ä½œã€‚è€Œä¸”å¯ä»¥åŒæ—¶å¯¹å¤šä¸ªè¯»æ“ä½œï¼Œå¤šä¸ªå†™æ“ä½œçš„I/Oå‡½æ•°è¿›è¡Œæ£€æµ‹ï¼Œç›´åˆ°æœ‰æ•°æ®å¯è¯»æˆ–å¯å†™æ—¶ï¼Œæ‰çœŸæ­£è°ƒç”¨I/Oæ“ä½œå‡½æ•°ã€‚ ä¿¡å·é©±åŠ¨IOæ¨¡å‹ï¼š ç®€ä»‹ï¼šä¸¤æ¬¡è°ƒç”¨ï¼Œä¸¤æ¬¡è¿”å›ï¼› é¦–å…ˆæˆ‘ä»¬å…è®¸å¥—æ¥å£è¿›è¡Œä¿¡å·é©±åŠ¨I/Oï¼Œå¹¶å®‰è£…ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œå¹¶ä¸é˜»å¡ã€‚å½“æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œè¿›ç¨‹ä¼šæ”¶åˆ°ä¸€ä¸ªSIGIOä¿¡å·ï¼Œå¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨I/Oæ“ä½œå‡½æ•°å¤„ç†æ•°æ®ã€‚ å¼‚æ­¥IOæ¨¡å‹ï¼š ç®€ä»‹ï¼šæ•°æ®æ‹·è´çš„æ—¶å€™è¿›ç¨‹æ— éœ€é˜»å¡ã€‚ å½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚å®é™…å¤„ç†è¿™ä¸ªè°ƒç”¨çš„éƒ¨ä»¶åœ¨å®Œæˆåï¼Œé€šè¿‡çŠ¶æ€ã€é€šçŸ¥å’Œå›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…çš„è¾“å…¥è¾“å‡ºæ“ä½œ é˜¶æ®µæ€§å°ç»“ åŒæ­¥IOå¼•èµ·è¿›ç¨‹é˜»å¡ï¼Œç›´è‡³IOæ“ä½œå®Œæˆã€‚å¼‚æ­¥IOä¸ä¼šå¼•èµ·è¿›ç¨‹é˜»å¡ã€‚IOå¤ç”¨æ˜¯å…ˆé€šè¿‡selectè°ƒç”¨é˜»å¡ã€‚ 5ä¸ªI/Oæ¨¡å‹çš„æ¯”è¾ƒï¼šselectã€pollã€epollåŒºåˆ«selectï¼š selectæœ¬è´¨ä¸Šæ˜¯é€šè¿‡è®¾ç½®æˆ–è€…æ£€æŸ¥å­˜æ”¾fdæ ‡å¿—ä½çš„æ•°æ®ç»“æ„æ¥è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ã€‚è¿™æ ·æ‰€å¸¦æ¥çš„ç¼ºç‚¹æ˜¯ï¼š 1ã€ å•ä¸ªè¿›ç¨‹å¯ç›‘è§†çš„fdæ•°é‡è¢«é™åˆ¶ï¼Œå³èƒ½ç›‘å¬ç«¯å£çš„å¤§å°æœ‰é™ã€‚ ä¸€èˆ¬æ¥è¯´è¿™ä¸ªæ•°ç›®å’Œç³»ç»Ÿå†…å­˜å…³ç³»å¾ˆå¤§ï¼Œå…·ä½“æ•°ç›®å¯ä»¥cat /proc/sys/fs/file-maxå¯Ÿçœ‹ã€‚32ä½æœºé»˜è®¤æ˜¯1024ä¸ªã€‚64ä½æœºé»˜è®¤æ˜¯2048.2ã€ å¯¹socketè¿›è¡Œæ‰«ææ—¶æ˜¯çº¿æ€§æ‰«æï¼Œå³é‡‡ç”¨è½®è¯¢çš„æ–¹æ³•ï¼Œæ•ˆç‡è¾ƒä½ï¼š å½“å¥—æ¥å­—æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œæ¯æ¬¡select()éƒ½è¦é€šè¿‡éå†FD_SETSIZEä¸ªSocketæ¥å®Œæˆè°ƒåº¦,ä¸ç®¡å“ªä¸ªSocketæ˜¯æ´»è·ƒçš„,éƒ½éå†ä¸€éã€‚è¿™ä¼šæµªè´¹å¾ˆå¤šCPUæ—¶é—´ã€‚å¦‚æœèƒ½ç»™å¥—æ¥å­—æ³¨å†ŒæŸä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ä»–ä»¬æ´»è·ƒæ—¶ï¼Œè‡ªåŠ¨å®Œæˆç›¸å…³æ“ä½œï¼Œé‚£å°±é¿å…äº†è½®è¯¢ï¼Œè¿™æ­£æ˜¯epollä¸kqueueåšçš„ã€‚3ã€éœ€è¦ç»´æŠ¤ä¸€ä¸ªç”¨æ¥å­˜æ”¾å¤§é‡fdçš„æ•°æ®ç»“æ„ï¼Œè¿™æ ·ä¼šä½¿å¾—ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åœ¨ä¼ é€’è¯¥ç»“æ„æ—¶å¤åˆ¶å¼€é”€å¤§ pollï¼š pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œå®ƒå°†ç”¨æˆ·ä¼ å…¥çš„æ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œç„¶åæŸ¥è¯¢æ¯ä¸ªfdå¯¹åº”çš„è®¾å¤‡çŠ¶æ€ï¼Œå¦‚æœè®¾å¤‡å°±ç»ªåˆ™åœ¨è®¾å¤‡ç­‰å¾…é˜Ÿåˆ—ä¸­åŠ å…¥ä¸€é¡¹å¹¶ç»§ç»­éå†ï¼Œå¦‚æœéå†å®Œæ‰€æœ‰fdåæ²¡æœ‰å‘ç°å°±ç»ªè®¾å¤‡ï¼Œåˆ™æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ°è®¾å¤‡å°±ç»ªæˆ–è€…ä¸»åŠ¨è¶…æ—¶ï¼Œè¢«å”¤é†’åå®ƒåˆè¦å†æ¬¡éå†fdã€‚è¿™ä¸ªè¿‡ç¨‹ç»å†äº†å¤šæ¬¡æ— è°“çš„éå†ã€‚ å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„ï¼Œä½†æ˜¯åŒæ ·æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼š 1ã€å¤§é‡çš„fdçš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´ï¼Œè€Œä¸ç®¡è¿™æ ·çš„å¤åˆ¶æ˜¯ä¸æ˜¯æœ‰æ„ä¹‰ã€‚ 2ã€pollè¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯â€œæ°´å¹³è§¦å‘â€ï¼Œå¦‚æœæŠ¥å‘Šäº†fdåï¼Œæ²¡æœ‰è¢«å¤„ç†ï¼Œé‚£ä¹ˆä¸‹æ¬¡pollæ—¶ä¼šå†æ¬¡æŠ¥å‘Šè¯¥fdã€‚ epoll: epollæ”¯æŒæ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ï¼Œæœ€å¤§çš„ç‰¹ç‚¹åœ¨äºè¾¹ç¼˜è§¦å‘ï¼Œå®ƒåªå‘Šè¯‰è¿›ç¨‹å“ªäº›fdåˆšåˆšå˜ä¸ºå°±ç»ªæ€ï¼Œå¹¶ä¸”åªä¼šé€šçŸ¥ä¸€æ¬¡ã€‚è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼Œepollä½¿ç”¨â€œäº‹ä»¶â€çš„å°±ç»ªé€šçŸ¥æ–¹å¼ï¼Œé€šè¿‡epoll_ctlæ³¨å†Œfdï¼Œä¸€æ—¦è¯¥fdå°±ç»ªï¼Œå†…æ ¸å°±ä¼šé‡‡ç”¨ç±»ä¼¼callbackçš„å›è°ƒæœºåˆ¶æ¥æ¿€æ´»è¯¥fdï¼Œepoll_waitä¾¿å¯ä»¥æ”¶åˆ°é€šçŸ¥ epollçš„ä¼˜ç‚¹ï¼š 1ã€æ²¡æœ‰æœ€å¤§å¹¶å‘è¿æ¥çš„é™åˆ¶ï¼Œèƒ½æ‰“å¼€çš„FDçš„ä¸Šé™è¿œå¤§äº1024ï¼ˆ1Gçš„å†…å­˜ä¸Šèƒ½ç›‘å¬çº¦10ä¸‡ä¸ªç«¯å£ï¼‰ï¼› 2ã€æ•ˆç‡æå‡ï¼Œä¸æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œä¸ä¼šéšç€FDæ•°ç›®çš„å¢åŠ æ•ˆç‡ä¸‹é™ã€‚åªæœ‰æ´»è·ƒå¯ç”¨çš„FDæ‰ä¼šè°ƒç”¨callbackå‡½æ•°ï¼› å³Epollæœ€å¤§çš„ä¼˜ç‚¹å°±åœ¨äºå®ƒåªç®¡ä½ â€œæ´»è·ƒâ€çš„è¿æ¥ï¼ˆå› ä¸ºæ”¯æŒè¾¹ç¼˜è§¦å‘ï¼‰ï¼Œè€Œè·Ÿè¿æ¥æ€»æ•°æ— å…³ï¼Œå› æ­¤åœ¨å®é™…çš„ç½‘ç»œç¯å¢ƒä¸­ï¼ŒEpollçš„æ•ˆç‡å°±ä¼šè¿œè¿œé«˜äºselectå’Œpollã€‚ 3ã€ å†…å­˜æ‹·è´ï¼Œåˆ©ç”¨mmap()æ–‡ä»¶æ˜ å°„å†…å­˜åŠ é€Ÿä¸å†…æ ¸ç©ºé—´çš„æ¶ˆæ¯ä¼ é€’ï¼›å³epollä½¿ç”¨mmapå‡å°‘å¤åˆ¶å¼€é”€ã€‚. 1ã€æ”¯æŒä¸€ä¸ªè¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•° select å•ä¸ªè¿›ç¨‹æ‰€èƒ½æ‰“å¼€çš„æœ€å¤§è¿æ¥æ•°æœ‰FD_SETSIZEå®å®šä¹‰ï¼Œå…¶å¤§å°æ˜¯32ä¸ªæ•´æ•°çš„å¤§å°ï¼ˆåœ¨32ä½çš„æœºå™¨ä¸Šï¼Œå¤§å°å°±æ˜¯3232ï¼ŒåŒç†64ä½æœºå™¨ä¸ŠFD_SETSIZEä¸º3264ï¼‰ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥å¯¹è¿›è¡Œä¿®æ”¹ï¼Œç„¶åé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œä½†æ˜¯æ€§èƒ½å¯èƒ½ä¼šå—åˆ°å½±å“ï¼Œè¿™éœ€è¦è¿›ä¸€æ­¥çš„æµ‹è¯•ã€‚ poll pollæœ¬è´¨ä¸Šå’Œselectæ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰æœ€å¤§è¿æ¥æ•°çš„é™åˆ¶ï¼ŒåŸå› æ˜¯å®ƒæ˜¯åŸºäºé“¾è¡¨æ¥å­˜å‚¨çš„ epoll è™½ç„¶è¿æ¥æ•°æœ‰ä¸Šé™ï¼Œä½†æ˜¯å¾ˆå¤§ï¼Œ1Gå†…å­˜çš„æœºå™¨ä¸Šå¯ä»¥æ‰“å¼€10ä¸‡å·¦å³çš„è¿æ¥ï¼Œ2Gå†…å­˜çš„æœºå™¨å¯ä»¥æ‰“å¼€20ä¸‡å·¦å³çš„è¿æ¥ 2.å‰§å¢åå¸¦æ¥çš„IOæ•ˆç‡é—®é¢˜ | select || å› ä¸ºæ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼šå¯¹è¿æ¥è¿›è¡Œçº¿æ€§éå†ï¼Œæ‰€ä»¥éšç€FDçš„å¢åŠ ä¼šé€ æˆéå†é€Ÿåº¦æ…¢çš„â€œçº¿æ€§ä¸‹é™æ€§èƒ½é—®é¢˜â€ã€‚ || â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“ || poll | åŒä¸Š || epoll | å› ä¸ºepollå†…æ ¸ä¸­å®ç°æ˜¯æ ¹æ®æ¯ä¸ªfdä¸Šçš„callbackå‡½æ•°æ¥å®ç°çš„ï¼Œåªæœ‰æ´»è·ƒçš„socketæ‰ä¼šä¸»åŠ¨è°ƒç”¨callbackï¼Œæ‰€ä»¥åœ¨æ´»è·ƒsocketè¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨epollæ²¡æœ‰å‰é¢ä¸¤è€…çš„çº¿æ€§ä¸‹é™çš„æ€§èƒ½é—®é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰socketéƒ½å¾ˆæ´»è·ƒçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šæœ‰æ€§èƒ½é—®é¢˜ã€‚ | 3.æ¶ˆæ¯ä¼ é€’æ–¹å¼ select å†…æ ¸éœ€è¦å°†æ¶ˆæ¯ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ï¼Œéƒ½éœ€è¦å†…æ ¸æ‹·è´åŠ¨ä½œ poll åŒä¸Š epoll é€šè¿‡å†…æ ¸å’Œç”¨æˆ·ç©ºé—´å…±äº«ä¸€å—å†…å­˜æ¥å®ç°çš„","categories":[{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C/"}],"tags":[{"name":"ç½‘ç»œï¼Œå¼‚æ­¥","slug":"ç½‘ç»œï¼Œå¼‚æ­¥","permalink":"http://blog.crazylaw.cn/tags/%E7%BD%91%E7%BB%9C%EF%BC%8C%E5%BC%82%E6%AD%A5/"}]},{"title":"ã€Nginxã€‘- è´Ÿè½½å‡è¡¡","slug":"nginx-load-balan","date":"2018-02-23T03:22:00.000Z","updated":"2021-03-20T16:25:01.811Z","comments":true,"path":"2018/02/23/nginx-load-balan/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/23/nginx-load-balan/","excerpt":"è¯´æ˜åœ¨ç°åœ¨äº’è”ç½‘çˆ†å‘çš„æ—¶ä»£ï¼Œç¨³å®šæ€§æˆä¸ºæ¯ä¸ªé¡¹ç›®çš„é¦–é€‰ï¼Œå†æ¬¡æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬å°±è¦å®ç°é«˜å¯ç”¨çš„æ¦‚å¿µï¼Œå®ç°é«˜å¯ç”¨çš„æœ€å¸¸ç”¨çš„ä¸€ç§æ‰‹æ®µå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåˆ†æ‘Šå„ä¸ªæœåŠ¡å™¨çš„è¯·æ±‚å‹åŠ›ã€‚ 1.è½®è®­ï¼ˆé»˜è®¤ï¼‰æŒ‰ç…§è¯·æ±‚æ—¶é—´çš„å¾ªåºï¼ŒæŠŠè¯·æ±‚é€ä¸€åˆ†é…åˆ°å¯¹åº”çš„æœåŠ¡å™¨ã€‚å¦‚æœå…¶ä¸­ä¸€å°æœåŠ¡å™¨ down äº†ï¼Œnginx ä¼šè‡ªåŠ¨å‰”é™¤ down æ‰çš„æœåŠ¡å™¨ã€‚ 1234upstream backserver &#123; server 192.168.0.14; server 192.168.0.15;&#125; 2.æƒé‡(weight)å…¶å®å°±æ˜¯è½®è®­çš„å‡çº§ç‰ˆï¼Œç»™ç‰¹å®šçš„æœåŠ¡å™¨ä¸€ä¸ªæŒ‡å®šçš„æƒé‡ï¼Œnginx ä¼šæ ¹æ®æƒé‡åˆ†é…è¯·æ±‚è®¿é—®ã€‚ä¸€èˆ¬ç”¨äºæœåŠ¡å™¨æ€§èƒ½ä¸ä¸€è‡´çš„æƒ…å†µä¸‹ã€‚ 1234upstream backserver &#123; server 192.168.0.14 weight&#x3D;3; server 192.168.0.15 weight&#x3D;7;&#125;","text":"è¯´æ˜åœ¨ç°åœ¨äº’è”ç½‘çˆ†å‘çš„æ—¶ä»£ï¼Œç¨³å®šæ€§æˆä¸ºæ¯ä¸ªé¡¹ç›®çš„é¦–é€‰ï¼Œå†æ¬¡æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬å°±è¦å®ç°é«˜å¯ç”¨çš„æ¦‚å¿µï¼Œå®ç°é«˜å¯ç”¨çš„æœ€å¸¸ç”¨çš„ä¸€ç§æ‰‹æ®µå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œåˆ†æ‘Šå„ä¸ªæœåŠ¡å™¨çš„è¯·æ±‚å‹åŠ›ã€‚ 1.è½®è®­ï¼ˆé»˜è®¤ï¼‰æŒ‰ç…§è¯·æ±‚æ—¶é—´çš„å¾ªåºï¼ŒæŠŠè¯·æ±‚é€ä¸€åˆ†é…åˆ°å¯¹åº”çš„æœåŠ¡å™¨ã€‚å¦‚æœå…¶ä¸­ä¸€å°æœåŠ¡å™¨ down äº†ï¼Œnginx ä¼šè‡ªåŠ¨å‰”é™¤ down æ‰çš„æœåŠ¡å™¨ã€‚ 1234upstream backserver &#123; server 192.168.0.14; server 192.168.0.15;&#125; 2.æƒé‡(weight)å…¶å®å°±æ˜¯è½®è®­çš„å‡çº§ç‰ˆï¼Œç»™ç‰¹å®šçš„æœåŠ¡å™¨ä¸€ä¸ªæŒ‡å®šçš„æƒé‡ï¼Œnginx ä¼šæ ¹æ®æƒé‡åˆ†é…è¯·æ±‚è®¿é—®ã€‚ä¸€èˆ¬ç”¨äºæœåŠ¡å™¨æ€§èƒ½ä¸ä¸€è‡´çš„æƒ…å†µä¸‹ã€‚ 1234upstream backserver &#123; server 192.168.0.14 weight&#x3D;3; server 192.168.0.15 weight&#x3D;7;&#125; æƒé‡è¶Šé«˜ï¼Œè®¿é—®çš„æ¦‚ç‡è¶Šå¤§ï¼Œåˆ†åˆ«æ˜¯ 30%,70%ã€‚ 3. IP å“ˆå¸ŒåŒ–ï¼ˆip_hashï¼‰é€šè¿‡ ip å“ˆå¸ŒåŒ–ï¼Œå¯ä»¥è®©åŒä¸€ ip çš„è¯·æ±‚åˆ†é…åˆ°åŒä¸€å°æœºå™¨ä¸Šã€‚ 12345upstream backserver &#123; ip_hash; server 192.168.0.14:88; server 192.168.0.15:80;&#125; è¿™ä¸ªåšæ³•çš„å¥½å¤„æ˜¯å¯ä»¥ä¿è¯åœ¨è´Ÿè½½å‡è¡¡çš„æƒ…å†µä¸‹ï¼Œç”¨æˆ·çš„ session ä¿¡æ¯éƒ½ä¿å­˜åœ¨ä¸€å°æœºå™¨ä¸Šï¼Œä¸ä¼šå› ä¸ºè´Ÿè½½å‡è¡¡å¯¼è‡´ç”¨æˆ· session ä¿¡æ¯ä¸¢å¤±ã€‚ 4. fairï¼ˆfair æ¨¡å—ï¼Œéœ€è¦ä¸º nginx å®‰è£…æ‰©å±•ï¼‰æŒ‰åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…ã€‚ 12345upstream backserver &#123; server server1; server server2; fair;&#125; è¿™ç§æ–¹å¼æœ‰ç‚¹ç±»ä¼¼äº epoll æ–¹å¼ã€‚ ç‰¹åˆ«è¯´æ˜1234567server 127.0.0.1:9090 down; (down è¡¨ç¤ºå•å‰çš„serveræš‚æ—¶ä¸å‚ä¸è´Ÿè½½)server 127.0.0.1:8080 weight&#x3D;2; (weight é»˜è®¤ä¸º1.weightè¶Šå¤§ï¼Œè´Ÿè½½çš„æƒé‡å°±è¶Šå¤§)server 127.0.0.1:6060;server 127.0.0.1:7070 backup; (å…¶å®ƒæ‰€æœ‰çš„ébackupæœºå™¨downæˆ–è€…å¿™çš„æ—¶å€™ï¼Œè¯·æ±‚backupæœºå™¨)","categories":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/categories/Nginx/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"}]},{"title":"ã€nginxã€‘- å¸¸ç”¨é…ç½®ä¾‹å­","slug":"nginx-example","date":"2018-02-23T02:53:30.000Z","updated":"2021-03-20T16:25:01.811Z","comments":true,"path":"2018/02/23/nginx-example/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/23/nginx-example/","excerpt":"è¯´æ˜ä»¥ä¸‹æ•´ç†ä¸€ä¸‹ä¸€äº› nginx å¸¸ç”¨ä¾‹å­ã€‚ ä¾‹å­ ç›®å½•å¯¹æ¢ 123&#x2F;123456&#x2F;xxxx -&gt; &#x2F;xxxx?id&#x3D;123456rewrite ^&#x2F;(\\d+)&#x2F;(.+)&#x2F; &#x2F;$2?id&#x3D;$1 last; ä¾‹å¦‚ä¸‹é¢è®¾å®š nginx åœ¨ç”¨æˆ·ä½¿ç”¨ ie çš„ä½¿ç”¨é‡å®šå‘åˆ°/nginx-ie ç›®å½•ä¸‹ï¼š 123if ($http_user_agent ~ MSIE) &#123; rewrite ^(.*)$ &#x2F;nginx-ie&#x2F;$1 break;&#125;","text":"è¯´æ˜ä»¥ä¸‹æ•´ç†ä¸€ä¸‹ä¸€äº› nginx å¸¸ç”¨ä¾‹å­ã€‚ ä¾‹å­ ç›®å½•å¯¹æ¢ 123&#x2F;123456&#x2F;xxxx -&gt; &#x2F;xxxx?id&#x3D;123456rewrite ^&#x2F;(\\d+)&#x2F;(.+)&#x2F; &#x2F;$2?id&#x3D;$1 last; ä¾‹å¦‚ä¸‹é¢è®¾å®š nginx åœ¨ç”¨æˆ·ä½¿ç”¨ ie çš„ä½¿ç”¨é‡å®šå‘åˆ°/nginx-ie ç›®å½•ä¸‹ï¼š 123if ($http_user_agent ~ MSIE) &#123; rewrite ^(.*)$ &#x2F;nginx-ie&#x2F;$1 break;&#125; ç›®å½•è‡ªåŠ¨åŠ â€œ/â€ 123if (-d $request_filename)&#123; rewrite ^&#x2F;(.*)([^&#x2F;])$ http:&#x2F;&#x2F;$host&#x2F;$1$2&#x2F; permanent; &#125; ç¦æ­¢ htaccess 123location ~&#x2F;\\.ht &#123; deny all;&#125; ç¦æ­¢å¤šä¸ªç›®å½• 1234location ~ ^&#x2F;(cron|templates)&#x2F; &#123; deny all; break;&#125; åªå……è®¸å›ºå®š ip è®¿é—®ç½‘ç«™ï¼Œå¹¶åŠ ä¸Šå¯†ç  1234567root &#x2F;opt&#x2F;htdocs&#x2F;www;allow 208.97.167.194;allow 222.33.1.2;allow 231.152.49.4;deny all;auth_basic â€œC1G_ADMINâ€;auth_basic_user_file htpasswd; æ–‡ä»¶å’Œç›®å½•ä¸å­˜åœ¨çš„æ—¶å€™é‡å®šå‘ï¼š 123if (!-e $request_filename) &#123; proxy_pass http:&#x2F;&#x2F;127.0.0.1;&#125; å¤šåŸŸåè½¬å‘ 123456server_name www.test.com&#x2F; www.test2.com&#x2F;;index index.html index.htm index.php;root &#x2F;opt&#x2F;ccinn&#x2F;;if ($host ~ â€œtest3\\.cnâ€) &#123; rewrite ^(.*) http:&#x2F;&#x2F;www.test.com$1&#x2F; permanent;&#125;","categories":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/categories/Nginx/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"}]},{"title":"ã€Nginxã€‘ - å˜é‡","slug":"nginx-var","date":"2018-02-23T02:26:00.000Z","updated":"2021-03-20T16:25:01.811Z","comments":true,"path":"2018/02/23/nginx-var/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/23/nginx-var/","excerpt":"è¯´æ˜Nginxé…ç½®æ–‡ä»¶ç®¡ç†è€…æ•´ä¸ªnginxæœåŠ¡çš„è¿ä½œï¼Œæœ‰ä¸€äº›é€»è¾‘æˆ‘ä»¬å¯ä»¥é€šè¿‡nginxå†…ç½®å˜é‡æˆ–è€…è‡ªå®šä¹‰å˜é‡æ¥é€‰æ‹©æ€§é…ç½®ã€‚ å†…ç½®å¸¸è§å˜é‡å‚è§ä¸‹è¡¨ï¼š åç§° è¯´æ˜ $arg_name è¯·æ±‚ä¸­çš„nameå‚æ•° $args è¯·æ±‚ä¸­çš„å‚æ•° $content_length HTTPè¯·æ±‚é‡Œé¢çš„â€Content-Lengthâ€ $content_type HTTPè¯·æ±‚é‡Œé¢çš„â€Content-Typeâ€ $document_root é…ç½®é‡Œé¢è®¾ç½®çš„ root èµ‹å€¼ $host è¯·æ±‚ä¿¡æ¯ç§çš„â€HOSTâ€,å¦‚æœè¯·æ±‚å¤´ä¸å­˜åœ¨Hostçš„è¯ï¼Œé‚£ä¹ˆä¹…ç­‰äºserver_name èµ‹å€¼ $http_cookie cookieä¿¡æ¯ $http_referer å¼•ç”¨åœ°å€ï¼Œå°±æ˜¯å‰ä¸€ä¸ªé“¾æ¥åœ°å€ $http_user_agent å®¢æˆ·ç«¯ä»£ç†ä¿¡æ¯ $is_args å¦‚æœè¯·æ±‚è¡Œå¸¦æœ‰å‚æ•°ï¼Œè¿”å›â€œï¼Ÿâ€ï¼Œå¦åˆ™è¿”å›ç©ºå­—ç¬¦ä¸² $limit_rate å½“å‰è¿æ¥é€Ÿç‡çš„é™åˆ¶ $pid nginxå½“å‰workerè¿›ç¨‹çš„PID $query_string ä¸$argsåŸºæœ¬ä¸€è‡´ $remote_addr å®¢æˆ·ç«¯IPåœ°å€ $remote_port å®¢æˆ·ç«¯ç«¯å£å· $scheme å½“å‰æ‰€ç”¨çš„åè®®ï¼Œæ¯”å¦‚httpæˆ–è€…https $request_method è¯·æ±‚æ–¹æ³•ï¼Œæ¯”å¦‚â€œGETâ€ï¼Œâ€œPOSTâ€ç­‰ $request_uri è¯·æ±‚çš„URIï¼Œå¸¦å‚æ•°ï¼Œæ¯”å¦‚ï¼šhttp://localhost:8080/uuu","text":"è¯´æ˜Nginxé…ç½®æ–‡ä»¶ç®¡ç†è€…æ•´ä¸ªnginxæœåŠ¡çš„è¿ä½œï¼Œæœ‰ä¸€äº›é€»è¾‘æˆ‘ä»¬å¯ä»¥é€šè¿‡nginxå†…ç½®å˜é‡æˆ–è€…è‡ªå®šä¹‰å˜é‡æ¥é€‰æ‹©æ€§é…ç½®ã€‚ å†…ç½®å¸¸è§å˜é‡å‚è§ä¸‹è¡¨ï¼š åç§° è¯´æ˜ $arg_name è¯·æ±‚ä¸­çš„nameå‚æ•° $args è¯·æ±‚ä¸­çš„å‚æ•° $content_length HTTPè¯·æ±‚é‡Œé¢çš„â€Content-Lengthâ€ $content_type HTTPè¯·æ±‚é‡Œé¢çš„â€Content-Typeâ€ $document_root é…ç½®é‡Œé¢è®¾ç½®çš„ root èµ‹å€¼ $host è¯·æ±‚ä¿¡æ¯ç§çš„â€HOSTâ€,å¦‚æœè¯·æ±‚å¤´ä¸å­˜åœ¨Hostçš„è¯ï¼Œé‚£ä¹ˆä¹…ç­‰äºserver_name èµ‹å€¼ $http_cookie cookieä¿¡æ¯ $http_referer å¼•ç”¨åœ°å€ï¼Œå°±æ˜¯å‰ä¸€ä¸ªé“¾æ¥åœ°å€ $http_user_agent å®¢æˆ·ç«¯ä»£ç†ä¿¡æ¯ $is_args å¦‚æœè¯·æ±‚è¡Œå¸¦æœ‰å‚æ•°ï¼Œè¿”å›â€œï¼Ÿâ€ï¼Œå¦åˆ™è¿”å›ç©ºå­—ç¬¦ä¸² $limit_rate å½“å‰è¿æ¥é€Ÿç‡çš„é™åˆ¶ $pid nginxå½“å‰workerè¿›ç¨‹çš„PID $query_string ä¸$argsåŸºæœ¬ä¸€è‡´ $remote_addr å®¢æˆ·ç«¯IPåœ°å€ $remote_port å®¢æˆ·ç«¯ç«¯å£å· $scheme å½“å‰æ‰€ç”¨çš„åè®®ï¼Œæ¯”å¦‚httpæˆ–è€…https $request_method è¯·æ±‚æ–¹æ³•ï¼Œæ¯”å¦‚â€œGETâ€ï¼Œâ€œPOSTâ€ç­‰ $request_uri è¯·æ±‚çš„URIï¼Œå¸¦å‚æ•°ï¼Œæ¯”å¦‚ï¼šhttp://localhost:8080/uuu è‡ªå®šä¹‰å˜é‡å¯ä»¥ä½¿ç”¨setå…³é”®å­—æ¥è®¾ç½®ï¼Œä¾‹å¦‚ set $name caiwh åœ¨å¯¹åº”çš„ç»“æ„ä½“ä¹‹å†…å°±ç”¨$nameæ¥ä»£è¡¨caiwhäº†","categories":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/categories/Nginx/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"}]},{"title":"ã€Nginxã€‘- RewriteåŠŸèƒ½","slug":"nginx-rewrite","date":"2018-02-23T01:57:00.000Z","updated":"2021-03-20T16:25:01.811Z","comments":true,"path":"2018/02/23/nginx-rewrite/","link":"","permalink":"http://blog.crazylaw.cn/2018/02/23/nginx-rewrite/","excerpt":"è¯´æ˜Nginx ä½œä¸ºä¸€ä¸ª http æœåŠ¡å™¨ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ rewrite åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½ç®—æ˜¯ nginx å¿…ä¼šå†…å®¹äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¯¦ç»†è¯´æ˜ä¸€ä¸‹ URL é‡å†™é…ç½®ä»¥åŠä¿¡æ¯è¯¦è§£ Nginx-rewrite ä¾èµ– PCRE è½¯ä»¶çš„æ”¯æŒï¼Œæ”¯æŒ perl å…¼å®¹æ­£åˆ™è¡¨è¾¾å¼è¯­å¥è¿›è¡Œè§„åˆ™åŒ¹é… rewrite æ˜¯å®ç° URL é‡å†™çš„å…³é”®æŒ‡ä»¤ï¼Œæ ¹æ® regexï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰éƒ¨åˆ†å†…å®¹ï¼Œé‡å®šå‘åˆ° replacementï¼Œç»“å°¾æ˜¯ flag æ ‡è®°ã€‚ è¯­æ³•123rewrite &lt;regex&gt; &lt;replacement&gt; [flag]å…³é”®å­— æ­£åˆ™è¡¨è¾¾å¼ æ›¿æ¢å†…å®¹ flagæ ‡è®° å…³é”®å­—ï¼šå›ºå®š rewrite å¼€å¯çš„å…³é”®å­— æ­£åˆ™ï¼šperl å…¼å®¹æ­£åˆ™è¡¨è¾¾å¼è¯­å¥è¿›è¡Œè§„åˆ™åŒ¹é… æ›¿ä»£å†…å®¹ï¼šå°†æ­£åˆ™åŒ¹é…çš„å†…å®¹æ›¿æ¢æˆ replacement flag æ ‡è®°ï¼šrewrite æ”¯æŒçš„ flag æ ‡è®°","text":"è¯´æ˜Nginx ä½œä¸ºä¸€ä¸ª http æœåŠ¡å™¨ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ rewrite åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½ç®—æ˜¯ nginx å¿…ä¼šå†…å®¹äº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¯¦ç»†è¯´æ˜ä¸€ä¸‹ URL é‡å†™é…ç½®ä»¥åŠä¿¡æ¯è¯¦è§£ Nginx-rewrite ä¾èµ– PCRE è½¯ä»¶çš„æ”¯æŒï¼Œæ”¯æŒ perl å…¼å®¹æ­£åˆ™è¡¨è¾¾å¼è¯­å¥è¿›è¡Œè§„åˆ™åŒ¹é… rewrite æ˜¯å®ç° URL é‡å†™çš„å…³é”®æŒ‡ä»¤ï¼Œæ ¹æ® regexï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰éƒ¨åˆ†å†…å®¹ï¼Œé‡å®šå‘åˆ° replacementï¼Œç»“å°¾æ˜¯ flag æ ‡è®°ã€‚ è¯­æ³•123rewrite &lt;regex&gt; &lt;replacement&gt; [flag]å…³é”®å­— æ­£åˆ™è¡¨è¾¾å¼ æ›¿æ¢å†…å®¹ flagæ ‡è®° å…³é”®å­—ï¼šå›ºå®š rewrite å¼€å¯çš„å…³é”®å­— æ­£åˆ™ï¼šperl å…¼å®¹æ­£åˆ™è¡¨è¾¾å¼è¯­å¥è¿›è¡Œè§„åˆ™åŒ¹é… æ›¿ä»£å†…å®¹ï¼šå°†æ­£åˆ™åŒ¹é…çš„å†…å®¹æ›¿æ¢æˆ replacement flag æ ‡è®°ï¼šrewrite æ”¯æŒçš„ flag æ ‡è®° flag æ ‡è®°è¯´æ˜ï¼š last æœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆåï¼Œç»§ç»­å‘ä¸‹åŒ¹é…æ–°çš„ location URI è§„åˆ™ break æœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆå³ç»ˆæ­¢ï¼Œä¸å†åŒ¹é…åé¢çš„ä»»ä½•è§„åˆ™ redirect è¿”å› 302 ä¸´æ—¶é‡å®šå‘ï¼Œæµè§ˆå™¨åœ°å€ä¼šæ˜¾ç¤ºè·³è½¬åçš„ URL åœ°å€ permanent è¿”å› 301 æ°¸ä¹…é‡å®šå‘ï¼Œæµè§ˆå™¨åœ°å€ä¼šæ˜¾ç¤ºè·³è½¬åçš„ URL åœ°å€ ä¾‹å­rewrite ^/(.*) http://usblog.crazylaw.cn/$1 permanent; è¿™ä¸ªä¾‹å­ï¼Œæ— è®ºè¯´æ˜è¯·æ±‚è¿‡æ¥ï¼Œéƒ½ä¼šæ°¸ä¹…é‡å®šå‘åˆ°http://usblog.crazylaw.cn/$1ä¸Šï¼Œè¿”å›çŠ¶æ€å— 301 å…·ä½“ä¾‹å­:å½“å…·ä½“çš„ url è¯·æ±‚:https://nginx.crazylaw.cn/index.php/archives/333/è¢« nginx-rewirte ä¹‹å,é“¾æ¥å˜æˆå¦‚ä¸‹https://usblog.crazylaw.cn/index.php/archives/333/ locationå¦å¤–æœ‰ä¸€äº›locationå…³é”®å­—ï¼Œéœ€è¦ç”¨åˆ°ä»¥ä¸‹ç‰¹æ®Šç¬¦å·ï¼š ~ &lt;rule&gt; ä¸ºåŒºåˆ†å¤§å°å†™åŒ¹é… ~* &lt;rule&gt; ä¸ºä¸åŒºåˆ†å¤§å°å†™åŒ¹é… !~ &lt;rule&gt; å’Œ !~* &lt;rule&gt; åˆ†åˆ«æ˜¯åŒºåˆ†å¤§å°å†™ä¸åŒ¹é…ä»¥åŠä¸åŒºåˆ†å¤§å°å†™ä¸åŒ¹é… é€»è¾‘åˆ¤æ–­ä¸“ç”¨ç¬¦å· -f &lt;file&gt; å’Œ !-f &lt;file&gt; åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶ -d &lt;dir&gt; å’Œ !-d &lt;dir&gt; åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›®å½• -e &lt;file|[dir]&gt; å’Œ !-e &lt;file|[dir]&gt; åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ–‡ä»¶æˆ–è€…ç›®å½• !x å’Œ !-x åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯ä»¥æ‰§è¡Œ Proxy_passè¯¥å…³é”®å­—å’Œrewriteè¦åšä¸€ç‚¹åŒºåˆ«ï¼Œproxy_passç”¨äºåå‘ä»£ç†ï¼Œé¡¾åæ€ä¹‰ï¼Œå’Œé‡å®šå‘ä¸åŒï¼Œproxy_passå¹¶ä¸ä¼šæ”¹å˜æµè§ˆå™¨çš„ urlï¼Œæ•´ä¸ªå…³é”®å­—æ˜¯ç”¨äºå†…éƒ¨æœåŠ¡å™¨è¯·æ±‚è½¬å‘çš„ã€‚ ç‰¹ç‚¹å¯ä»¥å½’çº³å¦‚ä¸‹ï¼š ä¸å½±å“æµè§ˆå™¨åœ°å€æ çš„ url è®¾ç½®è¢«ä»£ç† server çš„åè®®å’Œåœ°å€ï¼ŒURI å¯é€‰ï¼ˆå¯ä»¥æœ‰ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ï¼‰ åè®®å¯ä»¥ä¸º http æˆ– https åœ°å€å¯ä»¥ä¸ºåŸŸåæˆ–è€… IPï¼Œç«¯å£å¯é€‰ï¼›egï¼šproxy_pass http://localhost:8000/uri/; å¦‚æœä¸€ä¸ªåŸŸåå¯ä»¥è§£æåˆ°å¤šä¸ªåœ°å€ï¼Œé‚£ä¹ˆè¿™äº›åœ°å€ä¼šè¢«è½®æµä½¿ç”¨ï¼Œæ­¤å¤–ï¼Œè¿˜å¯ä»¥æŠŠä¸€ä¸ªåœ°å€æŒ‡å®šä¸º server groupï¼ˆå¦‚ï¼šnginx çš„ upstreamï¼‰, eg: 1234567891011121314upstream backend &#123; server backend1.example.com weight=5; server backend2.example.com:8080; server unix:/tmp/backend3; server backup1.example.com:8080 backup; server backup2.example.com:8080 backup;&#125;server &#123; location / &#123; proxy_pass http://backend; &#125;&#125; å¦‚æœ proxy_pass çš„ URL å®šå‘é‡ŒåŒ…æ‹¬ URIï¼Œé‚£ä¹ˆè¯·æ±‚ä¸­åŒ¹é…åˆ° location ä¸­ URI çš„éƒ¨åˆ†ä¼šè¢« proxy_pass åé¢ URL ä¸­çš„ URI æ›¿æ¢ï¼Œegï¼š 12345location &#x2F;name&#x2F; &#123; proxy_pass http:&#x2F;&#x2F;127.0.0.1&#x2F;remote&#x2F;;&#125;è¯·æ±‚http:&#x2F;&#x2F;127.0.0.1&#x2F;name&#x2F;test.html ä¼šè¢«ä»£ç†åˆ°http:&#x2F;&#x2F;example.com&#x2F;remote&#x2F;test.htm å¦‚æœ proxy_pass çš„ URL å®šå‘é‡Œä¸åŒ…æ‹¬ URIï¼Œé‚£ä¹ˆè¯·æ±‚ä¸­çš„ URI ä¼šä¿æŒåŸæ ·ä¼ é€ç»™åç«¯ serverï¼Œegï¼š 12345location &#x2F;name&#x2F; &#123; proxy_pass http:&#x2F;&#x2F;127.0.0.1;&#125;è¯·æ±‚http:&#x2F;&#x2F;127.0.0.1&#x2F;name&#x2F;test.html ä¼šè¢«ä»£ç†åˆ°http:&#x2F;&#x2F;127.0.0.1&#x2F;name&#x2F;test.html","categories":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/categories/Nginx/"}],"tags":[{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"}]},{"title":"MM|DMM-ä¸­æ–‡å…¨æ–‡æœç´¢å¼•æ“","slug":"fulltext-mm-dmm","date":"2018-01-23T09:20:49.000Z","updated":"2021-03-20T16:25:01.805Z","comments":true,"path":"2018/01/23/fulltext-mm-dmm/","link":"","permalink":"http://blog.crazylaw.cn/2018/01/23/fulltext-mm-dmm/","excerpt":"å‰è¨€ä»€ä¹ˆæ˜¯ä¸­æ–‡åˆ†è¯ ä¼—æ‰€å‘¨çŸ¥ï¼Œè‹±æ–‡æ˜¯ä»¥ è¯ä¸ºå•ä½çš„ï¼Œè¯å’Œè¯ä¹‹é—´æ˜¯é ç©ºæ ¼éš”å¼€ï¼Œè€Œä¸­æ–‡æ˜¯ä»¥å­—ä¸ºå•ä½ï¼Œå¥å­ä¸­æ‰€æœ‰çš„å­—è¿èµ·æ¥æ‰èƒ½æè¿°ä¸€ä¸ªæ„æ€ã€‚ä¾‹å¦‚ï¼Œè‹±æ–‡å¥å­ I am a studentï¼Œç”¨ä¸­æ–‡åˆ™ä¸ºï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªå­¦ç”Ÿâ€ã€‚è®¡ç®—æœºå¯ä»¥å¾ˆç®€å•é€šè¿‡ç©ºæ ¼çŸ¥é“ student æ˜¯ä¸€ä¸ªå•è¯ï¼Œä½†æ˜¯ä¸èƒ½å¾ˆå®¹æ˜“æ˜ç™½â€œå­¦â€ã€â€œç”Ÿâ€ä¸¤ä¸ªå­—åˆèµ·æ¥ æ‰è¡¨ç¤ºä¸€ä¸ªè¯ã€‚æŠŠä¸­æ–‡çš„æ±‰å­—åºåˆ—åˆ‡åˆ†æˆæœ‰æ„ä¹‰çš„è¯ï¼Œå°±æ˜¯ä¸­æ–‡åˆ†è¯ï¼Œæœ‰äº›äººä¹Ÿç§°ä¸ºåˆ‡è¯ã€‚æˆ‘æ˜¯ä¸€ä¸ªå­¦ç”Ÿï¼Œåˆ†è¯çš„ç»“æœæ˜¯ï¼šæˆ‘ æ˜¯ ä¸€ä¸ª å­¦ç”Ÿã€‚ çŸ¥è¯†è¡¥å……æœ€å°åŒ¹é…ç®—æ³•","text":"å‰è¨€ä»€ä¹ˆæ˜¯ä¸­æ–‡åˆ†è¯ ä¼—æ‰€å‘¨çŸ¥ï¼Œè‹±æ–‡æ˜¯ä»¥ è¯ä¸ºå•ä½çš„ï¼Œè¯å’Œè¯ä¹‹é—´æ˜¯é ç©ºæ ¼éš”å¼€ï¼Œè€Œä¸­æ–‡æ˜¯ä»¥å­—ä¸ºå•ä½ï¼Œå¥å­ä¸­æ‰€æœ‰çš„å­—è¿èµ·æ¥æ‰èƒ½æè¿°ä¸€ä¸ªæ„æ€ã€‚ä¾‹å¦‚ï¼Œè‹±æ–‡å¥å­ I am a studentï¼Œç”¨ä¸­æ–‡åˆ™ä¸ºï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªå­¦ç”Ÿâ€ã€‚è®¡ç®—æœºå¯ä»¥å¾ˆç®€å•é€šè¿‡ç©ºæ ¼çŸ¥é“ student æ˜¯ä¸€ä¸ªå•è¯ï¼Œä½†æ˜¯ä¸èƒ½å¾ˆå®¹æ˜“æ˜ç™½â€œå­¦â€ã€â€œç”Ÿâ€ä¸¤ä¸ªå­—åˆèµ·æ¥ æ‰è¡¨ç¤ºä¸€ä¸ªè¯ã€‚æŠŠä¸­æ–‡çš„æ±‰å­—åºåˆ—åˆ‡åˆ†æˆæœ‰æ„ä¹‰çš„è¯ï¼Œå°±æ˜¯ä¸­æ–‡åˆ†è¯ï¼Œæœ‰äº›äººä¹Ÿç§°ä¸ºåˆ‡è¯ã€‚æˆ‘æ˜¯ä¸€ä¸ªå­¦ç”Ÿï¼Œåˆ†è¯çš„ç»“æœæ˜¯ï¼šæˆ‘ æ˜¯ ä¸€ä¸ª å­¦ç”Ÿã€‚ çŸ¥è¯†è¡¥å……æœ€å°åŒ¹é…ç®—æ³• åœ¨æ‰€æœ‰çš„åˆ†è¯ç®—æ³•ä¸­ï¼Œæœ€æ—©ç ”ç©¶çš„æ˜¯æœ€å°åŒ¹é…ç®—æ³•(Minimum Matching)ï¼Œè¯¥ç®—æ³•ä»å¾…æ¯”è¾ƒå­—ç¬¦ä¸²å·¦è¾¹å¼€å§‹æ¯”è¾ƒï¼Œå…ˆå–å‰ä¸¤ä¸ªå­—ç¬¦ç»„æˆçš„å­—æ®µä¸è¯å…¸ä¸­çš„è¯è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœè¯å…¸ä¸­æœ‰è¯¥è¯ï¼Œåˆ™åˆ†å‡ºæ­¤è¯ï¼Œç»§ç»­ä»ç¬¬ä¸‰ä¸ªå­— ç¬¦å¼€å§‹å–ä¸¤ä¸ªå­—ç¬¦ç»„æˆçš„å­—æ®µè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œåˆ™å–å‰ 3 ä¸ªå­—ç¬¦ä¸²ç»„æˆçš„å­—æ®µè¿›è¡Œæ¯”è¾ƒï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°å–çš„å­—ç¬¦ä¸²çš„é•¿åº¦ç­‰äºé¢„å…ˆè®¾å®šçš„é˜ˆå€¼ï¼Œå¦‚æœè¿˜ æ²¡æœ‰åŒ¹é…æˆåŠŸï¼Œåˆ™ä»å¾…å¤„ç†å­—ä¸²çš„ç¬¬äºŒä¸ªå­—ç¬¦å¼€å§‹æ¯”è¾ƒï¼Œå¦‚æ­¤å¾ªç¯ã€‚ ä¾‹å¦‚ï¼Œâ€œå¦‚æœè¿˜æ²¡æœ‰åŒ¹é…æˆåŠŸâ€ï¼Œå–å‡ºå·¦è¾¹ä¸¤ä¸ªå­— ç»„æˆçš„å­—æ®µä¸è¯å…¸è¿›è¡Œæ¯”è¾ƒï¼Œåˆ†å‡ºâ€œå¦‚æœâ€ï¼›å†ä»â€œè¿˜â€å¼€å§‹ï¼Œå–â€œè¿˜æ²¡â€ï¼Œå­—å…¸ä¸­æ²¡æœ‰æ­¤è¯ï¼Œç»§ç»­å–â€œè¿˜æ²¡æœ‰â€ï¼Œä¾æ¬¡å–åˆ°å­—æ®µâ€œè¿˜æ²¡æœ‰åŒ¹é…â€(å‡è®¾é˜ˆå€¼ä¸º 5)ï¼Œç„¶åä»â€œæ²¡â€å¼€å§‹ï¼Œå–â€œæ²¡æœ‰â€ï¼Œå¦‚æ­¤å¾ªç¯ç›´åˆ°å­—ç¬¦ä¸²æœ«å°¾ä¸ºæ­¢ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å‡†ç¡®ç‡å´ä¸æ˜¯å¾ˆé«˜ï¼Œæ¯”å¦‚å¾…å¤„ç†å­—ç¬¦ä¸²ä¸ºâ€œä¸­åäººæ°‘å…±å’Œ å›½â€ï¼Œæ­¤åŒ¹é…ç®—æ³•åˆ†å‡ºçš„ç»“æœä¸ºï¼šä¸­åã€äººæ°‘ã€å…±å’Œå›½ï¼Œå› æ­¤è¯¥æ–¹æ³•åŸºæœ¬ä¸Šå·²ç»ä¸è¢«é‡‡ç”¨ ã€‚ æœ€å¤§åŒ¹é…ç®—æ³•åŸºäºå­—ç¬¦ä¸²çš„æœ€å¤§åŒ¹é…ï¼Œè¿™ç§æ–¹æ³•ç°åœ¨ä»æ¯”è¾ƒå¸¸ç”¨ã€‚æœ€å¤§åŒ¹é…(Maximum Matching)åˆ†ä¸ºæ­£å‘å’Œé€†å‘ä¸¤ç§æœ€å¤§åŒ¹é…ï¼Œæ­£å‘åŒ¹é…çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šå‡è®¾è¯å…¸ä¸­æœ€å¤§è¯æ¡æ‰€å«çš„æ±‰å­—ä¸ªæ•°ä¸º n ä¸ªï¼Œå–å¾…å¤„ç†å­—ç¬¦ä¸²çš„å‰ n ä¸ªå­—ä½œä¸ºåŒ¹é…å­— æ®µï¼ŒæŸ¥æ‰¾åˆ†è¯è¯å…¸ã€‚è‹¥è¯å…¸ä¸­å«æœ‰è¯¥è¯ï¼Œåˆ™åŒ¹é…æˆåŠŸï¼Œåˆ†å‡ºè¯¥è¯ï¼Œç„¶åä»è¢«æ¯”è¾ƒå­—ç¬¦ä¸²çš„ n+1 å¤„å¼€å§‹å†å– n ä¸ªå­—ç»„æˆçš„å­—æ®µé‡æ–°åœ¨è¯å…¸ä¸­åŒ¹é…ï¼›å¦‚æœæ²¡æœ‰åŒ¹é…æˆ åŠŸï¼Œåˆ™å°†è¿™ n ä¸ªå­—ç»„æˆçš„å­—æ®µçš„æœ€åä¸€ä½å‰”é™¤ï¼Œç”¨å‰©ä¸‹çš„ n ä¸€ 1 ä¸ªå­—ç»„æˆçš„å­—æ®µåœ¨è¯å…¸ä¸­è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æ­¤è¿›è¡Œä¸‹å»ï¼Œç›´åˆ°åˆ‡åˆ†æˆåŠŸä¸ºæ­¢ã€‚ ä¾‹ å¦‚ï¼Œå¾…å¤„ç†å­—ç¬¦ä¸²ä¸ºâ€œæ±‰å­—å¤šä¸ºè¡¨æ„æ–‡å­—â€ï¼Œå–å­—ç¬¦ä¸²â€œæ±‰è¯­å¤šä¸ºè¡¨â€(å‡è®¾æ¯”è¾ƒçš„æ­¥é•¿ä¸º 5ï¼Œæœ¬æ–‡æ­¥é•¿ step éƒ½å– 5)ä¸è¯å…¸è¿›è¡Œæ¯”è¾ƒï¼Œæ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„è¯ï¼Œå» é™¤â€œè¡¨â€å­—ï¼Œç”¨å­—æ®µâ€œæ±‰è¯­å¤šä¸ºâ€è¿›è¡ŒåŒ¹é…ï¼Œç›´è‡³åŒ¹é…åˆ°â€œæ±‰è¯­â€ä¸ºè‡³ï¼Œå†å–å­—ç¬¦ä¸²â€œå¤šä¸ºè¡¨æ„â€ï¼Œå¾ªç¯åˆ°åˆ‡åˆ†å‡ºâ€œæ–‡å­—â€ä¸€è¯ã€‚ç›®å‰ï¼Œæ­£å‘æœ€å¤§åŒ¹é…æ–¹æ³•ä½œä¸ºä¸€ç§ åŸºæœ¬çš„æ–¹æ³•å·²è¢«è‚¯å®šä¸‹æ¥ï¼Œä½†æ˜¯ç”±äºé”™è¯¯æ¯”è¾ƒå¤§ï¼Œä¸€èˆ¬ä¸å•ç‹¬ä½¿ç”¨ã€‚å¦‚å­—ç¬¦ä¸²â€œå¤„ç†æœºå™¨å‘ç”Ÿçš„æ•…éšœâ€ï¼Œåœ¨æ­£å‘æœ€å¤§åŒ¹é…æ–¹æ³•ä¸­ä¼šå‡ºç°æ­§ä¹‰åˆ‡åˆ†ï¼Œè¯¥å­—ç¬¦ä¸²è¢«åˆ†ä¸ºï¼š å¤„ç†æœºã€å‘ç”Ÿã€æ•…éšœï¼Œä½†æ˜¯ä½¿ç”¨é€†å‘åŒ¹é…å°±èƒ½å¾—åˆ°æœ‰æ•ˆçš„åˆ‡åˆ†ã€‚ é€†å‘æœ€å¤§åŒ¹é… RMM(Reverse Directional Maximum Matching Method)çš„åˆ†è¯åŸç†å’Œè¿‡ç¨‹ä¸æ­£å‘æœ€å¤§åŒ¹é…ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå‰è€…ä»æ–‡ç« æˆ–è€…å¥å­(å­—ä¸²)çš„æœ«å°¾å¼€å§‹åˆ‡åˆ†ï¼Œè‹¥ä¸æˆåŠŸåˆ™å‡å»æœ€å‰é¢çš„ä¸€ä¸ªå­—ã€‚æ¯”å¦‚å¯¹äºå­—ç¬¦ä¸² â€œå¤„ç†æœºå™¨å‘ç”Ÿçš„æ•…éšœâ€ï¼Œç¬¬ä¸€æ­¥ï¼Œä»å­—ä¸²çš„å³è¾¹å–é•¿åº¦ä»¥æ­¥é•¿ä¸ºå•ä½çš„å­—æ®µâ€œå‘ç”Ÿçš„æ•…éšœâ€åœ¨è¯å…¸ä¸­è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…ä¸æˆåŠŸï¼Œå†å–å­—æ®µâ€œç”Ÿçš„æ•…éšœâ€è¿›è¡ŒåŒ¹é…ï¼Œä¾ æ¬¡åŒ¹é…ï¼Œç›´åˆ°åˆ†å‡ºâ€œæ•…éšœâ€ä¸€è¯ï¼Œæœ€ç»ˆä½¿ç”¨ RMM æ–¹æ³•åˆ‡åˆ†çš„ç»“æœä¸ºï¼šæ•…éšœã€å‘ç”Ÿã€æœºå™¨ã€å¤„ç†ã€‚è¯¥æ–¹æ³•è¦æ±‚é…å¤‡é€†åºè¯å…¸ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"å…¨æ–‡æœç´¢","slug":"å…¨æ–‡æœç´¢","permalink":"http://blog.crazylaw.cn/tags/%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2/"}]},{"title":"åŸºäºtire-treeçš„å…³é”®å­—åŒ¹é…","slug":"æ•°æ®ç»“æ„/trie-tree","date":"2018-01-23T07:20:00.000Z","updated":"2021-03-20T16:25:01.818Z","comments":true,"path":"2018/01/23/æ•°æ®ç»“æ„/trie-tree/","link":"","permalink":"http://blog.crazylaw.cn/2018/01/23/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/trie-tree/","excerpt":"å‰è¨€å­—å…¸æ ‘ï¼Œåˆç§°å‰ç¼€æ ‘æˆ– trie æ ‘ï¼Œæ˜¯ä¸€ç§æœ‰åºæ ‘ï¼Œç”¨äºä¿å­˜å…³è”æ•°ç»„ï¼Œå…¶ä¸­çš„é”®é€šå¸¸æ˜¯å­—ç¬¦ä¸²ã€‚ä¸äºŒå‰æŸ¥æ‰¾æ ‘ä¸åŒï¼Œé”®ä¸æ˜¯ç›´æ¥ä¿å­˜åœ¨èŠ‚ç‚¹ä¸­ï¼Œè€Œæ˜¯ç”±èŠ‚ç‚¹åœ¨æ ‘ä¸­çš„ä½ç½®å†³å®šã€‚ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­å­™éƒ½æœ‰ç›¸åŒçš„å‰ç¼€ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªèŠ‚ç‚¹å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œè€Œæ ¹èŠ‚ç‚¹å¯¹åº”ç©ºå­—ç¬¦ä¸²ã€‚ å¼€å§‹æ—©æœŸçš„æ—¶å€™ï¼Œæˆ‘åœ¨ github ä¸Šå†™äº†ä¸€ä¸ªï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰å†™åšæ–‡ã€‚ https://github.com/whiteCcinn/tire-php å½“æ—¶å†™çš„æ—¶å€™ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºæ±‰å­—çš„ç¼–ç é—®é¢˜ï¼Œé‡Œé¢ä¼šè®¾ç½®ä¸€äº› ascii ç å’Œ utf-8 ç¼–ç çš„è½¬ç ä»£ç ï¼Œçœ‹ä¸Šå»æ¯”è¾ƒå¤æ‚ã€‚æ¥ä¸‹æ¥ï¼Œä¼šè´´ä¸€æ®µé€šè¿‡æ­£åˆ™å®ç°çš„ä»£ç ã€‚ é‚£ä¹ˆ trie æ ‘æ€ä¹ˆå®ç°å…³é”®å­—çš„åŒ¹é…å‘¢? è¿™é‡Œä»¥ä¸€å¹…å›¾æ¥è®²è§£ trie æ ‘åŒ¹é…çš„è¿‡ç¨‹ã€‚","text":"å‰è¨€å­—å…¸æ ‘ï¼Œåˆç§°å‰ç¼€æ ‘æˆ– trie æ ‘ï¼Œæ˜¯ä¸€ç§æœ‰åºæ ‘ï¼Œç”¨äºä¿å­˜å…³è”æ•°ç»„ï¼Œå…¶ä¸­çš„é”®é€šå¸¸æ˜¯å­—ç¬¦ä¸²ã€‚ä¸äºŒå‰æŸ¥æ‰¾æ ‘ä¸åŒï¼Œé”®ä¸æ˜¯ç›´æ¥ä¿å­˜åœ¨èŠ‚ç‚¹ä¸­ï¼Œè€Œæ˜¯ç”±èŠ‚ç‚¹åœ¨æ ‘ä¸­çš„ä½ç½®å†³å®šã€‚ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­å­™éƒ½æœ‰ç›¸åŒçš„å‰ç¼€ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªèŠ‚ç‚¹å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œè€Œæ ¹èŠ‚ç‚¹å¯¹åº”ç©ºå­—ç¬¦ä¸²ã€‚ å¼€å§‹æ—©æœŸçš„æ—¶å€™ï¼Œæˆ‘åœ¨ github ä¸Šå†™äº†ä¸€ä¸ªï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰å†™åšæ–‡ã€‚ https://github.com/whiteCcinn/tire-php å½“æ—¶å†™çš„æ—¶å€™ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºæ±‰å­—çš„ç¼–ç é—®é¢˜ï¼Œé‡Œé¢ä¼šè®¾ç½®ä¸€äº› ascii ç å’Œ utf-8 ç¼–ç çš„è½¬ç ä»£ç ï¼Œçœ‹ä¸Šå»æ¯”è¾ƒå¤æ‚ã€‚æ¥ä¸‹æ¥ï¼Œä¼šè´´ä¸€æ®µé€šè¿‡æ­£åˆ™å®ç°çš„ä»£ç ã€‚ é‚£ä¹ˆ trie æ ‘æ€ä¹ˆå®ç°å…³é”®å­—çš„åŒ¹é…å‘¢? è¿™é‡Œä»¥ä¸€å¹…å›¾æ¥è®²è§£ trie æ ‘åŒ¹é…çš„è¿‡ç¨‹ã€‚ å…¶ä¸­è¦ç‚¹ï¼šæ„é€  trie æ ‘ å°†å…³é”®è¯ç”¨ä¸Šé¢ä»‹ç»çš„ preg_split()å‡½æ•°æ‹†åˆ†ä¸ºå•ä¸ªå­—ç¬¦ã€‚å¦‚ç§‘å­¦å®¶å°±æ‹†åˆ†ä¸ºç§‘ã€å­¦ã€å®¶ä¸‰ä¸ªå­—ç¬¦ã€‚ åœ¨æœ€åä¸€ä¸ªå­—ç¬¦åæ·»åŠ ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ `ï¼Œæ­¤å­—ç¬¦ä½œä¸ºä¸€ä¸ªå…³é”®è¯çš„ç»“å°¾ï¼ˆå›¾ä¸­çš„ç²‰çº¢ä¸‰è§’ï¼‰ï¼Œä»¥æ­¤å­—ç¬¦æ¥æ ‡è¯†æŸ¥åˆ°äº†ä¸€ä¸ªå…³é”®è¯ï¼ˆä¸ç„¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“åŒ¹é…åˆ°ç§‘ã€å­¦ä¸¤ä¸ªå­—ç¬¦æ—¶ç®—ä¸ç®—åŒ¹é…æˆåŠŸï¼‰ã€‚`ï¼Œæ­¤å­—ç¬¦ä½œä¸ºä¸€ä¸ªå…³é”®è¯çš„ç»“å°¾ï¼ˆå›¾ä¸­çš„ç²‰çº¢ä¸‰è§’ï¼‰ï¼Œä»¥æ­¤å­—ç¬¦æ¥æ ‡è¯†æŸ¥åˆ°äº†ä¸€ä¸ªå…³é”®è¯ï¼ˆä¸ç„¶ï¼Œæˆ‘ä»¬ä¸çŸ¥é“åŒ¹é…åˆ°ç§‘ã€å­¦ä¸¤ä¸ªå­—ç¬¦æ—¶ç®—ä¸ç®—åŒ¹é…æˆåŠŸï¼‰ã€‚ æ£€æŸ¥æ ¹éƒ¨æ˜¯å¦æœ‰ç¬¬ä¸€ä¸ªå­—ç¬¦(ç§‘)èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰äº†æ­¤èŠ‚ç‚¹ï¼Œåˆ°æ­¥éª¤ 4ã€‚ å¦‚æœè¿˜æ²¡æœ‰ï¼Œåœ¨æ ¹éƒ¨æ·»åŠ å€¼ä¸ºç§‘çš„èŠ‚ç‚¹ã€‚ ä¾æ¬¡æ£€æŸ¥å¹¶æ·»åŠ å­¦ã€å®¶ ä¸¤ä¸ªèŠ‚ç‚¹ã€‚ åœ¨ç»“å°¾æ·»åŠ `èŠ‚ç‚¹ï¼Œå¹¶ç»§ç»­ä¸‹ä¸€ä¸ªå…³é”®è¯çš„æ’å…¥ã€‚ åŒ¹é…ç„¶åæˆ‘ä»¬ä»¥ è¿™ä½ç§‘å­¦å®¶å¾ˆäº†ä¸èµ·ï¼ä¸ºä¾‹æ¥å‘èµ·åŒ¹é…ã€‚ é¦–å…ˆæˆ‘ä»¬å°†å¥å­æ‹†åˆ†ä¸ºå•ä¸ªå­—ç¬¦ è¿™ã€ä½ã€â€¦ï¼› ä»æ ¹æŸ¥è¯¢ç¬¬ä¸€ä¸ªå­—ç¬¦è¿™ï¼Œå¹¶æ²¡æœ‰ä»¥è¿™ä¸ªå­—ç¬¦å¼€å¤´çš„å…³é”®è¯ï¼Œå°†å­—ç¬¦â€œæŒ‡é’ˆâ€å‘åç§»ï¼Œç›´åˆ°æ‰¾åˆ°æ ¹ä¸‹æœ‰çš„å­—ç¬¦èŠ‚ç‚¹ç§‘; æ¥ç€åœ¨èŠ‚ç‚¹ç§‘ä¸‹å¯»æ‰¾å€¼ä¸º å­¦èŠ‚ç‚¹ï¼Œæ‰¾åˆ°æ—¶ï¼Œç»“æœå­æ ‘çš„æ·±åº¦å·²ç»åˆ°äº† 2ï¼Œå…³é”®è¯çš„æœ€çŸ­é•¿åº¦æ˜¯ 2ï¼Œæ­¤æ—¶éœ€è¦åœ¨å­¦ç»“ç‚¹ä¸‹æŸ¥æ‰¾æ˜¯å¦æœ‰`ï¼Œæ‰¾åˆ°æ„å‘³ç€åŒ¹é…æˆåŠŸï¼Œè¿”å›å…³é”®è¯ï¼Œå¹¶å°†å­—ç¬¦â€œæŒ‡é’ˆâ€åç§»ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ç»§ç»­åœ¨æ­¤ç»“ç‚¹ä¸‹å¯»æ‰¾ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚ å¦‚æ­¤éå†ï¼Œç›´åˆ°æœ€åï¼Œè¿”å›æ‰€æœ‰åŒ¹é…ç»“æœã€‚ PHP ä»£ç å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283&lt;?phpclass Trie&#123; /** * node struct * * node = array( * val-&gt;word * next-&gt;array(node)/null * depth-&gt;int * ) */ private $root = array( 'depth' =&gt; 0, 'next' =&gt; array(), ); private $matched = array(); public function append($keyword) &#123; $words = preg_split('/(?&lt;!^)(?!$)/u', $keyword); array_push($words, '`'); $this-&gt;insert($this-&gt;root, $words); &#125; public function match($str) &#123; $this-&gt;matched = array(); $words = preg_split('/(?&lt;!^)(?!$)/u', $str); while (count($words) &gt; 0) &#123; $matched = array(); $res = $this-&gt;query($this-&gt;root, $words, $matched); if ($res) &#123; $this-&gt;matched[] = implode('', $matched); &#125; array_shift($words); &#125; return $this-&gt;matched; &#125; private function insert(&amp;$node, $words) &#123; if (empty($words)) &#123; return; &#125; $word = array_shift($words); if (isset($node['next'][$word])) &#123; $this-&gt;insert($node['next'][$word], $words); &#125; else &#123; $tmp_node = array( 'depth' =&gt; $node['depth'] + 1, 'next' =&gt; array(), ); $node['next'][$word] = $tmp_node; $this-&gt;insert($node['next'][$word], $words); &#125; &#125; private function query($node, $words, &amp;$matched) &#123; $word = array_shift($words); if (isset($node['next'][$word])) &#123; array_push($matched, $word); if (isset($node['next'][$word]['next']['`'])) &#123; return true; &#125; return $this-&gt;query($node['next'][$word], $words, $matched); &#125; else &#123; $matched = array(); return false; &#125; &#125;&#125;$tire = new Trie();$msg = 'æ€§æ´¾å¯¹';$tire-&gt;append('æ€§');$tire-&gt;append('æ€§çˆ±');$tire-&gt;append('æ€§çˆ±2');$tire-&gt;append('æ€§çˆ±3');print_r($tire-&gt;match($msg)); æ³¨æ„åˆ°ï¼Œä¸Šé¢çš„è¿™ä¸€æ®µä»£ç æœ‰ä¸€ä¸ªå¼±ç‚¹å°±æ˜¯æŒ‰ç…§æœ€çŸ­åŒ¹é…ã€‚å½“ä½ è¾“å…¥æ€§çˆ±æ’é˜Ÿçš„æ—¶å€™ï¼Œæ— æ³•æœç´¢å‡ºæ€§çˆ±ï¼Œåªèƒ½æœç´¢åˆ°æ€§ã€‚ ä»¥ä¸‹çš„ä»£ç è¿›è¡Œäº†å‡çº§ï¼Œå…¨åŒ¹é…ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485class Trie&#123; /** * node struct * * node = array( * val-&gt;word * next-&gt;array(node)/null * depth-&gt;int * ) */ private $root = array( 'depth' =&gt; 0, 'next' =&gt; array(), ); private $matched = array(); public function append($keyword) &#123; $words = preg_split('/(?&lt;!^)(?!$)/u', $keyword); array_push($words, '`'); $this-&gt;insert($this-&gt;root, $words); &#125; public function match($str) &#123; $this-&gt;matched = array(); $words = preg_split('/(?&lt;!^)(?!$)/u', $str); while (count($words) &gt; 0) &#123; $matched = array(); $res = $this-&gt;query($this-&gt;root, $words, $matched); if ($res) &#123; $this-&gt;matched[] = implode('', $matched); &#125; array_shift($words); &#125; return $this-&gt;matched; &#125; private function insert(&amp;$node, $words) &#123; if (empty($words)) &#123; return; &#125; $word = array_shift($words); if (isset($node['next'][$word])) &#123; $this-&gt;insert($node['next'][$word], $words); &#125; else &#123; $tmp_node = array( 'depth' =&gt; $node['depth'] + 1, 'next' =&gt; array(), ); $node['next'][$word] = $tmp_node; $this-&gt;insert($node['next'][$word], $words); &#125; &#125; private function query($node, $words, &amp;$matched) &#123; $word = array_shift($words); if (isset($node['next'][$word])) &#123; array_push($matched, $word); $keys = array_keys($node['next'][$word]['next']); if (!empty($keys) &amp;&amp; in_array('`', $keys)) &#123; if (count($keys) == 1) &#123; return true; &#125; else &#123; $this-&gt;matched[] = implode('', $matched); &#125; &#125; return $this-&gt;query($node['next'][$word], $words, $matched); &#125; else &#123; $matched = array(); return false; &#125; &#125;&#125;$tire = new Trie();$msg = 'æ€§çˆ±æ´¾å¯¹';$tire-&gt;append('æ€§');$tire-&gt;append('æ€§çˆ±');$tire-&gt;append('æ€§çˆ±æ´¾');print_r($tire-&gt;match($msg));","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"æ ‘","slug":"æ ‘","permalink":"http://blog.crazylaw.cn/tags/%E6%A0%91/"}]},{"title":"åŸºäºgeohashç®—æ³•-æœç´¢é™„è¿‘çš„äºº","slug":"redis-geohash","date":"2018-01-23T03:45:00.000Z","updated":"2021-03-20T16:25:01.814Z","comments":true,"path":"2018/01/23/redis-geohash/","link":"","permalink":"http://blog.crazylaw.cn/2018/01/23/redis-geohash/","excerpt":"å‰è¨€ç›®å‰ç©ºé—´ç´¢å¼•çš„å®ç°æœ‰ R æ ‘å’Œå…¶å˜ç§ GIST æ ‘ã€å››å‰æ ‘ã€ç½‘æ ¼ç´¢å¼•ç­‰ã€‚ ç½‘æ ¼ç´¢å¼•ä¸å†å¤šæï¼Œä½¿ç”¨æ™®é€šçš„ hash è¡¨å­˜å‚¨åœ°ç‚¹å’Œé£æ ¼ä¹‹é—´çš„æ˜ å°„æ¥å®ç°ã€‚ä»Šå¤©è¦ä»‹ç»çš„ GeoHash ç®—æ³•å®ç°çš„ç©ºé—´ç´¢å¼•ï¼Œè™½ç„¶æ˜¯ä»¥ B æ ‘å®ç°ï¼Œä½†æˆ‘è®¤ä¸ºå®ƒä¹Ÿå€Ÿç”¨ç½‘æ ¼ç´¢å¼•çš„ä¸€éƒ¨åˆ†æ€æƒ³ã€‚ php-geohash GeoHash ä»æ¨ªå‘ä¸Šå°†æ•´ä¸ªæ–¹å½¢çº¸åˆ†ä¸ºå·¦å³ä¸¤ä»½ï¼Œå·¦ä¾§éƒ¨åˆ†ä¸ºæ ‡è®°ä¸º 0ï¼Œ å³ä¾§éƒ¨åˆ†æ ‡è®°ä¸º 1ï¼› å†å°†çº¢ç‚¹æ‰€åœ¨çš„éƒ¨åˆ†åˆ’åˆ†ä¸ºå·¦å³ä¸¤å—ï¼Œå†å¯¹çº¢ç‚¹ä½ç½®åšåŒæ ·çš„æ ‡è¯†ï¼Œæœ€åå¾—å‡ºçº¢ç‚¹åœ¨æ¨ªå‘ä¸Šçš„æ ‡è¯†ä¸º 10; åœ¨çºµå‘ä¸Šå¯¹æ–¹å½¢çº¸åšåŒæ ·çš„åˆ’åˆ†ï¼Œå·¦ä¾§æ ‡è¯†ä¸º0ï¼Œå³ä¾§æ ‡è¯†ä¸º 1ï¼Œå¾—å‡ºçº¢ç‚¹ä½ç½®åœ¨çºµå‘ä¸Šçš„æ ‡è¯†ä¸º 01; å°†æ¨ªå‘æ ‡è¯†å’Œçºµå‘æ ‡è¯†åˆå¹¶ï¼Œè§„åˆ™ä¸º çºµå‘åœ¨å¥‡æ•°ä½ï¼Œæ¨ªå‘åœ¨å¶æ•°ä½ (ä¹Ÿå¯çºµæ¨ªç›¸åï¼Œä½†è¦åœ¨æ•´ä¸ªç³»ç»Ÿå†…ä¿æŒä¸€è‡´)ï¼Œå¾—å‡ºçº¢ç‚¹åœ¨æ–¹å½¢çº¸ä¸Šçš„æ ‡è¯†ä¸º 1001;","text":"å‰è¨€ç›®å‰ç©ºé—´ç´¢å¼•çš„å®ç°æœ‰ R æ ‘å’Œå…¶å˜ç§ GIST æ ‘ã€å››å‰æ ‘ã€ç½‘æ ¼ç´¢å¼•ç­‰ã€‚ ç½‘æ ¼ç´¢å¼•ä¸å†å¤šæï¼Œä½¿ç”¨æ™®é€šçš„ hash è¡¨å­˜å‚¨åœ°ç‚¹å’Œé£æ ¼ä¹‹é—´çš„æ˜ å°„æ¥å®ç°ã€‚ä»Šå¤©è¦ä»‹ç»çš„ GeoHash ç®—æ³•å®ç°çš„ç©ºé—´ç´¢å¼•ï¼Œè™½ç„¶æ˜¯ä»¥ B æ ‘å®ç°ï¼Œä½†æˆ‘è®¤ä¸ºå®ƒä¹Ÿå€Ÿç”¨ç½‘æ ¼ç´¢å¼•çš„ä¸€éƒ¨åˆ†æ€æƒ³ã€‚ php-geohash GeoHash ä»æ¨ªå‘ä¸Šå°†æ•´ä¸ªæ–¹å½¢çº¸åˆ†ä¸ºå·¦å³ä¸¤ä»½ï¼Œå·¦ä¾§éƒ¨åˆ†ä¸ºæ ‡è®°ä¸º 0ï¼Œ å³ä¾§éƒ¨åˆ†æ ‡è®°ä¸º 1ï¼› å†å°†çº¢ç‚¹æ‰€åœ¨çš„éƒ¨åˆ†åˆ’åˆ†ä¸ºå·¦å³ä¸¤å—ï¼Œå†å¯¹çº¢ç‚¹ä½ç½®åšåŒæ ·çš„æ ‡è¯†ï¼Œæœ€åå¾—å‡ºçº¢ç‚¹åœ¨æ¨ªå‘ä¸Šçš„æ ‡è¯†ä¸º 10; åœ¨çºµå‘ä¸Šå¯¹æ–¹å½¢çº¸åšåŒæ ·çš„åˆ’åˆ†ï¼Œå·¦ä¾§æ ‡è¯†ä¸º0ï¼Œå³ä¾§æ ‡è¯†ä¸º 1ï¼Œå¾—å‡ºçº¢ç‚¹ä½ç½®åœ¨çºµå‘ä¸Šçš„æ ‡è¯†ä¸º 01; å°†æ¨ªå‘æ ‡è¯†å’Œçºµå‘æ ‡è¯†åˆå¹¶ï¼Œè§„åˆ™ä¸º çºµå‘åœ¨å¥‡æ•°ä½ï¼Œæ¨ªå‘åœ¨å¶æ•°ä½ (ä¹Ÿå¯çºµæ¨ªç›¸åï¼Œä½†è¦åœ¨æ•´ä¸ªç³»ç»Ÿå†…ä¿æŒä¸€è‡´)ï¼Œå¾—å‡ºçº¢ç‚¹åœ¨æ–¹å½¢çº¸ä¸Šçš„æ ‡è¯†ä¸º 1001; åªæ ‡è®°ä¸€ä¸ªæ–¹æ ¼æ˜¾å¾—çœ‹ä¸å‡ºä»€ä¹ˆè§„å¾‹ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè¿™äº›éƒ½ç©ºæ ¼éƒ½æ ‡è¯†åä¼šå‘ç° è¢«åˆ’åˆ†åœ¨è§’è½é‡Œçš„å››ä¸ªæ–¹æ ¼ä¼šæœ‰åŒæ ·çš„å‰ç¼€. åŒæ ·çš„å‰ç¼€æ„å‘³ç€å¯ä»¥ä½¿ç”¨ B æ ‘ ç´¢å¼•æŸ¥æ‰¾æœ‰ç›¸åŒå‰ç¼€çš„ç‚¹ä½œä¸ºé™„è¿‘çš„ç‚¹ï¼ŒGeoHash ç®—æ³•ä¾¿æ˜¯è¿™äº›åŒæ ·çš„å‰ç¼€ä¸Šé¢åšæ–‡ç« ã€‚ å¢¨å¡æ‰˜æŠ•å½± å¢¨å¡æ‰˜æŠ•å½±ï¼Œæ˜¯æ­£è½´ç­‰è§’åœ†æŸ±æŠ•å½±ã€‚ç”±è·å…°åœ°å›¾å­¦å®¶å¢¨å¡æ‰˜(G.Mercator)äº 1569 å¹´åˆ›ç«‹ã€‚å‡æƒ³ä¸€ä¸ªä¸åœ°è½´æ–¹å‘ä¸€è‡´çš„åœ†æŸ±åˆ‡æˆ–å‰²äºåœ°çƒï¼ŒæŒ‰ç­‰è§’æ¡ä»¶ï¼Œå°†ç»çº¬ç½‘æŠ•å½±åˆ°åœ†æŸ±é¢ä¸Šï¼Œå°†åœ†æŸ±é¢å±•ä¸ºå¹³é¢åï¼Œå³å¾—æœ¬æŠ•å½±ã€‚å¢¨å¡æ‰˜æŠ•å½±åœ¨åˆ‡åœ†æŸ±æŠ•å½±ä¸å‰²åœ†æŸ±æŠ•å½±ä¸­ï¼Œæœ€æ—©ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ˜¯åˆ‡åœ†æŸ±æŠ•å½±ã€‚ å¢¨å¡æ‰˜æŠ•å½±ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å¯ä»¥ æŠŠæ•´ä¸ªåœ°çƒå¹³é¢ä½œä¸ºä¸€ä¸ªæ­£æ–¹å½¢æ¥å¤„ç†ï¼Œå½“ç„¶åœ°çƒå¹³é¢ä¸æ˜¯ä¸¥æ ¼çš„æ­£æ–¹å½¢ï¼Œæ­¤æŠ•å½±åœ¨ä¸¤æé™„è¿‘çš„ç‚¹ä¼šæœ‰è¯¯å·®ï¼Œæœ¬æ–‡ä¸“æ³¨äºåŸç†ï¼Œçº åå°±ä¸å¤šæäº†ã€‚ å®ç°æŒ‰ç…§å¢¨å¡æ‰˜æŠ•å½±çš„å¹³é¢ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸Šé¢åˆ’åˆ†æ–¹æ ¼çº¸çš„æ–¹å¼æ¥å°†æ•´ä¸ªåœ°çƒè¡¨é¢åˆ’åˆ†ä¸ºå„ä¸ªå°æ–¹æ ¼ã€‚ å¦‚(116.276349, 40.040875)è¿™ä¸ªç‚¹çš„ç»åº¦åˆ’åˆ†ï¼š ç»åº¦åœ¨ [-180,0) èŒƒå›´å†…çš„æ ‡è¯†ä¸º 0ï¼Œç»åº¦èŒƒå›´åœ¨ [0, 180) åº¦çš„æ ‡è¯†ä¸º 1; ç»§ç»­åˆ’åˆ†ï¼Œç»åº¦èŒƒå›´åœ¨ [0,90) çš„æ ‡è¯†ä¸º 0ï¼Œç»åº¦èŒƒå›´åœ¨ [90,180) çš„æ ‡è¯†ä¸º 1; è¿™æ ·ï¼Œæˆ‘ä»¬åˆ’åˆ† 20 æ¬¡ï¼Œæ–¹æ ¼çš„ç²¾åº¦ï¼ˆè§æ–‡æœ«å¯¹ç…§è¡¨ï¼‰å·²è¾¾åˆ° 2mï¼Œå¾—åˆ°ç»åº¦çš„æ ‡è¯†äºŒè¿›åˆ¶ä¸²ä¸º11010010101011110111; å¯¹çº¬åº¦åŒæ ·åˆ’åˆ†ï¼Œå¾—åˆ°çº¬åº¦çš„æ ‡è¯†äºŒè¿›åˆ¶ä¸²ä¸º10111000111100100111; æˆ‘ä»¬å¯¹å®ƒç»„åˆï¼Œå¾—åˆ° 40 ä½çš„äºŒè¿›åˆ¶ä¸²11011 01110 00010 01110 11100 10111 01001 11111; æˆ‘ä»¬å°†è¿™ä¸ªäºŒè¿›åˆ¶ä¸²ä½¿ç”¨ base32 ç¼–ç ï¼ˆåŸç†åŒ base64ï¼Œå¯ä»¥è§æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼šWEB å¼€å‘ä¸­çš„å­—ç¬¦é›†å’Œç¼–ç ï¼Œä½ç¼–ç æ˜ å°„è¡¨è§ä¸‹ï¼‰ï¼Œå¾—åˆ° GeoHash ç¼–ç ä¸º 3OCO4XJ7; é‚£ä¹ˆ GeoHash ç¼–ç å‰ç¼€ä¸º 3OCO4XJ7çš„åœ°ç†ç‚¹å°±æ˜¯ç¦» (116.276349, 40.040875)ä¸¤ç±³å†…çš„ç‚¹ã€‚å¦‚æœæˆ‘ä»¬æŠŠåœ°ç†ä½ç½®ç‚¹å’Œå…¶ GeoHash ç¼–ç å­˜å…¥æ•°æ®åº“çš„è¯ï¼Œæˆ‘ä»¬è¦æŸ¥æ‰¾ é™„è¿‘ä¸¤ç±³ç‚¹çš„ç‚¹ï¼Œåªéœ€è¦é™å®šæ¡ä»¶ geo_code like &#39;3OCO4XJ7%&#39;å°±è¡Œäº†; è¾¹ç•Œå€¼é—®é¢˜è¾¹ç•Œç‚¹é—®é¢˜ å¯æ˜¯æœ€ç®€ç‰ˆçš„ GeoHash è¿˜æœ‰ä¸€ä¸ªå¼±ç‚¹ï¼Œå¦‚ä¸‹å›¾ï¼š å¦‚æœæ¯ä¸ªæ–¹æ ¼çš„ç²¾åº¦ä¸º 2kmï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥æŒ‰ç…§å‰ç¼€æŸ¥è¯¢çº¢ç‚¹é™„è¿‘ 2km çš„ç‚¹æ˜¯æŸ¥æ‰¾ä¸åˆ°ç¦»å®ƒå¾ˆè¿‘çš„é»‘ç‚¹çš„ã€‚ è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰€å…¶å‘¨è¾¹å…«ä¸ªæ–¹æ ¼ä¹Ÿè€ƒè™‘ä¸Šï¼Œå°†è‡ªèº«æ–¹æ ¼å’Œå‘¨è¾¹å…«ä¸ªæ–¹æ ¼å†…çš„ç‚¹éƒ½éå†ä¸€æ¬¡ï¼Œå†è¿”å›ç¬¦åˆè¦æ±‚çš„ç‚¹ã€‚é‚£ä¹ˆå¦‚ä½•çŸ¥é“å‘¨è¾¹æ–¹æ ¼çš„å‰ç¼€å‘¢ï¼Ÿ ä»”ç»†è§‚å¯Ÿç›¸é‚»æ–¹æ ¼ï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸¤ä¸ªå°æ–¹æ ¼ä¼šåœ¨ ç»åº¦æˆ–çº¬åº¦çš„äºŒè¿›åˆ¶ç ä¸Šç›¸å·®1ï¼›æˆ‘ä»¬é€šè¿‡ GeoHash ç åå‘è§£æå‡ºäºŒè¿›åˆ¶ç åï¼Œå°†å…¶ç»åº¦æˆ–çº¬åº¦ï¼ˆæˆ–ä¸¤è€…ï¼‰çš„äºŒè¿›åˆ¶ç åŠ ä¸€ï¼Œå†æ¬¡ç»„åˆä¸º GeoHash ç ã€‚ Redis çš„ GEO å‡½æ•°ç‰ˆæœ¬é™åˆ¶ï¼šRedis çš„ Geo ç³»åˆ—å‡½æ•°éœ€è¦&gt;3.2 ç‰ˆæœ¬æ‰æ”¯æŒã€‚ é—®é¢˜æˆ‘ä»¬å¸¸è§çš„éœ€æ±‚æ˜¯æŸ¥æ‰¾ nç±³ èŒƒå›´å†…çš„ç‚¹ï¼Œé‚£ä¹ˆ n ç±³ ä¸ GeoHash ç ä½æ•°ä¹‹é—´çš„æ˜ å°„å¦‚ä½•å®ç°å‘¢ï¼Ÿç”±äº GeoHash ç æ˜¯ç”±5ä½äºŒè¿›åˆ¶ç ç»„æˆï¼Œæ¯å°‘ä¸€ä½ï¼Œç²¾åº¦å°±ä¼šæŸå¤± 2e(5/2)ã€‚ æ–¹æ³•å½“ç„¶æœ‰çš„ï¼Œæˆ‘ä»¬å°†äºŒè¿›åˆ¶ GeoHash ç ç›´æ¥ç´¢å¼•å°±å¯ä»¥ï¼Œä½†å¾ˆé•¿çš„ç´¢å¼•é•¿åº¦ä¼šå¯¼è‡´ B æ ‘ ç´¢å¼•æŸ¥è¯¢æ•ˆç‡ä¼šè¿…é€Ÿä¸‹é™ã€‚ æ–¹æ¡ˆäºæ˜¯æˆ‘ä»¬æ¥ç€å¯»æ‰¾è§£å†³æ–¹æ¡ˆï¼Œæ—¢ç„¶ä½¿ç”¨ base32 è½¬æ¢ä¸º 32 è¿›åˆ¶ç  ä¼šä¸å¥½æ§åˆ¶ç²¾åº¦ï¼Œä¿æŒäºŒè¿›åˆ¶åˆå¯¼è‡´ç´¢å¼•é•¿åº¦è¿‡é•¿ï¼Œé‚£ä¹ˆè¿›åˆ¶ä½æ•°å’Œç´¢å¼•é•¿åº¦æœ‰æ²¡æœ‰ä¸€ä¸ªå¹³è¡¡å‘¢ï¼Ÿ å¦å¤– Redis çš„ sorted set æ”¯æŒ 64 ä½ çš„ double ç±»å‹çš„ scoreï¼Œæˆ‘ä»¬æŠŠäºŒè¿›åˆ¶çš„ GeoHash ç è½¬ä¸ºåè¿›åˆ¶æ”¾å…¥ Redis çš„ sorted set ä¸­ï¼Œä¸æ˜¯å¯ä»¥å®ç° log(n)çš„æŸ¥è¯¢æ•ˆç‡äº†ä¹ˆã€‚ redis çš„ geo ä¹Ÿæœ‰ä¸€ä¸ªå¾ˆè‡´å‘½çš„å¼±ç‚¹ï¼Œé‚£å°±æ˜¯å•ä¸€çš„æœç´¢é™„è¿‘çš„äººï¼Œè¿˜ä¸èƒ½å¸¦å…¶ä»–çš„è¿å¸¦æ¡ä»¶ï¼Œæ‰€ä»¥éœ€è¦äºŒæ¬¡è¿‡æ»¤æ‰å¯ä»¥ï¼Œå¢åŠ äº†é¢å¤–çš„å¼€é”€ã€‚ APIgeoaddgeoadd ç”¨æ¥å¢åŠ åœ°ç†ä½ç½®çš„åæ ‡ï¼Œå¯ä»¥æ‰¹é‡æ·»åŠ åœ°ç†ä½ç½®ï¼Œå‘½ä»¤æ ¼å¼ä¸ºï¼š GEOADD key longitude latitude member [longitude latitude member ...] key æ ‡è¯†ä¸€ä¸ªåœ°ç†ä½ç½®çš„é›†åˆã€‚longitude latitude member æ ‡è¯†äº†ä¸€ä¸ªåœ°ç†ä½ç½®çš„åæ ‡ã€‚longitude æ˜¯åœ°ç†ä½ç½®çš„ç»åº¦ï¼Œlatitude æ˜¯åœ°ç†ä½ç½®çš„çº¬åº¦ã€‚member æ˜¯è¯¥åœ°ç†ä½ç½®çš„åç§°ã€‚GEOADD å¯ä»¥æ‰¹é‡ç»™é›†åˆæ·»åŠ ä¸€æ‰¹åœ°ç†ä½ç½®ã€‚geopos geopos å¯ä»¥è·å–åœ°ç†ä½ç½®çš„åæ ‡ï¼Œå¯ä»¥æ‰¹é‡è·å–å¤šä¸ªåœ°ç†ä½ç½®çš„åæ ‡ï¼Œå‘½ä»¤æ ¼å¼ä¸ºï¼š GEOPOS key member [member ...] geodistgeodist ç”¨æ¥è·å–ä¸¤ä¸ªåœ°ç†ä½ç½®çš„è·ç¦»ï¼Œå‘½ä»¤æ ¼å¼ä¸ºï¼š GEODIST key member1 member2 [m|km|ft|mi] å•ä½å¯ä»¥æŒ‡å®šä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼š mï¼šç±³ï¼Œè·ç¦»å•ä½é»˜è®¤ä¸ºç±³ï¼Œä¸ä¼ é€’è¯¥å‚æ•°åˆ™å•ä½ä¸ºç±³ã€‚ kmï¼šå…¬é‡Œã€‚ miï¼šè‹±é‡Œã€‚ ftï¼šè‹±å°ºã€‚ georadiusgeoradius å¯ä»¥æ ¹æ®ç»™å®šåœ°ç†ä½ç½®åæ ‡è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆã€‚å‘½ä»¤æ ¼å¼ä¸ºï¼š GEORADIUS key longitude latitude radius [m|km|ft|mi] [WITHCOORD] [WITHDIST] [ASC|DESC] [WITHHASH] [COUNT count] longitude latitude æ ‡è¯†äº†åœ°ç†ä½ç½®çš„åæ ‡ï¼Œradius è¡¨ç¤ºèŒƒå›´è·ç¦»ï¼Œè·ç¦»å•ä½å¯ä»¥ä¸º m|km|ft|miï¼Œè¿˜æœ‰ä¸€äº›å¯é€‰å‚æ•°ï¼š WITHCOORDï¼šä¼ å…¥ WITHCOORD å‚æ•°ï¼Œåˆ™è¿”å›ç»“æœä¼šå¸¦ä¸ŠåŒ¹é…ä½ç½®çš„ç»çº¬åº¦ã€‚ WITHDISTï¼šä¼ å…¥ WITHDIST å‚æ•°ï¼Œåˆ™è¿”å›ç»“æœä¼šå¸¦ä¸ŠåŒ¹é…ä½ç½®ä¸ç»™å®šåœ°ç†ä½ç½®çš„è·ç¦»ã€‚ ASC|DESCï¼šé»˜è®¤ç»“æœæ˜¯æœªæ’åºçš„ï¼Œä¼ å…¥ ASC ä¸ºä»è¿‘åˆ°è¿œæ’åºï¼Œä¼ å…¥ DESC ä¸ºä»è¿œåˆ°è¿‘æ’åºã€‚ WITHHASHï¼šä¼ å…¥ WITHHASH å‚æ•°ï¼Œåˆ™è¿”å›ç»“æœä¼šå¸¦ä¸ŠåŒ¹é…ä½ç½®çš„ hash å€¼ã€‚ COUNT countï¼šä¼ å…¥ COUNT å‚æ•°ï¼Œå¯ä»¥è¿”å›æŒ‡å®šæ•°é‡çš„ç»“æœã€‚ georadiusbymembergeoradiusbymember å¯ä»¥æ ¹æ®ç»™å®šåœ°ç†ä½ç½®è·å–æŒ‡å®šèŒƒå›´å†…çš„åœ°ç†ä½ç½®é›†åˆã€‚georadius å‘½ä»¤ä¼ é€’çš„æ˜¯åæ ‡ï¼Œgeoradiusbymember ä¼ é€’çš„æ˜¯åœ°ç†ä½ç½®ã€‚georadius æ›´ä¸ºçµæ´»ï¼Œå¯ä»¥è·å–ä»»ä½•åæ ‡ç‚¹èŒƒå›´å†…çš„åœ°ç†ä½ç½®ã€‚ä½†æ˜¯å¤§å¤šæ•°æ—¶å€™ï¼Œåªæ˜¯æƒ³è·å–æŸä¸ªåœ°ç†ä½ç½®é™„è¿‘çš„å…¶ä»–åœ°ç†ä½ç½®ï¼Œä½¿ç”¨ georadiusbymember åˆ™æ›´ä¸ºæ–¹ä¾¿ã€‚georadiusbymember å‘½ä»¤æ ¼å¼ä¸ºï¼ˆå‘½ä»¤å¯é€‰å‚æ•°ä¸ georadius å«ä¹‰ä¸€æ ·ï¼‰ï¼š GEORADIUSBYMEMBER key member radius [m|km|ft|mi] [WITHCOORD] [WITHDIST] [ASC|DESC] [WITHHASH] [COUNT count] geohashgeohash å¯ä»¥è·å–æŸä¸ªåœ°ç†ä½ç½®çš„ geohash å€¼ã€‚geohash æ˜¯å°†äºŒç»´çš„ç»çº¬åº¦è½¬æ¢æˆå­—ç¬¦ä¸² hash å€¼çš„ç®—æ³•ï¼Œåé¢ä¼šå…·ä½“ä»‹ç» geohash åŸç†ã€‚å¯ä»¥æ‰¹é‡è·å–å¤šä¸ªåœ°ç†ä½ç½®çš„ geohash å€¼ã€‚å‘½ä»¤æ ¼å¼ä¸ºï¼š GEOHASH key member [member ...] å‚è€ƒæ–‡çŒ®ï¼šhttps://www.cnblogs.com/zhenbianshu/p/6863405.html","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/tags/Redis/"}]},{"title":"dockerå®‰è£…php7+nginxäº‹ä¾‹","slug":"docker-php-nginx","date":"2017-11-02T01:34:00.000Z","updated":"2021-03-20T16:25:01.804Z","comments":true,"path":"2017/11/02/docker-php-nginx/","link":"","permalink":"http://blog.crazylaw.cn/2017/11/02/docker-php-nginx/","excerpt":"ç®€ä»‹docker æ˜¯ç”± go è¯­è¨€å¼€å‘çš„çš„ä¸€ä¸ªè™šæ‹Ÿæœºå®¹å™¨ï¼Œé€šè¿‡å±‚çš„æ¦‚å¿µï¼ŒæŠŠ fs(filesysytem)è¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå¯ä»¥ç‹¬ç«‹çš„ç³»ç»Ÿã€‚å…¶ä¸­æ¶‰åŠåˆ°äº†å®¿ä¸»æœºçš„æ¦‚å¿µï¼Œåœ¨è¿™é‡Œï¼Œç”±äºæˆ‘æ‰€ç”¨çš„ç¯å¢ƒåŸºæœ¬éƒ½æ˜¯ centos7ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« è®²è¯‰çš„å°±æ˜¯ centos7 ä¸­ä½¿ç”¨ docker å®‰è£… php7+nginx çš„äº‹ä¾‹ã€‚åç»­æˆ‘ä¼šå‘å¸ƒä¸€äº›é•œåƒä»¥åŠ dockerFile æä¾›å¤§å®¶å­¦ä¹ å‚è€ƒã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼šdocker è¿åŠ¨çš„æœåŠ¡éƒ½éœ€è¦ä»¥å‰å°çš„æ¨¡å¼è¿è¡Œ å®‰è£… docker1yum install -y docker ç”±äºæˆ‘ä»¬å­¦ä¹ å¦‚ä½•ä½¿ç”¨ dockerï¼Œæ‰€ä»¥è¿™é‡Œå°±é€‰æ‹©äº†çš„ç›´æ¥é‡‡ç”¨ yum å®‰è£…äº†ã€‚ å®‰è£…åˆ›å»º docker å®¹å™¨æ“ä½œç”¨æˆ·ç”±äº docker å®¹å™¨åŸºäºå®¿ä¸»æœºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å®¿ä¸»æœºä¸­åˆ›å»ºå¥½å¯¹å®¹å™¨æ“ä½œçš„ç”¨æˆ· 123&#x2F;&#x2F; -g -u å‚æ•°åˆ†åˆ«æŒ‡çš„çš„æ˜¯gidï¼Œå’Œuidgroupadd -g 2017 docker-groupadduser -g 2017 -u 2017 docker-user","text":"ç®€ä»‹docker æ˜¯ç”± go è¯­è¨€å¼€å‘çš„çš„ä¸€ä¸ªè™šæ‹Ÿæœºå®¹å™¨ï¼Œé€šè¿‡å±‚çš„æ¦‚å¿µï¼ŒæŠŠ fs(filesysytem)è¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå¯ä»¥ç‹¬ç«‹çš„ç³»ç»Ÿã€‚å…¶ä¸­æ¶‰åŠåˆ°äº†å®¿ä¸»æœºçš„æ¦‚å¿µï¼Œåœ¨è¿™é‡Œï¼Œç”±äºæˆ‘æ‰€ç”¨çš„ç¯å¢ƒåŸºæœ¬éƒ½æ˜¯ centos7ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« è®²è¯‰çš„å°±æ˜¯ centos7 ä¸­ä½¿ç”¨ docker å®‰è£… php7+nginx çš„äº‹ä¾‹ã€‚åç»­æˆ‘ä¼šå‘å¸ƒä¸€äº›é•œåƒä»¥åŠ dockerFile æä¾›å¤§å®¶å­¦ä¹ å‚è€ƒã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼šdocker è¿åŠ¨çš„æœåŠ¡éƒ½éœ€è¦ä»¥å‰å°çš„æ¨¡å¼è¿è¡Œ å®‰è£… docker1yum install -y docker ç”±äºæˆ‘ä»¬å­¦ä¹ å¦‚ä½•ä½¿ç”¨ dockerï¼Œæ‰€ä»¥è¿™é‡Œå°±é€‰æ‹©äº†çš„ç›´æ¥é‡‡ç”¨ yum å®‰è£…äº†ã€‚ å®‰è£…åˆ›å»º docker å®¹å™¨æ“ä½œç”¨æˆ·ç”±äº docker å®¹å™¨åŸºäºå®¿ä¸»æœºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨å®¿ä¸»æœºä¸­åˆ›å»ºå¥½å¯¹å®¹å™¨æ“ä½œçš„ç”¨æˆ· 123&#x2F;&#x2F; -g -u å‚æ•°åˆ†åˆ«æŒ‡çš„çš„æ˜¯gidï¼Œå’Œuidgroupadd -g 2017 docker-groupadduser -g 2017 -u 2017 docker-user åˆ›å»ºå‡ ä¸ªå’Œ docker å®¹å™¨æœåŠ¡é…ç½®æœ‰å…³çš„ç›®å½•1234567891011&#x2F;&#x2F; ç”¨äºdockerå†…nginxæœåŠ¡è®¿é—®é¡¹ç›®ç›®å½•mkdir -p &#x2F;docker-www&#x2F;&#x2F; ç”¨äºä¿®æ”¹nginxé…ç½®mkdir -p &#x2F;docker-config&#x2F;nginx_config&#x2F;&#x2F; ç”¨äºä¿®æ”¹phpé…ç½®mkdir -p &#x2F;docker-config&#x2F;php_config&#x2F;&#x2F; ç”¨äºä¿®æ”¹php-fpmé…ç½®mkdir -p &#x2F;docker-config&#x2F;php-fpm_config åˆ›å»ºä¸€ä¸ª php å…¥å£æ–‡ä»¶æ¥æ£€æµ‹ docker ä¸­çš„ nginx æœåŠ¡æ˜¯å¦æ­£å¸¸1touch &#x2F;docker-www&#x2F;index.php 123456789101112131415&lt;?php/** * * index.php * * @author Caiwh &lt;471113744@qq.com&gt; * @version 2017å¹´10æœˆ31æ—¥ * @copyright Copyright caiwh's code **/echo 'This is Docker Index.php';echo PHP_EOL;echo 'Hello-World'; ä» hub.docker ä¸­æ‹‰å– php é•œåƒhub.docker åœ°å€ï¼šhttps://hub.docker.com/_/php/ ç”±äºæˆ‘ä»¬è¿™é‡Œéœ€è¦é…åˆ nginx ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‡é€‰æ‹© fpm ç³»åˆ—çš„ã€‚ 123&#x2F;&#x2F; è¿™é‡Œæˆ‘é€‰æ‹©7.1.11-fpmç‰ˆæœ¬ï¼Œæƒ³è¦äº†è§£è¿™ä¸ªé•œåƒçš„åŸºç³»ç»Ÿçš„è¯ï¼Œå¯ä»¥å»æŸ¥çœ‹dockerFileï¼Œå®˜æ–¹æä¾›çš„å‡ ä¹å…¨éƒ¨éƒ½æ˜¯åŸºäºdebianç³»ç»Ÿçš„ã€‚docker pull php:7.1.11-fpm ä» php å®˜æ–¹ä¸­æ‹‰å–å¯¹åº”ç‰ˆæœ¬çš„ php.ini 1curl -o &#x2F;docker-config&#x2F;php_config&#x2F;php.ini https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;php&#x2F;php-src&#x2F;php-7.1.11&#x2F;php.ini-production æ–°å»ºä¸€ä¸ª php-fpm çš„ zz-docker.conf ç”¨äºé‡å†™ç›‘å¬ç«¯å£ 9008 1vim &#x2F;docker-config&#x2F;php-fpm_config&#x2F;zz-docker.conf æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼Œ 12345[global]daemonize &#x3D; no[www]listen &#x3D; [::]:9008 è¿è¡Œ docker ä¸­çš„ php æœåŠ¡12&#x2F;&#x2F; è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºcentos7ç³»ç»Ÿä¸»æœºä¸‹æœ‰selinuxçš„å­˜åœ¨ï¼Œå¯¼è‡´ç”¨æˆ·æ“ä½œæƒé™ä¸¥æ ¼å—åˆ°é™åˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦åŠ ä¸Š--privileged&#x3D;trueè¿™ä¸€é¡¹ï¼Œå¦‚æœæ˜¯å…¶ä»–å®¿ä¸»æœºçš„è¯ï¼Œå¯èƒ½ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚ä¸åŠ ä¹Ÿå¯ä»¥ã€‚docker run --name php -v &#x2F;docker-www:&#x2F;home&#x2F;wwwroot -v &#x2F;docker-config&#x2F;php_config&#x2F;php.ini:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;php&#x2F;php.ini -v &#x2F;docker-config&#x2F;php-fpm_config&#x2F;zz-docker.conf:&#x2F;usr&#x2F;local&#x2F;etc&#x2F;php-fpm.d&#x2F;zz-docker.conf --privileged&#x3D;true -p 9008:9000 -d php:7.1.11-fpm ä¿®æ”¹ docker å†…éƒ¨çš„ç”¨æˆ·æƒé™ã€‚ï¼ˆè¿™ä¸€æ­¥è²Œä¼¼æ²¡ä»€ä¹ˆæ„ä¹‰ï¼‰ 123&#x2F;&#x2F; è®¾ç½®æˆåˆšæ‰æˆ‘ä»¬çš„ç”¨æˆ·ç»„docker exec -it php sed -i &quot;s&#x2F;33&#x2F;2017&#x2F;g&quot; &#x2F;etc&#x2F;passwddocker exec -it php sed -i &quot;s&#x2F;33&#x2F;2017&#x2F;g&quot; &#x2F;etc&#x2F;group ä» hub.docker ä¸­æ‹‰å– nginx é•œåƒè¿™é‡Œæˆ‘ä»¬å°±ä¸åšç‰ˆæœ¬çš„é€‰æ‹©äº†ï¼Œæˆ‘ä»¬ç›´æ¥æ‹‰å»ï¼Œé»˜è®¤çš„ tag ä¼šæ˜¯ latestï¼Œæœ€æ–°ç‰ˆæœ¬ã€‚ 1docker pull nginx ç„¶åæˆ‘ä»¬åœ¨/docker-config/nginx_config/é‡Œé¢æ–°å¢ä¸€ä¸ª nginx çš„é¡¹ç›®é…ç½® 1234567891011121314151617181920server &#123; listen 80; server_name localhost.com; root /home/wwwroot; index index.html index.htm index.php; error_page 404 /404.html; error_page 500 502 503 504 /50x.html; # è‡³äºphp:9008ä¸ºä»€ä¹ˆæ˜¯9008ç«¯å£å‘¢ï¼Œæ˜¯ä¸ºäº†å¯èƒ½ä¸ºæœ¬æœºä¹Ÿæœ‰phpæœåŠ¡ï¼Œä¸ºäº†ä¸å’Œå®¿ä¸»æœºçš„phpæœåŠ¡å†²çªã€‚ # è‡³äºè¿™ä¸ªphp:9008è¿™ä¸ªæ˜¯å“ªé‡Œæ¥çš„phpå‘¢ï¼Œç­‰ä¸‹å¯åŠ¨nginxæœåŠ¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šç”¨--linké€‰é¡¹æŠŠnginxå®¹å™¨å’Œphpå®¹å™¨è¿æ¥èµ·æ¥ï¼Œç”¨åˆ°çš„åˆ«åå°±å«phpï¼Œè¿™ä¸ªphpä¼šè§£æç§°ä¸ºphpå®¹å™¨çš„ipåœ°å€ã€‚ location ~ \\.php$ &#123; fastcgi_pass php:9008; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; &#125;&#125; è¿è¡Œ docker ä¸­çš„ nginx æœåŠ¡1docker run --name nginx -v &#x2F;docker-www:&#x2F;home&#x2F;wwwroot -v &#x2F;docker-config&#x2F;nginx_config:&#x2F;etc&#x2F;nginx&#x2F;conf.d --privileged&#x3D;true --link&#x3D;php:php -p 80:80 -d nginx ä¿®æ”¹ docker å†…éƒ¨çš„ç”¨æˆ·æƒé™ã€‚ï¼ˆåŒä¸Šï¼‰ 123&#x2F;&#x2F; è®¾ç½®æˆåˆšæ‰æˆ‘ä»¬çš„ç”¨æˆ·ç»„docker exec -it nginx sed -i &quot;s&#x2F;104:107&#x2F;docker-user:2017&#x2F;g&quot; &#x2F;etc&#x2F;passwddocker exec -it nginx sed -i &quot;s&#x2F;107&#x2F;2017&#x2F;g&quot; &#x2F;etc&#x2F;group","categories":[{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/categories/Docker/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/tags/Docker/"},{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"}]},{"title":"Centos7å®‰è£…swoole2.xåç¨‹ç³»åˆ—","slug":"linux-make-swoole2","date":"2017-09-08T02:47:00.000Z","updated":"2021-03-20T16:25:01.808Z","comments":true,"path":"2017/09/08/linux-make-swoole2/","link":"","permalink":"http://blog.crazylaw.cn/2017/09/08/linux-make-swoole2/","excerpt":"è¯´æ˜å¯¹äºä¸€ä¸ªåˆæ ¼çš„ php åç«¯å¼€å‘è€…è€Œè¨€ï¼Œswoole çš„çŸ¥ååº¦ï¼Œä¼°è®¡æ˜¯å¤§å®¶éƒ½çŸ¥é“çš„ï¼Œswoole åˆ†ä¸º 2 ä¸ªç³»åˆ—ï¼Œä¸€ä¸ªæ˜¯1.9.xç³»åˆ—ï¼Œä¸€ä¸ªæ˜¯2.xç³»åˆ—ï¼Œä¸¤ä¸ªç³»åˆ—çš„åŒºåˆ«åœ¨äº1.9ç³»åˆ—æ˜¯åŸ swoole æˆå‘˜ç ”å‘çš„ä¸»åˆ†æ”¯ï¼Œ2.xç³»åˆ—æ˜¯ç”±è…¾è®¯æˆå‘˜ç ”å‘çš„å‰¯åˆ†æ”¯ã€‚1.9.xç³»åˆ—åº•å±‚åŸç”Ÿä¸æ”¯æŒåç¨‹çš„æ¦‚å¿µï¼Œè·Ÿç€ php åŸç”Ÿæ€èµ°ï¼Œä½†æ˜¯2.xåº•å±‚é‡‡ç”¨çš„æ˜¯åç¨‹çš„æ¦‚å¿µè¿›è¡Œç ”å‘ï¼ŒåŸºæœ¬ä¸Šéœ€è¦ç”¨åˆ°ç½‘ç»œ io çš„åœ°æ–¹åœ¨ç‰¹å®šçš„æƒ…å†µä¸‹éƒ½ä¼šå»è§¦å‘åç¨‹ï¼Œè®°ä½å½“å‰çš„VM stackçš„ä¿¡æ¯ï¼Œç„¶åé€šè¿‡Eventloopäº‹ä»¶å»å¤„ç†åˆ«çš„è¯·æ±‚ï¼Œå½¢æˆä¸€ä¸ªç›¸å¯¹äºåŸç”Ÿæ€çš„é˜»å¡çš„æ‰§è¡Œè¿‡ç¨‹æ¥è¯´ï¼Œè¿™ç§éé˜»å¡çš„å¤„ç†æ–¹å¼ï¼ŒæŠŠ 1+2 = 3 çš„ IO æ—¶é—´å˜æˆäº† max(1,2) =2ã€‚ä»è€Œåœ¨é«˜å¹¶å‘çš„è¯·æ±‚ä¸‹ï¼Œå¯ä»¥æ›´å¥½çš„æ‰¿è½½æ›´å¤šçš„è¯·æ±‚ã€‚ ä¹‹å‰æˆ‘æœ‰è¿‡ä¸€ç¯‡æ–‡ç« è¯´çš„å°±æ˜¯å®‰è£… v2.0.5 çš„ã€‚ä½†æ˜¯ç°åœ¨é‡æ–°è£…ä¸€æ¬¡ï¼Œè¯´æ˜ä¸€ä¸‹ã€‚ ä¸‹è½½ git1git clone -b v.2.0.9 https:&#x2F;&#x2F;github.com&#x2F;swoole&#x2F;swoole-src.git","text":"è¯´æ˜å¯¹äºä¸€ä¸ªåˆæ ¼çš„ php åç«¯å¼€å‘è€…è€Œè¨€ï¼Œswoole çš„çŸ¥ååº¦ï¼Œä¼°è®¡æ˜¯å¤§å®¶éƒ½çŸ¥é“çš„ï¼Œswoole åˆ†ä¸º 2 ä¸ªç³»åˆ—ï¼Œä¸€ä¸ªæ˜¯1.9.xç³»åˆ—ï¼Œä¸€ä¸ªæ˜¯2.xç³»åˆ—ï¼Œä¸¤ä¸ªç³»åˆ—çš„åŒºåˆ«åœ¨äº1.9ç³»åˆ—æ˜¯åŸ swoole æˆå‘˜ç ”å‘çš„ä¸»åˆ†æ”¯ï¼Œ2.xç³»åˆ—æ˜¯ç”±è…¾è®¯æˆå‘˜ç ”å‘çš„å‰¯åˆ†æ”¯ã€‚1.9.xç³»åˆ—åº•å±‚åŸç”Ÿä¸æ”¯æŒåç¨‹çš„æ¦‚å¿µï¼Œè·Ÿç€ php åŸç”Ÿæ€èµ°ï¼Œä½†æ˜¯2.xåº•å±‚é‡‡ç”¨çš„æ˜¯åç¨‹çš„æ¦‚å¿µè¿›è¡Œç ”å‘ï¼ŒåŸºæœ¬ä¸Šéœ€è¦ç”¨åˆ°ç½‘ç»œ io çš„åœ°æ–¹åœ¨ç‰¹å®šçš„æƒ…å†µä¸‹éƒ½ä¼šå»è§¦å‘åç¨‹ï¼Œè®°ä½å½“å‰çš„VM stackçš„ä¿¡æ¯ï¼Œç„¶åé€šè¿‡Eventloopäº‹ä»¶å»å¤„ç†åˆ«çš„è¯·æ±‚ï¼Œå½¢æˆä¸€ä¸ªç›¸å¯¹äºåŸç”Ÿæ€çš„é˜»å¡çš„æ‰§è¡Œè¿‡ç¨‹æ¥è¯´ï¼Œè¿™ç§éé˜»å¡çš„å¤„ç†æ–¹å¼ï¼ŒæŠŠ 1+2 = 3 çš„ IO æ—¶é—´å˜æˆäº† max(1,2) =2ã€‚ä»è€Œåœ¨é«˜å¹¶å‘çš„è¯·æ±‚ä¸‹ï¼Œå¯ä»¥æ›´å¥½çš„æ‰¿è½½æ›´å¤šçš„è¯·æ±‚ã€‚ ä¹‹å‰æˆ‘æœ‰è¿‡ä¸€ç¯‡æ–‡ç« è¯´çš„å°±æ˜¯å®‰è£… v2.0.5 çš„ã€‚ä½†æ˜¯ç°åœ¨é‡æ–°è£…ä¸€æ¬¡ï¼Œè¯´æ˜ä¸€ä¸‹ã€‚ ä¸‹è½½ git1git clone -b v.2.0.9 https:&#x2F;&#x2F;github.com&#x2F;swoole&#x2F;swoole-src.git è¿›å…¥ç›®å½• 1cd swoole-src åˆ©ç”¨ phpize æå–å‡ºç¼–è¯‘æ–‡ä»¶ 1phpize å¼€å§‹ç¼–è¯‘ï¼Œæ³¨æ„éœ€è¦å¼€å¯å‡ é¡¹å¿…é¡»çš„ä¸œè¥¿ 1.&#x2F;configure --enable-coroutine --enable-openssl è¿™é‡Œæˆ‘éœ€è¦å¼€å¯å†™åç¨‹å’Œ ssl è¯ä¹¦ ç„¶åç¼–è¯‘å®Œæ¯•ä¹‹åã€‚ æ·»åŠ åˆ° php.ini é‡Œé¢å³å¯ã€‚ å¼€å¯ swoole é«˜æ€§èƒ½å¼€å‘ä¹‹æ—… è®°ä½æ£€æŸ¥ swoole æ˜¯å¦å®‰è£…äº† 1php -m | grep swoole æŸ¥çœ‹ swoole ç‰ˆæœ¬ 1php --ri swoole å¼‚æ­¥ redis ç¼–è¯‘æ·»åŠ 1--enable-async-redis éœ€è¦å®‰è£…ä¾èµ–ä¸€ä¸ªå®˜æ–¹çš„ hredis çš„åŠ¨æ€ so åº“ hiredis ä¸‹è½½åœ°å€ï¼šhttps://github.com/redis/hiredis/releases å®‰è£…å®Œæ¯•ä¹‹å,å¦‚æœ swoole ç¼–è¯‘å®Œæˆï¼Œä¹‹åï¼Œå¦‚æœå‡ºç°äº†å¦‚ä¸‹é—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨ ldconfigï¼Œæ·»åŠ æœç´¢åŠ¨æ€åº“ç›®å½• libhiredis.so.0.13: cannot open shared object file: No such file or directory in Unknown on line 0ï¼Œ 1231. vim &#x2F;etc&#x2F;ld.so.conf2. æ·»åŠ  &#x2F;usr&#x2F;local&#x2F;lib3. sudo ldconfig ç„¶åå†é‡æ–°ç¼–è¯‘ 12make clean&#x2F;&#x2F; make &amp;&amp; make install","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"},{"name":"PHP","slug":"Linux/PHP","permalink":"http://blog.crazylaw.cn/categories/Linux/PHP/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"Swoole","slug":"Swoole","permalink":"http://blog.crazylaw.cn/tags/Swoole/"}]},{"title":"linux-make-tcpdump","slug":"linux-make-tcpdump","date":"2017-08-22T10:06:24.000Z","updated":"2021-03-20T16:25:01.809Z","comments":true,"path":"2017/08/22/linux-make-tcpdump/","link":"","permalink":"http://blog.crazylaw.cn/2017/08/22/linux-make-tcpdump/","excerpt":"è¯´æ˜TCPDUMP å¯ä»¥å¸®å†™æˆ‘ä»¬æŠ“åŒ…ï¼Œç›¸å½“äº window ä¸‹çš„wiresharkï¼Œä¸ºäº†æˆ‘ä»¬æ›´å¥½çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬æŠŠ tcpdump ä¹Ÿå®‰è£…äº†ã€‚ ä¸‹è½½ tcpdump-å›½å†…é•œåƒ æ‰¾åˆ°æœ€æ–°ç‰ˆ,å®‰è£… tcpdump éœ€è¦æŠŠ libpcap ä¹Ÿå®‰è£…äº†. å®‰è£… libpcapä¸‹è½½ 1cd &#x2F;usr&#x2F;local&#x2F;src &amp;&amp; sudo mkdir libpcap &amp;&amp; sudo wget http:&#x2F;&#x2F;www.tcpdump.org&#x2F;release&#x2F;libpcap-1.8.1.tar.gz &amp;&amp; sudo tar -zxvf &amp;&amp; sudo tar -zxvf libpcap-1.8.1.tar.gz &amp;&amp; cd libpcap-1.8.1","text":"è¯´æ˜TCPDUMP å¯ä»¥å¸®å†™æˆ‘ä»¬æŠ“åŒ…ï¼Œç›¸å½“äº window ä¸‹çš„wiresharkï¼Œä¸ºäº†æˆ‘ä»¬æ›´å¥½çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬æŠŠ tcpdump ä¹Ÿå®‰è£…äº†ã€‚ ä¸‹è½½ tcpdump-å›½å†…é•œåƒ æ‰¾åˆ°æœ€æ–°ç‰ˆ,å®‰è£… tcpdump éœ€è¦æŠŠ libpcap ä¹Ÿå®‰è£…äº†. å®‰è£… libpcapä¸‹è½½ 1cd &#x2F;usr&#x2F;local&#x2F;src &amp;&amp; sudo mkdir libpcap &amp;&amp; sudo wget http:&#x2F;&#x2F;www.tcpdump.org&#x2F;release&#x2F;libpcap-1.8.1.tar.gz &amp;&amp; sudo tar -zxvf &amp;&amp; sudo tar -zxvf libpcap-1.8.1.tar.gz &amp;&amp; cd libpcap-1.8.1 ç¼–è¯‘ 1sudo .&#x2F;configure å‘ç°å‘Šè¯‰æˆ‘ä»¬éœ€è¦å®‰è£… flex æˆ‘çš„ yum ä»“åº“æ²¡æœ‰ flexï¼Œæ‰€ä»¥å°±éœ€è¦å»æ‰¾äº†ã€‚æ‰¾äº†å‡ ä¸ªåœ°æ–¹ä¹‹åï¼Œå‘ç°åªæœ‰ github æœ‰æœ€æ–°çš„ç‰ˆæœ¬äº†ã€‚ 1git clone https:&#x2F;&#x2F;github.com&#x2F;westes&#x2F;flex.git è¿›å…¥åˆ° flex ç›®å½• å®‰è£… flex 1sudo .&#x2F;autogen.sh å‘ç°åˆæœ‰å®‰è£…ä¾èµ–äº†ï¼Œè¯´æˆ‘æ²¡æœ‰ libtoolize å¥½çš„ï¼Œæˆ‘åˆè¦å»æ‰¾äº† ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªå›½å†… gun åº“ å›½å†… GUN åº“ åŸºæœ¬æ‰€æœ‰ GUN åº“éƒ½å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ç›¸å…³çš„ä¿¡æ¯ æ‰¾åˆ° libtoolize 1sudo mkdir -p &#x2F;usr&#x2F;local&#x2F;src&#x2F;libtoolize &amp;&amp; sudo wget http:&#x2F;&#x2F;ftp.gnu.org&#x2F;gnu&#x2F;libtool&#x2F;libtool-2.4.tar.gz &amp;&amp; cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;libtoolize&#x2F;libtool-2.4","categories":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/"},{"name":"ç½‘ç»œ","slug":"åè®®/ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C/"},{"name":"Linux","slug":"åè®®/ç½‘ç»œ/Linux","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/tags/%E7%BD%91%E7%BB%9C/"},{"name":"TcpDump","slug":"TcpDump","permalink":"http://blog.crazylaw.cn/tags/TcpDump/"}]},{"title":"Centos7ä¸‹è‡ªè¡Œç¼–è¯‘PHP","slug":"linux-make-php","date":"2017-08-16T04:02:00.000Z","updated":"2021-03-20T16:25:01.808Z","comments":true,"path":"2017/08/16/linux-make-php/","link":"","permalink":"http://blog.crazylaw.cn/2017/08/16/linux-make-php/","excerpt":"è¯´æ˜ä¸ºäº†æ»¡è¶³æˆ‘çš„ä¸€ç¯‡åšæ–‡ï¼Œæˆ‘å•ç‹¬æŠ½å‡ºæ¥å†™ä¸€ç¯‡ PHP çš„ç¼–è¯‘ç¯‡ ä¸‹è½½æœ€å¥½ä¸è¦å» github ä¸Šä¸‹è½½ï¼Œå› ä¸ºä½ ä¸çŸ¥é“å“ªä¸€ä¸ªæ˜¯ç¨³å®šç‰ˆï¼Œæˆ‘ä»¬æœ€å¥½å»å®˜ç½‘å¯»æ‰¾æœ€æ–°çš„ç¨³å®šç‰ˆä¸‹è½½ å®˜ç½‘ä¸‹è½½ 1234567891011cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;sudo mkdir phpcd phpwget xxxxx.php -O php-xx.tar.gztar -zxvf php-xx.tar.gzcd php-xx","text":"è¯´æ˜ä¸ºäº†æ»¡è¶³æˆ‘çš„ä¸€ç¯‡åšæ–‡ï¼Œæˆ‘å•ç‹¬æŠ½å‡ºæ¥å†™ä¸€ç¯‡ PHP çš„ç¼–è¯‘ç¯‡ ä¸‹è½½æœ€å¥½ä¸è¦å» github ä¸Šä¸‹è½½ï¼Œå› ä¸ºä½ ä¸çŸ¥é“å“ªä¸€ä¸ªæ˜¯ç¨³å®šç‰ˆï¼Œæˆ‘ä»¬æœ€å¥½å»å®˜ç½‘å¯»æ‰¾æœ€æ–°çš„ç¨³å®šç‰ˆä¸‹è½½ å®˜ç½‘ä¸‹è½½ 1234567891011cd &#x2F;usr&#x2F;local&#x2F;src&#x2F;sudo mkdir phpcd phpwget xxxxx.php -O php-xx.tar.gztar -zxvf php-xx.tar.gzcd php-xx åœ¨è¿™é‡Œï¼Œæˆ‘çš„ php ç‰ˆæœ¬æ˜¯ php-7.1.8 ä¿®æ”¹æºç ç›®å½•æ‰€æœ‰è€… 1chown -R caiwh:caiwh php-7.1.8 è¿›å…¥ç›®å½• 1cd php-7.1.8 æœ€å°åŒ–å®‰è£…çš„æ¨¡å— curlæ‰©å±• (ä½¿ç”¨ curl çš„ API) â€“with-curl fpmæ‰©å±• ï¼ˆç®¡ç† PHP è¿›ç¨‹çš„æœåŠ¡ï¼‰ â€“enable-fpm opensslæ‰©å±• (æ‰“å¼€ ssl æœåŠ¡ï¼Œå¾ˆå¤šæœåŠ¡éƒ½ä¾èµ–è¿™ä¸ªï¼Œå¿…é¡»å®‰è£…ï¼Œä¾‹å¦‚ï¼šcomposerã€mysql çš„ ssl ç­‰ç­‰) â€“with-openssl mysqlndæ‰©å±• ï¼ˆmysql native driveï¼‰ â€“enable-mysqlnd â€“mysql-pdo-mysql=mysqlnd gdæ‰©å±• ï¼ˆå¯ä»¥æ“ä½œå›¾ç‰‡ï¼‰ â€“enable-gd â€“with-jpeg-dir (GD åº“é»˜è®¤ä¸æ”¯æŒ jpeg æ ¼å¼ï¼Œéœ€è¦é¢å¤–çš„æ·»åŠ ) zlibæ‰©å±• (å‹ç¼©è§£å‹ç¼©æœåŠ¡) â€“enable-zlib â€“with-zlib â€“with-libzip mbæ‰©å±• (å¯ä»¥ä½¿ç”¨äº mb ç³»åˆ—çš„å‡½æ•°ï¼Œä¾‹å¦‚æ±‰å­—çš„æˆªæ­¢ä¹‹ç±»çš„) â€“enable-mbstring socketæ‰©å±• ï¼ˆå¯ä»¥ä½¿ç”¨ socket ç³»åˆ—çš„å‡½æ•°ï¼‰ â€“enable-sockets x-debugæ‰©å±• ï¼ˆæ–­ç‚¹è°ƒè¯•ç”¨ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸åº”è¯¥å®‰è£…è¿™ä¸ªæ‰©å±•ï¼Œå› ä¸ºä¼šæ‹–åº•æ€§èƒ½ï¼‰ â€“enable-debug readlineæ‰©å±• ï¼ˆå¯ä»¥åœ¨ CLI æ¨¡å¼ä¸‹ç›´æ¥äº¤äº’ï¼Œä¾‹å¦‚ php -aï¼‰ â€“enable-readline æœ€åçš„ç¼–è¯‘å‚æ•°1.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;php --with-config-file-path&#x3D;&#x2F;usr&#x2F;local&#x2F;php&#x2F;etc --with-config-file-scan-dir&#x3D;&#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php.d --enable-mysqlnd --with-pdo-mysql&#x3D;mysqlnd --with-gd --with-jpeg-dir --with-curl --with-readline --with-openssl --with-zlib --with-libzip --enable-mbstring --enable-sockets --enable-bcmath --enable-fpm --with-fpm-user&#x3D;phper --with-fpm-group&#x3D;phper å¥½çš„ï¼Œå¼€å§‹è¡¥ç±»åº“çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå‘Šè¯‰æˆ‘æ²¡æœ‰ libxm2ï¼Œæ‰€ä»¥æˆ‘åˆè¦å»å®‰è£…äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å†æ¬¡ç”¨ yum å®‰è£… è®©æˆ‘ä»¬å…ˆçœ‹çœ‹æˆ‘ä»¬çš„æºæ˜¯å¦æœ‰è¿™äº›åŒ… 1yum search libxml2 OKï¼Œå¼€å§‹å®‰è£… 1sudo yum install libxml2-devel libxml2 -y å†æ¬¡ç¼–è¯‘ã€‚ å¥½çš„ï¼Œæˆ‘è¿˜æ²¡æœ‰å®‰è£… libcurl ç±»ï¼ŒåŒæ ·çš„åšæ³• 1sudo yum install libcurl-devel libcurl -y å†æ¬¡ç¼–è¯‘ã€‚ è¿˜æœ‰ä¸€äº›é—®é¢˜ï¼Œé’ˆå¯¹å¯¹åº”çš„ç±»åº“å®‰è£…å¯¹åº”çš„ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—å‡ºæ¥çš„ï¼Œä¸€æ¬¡è¿‡å†™å‡ºæ¥äº† 1sudo yum install libjpeg-turbo-devel libjpeg-turbo libpng-devel libpng readline-devel readline -y å†æ¬¡ç¼–è¯‘ã€‚ ç¼–è¯‘å®Œæˆï¼ï¼ å®‰è£…1sudo make &amp;&amp; make install å®‰è£…çš„é€Ÿåº¦å–å†³ä½ çš„æœåŠ¡å™¨é…ç½®ã€‚ â€¦.Loadingâ€¦.â€¦.Loadingâ€¦.â€¦.Loadingâ€¦. â€¦.Waitingâ€¦.â€¦.Waitingâ€¦.â€¦.Waitingâ€¦. å®‰è£…å®Œæ¯•ï¼ï¼ é…ç½® php-fpm1cd sapi&#x2F;fpm å¼€å§‹è°ƒè¯• php-fpm 1.&#x2F;php-fpm -h è®²ä¸€ä¸‹å‡ ä¸ªé‡è¦çš„å‚æ•° -c æŒ‡å®š php.ini é…ç½®æ–‡ä»¶çš„è·¯å¾„ -y æŒ‡å®š php-fpm.conf é…ç½®æ–‡ä»¶çš„è·¯å¾„ -n ä¸ç”¨ php.ini è¿è¡Œ 1sudo .&#x2F;php-fpm -t å¥½çš„ï¼Œæˆ‘ä»¬å‘ç°æµ‹è¯•å¤±è´¥ï¼Œè¯´æ˜¯æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å»è¿™ä¸ªç›®å½•ä¸‹ï¼Œå‘ç°åˆä¸€ä¸ªæ–‡ä»¶å« php-fpm.conf.default copy ä¸€ä»½å‡ºæ¥ï¼ŒæŠŠ default å»æ‰ 1sudo cp &#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm.conf.default &#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm.conf å¼€å¯ pid æ–‡ä»¶ è¯¦ç»†çš„é…ç½®æ–‡ä»¶ä¹Ÿè¦å¼„ä¸€ä»½å‡ºæ¥ 1sudo cp &#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf.default &#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf æµ‹è¯•é€šè¿‡ã€‚ å› ä¸ºæˆ‘ä»¬ç”¨äº† user=phper å’Œ group=phper çš„ç”¨æˆ·å»å¯åŠ¨ php-fpm çš„ worker è¿›ç¨‹ã€‚æ‰€ä»¥ï¼Œæˆ‘è¦åˆ›å»ºè¿™ä¹ˆä¸€ä¸ªä¸å¯ç™»å½•çš„ç”¨æˆ· 1useradd -M -s &#x2F;sbin&#x2F;nologin -U phper OKã€‚ å¯åŠ¨æˆåŠŸã€‚å®Œç¾ã€‚ æŠŠæœåŠ¡åŠ å…¥åˆ° Systemctlé¦–å…ˆï¼Œéœ€è¦è¿™ä¹ˆä¸€ä¸ª shell è„šæœ¬ 123cd &#x2F;usr&#x2F;local&#x2F;php&#x2F;sbin&#x2F;sudo vim php-fpm.sh 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152#! /bin/sh### BEGIN INIT INFO# Provides: caiwh[471113744@qq.com]# Short-Description: starts php-fpm# Description: starts the PHP FastCGI Process Manager daemon### END INIT INFOprefix=/usr/local/phpexec_prefix=$&#123;prefix&#125;php_fpm_BIN=$&#123;exec_prefix&#125;/sbin/php-fpmphp_fpm_CONF=$&#123;prefix&#125;/etc/php-fpm.confphp_fpm_PID=$&#123;prefix&#125;/var/run/php-fpm.pidphp_opts=\"--fpm-config $php_fpm_CONF --pid $php_fpm_PID\"wait_for_pid () &#123; try=0 while test $try -lt 35 ; do case \"$1\" in 'created') if [ -f \"$2\" ] ; then try='' break fi ;; 'removed') if [ ! -f \"$2\" ] ; then try='' break fi ;; esac echo -n . try=`expr $try + 1` sleep 1 done&#125;case \"$1\" in start) echo -n \"Starting php-fpm \" $php_fpm_BIN --daemonize $php_opts if [ \"$?\" != 0 ] ; then echo \" failed\" exit 1 fi wait_for_pid created $php_fpm_PID if [ -n \"$try\" ] ; then echo \" failed\" exit 1 else echo \" done\" fi ;; stop) echo -n \"Gracefully shutting down php-fpm \" if [ ! -r $php_fpm_PID ] ; then echo \"warning, no pid file found - php-fpm is not running ?\" exit 1 fi kill -QUIT `cat $php_fpm_PID` wait_for_pid removed $php_fpm_PID if [ -n \"$try\" ] ; then echo \" failed. Use force-quit\" exit 1 else echo \" done\" fi ;; status) if [ ! -r $php_fpm_PID ] ; then echo \"php-fpm is stopped\" exit 0 fi PID=`cat $php_fpm_PID` if ps -p $PID | grep -q $PID; then echo \"php-fpm (pid $PID) is running...\" else echo \"php-fpm dead but pid file exists\" fi ;; force-quit) echo -n \"Terminating php-fpm \" if [ ! -r $php_fpm_PID ] ; then echo \"warning, no pid file found - php-fpm is not running ?\" exit 1 fi kill -TERM `cat $php_fpm_PID` wait_for_pid removed $php_fpm_PID if [ -n \"$try\" ] ; then echo \" failed\" exit 1 else echo \" done\" fi ;; restart) $0 stop $0 start ;; reload) echo -n \"Reload service php-fpm \" if [ ! -r $php_fpm_PID ] ; then echo \"warning, no pid file found - php-fpm is not running ?\" exit 1 fi kill -USR2 `cat $php_fpm_PID` echo \" done\" ;; configtest) $php_fpm_BIN -t ;; *) echo \"Usage: $0 &#123;start|stop|force-quit|restart|reload|status|configtest&#125;\" exit 1 ;;esac ä¿å­˜é€€å‡ºï¼Œç„¶åä¿®æ”¹æƒé™ 1sudo chmod 755 php-fpm.sh ç„¶åå°±å¯ä»¥å†™ systemctl çš„ service äº†ã€‚ 1sudo vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;php-fpm.service æŠŠä»¥ä¸‹ä»£ç æ‹·è´è¿›å» 123456789101112131415[Unit]Description&#x3D;Belong caiwh - php-fpmDocumentation&#x3D; &#x2F;usr&#x2F;local&#x2F;php&#x2F;etc&#x2F;php-fpm&#x2F;After&#x3D;network.target remote-fs.target nss-lookup.target[Service]Type&#x3D;forkingExecStartPre&#x3D;&#x2F;usr&#x2F;local&#x2F;php&#x2F;sbin&#x2F;php-fpm.sh configtestExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;php&#x2F;sbin&#x2F;php-fpm.sh startExecReload&#x3D;&#x2F;usr&#x2F;local&#x2F;php&#x2F;sbin&#x2F;php-fpm.sh restartExecStop&#x3D;&#x2F;usr&#x2F;local&#x2F;php&#x2F;sbin&#x2F;php-fpm.sh stopPrivateTmp&#x3D;true[Install]WantedBy&#x3D;multi-user.target 1systemctl daemon-reload å®Œæˆ systemctl é‡å¯ ç„¶åå°±å¯ä»¥ç”¨ 123#1.systemctl start php-fpm å¯åŠ¨æœåŠ¡#2.systemctl stop php-fpm åœæ­¢æœåŠ¡#3.systemctl restart php-fpm é‡å¯æœåŠ¡ å®Œç¾ç»“åˆ","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"},{"name":"PHP","slug":"Linux/PHP","permalink":"http://blog.crazylaw.cn/categories/Linux/PHP/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"ç¼–è¯‘å®‰è£…","slug":"ç¼–è¯‘å®‰è£…","permalink":"http://blog.crazylaw.cn/tags/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"}]},{"title":"SystemctlæœåŠ¡ç®¡ç†è½¯ä»¶","slug":"linux-systemctl","date":"2017-08-16T03:21:00.000Z","updated":"2021-03-20T16:25:01.810Z","comments":true,"path":"2017/08/16/linux-systemctl/","link":"","permalink":"http://blog.crazylaw.cn/2017/08/16/linux-systemctl/","excerpt":"è¯´æ˜ç”±äºç‰¹æ®ŠåŸå› !!åˆšæ‰å†™çš„æ–‡ç« æ²¡ä¿å­˜ä¸‹æ¥!!!æ¥ä¸‹æ¥ç®€å†™.!!! Centos7 å’Œ Centos7 ä¹‹å‰çš„ç‰ˆæœ¬æœ‰å‡ ç‚¹æ¯”è¾ƒé‡è¦çš„ä¸åŒ,ä¸€ä¸ªæ˜¯ firewall-cmd ä»£æ›¿äº† iptablesï¼Œç„¶åå°±æ˜¯ systemctl ä»£æ›¿äº† serviceã€‚è¿™é‡Œï¼Œç°åœ¨æˆ‘å°±å†™ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ systemctl ç®¡ç†æœåŠ¡ã€‚ æœåŠ¡çš„åŸºæœ¬å‘½ä»¤ systemctl status xx ï¼ˆæœåŠ¡çŠ¶æ€ï¼‰ systemctl start xx ï¼ˆæœåŠ¡å¯åŠ¨ï¼‰ systemctl stop xx ï¼ˆåœæ­¢æœåŠ¡ï¼‰ systemctl restart xxï¼ˆé‡å¯æœåŠ¡ï¼‰ systemctl enable xx ï¼ˆæœåŠ¡éšå¼€æœºå¯åŠ¨ï¼‰ systemctl disable xx ï¼ˆæœåŠ¡å–æ¶ˆéšå¯åŠ¨ï¼‰ systemctl cat xx ï¼ˆæŸ¥çœ‹æœåŠ¡çš„é…ç½®ä¿¡æ¯ï¼‰ systemctl daemon-reload (æ¯æ¬¡ä¿®æ”¹äº†ä¸€ä¸ª service é…ç½®æˆ–è€…æ–°å¢äº†ä¸€ä¸ªé…ç½®ï¼Œéƒ½éœ€è¦æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œè®© systemctl æœåŠ¡é‡å¯ï¼Œç„¶åé‡æ–°åŠ è½½æœåŠ¡é…ç½®æ–‡ä»¶) systemctl list-dependencies [target name]ï¼ˆæŸ¥çœ‹ä¾èµ–æ ‘çŠ¶å›¾ï¼Œååˆ†çš„ç›´è§‚å¥½ç”¨ï¼‰","text":"è¯´æ˜ç”±äºç‰¹æ®ŠåŸå› !!åˆšæ‰å†™çš„æ–‡ç« æ²¡ä¿å­˜ä¸‹æ¥!!!æ¥ä¸‹æ¥ç®€å†™.!!! Centos7 å’Œ Centos7 ä¹‹å‰çš„ç‰ˆæœ¬æœ‰å‡ ç‚¹æ¯”è¾ƒé‡è¦çš„ä¸åŒ,ä¸€ä¸ªæ˜¯ firewall-cmd ä»£æ›¿äº† iptablesï¼Œç„¶åå°±æ˜¯ systemctl ä»£æ›¿äº† serviceã€‚è¿™é‡Œï¼Œç°åœ¨æˆ‘å°±å†™ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ systemctl ç®¡ç†æœåŠ¡ã€‚ æœåŠ¡çš„åŸºæœ¬å‘½ä»¤ systemctl status xx ï¼ˆæœåŠ¡çŠ¶æ€ï¼‰ systemctl start xx ï¼ˆæœåŠ¡å¯åŠ¨ï¼‰ systemctl stop xx ï¼ˆåœæ­¢æœåŠ¡ï¼‰ systemctl restart xxï¼ˆé‡å¯æœåŠ¡ï¼‰ systemctl enable xx ï¼ˆæœåŠ¡éšå¼€æœºå¯åŠ¨ï¼‰ systemctl disable xx ï¼ˆæœåŠ¡å–æ¶ˆéšå¯åŠ¨ï¼‰ systemctl cat xx ï¼ˆæŸ¥çœ‹æœåŠ¡çš„é…ç½®ä¿¡æ¯ï¼‰ systemctl daemon-reload (æ¯æ¬¡ä¿®æ”¹äº†ä¸€ä¸ª service é…ç½®æˆ–è€…æ–°å¢äº†ä¸€ä¸ªé…ç½®ï¼Œéƒ½éœ€è¦æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œè®© systemctl æœåŠ¡é‡å¯ï¼Œç„¶åé‡æ–°åŠ è½½æœåŠ¡é…ç½®æ–‡ä»¶) systemctl list-dependencies [target name]ï¼ˆæŸ¥çœ‹ä¾èµ–æ ‘çŠ¶å›¾ï¼Œååˆ†çš„ç›´è§‚å¥½ç”¨ï¼‰ æ·»åŠ æœåŠ¡æˆ‘ä»¬çš„æœåŠ¡é…ç½®æ–‡ä»¶å­˜æ”¾çš„è·¯å¾„ä¸º 1&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F; åœ¨è¿™ä¸ªæ–‡ä»¶ä¸‹ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™äº›æœåŠ¡ï¼Œä½†æ˜¯ä½ çš„ nginx æœåŠ¡ä¸æ˜¯ yum ç­‰è½¯ä»¶ç®¡ç†å·¥å…·å®‰è£…çš„è¯ï¼Œè¿™é‡Œæ˜¯ä¸ä¼šå­˜åœ¨nginx.serviceè¿™ä¸ªæ–‡ä»¶çš„ï¼Œè¿™ä¸ªæ–‡ä»¶éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ ã€‚ è¿™é‡Œï¼Œä»¥æ·»åŠ  nginx æœåŠ¡åˆ° systemctl ä¸ºä¾‹å­ã€‚ 1sudo vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service ä»¥ä¸‹æ˜¯æˆ‘ nginx çš„é…ç½®æ–‡ä»¶çš„ä¿¡æ¯ 123456789101112131415161718192021[Unit]Description=Belong caiwh - nginx - high performance web serverDocumentation= ----&gt; http://nginx.org/en/docs/After=network.target remote-fs.target nss-lookup.target[Service]Type=forkingPIDFile=/var/run/nginx.pidExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.confExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.confExecReload=/bin/kill -s HUP $MAINPIDExecStop=/bin/kill -s QUIT $MAINPID#if you don't like use ExecStop,you can use:#KillSignal=SIGQUIT##why KillMode use process? because the nginx master process will be control the child process#KillMode=processPrivateTmp=trueTimeoutStopSec=5[Install]WantedBy=multi-user.target ä¿å­˜ã€‚ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1sudo systemctl daemon-reload ç„¶åå¯åŠ¨ nginx: 1sudo systemctl start nginx æ¥ä¸‹æ¥ï¼Œè¦ä»‹ç»ï¼Œæˆ‘ä»¬ systemctl çš„é‡è¦å†…å®¹äº†ã€‚ å¼€å¯å¯åŠ¨å’Œä¸å¼€å¯å¯åŠ¨çš„åŒºåˆ«å¼€å¯å¯åŠ¨çš„æƒ…å†µä¸‹ï¼Œsystemctl åªä¼šå¯åŠ¨ä»¥ä¸‹è·¯å¾„çš„æœåŠ¡é…ç½® 1/etc/systemd/system ä½†æ˜¯ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„åŸºæœ¬æœåŠ¡ï¼Œéƒ½æ˜¯é…ç½®åœ¨ä»¥ä¸‹è·¯å¾„ï¼š 1&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system å½“æˆ‘ä»¬ç”¨åˆ°ä¸Šè¿°ä»‹ç»åˆ°çš„å‘½ä»¤ systemctl enable xx çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯åœ¨ /etc/systemd/system ç›®å½•é‡Œé¢åˆ›å»ºä»¥ä¸‹è½¯è¿æ¥åˆ° /usr/lib/systemd/system é‡Œé¢ [Unit] åŒºå—ï¼šå¯åŠ¨é¡ºåºä¸ä¾èµ–å…³ç³» Description ç»™å‡ºå½“å‰æœåŠ¡çš„ç®€å•æè¿° Documentation ç»™å‡ºæ–‡æ¡£ä½ç½® After è¡¨ç¤ºè¯¥æœåŠ¡è¦åœ¨å½“å‰ç›®æ ‡ç»„æˆ–è€…ç›®æ ‡æœåŠ¡å¯åŠ¨ä¹‹åæ‰èƒ½å¯åŠ¨ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯ nginx æœåŠ¡éœ€è¦åœ¨ network.target remote-fs.target nss-lookup.target å¯åŠ¨ä¹‹åæ‰å¯ä»¥å¯åŠ¨ï¼‰ Before ä¸ After ç›¸å¯¹ Wants è¡¨ç¤ºè¯¥æœåŠ¡å’Œå“ªä¸€äº›æœåŠ¡æœ‰ å¼±ä¾èµ– å…³ç³»ã€‚æ„æ€å°±æ˜¯ï¼Œæ‰€ä¾èµ–çš„æœåŠ¡å¦‚æœå¯åŠ¨å¤±è´¥çš„è¯æˆ–è€…å¼‚å¸¸äº†ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°è¯¥æœåŠ¡çš„å¯åŠ¨å’Œç»§ç»­è¿è¡Œ Requires ä¸ Wants ç›¸å ï¼Œå¼ºä¾èµ– [Service] åŒºå—ï¼šå¯åŠ¨è¡Œä¸º EnvironmentFile è¡¨ç¤ºè¯¥æœåŠ¡è‡ªå®šä¹‰çš„é…ç½®å‚æ•°å˜é‡æ–‡ä»¶ï¼Œæ–‡ä»¶å·² KEY=VALUE é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨ï¼Œåç»­å¯ä»¥ç”¨ $KEY æ¥è¯»å– valueã€‚ ExecReload : é‡å¯æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤ ExecStop : åœæ­¢æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤ ExecStartPre : å¯åŠ¨æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤ ExecStart : å¯åŠ¨æœåŠ¡æ‰§è¡Œçš„å‘½ä»¤ ExecStartPost : å¯åŠ¨æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤ ExecStopPost : åœæ­¢æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤ æ‰€æœ‰çš„å¯åŠ¨è®¾ç½®ä¹‹å‰ï¼Œéƒ½å¯ä»¥åŠ ä¸Šä¸€ä¸ªè¿è¯å·ï¼ˆ-ï¼‰ï¼Œè¡¨ç¤ºâ€æŠ‘åˆ¶é”™è¯¯â€ï¼Œå³å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œä¸å½±å“å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œã€‚æ¯”å¦‚ï¼ŒEnvironmentFile=-/etc/my-confï¼ˆæ³¨æ„ç­‰å·åé¢çš„é‚£ä¸ªè¿è¯å·ï¼‰ï¼Œå°±è¡¨ç¤ºå³ä½¿ /etc/my-conf æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚ Type å¯åŠ¨ç±»å‹ simpleï¼ˆé»˜è®¤å€¼ï¼‰ï¼šExecStart å­—æ®µå¯åŠ¨çš„è¿›ç¨‹ä¸ºä¸»è¿›ç¨‹ forkingï¼šExecStart å­—æ®µå°†ä»¥ fork()æ–¹å¼å¯åŠ¨ï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹å°†ä¼šé€€å‡ºï¼Œå­è¿›ç¨‹å°†æˆä¸ºä¸»è¿›ç¨‹ oneshotï¼šç±»ä¼¼äº simpleï¼Œä½†åªæ‰§è¡Œä¸€æ¬¡ï¼ŒSystemd ä¼šç­‰å®ƒæ‰§è¡Œå®Œï¼Œæ‰å¯åŠ¨å…¶ä»–æœåŠ¡ dbusï¼šç±»ä¼¼äº simpleï¼Œä½†ä¼šç­‰å¾… D-Bus ä¿¡å·åå¯åŠ¨ notifyï¼šç±»ä¼¼äº simpleï¼Œå¯åŠ¨ç»“æŸåä¼šå‘å‡ºé€šçŸ¥ä¿¡å·ï¼Œç„¶å Systemd å†å¯åŠ¨å…¶ä»–æœåŠ¡ idleï¼šç±»ä¼¼äº simpleï¼Œä½†æ˜¯è¦ç­‰åˆ°å…¶ä»–ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ‰ä¼šå¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸€ç§ä½¿ç”¨åœºåˆæ˜¯ä¸ºè®©è¯¥æœåŠ¡çš„è¾“å‡ºï¼Œä¸ä¸å…¶ä»–æœåŠ¡çš„è¾“å‡ºç›¸æ··åˆ KillMode æ€æ­»è¿›ç¨‹æ¨¡å¼ control-groupï¼ˆé»˜è®¤å€¼ï¼‰ï¼šå½“å‰æ§åˆ¶ç»„é‡Œé¢çš„æ‰€æœ‰å­è¿›ç¨‹ï¼Œéƒ½ä¼šè¢«æ€æ‰ processï¼šåªæ€ä¸»è¿›ç¨‹ mixedï¼šä¸»è¿›ç¨‹å°†æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå­è¿›ç¨‹æ”¶åˆ° SIGKILL ä¿¡å· noneï¼šæ²¡æœ‰è¿›ç¨‹ä¼šè¢«æ€æ‰ï¼Œåªæ˜¯æ‰§è¡ŒæœåŠ¡çš„ stop å‘½ä»¤ã€‚ Restar é‡å¯è¿›ç¨‹æ¨¡å¼ noï¼ˆé»˜è®¤å€¼ï¼‰ï¼šé€€å‡ºåä¸ä¼šé‡å¯ on-successï¼šåªæœ‰æ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç ä¸º 0ï¼‰ï¼Œæ‰ä¼šé‡å¯ on-failureï¼šéæ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç é 0ï¼‰ï¼ŒåŒ…æ‹¬è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯ on-abnormalï¼šåªæœ‰è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯ on-abortï¼šåªæœ‰åœ¨æ”¶åˆ°æ²¡æœ‰æ•æ‰åˆ°çš„ä¿¡å·ç»ˆæ­¢æ—¶ï¼Œæ‰ä¼šé‡å¯ on-watchdogï¼šè¶…æ—¶é€€å‡ºï¼Œæ‰ä¼šé‡å¯ alwaysï¼šä¸ç®¡æ˜¯ä»€ä¹ˆé€€å‡ºåŸå› ï¼Œæ€»æ˜¯é‡å¯ [Install] åŒºå— WantedBy è¡¨ç¤ºè¯¥æœåŠ¡æ‰€åœ¨çš„ Target ç»„ è¿™ä¸ªè®¾ç½®éå¸¸é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œ systemctl enable xx å‘½ä»¤æ—¶ï¼Œxx.service çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œå°±ä¼šæ”¾åœ¨/etc/systemd/system ç›®å½•ä¸‹é¢çš„ WantedBy å‘½åçš„ç›®å½•çš„å­ç›®å½•ä¹‹ä¸­ã€‚","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Centos7","slug":"Centos7","permalink":"http://blog.crazylaw.cn/tags/Centos7/"},{"name":"Systemctl","slug":"Systemctl","permalink":"http://blog.crazylaw.cn/tags/Systemctl/"}]},{"title":"å­—ç¬¦ç¼–ç æ·±åº¦å‰–æ","slug":"ascii-code-2","date":"2017-07-27T14:44:00.000Z","updated":"2021-03-20T16:25:01.801Z","comments":true,"path":"2017/07/27/ascii-code-2/","link":"","permalink":"http://blog.crazylaw.cn/2017/07/27/ascii-code-2/","excerpt":"","text":"å‰è¨€åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹å¦‚ä¸‹4ç§ç¼–ç è¿›è¡Œå¯¹æ¯” unicodeç¼–ç  utf8ç¼–ç  asciiç¼–ç  asniç¼–ç  ASCIIç¼–ç å’ŒASNIç¼–ç çš„åŒºåˆ«å­—ç¬¦å†…ç (charcter code)æŒ‡çš„æ˜¯ç”¨æ¥ä»£è¡¨å­—ç¬¦çš„å†…ç .è¯»è€…åœ¨è¾“å…¥å’Œå­˜å‚¨æ–‡æ¡£æ—¶éƒ½è¦ä½¿ç”¨å†…ç ,å†…ç åˆ†ä¸º å•å­—èŠ‚å†…ç  â€“ Single-Byte character sets (SBCS),å¯ä»¥æ”¯æŒ255ï¼ˆ 8bits = (2^8)-1 = 255ï¼‰ä¸ªå­—ç¬¦ç¼–ç . åŒå­—èŠ‚å†…ç  â€“ Double-Byte character sets)(DBCS),å¯ä»¥æ”¯æŒ65000ä¸ªå­—ç¬¦ç¼–ç ï¼ˆæœ€å¤šæ”¯æŒ16 bits = (2^16)-1 = 65535ï¼‰. å‰è€…å³ä¸ºASCIIç¼–ç ï¼Œåè€…å¯¹åº”ANSI. è‡³äºç®€ä½“ä¸­æ–‡ç¼–ç GB2312ï¼Œå®é™…ä¸Šå®ƒæ˜¯ANSIçš„ä¸€ä¸ªä»£ç é¡µ UNICODEç¼–ç unicode æ˜¯ä¸€ç§ç¼–ç è¡¨æ ¼ï¼Œä¾‹å¦‚ï¼Œç»™ä¸€ä¸ªæ±‰å­—è§„å®šä¸€ä¸ªä»£ç ã€‚ç±»ä¼¼ GB2312-1980, GB18030ç­‰ï¼Œåªä¸è¿‡å­—é›†ä¸åŒã€‚ ä¸€ä¸ªunicodeç å¯èƒ½è½¬æˆé•¿åº¦ä¸ºä¸€ä¸ªBYTE,æˆ–ä¸¤ä¸ªï¼Œä¸‰ä¸ªï¼Œå››ä¸ªBYTEï¼ˆæœ€å¤š6ä¸ªbyteï¼‰çš„UTF8ç ï¼Œå–å†³äºunicodeç çš„å€¼ã€‚è‹±æ–‡unicodeç å› ä¸ºå€¼å°äº0x80ï¼ˆå•å­—èŠ‚å­—ç¬¦ï¼‰,åªè¦ç”¨ä¸€ä¸ªBYTEçš„UTF8ä¼ é€ï¼Œæ¯”é€unicodeä¸¤ä¸ªbyteså¿«ã€‚ å¦‚ä¸Šï¼ŒANSIæœ‰å¾ˆå¤šä»£ç é¡µï¼Œä½¿ç”¨ä¸åŒä»£ç é¡µçš„å†…ç æ— æ³•åœ¨å…¶ä»–ä»£ç ä¹Ÿæ­£å¸¸æ˜¾ç¤ºï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ—¥æ–‡ç‰ˆï¼ç¹ä½“ä¸­æ–‡ç‰ˆæ¸¸æˆæ— æ³•åœ¨ç®€ä½“ä¸­æ–‡å¹³å°ç›´æ¥æ˜¾ç¤ºçš„åŸå› ï¼ Unicodeä¹Ÿæ˜¯ä¸€ç§å­—ç¬¦ç¼–ç æ–¹æ³•ï¼Œä¸è¿‡å®ƒæ˜¯ç”±å›½é™…ç»„ç»‡è®¾è®¡ï¼Œå¯ä»¥å®¹çº³å…¨ä¸–ç•Œæ‰€æœ‰è¯­è¨€æ–‡å­—çš„ç¼–ç æ–¹æ¡ˆï¼å®ƒæ˜¯ä¸€ç§ï¼’å­—èŠ‚ç¼–ç ï¼Œèƒ½å¤Ÿæä¾›ï¼–ï¼•ï¼•ï¼“ï¼•ä¸ªå­—ç¬¦ï¼Œ è¿™ä¸ªæ•°å­—æ˜¯ä¸å¤Ÿè¡¨ç¤ºæ‰€æœ‰çš„å­—ç¬¦çš„ï¼ˆæ±‰è¯­å°±æœ‰ï¼•ï¼•ï¼ï¼ï¼å¤šå­—ç¬¦ï¼‰ï¼Œæ‰€ä»¥ï¼Œé€šè¿‡ä¸€ä¸ªä»£ç†å¯¹çš„æœºåˆ¶æ¥å®ç°é™„åŠ çš„ï¼™ï¼‘ï¼—ï¼Œï¼”ï¼—ï¼–ä¸ªå­—ç¬¦è¡¨ç¤ºï¼Œä»¥è¾¾åˆ°æ‰€æœ‰å­—ç¬¦éƒ½å…·æœ‰å”¯ä¸€ç¼–ç ï¼ Unicodeå’ŒBigEndianUnicodeè¿™ä¸¤è€…åªæ˜¯å­˜å‚¨é¡ºåºä¸åŒï¼Œå¦‚ï¼‚Aï¼‚çš„unicodeç¼–ç ä¸º65 00 å…¶BigEndianUnicodeç¼–ç ä¸º00 65 å…¶å®å°±æ˜¯ç±»æ¯”äºæˆ‘ä¹‹å‰è¯´è¿‡çš„å¤§å°ç«¯çš„ä»‹ç» UTF8ç¼–ç UTF8å…¨ç§°ï¼šUnicode Transformation Format â€“ 8 bitï¼ˆunicodeè½¬åŒ–æ ¼å¼ä¸º8ä½çš„æµæ•°æ®ï¼‰ Unicodeæ˜¯ä¸€ä¸ªå­—ç¬¦é›†ï¼Œè€ŒUTF-8æ˜¯Unicodeçš„å…¶ä¸­ä¸€ç§ï¼ŒUnicodeæ˜¯å®šé•¿çš„éƒ½ä¸ºåŒå­—èŠ‚ï¼Œè€ŒUTF-8æ˜¯å¯å˜çš„ï¼Œå¯¹äºæ±‰å­—æ¥è¯´Unicodeå æœ‰çš„å­—èŠ‚æ¯”UTF-8å ç”¨çš„å­—èŠ‚å°‘1ä¸ªå­—èŠ‚ã€‚Unicodeä¸ºåŒå­—èŠ‚ï¼Œè€ŒUTF-8ä¸­æ±‰å­—å ä¸‰ä¸ªå­—èŠ‚ã€‚ æ˜¯Unicodeä¼ é€æ ¼å¼ã€‚å³æŠŠUnicodeæ–‡ä»¶è½¬æ¢æˆBYTEçš„ä¼ é€æµã€‚ å…¶ä¸­UTF-16å’ŒUnicodeç¼–ç å¤§è‡´ä¸€æ ·, UTF-8å°±æ˜¯ä»¥8ä½ä¸ºå•å…ƒå¯¹Unicodeè¿›è¡Œç¼–ç ã€‚ UTF-8ç¼–ç å­—ç¬¦ç†è®ºä¸Šå¯ä»¥æœ€å¤šåˆ°6ä¸ªå­—èŠ‚é•¿,ç„¶è€Œ16ä½BMPï¼ˆBasic Multilingual Planeï¼‰å­—ç¬¦æœ€å¤šåªç”¨åˆ°3å­—èŠ‚é•¿ã€‚ä»Unicodeåˆ°UTF-8çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š Unicodeç¼–ç (16è¿›åˆ¶) UTF-8 å­—èŠ‚æµ(äºŒè¿›åˆ¶) 0000 - 007F 0xxxxxxx 0080 - 07FF 110xxxxx 10xxxxxx 0800 - FFFF 1110xxxx 10xxxxxx 10xxxxxx 100000 - 1FFFFF 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx 200000 - 3FFFFFF 111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 4000000 - 7FFFFFFF 1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx ä¾‹å¦‚â€œæˆ‘â€å­—çš„Unicodeç¼–ç æ˜¯4f6bã€‚4f6båœ¨0800-FFFFä¹‹é—´ï¼Œæ‰€ä»¥è‚¯å®šè¦ç”¨3å­—èŠ‚æ¨¡æ¿äº†ï¼š1110xxxx 10xxxxxx 10xxxxxxã€‚å°†4f6bå†™æˆäºŒè¿›åˆ¶æ˜¯ï¼š100 111101 101011ï¼Œ ç”¨è¿™ä¸ªæ¯”ç‰¹æµä¾æ¬¡ä»£æ›¿æ¨¡æ¿ä¸­çš„xï¼Œå¾—åˆ°ï¼š11100100 10111101 10101011ï¼Œå³E4 9C ABã€‚ ç”¨PHPå®ç°unicodeç¼–ç å’Œutf8ç¼–ç çš„è½¬å˜123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051&lt;?php/** * UTF-8ç¼–ç å­—ç¬¦ç†è®ºä¸Šå¯ä»¥æœ€å¤šåˆ°6ä¸ªå­—èŠ‚é•¿,ç„¶è€Œ16ä½BMPï¼ˆBasic Multilingual Planeï¼‰å­—ç¬¦æœ€å¤šåªç”¨åˆ°3å­—èŠ‚é•¿ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹UTF-8ç¼–ç è¡¨ï¼š * * U-00000000 - U-0000007F: 0xxxxxxx * U-00000080 - U-000007FF: 110xxxxx 10xxxxxx * U-00000800 - U-0000FFFF: 1110xxxx 10xxxxxx 10xxxxxx * U-00010000 - U-001FFFFF: 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx * U-00200000 - U-03FFFFFF: 111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx * U-04000000 - U-7FFFFFFF: 1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx *//** * å•å­—ç¬¦æ±‰å­—è½¬æ¢unicode(16è¿›åˆ¶) * * @param $utf8_str * * @return string */function utf8_transform_unicode($utf8_str)&#123; $unicode = (ord($utf8_str&#123;0&#125;) &amp; 0xF) &lt;&lt; 12; $unicode |= (ord($utf8_str&#123;1&#125;) &amp; 0x3F) &lt;&lt; 6; $unicode |= (ord($utf8_str&#123;2&#125;) &amp; 0x3F); return dechex($unicode);&#125;/** * unicodeç¼–ç è½¬æ±‰å­— * @param $unicode * @return string */function unicode_transform_utf8($unicode)&#123; // åå…­è¿›åˆ¶è½¬åè¿›åˆ¶ $unicode = (int)hexdec($unicode); $ord_1 = decbin(0xe0 | ($unicode &gt;&gt; 12)); $ord_2 = decbin(0x80 | (($unicode &gt;&gt; 6) &amp; 0x3f)); $ord_3 = decbin(0x80 | ($unicode &amp; 0x3f)); $utf8_str = chr(bindec($ord_1)) . chr(bindec($ord_2)) . chr(bindec($ord_3)); return $utf8_str;&#125;$str = 'æˆ‘';echo utf8_transform_unicode($str);$unicode = '6211';echo unicode_transform_utf8($unicode); åç»­ï¼Œæˆ‘ä¼šå‡ºä¸€ä¸ªç”¨phpç›´æ¥å®ç°ç¼–ç è½¬æ¢å’Œæ±‰å­—å­—ç¬¦ä¸²æˆªå–çš„PHPæ‰©å±•ï¼Œéƒ½ä¼šç”¨åˆ°è¿™æ¬¡çš„çŸ¥è¯†ï¼Œåç»­è§ã€‚","categories":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"ascii","slug":"ascii","permalink":"http://blog.crazylaw.cn/tags/ascii/"}]},{"title":"PHP å®ç° Promise+åç¨‹è°ƒç”¨","slug":"ccp","date":"2017-07-27T14:13:00.000Z","updated":"2021-03-20T16:25:01.802Z","comments":true,"path":"2017/07/27/ccp/","link":"","permalink":"http://blog.crazylaw.cn/2017/07/27/ccp/","excerpt":"PHP å®ç° Promise+åç¨‹è°ƒç”¨ github åœ°å€ï¼šccp è§‰å¾—å¥½è®°çš„ç»™ä¸ª Start å–”ã€‚ è¯´æ˜åœ¨ PHP å½“ä¸­ï¼Œæˆ‘ä»¬æˆ–å¤šæˆ–å°‘ä¼šä½¿ç”¨åˆ°å¼‚æ­¥ç¼–ç¨‹çš„æ€æƒ³ï¼Œä½†æ˜¯å¼‚æ­¥ç¼–ç¨‹éš¾å…ç»™æˆ‘ä»¬å¸¦æ¥å›è°ƒåœ°ç‹±çš„æ„Ÿè§‰ï¼Œå¹¶ä¸”ä»£ç å¯è¯»æ€§ååˆ†ä¹‹å·®ï¼Œåœ¨ ES6 è§„èŒƒé‡Œé¢ï¼Œæˆ–è€…æ›´æ—©å°±å¯ä»¥æ¨å‡ºäº†ä¸€ä¸ªåš Promise çš„ä¸œè¥¿ï¼Œåˆ©ç”¨ Promiseï¼Œä½ å¯ä»¥ç”¨åŒæ­¥çš„åšæ³•æ¥å®ç°å¼‚æ­¥çš„æ“ä½œï¼Œä»£ç å¯è¯»æ€§ä¸Šå¤§å¤§æé«˜ï¼Œä¸ä»…å¦‚æ­¤ï¼Œç”±äºå¼‚æ­¥ç¼–ç¨‹å’Œå¼‚æ­¥ IO çš„æ··åˆä½¿ç”¨ï¼Œå¯¼è‡´ä»£ç çš„å‡†ç¡®æ€§éš¾ä»¥æé«˜ï¼Œä¸å¯å¦è®¤çš„æ˜¯ï¼ŒPromise çš„æ¨å‡ºï¼Œå¤§å¤§çš„æé«˜äº†ä½ ä»¬ç¼–å†™å¼‚æ­¥ä»£ç çš„å¯é æ€§ï¼Œè™½ç„¶è¿™ä¹Ÿæ˜¯ä¼šæŸè€—ä¸€äº›ååˆ†å¾®å°çš„æ€§èƒ½ï¼Œä½†æ˜¯ä»»ä½•å–èˆéƒ½æ˜¯ç›¸å¯¹çš„ã€‚","text":"PHP å®ç° Promise+åç¨‹è°ƒç”¨ github åœ°å€ï¼šccp è§‰å¾—å¥½è®°çš„ç»™ä¸ª Start å–”ã€‚ è¯´æ˜åœ¨ PHP å½“ä¸­ï¼Œæˆ‘ä»¬æˆ–å¤šæˆ–å°‘ä¼šä½¿ç”¨åˆ°å¼‚æ­¥ç¼–ç¨‹çš„æ€æƒ³ï¼Œä½†æ˜¯å¼‚æ­¥ç¼–ç¨‹éš¾å…ç»™æˆ‘ä»¬å¸¦æ¥å›è°ƒåœ°ç‹±çš„æ„Ÿè§‰ï¼Œå¹¶ä¸”ä»£ç å¯è¯»æ€§ååˆ†ä¹‹å·®ï¼Œåœ¨ ES6 è§„èŒƒé‡Œé¢ï¼Œæˆ–è€…æ›´æ—©å°±å¯ä»¥æ¨å‡ºäº†ä¸€ä¸ªåš Promise çš„ä¸œè¥¿ï¼Œåˆ©ç”¨ Promiseï¼Œä½ å¯ä»¥ç”¨åŒæ­¥çš„åšæ³•æ¥å®ç°å¼‚æ­¥çš„æ“ä½œï¼Œä»£ç å¯è¯»æ€§ä¸Šå¤§å¤§æé«˜ï¼Œä¸ä»…å¦‚æ­¤ï¼Œç”±äºå¼‚æ­¥ç¼–ç¨‹å’Œå¼‚æ­¥ IO çš„æ··åˆä½¿ç”¨ï¼Œå¯¼è‡´ä»£ç çš„å‡†ç¡®æ€§éš¾ä»¥æé«˜ï¼Œä¸å¯å¦è®¤çš„æ˜¯ï¼ŒPromise çš„æ¨å‡ºï¼Œå¤§å¤§çš„æé«˜äº†ä½ ä»¬ç¼–å†™å¼‚æ­¥ä»£ç çš„å¯é æ€§ï¼Œè™½ç„¶è¿™ä¹Ÿæ˜¯ä¼šæŸè€—ä¸€äº›ååˆ†å¾®å°çš„æ€§èƒ½ï¼Œä½†æ˜¯ä»»ä½•å–èˆéƒ½æ˜¯ç›¸å¯¹çš„ã€‚ å‚è€ƒ ECMAScript 2015 (6th Edition, ECMA-262) Promise ECMAScript Latest Draft (ECMA-262)Promise æ”¯æŒ PromiseAPI promise-&gt;then primise-&gt;catch Promise::all Promise::race Promise::resolve Promise::reject Promise::warp Promise::co ç­‰ç­‰ ç¿»è¯‘åˆ‡æ¢ English.MD","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"Promise","slug":"Promise","permalink":"http://blog.crazylaw.cn/tags/Promise/"},{"name":"ES6","slug":"ES6","permalink":"http://blog.crazylaw.cn/tags/ES6/"}]},{"title":"64ä½åˆ†å¸ƒå¼è‡ªå¢å‘å·å™¨","slug":"id-sender","date":"2017-07-13T09:30:00.000Z","updated":"2021-03-20T16:25:01.806Z","comments":true,"path":"2017/07/13/id-sender/","link":"","permalink":"http://blog.crazylaw.cn/2017/07/13/id-sender/","excerpt":"IdCenterSender â€”PHP æºç å®ç°-64 ä½åˆ†å¸ƒå¼è‡ªå¢å‘å·å™¨PHP å®ç° 64 ä½åˆ†å¸ƒå¼ ID å‘å·å™¨, github ä¸Šä¹Ÿæœ‰ C è¯­è¨€ç‰ˆæœ¬ä¸Šçš„è¿æ¥å¯ä»¥è¿›å»è·³è½¬ github åœ°å€ : IdCenterSender è§‰å¾—å¥½è®°çš„ç»™ä¸ª Start å–”ã€‚ åŸç†å‚è€ƒ Snowflake ç®—æ³•,æ ¹æ®è‡ªèº«è®¾è®¡æƒ…å†µæ‰©å±•äº†å…¶ä¸­çš„ç»†èŠ‚","text":"IdCenterSender â€”PHP æºç å®ç°-64 ä½åˆ†å¸ƒå¼è‡ªå¢å‘å·å™¨PHP å®ç° 64 ä½åˆ†å¸ƒå¼ ID å‘å·å™¨, github ä¸Šä¹Ÿæœ‰ C è¯­è¨€ç‰ˆæœ¬ä¸Šçš„è¿æ¥å¯ä»¥è¿›å»è·³è½¬ github åœ°å€ : IdCenterSender è§‰å¾—å¥½è®°çš„ç»™ä¸ª Start å–”ã€‚ åŸç†å‚è€ƒ Snowflake ç®—æ³•,æ ¹æ®è‡ªèº«è®¾è®¡æƒ…å†µæ‰©å±•äº†å…¶ä¸­çš„ç»†èŠ‚ 64bits åˆ†æˆäº† 4 ä¸ªéƒ¨åˆ†ã€‚ æœ€é«˜ä½èˆå¼ƒæ¯«ç§’çº§çš„æ—¶é—´æˆ³,æœ‰ 41 ä¸ª bit.èƒ½å¤Ÿä½¿ç”¨ 139 å¹´ï¼Œå½“ç„¶è¿™äº›æ˜¯å¯ä»¥æ‰©å±•çš„,å¯ä»¥é€šçŸ¥æŒ‡å®šèµ·å§‹æ—¶é—´æ¥å»¶é•¿è¿™ä¸ªæ—¥æœŸé•¿åº¦ã€‚ä¹Ÿå°±æ˜¯è¯´æœåŠ¡å¯åŠ¨å¼€å§‹ä¹‹åå°±å¯ä»¥æŒç»­ä½¿ç”¨ 139 å¹´è‡ªå®šä¹‰åˆ†å¸ƒå¼æœºå™¨èŠ‚ç‚¹ id,å ä½ 12 ä¸ª bit,èƒ½å¤Ÿæ”¯æŒ 8191 ä¸ªèŠ‚ç‚¹ã€‚éƒ¨ç½²çš„æ—¶å€™å¯ä»¥é…ç½®å¥½æœåŠ¡å™¨ id,ä¹Ÿå°±æ˜¯ä»£ç é‡Œé¢çš„ node_id å˜é‡ï¼Œæ¯ä¸€å°æœºå™¨éƒ½éœ€è¦ç”¨ä¸åŒçš„ node_id æ¥æ ‡å¿—ï¼Œå°±åƒ mysql çš„ server_id ä¸€æ ·è¿›ç¨‹ï¼ˆæ¯«ç§’ï¼‰è‡ªå¢åºå·ã€‚å ä½ 10bit,ä¸€æ¯«ç§’èƒ½äº§ç”Ÿ 2047 ä¸ª idã€‚ æ€»ç»“ç‰¹ç‚¹ï¼š ç±» snowflake ç®—æ³• ID å‘å·å™¨æœ‰æ•ˆæœŸå¯ä»¥å»¶ç»­ä»å‘å¸ƒå¼€å§‹çš„ 139 å¹´ åˆ†å¸ƒå¼æ”¯æŒ 8191 å°æœºå™¨ å•è¿›ç¨‹è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå¹¶å‘æ¯ç§’æ”¯æŒ 200 ä¸‡ä¸ª ID ç”Ÿæˆ å”¯ä¸€æ€§ä¿è¯ åŒä¸€æ¯«ç§’å†…è‡ªå¢å˜é‡ä¿è¯å¹¶å‘çš„å”¯ä¸€æ€§(é‡‡ç”¨æ–‡ä»¶é”çš„æ–¹å¼å¯¹ cache æ–‡ä»¶è¿›è¡Œé”å®š)ã€‚ ä½¿ç”¨1234567include_once '../cckeyid/IdCenterSender.php';echo \\cckeyid\\IdCenterSender::getInstance()-&gt;ck_get_new_id(1);echo PHP_EOL;print_r(\\cckeyid\\IdCenterSender::getInstance(true)-&gt;ck_get_new_id(4));","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"IDå‘å·å™¨","slug":"IDå‘å·å™¨","permalink":"http://blog.crazylaw.cn/tags/ID%E5%8F%91%E5%8F%B7%E5%99%A8/"}]},{"title":"RabbitMQã®å…³é”®çŸ¥è¯†æ•´ç†","slug":"rabbit-mq","date":"2017-07-11T03:45:00.000Z","updated":"2021-03-20T16:25:01.813Z","comments":true,"path":"2017/07/11/rabbit-mq/","link":"","permalink":"http://blog.crazylaw.cn/2017/07/11/rabbit-mq/","excerpt":"è¯´æ˜RabbitMQ ä½œä¸ºä¸€ä¸ªè½¬å‘æœåŠ¡å™¨ï¼Œé‡Œé¢æ¶‰åŠäº†ä¸€äº›å®ä½“çš„ä¸œè¥¿ï¼Œå¦‚ä¸‹ï¼š ç”Ÿäº§è€… (Producter) æ¶ˆæ¯ (Message) äº¤æ¢æœº (Exchange) é˜Ÿåˆ— (Queue) æ¶ˆè´¹è€… (Consumer) åœ¨è¿™äº›å®ä½“çš„ä¸œè¥¿çš„åŸºç¡€ä¸Šï¼ŒRabbitMQ é‡ç‚¹çš„æ˜¯ äº¤æ¢æœº,é˜Ÿåˆ— äº¤æ¢æœºä¸é˜Ÿåˆ—è¯´å®Œå®ä½“çš„ä¸œè¥¿ä¹‹åï¼Œåœ¨ äº¤æ¢æœº å’Œ é˜Ÿåˆ— ä¹‹é—´æœ‰è®¸å¤šçš„è§„åˆ™ï¼ˆç©æ³•ï¼‰ï¼Œæˆ‘ä»¬å¢åŠ äº†å¦‚ä¸‹å†…å®¹ï¼š é˜Ÿåˆ—å (Queue_name) äº¤æ¢æœºç±»å‹ (Exchange_type) è·¯ç”±é”® (Routing_key)","text":"è¯´æ˜RabbitMQ ä½œä¸ºä¸€ä¸ªè½¬å‘æœåŠ¡å™¨ï¼Œé‡Œé¢æ¶‰åŠäº†ä¸€äº›å®ä½“çš„ä¸œè¥¿ï¼Œå¦‚ä¸‹ï¼š ç”Ÿäº§è€… (Producter) æ¶ˆæ¯ (Message) äº¤æ¢æœº (Exchange) é˜Ÿåˆ— (Queue) æ¶ˆè´¹è€… (Consumer) åœ¨è¿™äº›å®ä½“çš„ä¸œè¥¿çš„åŸºç¡€ä¸Šï¼ŒRabbitMQ é‡ç‚¹çš„æ˜¯ äº¤æ¢æœº,é˜Ÿåˆ— äº¤æ¢æœºä¸é˜Ÿåˆ—è¯´å®Œå®ä½“çš„ä¸œè¥¿ä¹‹åï¼Œåœ¨ äº¤æ¢æœº å’Œ é˜Ÿåˆ— ä¹‹é—´æœ‰è®¸å¤šçš„è§„åˆ™ï¼ˆç©æ³•ï¼‰ï¼Œæˆ‘ä»¬å¢åŠ äº†å¦‚ä¸‹å†…å®¹ï¼š é˜Ÿåˆ—å (Queue_name) äº¤æ¢æœºç±»å‹ (Exchange_type) è·¯ç”±é”® (Routing_key) äº¤æ¢æœºç±»å‹ã€è·¯ç”±é”®çš„ä½œç”¨ è·¯ç”±é”®ä¸€èˆ¬å¯ä»¥è®¾ç½®ä¸ºæŸä¸€ç±»ç›¸åŒå±æ€§å®šä¹‰çš„é›†åˆ fanout (æ‰‡å½¢ç±»å‹) ï¼š å¿½ç•¥äº† Routing_keyï¼Œç±»æ¯”å¹¿æ’­æ¨¡å¼ï¼Œä¹Ÿç®—æ˜¯ç±»æ¯”å‘å¸ƒè€…ã€è®¢é˜…è€…æ¨¡å¼ direct (ç›´æ¥ç±»å‹) ï¼š ä¸å¿½ç•¥ Routing_keyï¼Œä¸ºæ™®é€šStringï¼Œå½“ N ä¸ª Consumer ç»‘å®šçš„ Routing_key ä¸€è‡´çš„æ—¶å€™ï¼Œå’Œfanout ç±»å‹æ²¡åŒºåˆ« topics ï¼ˆè¯é¢˜ç±»å‹ï¼‰ ï¼š ä¸å¿½ç•¥ Routing_keyï¼ŒRouting_key é¢å¤–åŠ å¤šä»¥ä¸ªè§„åˆ™ï¼Œå¦‚æœéœ€è¦ä¸ºå•è¯åˆ—è¡¨çš„æ—¶å€™ï¼Œéœ€è¦ç”¨ . å·è¿›è¡Œåˆ†å‰²ï¼Œä¾‹å¦‚(c.a.i)ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ* å¯ä»¥ä»£è¡¨ä¸€ä¸ªå ä½ç¬¦ï¼Œ# å¯ä»¥ä»£è¡¨ 0 æˆ–è€…å¤šä¸ªå ä½ç¬¦ï¼Œä¾‹å¦‚(*.a.i)ï¼Œ(c.#) headers ï¼ˆå¤´éƒ¨ç±»å‹ï¼‰ ï¼š ç•¥ç•¥ç•¥â€¦æ—¥åè¡¥å…… å„ç±»çŸ¥è¯†äº¤æ¢æœºåˆ†å‘è¯·æ±‚åˆ°é˜Ÿåˆ— ä¸€ä¸ªé˜Ÿåˆ—å¯¹åº” N ä¸ªæ¶ˆè´¹è€… äº¤æ¢æœºåˆ†å‘è¯·æ±‚çš„æ—¶å€™ï¼Œç”¨åˆ°äº† Queue_name å’ŒRouting_keyï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ˆåŒä¸€ä¸ªé˜Ÿåˆ—ï¼‰ï¼Œäº¤æ¢æœºåˆ†å‘çš„ç­–ç•¥æ˜¯å¾ªç¯è°ƒåº¦ï¼Œä¾‹å¦‚ï¼Œæˆ‘ç°åœ¨æœ‰ 2 ä¸ªæ¶ˆè´¹è€…ï¼Œå¯¹åº”ä¸€ä¸ªé˜Ÿåˆ—ï¼Œåˆ†åˆ«å«C1,C2ï¼Œç¬¬ä¸€æ¬¡æ¶ˆæ¯ï¼Œé˜Ÿåˆ—ä¼šå‘é€åˆ°C1ï¼Œç¬¬äºŒæ¬¡æ¶ˆæ¯ï¼Œé˜Ÿåˆ—ä¼šå‘é€åˆ°C2ï¼Œä»¥æ­¤å¾ªç¯è°ƒç”¨ã€‚ è¿™é‡Œä¼šäº§ç”Ÿå‡ ä¸ªé—®é¢˜ï¼š å¦‚æœ C1 æ˜¯ä¸€ä¸ªè€—æ—¶ï¼ˆsleep 1sï¼‰çš„æ“ä½œï¼Œä½†æ˜¯ C2 æ˜¯ä¸€ä¸ªç«‹åˆ»æ‰§è¡Œå®Œæ¯•çš„é˜Ÿåˆ—ã€‚å½“å‰é˜Ÿåˆ—æ¥å—äº†äº¤æ¢æœºè½¬å‘è¿‡æ¥çš„ 14 ä¸ªæ¶ˆæ¯ï¼Œé‚£ä¹ˆäº¤æ¢æœºä¼šä»¥å¾ªç¯è°ƒåº¦çš„æ–¹å¼è¿›è¡Œæ‰§è¡Œï¼Œæ¶ˆæ¯çš„åˆ†é…é‚£ä¹ˆå¹³å‡ï¼ŒC1 å¤„ç†äº† 7 ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼ŒC2 å¤„ç†äº† 7 ä¸ªæ¶ˆæ¯ï¼Œåªä¸è¿‡ C2 è¿›ç¨‹ä¼šå…ˆå®Œæˆä»»åŠ¡ï¼Œå¿«å°†è¿‘ä¸€åŠçš„æ—¶é—´ã€‚ å¯¹ç­–ï¼šRabbitMQ ä¸­æœ‰ä¸€ä¸ªqosçš„æ¦‚å¿µï¼Œè¿™ä¸ªæ¦‚å¿µå¯ä»¥å¸®åŠ©ç±»æ¯”ç½‘ç»œæ¨¡å‹é‡Œé¢çš„epollæ¨¡å¼ï¼Œå½“å…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…ç©ºé—²çš„æ—¶å€™ï¼Œå°±æŠŠæ¶ˆæ¯è½¬å‘åˆ°è¯¥æ¶ˆè´¹è€…ä¸Šï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹çš„è¯ï¼Œå¤§å¤§æé«˜äº†æ•´ä½“æ¶ˆæ¯æ¶ˆè´¹çš„é€Ÿç‡ã€‚ä½†æ˜¯ä¹Ÿæœ‰å¼Šç«¯ï¼Œå°±æ˜¯å¦‚æœæ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½å¤„äºå¿™ç¢Œçš„çŠ¶æ€çš„è¯ï¼Œé‚£ä¹ˆä¹…å¯èƒ½éœ€è¦è€ƒè™‘ä¸€ä¸‹å¢åŠ å¤šä¸€äº›æ¶ˆè´¹è€…äº†ã€‚ å¦‚æœæ¶ˆè´¹è€…æ¶ˆè´¹ä¸åŠæ—¶ï¼Œé‚£ä¹ˆåœ¨é˜Ÿåˆ—ä¸­å°±ä¼šå¤§é‡å †ç§¯æ¶ˆæ¯ï¼Œå ç”¨å¤§é‡å†…å­˜ï¼Œå¯¼è‡´æœåŠ¡å™¨å®•æœºæˆ–è€… RabbitMQ å®•æœºï¼Œå¹¶ä¸”å®•æœºçš„æ—¶å€™ï¼Œå¤§é‡æ¶ˆæ¯éšæ—¶é¢ä¸´äº†ä¸¢å¤±çš„å¯èƒ½ï¼Œè¿™å°†ä¼šäº§ç”Ÿæ˜¯å¦å¯æ€•çš„ä¸¥é‡çš„åæœ å¯¹ç­–ï¼šRabbitMq ä¸­æœ‰ä¸€ä¸ªæŒä¹…åŒ–çš„æ¦‚å¿µï¼ŒæŒä¹…åŒ–æ”¯æŒé˜Ÿåˆ—æŒä¹…åŒ–ï¼Œæ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¸ºçš„å°±æ˜¯é˜²æ­¢å®•æœºçš„æ—¶å€™ï¼Œè¿™äº›æ¶ˆæ¯ä¹Ÿè·Ÿä¹‹ä¸¢å¤±ã€‚ æ¶ˆè´¹è€…å› ä¸ºæŸäº›ç³»ç»Ÿé”™è¯¯ç»“æŸäº†ï¼Œç†è®ºä¸Šï¼Œè¯¥æ¶ˆæ¯ä¼šè½¬å‘ç»™å¦å¤–ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„æ¶ˆè´¹è€…å»æ¶ˆè´¹ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆè´¹è€…ä¹Ÿå®•äº†ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°†ä¼šåœ¨é˜Ÿåˆ—ä¸­å­˜å‚¨ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…è¿æ¥çš„æ—¶å€™ï¼Œä¼šæŠ•é€’åˆ°æ¶ˆè´¹è€…ä¸­ã€‚ å¯¹ç­–ï¼šè®¾å®š ack åº”ç­”æœºåˆ¶å®ç°é«˜å¯ç”¨çš„ç‰¹æ€§ã€‚","categories":[{"name":"MQ","slug":"MQ","permalink":"http://blog.crazylaw.cn/categories/MQ/"}],"tags":[{"name":"MQ","slug":"MQ","permalink":"http://blog.crazylaw.cn/tags/MQ/"}]},{"title":"å¤§ç«¯å’Œå°ç«¯ï¼ˆBig endian and Little endianï¼‰","slug":"network-protocol-endian","date":"2017-06-28T06:43:00.000Z","updated":"2021-03-20T16:25:01.811Z","comments":true,"path":"2017/06/28/network-protocol-endian/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/28/network-protocol-endian/","excerpt":"å¤§ç«¯å’Œå°ç«¯ï¼ˆBig endian and Little endianï¼‰ç½‘ç»œå­—èŠ‚åºç½‘ç»œå­—èŠ‚é¡ºåºæ˜¯TCP/IPä¸­è§„å®šå¥½çš„ä¸€ç§æ•°æ®è¡¨ç¤ºæ ¼å¼ï¼Œå®ƒä¸å…·ä½“çš„CPUç±»å‹ã€æ“ä½œç³»ç»Ÿç­‰æ— å…³ï¼Œä»è€Œå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸åŒä¸»æœºä¹‹é—´ä¼ è¾“æ—¶èƒ½å¤Ÿè¢«æ­£ç¡®è§£é‡Šã€‚ç½‘ç»œå­—èŠ‚é¡ºåºé‡‡ç”¨big endianæ’åºæ–¹å¼ã€‚ ç”±æ­¤å¯çŸ¥ï¼Œç½‘ç»œå­—èŠ‚åºæ˜¯å¤§ç«¯åºçš„ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯Big endianå‘¢ï¼Ÿ ä¸€ã€å¤§ç«¯å’Œå°ç«¯çš„é—®é¢˜å¯¹äºæ•´å‹ã€é•¿æ•´å‹ç­‰æ•°æ®ç±»å‹ï¼ŒBig endian è®¤ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯æœ€é«˜ä½å­—èŠ‚ï¼ˆæŒ‰ç…§ä»ä½åœ°å€åˆ°é«˜åœ°å€çš„é¡ºåºå­˜æ”¾æ•°æ®çš„é«˜ä½å­—èŠ‚åˆ°ä½ä½å­—èŠ‚ï¼‰ï¼›è€Œ Little endian åˆ™ç›¸åï¼Œå®ƒè®¤ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯æœ€ä½ä½å­—èŠ‚ï¼ˆæŒ‰ç…§ä»ä½åœ°å€åˆ°é«˜åœ°å€çš„é¡ºåºå­˜æ”¾æ•°æ®çš„ä½ä½å­—èŠ‚åˆ°é«˜ä½å­—èŠ‚ï¼‰ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ä»å†…å­˜åœ°å€ 0x0000 å¼€å§‹æœ‰ä»¥ä¸‹æ•°æ®ï¼š 0x0000 0x0001 0x0002 0x0003 0x12 0x34 0xab 0xcd","text":"å¤§ç«¯å’Œå°ç«¯ï¼ˆBig endian and Little endianï¼‰ç½‘ç»œå­—èŠ‚åºç½‘ç»œå­—èŠ‚é¡ºåºæ˜¯TCP/IPä¸­è§„å®šå¥½çš„ä¸€ç§æ•°æ®è¡¨ç¤ºæ ¼å¼ï¼Œå®ƒä¸å…·ä½“çš„CPUç±»å‹ã€æ“ä½œç³»ç»Ÿç­‰æ— å…³ï¼Œä»è€Œå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸åŒä¸»æœºä¹‹é—´ä¼ è¾“æ—¶èƒ½å¤Ÿè¢«æ­£ç¡®è§£é‡Šã€‚ç½‘ç»œå­—èŠ‚é¡ºåºé‡‡ç”¨big endianæ’åºæ–¹å¼ã€‚ ç”±æ­¤å¯çŸ¥ï¼Œç½‘ç»œå­—èŠ‚åºæ˜¯å¤§ç«¯åºçš„ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯Big endianå‘¢ï¼Ÿ ä¸€ã€å¤§ç«¯å’Œå°ç«¯çš„é—®é¢˜å¯¹äºæ•´å‹ã€é•¿æ•´å‹ç­‰æ•°æ®ç±»å‹ï¼ŒBig endian è®¤ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯æœ€é«˜ä½å­—èŠ‚ï¼ˆæŒ‰ç…§ä»ä½åœ°å€åˆ°é«˜åœ°å€çš„é¡ºåºå­˜æ”¾æ•°æ®çš„é«˜ä½å­—èŠ‚åˆ°ä½ä½å­—èŠ‚ï¼‰ï¼›è€Œ Little endian åˆ™ç›¸åï¼Œå®ƒè®¤ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯æœ€ä½ä½å­—èŠ‚ï¼ˆæŒ‰ç…§ä»ä½åœ°å€åˆ°é«˜åœ°å€çš„é¡ºåºå­˜æ”¾æ•°æ®çš„ä½ä½å­—èŠ‚åˆ°é«˜ä½å­—èŠ‚ï¼‰ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ä»å†…å­˜åœ°å€ 0x0000 å¼€å§‹æœ‰ä»¥ä¸‹æ•°æ®ï¼š 0x0000 0x0001 0x0002 0x0003 0x12 0x34 0xab 0xcd å¦‚æœæˆ‘ä»¬å»è¯»å–ä¸€ä¸ªåœ°å€ä¸º 0x0000 çš„å››ä¸ªå­—èŠ‚å˜é‡ï¼Œè‹¥å­—èŠ‚åºä¸ºbig-endianï¼Œåˆ™è¯»å‡ºç»“æœä¸º0x1234abcdï¼›è‹¥å­—èŠ‚åºä¸ºlittle-endianï¼Œåˆ™è¯»å‡ºç»“æœä¸º0xcdab3412ã€‚ å¦‚æœæˆ‘ä»¬å°†0x1234abcd å†™å…¥åˆ°ä»¥ 0x0000 å¼€å§‹çš„å†…å­˜ä¸­ï¼Œåˆ™Little endian å’Œ Big endian æ¨¡å¼çš„å­˜æ”¾ç»“æœå¦‚ä¸‹ï¼š åœ°å€ 0x0000 0x0001 0x0002 0x0003 big-endian 0x12 0x34 0xab 0xcd little-endian 0xcd 0xab 0x34 0x12 ä¸€èˆ¬æ¥è¯´ï¼Œx86 ç³»åˆ— CPU éƒ½æ˜¯ little-endian çš„å­—èŠ‚åºï¼ŒPowerPC é€šå¸¸æ˜¯ big-endianï¼Œç½‘ç»œå­—èŠ‚é¡ºåºä¹Ÿæ˜¯ big-endianè¿˜æœ‰çš„CPU èƒ½é€šè¿‡è·³çº¿æ¥è®¾ç½® CPU å·¥ä½œäº Little endian è¿˜æ˜¯ Big endian æ¨¡å¼ã€‚ å¯¹äº0x12345678çš„å­˜å‚¨ï¼š å°ç«¯æ¨¡å¼ï¼šï¼ˆä»ä½å­—èŠ‚åˆ°é«˜å­—èŠ‚ï¼‰åœ°ä½åœ°å€ 0x78 0x56 0x34 0x12 å¤§ç«¯æ¨¡å¼ï¼šï¼ˆä»é«˜å­—èŠ‚åˆ°ä½å­—èŠ‚ï¼‰åœ°ä½åœ°å€ 0x12 0x34 0x56 0x78 äºŒã€Cè¯­è¨€å¤§ç«¯å°ç«¯è½¬æ¢æ–¹æ³• Big-Endianè½¬æ¢æˆLittle-Endian 123#define BigtoLittle16(A) ((((uint16)(A) &amp; 0xff00) &gt;&gt; 8) | (((uint16)(A) &amp; 0x00ff) &lt;&lt; 8))#define BigtoLittle32(A) ((((uint32)(A) &amp; 0xff000000) &gt;&gt; 24) | (((uint32)(A) &amp; 0x00ff0000) &gt;&gt; 8) | \\(((uint32)(A) &amp; 0x0000ff00) &lt;&lt; 8) | (((uint32)(A) &amp; 0x000000ff) &lt;&lt; 24)) ä¸‰ã€Cè¯­è¨€å¤§ç«¯å°ç«¯æ£€æµ‹æ–¹æ³•123456int i = 1;char *p = (char *)&amp;i;if(*p == 1) printf(\"Little Endian\");else printf(\"Big Endian\"); å¤§å°ç«¯å­˜å‚¨é—®é¢˜ï¼Œå¦‚æœå°ç«¯æ–¹å¼ä¸­ï¼ˆiå è‡³å°‘ä¸¤ä¸ªå­—èŠ‚çš„é•¿åº¦ï¼‰åˆ™iæ‰€åˆ†é…çš„å†…å­˜æœ€å°åœ°å€é‚£ä¸ªå­—èŠ‚ä¸­å°±å­˜ç€1ï¼Œå…¶ä»–å­—èŠ‚æ˜¯0.å¤§ç«¯çš„è¯åˆ™1åœ¨içš„æœ€é«˜åœ°å€å­—èŠ‚å¤„å­˜æ”¾ï¼Œcharæ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å¼ºåˆ¶å°†charå‹é‡pæŒ‡å‘iåˆ™pæŒ‡å‘çš„ä¸€å®šæ˜¯içš„æœ€ä½åœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ¤æ–­pä¸­çš„å€¼æ˜¯ä¸æ˜¯1æ¥ç¡®å®šæ˜¯ä¸æ˜¯å°ç«¯ã€‚ è”åˆä½“unionçš„å­˜æ”¾é¡ºåºæ˜¯æ‰€æœ‰æˆå‘˜éƒ½ä»ä½åœ°å€å¼€å§‹å­˜æ”¾ï¼Œåˆ©ç”¨è¯¥ç‰¹æ€§å°±å¯ä»¥è½»æ¾åœ°è·å¾—äº†CPUå¯¹å†…å­˜é‡‡ç”¨Little-endianè¿˜æ˜¯Big-endianæ¨¡å¼è¯»å†™ã€‚ 1234567891011/*return 1: little-endian, return 0: big-endian*/int checkCPUendian()&#123;union &#123; unsigned int a; unsigned char b; &#125;c; c.a = 1; return (c.b == 1);&#125; å®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œæ¥çœ‹çœ‹Linux æ“ä½œç³»ç»Ÿä¸­ç›¸å…³çš„æºä»£ç æ˜¯æ€ä¹ˆåšçš„ï¼š 123static union &#123; char c[4]; unsigned long mylong; &#125; endian_test = &#123;&#123; 'l', '?', '?', 'b' &#125; &#125;;#define ENDIANNESS ((char)endian_test.mylong) Linux çš„å†…æ ¸ä½œè€…ä»¬ä»…ä»…ç”¨ä¸€ä¸ªunion å˜é‡å’Œä¸€ä¸ªç®€å•çš„å®å®šä¹‰å°±å®ç°äº†ä¸€å¤§æ®µä»£ç åŒæ ·çš„åŠŸèƒ½ï¼ï¼ˆå¦‚æœENDIANNESS=â€™lâ€™è¡¨ç¤ºç³»ç»Ÿä¸ºlittle endianï¼Œä¸ºâ€™bâ€™è¡¨ç¤ºbig endianï¼‰ å››ã€ç›¸å…³çš„ä¸€äº›é—®é¢˜é—®é¢˜ä¸€ï¼š 123char *sz = \"0123456789\";int *p = (int*)sz;printf(\"%x\\n\",*++p); é—®ï¼šå­—ç¬¦â€™0â€™å¯¹åº”çš„åå…­è¿›åˆ¶æ˜¯0x30ï¼Œè¯·é—®åœ¨x86ç¯å¢ƒä¸‹ç¨‹åºè¾“å‡ºæ˜¯å¤šå°‘ï¼Ÿ è§£ç­”ï¼š å‡è®¾ å­—ç¬¦ä¸²szåœ°å€ ä» $0 å¼€å§‹ï¼Œé‚£ä¹ˆszåœ¨å†…å­˜çš„å­˜å‚¨ä¸º $0 $1 $2 $3 $4 $5 $6 $7 $8 $9 0x30 0x31 0x32 0x33 0x34 0x35 0x36 0x37 0x38 0x39 å½“ä½ æŠŠcharå¼ºåˆ¶ç±»å‹è½¬åŒ–æˆintåï¼Œå› ä¸ºintå å››ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆpæŒ‡å‘$0ï¼Œå¹¶ä¸”på æœ‰çš„åœ°å€æ˜¯*$0$1$2$3ï¼Œæ‰“å°çš„æ—¶å€™ å…ˆè¿›è¡Œ++pæ“ä½œï¼Œé‚£ä¹ˆpæŒ‡å‘$4ï¼Œæ­¤æ—¶*på æœ‰çš„åœ°å€æ˜¯$4$5$6$7*ï¼Œæ ¹æ®ä¸Šé¢åœ°åœ°å€å­˜åœ°ä½ï¼Œlittle endianï¼Œé‚£ä¹ˆpåº”è¯¥ç­‰äº0x37363534 é—®é¢˜äºŒï¼š 123int a = 0x12345678;char *p = (char*)(&amp;a);printf(\"%x\\n\",*(p+1)); ä¾‹å¦‚å¯¹äº0x12345678ï¼Œç½‘ç»œå­—èŠ‚é¡ºåºæ˜¯è¿™æ ·0x12,0x34,0x56,0x78å­˜å‚¨çš„ï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºbig-endianintelå¤„ç†å™¨æ˜¯0x78 0x56 0x34 0x12è¿™æ ·æ¥å­˜å‚¨çš„ï¼Œç§°ä¸ºå°å°¾little-endianåœ¨x86ç¯å¢ƒä¸‹é¢˜ç›®ä¸­çš„pæŒ‡å‘0x78ï¼ŒåŠ 1åæŒ‡å‘0x56 é—®é¢˜ä¸‰ï¼š 12345678910111213#include &lt;stdio.h&gt;union&#123; int i; char x[2];&#125;a;int main()&#123;a.x[0] = 10; a.x[1] = 1; printf(\"%d\",a.i); return 0;&#125; x86ä¸‹è¾“å‡ºç­”æ¡ˆï¼š 266 ï¼ˆx86ä¸‹ï¼šiå†…å­˜é‡Œå­˜çš„å€¼æ˜¯Ox010Aï¼Œåè¿›åˆ¶ä¸º266ï¼‰ é—®é¢˜å››ï¼š 123456789101112131415161718int main()&#123;union &#123; int i; struct &#123; char first; char second; &#125;half; &#125;number; number.i=0x4241; printf(\"%c %c\\n\", number.half.first, number.half.second); number.half.first='a'; number.half.second='b'; printf(\"%x\\n\", number.i); return 0;&#125; x86ä¸‹è¾“å‡ºç­”æ¡ˆï¼š A B (0x41å¯¹åº”â€™Aâ€™,æ˜¯ä½ä½ï¼›Ox42å¯¹åº”â€™Bâ€™,æ˜¯é«˜ä½ï¼‰6261 (number.iå’Œnumber.halfå…±ç”¨ä¸€å—åœ°å€ç©ºé—´0x6261ï¼‰","categories":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"è¿›åˆ¶","slug":"è¿›åˆ¶","permalink":"http://blog.crazylaw.cn/tags/%E8%BF%9B%E5%88%B6/"},{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/tags/%E7%BD%91%E7%BB%9C/"}]},{"title":"è¿›åˆ¶è½¬æ¢ç›¸å…³çŸ¥è¯†","slug":"bin-hex-oct","date":"2017-06-28T02:43:00.000Z","updated":"2021-03-20T16:25:01.801Z","comments":true,"path":"2017/06/28/bin-hex-oct/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/28/bin-hex-oct/","excerpt":"è¿›åˆ¶è½¬æ¢ å¥½ä¹…éƒ½æ²¡æœ‰å¥½å¥½æ•´ç†è¿‡è¿›åˆ¶ä¹‹é—´è½¬æ¢çš„å…³ç³»äº†ã€‚æœ€è¿‘åœ¨ç ”ç©¶ RPC çš„å†…å®¹ï¼Œæœ‰ä¸€äº›ç†è®ºçŸ¥è¯†å¿…é¡»è¦é‡æ–°æ•´ç†ä¸€ä¸‹ã€‚ ç”±äºæ•°æ®åœ¨è®¡ç®—æœºä¸­çš„è¡¨ç¤ºï¼Œæœ€ç»ˆä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜åœ¨ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä½¿ç”¨äºŒè¿›åˆ¶ï¼Œå¯ä»¥æ›´ç›´è§‚åœ°è§£å†³é—®é¢˜ã€‚ ä½†æ˜¯æœ‰ä¸€äº›æ—¶å€™ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºçš„æ•°æ®å®åœ¨çš„å¤ªé•¿äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€äº›æ›´é«˜è¿›åˆ¶çš„æ•°æ¥è¡¨ç¤ºæ•°æ®ï¼Œè€Œæˆ‘ä»¬ä»å°å­¦ä¹ çš„æ•°å­¦ï¼Œå°±æ˜¯ä»¥ 10 è¿›åˆ¶æ¥ä»£è¡¨çš„ã€‚ è¿›åˆ¶æ•°è¶Šå¤§ï¼Œæ‰€éœ€è¦æ•°é•¿åº¦å°±è¶ŠçŸ­ã€‚ æˆ‘ä»¬å¸¸ç”¨çš„è¿›åˆ¶æœ‰ 2ã€8ã€16 è¿›åˆ¶ï¼Œåˆ†åˆ«æ˜¯ 2 çš„ 1 ä¸€æ¬¡æ–¹ï¼Œ2 çš„ 3 æ¬¡æ–¹ï¼Œ2 çš„ 4 æ¬¡æ–¹ã€‚ï¼ˆè‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰ 3 è¿›åˆ¶ï¼Œ4 è¿›åˆ¶è¯¸å¦‚æ­¤ç±»çš„ï¼Œå„ä½ç™¾åº¦ä¸€ä¸‹å§ï¼‰","text":"è¿›åˆ¶è½¬æ¢ å¥½ä¹…éƒ½æ²¡æœ‰å¥½å¥½æ•´ç†è¿‡è¿›åˆ¶ä¹‹é—´è½¬æ¢çš„å…³ç³»äº†ã€‚æœ€è¿‘åœ¨ç ”ç©¶ RPC çš„å†…å®¹ï¼Œæœ‰ä¸€äº›ç†è®ºçŸ¥è¯†å¿…é¡»è¦é‡æ–°æ•´ç†ä¸€ä¸‹ã€‚ ç”±äºæ•°æ®åœ¨è®¡ç®—æœºä¸­çš„è¡¨ç¤ºï¼Œæœ€ç»ˆä»¥äºŒè¿›åˆ¶çš„å½¢å¼å­˜åœ¨ï¼Œæ‰€ä»¥æœ‰æ—¶å€™ä½¿ç”¨äºŒè¿›åˆ¶ï¼Œå¯ä»¥æ›´ç›´è§‚åœ°è§£å†³é—®é¢˜ã€‚ ä½†æ˜¯æœ‰ä¸€äº›æ—¶å€™ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºçš„æ•°æ®å®åœ¨çš„å¤ªé•¿äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½éœ€è¦ä¸€äº›æ›´é«˜è¿›åˆ¶çš„æ•°æ¥è¡¨ç¤ºæ•°æ®ï¼Œè€Œæˆ‘ä»¬ä»å°å­¦ä¹ çš„æ•°å­¦ï¼Œå°±æ˜¯ä»¥ 10 è¿›åˆ¶æ¥ä»£è¡¨çš„ã€‚ è¿›åˆ¶æ•°è¶Šå¤§ï¼Œæ‰€éœ€è¦æ•°é•¿åº¦å°±è¶ŠçŸ­ã€‚ æˆ‘ä»¬å¸¸ç”¨çš„è¿›åˆ¶æœ‰ 2ã€8ã€16 è¿›åˆ¶ï¼Œåˆ†åˆ«æ˜¯ 2 çš„ 1 ä¸€æ¬¡æ–¹ï¼Œ2 çš„ 3 æ¬¡æ–¹ï¼Œ2 çš„ 4 æ¬¡æ–¹ã€‚ï¼ˆè‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰ 3 è¿›åˆ¶ï¼Œ4 è¿›åˆ¶è¯¸å¦‚æ­¤ç±»çš„ï¼Œå„ä½ç™¾åº¦ä¸€ä¸‹å§ï¼‰ è¿›åˆ¶è§„åˆ™å¦‚ä¸‹ï¼š 2 è¿›åˆ¶ï¼Œç”¨ä¸¤ä¸ªé˜¿æ‹‰ä¼¯æ•°å­—ï¼š0ã€1ï¼› 8 è¿›åˆ¶ï¼Œç”¨å…«ä¸ªé˜¿æ‹‰ä¼¯æ•°å­—ï¼š0ã€1ã€2ã€3ã€4ã€5ã€6ã€7ï¼› 10 è¿›åˆ¶ï¼Œç”¨åä¸ªé˜¿æ‹‰ä¼¯æ•°å­—ï¼š0 åˆ° 9ï¼› 16 è¿›åˆ¶ï¼Œç”¨åå…­ä¸ªé˜¿æ‹‰ä¼¯æ•°å­—â€¦â€¦ç­‰ç­‰ï¼Œé˜¿æ‹‰ä¼¯äººæˆ–è¯´æ˜¯å°åº¦äººï¼Œåªå‘æ˜äº† 10 ä¸ªæ•°å­—å•Šï¼Ÿ 16 è¿›åˆ¶å°±æ˜¯é€¢ 16 è¿› 1ï¼Œä½†æˆ‘ä»¬åªæœ‰ 0~9 è¿™åä¸ªæ•°å­—ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ Aï¼ŒBï¼ŒCï¼ŒDï¼ŒEï¼ŒF è¿™å…­ä¸ªå­—æ¯æ¥åˆ†åˆ«è¡¨ç¤º 10ï¼Œ11ï¼Œ12ï¼Œ13ï¼Œ14ï¼Œ15ã€‚å­—æ¯ä¸åŒºåˆ†å¤§å°å†™ã€‚ åè¿›åˆ¶è½¬äºŒè¿›åˆ¶å¦‚æœæˆ‘æœ‰ä¸€ä¸ªæ•°å­— 3ï¼Œæƒ³è¦è½¬æˆ 2 è¿›åˆ¶ã€‚ä½†æ˜¯åªæœ‰ 0ã€1 ä¸¤ä¸ªæ•°å­—ï¼Œå¦‚ä½•è¡¨ç¤º 3 çš„å‘¢ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦é€¢äºŒè¿›ä¸€ï¼Œä» 2 å¼€å§‹è®¡ç®—ã€‚2 çš„è¿›åˆ¶æ˜¯ 10ï¼Œ3/2=1ï¼Œæ‰€ä»¥å°±æ˜¯ 11ï¼Œ4 çš„è¿›åˆ¶å‘¢ï¼ŒåŒç†ï¼š4/2 = 2ã€‚æ‰€ä»¥å°±ä» 10 å˜æˆäº† 100ã€‚æ‰€ä»¥æ˜¯ 3 å˜æˆ 4 çš„è¯ï¼Œå°±æ˜¯ä½ä½+1.è¿›ä¸€ä½å˜æˆ 100. äºŒè¿›åˆ¶è½¬å…«è¿›åˆ¶ï¼ˆä»ä½ä½èµ·ç®—ï¼Œæ¯ä¸‰ä½äºŒè¿›åˆ¶æ•°ä»£è¡¨ä¸€ä½ 8 è¿›åˆ¶ä½ï¼‰ æœ‰äººä¼šé—®ï¼Œä¸ºä»€ä¹ˆæ¯ä¸‰ä½äºŒè¿›åˆ¶ä»£è¡¨ä¸€ä¸ª 8 è¿›åˆ¶ä½å‘¢ï¼Œé‚£æ˜¯å› ä¸º 2 çš„ä¸‰æ¬¡æ–¹æ˜¯ 8 çš„å…³ç³»ã€‚æ‰€ä»¥äºŒè¿›åˆ¶çš„æ¯ 3 ä½ï¼Œéƒ½è¦ä»£è¡¨ 8 è¿›åˆ¶çš„è¿›ä¸€ä½ã€‚ ä¾‹å¦‚æˆ‘æœ‰ï¼ˆåè¿›åˆ¶ï¼š10ï¼‰00001010,è¦è½¬æˆ 8 è¿›åˆ¶å°±æ˜¯ 012ã€‚ äºŒè¿›åˆ¶è½¬åå…­è¿›åˆ¶ï¼ˆåŒç†è½¬å…«è¿›åˆ¶å¯å¾—ï¼Œæ¯ 4 ä½äºŒè¿›åˆ¶æ•°ä»£è¡¨ä¸€ä¸ªåå…­è¿›åˆ¶ä½ï¼‰ä¾‹å¦‚æˆ‘æœ‰ï¼ˆåè¿›åˆ¶ï¼š10ï¼‰00001010ï¼Œè¦è½¬æˆ 16 è¿›åˆ¶å°±æ˜¯ 0xAã€‚ æ¶‰åŠ PHPåœ¨ PHP å½“ä¸­ï¼Œéœ€è¦è¡¨ç¤ºå…«è¿›åˆ¶çš„æ—¶å€™ï¼Œéœ€è¦ç”¨ 0 å¼€å¤´çš„æ•´æ•°ï¼Œè¾“å‡ºå‡ºæ¥çš„æ•°æ®ä¼šè¢«è§£æè½¬æˆåè¿›åˆ¶çš„æ•°æ®ã€‚è€Œè¡¨ç¤ºåå…­è¿›åˆ¶çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ°çš„æ˜¯ 0x å¼€å¤´ åè¿›åˆ¶è½¬äºŒè¿›åˆ¶ =&gt; decbin($decVar) åè¿›åˆ¶è½¬åå…­è¿›åˆ¶ =&gt; dechex($decVar) åå…­è¿›åˆ¶è½¬åè¿›åˆ¶ =&gt; hexdec($hexVar) äºŒè¿›åˆ¶è½¬åè¿›åˆ¶ =&gt; bindec($binVar)","categories":[{"name":"è¿›åˆ¶","slug":"è¿›åˆ¶","permalink":"http://blog.crazylaw.cn/categories/%E8%BF%9B%E5%88%B6/"}],"tags":[{"name":"è¿›åˆ¶","slug":"è¿›åˆ¶","permalink":"http://blog.crazylaw.cn/tags/%E8%BF%9B%E5%88%B6/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®è¡Œä¸ºå‹ã®ç­–ç•¥æ¨¡å¼","slug":"design-strategy-model","date":"2017-06-22T07:23:00.000Z","updated":"2021-03-20T16:25:01.804Z","comments":true,"path":"2017/06/22/design-strategy-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-strategy-model/","excerpt":"åŸºæœ¬æ¦‚å¿µç­–ç•¥æ¨¡å¼æ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨ï¼Œä¸”éå¸¸æœ‰ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚ç®€å•çš„è¯´ï¼Œå®ƒæ˜¯å½“ä½ ä½¿ç”¨å¤§é‡ if else é€»è¾‘æ—¶çš„æ•‘æ˜Ÿã€‚if else å°±æ˜¯ä¸€ç§åˆ¤æ–­ä¸Šä¸‹æ–‡çš„ç¯å¢ƒæ‰€ä½œå‡ºçš„ç­–ç•¥ï¼Œå¦‚æœä½ æŠŠ if else å†™æ­»ï¼Œé‚£ä¹ˆåœ¨å¤æ‚é€»è¾‘çš„æ—¶å€™ä½ ä¼šå‘ç°ä»£ç è¶…çº§é•¿ï¼Œè€Œä¸”æœ€è›‹ç–¼çš„æ˜¯ï¼Œå½“ä½ ä»¥åè¦æ–°å¢ç­–ç•¥æ—¶ï¼Œå†å†™ä¸€ä¸ª elseifï¼Ÿä¸‡ä¸€è¿™ä¸ªé€»è¾‘è¦ä¿®æ”¹ 20 ä¸ªåœ°æ–¹å‘¢ï¼Ÿä¸€å£è€è¡€ååœ¨å±å¹•ä¸Šâ€¦ç­–ç•¥æ¨¡å¼å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚ä¸¾ä¸€ä¸ªåœºæ™¯ï¼Œå•†åŸçš„é¦–é¡µï¼Œç”·çš„è¿›æ¥çœ‹ç”·æ€§å•†å“ï¼Œå¥³çš„è¿›æ¥çœ‹å¥³æ€§å•†å“ï¼Œä¸ç”·ä¸å¥³â€¦ä»¥æ­¤ç±»æ¨ï¼Œå„ç§æ¡ä»¶ä¸‹ç”¨ä¸åŒç­–ç•¥å±•ç¤ºä¸åŒå•†å“ã€‚","text":"åŸºæœ¬æ¦‚å¿µç­–ç•¥æ¨¡å¼æ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨ï¼Œä¸”éå¸¸æœ‰ç”¨çš„è®¾è®¡æ¨¡å¼ã€‚ç®€å•çš„è¯´ï¼Œå®ƒæ˜¯å½“ä½ ä½¿ç”¨å¤§é‡ if else é€»è¾‘æ—¶çš„æ•‘æ˜Ÿã€‚if else å°±æ˜¯ä¸€ç§åˆ¤æ–­ä¸Šä¸‹æ–‡çš„ç¯å¢ƒæ‰€ä½œå‡ºçš„ç­–ç•¥ï¼Œå¦‚æœä½ æŠŠ if else å†™æ­»ï¼Œé‚£ä¹ˆåœ¨å¤æ‚é€»è¾‘çš„æ—¶å€™ä½ ä¼šå‘ç°ä»£ç è¶…çº§é•¿ï¼Œè€Œä¸”æœ€è›‹ç–¼çš„æ˜¯ï¼Œå½“ä½ ä»¥åè¦æ–°å¢ç­–ç•¥æ—¶ï¼Œå†å†™ä¸€ä¸ª elseifï¼Ÿä¸‡ä¸€è¿™ä¸ªé€»è¾‘è¦ä¿®æ”¹ 20 ä¸ªåœ°æ–¹å‘¢ï¼Ÿä¸€å£è€è¡€ååœ¨å±å¹•ä¸Šâ€¦ç­–ç•¥æ¨¡å¼å°±æ˜¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚ä¸¾ä¸€ä¸ªåœºæ™¯ï¼Œå•†åŸçš„é¦–é¡µï¼Œç”·çš„è¿›æ¥çœ‹ç”·æ€§å•†å“ï¼Œå¥³çš„è¿›æ¥çœ‹å¥³æ€§å•†å“ï¼Œä¸ç”·ä¸å¥³â€¦ä»¥æ­¤ç±»æ¨ï¼Œå„ç§æ¡ä»¶ä¸‹ç”¨ä¸åŒç­–ç•¥å±•ç¤ºä¸åŒå•†å“ã€‚ å®ç°showStrategy . php å±•ç¤ºç­–ç•¥æ¥å£1234interface showStrategy&#123; public function showCategory();&#125; maleShowStrategy . php ç”·æ€§ç”¨æˆ·å±•ç¤ºç­–ç•¥1234567class maleShowStrategy implements showStrategy&#123; // å…·ä½“ç­–ç•¥A public function showCategory() &#123; echo 'å±•ç¤ºç”·æ€§å•†å“ç›®å½•'; &#125;&#125; femaleShowStrategy . php å¥³æ€§ç”¨æˆ·å±•ç¤ºç­–ç•¥1234567class femaleShowStrategy implements showStrategy&#123; // å…·ä½“ç­–ç•¥B public function showCategory() &#123; echo 'å±•ç¤ºå¥³æ€§å•†å“ç›®å½•'; &#125;&#125; page . php å±•ç¤ºé¡µé¢1234567891011121314class Page&#123; private $_strategy; public function __construct(showStrategy $strategy) &#123; $this-&gt;_strategy = $strategy; &#125; public function showPage() &#123; $this-&gt;_strategy-&gt;showCategory(); &#125;&#125; ä½¿ç”¨12345678910111213$_GET['male'] = 1;if (isset($_GET['male']))&#123; $strategy = new maleShowStrategy();&#125; elseif (isset($_GET['female']))&#123; $strategy = new femaleShowStrategy();&#125;//æ³¨æ„çœ‹è¿™é‡Œä¸Šä¸‹ï¼ŒPageç±»ä¸å†ä¾èµ–ä¸€ç§å…·ä½“çš„ç­–ç•¥ï¼Œè€Œæ˜¯åªéœ€è¦ç»‘å®šä¸€ä¸ªæŠ½è±¡çš„æ¥å£ï¼Œè¿™å°±æ˜¯ä¼ è¯´ä¸­çš„æ§åˆ¶åè½¬ï¼ˆIOCï¼‰ã€‚$question = new Page($strategy);$question-&gt;showPage(); æ€»ç»“ä»”ç»†çœ‹ä¸Šé¢çš„ä¾‹å­ï¼Œä¸å¤æ‚ï¼Œæˆ‘ä»¬å‘ç°æœ‰ 2 ä¸ªå¥½å¤„ï¼š å®ƒæŠŠ if else æŠ½ç¦»å‡ºæ¥äº†ï¼Œä¸éœ€è¦åœ¨æ¯ä¸ªç±»é‡Œéƒ½å†™ if elseï¼› å®ƒæˆåŠŸçš„å®ç°äº†æ§åˆ¶åè½¬ï¼ŒPage ç±»é‡Œæ²¡æœ‰å…·ä½“çš„ä¾èµ–ç­–ç•¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éšæ—¶æ·»åŠ å’Œåˆ é™¤ ä¸åŒçš„ç­–ç•¥ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼ï¼ŒPHP","slug":"è®¾è®¡æ¨¡å¼ï¼ŒPHP","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%8CPHP/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®è¡Œä¸ºå‹ã®è´£ä»»é“¾æ¨¡å¼","slug":"design-chain-of-responsibility-model","date":"2017-06-22T07:06:00.000Z","updated":"2021-03-20T16:25:01.802Z","comments":true,"path":"2017/06/22/design-chain-of-responsibility-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-chain-of-responsibility-model/","excerpt":"ç†è§£æ¦‚å¿µè´£ä»»é“¾æ˜¯ä¸€ç§æ¯”è¾ƒé«˜çº§çš„è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œå°±æ˜¯å½“ä½ æœ‰ä¸€ä¸ªè¯·æ±‚ï¼Œä½ ä¸çŸ¥é“ç”¨é‚£ä¸ªæ–¹æ³•(handler)æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚æ—¶ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªè¯·æ±‚ä¸¢è¿›ä¸€ä¸ªè´£ä»»é“¾é‡Œï¼ˆé‡Œé¢æœ‰å¾ˆå¤šæ–¹æ³•ï¼‰ï¼Œè¿™ä¸ªè´£ä»»é“¾ä¼šé€šè¿‡è½®è¯¢çš„æ–¹å¼è‡ªåŠ¨æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ã€‚ æ¯”å¦‚æˆ‘è¦ç¿»è¯‘ä¸€ä¸ªå•è¯ï¼Œæˆ‘å†™è¿™ä¸ªä»£ç çš„æ—¶å€™ï¼Œæ ¹æœ¬ä¸çŸ¥é“ç”¨æˆ·ä¼šè¾“å…¥ä»€ä¹ˆè¯­è¨€ï¼Œæ‰€ä»¥æˆ‘å¹²è„†å°±ä¸ç®¡äº†ï¼Œæ— è®ºç”¨æˆ·è¾“å…¥ä»€ä¹ˆè¯­è¨€ï¼Œæˆ‘æŠŠå®ƒè¾“å…¥çš„å†…å®¹ä¸¢è¿›ä¸€ä¸ªè´£ä»»é“¾ï¼Œè¿™ä¸ªè´£ä»»é“¾é‡Œæœ‰å¾·è¯­ç¿»è¯‘å™¨ï¼Œè‹±è¯­ç¿»è¯‘å™¨ï¼Œæ³•è¯­ç¿»è¯‘å™¨ï¼Œæ±‰è¯­ç¿»è¯‘å™¨ï¼Œæ—¥è¯­ç¿»è¯‘å™¨ç­‰ç­‰ç­‰ç­‰ï¼Œä¸¢è¿›å»çš„æ—¶å€™å®ƒå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾äº†ï¼Œæ‰¾åˆ°å¯¹åº”çš„è¯­è¨€å°±ä¼šè‡ªåŠ¨ç¿»è¯‘å‡ºæ¥ã€‚","text":"ç†è§£æ¦‚å¿µè´£ä»»é“¾æ˜¯ä¸€ç§æ¯”è¾ƒé«˜çº§çš„è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œå°±æ˜¯å½“ä½ æœ‰ä¸€ä¸ªè¯·æ±‚ï¼Œä½ ä¸çŸ¥é“ç”¨é‚£ä¸ªæ–¹æ³•(handler)æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚æ—¶ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªè¯·æ±‚ä¸¢è¿›ä¸€ä¸ªè´£ä»»é“¾é‡Œï¼ˆé‡Œé¢æœ‰å¾ˆå¤šæ–¹æ³•ï¼‰ï¼Œè¿™ä¸ªè´£ä»»é“¾ä¼šé€šè¿‡è½®è¯¢çš„æ–¹å¼è‡ªåŠ¨æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ã€‚ æ¯”å¦‚æˆ‘è¦ç¿»è¯‘ä¸€ä¸ªå•è¯ï¼Œæˆ‘å†™è¿™ä¸ªä»£ç çš„æ—¶å€™ï¼Œæ ¹æœ¬ä¸çŸ¥é“ç”¨æˆ·ä¼šè¾“å…¥ä»€ä¹ˆè¯­è¨€ï¼Œæ‰€ä»¥æˆ‘å¹²è„†å°±ä¸ç®¡äº†ï¼Œæ— è®ºç”¨æˆ·è¾“å…¥ä»€ä¹ˆè¯­è¨€ï¼Œæˆ‘æŠŠå®ƒè¾“å…¥çš„å†…å®¹ä¸¢è¿›ä¸€ä¸ªè´£ä»»é“¾ï¼Œè¿™ä¸ªè´£ä»»é“¾é‡Œæœ‰å¾·è¯­ç¿»è¯‘å™¨ï¼Œè‹±è¯­ç¿»è¯‘å™¨ï¼Œæ³•è¯­ç¿»è¯‘å™¨ï¼Œæ±‰è¯­ç¿»è¯‘å™¨ï¼Œæ—¥è¯­ç¿»è¯‘å™¨ç­‰ç­‰ç­‰ç­‰ï¼Œä¸¢è¿›å»çš„æ—¶å€™å®ƒå°±ä¼šè‡ªåŠ¨æŸ¥æ‰¾äº†ï¼Œæ‰¾åˆ°å¯¹åº”çš„è¯­è¨€å°±ä¼šè‡ªåŠ¨ç¿»è¯‘å‡ºæ¥ã€‚ å®ç°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071abstract class TranslationResponsibility&#123; // æŠ½è±¡è´£ä»»è§’è‰² protected $next; // ä¸‹ä¸€ä¸ªè´£ä»»è§’è‰² protected $translator; public function setNext(TranslationResponsibility $l) &#123; $this-&gt;next = $l; return $this; &#125; public function canTranslate($input) &#123; return $this-&gt;translator == $this-&gt;check($input); &#125; // ä¸å…è®¸è¢«ç»§æ‰¿ï¼Œç”¨final public final function check($input) &#123; //å†™éªŒè¯è¾“å…¥è¯­è¨€æ€»ç±»çš„é€»è¾‘ if ($input == 'ç™½èœ') &#123; return 'English'; &#125; return 'French'; &#125; abstract public function translate($input); // ç¿»è¯‘æ–¹æ³•&#125;class EnglishTranslator extends TranslationResponsibility&#123; public function __construct() &#123; $this-&gt;translator = 'English'; &#125; public function translate($input) &#123; //å¦‚æœå½“å‰ç¿»è¯‘å™¨ç¿»è¯‘ä¸äº†ï¼Œå¹¶ä¸”è´£ä»»é“¾ä¸Šè¿˜æœ‰ä¸‹ä¸€ä¸ªç¿»è¯‘å™¨å¯ç”¨ï¼Œåˆ™è®©ä¸‹ä¸€ä¸ªç¿»è¯‘å™¨è¯•è¯• if (!is_null($this-&gt;next) &amp;&amp; !$this-&gt;canTranslate($input)) &#123; $this-&gt;next-&gt;translate($input); &#125; else &#123; echo 'è‹±è¯­é€»è¾‘'; &#125; &#125;&#125;class FrenchTranslator extends TranslationResponsibility&#123; public function __construct() &#123; $this-&gt;translator = 'French'; &#125; public function translate($input) &#123; //å¦‚æœå½“å‰ç¿»è¯‘å™¨ç¿»è¯‘ä¸äº†ï¼Œå¹¶ä¸”è´£ä»»é“¾ä¸Šè¿˜æœ‰ä¸‹ä¸€ä¸ªç¿»è¯‘å™¨å¯ç”¨ï¼Œåˆ™è®©ä¸‹ä¸€ä¸ªç¿»è¯‘å™¨è¯•è¯• if (!is_null($this-&gt;next) &amp;&amp; !$this-&gt;canTranslate($input)) &#123; $this-&gt;next-&gt;translate($input); &#125; else &#123; echo 'æ³•è¯­é€»è¾‘'; &#125; &#125;&#125; ä½¿ç”¨12345678//ç»„å»ºæ³¨å†Œé“¾$res_a = new EnglishTranslator();$res_b = new FrenchTranslator();$res_a-&gt;setNext($res_b);//ä½¿ç”¨$res_a-&gt;translate('ç™½èœ'); // è‹±è¯­é€»è¾‘$res_a-&gt;translate('ç™½èœ2'); // æ³•è¯­é€»è¾‘ ç»“æœå°±æ˜¯ï¼Œè‹±è¯­ç¿»è¯‘å™¨ç¿»è¯‘ä¸äº†ï¼Œä¼ é€’åˆ°æ³•è¯­ç¿»è¯‘å™¨ç¿»è¯‘ã€‚ æ³¨æ„ï¼Œè¿™é‡Œä¸ºäº†ç®€åŒ–è¯´æ˜ï¼Œåªå±•ç¤ºäº† 2 ä¸ªç¿»è¯‘å™¨äº’ä¸ºè´£ä»»é“¾çš„æƒ…å†µï¼Œå¦‚æœä½ éœ€è¦å¤šä¸ªç¿»è¯‘å™¨ï¼Œè¿˜éœ€è¦æ”¹é€ ä¸€ä¸‹ä»£ç ï¼Œè®©å®ƒèƒ½å¤Ÿè½®è¯¢ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®è¡Œä¸ºå‹ã®è§‚å¯Ÿè€…æ¨¡å¼","slug":"design-observer-model","date":"2017-06-22T06:26:45.000Z","updated":"2021-03-20T16:25:01.804Z","comments":true,"path":"2017/06/22/design-observer-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-observer-model/","excerpt":"å¤§æ¦‚è¯´æ˜å¦‚æœæˆ‘å¸Œæœ›ä¸€ä¸ªåŠ¨ä½œåœ¨å‘ç”Ÿçš„æ—¶å€™ï¼Œå¸Œæœ›è®¢é˜…ä»–è¿™ä¸ªåŠ¨ä½œçš„æ‰€æœ‰äººéƒ½çŸ¥é“äº†æœ‰è¿™ä¹ˆä¸€ä»¶äº‹çš„è¯ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚ æ²¡ç”¨è§‚å¯Ÿè€…æ¨¡å¼çš„æƒ…å†µä¸‹1234567891011121314151617181920class Event&#123; function trigger() &#123; echo \"Event update!&lt;br/&gt;\"; //å…·ä½“æ›´æ–°é€»è¾‘ echo \"update1&lt;br/&gt;\"; echo \"update2&lt;br/&gt;\"; // ... &#125;&#125;//ä½¿ç”¨$event = new Event;$event-&gt;trigger(); è¿™ä¸ªäº‹ä»¶çš„è§¦å‘å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä¸æ–­çš„æœ‰æ–°çš„äººéœ€è¦è®¢é˜…çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ª trigger æ–¹æ³•ä¸æ–­çš„å°±æ˜¯è¦æ·»åŠ æ–°çš„é€»è¾‘å’Œä¸šåŠ¡ã€‚è¿åäº†è®¾è®¡æ¨¡å¼-å¼€é—­åŸåˆ™ï¼Œå°±æ˜¯å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾çš„åŸåˆ™ã€‚","text":"å¤§æ¦‚è¯´æ˜å¦‚æœæˆ‘å¸Œæœ›ä¸€ä¸ªåŠ¨ä½œåœ¨å‘ç”Ÿçš„æ—¶å€™ï¼Œå¸Œæœ›è®¢é˜…ä»–è¿™ä¸ªåŠ¨ä½œçš„æ‰€æœ‰äººéƒ½çŸ¥é“äº†æœ‰è¿™ä¹ˆä¸€ä»¶äº‹çš„è¯ï¼Œé‚£ä¹ˆå°±é‡‡ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚ æ²¡ç”¨è§‚å¯Ÿè€…æ¨¡å¼çš„æƒ…å†µä¸‹1234567891011121314151617181920class Event&#123; function trigger() &#123; echo \"Event update!&lt;br/&gt;\"; //å…·ä½“æ›´æ–°é€»è¾‘ echo \"update1&lt;br/&gt;\"; echo \"update2&lt;br/&gt;\"; // ... &#125;&#125;//ä½¿ç”¨$event = new Event;$event-&gt;trigger(); è¿™ä¸ªäº‹ä»¶çš„è§¦å‘å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä¸æ–­çš„æœ‰æ–°çš„äººéœ€è¦è®¢é˜…çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ª trigger æ–¹æ³•ä¸æ–­çš„å°±æ˜¯è¦æ·»åŠ æ–°çš„é€»è¾‘å’Œä¸šåŠ¡ã€‚è¿åäº†è®¾è®¡æ¨¡å¼-å¼€é—­åŸåˆ™ï¼Œå°±æ˜¯å¯¹ä¿®æ”¹å…³é—­ï¼Œå¯¹æ‰©å±•å¼€æ”¾çš„åŸåˆ™ã€‚ è§‚å¯Ÿè€…æ¨¡å¼12345678910111213141516171819202122//å£°æ˜ä¸€ä¸ªæŠ½è±¡çš„äº‹ä»¶å‘ç”Ÿè€…åŸºç±»abstract class EventGenerator&#123; private $observers = array(); //æ·»åŠ è§‚å¯Ÿè€…æ–¹æ³• function addobserver(Observer $observer) &#123; $this-&gt;observers[] = $observer; &#125; //å¯¹æ¯ä¸ªæ·»åŠ çš„è§‚å¯Ÿè€…è¿›è¡Œäº‹ä»¶é€šçŸ¥ function notify() &#123; //å¯¹æ¯ä¸ªè§‚å¯Ÿè€…é€ä¸ªå»æ›´æ–° foreach ($this-&gt;observers as $observer) &#123; $observer-&gt;update(); &#125; &#125;&#125; 123456//å£°æ˜ä¸€ä¸ªè§‚å¯Ÿè€…æ¥å£interface observer&#123; function update($event_info = null);&#125; 1234567891011121314151617//å£°æ˜å¤šä¸ªè§‚å¯Ÿè€…class Observer1 implements observer&#123; function update($event_info = null) &#123; echo \"é€»è¾‘1&lt;br/&gt;\"; &#125;&#125;class Observer2 implements observer&#123; function update($event_info = null) &#123; echo \"é€»è¾‘2&lt;br/&gt;\"; &#125;&#125; 12345678910111213141516171819//ä½¿ç”¨$event = new Event;$event-&gt;addObserver(new Observer1);$event-&gt;addObserver(new Observer2);$event-&gt;trigger();//ä»”ç»†è§‚å¯Ÿä»£ç å…¶å®å¾ˆç®€å•çš„ï¼ŒEventåŸºç±»é‡Œçš„foreachï¼Œå¯ä»¥å®ç°ä¸€ä¸ªäº‹ä»¶å¯¹åº”å¤šä¸ªè§‚å¯Ÿè€…ï¼›åœ¨è¿™é‡Œæˆ‘ä»¬ææ˜ç™½äº†ï¼Œæ‰€è°“è§‚å¯Ÿè€…å…¶å®å°±æ˜¯äº‹ä»¶çš„handlerï¼Œå®ƒå’Œäº‹ä»¶æ€ä¹ˆæŒ‚é’©å‘¢ï¼Œå…¶å®æ˜¯éœ€è¦æ³¨å†Œä¸€ä¸‹ï¼›$event-&gt;addObserver(new Observer1);$event-&gt;addObserver(new Observer2);//è€Œè¿™ä¸ªæ­¥éª¤$event = new Event;$event-&gt;trigger(); è¿™æ ·å­ï¼Œå°±åªéœ€è¦æ³¨å†Œå¯¹åº”çš„ handler åˆ° listered é‡Œé¢ä¾¿å¯ä»¥å®ç°ä¸»åŠ¨æ¨é€å°æ–°ç»™â€œè®¢é˜…è€…â€ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®è£…é¥°å™¨æ¨¡å¼å’Œè§‚å¯Ÿè€…æ¨¡å¼çš„åŒºåˆ«","slug":"design-d-p-d-model","date":"2017-06-22T06:18:00.000Z","updated":"2021-03-20T16:25:01.803Z","comments":true,"path":"2017/06/22/design-d-p-d-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-d-p-d-model/","excerpt":"","text":"è§‚å¯Ÿè€…æ¨¡å¼è§‚å¯Ÿè€…æ¨¡å¼å®Œç¾çš„å°†è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿå¯¹è±¡åˆ†å¼€ï¼Œç³»ç»Ÿä¸­çš„æ¯ä¸ªç±»å°†é‡ç‚¹æ”¾åœ¨æŸä¸€ä¸ªåŠŸèƒ½ä¸Šï¼Œè€Œä¸æ˜¯å…¶ä»–çš„æ–¹é¢ï¼ˆå¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼‰ï¼Œå¾ˆå¥½çš„ä½“ç°äº†å•ä¸€èŒè´£åŸåˆ™ã€‚è§‚å¯Ÿè€…å°†è‡ªå·±æ³¨å†Œåˆ°è¢«è§‚å¯Ÿè€…çš„å®¹å™¨ä¸­ï¼Œè¢«è§‚å¯Ÿè€…ä¸åº”è¯¥è¿‡é—®è§‚å¯Ÿè€…çš„å…·ä½“ç±»å‹ï¼Œè€Œæ˜¯ä½¿ç”¨è§‚å¯Ÿè€…çš„æ¥å£ã€‚è¿™æ ·çš„ä¼˜ç‚¹æ˜¯ï¼šå‡å®šç¨‹åºä¸­è¿˜æœ‰åˆ«çš„è§‚å¯Ÿè€…ï¼Œé‚£ä¹ˆè¿™ä¸ªè§‚å¯Ÿè€…æ˜¯ç›¸åŒçš„æ¥å£å³å¯ï¼ŒåŸºäºæ¥å£è€Œä¸æ˜¯å…·ä½“çš„å®ç°ï¼Œè¿™ä¸€ç‚¹ä¸ºç¨‹åºæä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚ ç°å®ç”Ÿæ´»ä¸­åƒç§»åŠ¨çš„å°±ä¸šä¿¡æ¯æ¨é€ç³»ç»Ÿï¼Œå¸Œæœ›å¾—åˆ°ä¸šåŠ¡çš„äººï¼ˆè§‚å¯Ÿè€…ï¼‰å…ˆåˆ°ç§»åŠ¨æ³¨å†Œï¼Œç„¶åå¦‚æœæœ‰å…·ä½“çš„ä¿¡æ¯ï¼Œç§»åŠ¨ä¼šä¸»åŠ¨çš„æ¨é€åˆ°é¢„è®¢ä¸šåŠ¡çš„äººï¼Œä¸éœ€è¦é¢„è®¢ä¸šåŠ¡çš„äººå»ä¸»åŠ¨è¯¢é—®ã€‚ è£…é¥°è€…æ¨¡å¼è£…é¥°è€…æ¨¡å¼ä¸åœ¨ä¸æ”¹å˜åŸç±»æ–‡ä»¶çš„æƒ…å†µä¸‹åŠ¨æ€çš„æ‰©å±•ä¸€ä¸ªå¯¹è±¡çš„åŠŸèƒ½ã€‚å®ƒæ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªåŒ…è£…å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è£…é¥°æ¥åŒ…è£¹çœŸå®çš„å¯¹è±¡ã€‚å½“æˆ‘ä»¬éœ€è¦ä¸ºæŸä¸ªå¯¹è±¡åŠ¨æ€åœ°å¢åŠ ä¸€ä¸ªåŠŸèƒ½çš„æˆ–èŒè´£çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è£…é¥°è€…æ¨¡å¼ï¼›å½“æŸä¸ªå¯¹è±¡çš„èŒè´£ç»å¸¸å‘ç”Ÿå˜åŒ–æˆ–è€…ç»å¸¸éœ€è¦åŠ¨æ€çš„å¢åŠ èŒè´£ï¼Œé¿å…ä¸ºäº†é€‚åº”å˜åŒ–è€Œå¢åŠ çˆ±ç»§æ‰¿å­ç±»æ‰©å±•çš„æ–¹å¼ï¼Œå› ä¸ºè¿™ç§æ‰©å±•å¯èƒ½ä¼šé€ æˆå­ç±»è†¨èƒ€çš„é€Ÿåº¦è¿‡å¿«ï¼Œéš¾ä»¥æ§åˆ¶ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨è£…é¥°ç€æ¨¡å¼ã€‚ å¯¹äºè¿™ä¸­æ¨¡å¼çš„å®ç°ï¼Œä¼šæœ‰è¢«è£…é¥°çš„å…·ä½“å¯¹è±¡ï¼Œè¢«è£…é¥°çš„æŠ½è±¡ï¼Œè£…é¥°è€…çš„æŠ½è±¡ï¼Œå’Œè‹¥å¹²ä¸ªè£…é¥°ç€ï¼Œè¿™è‹¥å¹²ä¸ªè£…é¥°è€…å¹¶ä¸æ˜¯åˆ›å»ºå„ç§ä¸åŒçš„å¯¹è±¡ï¼ˆæ‰€ä»¥è£…é¥°è€…æ¨¡å¼ä¸ºç»“æ„å‹æ¨¡å¼è€Œä¸æ˜¯åˆ›å»ºå‹æ¨¡å¼ï¼‰ï¼Œè€Œæ˜¯æ¯ä¸ªè£…é¥°è€…éƒ½ä¼šæœ‰ä¸€ä¸ªçœŸå®çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œç„¶ååœ¨è¿™ä¸ªå…·ä½“å¯¹è±¡æ–¹æ³•çš„å‰åæ·»åŠ ä¸€äº›æ–°çš„åŠŸèƒ½ï¼Œèµ·åˆ°è£…é¥°çš„ä½œç”¨ã€‚ä¾‹å¦‚æœ‰ä¸¤ä¸ªè£…é¥° 1ï¼Œå’Œè£…é¥° 2ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠè£…é¥° 1 å½“ä½œè£…é¥° 2 çš„å…·ä½“å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ è¿›å»ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šäº§ç”Ÿå¦å¤–ä¸€ç§æ–°çš„è£…é¥°äº†ï¼Œè€Œä¸”æ²¡æœ‰æ–°çš„å­ç±»ã€‚ ç°å®ç”Ÿæ´»ç€çš„ä¾‹å­ä¾‹å¦‚åŒ…é¥ºå­ï¼Œæ­¥éª¤åˆ†ä¸ºå’Œé™·ï¼Œå’Œé¢ï¼Œæ†çš®ï¼ŒåŒ…é¥ºå­ï¼Œç…®é¥ºå­ï¼Œå¯ä»¥åœ¨å’Œé™·è¿™ä¸ªæ–¹æ³•çš„å‰é¢å¤šåŠ ç‚¹é…èœï¼Œä¹Ÿå¯ä»¥åœ¨å’Œé¢è¿™ä¸ªæ–¹æ³•çš„å‰é¢åœ¨é¢é‡Œé¢åŠ ä¸ªé¸¡è›‹ï¼Œä¹Ÿå¯ä»¥åŒæ—¶ç”¨è¿™ä¸¤ä¸ªè£…é¥°å…ˆåŠ èœåå’Œé¢åŠ é¸¡è›‹ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸¤ä¸ªå·²ç»å­˜åœ¨çš„è£…é¥°äº§ç”Ÿä¸€ä¸ªæ–°çš„è£…é¥°äº†ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®ä»£ç†æ¨¡å¼","slug":"design-proxy-model","date":"2017-06-22T03:50:00.000Z","updated":"2021-03-20T16:25:01.804Z","comments":true,"path":"2017/06/22/design-proxy-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-proxy-model/","excerpt":"å¤§æ¦‚æ„æ€è¿™ä¸ªæ¨¡å¼å…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä½ æƒ³è®¿é—®ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œä¸ç›´æ¥è®¿é—®ï¼Œè€Œæ˜¯æ‰¾è¿™ä¸ªç±»çš„ä¸€ä¸ªä»£ç†ã€‚ä»£ç†å°±æ˜¯ä¸­ä»‹ï¼Œæœ‰ä¸­ä»‹å°±æ„å‘³ç€è§£è€¦ã€‚ åœ¨ä»£ç†æ¨¡å¼ä¸‹ï¼Œä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†çš„å¯¹è±¡ï¼Œæœ‰ä¸ªé‡è¦ç‰¹ç‚¹ï¼šå¿…é¡»ç»§æ‰¿åŒä¸€ä¸ªæ¥å£ã€‚ è¿™é‡Œè¯´ä¸‹é‡ç‚¹ï¼Œä¹‹å‰è¯´è¿‡çš„ é€‚é…å™¨æ¨¡å¼ï¼Œå’Œä»£ç†æ¨¡å¼éå¸¸éå¸¸åƒï¼Œåªä¸è¿‡æ˜¯åœ¨é€‚é…å™¨æ¨¡å¼ä¸‹ï¼Œé€‚é…å™¨å’Œå®ƒè¦é€‚é…çš„ç±»æ²¡æœ‰ç»§æ‰¿åŒä¸€æ¥å£ï¼Œé€‚é…å™¨å°±æ˜¯è¦æŠŠè¿™ä¸ªç¬¬ä¸‰æ–¹ç±»å˜æˆç¬¦åˆæ¥å£è§„èŒƒã€‚é€‚é…å™¨ä¹Ÿæ˜¯ä¸ªä¸­ä»‹ï¼Œæ‰€ä»¥æˆ‘è¯´å®ƒä»¬å¾ˆåƒã€‚å®ç° æ¥å£ï¼š 1234interface Image&#123; public function getWidth();&#125; ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª Image æ¥å£ç±»ï¼Œæ¥å£å®šä¹‰ getWidth æ–¹æ³•ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…·ä½“ç±»ï¼ˆå®ç°ç±»ï¼‰æ¥å®ç°è¿™ä¸ªæ¥å£ã€‚","text":"å¤§æ¦‚æ„æ€è¿™ä¸ªæ¨¡å¼å…¶å®æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä½ æƒ³è®¿é—®ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œä¸ç›´æ¥è®¿é—®ï¼Œè€Œæ˜¯æ‰¾è¿™ä¸ªç±»çš„ä¸€ä¸ªä»£ç†ã€‚ä»£ç†å°±æ˜¯ä¸­ä»‹ï¼Œæœ‰ä¸­ä»‹å°±æ„å‘³ç€è§£è€¦ã€‚ åœ¨ä»£ç†æ¨¡å¼ä¸‹ï¼Œä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†çš„å¯¹è±¡ï¼Œæœ‰ä¸ªé‡è¦ç‰¹ç‚¹ï¼šå¿…é¡»ç»§æ‰¿åŒä¸€ä¸ªæ¥å£ã€‚ è¿™é‡Œè¯´ä¸‹é‡ç‚¹ï¼Œä¹‹å‰è¯´è¿‡çš„ é€‚é…å™¨æ¨¡å¼ï¼Œå’Œä»£ç†æ¨¡å¼éå¸¸éå¸¸åƒï¼Œåªä¸è¿‡æ˜¯åœ¨é€‚é…å™¨æ¨¡å¼ä¸‹ï¼Œé€‚é…å™¨å’Œå®ƒè¦é€‚é…çš„ç±»æ²¡æœ‰ç»§æ‰¿åŒä¸€æ¥å£ï¼Œé€‚é…å™¨å°±æ˜¯è¦æŠŠè¿™ä¸ªç¬¬ä¸‰æ–¹ç±»å˜æˆç¬¦åˆæ¥å£è§„èŒƒã€‚é€‚é…å™¨ä¹Ÿæ˜¯ä¸ªä¸­ä»‹ï¼Œæ‰€ä»¥æˆ‘è¯´å®ƒä»¬å¾ˆåƒã€‚å®ç° æ¥å£ï¼š 1234interface Image&#123; public function getWidth();&#125; ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ª Image æ¥å£ç±»ï¼Œæ¥å£å®šä¹‰ getWidth æ–¹æ³•ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…·ä½“ç±»ï¼ˆå®ç°ç±»ï¼‰æ¥å®ç°è¿™ä¸ªæ¥å£ã€‚ å®ç°ç±»ï¼š 1234567class RawImage implements Image&#123; public function getWidth() &#123; return \"100 x 100\"; &#125;&#125; ä»£ç†ç±» 1234567891011121314class ImageProxy implements Image&#123; private $img; public function __construct() &#123; $this-&gt;img = new RawImage(); &#125; public function getWidth() &#123; return $this-&gt;img-&gt;getWidth(); &#125;&#125; å®ç°äº†åŒä¸€ä¸ªæ¥å£çš„ç›®çš„æ˜¯ï¼Œæ¥å£æ˜¯å¯¹å¤–å¼€æ”¾çš„ï¼Œè®¾è®¡æ¨¡å¼çš„åŸåˆ™æ˜¯å¯¹å†…å°é—­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåˆ«äººç»™åˆ°çš„æ¨¡å¼å°±æ˜¯è¿™æ ·å­çš„ï¼Œä½ é€šè¿‡å®ç°ä¸€æ ·çš„æ¥å£ï¼Œæˆ–è€…è¯´æ˜¯ç»§æ‰¿äº†åŒä¸€ä¸ªæ¥å£çš„è®¾è®¡æ¨¡å¼ï¼Œå°±å¯ä»¥é¢å¤–çš„æ·»åŠ ä¸šåŠ¡é€»è¾‘åœ¨é‡Œé¢åˆ¤æ–­äº†ï¼Œæˆ‘ä»¬ç»å¸¸ä¹Ÿç”¨åˆ°è¿™ç§æ¨¡å¼ï¼Œä¾‹å¦‚åœ¨æ§åˆ¶å™¨é‡Œé¢ 1234567891011class A&#123; public function __construct()&#123;&#125;&#125;class B extends A&#123; public function __construct()&#123; echo 'åšæˆ‘æƒ³åš'; parents::__construct(); echo 'åšæˆ‘æƒ³åš'; &#125;&#125; è¿™æ ·å­å°±å¯ä»¥å¾ˆå¥½çš„ç”¨åˆ°äº†ä»£ç†æ¨¡å¼ã€‚ ä½œç”¨æ˜¾è€Œæ˜“è§ï¼Œè§£è€¦ã€‚å› ä¸ºä»£ç†å’Œè¢«ä»£ç†å¯¹è±¡ éƒ½å®ç°åŒä¸€æ¥å£ï¼Œæ‰€ä»¥å¯¹äºåŸçœŸå®å¯¹è±¡ï¼Œä½ æ— è®ºæ€ä¹ˆæ”¹éƒ½è¡Œã€‚åŒæ ·ï¼Œåœ¨ä»£ç†å¯¹è±¡ä¸­ï¼Œé™¤äº†å¦‚å®åæ˜ çœŸå®å¯¹è±¡çš„æ–¹æ³•é€»è¾‘ï¼Œä½ è¿˜å¯ä»¥æ·»åŠ ç‚¹åˆ«çš„é€»è¾‘ï¼Œæ€ä¹ˆæ·»åŠ éƒ½è¡Œï¼Œä¸ä¼šå½±å“åˆ°çœŸå®å¯¹è±¡ï¼Œæ·»åŠ åå¯ä»¥åœ¨æ‰€æœ‰ä½¿ç”¨è¿‡ä»£ç†å¯¹è±¡çš„ä¸šåŠ¡é€»è¾‘ä¸­ç¬é—´æ›´æ–°ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®é“¾å¼æ¨¡å¼","slug":"design-link-model","date":"2017-06-22T03:36:00.000Z","updated":"2021-03-20T16:25:01.803Z","comments":true,"path":"2017/06/22/design-link-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-link-model/","excerpt":"ä¸€ä¸ªå¸¸è§çš„éæ­£ç»Ÿçš„è®¾è®¡æ¨¡å¼fluent interfaceï¼ˆæµåˆ©æ¥å£ï¼‰æœ‰ä¸€ä¸ªæ›´å¹¿ä¸ºäººçŸ¥çš„åå­—ã€é“¾å¼æ“ä½œã€ï¼Œå¯èƒ½å¤§å¤šæ•°äººå¤§æ¦‚éƒ½æ˜¯ä» Jquery æœ€å…ˆç†Ÿæ‚‰çš„ï¼Œåœ¨ laravel ä¸­ï¼ŒORM çš„ä¸€ç³»åˆ— sql æ“ä½œï¼Œä¹Ÿæ˜¯é“¾å¼æ“ä½œï¼Œç‰¹ç‚¹æ˜¯æ¯æ¬¡éƒ½è¿”å›ä¸€ä¸ª Query Builder å¯¹è±¡ã€‚","text":"ä¸€ä¸ªå¸¸è§çš„éæ­£ç»Ÿçš„è®¾è®¡æ¨¡å¼fluent interfaceï¼ˆæµåˆ©æ¥å£ï¼‰æœ‰ä¸€ä¸ªæ›´å¹¿ä¸ºäººçŸ¥çš„åå­—ã€é“¾å¼æ“ä½œã€ï¼Œå¯èƒ½å¤§å¤šæ•°äººå¤§æ¦‚éƒ½æ˜¯ä» Jquery æœ€å…ˆç†Ÿæ‚‰çš„ï¼Œåœ¨ laravel ä¸­ï¼ŒORM çš„ä¸€ç³»åˆ— sql æ“ä½œï¼Œä¹Ÿæ˜¯é“¾å¼æ“ä½œï¼Œç‰¹ç‚¹æ˜¯æ¯æ¬¡éƒ½è¿”å›ä¸€ä¸ª Query Builder å¯¹è±¡ã€‚ å®ä¾‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647class Employee&#123; public $name; public $surName; public $salary; public function setName($name) &#123; $this-&gt;name = $name; return $this; &#125; public function setSurname($surname) &#123; $this-&gt;surName = $surname; return $this; &#125; public function setSalary($salary) &#123; $this-&gt;salary = $salary; return $this; &#125; public function __toString() &#123; $employeeInfo = 'Name: ' . $this-&gt;name . PHP_EOL; $employeeInfo .= 'Surname: ' . $this-&gt;surName . PHP_EOL; $employeeInfo .= 'Salary: ' . $this-&gt;salary . PHP_EOL; return $employeeInfo; &#125;&#125;//é“¾å¼æ“ä½œçš„æ•ˆæœ$employee = (new Employee()) -&gt;setName('Tom') -&gt;setSurname('Smith') -&gt;setSalary('100');echo $employee;# è¾“å‡ºç»“æœ# Name: Tom# Surname: Smith# Salary: 100 é“¾å¼æ“ä½œçš„å…³é”®åœ¨äºï¼Œæ¯æ¬¡éƒ½è¿”å›æœ¬å¯¹è±¡ return $thisï¼Œä½¿å¾—æ²¡ä¸€æ¬¡æ“ä½œä¹‹åéƒ½æ˜¯å¯ä»¥å¯è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®é—¨é¢æ¨¡å¼","slug":"design-facade-model","date":"2017-06-22T03:19:00.000Z","updated":"2021-03-20T16:25:01.803Z","comments":true,"path":"2017/06/22/design-facade-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-facade-model/","excerpt":"æ¦‚å¿µç”¨è¿‡ Laravel çš„æœ‹å‹çš„åº”è¯¥ç†Ÿæ‚‰ï¼ŒLaravel ç»™æˆ‘ä»¬ç§‘æ™®äº†ä¸€ä¸ªæ¦‚å¿µ Facadeï¼Œç„¶è€Œ Laravel ä¸­çš„ Facade å¹¶ä¸æ˜¯çœŸæ­£è®¾è®¡æ¨¡å¼ä¸­å®šä¹‰çš„ Facadeï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆå®ƒä»¬éƒ½å«ä¸€ä¸ªåå­—å‘¢ï¼Ÿ æˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥äº†è§£ä¸€ä¸‹ Facade è¿™ä¸ªå•è¯çš„æ„æ€å§ã€‚é¦–å…ˆå®ƒçš„è¯»éŸ³æ˜¯[fÉ™ËˆsÉ‘Ëd]ï¼Œæºè‡ªæ³•è¯­ faÃ§adeï¼Œæ³•è¯­è¿™ä¸ªè¯åŸæ„å°±æ˜¯ frontageï¼Œæ„æ€æ˜¯å»ºç­‘çš„æ­£é¢ï¼Œé—¨é¢ï¼Œç”±äºä»¥å‰æ³•å›½ï¼Œæ„å¤§åˆ©çš„å»ºç­‘åªæ³¨é‡ä¿®è‘ºä¸´è¡—çš„ä¸€é¢ï¼Œååˆ†ç²¾ç¾ï¼Œè€ŒèƒŒåå´æ¯”è¾ƒç®€é™‹ï¼Œæ‰€ä»¥è¿™ä¸ªè¯å¼•ç”³çš„æ„æ€æ˜¯è¡¨è±¡ï¼Œå‡è±¡ã€‚ å…ˆè®²è®¾è®¡æ¨¡å¼ä¸­çš„æ¦‚å¿µåœ¨è®¾è®¡æ¨¡å¼ä¸­ï¼Œå…¶å® Facade è¿™ä¸ªæ¦‚å¿µååˆ†ç®€å•ã€‚ å®ƒä¸»è¦è®²çš„æ˜¯è®¾è®¡ä¸€ä¸ªæ¥å£æ¥ç»Ÿé¢†æ‰€æœ‰å­ç³»ç»Ÿçš„åŠŸèƒ½ã€‚çœ‹å®Œä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜ç™½äº†ï¼š","text":"æ¦‚å¿µç”¨è¿‡ Laravel çš„æœ‹å‹çš„åº”è¯¥ç†Ÿæ‚‰ï¼ŒLaravel ç»™æˆ‘ä»¬ç§‘æ™®äº†ä¸€ä¸ªæ¦‚å¿µ Facadeï¼Œç„¶è€Œ Laravel ä¸­çš„ Facade å¹¶ä¸æ˜¯çœŸæ­£è®¾è®¡æ¨¡å¼ä¸­å®šä¹‰çš„ Facadeï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆå®ƒä»¬éƒ½å«ä¸€ä¸ªåå­—å‘¢ï¼Ÿ æˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥äº†è§£ä¸€ä¸‹ Facade è¿™ä¸ªå•è¯çš„æ„æ€å§ã€‚é¦–å…ˆå®ƒçš„è¯»éŸ³æ˜¯[fÉ™ËˆsÉ‘Ëd]ï¼Œæºè‡ªæ³•è¯­ faÃ§adeï¼Œæ³•è¯­è¿™ä¸ªè¯åŸæ„å°±æ˜¯ frontageï¼Œæ„æ€æ˜¯å»ºç­‘çš„æ­£é¢ï¼Œé—¨é¢ï¼Œç”±äºä»¥å‰æ³•å›½ï¼Œæ„å¤§åˆ©çš„å»ºç­‘åªæ³¨é‡ä¿®è‘ºä¸´è¡—çš„ä¸€é¢ï¼Œååˆ†ç²¾ç¾ï¼Œè€ŒèƒŒåå´æ¯”è¾ƒç®€é™‹ï¼Œæ‰€ä»¥è¿™ä¸ªè¯å¼•ç”³çš„æ„æ€æ˜¯è¡¨è±¡ï¼Œå‡è±¡ã€‚ å…ˆè®²è®¾è®¡æ¨¡å¼ä¸­çš„æ¦‚å¿µåœ¨è®¾è®¡æ¨¡å¼ä¸­ï¼Œå…¶å® Facade è¿™ä¸ªæ¦‚å¿µååˆ†ç®€å•ã€‚ å®ƒä¸»è¦è®²çš„æ˜¯è®¾è®¡ä¸€ä¸ªæ¥å£æ¥ç»Ÿé¢†æ‰€æœ‰å­ç³»ç»Ÿçš„åŠŸèƒ½ã€‚çœ‹å®Œä¸‹é¢è¿™ä¸ªä¾‹å­å°±æ˜ç™½äº†ï¼š 123456789101112131415161718class CPU&#123; public function freeze()&#123; /*...*/&#125; public function jump()&#123;/*...*/&#125; public function execute()&#123;/*...*/&#125;&#125;class HardDrive&#123; public function read($boot_sector, $sector_size)&#123;/*...*/&#125;&#125;class Memory&#123; public function load($boot_address, $hd_data)&#123;/*...*/&#125;&#125; è¿™æ˜¯ä¸‰ä¸ªç”µè„‘ä¸­çš„å­ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ªæ€»ç³»ç»Ÿæ¥ç»„ç»‡å®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼Œè¿™å…¶å®å°±æ˜¯ Facadeï¼š 12345678910111213141516171819202122class ComputerFacade&#123; private $cpu; private $ram; private $hd; public function __construct() &#123; $this-&gt;cpu = new CPU(); $this-&gt;ram = new Memory(); $this-&gt;hd = new HardDrive(); &#125; public function start() &#123; $this-&gt;cpu-&gt;freeze(); $this-&gt;ram-&gt;load(BOOT_ADDRESS, $this-&gt;hd-&gt;read(BOOT_SECTOR, SECTOR_SIZE)); $this-&gt;cpu-&gt;jump(BOOT_ADDRESS); $this-&gt;cpu-&gt;execute(); &#125;&#125; ä½¿ç”¨ï¼š12$computer = new ComputerFacade();$computer-&gt;start(); é—¨é¢æ¨¡å¼å…¶å®å°±æ˜¯è¿™ä¹ˆå›äº‹ï¼Œç”±ä¸€ä¸ªé—¨é¢ï¼ˆå…¥å£ï¼‰æŠŠæ‰€æœ‰å­ç³»ç»Ÿéšè—èµ·æ¥äº†ï¼Œåªéœ€è¦æ“ä½œé—¨é¢å°±å¯ä»¥ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå¯¹å¤–çš„ï¼Œåˆ«äººåªçŸ¥é“æœ‰ä¸ª start å¼€æœºé”®ï¼Œä½†æ˜¯é‡Œé¢æ˜¯æ€ä¹ˆè·‘çš„ï¼Œåˆ«äººå‹æ ¹ä¸æ¸…æ¥šã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®ä¾èµ–æ³¨å…¥æ¨¡å¼","slug":"design-dependency-injection-model","date":"2017-06-22T03:11:00.000Z","updated":"2021-03-20T16:25:01.803Z","comments":true,"path":"2017/06/22/design-dependency-injection-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-dependency-injection-model/","excerpt":"å¾ˆç®€å•çš„ç†è§£ç»ˆäºè¦è®²åˆ°è¿™ä¸ªè‘—åçš„è®¾è®¡åŸåˆ™ï¼Œå…¶å®å®ƒæ¯”å…¶ä»–è®¾è®¡æ¨¡å¼éƒ½ç®€å•ã€‚ä¾èµ–æ³¨å…¥çš„å®è´¨å°±æ˜¯æŠŠä¸€ä¸ªç±»ä¸å¯èƒ½æ›´æ¢çš„éƒ¨åˆ† å’Œ å¯æ›´æ¢çš„éƒ¨åˆ† åˆ†ç¦»å¼€æ¥ï¼Œé€šè¿‡æ³¨å…¥çš„æ–¹å¼æ¥ä½¿ç”¨ï¼Œä»è€Œè¾¾åˆ°è§£è€¦çš„ç›®çš„ã€‚ ä¸€ä¸ªæ•°æ®åº“è¿æ¥ç±»12345678910111213141516171819202122class Mysql&#123; private $host; private $port; private $username; private $password; private $db_name; public function __construct() &#123; $this-&gt;host = '127.0.0.1'; $this-&gt;port = 22; $this-&gt;username = 'root'; $this-&gt;password = ''; $this-&gt;db_name = 'my_db'; &#125; public function connect() &#123; return mysqli_connect($this-&gt;host, $this-&gt;username, $this-&gt;password, $this-&gt;db_name, $this-&gt;port); &#125;&#125;","text":"å¾ˆç®€å•çš„ç†è§£ç»ˆäºè¦è®²åˆ°è¿™ä¸ªè‘—åçš„è®¾è®¡åŸåˆ™ï¼Œå…¶å®å®ƒæ¯”å…¶ä»–è®¾è®¡æ¨¡å¼éƒ½ç®€å•ã€‚ä¾èµ–æ³¨å…¥çš„å®è´¨å°±æ˜¯æŠŠä¸€ä¸ªç±»ä¸å¯èƒ½æ›´æ¢çš„éƒ¨åˆ† å’Œ å¯æ›´æ¢çš„éƒ¨åˆ† åˆ†ç¦»å¼€æ¥ï¼Œé€šè¿‡æ³¨å…¥çš„æ–¹å¼æ¥ä½¿ç”¨ï¼Œä»è€Œè¾¾åˆ°è§£è€¦çš„ç›®çš„ã€‚ ä¸€ä¸ªæ•°æ®åº“è¿æ¥ç±»12345678910111213141516171819202122class Mysql&#123; private $host; private $port; private $username; private $password; private $db_name; public function __construct() &#123; $this-&gt;host = '127.0.0.1'; $this-&gt;port = 22; $this-&gt;username = 'root'; $this-&gt;password = ''; $this-&gt;db_name = 'my_db'; &#125; public function connect() &#123; return mysqli_connect($this-&gt;host, $this-&gt;username, $this-&gt;password, $this-&gt;db_name, $this-&gt;port); &#125;&#125; ä½¿ç”¨12$db = new Mysql();$con = $db-&gt;connect(); é€šå¸¸åº”è¯¥è®¾è®¡ä¸ºå•ä¾‹ï¼Œè¿™é‡Œå°±å…ˆä¸æå¤æ‚äº†ã€‚ ä¾èµ–æ³¨å…¥æ˜¾ç„¶ï¼Œæ•°æ®åº“çš„é…ç½®æ˜¯å¯ä»¥æ›´æ¢çš„éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŠŠå®ƒæ‹å‡ºæ¥ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142class MysqlConfiguration&#123; private $host; private $port; private $username; private $password; private $db_name; public function __construct(string $host, int $port, string $username, string $password, string $db_name) &#123; $this-&gt;host = $host; $this-&gt;port = $port; $this-&gt;username = $username; $this-&gt;password = $password; $this-&gt;db_name = $db_name; &#125; public function getHost(): string &#123; return $this-&gt;host; &#125; public function getPort(): int &#123; return $this-&gt;port; &#125; public function getUsername(): string &#123; return $this-&gt;username; &#125; public function getPassword(): string &#123; return $this-&gt;password; &#125; public function getDbName(): string &#123; return $this-&gt;db_name; &#125;&#125; ç„¶åä¸å¯æ›¿æ¢çš„éƒ¨åˆ†è¿™æ ·ï¼š 1234567891011121314class Mysql&#123; private $configuration; public function __construct(MysqlConfiguration $config) &#123; $this-&gt;configuration = $config; &#125; public function connect() &#123; return mysqli_connect($this-&gt;configuration-&gt;getHost(), $this-&gt;configuration-&gt;getUsername(), $this-&gt;configuration-&gt;getPassword, $this-&gt;configuration-&gt;getDbName(), $this-&gt;configuration-&gt;getPort()); &#125;&#125; è¿™æ ·å°±å®Œæˆäº†é…ç½®æ–‡ä»¶å’Œè¿æ¥é€»è¾‘çš„åˆ†ç¦»ã€‚ ä½¿ç”¨123$config = new MysqlConfiguration('127.0.0.1', 'root', '', 'my_db', 22);$db = new Mysql($config);$con = $db-&gt;connect(); $config æ˜¯æ³¨å…¥ Mysql çš„ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ä¾èµ–æ³¨å…¥ã€‚ å¤‡æ³¨è¿˜æœ‰ä¸€ç§åšæ³•å°±æ˜¯å°†æ‰€æœ‰çš„ç»„ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ªå®¹å™¨é‡Œï¼Œç­‰åˆ°æ§åˆ¶å™¨éœ€è¦çš„æ—¶å€™ï¼Œå†å»åŠ¨æ€æ³¨å…¥è¿›æ¥ï¼Œåç»­å¦‚æœè¿˜è¦å†ä½¿ç”¨çš„è¯ï¼Œå°±ä»å·²ç»åŠ è½½äº†çš„æ˜¯å®ä¾‹ä¸­è·å–ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®è£…é¥°å™¨æ¨¡å¼","slug":"design-decorator-model","date":"2017-06-22T01:57:00.000Z","updated":"2021-03-20T16:25:01.803Z","comments":true,"path":"2017/06/22/design-decorator-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/22/design-decorator-model/","excerpt":"å¤§æ¦‚çš„æ„æ€ä¸€ä¸ªç±»ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘éœ€è¦ç»å¸¸æ”¹å®ƒï¼Œè€Œä¸”ä¼šååå¤å¤ï¼Œæ”¹å®Œäº†åˆæ”¹å›å»ã€‚ ä¸€èˆ¬è¦ä¹ˆæˆ‘ä»¬ç›´æ¥æ”¹åŸæ¥çš„ç±»ä¸­çš„æ–¹æ³•ï¼Œè¦ä¹ˆç»§æ‰¿ä¸€ä¸‹ç±»è¦†ç›–è¿™ä¸ªæ–¹æ³•ã€‚ æœ‰æ²¡æœ‰ä¸€ä¸ªåŠæ³•å¯ä»¥ä¸ç”¨ç»§æ‰¿ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªç±»è¿›å»ï¼Œå°±å¯ä»¥æ”¹æ‰é‚£ä¸ªæ–¹æ³•ã€‚ æœ‰ï¼Œè£…é¥°å™¨æ¨¡å¼ã€‚ åœºæ™¯1234567891011class plainCoffee&#123; public function makeCoffee() &#123; $this-&gt;addCoffee(); &#125; public function addCoffee() &#123; &#125;&#125; è¿™æ˜¯ä¸€ä¸ªç…®å’–å•¡çš„ç¨‹åºï¼Œç°åœ¨æˆ‘è¿˜æƒ³åŠ ç‚¹ç³–ï¼Œä¸€èˆ¬åšæ³•ï¼š","text":"å¤§æ¦‚çš„æ„æ€ä¸€ä¸ªç±»ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ‘éœ€è¦ç»å¸¸æ”¹å®ƒï¼Œè€Œä¸”ä¼šååå¤å¤ï¼Œæ”¹å®Œäº†åˆæ”¹å›å»ã€‚ ä¸€èˆ¬è¦ä¹ˆæˆ‘ä»¬ç›´æ¥æ”¹åŸæ¥çš„ç±»ä¸­çš„æ–¹æ³•ï¼Œè¦ä¹ˆç»§æ‰¿ä¸€ä¸‹ç±»è¦†ç›–è¿™ä¸ªæ–¹æ³•ã€‚ æœ‰æ²¡æœ‰ä¸€ä¸ªåŠæ³•å¯ä»¥ä¸ç”¨ç»§æ‰¿ï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªç±»è¿›å»ï¼Œå°±å¯ä»¥æ”¹æ‰é‚£ä¸ªæ–¹æ³•ã€‚ æœ‰ï¼Œè£…é¥°å™¨æ¨¡å¼ã€‚ åœºæ™¯1234567891011class plainCoffee&#123; public function makeCoffee() &#123; $this-&gt;addCoffee(); &#125; public function addCoffee() &#123; &#125;&#125; è¿™æ˜¯ä¸€ä¸ªç…®å’–å•¡çš„ç¨‹åºï¼Œç°åœ¨æˆ‘è¿˜æƒ³åŠ ç‚¹ç³–ï¼Œä¸€èˆ¬åšæ³•ï¼š 123456789101112class sweetCoffee extends plainCoffee&#123; public function makeCoffee() &#123; $this-&gt;addCoffee(); $this-&gt;addSugar(); &#125; public function addSugar() &#123; &#125;&#125; å¥½äº†ï¼Œä¸‹é¢å¦‚æœæˆ‘è¿˜æƒ³åŠ ç‚¹å¥¶ï¼ŒåŠ ç‚¹å¥¶æ²¹ï¼ŒåŠ ç‚¹å·§å…‹åŠ›ï¼ŒåŠ ç‚¹æµ·ç›ï¼Ÿä¼š extends åˆ°å´©æºƒã€‚ è£…é¥°å™¨è¦æƒ³ä½¿ç”¨è£…é¥°å™¨ï¼Œéœ€è¦å¯¹æœ€æ—©é‚£ä¸ªç±»è¿›è¡Œæ”¹é€ ï¼š 1234567891011class plainCoffee&#123; public function makeCoffee() &#123; $this-&gt;addCoffee(); &#125; public function addCoffee() &#123; &#125;&#125; æˆ‘ä»¬æƒ³æ”¹é€  makeCoffee()è¿™ä¸ªæ–¹æ³•ï¼Œæ— éæ˜¯åœ¨å®ƒå‰é¢æˆ–åé¢åŠ ç‚¹é€»è¾‘ï¼Œäºæ˜¯ï¼š 123456789101112131415161718192021class plainCoffee&#123; private function before() &#123; &#125; private function after() &#123; &#125; public function makeCoffee() &#123; $this-&gt;before(); $this-&gt;addCoffee(); $this-&gt;after(); &#125; public function addCoffee() &#123; &#125;&#125; é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆåœ¨ before å’Œ after ä¸­åŠ å…¥é€»è¾‘å‘¢ï¼š 123456789101112131415161718192021222324252627282930313233343536class plainCoffee&#123; private $decorators; public function addDecorator($decorator) &#123; $this-&gt;decorators[] = $decorator; &#125; private function before() &#123; foreach ($this-&gt;decorators as $decorator) &#123; $decorator-&gt;before(); &#125; &#125; private function after() &#123; foreach ($this-&gt;decorators as $decorator) &#123; $decorator-&gt;after(); &#125; &#125; public function makeCoffee() &#123; $this-&gt;before(); $this-&gt;addCoffee(); $this-&gt;after(); &#125; public function addCoffee() &#123; &#125;&#125; æ”¹é€ å¥½äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ€ä¹ˆå†™è£…é¥°å™¨ï¼š 123456789101112131415class sweetCoffeeDecorator&#123; public function before() &#123; &#125; public function after() &#123; $this-&gt;addSugar(); &#125; public function addSugar() &#123; &#125;&#125; ç”±äºæˆ‘ä»¬è¿™é‡Œè¿™é‡Œçš„é€»è¾‘åªä¼šå†™åœ¨åé¢ï¼Œæ‰€ä»¥ before å°±ç•™ç©ºäº†ã€‚ ä½¿ç”¨12345$coffee = new plainCoffee();$coffee-&gt;addDecorator(new sweetCoffeeDecorator());$coffee-&gt;makeCoffee(); è¿™æ ·å°±å¾—åˆ°äº†åŠ ç³–çš„ coffeeï¼Œå¦‚æœè¦åŠ å¥¶çš„ï¼Œå°±å†æ–°å»ºä¸€ä¸ªç±»ä¼¼çš„ä¿®é¥°å™¨ï¼š 1234567$coffee = new plainCoffee();$coffee-&gt;addDecorator(new sweetCoffeeDecorator());$coffee-&gt;addDecorator(new milkCoffeeDecorator());$coffee-&gt;makeCoffee(); ä¸éš¾å‘ç°ï¼Œåœ¨è¿™é‡Œå¯ä»¥è‡ªç”±çš„æ–°å¢æˆ–æ³¨é‡Šæ‰ ä¸åŒçš„è£…é¥°å™¨ã€‚æ˜¯ä¸æ˜¯å¾ˆçµæ´»ï¼Ÿ å½“ä½  extends ç”¨è¿‡ååˆé‡åˆ°éœ€è¦å†æ¬¡ extends çš„æƒ…å†µæ—¶ï¼Œä¸å¦¨è€ƒè™‘ä¸€ä¸‹è£…é¥°å™¨æ¨¡å¼ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"åŠ¨æ€è§„åˆ’ç®—æ³•ã®çˆ¬æ¥¼æ¢¯","slug":"ç®—æ³•/algorithm-dynatic","date":"2017-06-21T08:04:00.000Z","updated":"2021-03-20T16:25:01.821Z","comments":true,"path":"2017/06/21/ç®—æ³•/algorithm-dynatic/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/21/%E7%AE%97%E6%B3%95/algorithm-dynatic/","excerpt":"é¢˜ç›®æœ‰ä¸€åº§é«˜åº¦æ˜¯ 10 çº§å°é˜¶çš„æ¥¼æ¢¯ï¼Œä»ä¸‹å¾€ä¸Šèµ°ï¼Œæ¯è·¨ä¸€æ­¥åªèƒ½å‘ä¸Š 1 çº§æˆ–è€… 2 çº§å°é˜¶ã€‚è¦æ±‚ç”¨ç¨‹åºæ¥æ±‚å‡ºä¸€å…±æœ‰å¤šå°‘ç§èµ°æ³•ã€‚","text":"é¢˜ç›®æœ‰ä¸€åº§é«˜åº¦æ˜¯ 10 çº§å°é˜¶çš„æ¥¼æ¢¯ï¼Œä»ä¸‹å¾€ä¸Šèµ°ï¼Œæ¯è·¨ä¸€æ­¥åªèƒ½å‘ä¸Š 1 çº§æˆ–è€… 2 çº§å°é˜¶ã€‚è¦æ±‚ç”¨ç¨‹åºæ¥æ±‚å‡ºä¸€å…±æœ‰å¤šå°‘ç§èµ°æ³•ã€‚ è§£æ³•12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758&lt;?php/** * ç®—æ³•ï¼šåŠ¨æ€è§„åˆ’. * æ€è·¯: æœ€ä¼˜å­ç»“æ„,è‡ªä½å‘ä¸Šï¼Œç©ºé—´æ¢æ—¶é—´ï¼Œå…³é”®ä¸€æ­¥ï¼Œå’Œå¤‡å¿˜å½•ç®—æ³•åŒºåˆ« * User: ç™½èœ * Date: 2017/6/21 * Time: 15:45 * é¢˜ç›® :æœ‰ä¸€åº§é«˜åº¦æ˜¯10çº§å°é˜¶çš„æ¥¼æ¢¯ï¼Œä»ä¸‹å¾€ä¸Šèµ°ï¼Œæ¯è·¨ä¸€æ­¥åªèƒ½å‘ä¸Š1çº§æˆ–è€…2çº§å°é˜¶ã€‚è¦æ±‚ç”¨ç¨‹åºæ¥æ±‚å‡ºä¸€å…±æœ‰å¤šå°‘ç§èµ°æ³•ã€‚ *//** * åŠ¨æ€è§„åˆ’ç®—æ³• * * @param $n * * @return int|mixed *//** * åŠ¨æ€è§„åˆ’å†™æ³•ï¼ˆå¤‡å¿˜å½•ç®—æ³•å‡çº§ç‰ˆï¼‰ * æ—¶é—´å¤æ‚åº¦O(n),ç©ºé—´å¤æ‚åº¦O(1) * * @param int $n å°é˜¶æ•° * * @return int */function dp3(int $n)&#123; if ($n &lt; 0) &#123; return false; &#125; switch ($n) &#123; case 1: return 1; break; case 2: return 2; break; default: $a = 1; // ç¬¬n-1ä¸ª $b = 2; // ç¬¬n-2ä¸ª $temp = 0; // ä¸´æ—¶å˜é‡,ç”¨äºä¸‹é¢å¾ªç¯å¤„äº¤äº’$a,$bå¤§å° for ($i = 3; $i &lt;= $n; $i++) &#123; $temp = $a + $b; $a = $b; $b = $temp; &#125; unset($a, $b); return $temp; &#125;&#125;$level = 4;echo dp($level); æ—¶é—´å¯¹æ¯”123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144&lt;?php/** * ç®—æ³•ï¼šåŠ¨æ€è§„åˆ’. * æ€è·¯: æœ€ä¼˜å­ç»“æ„,è‡ªä½å‘ä¸Šï¼Œç©ºé—´æ¢æ—¶é—´ï¼Œå…³é”®ä¸€æ­¥ï¼Œå’Œå¤‡å¿˜å½•ç®—æ³•åŒºåˆ« * User: ç™½èœ * Date: 2017/6/21 * Time: 15:45 * é¢˜ç›® :æœ‰ä¸€åº§é«˜åº¦æ˜¯10çº§å°é˜¶çš„æ¥¼æ¢¯ï¼Œä»ä¸‹å¾€ä¸Šèµ°ï¼Œæ¯è·¨ä¸€æ­¥åªèƒ½å‘ä¸Š1çº§æˆ–è€…2çº§å°é˜¶ã€‚è¦æ±‚ç”¨ç¨‹åºæ¥æ±‚å‡ºä¸€å…±æœ‰å¤šå°‘ç§èµ°æ³•ã€‚ *//** * å•çº¯çš„é€’å½’ * æ—¶é—´å¤æ‚åº¦O(2^n),ç©ºé—´å¤æ‚åº¦O(1) * * @param int $n å°é˜¶æ•° * * @return int */function dp1(int $n)&#123; if ($n &lt; 0) &#123; return false; &#125; // å•çº¯çš„é€’å½’ï¼Œè€ŒéåŠ¨æ€è§„åˆ’ switch ($n) &#123; case 1: return 1; break; case 2: return 2; break; default: return dp1($n - 1) + dp1($n - 2); &#125;&#125;/** * å¤‡å¿˜å½•ç®—æ³•(å•çº¯çš„é€’å½’å‡çº§) * æ—¶é—´å¤æ‚åº¦O(n),ç©ºé—´å¤æ‚åº¦O(n) * * @param int $n å°é˜¶æ•° * * @return int|mixed */function dp2(int $n)&#123; if ($n &lt; 0) &#123; return false; &#125; // å¤‡å¿˜å½•ç®—æ³• static $storage = [ 1 =&gt; 1, 2 =&gt; 2, ]; if (isset($storage[ $n ])) &#123; return $storage[ $n ]; &#125; // é€’å½’ï¼ŒåŠ¨æ€è§„åˆ’æ ¹åŸº f(1)=1ï¼Œf(2)=2 &#123;1-&gt;1|2&#125; ,f(3)&#123;1-&gt;1-&gt;1|1-&gt;2|2-&gt;1&#125; $num = dp2($n - 1) + dp2($n - 2); $storage[ $n ] = $num; return $num;&#125;/** * åŠ¨æ€è§„åˆ’å†™æ³•ï¼ˆå¤‡å¿˜å½•ç®—æ³•å‡çº§ç‰ˆï¼‰ * æ—¶é—´å¤æ‚åº¦O(n),ç©ºé—´å¤æ‚åº¦O(1) * * @param int $n å°é˜¶æ•° * * @return int */function dp3(int $n)&#123; if ($n &lt; 0) &#123; return false; &#125; switch ($n) &#123; case 1: return 1; break; case 2: return 2; break; default: $a = 1; // ç¬¬n-1ä¸ª $b = 2; // ç¬¬n-2ä¸ª $temp = 0; // ä¸´æ—¶å˜é‡,ç”¨äºä¸‹é¢å¾ªç¯å¤„äº¤äº’$a,$bå¤§å° for ($i = 3; $i &lt;= $n; $i++) &#123; $temp = $a + $b; $a = $b; $b = $temp; &#125; unset($a, $b); return $temp; &#125;&#125;$level = 4;$start = microtime(true);$memory = memory_get_usage();for ($i = 0; $i &lt; 100000000; $i++)&#123; dp3($level);&#125;echo 'åŠ¨æ€è§„åˆ’è€—æ—¶ï¼š' . round(microtime(true) - $start, 4);echo PHP_EOL;echo 'åŠ¨æ€è§„åˆ’å ç”¨å†…å­˜ï¼š' . (memory_get_usage() - $memory) / 1024 . 'KB';echo PHP_EOL . PHP_EOL;$start = microtime(true);$memory = memory_get_usage();for ($i = 0; $i &lt; 100000000; $i++)&#123; dp2($level);&#125;echo 'å¤‡å¿˜å½•ç®—æ³•è€—æ—¶ï¼š' . round(microtime(true) - $start, 4);echo PHP_EOL;echo 'å¤‡å¿˜å½•ç®—æ³•å ç”¨å†…å­˜ï¼š' . (memory_get_usage() - $memory) / 1024 . 'KB';echo PHP_EOL . PHP_EOL;$start = microtime(true);$memory = memory_get_usage();for ($i = 0; $i &lt; 100000000; $i++)&#123; dp1($level);&#125;echo 'ç›´æ¥é€’å½’è€—æ—¶ï¼š' . round(microtime(true) - $start, 4);echo PHP_EOL;echo 'ç›´æ¥é€’å½’å ç”¨å†…å­˜ï¼š' . (memory_get_usage() - $memory) / 1024 . 'KB';echo PHP_EOL; æ€»ç»“ä»ç®—æ³•ä¸Šçœ‹ï¼ŒåŠ¨æ€è§„åˆ’ï¼Œä¸ç®¡æ˜¯ä»ç©ºé—´è¿˜æ˜¯æ—¶é—´ä¸Šéƒ½æ˜¯æœ€ä¼˜çš„ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬ç”¨åˆ°çš„ static å…³é”®å­—ï¼Œæ”¾è¿™ä¸ªç»“æœå˜æˆäº†å¤‡å¿˜å½•ç®—æ³•æ¯”åŠ¨æ€è§„åˆ’è¿˜è¦å¿«ã€‚æ‰€ä»¥è¿™ä¸ªç®—æ³•å’Œç»“æœè¿˜æ˜¯æœ‰ç‚¹å‡ºå…¥çš„ï¼Œä¸è¿‡ä¹Ÿå¥½ï¼Œå¤§å®¶ä¹ŸçŸ¥é“åŠ¨æ€è§„åˆ’çš„åŸç†äº†ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"åŠ¨æ€è§„åˆ’","slug":"åŠ¨æ€è§„åˆ’","permalink":"http://blog.crazylaw.cn/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"}]},{"title":"HASHç®—æ³•ã®BKDRHash","slug":"ç®—æ³•/algorithm-hash-bkrd","date":"2017-06-20T09:39:00.000Z","updated":"2021-03-20T16:25:01.821Z","comments":true,"path":"2017/06/20/ç®—æ³•/algorithm-hash-bkrd/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/20/%E7%AE%97%E6%B3%95/algorithm-hash-bkrd/","excerpt":"è¯´æ˜ä»Šå¤©å’Œåˆ«äººè¯´ä¸€ä¸‹ hash ç®—æ³•ï¼Œèµ·æºæ˜¯å› ä¸ºå­—ç¬¦ä¸²åœ¨æ•°æ®åº“åšç´¢å¼•çš„é—®é¢˜ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯å­—ç¬¦ä¸²é€šè¿‡ hash ç®—æ³•ï¼Œå¾—åˆ°çš„ int ç±»å‹çš„æ•°æ®ï¼Œåœ¨ int ç±»å‹çš„æ•°æ®åº“ä¸Šåšç´¢å¼•ï¼Œä½†æ˜¯ hash ç®—æ³•æœ‰å¾ˆå¤šé€‰æ‹©ï¼Œå°± PHP è€Œè¨€ï¼Œæœ‰äººè¯´ 10 ä¸‡æ•°æ®å†…çš„è¯ï¼Œç”¨ PHP å†…ç½®çš„ CRC32 ç®—æ³•(abs(crc32($str)))å°±å¯ä»¥ï¼Œä½†æ˜¯æˆ‘å‘ç° hash ç®—æ³•æœ‰å¾ˆå¤šç§ï¼Œå…¶ä¸­ä¸€ç§å°±æ˜¯ bkdrhash ç®—æ³•ã€‚","text":"è¯´æ˜ä»Šå¤©å’Œåˆ«äººè¯´ä¸€ä¸‹ hash ç®—æ³•ï¼Œèµ·æºæ˜¯å› ä¸ºå­—ç¬¦ä¸²åœ¨æ•°æ®åº“åšç´¢å¼•çš„é—®é¢˜ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯å­—ç¬¦ä¸²é€šè¿‡ hash ç®—æ³•ï¼Œå¾—åˆ°çš„ int ç±»å‹çš„æ•°æ®ï¼Œåœ¨ int ç±»å‹çš„æ•°æ®åº“ä¸Šåšç´¢å¼•ï¼Œä½†æ˜¯ hash ç®—æ³•æœ‰å¾ˆå¤šé€‰æ‹©ï¼Œå°± PHP è€Œè¨€ï¼Œæœ‰äººè¯´ 10 ä¸‡æ•°æ®å†…çš„è¯ï¼Œç”¨ PHP å†…ç½®çš„ CRC32 ç®—æ³•(abs(crc32($str)))å°±å¯ä»¥ï¼Œä½†æ˜¯æˆ‘å‘ç° hash ç®—æ³•æœ‰å¾ˆå¤šç§ï¼Œå…¶ä¸­ä¸€ç§å°±æ˜¯ bkdrhash ç®—æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152&lt;?php/** * BKDRHashç®—æ³• * * Cã€C++ç‰ˆæœ¬ * unsigned int BKDRHash(char *str) * &#123; * unsigned int seed = 131313;//ä¹Ÿå¯ä»¥ä¹˜ä»¥31ã€131ã€1313ã€13131ã€131313.. * unsigned int hash = 0; * while(*str) * &#123; * hash = hash*seed + (*str++); * &#125; * * return hash%32767;//æœ€å¥½å¯¹ä¸€ä¸ªå¤§çš„ç´ æ•°å–ä½™ * &#125; * * phpå®ç° æ¯”cè¯­è¨€ç‰ˆæœ¬å¤æ‚çš„éƒ¨åˆ†ï¼Œæ˜¯ç”±äºphpä¸­æ•´å‹æ•°çš„èŒƒå›´æ˜¯ï¼Œä¸”ä¸€å®šæ˜¯-2147483648 åˆ°2147483647ï¼Œå¹¶ä¸”æ²¡æœ‰æ— ç¬¦å·æ•´å½¢æ•°ã€‚ * åœ¨ç®—æ³•ä¸­ä¼šå‡ºç°å¤§æ•°æº¢å‡ºçš„é—®é¢˜ï¼Œä¸èƒ½ä½¿ç”¨intval,éœ€è¦ç”¨floatvalï¼ŒåŒæ—¶åœ¨è¿ç®—è¿‡ç¨‹ä¸­å–ä½™ä¿è¯ä¸æº¢å‡ºã€‚ * 0x7FFFFFFF æ˜¯æ§åˆ¶long intçš„æœ€å¤§å€¼ */class BKDRHash&#123; private $seed = 131; private $hash = 0; public $str = ''; public function __construct($str) &#123; $this-&gt;str = md5($str); &#125; public function hash() &#123; $this-&gt;hash = 0; for ($i = 0; $i &lt; 32; $i++) &#123; $this-&gt;hash = ((floatval($this-&gt;hash * $this-&gt;seed) &amp; 0x7FFFFFFF) + ord($this-&gt;str&#123;$i&#125;)) &amp; 0x7FFFFFFF; // è¡¨ç¤ºæ§åˆ¶åœ¨long intèŒƒå›´ä¹‹å†… &#125; return $this-&gt;hash &amp; 0x7FFFFFFF; &#125;&#125;$obj = new BKDRHash('ç™½èœ');var_dump($obj-&gt;hash());$obj-&gt;str = md5('ç™½èœ');var_dump($obj-&gt;hash());","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"Hashå‡½æ•°","slug":"Hashå‡½æ•°","permalink":"http://blog.crazylaw.cn/tags/Hash%E5%87%BD%E6%95%B0/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®ç»„åˆæ¨¡å¼","slug":"design-combination-model","date":"2017-06-20T08:19:00.000Z","updated":"2021-03-20T16:25:01.803Z","comments":true,"path":"2017/06/20/design-combination-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/20/design-combination-model/","excerpt":"å¤§æ¦‚æ„æ€ä¸€ä¸ªæ¥å£å¯¹äºå¤šä¸ªå®ç°ï¼Œå¹¶ä¸”è¿™äº›å®ç°ä¸­éƒ½æ‹¥æœ‰ç›¸åŒçš„æ–¹æ³•ï¼ˆåï¼‰ã€‚ æœ‰æ—¶å€™ä½ éœ€è¦åªè¿è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œå°±è®©ä¸åŒå®ç°ç±»çš„æŸä¸ªæ–¹æ³•æˆ–æŸä¸ªé€»è¾‘å…¨éƒ¨æ‰§è¡Œä¸€éã€‚åœ¨æ‰¹é‡å¤„ç†å¤šä¸ªå®ç°ç±»æ—¶ï¼Œæ„Ÿè§‰å°±åƒåœ¨ä½¿ç”¨ä¸€ä¸ªç±»ä¸€æ ·ã€‚ 12345678910111213//å…ˆå»ºç«‹ä¸€ä¸ªè¡¨å•$form = new Form();//åœ¨è¡¨å•ä¸­å¢åŠ ä¸€ä¸ªEmailå…ƒç´ $form-&gt;addElement(new TextElement('Email:'));$form-&gt;addElement(new InputElement());//åœ¨è¡¨å•ä¸­å¢åŠ ä¸€ä¸ªå¯†ç å…ƒç´ $form-&gt;addElement(new TextElement('Password:'));$form-&gt;addElement(new InputElement());//æŠŠè¡¨å•æ¸²æŸ“å‡ºæ¥$form-&gt;render(); è¿™ä¸ªä¾‹å­å½¢è±¡çš„ä»‹ç»äº†ç»„åˆæ¨¡å¼ï¼Œè¡¨å•çš„å…ƒç´ å¯ä»¥åŠ¨æ€å¢åŠ ï¼Œä½†æ˜¯åªè¦æ¸²æŸ“ä¸€æ¬¡ï¼Œå°±å¯ä»¥æŠŠæ•´ä¸ªè¡¨å•æ¸²æŸ“å‡ºæ¥ã€‚","text":"å¤§æ¦‚æ„æ€ä¸€ä¸ªæ¥å£å¯¹äºå¤šä¸ªå®ç°ï¼Œå¹¶ä¸”è¿™äº›å®ç°ä¸­éƒ½æ‹¥æœ‰ç›¸åŒçš„æ–¹æ³•ï¼ˆåï¼‰ã€‚ æœ‰æ—¶å€™ä½ éœ€è¦åªè¿è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œå°±è®©ä¸åŒå®ç°ç±»çš„æŸä¸ªæ–¹æ³•æˆ–æŸä¸ªé€»è¾‘å…¨éƒ¨æ‰§è¡Œä¸€éã€‚åœ¨æ‰¹é‡å¤„ç†å¤šä¸ªå®ç°ç±»æ—¶ï¼Œæ„Ÿè§‰å°±åƒåœ¨ä½¿ç”¨ä¸€ä¸ªç±»ä¸€æ ·ã€‚ 12345678910111213//å…ˆå»ºç«‹ä¸€ä¸ªè¡¨å•$form = new Form();//åœ¨è¡¨å•ä¸­å¢åŠ ä¸€ä¸ªEmailå…ƒç´ $form-&gt;addElement(new TextElement('Email:'));$form-&gt;addElement(new InputElement());//åœ¨è¡¨å•ä¸­å¢åŠ ä¸€ä¸ªå¯†ç å…ƒç´ $form-&gt;addElement(new TextElement('Password:'));$form-&gt;addElement(new InputElement());//æŠŠè¡¨å•æ¸²æŸ“å‡ºæ¥$form-&gt;render(); è¿™ä¸ªä¾‹å­å½¢è±¡çš„ä»‹ç»äº†ç»„åˆæ¨¡å¼ï¼Œè¡¨å•çš„å…ƒç´ å¯ä»¥åŠ¨æ€å¢åŠ ï¼Œä½†æ˜¯åªè¦æ¸²æŸ“ä¸€æ¬¡ï¼Œå°±å¯ä»¥æŠŠæ•´ä¸ªè¡¨å•æ¸²æŸ“å‡ºæ¥ã€‚ å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263// é¡¶å±‚æ¸²æŸ“æ¥å£ RenderableInterface.phpinterface RenderableInterface&#123; public function render(): string;&#125;// è¡¨å•æ„é€ å™¨ Form.php//å¿…é¡»ç»§æ‰¿é¡¶å±‚æ¸²æŸ“æ¥å£class Form implements RenderableInterface&#123; private $elements; //è¿™é‡Œå¾ˆå…³é”®ï¼Œç›¸å½“äºæ˜¯æ‰¹é‡å¤„ç†æ¥å£å®ç°ç±» public function render(): string &#123; $formCode = '&lt;form&gt;'; foreach ($this-&gt;elements as $element) &#123; $formCode .= $element-&gt;render(); &#125; $formCode .= '&lt;/form&gt;'; return $formCode; &#125; //è¿™ä¸ªæ–¹æ³•ç”¨æ¥æ³¨å†Œ æ¥å£å®ç°ç±» public function addElement(RenderableInterface $element) &#123; $this-&gt;elements[] = $element; &#125;&#125;// å…·ä½“å®ç°ç±»ä¸€ TextElement.phpclass TextElement implements RenderableInterface&#123; private $text; public function __construct(string $text) &#123; $this-&gt;text = $text; &#125; public function render(): string &#123; return $this-&gt;text; &#125;&#125;// å…·ä½“å®ç°ç±»äºŒ InputElement.phpclass InputElement implements RenderableInterface&#123; public function render(): string &#123; return '&lt;input type=\"text\" /&gt;'; &#125;&#125;// ä½ è¿˜å¯ä»¥å®šä¹‰æ›´å¤šçš„å…ƒç´ ï¼Œæ¥æ„å»ºè¡¨å•ã€‚ è¾“å‡ºç»“æœå½“ä½ ä½¿ç”¨ $form-&gt;render() æ¸²æŸ“ä¹‹åï¼Œæ‰€æœ‰çš„å…ƒç´ éƒ½å¯ä»¥æ¸²æŸ“å‡ºæ¥ã€‚ 1&lt;form&gt;Email:&lt;input type=\"text\" /&gt;Password:&lt;input type=\"text\" /&gt;&lt;/form&gt;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®æ¡¥æ¥æ¨¡å¼","slug":"design-bridge-model","date":"2017-06-20T07:45:00.000Z","updated":"2021-03-20T16:25:01.802Z","comments":true,"path":"2017/06/20/design-bridge-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/20/design-bridge-model/","excerpt":"ç›®çš„æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œä¸€ä¸ªæ¥å£å¯¹åº”å¤šä¸ªå®ç°ã€‚ åœ¨ä¸åŒçš„å®ç°ç±»ä¸­ï¼Œå®ƒå®ç°æ¥å£æ–¹æ³•çš„é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ã€‚ æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹è¿™äº›æŠ½è±¡æ–¹æ³•è¿›è¡Œä¸€äº›ç»„åˆï¼Œä¿®æ”¹ï¼Œä½†æ˜¯åˆèƒ½é€‚ç”¨äºæ‰€æœ‰å®ç°ç±»ã€‚ è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªæ¡¥ï¼Œè¿æ¥ä¸åŒçš„å®ç°ç±»å¹¶ç»Ÿä¸€æ ‡å‡†ã€‚ ä¸€ä¸ªæ¥å£å¤šä¸ªå®ç°1234567891011121314151617181920212223// æ ¼å¼åŒ–æ¥å£interface FormatterInterface&#123; public function format(string $text);&#125;// æ–‡æœ¬æ ¼å¼åŒ–class PlainTextFormatter implements FormatterInterface&#123; public function format(string $text) &#123; return $text; &#125;&#125;// HTMLæ ¼å¼åŒ–class HtmlFormatter implements FormatterInterface&#123; public function format(string $text) &#123; return sprintf('&lt;p&gt;%s&lt;/p&gt;', $text); &#125;&#125;","text":"ç›®çš„æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªç±»å¯ä»¥å®ç°å¤šä¸ªæ¥å£ï¼Œä¸€ä¸ªæ¥å£å¯¹åº”å¤šä¸ªå®ç°ã€‚ åœ¨ä¸åŒçš„å®ç°ç±»ä¸­ï¼Œå®ƒå®ç°æ¥å£æ–¹æ³•çš„é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ã€‚ æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹è¿™äº›æŠ½è±¡æ–¹æ³•è¿›è¡Œä¸€äº›ç»„åˆï¼Œä¿®æ”¹ï¼Œä½†æ˜¯åˆèƒ½é€‚ç”¨äºæ‰€æœ‰å®ç°ç±»ã€‚ è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªæ¡¥ï¼Œè¿æ¥ä¸åŒçš„å®ç°ç±»å¹¶ç»Ÿä¸€æ ‡å‡†ã€‚ ä¸€ä¸ªæ¥å£å¤šä¸ªå®ç°1234567891011121314151617181920212223// æ ¼å¼åŒ–æ¥å£interface FormatterInterface&#123; public function format(string $text);&#125;// æ–‡æœ¬æ ¼å¼åŒ–class PlainTextFormatter implements FormatterInterface&#123; public function format(string $text) &#123; return $text; &#125;&#125;// HTMLæ ¼å¼åŒ–class HtmlFormatter implements FormatterInterface&#123; public function format(string $text) &#123; return sprintf('&lt;p&gt;%s&lt;/p&gt;', $text); &#125;&#125; æ¡¥æ¥æ ¸å¿ƒ12345678910111213141516171819abstract class Service&#123; protected $implementation; //åˆå§‹åŒ–ä¸€ä¸ªFormatterInterfaceçš„å®ç° public function __construct(FormatterInterface $printer) &#123; $this-&gt;implementation = $printer; &#125; // å¯ä»¥è·Ÿæ¢å®ç° public function setImplementation(FormatterInterface $printer) &#123; $this-&gt;implementation = $printer; &#125; //æ¡¥æ¥æŠ½è±¡æ–¹æ³• abstract public function get();&#125; å…·ä½“æ¡¥æ¥12345678class HelloWorldService extends Service&#123; //æ¡¥æ¥æŠ½è±¡æ–¹æ³•çš„å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å…³é”®ï¼Œå› ä¸ºå®ƒä¸åœ¨å—é™äºåŸæœ‰çš„æ¥å£æ–¹æ³•ï¼Œè€Œæ˜¯å¯ä»¥è‡ªç”±ç»„åˆä¿®æ”¹ï¼Œå¹¶ä¸”ä½ å¯ä»¥ç¼–å†™å¤šä¸ªç±»ä¼¼çš„æ–¹æ³•ï¼Œè¿™æ ·å°±å’ŒåŸæ¥å£è§£è€¦äº†ã€‚ public function get() &#123; return $this-&gt;implementation-&gt;format('Hello World') . '-è¿™æ˜¯ä¿®æ”¹çš„åç¼€'; &#125;&#125; ä½¿ç”¨12345678$service = new HelloWorldService(new PlainTextFormatter());echo $service-&gt;get(); //Hello World-è¿™æ˜¯ä¿®æ”¹çš„åç¼€//åœ¨è¿™é‡Œåˆ‡æ¢å®ç°å¾ˆè½»æ¾$service-&gt;setImplementation(new HtmlFormatter());echo $service-&gt;get(); //&lt;p&gt;Hello World&lt;/p&gt;-è¿™æ˜¯ä¿®æ”¹çš„åç¼€","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®ç»“æ„å‹ã®é€‚é…å™¨æ¨¡å¼","slug":"design-adapter-model","date":"2017-06-20T03:54:00.000Z","updated":"2021-03-20T16:25:01.802Z","comments":true,"path":"2017/06/20/design-adapter-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/20/design-adapter-model/","excerpt":"è¯´æ˜æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ã€‚å…ˆæ¥çœ‹çœ‹æ¥å£çš„ä½œç”¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// ç›®æ ‡è§’è‰²(å¯¹å¤–ä¸€è‡´çš„æ¥å£)interface Database&#123; public function connect(); public function query(); public function close();&#125;class Mysql implements Database&#123; public function connect() &#123; //mysql çš„é€»è¾‘ &#125; public function query() &#123; //mysql çš„é€»è¾‘ &#125; public function close() &#123; //mysql çš„é€»è¾‘ &#125;&#125;class Pdo implements Database&#123; public function connect() &#123; //Pdo çš„é€»è¾‘ &#125; public function query() &#123; //Pdo çš„é€»è¾‘ &#125; public function close() &#123; //Pdo çš„é€»è¾‘ &#125;&#125;//ä½¿ç”¨$database = new Mysql(); //åˆ‡æ¢æ•°æ®åº“åªè¦æ”¹è¿™ä¸€è¡Œå°±è¡Œäº†ï¼Œå› ä¸ºåé¢çš„éƒ½æ˜¯æ ‡å‡†æ¥å£æ–¹æ³•ï¼Œä¸ç®¡å“ªä¸ªæ•°æ®åº“éƒ½ä¸€æ ·ã€‚$database-&gt;connect();$database-&gt;query();$database-&gt;close();","text":"è¯´æ˜æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ã€‚å…ˆæ¥çœ‹çœ‹æ¥å£çš„ä½œç”¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// ç›®æ ‡è§’è‰²(å¯¹å¤–ä¸€è‡´çš„æ¥å£)interface Database&#123; public function connect(); public function query(); public function close();&#125;class Mysql implements Database&#123; public function connect() &#123; //mysql çš„é€»è¾‘ &#125; public function query() &#123; //mysql çš„é€»è¾‘ &#125; public function close() &#123; //mysql çš„é€»è¾‘ &#125;&#125;class Pdo implements Database&#123; public function connect() &#123; //Pdo çš„é€»è¾‘ &#125; public function query() &#123; //Pdo çš„é€»è¾‘ &#125; public function close() &#123; //Pdo çš„é€»è¾‘ &#125;&#125;//ä½¿ç”¨$database = new Mysql(); //åˆ‡æ¢æ•°æ®åº“åªè¦æ”¹è¿™ä¸€è¡Œå°±è¡Œäº†ï¼Œå› ä¸ºåé¢çš„éƒ½æ˜¯æ ‡å‡†æ¥å£æ–¹æ³•ï¼Œä¸ç®¡å“ªä¸ªæ•°æ®åº“éƒ½ä¸€æ ·ã€‚$database-&gt;connect();$database-&gt;query();$database-&gt;close(); é—®é¢˜æœ‰äº›ç¬¬ä¸‰æ–¹çš„ æ•°æ®åº“ç±»å¹¶æ²¡æœ‰æŒ‰ç…§æˆ‘çš„æ¥å£æ¥å®ç°ï¼Œè€Œæ˜¯æœ‰è‡ªå·±ä¸åŒçš„æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦æœ‰ä¸€ä¸ªé€‚é…å™¨ç±»ï¼Œæ¥å…ˆå¤„ç†ä¸€ä¸‹è¿™ä¸ªå¼‚ç±»ã€‚ ä½œç”¨æœ‰ç‚¹åƒæŠŠ 110v ç”µæºè½¬æ¢æˆä¸º 220vï¼ˆç”µæºé€‚é…å™¨ï¼‰ã€‚ 123456789101112131415161718//ç¬¬ä¸‰æ–¹æ•°æ®åº“ç±»(æºè§’è‰²)class Oracle&#123; public function oracleConnect() &#123; //Oracle çš„é€»è¾‘ &#125; public function oracleQuery() &#123; //Oracle çš„é€»è¾‘ &#125; public function oracleClose() &#123; //Oracle çš„é€»è¾‘ &#125;&#125; é€‚é…å™¨æ¨¡å¼1234567891011121314151617181920212223242526// é€‚é…å™¨è§’è‰²class Adapter implements Database&#123; private $adaptee; function __construct($adaptee) &#123; $this-&gt;adaptee = $adaptee; &#125; //è¿™é‡ŒæŠŠå¼‚ç±»çš„æ–¹æ³•è½¬æ¢æˆäº† æ¥å£æ ‡å‡†æ–¹æ³•ï¼Œä¸‹åŒ public function connect() &#123; $this-&gt;adaptee-&gt;oracleConnect(); &#125; public function query() &#123; $this-&gt;adaptee-&gt;oracleQuery(); &#125; public function close() &#123; $this-&gt;adaptee-&gt;oracleClose(); &#125;&#125; ä½¿ç”¨ä¸Šï¼š 12345678$adaptee = new Oracle();$adapter = new Adapter($adaptee);//åªè¦æ”¹è¿™ä¸ªç±»å°±è¡Œäº†ï¼Œåé¢çš„éƒ½å¯ä»¥ä¸ç”¨æ”¹ï¼›// OR// $adapter = new Mysql();$database = $adapter;$database-&gt;connect();$database-&gt;query();$database-&gt;close(); æ‰€ä»¥è¯´ï¼Œé€‚é…å™¨å¯¹åº”ä¸åŒçš„å…·ä½“ç±»,è¿™ä¸ªç±»å®ç°ç›®æ ‡è§’è‰²çš„æ‰€æœ‰æ¥å£ï¼Œä½†æ˜¯ç”±äºæºè§’è‰²çš„æ“ä½œä¸ªä¸ä¸€è‡´,æ‰€ä»¥éœ€è¦ä¸€ä¸ªé€‚é…å™¨é€‚é…ä¸€ä¸ªæºè§’è‰²ã€‚å¾ˆç®€å•ï¼Œä¹Ÿå¾ˆå®ç”¨ã€‚ æ³¨æ„ï¼Œè¿˜å¯ä»¥ç»“åˆæŠ½è±¡ç±»å’Œå€Ÿå£åˆ†åˆ«åšæ–‡ç« ï¼Œæœ€ç»ˆçš„ç›®çš„å°±æ˜¯ç›®æ ‡è§’è‰²çš„ç»Ÿä¸€æ€§ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®åˆ›å»ºå‹ã®åŸå‹æ¨¡å¼","slug":"design-prototype-model","date":"2017-06-20T03:46:00.000Z","updated":"2021-03-20T16:25:01.804Z","comments":true,"path":"2017/06/20/design-prototype-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/20/design-prototype-model/","excerpt":"å®è´¨å°±æ˜¯ å¯¹è±¡çš„å¤åˆ¶å¯¹ä¸€äº›å¤§å‹å¯¹è±¡ï¼Œæ¯æ¬¡å» newï¼Œåˆå§‹åŒ–å¼€é”€å¾ˆå¤§ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ å…ˆ new ä¸€ä¸ªæ¨¡ç‰ˆå¯¹è±¡ï¼Œç„¶åå…¶ä»–å®ä¾‹éƒ½å» clone è¿™ä¸ªæ¨¡ç‰ˆï¼Œ è¿™æ ·å¯ä»¥èŠ‚çº¦ä¸å°‘æ€§èƒ½ã€‚è¿™ä¸ªæ‰€è°“çš„æ¨¡ç‰ˆï¼Œå°±æ˜¯åŸå‹ï¼ˆPrototypeï¼‰ï¼›å½“ç„¶ï¼ŒåŸå‹æ¨¡å¼æ¯”å•çº¯çš„ Clone è¦ç¨å¾®å‡çº§ä¸€ä¸‹ã€‚ æ™®é€š clonenew å’Œ clone éƒ½æ˜¯ç”¨æ¥åˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ã€‚åœ¨ PHP ä¸­ï¼Œ å¯¹è±¡é—´çš„èµ‹å€¼æ“ä½œå®é™…ä¸Šæ˜¯å¼•ç”¨æ“ä½œ ï¼ˆäº‹å®ä¸Šï¼Œç»å¤§éƒ¨åˆ†çš„ç¼–ç¨‹è¯­è¨€éƒ½æ˜¯å¦‚æ­¤! ä¸»è¦åŸå› æ˜¯å†…å­˜åŠæ€§èƒ½çš„é—®é¢˜) ï¼Œæ¯”å¦‚ï¼š","text":"å®è´¨å°±æ˜¯ å¯¹è±¡çš„å¤åˆ¶å¯¹ä¸€äº›å¤§å‹å¯¹è±¡ï¼Œæ¯æ¬¡å» newï¼Œåˆå§‹åŒ–å¼€é”€å¾ˆå¤§ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ å…ˆ new ä¸€ä¸ªæ¨¡ç‰ˆå¯¹è±¡ï¼Œç„¶åå…¶ä»–å®ä¾‹éƒ½å» clone è¿™ä¸ªæ¨¡ç‰ˆï¼Œ è¿™æ ·å¯ä»¥èŠ‚çº¦ä¸å°‘æ€§èƒ½ã€‚è¿™ä¸ªæ‰€è°“çš„æ¨¡ç‰ˆï¼Œå°±æ˜¯åŸå‹ï¼ˆPrototypeï¼‰ï¼›å½“ç„¶ï¼ŒåŸå‹æ¨¡å¼æ¯”å•çº¯çš„ Clone è¦ç¨å¾®å‡çº§ä¸€ä¸‹ã€‚ æ™®é€š clonenew å’Œ clone éƒ½æ˜¯ç”¨æ¥åˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ã€‚åœ¨ PHP ä¸­ï¼Œ å¯¹è±¡é—´çš„èµ‹å€¼æ“ä½œå®é™…ä¸Šæ˜¯å¼•ç”¨æ“ä½œ ï¼ˆäº‹å®ä¸Šï¼Œç»å¤§éƒ¨åˆ†çš„ç¼–ç¨‹è¯­è¨€éƒ½æ˜¯å¦‚æ­¤! ä¸»è¦åŸå› æ˜¯å†…å­˜åŠæ€§èƒ½çš„é—®é¢˜) ï¼Œæ¯”å¦‚ï¼š 1234567891011class ProClass&#123; public $data;&#125;$obj1 = new ProClass();$obj1-&gt;data = \"aaa\";$obj2 = $obj1;$obj2-&gt;data = \"bbb\"; //$obj1-&gt;dataçš„å€¼ä¹Ÿä¼šå˜æˆ\"bbb\"var_dump($obj1-&gt;data); ä½†æ˜¯å¦‚æœä½ ä¸æ˜¯ç›´æ¥å¼•ç”¨ï¼Œè€Œæ˜¯ cloneï¼Œé‚£ä¹ˆç›¸å½“äºåšäº†ä¸€ä¸ªç‹¬ç«‹çš„å‰¯æœ¬ï¼š 12$obj2 = clone $obj1;$obj2-&gt;data =\"bbb\"; //$obj1-&gt;dataçš„å€¼è¿˜æ˜¯\"aaa\"ï¼Œä¸ä¼šå…³è” è¿™æ ·å°±å¾—åˆ°ä¸€ä¸ªå’Œè¢«å¤åˆ¶å¯¹è±¡å®Œå…¨æ²¡æœ‰çº è‘›çš„æ–°å¯¹è±¡ï¼Œä½†ä¸¤ä¸ªå¯¹è±¡é•¿å¾—æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚ æµ…å¤åˆ¶å’Œæ·±å¤åˆ¶å¦‚æœä½ ä»¥ä¸ºä½ å·²ç»æŠŠå®ƒä¿©å½»åº•åˆ†å¼€äº†ï¼Œä½ é”™äº†ï¼Œæ²¡é‚£ä¹ˆå®¹æ˜“, æˆ‘ä»¬å†çœ‹ä¸€ä¸ªå¤æ‚ç‚¹ä¾‹å­ã€‚ç»§ç»­æ¥ç€ä¸Šé¢çš„ä¾‹å­çœ‹: 12345678910111213141516171819202122232425262728293031323334353637class ProClass&#123; public $data; public $item;&#125;$obj1 = new ProClass();$obj1-&gt;data = \"aaa\";class itemObject&#123; public $count = 0; public function add() &#123; $this-&gt;count = ++$this-&gt;count; &#125;&#125;$item = new itemObject;$obj1-&gt;item = $item;$obj2 = clone $obj1;$obj2-&gt;data = \"bbb\";var_dump($obj1-&gt;data); // aaavar_dump($obj2-&gt;data); // bbb// åˆ°ç›®å‰ä¸ºæ­¢,ä¸€åˆ‡éƒ½æ²¡é—®é¢˜,å·²ç»éš”ç¦»å¼€äº†.// ä½†æ˜¯åˆ°è¿™é‡Œä¹‹åï¼Œè¿è¡Œä»¥ä¸‹ä»£ç $obj2-&gt;item-&gt;add();print_r($item); // count = 1print_r($obj1); // count = 1print_r($obj2); // count = 1// å‘ç°$obj1,$obj2çš„countéƒ½å˜æˆäº†1,å‘ç°åˆä¾èµ–ä¸Šäº†ï¼Œå¹¶æ²¡æœ‰å®Œå…¨éš”ç¦»å¼€ã€‚è¿™å°±æ˜¯æ‰€è°“çš„ æµ…å¤åˆ¶ æˆ‘ä»¬æ—¢ç„¶è¦ Cloneï¼Œç›®çš„å°±æ˜¯è¦æŠŠ ä¸¤ä¸ªå¯¹è±¡ å®Œå…¨åˆ†ç¦»å¼€ã€‚ æ‰€ä»¥æˆ‘ä»¬æ¥èŠä¸€ä¸‹ æ·±å¤åˆ¶ çš„æ–¹æ³•ï¼š éå¸¸ç®€å•ï¼Œåœ¨è¢«å¤åˆ¶å¯¹è±¡ä¸­åŠ ä¸€ä¸ªé­”æœ¯æ–¹æ³•å°±å¯ä»¥äº†ã€‚ 12345678class ProClass&#123; public $data; public $item; public function __clone() &#123; $this-&gt;item &#x3D; clone $this-&gt;item; &#125;&#125; æ­£è§£12345678910111213141516171819202122232425262728interface Prototype&#123; public function copy();&#125;class ConcretePrototype implements Prototype&#123; private $_name; public function __construct($name) &#123; $this-&gt;_name = $name; &#125; public function copy() &#123; return clone $this; &#125;&#125;class Demo&#123;&#125;// client$demo = new Demo();$object1 = new ConcretePrototype($demo);$object2 = $object1-&gt;copy(); ä»ä¸Šé¢çš„ä¾‹å­ä¸éš¾çœ‹å‡ºï¼Œæ‰€è°“åŸå‹æ¨¡å¼å°±æ˜¯ä¸ç›´æ¥ç”¨ clone è¿™ç§å…³é”®å­—å†™æ³•ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªåŸå‹ç±»ã€‚ æŠŠéœ€è¦è¢«å¤åˆ¶çš„å¯¹è±¡ä¸¢è¿› åŸå‹ç±»é‡Œé¢ï¼Œç„¶åè¿™ä¸ªç±»å°±å…·æœ‰äº† å¤åˆ¶è‡ªå·±çš„èƒ½åŠ›ï¼ˆæ–¹æ³•ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç»§æ‰¿åŸå‹çš„ä¸€äº›å…¬å…±çš„å±æ€§å’Œæ–¹æ³•ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®åˆ›å»ºå‹ã®åŸå‹æ¨¡å¼","slug":"design-object-pool-model","date":"2017-06-20T03:46:00.000Z","updated":"2021-03-20T16:25:01.804Z","comments":true,"path":"2017/06/20/design-object-pool-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/20/design-object-pool-model/","excerpt":"ç®€ä»‹ å¯¹è±¡æ± ï¼ˆä¹Ÿç§°ä¸ºèµ„æºæ± ï¼‰è¢«ç”¨æ¥ç®¡ç†å¯¹è±¡ç¼“å­˜ã€‚å¯¹è±¡æ± æ˜¯ä¸€ç»„å·²ç»åˆå§‹åŒ–è¿‡ä¸”å¯ä»¥ç›´æ¥ä½¿ç”¨çš„å¯¹è±¡é›†åˆï¼Œç”¨æˆ·åœ¨ä½¿ç”¨å¯¹è±¡æ—¶å¯ä»¥ä»å¯¹è±¡æ± ä¸­è·å–å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œæ“ä½œå¤„ç†ï¼Œå¹¶åœ¨ä¸éœ€è¦æ—¶å½’è¿˜ç»™å¯¹è±¡æ± è€Œéé”€æ¯å®ƒã€‚ è‹¥å¯¹è±¡åˆå§‹åŒ–ã€å®ä¾‹åŒ–çš„ä»£ä»·é«˜ï¼Œä¸”éœ€è¦ç»å¸¸å®ä¾‹åŒ–ï¼Œä½†æ¯æ¬¡å®ä¾‹åŒ–çš„æ•°é‡è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¯¹è±¡æ± å¯ä»¥è·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚å¸¸è§çš„ä½¿ç”¨å¯¹è±¡æ± æ¨¡å¼çš„æŠ€æœ¯åŒ…æ‹¬çº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€ä»»åŠ¡é˜Ÿåˆ—æ± ã€å›¾ç‰‡èµ„æºå¯¹è±¡æ± ç­‰ã€‚ å½“ç„¶ï¼Œå¦‚æœè¦å®ä¾‹åŒ–çš„å¯¹è±¡è¾ƒå°ï¼Œä¸éœ€è¦å¤šå°‘èµ„æºå¼€é”€ï¼Œå°±æ²¡æœ‰å¿…è¦ä½¿ç”¨å¯¹è±¡æ± æ¨¡å¼äº†ï¼Œè¿™éä½†ä¸ä¼šæå‡æ€§èƒ½ï¼Œåè€Œæµªè´¹å†…å­˜ç©ºé—´ï¼Œç”šè‡³é™ä½æ€§èƒ½ã€‚","text":"ç®€ä»‹ å¯¹è±¡æ± ï¼ˆä¹Ÿç§°ä¸ºèµ„æºæ± ï¼‰è¢«ç”¨æ¥ç®¡ç†å¯¹è±¡ç¼“å­˜ã€‚å¯¹è±¡æ± æ˜¯ä¸€ç»„å·²ç»åˆå§‹åŒ–è¿‡ä¸”å¯ä»¥ç›´æ¥ä½¿ç”¨çš„å¯¹è±¡é›†åˆï¼Œç”¨æˆ·åœ¨ä½¿ç”¨å¯¹è±¡æ—¶å¯ä»¥ä»å¯¹è±¡æ± ä¸­è·å–å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œæ“ä½œå¤„ç†ï¼Œå¹¶åœ¨ä¸éœ€è¦æ—¶å½’è¿˜ç»™å¯¹è±¡æ± è€Œéé”€æ¯å®ƒã€‚ è‹¥å¯¹è±¡åˆå§‹åŒ–ã€å®ä¾‹åŒ–çš„ä»£ä»·é«˜ï¼Œä¸”éœ€è¦ç»å¸¸å®ä¾‹åŒ–ï¼Œä½†æ¯æ¬¡å®ä¾‹åŒ–çš„æ•°é‡è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¯¹è±¡æ± å¯ä»¥è·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚å¸¸è§çš„ä½¿ç”¨å¯¹è±¡æ± æ¨¡å¼çš„æŠ€æœ¯åŒ…æ‹¬çº¿ç¨‹æ± ã€æ•°æ®åº“è¿æ¥æ± ã€ä»»åŠ¡é˜Ÿåˆ—æ± ã€å›¾ç‰‡èµ„æºå¯¹è±¡æ± ç­‰ã€‚ å½“ç„¶ï¼Œå¦‚æœè¦å®ä¾‹åŒ–çš„å¯¹è±¡è¾ƒå°ï¼Œä¸éœ€è¦å¤šå°‘èµ„æºå¼€é”€ï¼Œå°±æ²¡æœ‰å¿…è¦ä½¿ç”¨å¯¹è±¡æ± æ¨¡å¼äº†ï¼Œè¿™éä½†ä¸ä¼šæå‡æ€§èƒ½ï¼Œåè€Œæµªè´¹å†…å­˜ç©ºé—´ï¼Œç”šè‡³é™ä½æ€§èƒ½ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142class ObjectPool&#123; private $instances = []; public function get($key) &#123; if (isset($this-&gt;instances[ $key ])) &#123; return $this-&gt;instances[ $key ]; &#125; else &#123; $item = $this-&gt;make($key); $this-&gt;instances[ $key ] = $item; return $item; &#125; &#125; public function add($object, $key) &#123; $this-&gt;instances[ $key ] = $object; &#125; public function make($key) &#123; if ($key == 'mysql') &#123; return new Mysql(); &#125; elseif ($key == 'socket') &#123; return new Socket(); &#125; &#125;&#125;class ReusableObject&#123; public function doSomething() &#123; // ... &#125;&#125; è¯´æ˜ä¸Šé¢çš„ä¾‹å­å…¶å®åªæ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„ä¾‹å­ï¼Œå¯¹è±¡æ± çš„ç†å¿µè¿˜æœ‰å¾ˆå¤šçš„å‡çº§ç‰ˆæœ¬ï¼Œåƒå¯¹è±¡ä¸ªæ•°çš„æ§åˆ¶ï¼Œå°±æœ‰åŠ¨æ€æ‰©å±•å®¹å™¨å¯¹è±¡çš„åšæ³•ï¼Œä¹Ÿæœ‰é™æ€å›ºå®šçš„åšæ³•ï¼Œè¿˜æœ‰åˆå§‹åŒ–å’Œé™æ€å›ºå®šä¹‹é—´æµ®åŠ¨çš„åšæ³•ã€‚æ‰€æœ‰çš„çº¿ç¨‹æ± ä¹‹ç±»çš„æ¦‚å¿µï¼Œå…¶å®éƒ½æ˜¯è®¾è®¡æ¨¡å¼çš„å¯¹è±¡æ± çš„æ€æƒ³ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¾è®¡æ¨¡å¼ã®åˆ›å»ºå‹ã®å•ä¾‹æ¨¡å¼","slug":"design-single-model","date":"2017-06-20T02:22:00.000Z","updated":"2021-03-20T16:25:01.804Z","comments":true,"path":"2017/06/20/design-single-model/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/20/design-single-model/","excerpt":"ç®€ä»‹å¾ˆå®¹æ˜“ç†è§£ï¼Œä¹Ÿå¾ˆç®€å•ã€‚ æœ€å¸¸è§çš„åœºæ™¯å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“çš„é“¾æ¥ï¼Œæˆ‘ä»¬æ¯æ¬¡è¯·æ±‚åªéœ€è¦è¿æ¥ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ç”¨ç±»æ¥å†™çš„è¯ï¼Œåªéœ€è¦ç”¨ä¸€ä¸ªå®ä¾‹å°±å¤Ÿäº†ï¼ˆå¤šäº†æµªè´¹ï¼‰ã€‚","text":"ç®€ä»‹å¾ˆå®¹æ˜“ç†è§£ï¼Œä¹Ÿå¾ˆç®€å•ã€‚ æœ€å¸¸è§çš„åœºæ™¯å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“çš„é“¾æ¥ï¼Œæˆ‘ä»¬æ¯æ¬¡è¯·æ±‚åªéœ€è¦è¿æ¥ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ç”¨ç±»æ¥å†™çš„è¯ï¼Œåªéœ€è¦ç”¨ä¸€ä¸ªå®ä¾‹å°±å¤Ÿäº†ï¼ˆå¤šäº†æµªè´¹ï¼‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738&lt;?phpclass Mysql&#123; //è¯¥å±æ€§ç”¨æ¥ä¿å­˜å®ä¾‹ private static $conn; //æ„é€ å‡½æ•°ä¸ºprivate,é˜²æ­¢åˆ›å»ºå¯¹è±¡ private function __construct() &#123; self::$conn = mysqli_connect('localhost', 'root', ''); &#125; //åˆ›å»ºä¸€ä¸ªç”¨æ¥å®ä¾‹åŒ–å¯¹è±¡çš„æ–¹æ³•ï¼Œå¦‚æœä¸å­˜åœ¨ä¸€ä¸ªè¿™ä¸ªç±»çš„å®ä¾‹å±æ€§ï¼Œå°±åˆ›å»ºä¸€ä¸ªï¼Œå¦åˆ™å°±å–è¿™ä¸ªå®ä¾‹å±æ€§ã€‚ public static function getInstance() &#123; if (!(self::$conn instanceof self)) &#123; self::$conn = new self; &#125; return self::$conn; &#125; //é˜²æ­¢å¯¹è±¡è¢«å¤åˆ¶ public function __clone() &#123; trigger_error('Clone is not allowed !'); &#125; //é˜²æ­¢ååºåˆ—åŒ–ååˆ›å»ºå¯¹è±¡ private function __wakeup() &#123; trigger_error('Unserialized is not allowed !'); &#125;&#125;//åªèƒ½è¿™æ ·å–å¾—å®ä¾‹ï¼Œä¸èƒ½new å’Œ clone$mysql = Mysql::getInstance(); è¯´æ˜å•ä¾‹æ¨¡å¼å…¶å®åˆ†ä¸º 2 ç§ï¼ŒPHP ä¸­æœ€å¸¸ç”¨çš„æ˜¯æ‡’æ±‰æ¨¡å¼ï¼Œæ„è¯†å°±æ˜¯éœ€è¦åŠ è½½çš„æ—¶å€™æ‰å»å®ä¾‹åŒ–ï¼Œè¿˜æœ‰ä¸€ç§å°±æ˜¯å«é¥¿æ±‰æ¨¡å¼ï¼Œå°±æ˜¯ä¸€å¼€å§‹å°±å¼€å§‹å®ä¾‹åŒ–äº†ï¼Œä½†æ˜¯ç”±äº PHP ä¸æ”¯æŒåœ¨ç±»å®šä¹‰æ—¶ç»™ç±»çš„æˆå‘˜å˜é‡èµ‹äºˆéåŸºæœ¬ç±»å‹çš„å€¼ã€‚å¦‚è¡¨è¾¾å¼ï¼Œnew æ“ä½œç­‰ç­‰ï¼Œæ‰€ä»¥ PHP ä¸­å°±ä¸å­˜åœ¨é¥¿æ±‰æ¨¡å¼äº†ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼ï¼ŒPHP","slug":"è®¾è®¡æ¨¡å¼ï¼ŒPHP","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%8CPHP/"}]},{"title":"linuxã®ä¿®æ”¹è¯­è¨€åŒ…","slug":"linux-language-package","date":"2017-06-19T08:32:00.000Z","updated":"2021-03-20T16:25:01.808Z","comments":true,"path":"2017/06/19/linux-language-package/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/19/linux-language-package/","excerpt":"","text":"æ‰§è¡Œ locale -a å‘ç°å­˜åœ¨ä¸­æ–‡è¯­è¨€åŒ…ï¼Œè¯­è¨€åŒ…å­˜æ”¾è·¯å¾„åº”è¯¥æ˜¯ /usr/share/locale/ã€‚ æ‰§è¡Œ echo $LANG å‘ç°è¯­è¨€é…ç½®æ˜¯ Cï¼Œå¤§æ¦‚æ˜¯ ANSI C çš„æ„æ€ã€‚ ä¿®æ”¹ /etc/locale.conf ä¸º LANG=â€zh_CN.UTF-8â€ï¼Œå¹¶æ‰§è¡Œ source /etc/locale.conf ä½¿é…ç½®ç”Ÿæ•ˆã€‚ ç°åœ¨æ”¯æŒä¸­æ–‡äº†ï¼Œå¯æ˜¯æç¤ºè¯­ä¹Ÿå˜ä¸­æ–‡äº†ï¼Œæˆ‘æƒ³ä¿ç•™è‹±æ–‡ä½œä¸ºç³»ç»Ÿè¯­è¨€ï¼ŒåŒæ—¶æ”¯æŒä¸­æ–‡ï¼Œæ‰€ä»¥é‡æ–°ä¿®æ”¹ /etc/locale.conf LANG=â€en_US.UTF-8â€ï¼Œå¹¶æ‰§è¡Œ source","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"è¯­è¨€åŒ…","slug":"è¯­è¨€åŒ…","permalink":"http://blog.crazylaw.cn/tags/%E8%AF%AD%E8%A8%80%E5%8C%85/"}]},{"title":"linux ã®åŠ¨æ€åº“","slug":"ldconfig","date":"2017-06-19T06:24:00.000Z","updated":"2021-03-20T16:25:01.807Z","comments":true,"path":"2017/06/19/ldconfig/","link":"","permalink":"http://blog.crazylaw.cn/2017/06/19/ldconfig/","excerpt":"1. /lib å’Œ /usr/lib çš„åŒºåˆ«/lib é‡Œé¢ç»™çš„æ˜¯ root å’Œå†…æ ¸æ‰€éœ€so(åŠ¨æ€åº“)æˆ–è€…a(é™æ€)ä¹‹ç±»çš„åº“æ–‡ä»¶ï¼Œè€Œ/usr/lib æ˜¯æ™®é€šç”¨æˆ·èƒ½å¤Ÿä½¿ç”¨çš„ã€‚ Linux çš„ç¨‹åºæœ‰ä¸¤ç§æ¨¡å¼ï¼Œè¿™ä¸ªä½ åº”è¯¥çŸ¥é“ï¼Œæ˜¯ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ï¼Œå’Œè¿™ä¸ªä¹Ÿæ˜¯æœ‰å…³ç³»çš„ï¼Œä¸å†å†—è¿°ã€‚ ç®€å•è¯´,/lib æ˜¯å†…æ ¸çº§çš„,/usr/lib æ˜¯ç³»ç»Ÿçº§çš„,/usr/local/lib æ˜¯ç”¨æˆ·çº§çš„. /lib/ â€” åŒ…å«è®¸å¤šè¢« /bin/ å’Œ /sbin/ ä¸­çš„ç¨‹åºä½¿ç”¨çš„åº“æ–‡ä»¶ã€‚ç›®å½• /usr/lib/ ä¸­å«æœ‰æ›´å¤šç”¨äºç”¨æˆ·ç¨‹åºçš„åº“æ–‡ä»¶ã€‚/lib ç›®å½•ä¸‹æ”¾ç½®çš„æ˜¯/bin å’Œ/sbin ç›®å½•ä¸‹ç¨‹åºæ‰€éœ€çš„åº“æ–‡ä»¶ã€‚/lib ç›®å½•ä¸‹çš„æ–‡ä»¶çš„åç§°éµå¾ªä¸‹é¢çš„æ ¼å¼ï¼š 12libc.so.*ld*","text":"1. /lib å’Œ /usr/lib çš„åŒºåˆ«/lib é‡Œé¢ç»™çš„æ˜¯ root å’Œå†…æ ¸æ‰€éœ€so(åŠ¨æ€åº“)æˆ–è€…a(é™æ€)ä¹‹ç±»çš„åº“æ–‡ä»¶ï¼Œè€Œ/usr/lib æ˜¯æ™®é€šç”¨æˆ·èƒ½å¤Ÿä½¿ç”¨çš„ã€‚ Linux çš„ç¨‹åºæœ‰ä¸¤ç§æ¨¡å¼ï¼Œè¿™ä¸ªä½ åº”è¯¥çŸ¥é“ï¼Œæ˜¯ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ï¼Œå’Œè¿™ä¸ªä¹Ÿæ˜¯æœ‰å…³ç³»çš„ï¼Œä¸å†å†—è¿°ã€‚ ç®€å•è¯´,/lib æ˜¯å†…æ ¸çº§çš„,/usr/lib æ˜¯ç³»ç»Ÿçº§çš„,/usr/local/lib æ˜¯ç”¨æˆ·çº§çš„. /lib/ â€” åŒ…å«è®¸å¤šè¢« /bin/ å’Œ /sbin/ ä¸­çš„ç¨‹åºä½¿ç”¨çš„åº“æ–‡ä»¶ã€‚ç›®å½• /usr/lib/ ä¸­å«æœ‰æ›´å¤šç”¨äºç”¨æˆ·ç¨‹åºçš„åº“æ–‡ä»¶ã€‚/lib ç›®å½•ä¸‹æ”¾ç½®çš„æ˜¯/bin å’Œ/sbin ç›®å½•ä¸‹ç¨‹åºæ‰€éœ€çš„åº“æ–‡ä»¶ã€‚/lib ç›®å½•ä¸‹çš„æ–‡ä»¶çš„åç§°éµå¾ªä¸‹é¢çš„æ ¼å¼ï¼š 12libc.so.*ld* ä»…ä»…è¢«/usr ç›®å½•ä¸‹çš„ç¨‹åºæ‰€ä½¿ç”¨çš„å…±äº«åº“ä¸å¿…æ”¾åˆ°/lib ç›®å½•ä¸‹ã€‚åªæœ‰/bin å’Œ/sbin ä¸‹çš„ç¨‹åºæ‰€éœ€è¦çš„åº“æœ‰å¿…è¦æ”¾åˆ°/lib ç›®å½•ä¸‹ã€‚å®é™…ä¸Šï¼Œlibm.so.*ç±»å‹çš„åº“æ–‡ä»¶å¦‚æœè¢«æ˜¯/bin å’Œ/sbin æ‰€éœ€è¦çš„ï¼Œä¹Ÿå¯ä»¥æ”¾åˆ°/usr/lib ä¸‹ã€‚ /bin/ â€” ç”¨æ¥è´®å­˜ç”¨æˆ·å‘½ä»¤ã€‚ç›®å½• /usr/bin ä¹Ÿè¢«ç”¨æ¥è´®å­˜ç”¨æˆ·å‘½ä»¤ã€‚ /sbin/ â€” è®¸å¤šç³»ç»Ÿå‘½ä»¤ï¼ˆä¾‹å¦‚ shutdownï¼‰çš„è´®å­˜ä½ç½®ã€‚ç›®å½• /usr/sbin ä¸­ä¹ŸåŒ…æ‹¬äº†è®¸å¤šç³»ç»Ÿå‘½ä»¤ã€‚ /root/ â€” æ ¹ç”¨æˆ·ï¼ˆè¶…çº§ç”¨æˆ·ï¼‰çš„ä¸»ç›®å½•ã€‚ /mnt/ â€” è¯¥ç›®å½•ä¸­é€šå¸¸åŒ…æ‹¬ç³»ç»Ÿå¼•å¯¼åè¢«æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹ã€‚è­¬å¦‚ï¼Œé»˜è®¤çš„å…‰ç›˜æŒ‚è½½ç‚¹æ˜¯ /mnt/cdrom/. /boot/ â€” åŒ…æ‹¬å†…æ ¸å’Œå…¶å®ƒç³»ç»Ÿå¯åŠ¨æœŸé—´ä½¿ç”¨çš„æ–‡ä»¶ã€‚ /lost+found/ â€” è¢« fsck ç”¨æ¥æ”¾ç½®é›¶æ•£æ–‡ä»¶ï¼ˆæ²¡æœ‰åç§°çš„æ–‡ä»¶ï¼‰ã€‚ /lib/ â€” åŒ…å«è®¸å¤šè¢« /bin/ å’Œ /sbin/ ä¸­çš„ç¨‹åºä½¿ç”¨çš„åº“æ–‡ä»¶ã€‚ç›®å½• /usr/lib/ ä¸­å«æœ‰æ›´å¤šç”¨äºç”¨æˆ·ç¨‹åºçš„åº“æ–‡ä»¶ã€‚ /dev/ â€” è´®å­˜è®¾å¤‡æ–‡ä»¶ã€‚ /etc/ â€” åŒ…å«è®¸å¤šé…ç½®æ–‡ä»¶å’Œç›®å½•ã€‚ /var/ â€” ç”¨äºè´®å­˜ variableï¼ˆæˆ–ä¸æ–­æ”¹å˜çš„ï¼‰æ–‡ä»¶ï¼Œä¾‹å¦‚æ—¥å¿—æ–‡ä»¶å’Œæ‰“å°æœºå‡è„±æœºæ–‡ä»¶ã€‚ /usr/ â€” åŒ…æ‹¬ä¸ç³»ç»Ÿç”¨æˆ·ç›´æ¥æœ‰å…³çš„æ–‡ä»¶å’Œç›®å½•ï¼Œä¾‹å¦‚åº”ç”¨ç¨‹åºåŠæ”¯æŒå®ƒä»¬çš„åº“æ–‡ä»¶ã€‚ /proc/ â€” ä¸€ä¸ªè™šæ‹Ÿçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆä¸æ˜¯å®é™…è´®å­˜åœ¨ç£ç›˜ä¸Šçš„ï¼‰ï¼Œå®ƒåŒ…æ‹¬è¢«æŸäº›ç¨‹åºä½¿ç”¨çš„ç³»ç»Ÿä¿¡æ¯ã€‚ /initrd/ â€” ç”¨æ¥åœ¨è®¡ç®—æœºå¯åŠ¨æ—¶æŒ‚è½½ initrd.img æ˜ åƒæ–‡ä»¶çš„ç›®å½•ä»¥åŠè½½å…¥æ‰€éœ€è®¾å¤‡æ¨¡å—çš„ç›®å½•ã€‚ è­¦å‘Š ä¸è¦åˆ é™¤ /initrd/ ç›®å½•ã€‚å¦‚æœä½ åˆ é™¤äº†è¯¥ç›®å½•åå†é‡æ–°å¼•å¯¼ Red Hat Linux æ—¶ï¼Œä½ å°†æ— æ³•å¼•å¯¼ä½ çš„è®¡ç®—æœºã€‚ /tmp/ â€” ç”¨æˆ·å’Œç¨‹åºçš„ä¸´æ—¶ç›®å½•ã€‚ /tmp ç»™äºˆæ‰€æœ‰ç³»ç»Ÿç”¨æˆ·è¯»å†™æƒã€‚ /home/ â€” ç”¨æˆ·ä¸»ç›®å½•çš„é»˜è®¤ä½ç½®ã€‚ /opt/ â€” å¯é€‰æ–‡ä»¶å’Œç¨‹åºçš„è´®å­˜ç›®å½•ã€‚è¯¥ç›®å½•ä¸»è¦è¢«ç¬¬ä¸‰æ–¹å¼€å‘è€…ç”¨æ¥ç®€æ˜“åœ°å®‰è£…å’Œå¸è£…ä»–ä»¬çš„è½¯ä»¶åŒ…ã€‚ 2.ldconfig ldconfig æ˜¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ç®¡ç†å‘½ä»¤ï¼Œå…¶ç›®çš„ä¸ºäº†è®©åŠ¨æ€é“¾æ¥åº“ä¸ºç³»ç»Ÿæ‰€å…±äº«ã€‚ 2.1 ldconfig çš„ä¸»è¦ç”¨é€”ï¼šé»˜è®¤æœå¯»/lilb å’Œ/usr/libï¼Œä»¥åŠé…ç½®æ–‡ä»¶/etc/ld.so.conf å†…æ‰€åˆ—çš„ç›®å½•ä¸‹çš„åº“æ–‡ä»¶ã€‚ æœç´¢å‡ºå¯å…±äº«çš„åŠ¨æ€é“¾æ¥åº“ï¼Œåº“æ–‡ä»¶çš„æ ¼å¼ä¸ºï¼šlib*.so.ï¼Œè¿›è€Œåˆ›å»ºå‡ºåŠ¨æ€è£…å…¥ç¨‹åº(ld.so)æ‰€éœ€çš„è¿æ¥å’Œç¼“å­˜æ–‡ä»¶ã€‚ ç¼“å­˜æ–‡ä»¶é»˜è®¤ä¸º/etc/ld.so.cacheï¼Œè¯¥æ–‡ä»¶ä¿å­˜å·²æ’å¥½åºçš„åŠ¨æ€é“¾æ¥åº“åå­—åˆ—è¡¨ã€‚ ldconfig é€šå¸¸åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è¿è¡Œï¼Œè€Œå½“ç”¨æˆ·å®‰è£…äº†ä¸€ä¸ªæ–°çš„åŠ¨æ€é“¾æ¥åº“æ—¶ï¼Œå°±éœ€è¦æ‰‹å·¥è¿è¡Œè¿™ä¸ªå‘½ä»¤ã€‚ 2.2 ldconfig éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼šå¾€/lib å’Œ/usr/lib é‡Œé¢åŠ ä¸œè¥¿ï¼Œæ˜¯ä¸ç”¨ä¿®æ”¹/etc/ld.so.conf æ–‡ä»¶çš„ï¼Œä½†æ˜¯æ·»åŠ å®Œåéœ€è¦è°ƒç”¨ä¸‹ ldconfigï¼Œä¸ç„¶æ·»åŠ çš„ library ä¼šæ‰¾ä¸åˆ°ã€‚ å¦‚æœæ·»åŠ çš„ library ä¸åœ¨/lib å’Œ/usr/lib é‡Œé¢çš„è¯ï¼Œå°±ä¸€å®šè¦ä¿®æ”¹/etc/ld.so.conf æ–‡ä»¶ï¼Œå¾€è¯¥æ–‡ä»¶è¿½åŠ  library æ‰€åœ¨çš„è·¯å¾„ï¼Œç„¶åä¹Ÿéœ€è¦é‡æ–°è°ƒç”¨ä¸‹ ldconfig å‘½ä»¤ã€‚æ¯”å¦‚åœ¨å®‰è£… MySQL çš„æ—¶å€™ï¼Œå…¶åº“æ–‡ä»¶/usr/local/mysql/libï¼Œå°±éœ€è¦è¿½åŠ åˆ°/etc/ld.so.conf æ–‡ä»¶ä¸­ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š 123echo &quot;&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;lib&quot; &gt;&gt; &#x2F;etc&#x2F;ld.so.confldconfig -v | grep mysql å¦‚æœæ·»åŠ çš„ library ä¸åœ¨/lib æˆ–/usr/lib ä¸‹ï¼Œä½†æ˜¯å´æ²¡æœ‰æƒé™æ“ä½œå†™/etc/ld.so.conf æ–‡ä»¶çš„è¯ï¼Œè¿™æ—¶å°±éœ€è¦å¾€ export é‡Œå†™ä¸€ä¸ªå…¨å±€å˜é‡ LD_LIBRARY_PATHï¼Œå°±å¯ä»¥äº†ã€‚","categories":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"}]},{"title":"Asciiç å’Œå­—èŠ‚å­—ç¬¦çš„å…³ç³»","slug":"ascii-code-1","date":"2017-05-27T10:20:00.000Z","updated":"2021-03-20T16:25:01.801Z","comments":true,"path":"2017/05/27/ascii-code-1/","link":"","permalink":"http://blog.crazylaw.cn/2017/05/27/ascii-code-1/","excerpt":"","text":"##å…³äº Ascii ç çš„æ•´ç† 123456789101112131415- 0 &lt; ascii &lt; 128 å•å­—èŠ‚å­—ç¬¦ &#x3D;&#x3D; 1xxx xxxxå‘å³ç§»åŠ¨ 7 ä½ç­‰äº 0.ç¬¦åˆèŒƒå›´å†…- 240 &lt;&#x3D; ascii å››å­—èŠ‚å­—ç¬¦ &#x3D;&#x3D; 1111 xxxxå‘å³ç§»åŠ¨ 4 ä½&#x3D;15ï¼Œç¬¦åˆèŒƒå›´å†…- 224 &lt;&#x3D; ascii &lt; 240 3 å­—èŠ‚å­—ç¬¦ &#x3D;&#x3D; 111x xxxxå‘å³ç§»åŠ¨ 5 ä½&#x3D;7ï¼Œç¬¦åˆèŒƒå›´å†…- 192 &lt;&#x3D; ascii &lt; 224 2 å­—èŠ‚å­—ç¬¦ 11xx xxxxå‘å³ç§»åŠ¨ 6 ä½&#x3D;3ï¼Œç¬¦åˆèŒƒå›´å†…","categories":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"Ascii","slug":"Ascii","permalink":"http://blog.crazylaw.cn/tags/Ascii/"}]},{"title":"ip_to_long","slug":"ip-to-long","date":"2017-03-15T06:20:00.000Z","updated":"2021-03-20T16:25:01.806Z","comments":true,"path":"2017/03/15/ip-to-long/","link":"","permalink":"http://blog.crazylaw.cn/2017/03/15/ip-to-long/","excerpt":"å­—ç¬¦ä¸² ip è½¬é•¿æ•´å½¢åŸç†å’Œå®ç° php å†…ç½®æ–¹æ³•ï¼šip2long ä½†æ˜¯è¿™ä¸ªæ–¹æ³•å­˜åœ¨ bugï¼Œå°±æ˜¯ 010.0.3.198 çš„æ—¶å€™ï¼Œè®¡ç®—çš„é•¿æ•´å½¢å¹¶éæ­£ç¡®çš„é•¿æ•´å½¢ã€‚å¹¶ä¸”æŒæ¡å®ç°åŸç†ï¼Œå…¶å®å¹¶ä¸å›°éš¾ã€‚ åŸç†ï¼šIPv4 åœ°å€æˆ‘ä»¬çŸ¥é“çš„æ˜¯è¿™æ ·å­çš„å½¢å¼ï¼š 192.168.2.10 è¿™ç§å½¢å¼æˆ‘ä»¬ç§°ä¹‹ä¸º ç‚¹åˆ†åè¿›åˆ¶ï¼Œå½“ç„¶è¿˜æœ‰æˆ‘ä»¬çš„å†’åˆ†åå…­è¿›åˆ¶ï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯é€‚ç”¨äº IPv6 çš„ å›åˆ°ä¸»é¢˜ï¼Œç‚¹åˆ†åè¿›åˆ¶çš„å†™æ³•å…¶å®æ˜¯ä¸€ä¸ª 4 ä¸ªå­—èŠ‚ï¼Œ32 ä½çš„æ•´å‹ç»„æˆçš„ã€‚ ä¾‹å¦‚ : 10.0.3.198 äºŒè¿›åˆ¶å½¢å¼ ï¼š00001010.00000000.00000011.11000001 è¯´åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½éƒ½çŸ¥é“äº†ï¼Œä¸ºä»€ä¹ˆæ˜¯ 32 ä½äº†å§ã€‚é‚£ä¹ˆäºŒè¿›åˆ¶çš„ 32 ä½è½¬æˆåè¿›åˆ¶çš„æ—¶å€™ï¼Œå°±æ˜¯æˆ‘ä»¬çš„é•¿æ•´å½¢äº†ã€‚ è½¬æ¢ç»“æœä¸º ï¼š167773121","text":"å­—ç¬¦ä¸² ip è½¬é•¿æ•´å½¢åŸç†å’Œå®ç° php å†…ç½®æ–¹æ³•ï¼šip2long ä½†æ˜¯è¿™ä¸ªæ–¹æ³•å­˜åœ¨ bugï¼Œå°±æ˜¯ 010.0.3.198 çš„æ—¶å€™ï¼Œè®¡ç®—çš„é•¿æ•´å½¢å¹¶éæ­£ç¡®çš„é•¿æ•´å½¢ã€‚å¹¶ä¸”æŒæ¡å®ç°åŸç†ï¼Œå…¶å®å¹¶ä¸å›°éš¾ã€‚ åŸç†ï¼šIPv4 åœ°å€æˆ‘ä»¬çŸ¥é“çš„æ˜¯è¿™æ ·å­çš„å½¢å¼ï¼š 192.168.2.10 è¿™ç§å½¢å¼æˆ‘ä»¬ç§°ä¹‹ä¸º ç‚¹åˆ†åè¿›åˆ¶ï¼Œå½“ç„¶è¿˜æœ‰æˆ‘ä»¬çš„å†’åˆ†åå…­è¿›åˆ¶ï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯é€‚ç”¨äº IPv6 çš„ å›åˆ°ä¸»é¢˜ï¼Œç‚¹åˆ†åè¿›åˆ¶çš„å†™æ³•å…¶å®æ˜¯ä¸€ä¸ª 4 ä¸ªå­—èŠ‚ï¼Œ32 ä½çš„æ•´å‹ç»„æˆçš„ã€‚ ä¾‹å¦‚ : 10.0.3.198 äºŒè¿›åˆ¶å½¢å¼ ï¼š00001010.00000000.00000011.11000001 è¯´åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½éƒ½çŸ¥é“äº†ï¼Œä¸ºä»€ä¹ˆæ˜¯ 32 ä½äº†å§ã€‚é‚£ä¹ˆäºŒè¿›åˆ¶çš„ 32 ä½è½¬æˆåè¿›åˆ¶çš„æ—¶å€™ï¼Œå°±æ˜¯æˆ‘ä»¬çš„é•¿æ•´å½¢äº†ã€‚ è½¬æ¢ç»“æœä¸º ï¼š167773121 é‚£ä¹ˆæ€ä¹ˆè½¬æ¢å‘¢ï¼Ÿï¼Ÿï¼Ÿ ip è½¬æˆé•¿æ•´å½¢1234567// ipè½¬æˆé•¿æ•´å½¢public function ipToLong(string $ip)&#123; list($position1, $position2, $position3, $position4) = explode('.', $ip); return ($position1 &lt;&lt; 24) | ($position2 &lt;&lt; 16) | ($position3 &lt;&lt; 8) | ($position4);&#125; å¯èƒ½çœ‹åˆ°è¿™é‡Œï¼Œä½ ä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œé¢ä¼šè®¾è®¡ä½è¿ç®—å’Œé€»è¾‘è¿è¡Œå‘¢ã€‚ å¦‚æœè¿˜ä¸ç†è§£ä¸ºä»€ä¹ˆæ¶‰åŠäº†ä½è¿ç®—çš„è¯ï¼Œé‚£è¯´æ˜ä¸Šé¢çš„ 32 ä½çš„ 10 è¿›åˆ¶çš„æ¦‚å¿µè¿˜ä¸ç†è§£ã€‚ ç¬¬ä¸€æ®µå¦‚æœè¦æŒ‰æ»¡ 32 ä½çš„è¯ï¼Œé‚£ä¹ˆä»–è¿˜éœ€è¦å¡«è¡¥ 24 ä½ï¼Œå°±æ˜¯ 24 ä¸ª 0 åœ¨å³è¾¹ã€‚ç¬¬äºŒæ®µå¦‚æœè¦æŒ‰æ»¡ 32 ä½çš„è¯ï¼Œé‚£ä¹ˆä»–è¿˜éœ€è¦å¡«è¡¥ 24 ä½ï¼Œåˆ†åˆ«æ˜¯å·¦è¾¹ 8 ä½ï¼Œå³è¾¹ 16 ä½ã€‚å°±æ˜¯å·¦è¾¹ 8 ä¸ª 0ï¼Œå³è¾¹ 16 ä¸ª 0ã€‚ç¬¬ä¸‰æ®µå¦‚æœè¦æŒ‰æ»¡ 32 ä½çš„è¯ï¼Œé‚£ä¹ˆä»–è¿˜éœ€è¦å¡«è¡¥ 24 ä½ï¼Œåˆ†åˆ«æ˜¯å·¦è¾¹ 16 ä½ï¼Œå³è¾¹ 8 ä½ã€‚å°±æ˜¯å·¦è¾¹ 16 ä¸ª 0ï¼Œå³è¾¹ 8 ä¸ª 0ã€‚ç¬¬å››æ®µå¦‚æœè¦æŒ‰æ»¡ 32 ä½çš„è¯ï¼Œé‚£ä¹ˆä»–è¿˜éœ€è¦å¡«è¡¥ 24 ä½ï¼Œå°±æ˜¯ 24 ä¸ª 0 åœ¨å·¦è¾¹ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆæ˜¯é€»è¾‘è¿ç®—å‘¢ï¼Œå…¶å®è¿™é‡Œçš„è¯é€»è¾‘è¿è¡Œå¯ä»¥æé«˜äºŒè¿›åˆ¶çš„è®¡ç®—é€Ÿåº¦ï¼Œåœ¨è¿™é‡Œå¤§å®¶æ›´å€¾å‘äºé€»è¾‘è¿è¡Œçš„åŠ æ³•æ³•åˆ™ã€‚æ‰€ä»¥è¿™é‡Œä½ ç”¨+å·çš„è¯ï¼Œæ‹¬å·é‡Œé¢çš„å€¼ä¼šç”± 2 è¿›åˆ¶å…ˆè½¬æ¢ç¨‹ 10 è¿›åˆ¶ï¼Œå†è¿›è¡Œç›¸åŠ ï¼Œå¤šäº†ä¸€æ­¥ç¹ççš„æ­¥éª¤ï¼Œæ‰€ä»¥å¤§å®¶æ›´å€¾å‘äºé€»è¾‘æˆ–çš„è¿ç®—ã€‚ é•¿æ•´å½¢è½¬ ip123456789101112131415161718// æ•´å‹è½¬ip,ä¸‰ç§æ–¹å¼ï¼Œéƒ½å¯ä»¥ï¼Œæˆ‘å–œæ¬¢æ²¡æ³¨é‡Šçš„é‚£ç§function LongToIp(int $long)&#123;// return long2ip($long); $ret = []; for ($i = 3; $i &gt;= 0; $i--) &#123; $ret[] = ($long &gt;&gt; $i * 8) &amp; 0xff; &#125;// $ret[] = (($long &amp; 0xffffffff) &gt;&gt; 24);// $ret[] = (($long &amp; 0xffffff) &gt;&gt; 16);// $ret[] = (($long &amp; 0xffff) &gt;&gt; 8);// $ret[] = (($long &amp; 0xff) &gt;&gt; 0); return join('.', $ret);&#125; è®²åˆ°è¿™é‡Œ,è½¬æ¢çš„åŸç†å°±æ˜¯è¿™æ ·å­çš„äº†ï¼Œä½†æ˜¯æ·±å…¥çš„ç†è§£ï¼Œå¯èƒ½è¿˜è¦æ¶‰åŠåˆ°ç½‘ç»œ ip çš„çŸ¥è¯†ï¼Œå°±æ˜¯ 256 è¿›åˆ¶åœ¨ ip ä¸­çš„è¿ä½œã€‚","categories":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/"},{"name":"ç½‘ç»œ","slug":"åè®®/ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C/"},{"name":"ç®—æ³•","slug":"åè®®/ç½‘ç»œ/ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C/%E7%AE%97%E6%B3%95/"}],"tags":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/tags/%E7%BD%91%E7%BB%9C/"},{"name":"IP","slug":"IP","permalink":"http://blog.crazylaw.cn/tags/IP/"}]},{"title":"æ¨¡æ‹Ÿä»1äº¿ä¸ªipä¸­è®¿é—®æ¬¡æ•°æœ€å¤šçš„IP--PHP","slug":"most-duplicated-ip-from-100-million","date":"2017-03-15T06:03:38.000Z","updated":"2021-03-20T16:25:01.810Z","comments":true,"path":"2017/03/15/most-duplicated-ip-from-100-million/","link":"","permalink":"http://blog.crazylaw.cn/2017/03/15/most-duplicated-ip-from-100-million/","excerpt":"å‰æï¼š å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ å†…å­˜æœ‰é™ï¼Œæ—¶é—´æ— é™ã€‚ æ€è·¯ï¼š é‡‡ç”¨ç±»ä¼¼åˆ†è¡¨çš„åŠæ³•ï¼Œå°†æ–‡ä»¶æ‹†åˆ†åˆ°å„ä¸ªæ–‡ä»¶ä¸­å†åšç»Ÿè®¡è¿ç®—ï¼Œæé«˜æ£€ç´¢é€Ÿåº¦ï¼Œåˆ†æ•£å†…å­˜å‹åŠ› æ¶‰åŠåˆ° ip çš„ï¼Œé¦–å…ˆè¦è€ƒè™‘çš„å°±æ˜¯å°† ip è½¬ç¨‹é•¿æ•´å½¢ï¼Œç†ç”±æ˜¯æ•´å‹çœå†…å­˜ï¼Œå¹¶ä¸”æ”¯æŒä¸€èˆ¬éƒ½æ”¯æŒæ•´å½¢ç´¢å¼•ï¼Œæ¯”å­—ç¬¦ä¸²ç´¢å¼•é€Ÿåº¦å¿« æ•°ç»„å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼Œé‡‡ç”¨å†—ä½™çš„ç­–ç•¥ï¼Œè®°å½•ä¸€ç»„æ•°ç»„ä¸­é‡å¤æœ€å¤šçš„ ip å’Œæ•°æ® ç‹¬ç«‹å°æ–‡ä»¶èƒœå‡ºçš„ï¼Œå†å’Œåˆ†å‡ºæ¥çš„å…¶ä»–çš„ N-1 ä¸ªå°æ–‡ä»¶èƒœå‡ºçš„æ¯”è¾ƒ","text":"å‰æï¼š å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ å†…å­˜æœ‰é™ï¼Œæ—¶é—´æ— é™ã€‚ æ€è·¯ï¼š é‡‡ç”¨ç±»ä¼¼åˆ†è¡¨çš„åŠæ³•ï¼Œå°†æ–‡ä»¶æ‹†åˆ†åˆ°å„ä¸ªæ–‡ä»¶ä¸­å†åšç»Ÿè®¡è¿ç®—ï¼Œæé«˜æ£€ç´¢é€Ÿåº¦ï¼Œåˆ†æ•£å†…å­˜å‹åŠ› æ¶‰åŠåˆ° ip çš„ï¼Œé¦–å…ˆè¦è€ƒè™‘çš„å°±æ˜¯å°† ip è½¬ç¨‹é•¿æ•´å½¢ï¼Œç†ç”±æ˜¯æ•´å‹çœå†…å­˜ï¼Œå¹¶ä¸”æ”¯æŒä¸€èˆ¬éƒ½æ”¯æŒæ•´å½¢ç´¢å¼•ï¼Œæ¯”å­—ç¬¦ä¸²ç´¢å¼•é€Ÿåº¦å¿« æ•°ç»„å­˜å‚¨çš„æ•°æ®ç»“æ„ï¼Œé‡‡ç”¨å†—ä½™çš„ç­–ç•¥ï¼Œè®°å½•ä¸€ç»„æ•°ç»„ä¸­é‡å¤æœ€å¤šçš„ ip å’Œæ•°æ® ç‹¬ç«‹å°æ–‡ä»¶èƒœå‡ºçš„ï¼Œå†å’Œåˆ†å‡ºæ¥çš„å…¶ä»–çš„ N-1 ä¸ªå°æ–‡ä»¶èƒœå‡ºçš„æ¯”è¾ƒ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182&lt;?php/** * æ¨¡æ‹Ÿä»1äº¿ä¸ªipä¸­è®¿é—®æ¬¡æ•°æœ€å¤šçš„IP * åˆ›å»ºæ–‡ä»¶ * Created by PhpStorm. * User: admin * Date: 2017/3/14 * Time: 16:19 */class Test&#123; const MAX_NUM = 100000000; const HASH_NUM = 1000; const FILE_NAME = 'IpFile.txt'; public static $hashIps = []; public static function generateIp() &#123; // å¤§æ¦‚15ä¸ªå­—èŠ‚byte $number = '192.168'; $number = $number . '.' . random_int(0, 255) . '.' . random_int(0, 255); return $number; &#125; public static function generateIpFiles() &#123; /** * fopen çš„modeï¼Œå¦‚æœåŠ ä¸Šbï¼Œä¾‹å¦‚wbçš„è¯ï¼Œæ˜¯è¯´æ˜å¼ºè°ƒè¯´æ˜è¿™ä¸ªæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ * å¦‚æœ1äº¿æ¬¡çš„è¯ï¼Œé‚£å°±æ˜¯15byte*1E = 15E byte /1024 * ç”±äºæœºå™¨æ€§èƒ½æ¯”è¾ƒå·®ï¼Œæ–‡ä»¶æˆ‘åªç”Ÿæˆäº†700Mçš„æ•°æ®ã€‚å¯èƒ½åªæœ‰5åƒä¸‡æ¡æ•°æ® */ $handler = fopen(self::FILE_NAME, 'w'); for ($i = 0; $i &lt; self::MAX_NUM; $i++) &#123; $ip = self::generateIp(); fwrite($handler, $ip . PHP_EOL); &#125; fclose($handler); &#125; /** * ipè½¬æˆé•¿æ•´å½¢ * * @param string $ip * * @return int */ public static function ipToLong(string $ip) &#123; list($position1, $position2, $position3, $position4) = explode('.', $ip); return ($position1 &lt;&lt; 24) | ($position2 &lt;&lt; 16) | ($position3 &lt;&lt; 8) | ($position4); &#125; /** * å“ˆå¸Œå–æ¨¡ * * @param string $ip * * @return int */ public static function hash(string $ip) &#123; $longInt = self::ipToLong($ip); return $longInt % self::HASH_NUM; &#125; /** * æ‹†åˆ†æ–‡ä»¶ * è€ƒè™‘ï¼š * 1.1Eè¡Œæ•°æ®ï¼Œä¸€æ¬¡æ€§åŠ è½½æ–‡ä»¶è¿™æ˜¯ä¸æ˜æ™ºçš„åšæ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€è¡Œä¸€è¡Œæ¥è¯»å–ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºç¼“å­˜è¯»å–ã€‚ * 2.å‡å¦‚1Eä¸ªipï¼Œæˆ‘ä»¬ç›´æ¥ä¸€è¡Œè¡Œè¯»å†™æ“ä½œçš„è¯ï¼Œéœ€è¦æ“ä½œçš„ioå°±æ˜¯1Eæ¬¡ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜¯ååˆ†ä¸æ˜æ™ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªèº«æœåŠ¡å™¨çš„å†…å­˜æ¯”ä¾‹æ¥è¿›è¡Œåˆ’åˆ†å‡ºé¢„å®šçš„æ•°ç»„æ¥ä¿å­˜ */ public static function divideIpsFiles() &#123; $handler = fopen(self::FILE_NAME, 'r'); $count = 0; while (($ip = fgets($handler)) !== false) &#123; $count++; $hashIp = self::hash($ip); self::$hashIps[ $hashIp ][] = $ip; // å½“å¤„ç†äº†50000ä¸‡æ¡æ•°æ®çš„æ—¶å€™ï¼Œå°±å†™å…¥ä¸€æ¬¡æ€§å†™å…¥æ–‡ä»¶ã€‚ if ($count == 50000) &#123; foreach (self::$hashIps as $key =&gt; $hip) &#123; $handler2 = fopen($key . '.txt', 'a'); while (($ip = current($hip)) !== false) &#123; $byte = fwrite($handler2, $ip); if ($byte === false) &#123; die('Shutdown'); &#125; next($hip); &#125; fclose($handler2); &#125; $count = 0; self::$hashIps = []; &#125; &#125; fclose($handler); &#125; public static function calus() &#123; $last = []; for ($i = 0; $i &lt; 1000; $i++) &#123; $first = [ 'item' =&gt; [], 'max' =&gt; ['ip' =&gt; 0, 'count' =&gt; 0] ]; $handler = fopen($i . '.txt', 'r'); while (($ip = fgets($handler)) !== false) &#123; if (array_key_exists($ip, $first['item'])) &#123; $first['item'][ $ip ]++; &#125; else &#123; $first['item'][ $ip ] = 1; &#125; if ($first['item'][ $ip ] &gt; $first['max']['count']) &#123; $first['max']['ip'] = $ip; $first['max']['count'] = $first['item'][ $ip ]; &#125; &#125; fclose($handler); $last[ $first['max']['ip'] ] = $first['max']['count']; unset($first); &#125; echo 'IPæœ€å¤šé‡å¤çš„æ˜¯ï¼š' . array_search(($count = max($last)), $last) . ',é‡å¤æ¬¡æ•°ä¸º:' . $count; &#125; /** * ç§»é™¤æ–‡ä»¶ */ public static function deleteFiles() &#123; for ($i = 0; $i &lt; 1000; $i++) &#123; if (file_exists($i . '.txt')) &#123; unlink($i . '.txt'); &#125; else &#123; return false; &#125; &#125; echo 'ç§»é™¤å®Œæ¯•' . PHP_EOL; return true; &#125;&#125;if (!file_exists(Test::FILE_NAME))&#123; Test::generateIpFiles();&#125;////Test::deleteFiles();////Test::divideIpsFiles();Test::calus();","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"}]},{"title":"Cè¯­è¨€æ•°æ®ç»“æ„ã®AVLæ ‘","slug":"æ•°æ®ç»“æ„/struct-study-6","date":"2017-02-20T03:03:43.000Z","updated":"2021-03-20T16:25:01.818Z","comments":true,"path":"2017/02/20/æ•°æ®ç»“æ„/struct-study-6/","link":"","permalink":"http://blog.crazylaw.cn/2017/02/20/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/struct-study-6/","excerpt":"","text":"å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210#ifndef _INCLUDE_BASE#define _INCLUDE_BASE#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define true 1#define false 0#endiftypedef int avl_elementType;typedef struct avl&#123; avl_elementType data; struct avl *left; // å·¦èŠ‚ç‚¹ struct avl *right; // å³èŠ‚ç‚¹ avl_elementType hight; // ä»¥æ­¤ä¸ºæ ¹çš„é«˜åº¦&#125;AVL,*PAVL;// ================================================================ void RotateWithDoubleRight(PAVL *avl); // RR æ—‹è½¬å¹³è¡¡ç®—æ³• void RotateWithDoubleLeft(PAVL *avl); // LLæ—‹è½¬å¹³è¡¡ç®—æ³• void RotateWithLeftRight(PAVL *avl); // LRæ—‹è½¬å¹³è¡¡ç®—æ³• void RotateWithRightLeft(PAVL *avl); // RLæ—‹è½¬å¹³è¡¡ç®—æ³• void InsertNode(PAVL *avl,int data); // AVLæ’å…¥ç®—æ³• int NodeHigh(PAVL avl); // æŸ¥è¯¢å½“å‰æ ‘èŠ‚ç‚¹çš„é«˜åº¦ int compareHigh(PAVL a,PAVL b); // å¯¹æ¯”é«˜åº¦ï¼Œå–æœ€å¤§å€¼ void LeftBalance(PAVL *avl); // å·¦å¹³è¡¡ç®—æ³• void RightBalance(PAVL *avl); // å³å¹³è¡¡ç®—æ³• void print_inorder(PAVL avl); // ä¸­åºæ’åˆ—æ‰“å° void print_preorder(PAVL avl); // å‰åºæ’åˆ—æ‰“å° void print_houorder(PAVL avl); // ååºæ’åˆ—æ‰“å° void print_inhight(PAVL avl); // èŠ‚ç‚¹çš„é«˜åº¦// =================================================================// main funcvoid main()&#123; PAVL root = (PAVL)malloc(sizeof(PAVL));// root-&gt;data = 3;// InsertNode(&amp;root,2); InsertNode(&amp;root,2); InsertNode(&amp;root,1); InsertNode(&amp;root,-1);// InsertNode(&amp;root,0); InsertNode(&amp;root,6); InsertNode(&amp;root,7); InsertNode(&amp;root,5); printf(\"ä¸­åºæ’åˆ—èŠ‚ç‚¹çš„é«˜åº¦ï¼š\"); print_inhight(root); printf(\"\\n\"); printf(\"ä¸­åºæ’åˆ—ï¼š\"); print_inorder(root); printf(\"\\n\"); printf(\"å‰åºæ’åˆ—ï¼š\"); print_preorder(root);&#125;void InsertNode(PAVL *avl,int data)&#123; if(!(*avl)) &#123; PAVL node = (PAVL)malloc(sizeof(PAVL)); node-&gt;data = data; node-&gt;hight = 0; *avl = node; return ; &#125; if(data &gt; (*avl)-&gt;data) &#123; InsertNode(&amp;((*avl)-&gt;right),data); //åˆ¤æ–­æ˜¯å¦ç ´åAVLæ ‘çš„å¹³è¡¡æ€§ if (NodeHeight((*avl)-&gt;right)-NodeHeight((*avl)-&gt;left)==2) RightBalance(avl); //å³å¹³è¡¡å¤„ç† &#125;else&#123; InsertNode(&amp;((*avl)-&gt;left),data); //åˆ¤æ–­æ˜¯å¦ç ´åAVLæ ‘çš„å¹³è¡¡æ€§ printf(\"ç›¸å‡ä¸º:%d\",NodeHeight((*avl)-&gt;left)-NodeHeight((*avl)-&gt;right)); if (NodeHeight((*avl)-&gt;left)-NodeHeight((*avl)-&gt;right)==2) LeftBalance(avl); //å·¦å¹³è¡¡å¤„ç† &#125; (*avl)-&gt;hight = compareHigh((*avl)-&gt;left,(*avl)-&gt;right) + 1 ; printf(\"å½“å‰èŠ‚ç‚¹:%d , é«˜åº¦:%d , left-é«˜åº¦:%d,right-é«˜åº¦:%d \\n\",(*avl)-&gt;data,(*avl)-&gt;hight,NodeHeight((*avl)-&gt;left),NodeHeight((*avl)-&gt;right));&#125;// ç©ºèŠ‚ç‚¹ä¸º-1ï¼Œå¦åˆ™è¿”å›æ ‘èŠ‚ç‚¹é«˜åº¦int NodeHeight(PAVL avl)&#123; return avl == NULL ? -1 : avl-&gt;hight;&#125;int compareHigh(PAVL a,PAVL b)&#123; if(!a || !b) return 0; return a-&gt;hight &gt; b-&gt;hight ? a-&gt;hight : b-&gt;hight;&#125;// å·¦å¹³è¡¡å¤„ç†void LeftBalance(PAVL *avl)&#123; if(NodeHeight((*avl)-&gt;left-&gt;left) - NodeHeight((*avl)-&gt;left-&gt;right) != -1) &#123; RotateWithDoubleLeft(avl); &#125;else &#123; RotateWithLeftRight(avl); &#125;&#125;// å³å¹³è¡¡å¤„ç†void RightBalance(PAVL *avl)&#123; if(NodeHeight((*avl)-&gt;right-&gt;right) - NodeHeight((*avl)-&gt;right-&gt;left) != -1) &#123; RotateWithDoubleRight(avl); &#125;else &#123; RotateWithRightLeft(avl); &#125;&#125;// LLæ—‹è½¬ç®—æ³•void RotateWithDoubleLeft(PAVL *avl)&#123; PAVL p = *avl; PAVL q = p-&gt;left; p-&gt;left = q-&gt;right; q-&gt;right = p; p-&gt;hight = compareHigh(p-&gt;left,p-&gt;right) +1 ; q-&gt;hight = compareHigh(q-&gt;left,q-&gt;right) +1 ; *avl = q;&#125;// RRæ—‹è½¬ç®—æ³•void RotateWithDoubleRight(PAVL *avl)&#123; PAVL p = *avl; PAVL q = p-&gt;right; p-&gt;right = q-&gt;left; q-&gt;left = p; p-&gt;hight = compareHigh(p-&gt;left,p-&gt;right) +1 ; q-&gt;hight = compareHigh(q-&gt;left,q-&gt;right) +1 ; *avl = q;&#125;// LRæ—‹è½¬ç®—æ³•void RotateWithLeftRight(PAVL *avl)&#123; printf(\"\\nLR\\n\"); RotateWithDoubleRight(&amp;((*avl)-&gt;left)); RotateWithDoubleLeft(avl);&#125;// RLæ—‹è½¬ç®—æ³•void RotateWithRightLeft(PAVL *avl)&#123; printf(\"\\nRL\\n\"); RotateWithDoubleLeft(&amp;((*avl)-&gt;right)); RotateWithDoubleRight(avl);&#125;void print_inorder(PAVL avl)&#123; if(avl) &#123; print_inorder(avl-&gt;left); printf(\"%d - \",avl-&gt;data); print_inorder(avl-&gt;right); &#125;&#125;void print_inhight(PAVL avl)&#123; if(avl) &#123; print_inhight(avl-&gt;left); printf(\"%d - \",avl-&gt;hight); print_inhight(avl-&gt;right); &#125;&#125;void print_preorder(PAVL avl)&#123; if(avl) &#123; printf(\"%d - \",avl-&gt;data); print_preorder(avl-&gt;left); print_preorder(avl-&gt;right); &#125;&#125;void print_houorder(PAVL avl)&#123; if(avl) &#123; print_houorder(avl-&gt;left); print_houorder(avl-&gt;right); printf(\"%d - \",avl-&gt;data); &#125;&#125;","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"BSTæ ‘","slug":"BSTæ ‘","permalink":"http://blog.crazylaw.cn/tags/BST%E6%A0%91/"}]},{"title":"Cè¯­è¨€æ•°æ®ç»“æ„ã®BSTæ ‘(å†™æ³•äºŒ:æŒ‡é’ˆå¼•ç”¨ï¼Œé€’å½’)","slug":"æ•°æ®ç»“æ„/struct-study-5","date":"2017-02-15T10:01:00.000Z","updated":"2021-03-20T16:25:01.818Z","comments":true,"path":"2017/02/15/æ•°æ®ç»“æ„/struct-study-5/","link":"","permalink":"http://blog.crazylaw.cn/2017/02/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/struct-study-5/","excerpt":"","text":"å®ç°12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define true 1#define false 0typedef int elementType;typedef struct bst&#123; elementType data; // æ•°æ®åŸŸ struct bst *left; // å·¦æŒ‡é’ˆ struct bst *right; // å³æŒ‡é’ˆ&#125;BST,*PBST;PBST create_bst(int root_data); // create include the root node treeint insert_node(PBST *bst,int data); // insert into bstvoid print_inorder(PBST tree); void main()&#123; int in; printf(\"è¯·è¾“å…¥æ ¹èŠ‚ç‚¹çš„å€¼\"); scanf(\"%d\",&amp;in); PBST bst = create_bst(in); insert_node(&amp;bst,2); insert_node(&amp;bst,3); insert_node(&amp;bst,4); insert_node(&amp;bst,5); insert_node(&amp;bst,6);// printf(\"\\n%d\",bst-&gt;right == NULL);// printf(\"\\n%d\",bst-&gt;left-&gt;data); print_inorder(bst);&#125;PBST create_bst(int root_data)&#123; // ç”³è¯·å†…å­˜ï¼Œå¹¶ä¸”è¿”å›åœ°å€ PBST bst = (PBST)malloc(sizeof(PBST)); if(bst == NULL) &#123; printf(\"malloc apply fail\"); exit(-1); &#125; bst-&gt;data = root_data; // é»˜è®¤ä¸º0 bst-&gt;left = NULL; // é˜²æ­¢å‡ºç°é‡æŒ‡é’ˆ bst-&gt;right = NULL; // é˜²æ­¢å‡ºç°é‡æŒ‡é’ˆ return bst;&#125;void create_node(PBST child,int data)&#123; child = (PBST)malloc(sizeof(PBST)); child-&gt;data = data; child-&gt;left = child-&gt;right = NULL;&#125;// ä¸­åºæ’åˆ—ï¼ˆé€’å¢æ’åˆ—ï¼‰int insert_node(PBST *bst,int data)&#123; if(!(*bst)) &#123; PBST temp = (PBST)malloc(sizeof(PBST)); temp-&gt;left = temp-&gt;right = NULL; temp-&gt;data = data; *bst = temp; return ; &#125; if (data &lt; (*bst)-&gt;data) &#123; insert_node(&amp;((*bst)-&gt;left),data); &#125;else if (data &gt; (*bst)-&gt;data) &#123; insert_node(&amp;((*bst)-&gt;right),data); &#125;&#125;void print_inorder(PBST tree) &#123; if(tree) &#123; print_inorder(tree-&gt;left); printf(\"%d\\n\",tree-&gt;data); print_inorder(tree-&gt;right); &#125;&#125;","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"BSTæ ‘","slug":"BSTæ ‘","permalink":"http://blog.crazylaw.cn/tags/BST%E6%A0%91/"}]},{"title":"Cè¯­è¨€æ•°æ®ç»“æ„ã®BSTæ ‘(å†™æ³•ä¸€:éæŒ‡é’ˆå¼•ç”¨ï¼Œéé€’å½’)","slug":"æ•°æ®ç»“æ„/struct-study-4","date":"2017-02-15T10:00:00.000Z","updated":"2021-03-20T16:25:01.818Z","comments":true,"path":"2017/02/15/æ•°æ®ç»“æ„/struct-study-4/","link":"","permalink":"http://blog.crazylaw.cn/2017/02/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/struct-study-4/","excerpt":"","text":"å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#define true 1#define false 0typedef int elementType;typedef struct bst&#123; elementType data; // æ•°æ®åŸŸ struct bst *left; // å·¦æŒ‡é’ˆ struct bst *right; // å³æŒ‡é’ˆ&#125;BST,*PBST;PBST create_bst(int root_data); // create include the root node treeint insert_node(PBST bst,int data); // insert into bstPBST create_node(PBST child,int data);void print_inorder(PBST tree);void main()&#123; int in; printf(\"è¯·è¾“å…¥æ ¹èŠ‚ç‚¹çš„å€¼\"); scanf(\"%d\",&amp;in); PBST bst = create_bst(in); insert_node(bst,2);// insert_node(bst,3); insert_node(bst,4); insert_node(bst,1);// insert_node(bst,6);// printf(\"\\n%d\",bst-&gt;right == NULL);// printf(\"\\n%d\",bst-&gt;left-&gt;data); print_inorder(bst);&#125;PBST create_bst(int root_data)&#123; // ç”³è¯·å†…å­˜ï¼Œå¹¶ä¸”è¿”å›åœ°å€ PBST bst = (PBST)malloc(sizeof(PBST)); if(bst == NULL) &#123; printf(\"malloc apply fail\"); exit(-1); &#125; bst-&gt;data = root_data; // é»˜è®¤ä¸º0 bst-&gt;left = NULL; // é˜²æ­¢å‡ºç°é‡æŒ‡é’ˆ bst-&gt;right = NULL; // é˜²æ­¢å‡ºç°é‡æŒ‡é’ˆ return bst;&#125;PBST create_node(PBST child,int data)&#123; child = (PBST)malloc(sizeof(PBST)); if(child==NULL) &#123; printf(\"malloc apply fail - child\"); exit(-1); &#125; child-&gt;data = data; child-&gt;left = child-&gt;right = NULL; return child;&#125;// ä¸­åºæ’åˆ—ï¼ˆé€’å¢æ’åˆ—ï¼‰int insert_node(PBST bst,int data)&#123; PBST current_node = bst; if(current_node-&gt;data &gt; data) &#123; while(true)&#123; if(current_node-&gt;left !=NULL) &#123; current_node = current_node-&gt;left; &#125;else &#123; PBST child = (PBST)malloc(sizeof(PBST)); child = create_node(child,data); printf(\"\\nchild data : %d \\n\",child-&gt;data); current_node-&gt;left = child; break; &#125; &#125; &#125;else&#123; while(true)&#123; if(current_node-&gt;right !=NULL) &#123; current_node = current_node-&gt;right; &#125;else &#123; PBST child = (PBST)malloc(sizeof(PBST)); child = create_node(child,data); printf(\"\\nchild data : %d \\n\",child-&gt;data); current_node-&gt;right = child; break; &#125; &#125; &#125;&#125;void print_inorder(PBST tree) &#123; if(tree) &#123; print_inorder(tree-&gt;left); printf(\"%d\\n\",tree-&gt;data); print_inorder(tree-&gt;right); &#125;&#125;","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"BSTæ ‘","slug":"BSTæ ‘","permalink":"http://blog.crazylaw.cn/tags/BST%E6%A0%91/"}]},{"title":"Cè¯­è¨€æ•°æ®ç»“æ„ã®å¾ªç¯é˜Ÿåˆ—","slug":"æ•°æ®ç»“æ„/struct-study-3","date":"2017-02-15T06:08:17.000Z","updated":"2021-03-20T16:25:01.817Z","comments":true,"path":"2017/02/15/æ•°æ®ç»“æ„/struct-study-3/","link":"","permalink":"http://blog.crazylaw.cn/2017/02/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/struct-study-3/","excerpt":"","text":"å®ç°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;// because the C language does not has the type of boolean ,so , we use replace of which int,example 1 and 0 replace of the \"true\" and \"false\"#define true 1#define false 0// alias name by inttypedef int elementType;// design the queue data stucttypedef struct queue&#123; elementType *content; elementType front; elementType rear; elementType maxSize;&#125;QUEUE,*PQUEUE;// define the funcPQUEUE createQueue(); // create one queue , return the queueint isFull(PQUEUE queue); // is Fullint isEmpty(PQUEUE queue); // is Emptyint enQueue(PQUEUE queue,int data); // EnQueue , include isFullint deQueue(PQUEUE queue); // DeQueue, include isEmpty//void loop_print(PQUEUE queue); // Loop Print the queue;void main()&#123; // define the queue PQUEUE queue = NULL; printf(\" Please Input the queue of length :\"); int length; scanf(\"%d\",&amp;length); // invoke func queue = createQueue(length); while(true) &#123; printf(\" Please Input which your want to enQueue the data:\"); int data ; scanf(\"%d\",&amp;data); if(data == 0) &#123; break; &#125; // invoke func enQueue(queue,data); &#125; char *result = (char *)malloc(sizeof(char)); while(true) &#123; printf(\"deQueue :\"); int data = deQueue(queue); printf(\"data : %d\\n\",data); printf(\" Go on ? [yes|no]\\n\"); scanf(\"%s\",result); if(strcmp(result,\"yes\") != 0) &#123; break; &#125; &#125;&#125;PQUEUE createQueue(int maxSize)&#123; PQUEUE p = (PQUEUE)malloc(sizeof(PQUEUE)); if(p == NULL) &#123; printf(\"malloc apply fail\"); exit(-1); &#125; if(maxSize &lt; 1) &#123; printf(\"the queue size does not &lt; 1\"); exit(-1); &#125; maxSize++; // when the front end rear equals ,the queue is empty p-&gt;front = p-&gt;rear = 0; p-&gt;maxSize = maxSize; p-&gt;content = (elementType *)malloc(sizeof(elementType)); // init Mem // return the queue of point; return p;&#125;int enQueue(PQUEUE queue,int data)&#123; if(isFull(queue))&#123; printf(\"The queue is fullest,data : %d\\n\",data); exit(-1); &#125; queue-&gt;content[queue-&gt;rear] = data; queue-&gt;rear = (queue-&gt;rear+1)%queue-&gt;maxSize;&#125;int isFull(PQUEUE queue)&#123; if((((queue-&gt;rear)+1)%queue-&gt;maxSize == queue-&gt;front)) &#123; return true; &#125; return false;&#125;int isEmpty(PQUEUE queue)&#123; if(queue-&gt;rear == queue-&gt;front &amp;&amp; queue-&gt;maxSize &gt; 0) &#123; return true; &#125; return false;&#125;int deQueue(PQUEUE queue)&#123; if(isEmpty(queue)) &#123; printf(\"é˜Ÿåˆ—ä¸ºç©º\"); exit(-1); &#125; int data = queue-&gt;content[queue-&gt;front]; queue-&gt;front = (queue-&gt;front+1)%queue-&gt;maxSize; return data;&#125;","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"å¾ªç¯é˜Ÿåˆ—","slug":"å¾ªç¯é˜Ÿåˆ—","permalink":"http://blog.crazylaw.cn/tags/%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97/"}]},{"title":"PHP7æ‰©å±•å¼€å‘ã®Hello Wold","slug":"php-extend-1","date":"2017-02-10T03:47:00.000Z","updated":"2021-03-20T16:25:01.812Z","comments":true,"path":"2017/02/10/php-extend-1/","link":"","permalink":"http://blog.crazylaw.cn/2017/02/10/php-extend-1/","excerpt":"ç®€ä»‹æƒ³è¦çªç ´è‡ªæˆ‘ï¼Œå¿…é¡»æ·±å…¥äº†è§£ PHPï¼Œä»Šå¤©æˆ‘ä»¬è®²è®² PHP æ‰©å±•çš„å¼€å‘ï¼Œæ­¤è·¯é•¿é•¿ï¼Œéœ€è¦å¤šå¤šç§¯ç´¯ C è¯­è¨€çš„çŸ¥è¯†ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œç›´å…¥ä¸»é¢˜ã€‚ èµ„æºå…ˆå» github ä¸Šä¸‹è½½ PHP çš„æºç ï¼Œæœç´¢ php-src https://github.com/php/php-src","text":"ç®€ä»‹æƒ³è¦çªç ´è‡ªæˆ‘ï¼Œå¿…é¡»æ·±å…¥äº†è§£ PHPï¼Œä»Šå¤©æˆ‘ä»¬è®²è®² PHP æ‰©å±•çš„å¼€å‘ï¼Œæ­¤è·¯é•¿é•¿ï¼Œéœ€è¦å¤šå¤šç§¯ç´¯ C è¯­è¨€çš„çŸ¥è¯†ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œç›´å…¥ä¸»é¢˜ã€‚ èµ„æºå…ˆå» github ä¸Šä¸‹è½½ PHP çš„æºç ï¼Œæœç´¢ php-src https://github.com/php/php-src å¼€å§‹1.åœ¨ PHP æºç åŒ…é‡Œé¢ï¼Œé‡Œé¢æœ‰ä¸€ä¸ª extï¼Œå’Œ Zend ç›®å½•ï¼ŒZend ç›®å½•å°±æ˜¯æˆ‘ä»¬çš„ PHP æºç çš„æ‰€æœ‰å¤´æ–‡ä»¶å’Œæ‰§è¡Œæ–‡ä»¶ï¼Œext åˆ™æ˜¯æˆ‘ä»¬å­˜æ”¾æ‰©å±•çš„ç›®å½•ã€‚æ—¥åå¿…è¯» Zendã€‚ç›®å‰åªéœ€è¦å…³æ³¨ extã€‚ 1cd ext åœ¨ ext ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°å¾ˆå¤š PHP æºç å¸®æˆ‘ä»¬æ‰©å±•å¥½çš„ä¸€äº›æ‰©å±•ï¼Œä¾‹å¦‚ curl,xml,pdo ç­‰ç­‰ã€‚æˆ‘ä»¬ç°åœ¨è¦å…³æ³¨çš„æ˜¯ ext-skel å·¥å…·ã€‚å®ƒå¯ä»¥å¸®æˆ‘ä»¬ç”Ÿæˆæ‰©å±•çš„æ ‡å‡†ç›®å½•æ ¼å¼ã€‚ 1./ext-skel --help 1.extname å‚æ•°ä¸ºæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰çš„æ‰©å±•åç§° 1./ext-skel --extname=hello_world ä»¥ä¸Šä»£ç ä¼šè‡ªåŠ¨ä¸ºä½ åˆ›å»ºæ‰©å±•åå­—å«hello_worldçš„æ ‡å‡†ç›®å½•ã€‚ åˆ›å»ºå®Œæ¯•ä¹‹å 1cd hello_world ç›®å‰ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ–‡ä»¶åªæœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯config.m4,hello_world.c è¿™ä¸ªconfig.m4ç›®å½•æ˜¯æˆ‘ä»¬ç”Ÿæˆç¼–è¯‘æ–‡ä»¶çš„é…ç½®æ–‡ä»¶ã€‚ 1vim config.m4 ä¿®æ”¹å®Œæ¯•ä¹‹åï¼Œä¿å­˜é€€å‡ºã€‚ æ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬çš„é‡ç‚¹æ–‡ä»¶äº†ï¼Œhello_world.c 1234vim hello_world.c#ä»¥ä¸‹æ˜¯vimæœç´¢å‘½ä»¤zend_module_entry/zend_module_entry æŸ¥çœ‹åˆ°å¦‚ä¸‹éƒ¨åˆ†ï¼š è¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬æ‰©å±•çš„å…¥å£æ–‡ä»¶ã€‚ç°åœ¨æˆ‘ä»¬æš‚æ—¶ç”¨ä¸ä¸Šã€‚ æˆ‘ä»¬éœ€è¦å…³å¿ƒçš„ zend_function_entry è¿™ä¸ªå‡½æ•°ä¼šåˆå§‹åŒ–æˆ‘ä»¬çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥çš„Hello_World()ã€‚ æˆ‘ä»¬åœ¨zend_function_entry é‡Œé¢å†™å…¥ä¸€è¡Œä»£ç : 1PHP_FE(Hello_World,NULL) ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‡½æ•°çš„åç§°ï¼Œç¬¬äºŒå‚æ•°ä¸ºä¼ å…¥å‡½æ•°çš„å‚æ•°ã€‚ å¥½äº†ï¼Œå®šä¹‰å®Œè¦åˆå§‹åŒ–çš„å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å°±è¦å»å†™å‡½æ•°äº†ã€‚ æ‰¾ä¸ªç©ºç™½çš„åœ°æ–¹æ’å…¥ä»¥ä¸‹ä»£ç  123456PHP_FUNCTION(Hello_World)&#123; php_printf(\"I'm PHP's ext function Hello_World\"); /* this function php_printf Zend Engine defined*/ RETURN_TRUE; /* this const var also with top*/&#125; ä¿å­˜é€€å‡º 123phpize./configuremake &amp;&amp; make install 1ll modules&#x2F; okï¼Œå®Œæˆäº† 90%äº†ã€‚ å‰©ä¸‹çš„å°±æ˜¯æŠŠè¿™ä¸ª so æ–‡ä»¶ï¼Œæ·»åŠ åˆ°php.inié‡Œé¢å§ã€‚ Good Luck!","categories":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"}],"tags":[{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"PHPæ‰©å±•","slug":"PHPæ‰©å±•","permalink":"http://blog.crazylaw.cn/tags/PHP%E6%89%A9%E5%B1%95/"}]},{"title":"Cè¯­è¨€æ•°æ®ç»“æ„ã®å•é“¾è¡¨","slug":"æ•°æ®ç»“æ„/struct-study-2","date":"2017-01-24T09:27:20.000Z","updated":"2021-03-20T16:25:01.817Z","comments":true,"path":"2017/01/24/æ•°æ®ç»“æ„/struct-study-2/","link":"","permalink":"http://blog.crazylaw.cn/2017/01/24/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/struct-study-2/","excerpt":"","text":"å®ç°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt; // å£°æ˜exitå‡½æ•°/* å•èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ 16ä¸ªå­—èŠ‚ */typedef struct Node&#123; int data; //æ•°æ®åŸŸ struct Node * pNext; //æŒ‡é’ˆåŸŸ&#125;NODE,*PNODE;//å‡½æ•°å£°æ˜PNODE createLinkList(void); //åˆ›å»ºé“¾è¡¨çš„å‡½æ•°void traverseLinkList(PNODE pHead); //éå†é“¾è¡¨çš„å‡½æ•°/** * ä¸»å‡½æ•°å…¥å£ main */void main()&#123; PNODE pHead = NULL; pHead = createLinkList(); traverseLinkList(pHead);&#125;/** * åˆ›å»ºé“¾è¡¨ */PNODE createLinkList(void)&#123; int length; int i; int value; // ç”³è¯·å†…å­˜ç©ºé—´,å¤´ç»“ç‚¹ PNODE phead = (PNODE)malloc(sizeof(NODE)); if(NULL == phead) &#123; printf(\"å†…å­˜åˆ†é…å¤±è´¥ï¼Œç¨‹åºé€€å‡ºï¼\\n\"); exit(-1); &#125; // å°¾èŠ‚ç‚¹ PNODE pend = phead; // pendå§‹ç»ˆæŒ‡å‘å°¾èŠ‚ç‚¹ pend-&gt;pNext = NULL; // å•é“¾è¡¨å°¾èŠ‚ç‚¹æŒ‡é’ˆåŸŸä¸ºNULL printf(\"è¯·è¾“å…¥é“¾è¡¨çš„é•¿åº¦,len =\"); scanf(\"%d\",&amp;length); // åˆ›å»ºé“¾è¡¨é•¿åº¦ for(i= 0;i&lt; length;i++)&#123; printf(\"è¯·è¾“å…¥ç¬¬%dä¸ªèŠ‚ç‚¹çš„å€¼ :\",i); scanf(\"%d\",&amp;value); PNODE pNew =(PNODE)malloc(sizeof(NODE)); if(NULL == pNew) &#123; printf(\"å†…å­˜åˆ†é…å¤±è´¥ï¼Œç¨‹åºé€€å‡ºï¼\\n\"); exit(-1); &#125; pNew-&gt;data = value; // æŠŠæ–°å€¼æ”¾å…¥èŠ‚ç‚¹ pend-&gt;pNext = pNew; // æŠŠå°¾èŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹ pNew-&gt;pNext = NULL; // å°¾èŠ‚ç‚¹æŒ‡é’ˆåŸŸä¸ºNULL pend = pNew; &#125; return phead;&#125;void traverseLinkList(PNODE pHead)&#123; PNODE p = pHead-&gt;pNext; while(NULL != p) &#123; printf(\"%d \", p-&gt;data); p = p-&gt;pNext; &#125; printf(\"\\n\");&#125;","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"å•é“¾è¡¨","slug":"å•é“¾è¡¨","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%95%E9%93%BE%E8%A1%A8/"}]},{"title":"çº¿æ€§å­˜å‚¨ç»“æ„","slug":"æ•°æ®ç»“æ„/struct-study-1","date":"2017-01-24T03:29:00.000Z","updated":"2021-03-20T16:25:01.817Z","comments":true,"path":"2017/01/24/æ•°æ®ç»“æ„/struct-study-1/","link":"","permalink":"http://blog.crazylaw.cn/2017/01/24/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/struct-study-1/","excerpt":"ç®€ä»‹ çº¿æ€§ç»“æ„æ˜¯ä¸€ä¸ªæœ‰åºå…ƒç´ é›†åˆ å¸¸ç”¨çš„çº¿æ€§ç»“æ„æœ‰ï¼šçº¿æ€§è¡¨ï¼Œæ ˆï¼Œé˜Ÿåˆ—ï¼ŒåŒé˜Ÿåˆ—ï¼Œæ•°ç»„ï¼Œä¸² å…³äºå¹¿ä¹‰è¡¨ï¼Œæ˜¯ä¸€ç§éçº¿æ€§æ•°æ®ç»“æ„ å¸¸è§çš„éçº¿æ€§ç»“æ„æœ‰ï¼šäºŒç»´æ•°ç»„ï¼Œå¤šç»´æ•°ç»„ï¼Œæ ‘ï¼ˆäºŒå‰æ ‘ç­‰ï¼‰ï¼Œå¹¿ä¹‰è¡¨ï¼Œå›¾ã€‚","text":"ç®€ä»‹ çº¿æ€§ç»“æ„æ˜¯ä¸€ä¸ªæœ‰åºå…ƒç´ é›†åˆ å¸¸ç”¨çš„çº¿æ€§ç»“æ„æœ‰ï¼šçº¿æ€§è¡¨ï¼Œæ ˆï¼Œé˜Ÿåˆ—ï¼ŒåŒé˜Ÿåˆ—ï¼Œæ•°ç»„ï¼Œä¸² å…³äºå¹¿ä¹‰è¡¨ï¼Œæ˜¯ä¸€ç§éçº¿æ€§æ•°æ®ç»“æ„ å¸¸è§çš„éçº¿æ€§ç»“æ„æœ‰ï¼šäºŒç»´æ•°ç»„ï¼Œå¤šç»´æ•°ç»„ï¼Œæ ‘ï¼ˆäºŒå‰æ ‘ç­‰ï¼‰ï¼Œå¹¿ä¹‰è¡¨ï¼Œå›¾ã€‚ çº¿æ€§è¡¨ é¡ºåºè¡¨ é¡ºåºè¡¨å°†å…ƒç´ å­˜å‚¨åœ¨ä¸€ç»„è¿ç»­çš„å•å…ƒä¸­ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸Šæ˜¯è¿ç»­çš„ï¼Œå°±æ˜¯è¯´å†…å­˜åœ°å€æ˜¯è¿ç»­çš„ã€‚ é¡ºåºçš„å¯†åº¦æ¯”è¾ƒå¤§,èŠ‚çœç©ºé—´ã€‚è¯»å–çš„æ—¶é—´å¤æ‚åº¦ä¸º:O(1),æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸º O((n-0)/2),æ’å…¥æˆ–è€…åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦ä¸º O((n-0)/2),åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦ä¸º O((n-1)/2) é“¾è¡¨ é“¾è¡¨æ‹¥æœ‰å¾ˆå¤šç»“ç‚¹ï¼Œæ¯ä¸ªç»“ç‚¹å‰åŠéƒ¨åˆ†æ˜¯æ•°æ®åŸŸï¼ŒååŠéƒ¨åˆ†æ˜¯æŒ‡é’ˆåŸŸï¼ŒæŒ‡é’ˆåŸŸæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªç»“ç‚¹ï¼›é“¾è¡¨å¯åˆ†ä¸ºå•é“¾è¡¨ã€å¾ªç¯é“¾è¡¨å’ŒåŒé“¾è¡¨ã€‚ å•é“¾è¡¨ ä»ç»“æ„å¯ä»¥çœ‹å‡º,å•é“¾è¡¨æœ‰ä¸€ä¸ªå¤´éƒ¨èŠ‚ç‚¹,æ²¡æœ‰ data åŸŸ,ç›´æ¥æŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ p1,ç¬¬ä¸€ä¸ªèŠ‚ç‚¹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†,ä¸€ä¸ªæ˜¯ data åŸŸ,ä¸€ä¸ªæ˜¯æŒ‡é’ˆåŸŸ,æŒ‡é’ˆåŸŸæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ p2,æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆåŸŸä¸º NULL. é“¾è¡¨çš„å¯†åº¦æ¯”è¾ƒæ•£åˆ—ã€‚è¯»å–çš„æ—¶é—´å¤æ‚åº¦ä¸º O((n+1)/2),æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n/2)ï¼Œæ’å…¥çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1),åˆ é™¤çš„æ—¶é—´å¤æ‚ä¸º O(1)","categories":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}],"tags":[{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"çº¿æ€§å­˜å‚¨ç»“æ„","slug":"çº¿æ€§å­˜å‚¨ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E7%BA%BF%E6%80%A7%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/"}]},{"title":"C è¯­è¨€å…¥é—¨å®å½• äºŒ","slug":"c-study-2","date":"2017-01-21T03:29:00.000Z","updated":"2021-03-20T16:25:01.802Z","comments":true,"path":"2017/01/21/c-study-2/","link":"","permalink":"http://blog.crazylaw.cn/2017/01/21/c-study-2/","excerpt":"Cè¯­è¨€ä¸­çš„ç±»å‹åˆ†ä¸ºä¸€ä¸‹å‡ ç§ åºå· ç±»å‹å’Œæè¿° 1 åŸºæœ¬ç±»å‹ï¼šç®—æœ¯ç±»å‹ ï¼Œæ•´æ•°ç±»å‹å’Œæµ®ç‚¹ç±»å‹ 2 æšä¸¾ç±»å‹ï¼šä¹Ÿæ˜¯ç®—æœ¯ç±»å‹ï¼Œä½†æ˜¯æ˜¯ä¸€äº›ç¦»æ•£å›ºå®šçš„æ•´æ•°ç±»å‹ 3 voidç±»å‹ï¼šè¡¨æ˜æ²¡æœ‰å¯ç”¨çš„å€¼ 4 æ´¾ç”Ÿç±»å‹ï¼šæŒ‡é’ˆç±»å‹ï¼Œæ•°ç»„ç±»å‹ï¼Œç»“æ„ç±»å‹ï¼Œå‡½æ•°ç±»å‹ä»¥åŠå…±ç”¨ä½“ç±»å‹ æ•´æ•°ç±»å‹ ç±»å‹ å­˜å‚¨å¤§å°ï¼ˆ1ä¸ªå­—èŠ‚(bit)å 8ä½[bits]ï¼‰ å€¼çš„èŒƒå›´ï¼ˆç”±äºŒè¿›åˆ¶å¾—å‡ºï¼‰ char 1å­—èŠ‚ -128127 æˆ–è€… 0255 unsigned char 1å­—èŠ‚ 0~255 signed char 1å­—èŠ‚ -128~127 int 2å­—èŠ‚(16ä½ç³»ç»Ÿ)æˆ–4å­—èŠ‚(32/64ä½ç³»ç»Ÿ) -32,768 åˆ° 32,767 æˆ– -2,147,483,648 åˆ° 2,147,483,647 unsigned int 2å­—èŠ‚(16ä½ç³»ç»Ÿ)æˆ–4å­—èŠ‚(32/64ä½ç³»ç»Ÿ) 0 åˆ° 65,535 æˆ– 0 åˆ° 4,294,967,295 short 2å­—èŠ‚ -32,768 åˆ° 32,767 unsigned short 2å­—èŠ‚ 0 åˆ° 65,535 long 4å­—èŠ‚ -2,147,483,648 åˆ° 2,147,483,647 unsigned long 4å­—èŠ‚ 0 åˆ° 4,294,967,295","text":"Cè¯­è¨€ä¸­çš„ç±»å‹åˆ†ä¸ºä¸€ä¸‹å‡ ç§ åºå· ç±»å‹å’Œæè¿° 1 åŸºæœ¬ç±»å‹ï¼šç®—æœ¯ç±»å‹ ï¼Œæ•´æ•°ç±»å‹å’Œæµ®ç‚¹ç±»å‹ 2 æšä¸¾ç±»å‹ï¼šä¹Ÿæ˜¯ç®—æœ¯ç±»å‹ï¼Œä½†æ˜¯æ˜¯ä¸€äº›ç¦»æ•£å›ºå®šçš„æ•´æ•°ç±»å‹ 3 voidç±»å‹ï¼šè¡¨æ˜æ²¡æœ‰å¯ç”¨çš„å€¼ 4 æ´¾ç”Ÿç±»å‹ï¼šæŒ‡é’ˆç±»å‹ï¼Œæ•°ç»„ç±»å‹ï¼Œç»“æ„ç±»å‹ï¼Œå‡½æ•°ç±»å‹ä»¥åŠå…±ç”¨ä½“ç±»å‹ æ•´æ•°ç±»å‹ ç±»å‹ å­˜å‚¨å¤§å°ï¼ˆ1ä¸ªå­—èŠ‚(bit)å 8ä½[bits]ï¼‰ å€¼çš„èŒƒå›´ï¼ˆç”±äºŒè¿›åˆ¶å¾—å‡ºï¼‰ char 1å­—èŠ‚ -128127 æˆ–è€… 0255 unsigned char 1å­—èŠ‚ 0~255 signed char 1å­—èŠ‚ -128~127 int 2å­—èŠ‚(16ä½ç³»ç»Ÿ)æˆ–4å­—èŠ‚(32/64ä½ç³»ç»Ÿ) -32,768 åˆ° 32,767 æˆ– -2,147,483,648 åˆ° 2,147,483,647 unsigned int 2å­—èŠ‚(16ä½ç³»ç»Ÿ)æˆ–4å­—èŠ‚(32/64ä½ç³»ç»Ÿ) 0 åˆ° 65,535 æˆ– 0 åˆ° 4,294,967,295 short 2å­—èŠ‚ -32,768 åˆ° 32,767 unsigned short 2å­—èŠ‚ 0 åˆ° 65,535 long 4å­—èŠ‚ -2,147,483,648 åˆ° 2,147,483,647 unsigned long 4å­—èŠ‚ 0 åˆ° 4,294,967,295 ä½†æ˜¯Cè¯­è¨€çš„å–å€¼èŒƒå›´æ˜¯å¦‚ä½•è®¡ç®—çš„å‡ºæ¥çš„å‘¢ï¼Ÿ äºŒè¿›åˆ¶æ•°æ®åœ¨è®¡ç®—æœºä¸­å­˜å‚¨çš„æ˜¯è¡¥ç æ­£æ•°çš„è¡¥ç ç­‰äºåŸç ,è´Ÿæ•°è¡¥ç éœ€è¦åœ¨ç¬¦å·ä½ä¹‹åå–å+1 å¦‚æœä»¥æœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼ŒäºŒè¿›åˆ¶åŸç æœ€å¤§ä¸º0111111111111111=2çš„15æ¬¡æ–¹å‡1=32767æœ€å°ä¸º1111111111111111=-2çš„15æ¬¡æ–¹å‡1=-32767æ­¤æ—¶0æœ‰ä¸¤ç§è¡¨ç¤ºæ–¹æ³•ï¼Œå³æ­£0å’Œè´Ÿ0ï¼š0000000000000000=1000000000000000=0æ‰€ä»¥ï¼ŒäºŒè¿›åˆ¶åŸç è¡¨ç¤ºæ—¶ï¼ŒèŒƒå›´æ˜¯-32767ï½-0å’Œ0ï½32767ï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªé›¶çš„å­˜åœ¨ï¼Œæ‰€ä»¥ä¸åŒçš„æ•°å€¼ä¸ªæ•°ä¸€å…±åªæœ‰2çš„16æ¬¡æ–¹å‡1ä¸ªï¼Œæ¯”16ä½äºŒè¿›åˆ¶èƒ½å¤Ÿæä¾›çš„2çš„16æ¬¡æ–¹ä¸ªç¼–ç å°‘1ä¸ªã€‚ä½†æ˜¯è®¡ç®—æœºä¸­é‡‡ç”¨äºŒè¿›åˆ¶è¡¥ç å­˜å‚¨æ•°æ®ï¼Œå³æ­£æ•°ç¼–ç ä¸å˜ï¼Œä»0000000000000000åˆ°0111111111111111ä¾æ—§è¡¨ç¤º0åˆ°32767ï¼Œè€Œè´Ÿæ•°éœ€è¦æŠŠé™¤ç¬¦å·ä½ä»¥åçš„éƒ¨åˆ†å–ååŠ 1ï¼Œå³-32767çš„è¡¥ç ä¸º1000000000000001ã€‚åˆ°æ­¤ï¼Œå†æ¥çœ‹åŸç çš„æ­£0å’Œè´Ÿ0ï¼š0000000000000000å’Œ1000000000000000ï¼Œè¡¥ç è¡¨ç¤ºä¸­ï¼Œå‰è€…çš„è¡¥ç è¿˜æ˜¯0000000000000000ï¼Œåè€…ç»è¿‡éç¬¦å·ä½å–ååŠ 1åï¼ŒåŒæ ·å˜æˆäº†0000000000000000ï¼Œä¹Ÿå°±æ˜¯æ­£0å’Œè´Ÿ0åœ¨è¡¥ç ç³»ç»Ÿä¸­çš„ç¼–ç æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œ16ä½äºŒè¿›åˆ¶æ•°å¯ä»¥è¡¨ç¤º2çš„16æ¬¡æ–¹ä¸ªç¼–ç ï¼Œè€Œåœ¨è¡¥ç ä¸­é›¶çš„ç¼–ç åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯è¡¥ç ä¸­ä¼šæ¯”åŸç å¤šä¸€ä¸ªç¼–ç å‡ºæ¥ï¼Œè¿™ä¸ªç¼–ç å°±æ˜¯1000000000000000ï¼Œå› ä¸ºä»»ä½•ä¸€ä¸ªåŸç éƒ½ä¸å¯èƒ½åœ¨è½¬æˆè¡¥ç æ—¶å˜æˆ1000000000000000ã€‚æ‰€ä»¥ï¼Œäººä¸ºè§„å®š1000000000000000è¿™ä¸ªè¡¥ç ç¼–ç ä¸º-32768ã€‚æ‰€ä»¥ï¼Œè¡¥ç ç³»ç»Ÿä¸­ï¼ŒèŒƒå›´æ˜¯-23768ï½32767ã€‚å› æ­¤ï¼Œå®é™…ä¸Šï¼ŒäºŒè¿›åˆ¶çš„æœ€å°æ•°ç¡®å®æ˜¯1111111111111111ï¼Œåªæ˜¯äºŒè¿›åˆ¶è¡¥ç çš„æœ€å°å€¼æ‰æ˜¯1000000000000000ï¼Œè€Œè¡¥ç çš„1111111111111111æ˜¯äºŒè¿›åˆ¶å€¼çš„-1 å½“ç„¶ï¼Œå¦‚æœä½ ä¸ç¡®å®šå½“å‰æ¯ä¸ªç±»å‹å çš„è‡ªå·±æ•°çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸‹ä»£ç æ¥æ‰“å°ä¸€ä¸‹ 123456789#include &lt;stdio.h&gt;int main()&#123; printf(\"int å­˜å‚¨çš„å­—èŠ‚å¤§å°ä¸º: %lu \\n\",sizeof(int)); return 0;&#125; æµ®ç‚¹ç±»å‹ ç±»å‹ å­˜å‚¨å¤§å°ï¼ˆ1ä¸ªå­—èŠ‚(bit)å 8ä½[bits]ï¼‰ å€¼çš„èŒƒå›´ï¼ˆç”±äºŒè¿›åˆ¶å¾—å‡ºï¼‰ ç²¾åº¦ float 4 å­—èŠ‚ 1.2E-38 åˆ° 3.4E+38 6 ä½å°æ•° double 8 å­—èŠ‚ 2.3E-308 åˆ° 1.7E+308 15 ä½å°æ•° long double 16 å­—èŠ‚ 3.4E-4932 åˆ° 1.1E+4932 19 ä½å°æ•° æƒ³è¦ç”¨floatçš„å‡½æ•°å’Œå®å°±éœ€è¦å¼•å…¥floatç›¸å…³çš„å‡½æ•°å®šä¹‰ 123456789101112131415#include &lt;stdio.h&gt;#include &lt;float.h&gt; /** floatå¤´éƒ¨ **/int main()&#123; printf(\"float æœ€å¤§å­˜å‚¨çš„å­—èŠ‚ä¸º %lu \\n\",sizeof(float)); printf(\"float æœ€å°å€¼ä¸º %E\\n\",FLT_MIN); printf(\"float æœ€å¤§å€¼ä¸º %E\\n\",FLT_MAX); printf(\"ç²¾ç¡®åº¦ %d\\n\",FLT_DIG); return 0;&#125; voidç±»å‹æŒ‡å®šæ²¡æœ‰å¯ç”¨çš„å€¼ åºå· ç±»å‹ä¸æè¿° 1 å‡½æ•°è¿”å›ä¸ºç©º C ä¸­æœ‰å„ç§å‡½æ•°éƒ½ä¸è¿”å›å€¼ï¼Œæˆ–è€…æ‚¨å¯ä»¥è¯´å®ƒä»¬è¿”å›ç©ºã€‚ä¸è¿”å›å€¼çš„å‡½æ•°çš„è¿”å›ç±»å‹ä¸ºç©ºã€‚ä¾‹å¦‚ void exit (int status); 2 å‡½æ•°å‚æ•°ä¸ºç©º C ä¸­æœ‰å„ç§å‡½æ•°ä¸æ¥å—ä»»ä½•å‚æ•°ã€‚ä¸å¸¦å‚æ•°çš„å‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ª voidã€‚ä¾‹å¦‚ int rand(void); 3 æŒ‡é’ˆæŒ‡å‘ void ç±»å‹ä¸º void * çš„æŒ‡é’ˆä»£è¡¨å¯¹è±¡çš„åœ°å€ï¼Œè€Œä¸æ˜¯ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå†…å­˜åˆ†é…å‡½æ•° void *malloc( size_t size ); è¿”å›æŒ‡å‘ void çš„æŒ‡é’ˆï¼Œå¯ä»¥è½¬æ¢ä¸ºä»»ä½•æ•°æ®ç±»å‹ã€‚","categories":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/categories/C/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"å­¦ä¹ è®°å½•","slug":"å­¦ä¹ è®°å½•","permalink":"http://blog.crazylaw.cn/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"}]},{"title":"Cè¯­è¨€ å…¥é—¨å®å½• ä¸€","slug":"c-study-1","date":"2017-01-21T03:01:00.000Z","updated":"2021-03-20T16:25:01.802Z","comments":true,"path":"2017/01/21/c-study-1/","link":"","permalink":"http://blog.crazylaw.cn/2017/01/21/c-study-1/","excerpt":"å¼€å§‹åœ¨ linux vim ä¸‹å»ºç«‹ä¸€ä¸ª Hello World ç¨‹åº æˆ‘ä»¬æ„æ°”é£å‘çš„å†™ä¸‹ï¼š 12345678910-Hello_World.c-#include &lt;stdio.h&gt;int main()&#123; printf(\"Hello world! \\n\"); return 0;&#125;","text":"å¼€å§‹åœ¨ linux vim ä¸‹å»ºç«‹ä¸€ä¸ª Hello World ç¨‹åº æˆ‘ä»¬æ„æ°”é£å‘çš„å†™ä¸‹ï¼š 12345678910-Hello_World.c-#include &lt;stdio.h&gt;int main()&#123; printf(\"Hello world! \\n\"); return 0;&#125; é€šè¿‡ gcc æ¥ç¼–è¯‘ C ä»£ç  gcc Hello_World.c -o Hello_World ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤§å°ç›¸å·® 8kb è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ ./Hello_World å¤‡æ³¨ æ‰€æœ‰çš„ C è¯­è¨€ç¨‹åºéƒ½éœ€è¦åŒ…å« main() å‡½æ•°ã€‚ ä»£ç ä» main() å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚ /_ â€¦ _/ ç”¨äºæ³¨é‡Šè¯´æ˜ã€‚ printf() ç”¨äºæ ¼å¼åŒ–è¾“å‡ºåˆ°å±å¹•ã€‚printf() å‡½æ•°åœ¨ â€œstdio.hâ€ å¤´æ–‡ä»¶ä¸­å£°æ˜ã€‚ stdio.h æ˜¯ä¸€ä¸ªå¤´æ–‡ä»¶ (æ ‡å‡†è¾“å…¥è¾“å‡ºå¤´æ–‡ä»¶) and #include æ˜¯ä¸€ä¸ªé¢„å¤„ç†å‘½ä»¤ï¼Œç”¨æ¥å¼•å…¥å¤´æ–‡ä»¶ã€‚ å½“ç¼–è¯‘å™¨é‡åˆ° printf() å‡½æ•°æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ° stdio.h å¤´æ–‡ä»¶ï¼Œä¼šå‘ç”Ÿç¼–è¯‘é”™è¯¯ã€‚ return 0; è¯­å¥ç”¨äºè¡¨ç¤ºé€€å‡ºç¨‹åºã€‚","categories":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/categories/C/"}],"tags":[{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"å­¦ä¹ è®°å½•","slug":"å­¦ä¹ è®°å½•","permalink":"http://blog.crazylaw.cn/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"}]},{"title":"æ·±åº¦è§£å‰–JWTè®¤è¯æµç¨‹","slug":"jwt-analysis","date":"2017-01-17T02:40:00.000Z","updated":"2021-03-20T16:25:01.806Z","comments":true,"path":"2017/01/17/jwt-analysis/","link":"","permalink":"http://blog.crazylaw.cn/2017/01/17/jwt-analysis/","excerpt":"è¯´æ˜ è¯´æ˜ç®€ä»‹ ä¼ ç»Ÿçš„ cookie-session æœºåˆ¶å¯ä»¥ä¿è¯çš„æ¥å£å®‰å…¨ï¼Œåœ¨æ²¡æœ‰é€šè¿‡è®¤è¯çš„æƒ…å†µä¸‹ä¼šè·³è½¬è‡³ç™»å…¥ç•Œé¢æˆ–è€…è°ƒç”¨å¤±è´¥ã€‚ åœ¨å¦‚ä»Š RESTful åŒ–çš„ API æ¥å£ä¸‹ï¼Œcookie-session å·²ç»ä¸èƒ½å¾ˆå¥½å‘æŒ¥å…¶ä½™çƒ­ä¿æŠ¤å¥½ä½ çš„ API ã€‚ æ›´å¤šçš„å½¢å¼ä¸‹é‡‡ç”¨çš„åŸºäº Token çš„éªŒè¯æœºåˆ¶ï¼ŒJWT æœ¬è´¨çš„ä¹Ÿæ˜¯ä¸€ç§ Tokenï¼Œä½†æ˜¯å…¶ä¸­åˆæœ‰äº›è®¸ä¸åŒã€‚ ä»€ä¹ˆæ˜¯ JWTJWT åŠæ—¶ JSON Web Tokenï¼Œå®ƒæ˜¯åŸºäº RFC 7519 æ‰€å®šä¹‰çš„ä¸€ç§åœ¨å„ä¸ªç³»ç»Ÿä¸­ä¼ é€’ç´§å‡‘å’Œè‡ªåŒ…å«çš„ JSON æ•°æ®å½¢å¼ã€‚ ç´§å‡‘ï¼ˆCompactï¼‰ ï¼šç”±äºä¼ é€çš„æ•°æ®å°ï¼ŒJWT å¯ä»¥é€šè¿‡ GETã€POST å’Œ æ”¾åœ¨ HTTP çš„ header ä¸­ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å› ä¸ºå°ä¹Ÿèƒ½ä¼ é€çš„æ›´å¿«ã€‚ è‡ªåŒ…å«ï¼ˆself-containedï¼‰ : Payload ä¸­èƒ½å¤ŸåŒ…å«ç”¨æˆ·çš„ä¿¡æ¯ï¼Œé¿å…æ•°æ®åº“çš„æŸ¥è¯¢ã€‚ JSON Web Token ç”±ä¸‰éƒ¨åˆ†ç»„æˆä½¿ç”¨ . åˆ†å‰²å¼€ï¼š header ï¼ˆå¤´éƒ¨ï¼‰ payload ï¼ˆè½½è·ï¼‰ Signatureï¼ˆç­¾åï¼‰","text":"è¯´æ˜ è¯´æ˜ç®€ä»‹ ä¼ ç»Ÿçš„ cookie-session æœºåˆ¶å¯ä»¥ä¿è¯çš„æ¥å£å®‰å…¨ï¼Œåœ¨æ²¡æœ‰é€šè¿‡è®¤è¯çš„æƒ…å†µä¸‹ä¼šè·³è½¬è‡³ç™»å…¥ç•Œé¢æˆ–è€…è°ƒç”¨å¤±è´¥ã€‚ åœ¨å¦‚ä»Š RESTful åŒ–çš„ API æ¥å£ä¸‹ï¼Œcookie-session å·²ç»ä¸èƒ½å¾ˆå¥½å‘æŒ¥å…¶ä½™çƒ­ä¿æŠ¤å¥½ä½ çš„ API ã€‚ æ›´å¤šçš„å½¢å¼ä¸‹é‡‡ç”¨çš„åŸºäº Token çš„éªŒè¯æœºåˆ¶ï¼ŒJWT æœ¬è´¨çš„ä¹Ÿæ˜¯ä¸€ç§ Tokenï¼Œä½†æ˜¯å…¶ä¸­åˆæœ‰äº›è®¸ä¸åŒã€‚ ä»€ä¹ˆæ˜¯ JWTJWT åŠæ—¶ JSON Web Tokenï¼Œå®ƒæ˜¯åŸºäº RFC 7519 æ‰€å®šä¹‰çš„ä¸€ç§åœ¨å„ä¸ªç³»ç»Ÿä¸­ä¼ é€’ç´§å‡‘å’Œè‡ªåŒ…å«çš„ JSON æ•°æ®å½¢å¼ã€‚ ç´§å‡‘ï¼ˆCompactï¼‰ ï¼šç”±äºä¼ é€çš„æ•°æ®å°ï¼ŒJWT å¯ä»¥é€šè¿‡ GETã€POST å’Œ æ”¾åœ¨ HTTP çš„ header ä¸­ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å› ä¸ºå°ä¹Ÿèƒ½ä¼ é€çš„æ›´å¿«ã€‚ è‡ªåŒ…å«ï¼ˆself-containedï¼‰ : Payload ä¸­èƒ½å¤ŸåŒ…å«ç”¨æˆ·çš„ä¿¡æ¯ï¼Œé¿å…æ•°æ®åº“çš„æŸ¥è¯¢ã€‚ JSON Web Token ç”±ä¸‰éƒ¨åˆ†ç»„æˆä½¿ç”¨ . åˆ†å‰²å¼€ï¼š header ï¼ˆå¤´éƒ¨ï¼‰ payload ï¼ˆè½½è·ï¼‰ Signatureï¼ˆç­¾åï¼‰ ä¸€ä¸ªå®Œæ•´çš„ JWT ä¸ºä»¥ä¸‹çš„å½¢å¼ï¼š xxxxx.yyyy.zzzz Header ä¸€èˆ¬ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆ alg tpy alg æ˜¯æ‰€é‡‡ç”¨çš„åŠ å¯† hash ç®—æ³•ï¼ˆHS256ï¼ŒMD5 ç­‰ï¼‰ï¼Œtpy å°±æ˜¯ token çš„ç±»å‹äº†ï¼Œåœ¨è¿™é‡Œå°±è‚¯å®šæ˜¯â€JWTâ€ã€‚ 1234&#123; \"alg\": \"HS256\", \"tpy\": \"JWT\"&#125; åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæˆ‘ä»¬é‡‡ç”¨ Base64 åŠ å¯†çš„ç®—æ³•æ¥åŠ å¯†ç¬¬ä¸€éƒ¨åˆ† header ç»“æœå¦‚ä¸‹ï¼š eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9 é‚£ä¹ˆï¼Œç›®å‰ JWT çš„å½¢å¼ä¸å®Œæ•´å½¢æ€å°±ä¸ºï¼š eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.&lt;second part&gt;.&lt;third part&gt; Payload ä¸€èˆ¬åˆ†äº†å‡ ä¸ªéƒ¨åˆ†ï¼Œå®ƒæ˜¯æ•´ä¸ª JWT çš„æ ¸å¿ƒä¿¡æ¯ï¼Œç›¸å½“äº bodyï¼Œå…¶ä¸­åŒ…å«äº†è®¸å¤šç§çš„å£°æ˜ï¼ˆclaimsï¼‰ã€‚ ï¼ˆä¿ç•™å£°æ˜ï¼‰reserved claims ï¼šé¢„å®šä¹‰çš„ ä¸€äº›å£°æ˜ï¼Œå¹¶ä¸æ˜¯å¼ºåˆ¶çš„ä½†æ˜¯æ¨èï¼Œå®ƒä»¬åŒ…æ‹¬ iss (issuer)ï¼Œexp (expiration time)ï¼Œsub (subject)ï¼Œaud(audience) ç­‰ã€‚ ï¼ˆå…¬æœ‰å£°æ˜ï¼‰public claims : è¿™ä¸ªéƒ¨åˆ†å¯ä»¥éšä¾¿å®šä¹‰ï¼Œä½†æ˜¯è¦æ³¨æ„å’Œ IANA JSON Web Token å†²çªã€‚ Payload ä¸€èˆ¬ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆ issu ï¼ˆç­¾å‘è€…ï¼‰ sub ï¼ˆé¢å‘å¯¹è±¡ï¼‰ iat ï¼ˆç­¾å‘æ—¶é—´ï¼‰ exp ï¼ˆè¿‡æœŸæ—¶é—´ï¼‰ 123456&#123; \"issu\":\"Baicai\", \"sub\":\"http://usblog.crazylaw.cn\", \"iat\":1484618744 \"exp\":1484618754 (æ³¨ï¼š10såè¿‡æœŸ)&#125; Signature åœ¨åˆ›å»ºè¯¥éƒ¨åˆ†æ—¶å€™ä½ åº”è¯¥å·²ç»æœ‰äº† ç¼–ç åçš„ Header å’Œ Payload è¿˜éœ€è¦ä¸€ä¸ªä¸€ä¸ªç§˜é’¥ï¼Œè¿™ä¸ªåŠ å¯†çš„ç®—æ³•åº”è¯¥ Header ä¸­æŒ‡å®šã€‚ ä¸€ä¸ªä½¿ç”¨ HMAC SHA256 çš„ä¾‹å­å¦‚ä¸‹: 1234HMACSHA256( base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret) è¿™ä¸ª signature æ˜¯ç”¨æ¥éªŒè¯å‘é€è€…çš„ JWT çš„åŒæ—¶ä¹Ÿèƒ½ç¡®ä¿åœ¨æœŸé—´ä¸è¢«ç¯¡æ”¹ã€‚ æ‰€ä»¥ï¼Œåšåä½ çš„ä¸€ä¸ªå®Œæ•´çš„ JWT åº”è¯¥æ˜¯å¦‚ä¸‹å½¢å¼ï¼š 1eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ æ³¨æ„\bè¢« . åˆ†å‰²å¼€çš„ä¸‰ä¸ªéƒ¨åˆ† JSON Web Token çš„å·¥ä½œæµç¨‹ åœ¨ç”¨æˆ·ä½¿ç”¨è¯ä¹¦æˆ–è€…è´¦å·å¯†ç ç™»å…¥çš„æ—¶å€™ä¸€ä¸ª JSON Web Token å°†ä¼šè¿”å›ï¼ŒåŒæ—¶å¯ä»¥æŠŠè¿™ä¸ª JWT å­˜å‚¨åœ¨ local storageã€æˆ–è€… cookie ä¸­ï¼Œç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„åœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¸€ä¸ª session è¿”å›ä¸€ä¸ª cookieã€‚ å½“ç”¨æˆ·æƒ³è¦ä½¿ç”¨å—ä¿æŠ¤çš„è·¯ç”±æ—¶å€™ï¼Œåº”è¯¥è¦åœ¨è¯·æ±‚å¾—æ—¶å€™å¸¦ä¸Š JWT ï¼Œä¸€èˆ¬çš„æ˜¯åœ¨ header çš„ Authorization ä½¿ç”¨ Bearer çš„å½¢å¼ï¼Œä¸€ä¸ªåŒ…å«çš„ JWT çš„è¯·æ±‚å¤´çš„ Authorization å¦‚ä¸‹ï¼š Authorization: Bearer &lt;token&gt; è¿™æ˜¯ä¸€ä¸­æ— çŠ¶æ€çš„è®¤è¯æœºåˆ¶ï¼Œç”¨æˆ·çš„çŠ¶æ€ä»æ¥ä¸ä¼šå­˜åœ¨æœåŠ¡ç«¯ï¼Œåœ¨è®¿é—®å—ä¿æŠ¤çš„è·¯ç”±æ—¶å€™å›æ ¡éªŒ HTTP header ä¸­ Authorization çš„ JWTï¼ŒåŒæ—¶ JWT æ˜¯ä¼šå¸¦ä¸Šä¸€äº›å¿…è¦çš„ä¿¡æ¯ï¼Œä¸éœ€è¦å¤šæ¬¡çš„æŸ¥è¯¢æ•°æ®åº“ã€‚ è¿™ç§æ— çŠ¶æ€çš„æ“ä½œå¯ä»¥å……åˆ†çš„ä½¿ç”¨æ•°æ®çš„ APIsï¼Œç”šè‡³æ˜¯åœ¨ä¸‹æ¸¸æœåŠ¡ä¸Šä½¿ç”¨ï¼Œè¿™äº› APIs å’Œå“ªæœåŠ¡å™¨æ²¡æœ‰å…³ç³»ï¼Œå› æ­¤ï¼Œç”±äºæ²¡æœ‰ cookie çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨ä¸å­˜åœ¨è·¨åŸŸï¼ˆCORS, Cross-Origin Resource Sharingï¼‰çš„é—®é¢˜ã€‚ ä½ ä»¬ä»¥ä¸ºåˆ°è¿™é‡Œå°±å®Œäº†ï¼Ÿå…¶å®è¿˜æ²¡æœ‰ï¼Œè¿˜æœ‰ JWT è¶…æ—¶çš„é—®é¢˜ä»¥åŠä¼ è¾“çš„ä½ç½®è¿˜æ²¡æœ‰è®²ã€‚JWT ä¸€èˆ¬ä½ å¯ä»¥é€‰æ‹©æ”¾åœ¨ GET æ–¹æ³•çš„ query ä½œä¸ºå‚æ•°ä¼ é€’ç»™æœåŠ¡å™¨æ ¡éªŒã€‚ä½ ä¹Ÿå¯ä»¥é€‰æ‹© POST æ–¹æ³•çš„body æ¥ä¼ é€’è¯¥è¯¥å‚æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ GETã€POST æ–¹æ³•éƒ½æœ‰è‡ªèº«çš„ä¼ é€’æ•°æ®é•¿åº¦ï¼Œæˆ‘ä»¬è¦èŠ‚çº¦è¿™äº›èµ„æºçš„è¯ï¼Œæˆ‘è¿˜æ˜¯æ¨èæ”¾åœ¨å¤´éƒ¨ã€‚å¹¶ä¸”æœåŠ¡å™¨ç«¯æ¯æ¬¡æ ¡éªŒ jwt çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ª leeway ï¼Œæˆ‘æŠŠå®ƒå«ä¸ºè¿‚å›æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´çš„ä½œç”¨æ˜¯åœ¨ jwt è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼Œä½†æ˜¯å¯ä»¥åˆ·æ–° jwt è€Œå­˜åœ¨çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¹‹ä¸º åˆ·æ–°ä»¤ç‰Œæ—¶é—´ï¼Œåªè¦åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ç«¯å°±ä¼šåœ¨å“åº”æ€§å¤´è®¾ç½®æ–°çš„ jwt è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯éœ€è¦æ£€æµ‹è¿™ä¸ªå“åº”å¤´æ˜¯å¦å­˜åœ¨è¿™ä¸ªå±æ€§æ¥æ›´æ–° jwt çš„å€¼ï¼Œå¦åˆ™ï¼Œå¦‚æœ jwt è¶…è¿‡äº†è¿™ä¸ª leewayï¼Œé‚£ä¹ˆï¼Œä½ çš„ app å°†éœ€è¦é‡æ–°ç™»å½•æ¥è·å–æˆæƒã€‚","categories":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/"}],"tags":[{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"JWT","slug":"JWT","permalink":"http://blog.crazylaw.cn/tags/JWT/"}]},{"title":"apache-benchmark","slug":"apache-benchmark","date":"2017-01-12T06:38:06.000Z","updated":"2021-03-20T16:25:01.801Z","comments":true,"path":"2017/01/12/apache-benchmark/","link":"","permalink":"http://blog.crazylaw.cn/2017/01/12/apache-benchmark/","excerpt":"ç®€ä»‹Apache Benchmark å…¶å®å°±æ˜¯æˆ‘ä»¬å¹³æ—¶æ‰€ç†Ÿç§°çš„abtestï¼Œå³abå‹åŠ›æµ‹è¯•ï¼Œå®ƒæ˜¯apacheè‡ªå¸¦çš„ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å‹åŠ›æµ‹è¯•å·¥å…·ï¼Œå½“å®‰è£…å®Œapacheçš„æ—¶å€™ï¼Œå°±å¯ä»¥åœ¨binä¸‹é¢æ‰¾åˆ°abã€‚ ä½†æ˜¯å¦‚æœæˆ‘ä»¬ç”¨çš„httpä»£ç†æ˜¯nginxçš„æ—¶å€™å°±éœ€è¦æ‰‹åŠ¨ä¸‹è½½è¿™ä¸ªå·¥å…·äº†ã€‚æ¥ä¸‹æ¥å°±å’Œå¤§å®¶è®²è®²abtestã€‚","text":"ç®€ä»‹Apache Benchmark å…¶å®å°±æ˜¯æˆ‘ä»¬å¹³æ—¶æ‰€ç†Ÿç§°çš„abtestï¼Œå³abå‹åŠ›æµ‹è¯•ï¼Œå®ƒæ˜¯apacheè‡ªå¸¦çš„ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å‹åŠ›æµ‹è¯•å·¥å…·ï¼Œå½“å®‰è£…å®Œapacheçš„æ—¶å€™ï¼Œå°±å¯ä»¥åœ¨binä¸‹é¢æ‰¾åˆ°abã€‚ ä½†æ˜¯å¦‚æœæˆ‘ä»¬ç”¨çš„httpä»£ç†æ˜¯nginxçš„æ—¶å€™å°±éœ€è¦æ‰‹åŠ¨ä¸‹è½½è¿™ä¸ªå·¥å…·äº†ã€‚æ¥ä¸‹æ¥å°±å’Œå¤§å®¶è®²è®²abtestã€‚ å®‰è£…centos 7ä¸‹å®‰è£…abï¼Œåªéœ€è¦ä¸€ä¸ªå‘½ä»¤å°±å¥½äº† yum install httpd-tools ä½¿ç”¨ab www.baidu.com/ æ³¨æ„å‹åŠ›æµ‹è¯•æ˜¯æµ‹è¯•æŸä¸ªç›®å½•çš„ï¼Œåå°¾è¦åŠ ä¸Š/ è¿™å°±æ˜¯abæœ€ç®€å•çš„æµ‹è¯•å‘½ä»¤ï¼Œè¿™ä¸€å‘½ä»¤æ˜¾ç¤ºäº†ç™¾åº¦é¡µé¢çš„ç›¸å…³æ•°æ®ã€‚ 1234567891011121314151617181920212223242526272829303132This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http:&#x2F;&#x2F;www.zeustech.net&#x2F;Licensed to The Apache Software Foundation, http:&#x2F;&#x2F;www.apache.org&#x2F;Benchmarking www.baidu.com (be patient).....doneServer Software: BWS&#x2F;1.1Server Hostname: www.baidu.comServer Port: 80Document Path: &#x2F;Document Length: 102126 bytesConcurrency Level: 1Time taken for tests: 0.028 secondsComplete requests: 1Failed requests: 0Write errors: 0Total transferred: 103076 bytesHTML transferred: 102126 bytesRequests per second: 36.01 [#&#x2F;sec] (mean)Time per request: 27.773 [ms] (mean)Time per request: 27.773 [ms] (mean, across all concurrent requests)Transfer rate: 3624.39 [Kbytes&#x2F;sec] receivedConnection Times (ms) min mean[+&#x2F;-sd] median maxConnect: 8 8 0.0 8 8Processing: 20 20 0.0 20 20Waiting: 12 12 0.0 12 12Total: 28 28 0.0 28 28 ä¸Šè¾¹çš„æ•°æ®ä¸­ï¼ŒHTML transferredï¼ŒRequests per secondï¼ŒTime per requestæ˜¯æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„ï¼Œæ ¹æ®è¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬èƒ½å¤§æ¦‚äº†è§£WebæœåŠ¡å™¨çš„æ€§èƒ½æ°´å¹³ã€‚ ç›¸å…³å­—æ®µè¯´æ˜ å­—æ®µ è¯´æ˜ Server Software æœåŠ¡å™¨ç³»ç»Ÿ Server Hostname æœåŠ¡å™¨åŸŸå Server Port æœåŠ¡å™¨ç«¯å£ Document Path è®¿é—®çš„è·¯å¾„ Document Length è®¿é—®çš„æ–‡ä»¶å¤§å° Concurrency Level å¹¶å‘è¯·æ±‚æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºåŒä¸€æ—¶é—´çš„è®¿é—®äººæ•° Time taken fortests å“åº”æ—¶é—´ Complete requests æ€»å…±å“åº”æ¬¡æ•° Failed requests å¤±è´¥çš„è¯·æ±‚æ¬¡æ•° Write errors å¤±è´¥çš„å†™å…¥æ¬¡æ•° Total transferred ä¼ è¾“çš„æ€»æ•°æ®é‡ HTML transferred HTMLé¡µé¢å¤§å° Requests per second æ¯ç§’æ”¯æŒå¤šå°‘äººè®¿é—® Time per request æ»¡è¶³ä¸€ä¸ªè¯·æ±‚èŠ±è´¹çš„æ€»æ—¶é—´ Time per request æ»¡è¶³æ‰€æœ‰å¹¶å‘è¯·æ±‚ä¸­çš„ä¸€ä¸ªè¯·æ±‚èŠ±è´¹çš„æ€»æ—¶é—´ Transfer rate å¹³å‡æ¯ç§’æ”¶åˆ°çš„å­—èŠ‚ æœ€åçš„æ•°æ®åŒ…æ‹¬ Connect , Processing , Waiting , Total å­—æ®µã€‚è¿™äº›æ•°æ®èƒ½å¤§è‡´è¯´æ˜æµ‹è¯•è¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„æ—¶é—´ã€‚å…¶å®æˆ‘ä»¬å¯ä»¥åªçœ‹Totalå­—æ®µä¸­çš„minï¼Œmaxä¸¤åˆ—æ•°æ®å€¼ï¼Œè¿™ä¸¤ä¸ªå€¼åˆ†åˆ«æ˜¾ç¤ºäº†æµ‹è¯•è¿‡ç¨‹ä¸­ï¼ŒèŠ±è´¹æ—¶é—´æœ€çŸ­å’Œæœ€é•¿çš„æ—¶é—´ã€‚ å¯é€‰å‚æ•°abå‘½ä»¤è¿˜æœ‰å¾ˆå¤šå¯é€‰å‚æ•°ï¼Œä½†å¸¸ç”¨çš„å…¶å®å°±ä¸‹è¾¹å‡ ä¸ªï¼š å‚æ•° åŠŸèƒ½è§£é‡Š -n è®¾ç½®abå‘½ä»¤æ¨¡æ‹Ÿè¯·æ±‚çš„æ€»æ¬¡æ•° -c è®¾ç½®abå‘½ä»¤æ¨¡æ‹Ÿè¯·æ±‚çš„å¹¶å‘æ•° -t è®¾ç½®abå‘½ä»¤æ¨¡æ‹Ÿè¯·æ±‚çš„æ—¶é—´ -k è®¾ç½®abå‘½ä»¤å…è®¸1ä¸ªhttpä¼šè¯å“åº”å¤šä¸ªè¯·æ±‚ è¿™ä¸‰ä¸ªå‚æ•°çš„ç”¨æ³•å¦‚ä¸‹ï¼š 1ï¼‰ä½¿ç”¨abå‘½ä»¤åŠ ä¸Šâ€-nâ€å‚æ•°æ¨¡æ‹Ÿ1ä¸ªç”¨æˆ·è®¿é—®ç™¾åº¦æ€»å…±5æ¬¡ 1ab -n 5 www.baidu.com&#x2F; 2ï¼‰ä½¿ç”¨abå‘½ä»¤åŠ ä¸Šâ€-nâ€ä¸â€-câ€å‚æ•°æ¨¡æ‹Ÿ5ä¸ªç”¨æˆ·åŒæ—¶è®¿é—®ç™¾åº¦æ€»å…±9æ¬¡ 1ab -c 5 -n 9 www.baidu.com&#x2F; 3ï¼‰ä½¿ç”¨abå‘½ä»¤åŠ ä¸Šâ€-câ€ä¸â€-tâ€å‚æ•°æ¨¡æ‹Ÿ5ä¸ªç”¨æˆ·åŒæ—¶è®¿é—®ç™¾åº¦æ€»å…±9ç§’ 1ab -c 5 -t 9 www.baidu.com&#x2F; 3ï¼‰ä½¿ç”¨abå‘½ä»¤åŠ ä¸Šâ€-câ€ä¸â€-tâ€é™„åŠ â€-kâ€å‚æ•°æ¨¡æ‹Ÿ5ä¸ªç”¨æˆ·åŒæ—¶è®¿é—®ç™¾åº¦æ€»å…±9ç§’,ç™¾åº¦ä¼šæ‰“å¼€5ä¸ªå¹¶å‘è¿æ¥ï¼Œä»è€Œå‡å°‘webæœåŠ¡å™¨åˆ›å»ºæ–°é“¾æ¥æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚ 1ab -c 5 -t 9 -k www.baidu.com&#x2F; ä½¿ç”¨abå‘½ä»¤çš„æ—¶å€™ï¼Œæœ‰å‡ ç‚¹ç‚¹è¦è¯´æ˜ï¼š 1ï¼‰abå‘½ä»¤å¿…é¡»æŒ‡å®šè¦è®¿é—®çš„æ–‡ä»¶ï¼Œå¦‚æœæ²¡æŒ‡å®šï¼Œé‚£å¿…é¡»å¾—åœ¨åŸŸåçš„ç»“å°¾åŠ ä¸Šä¸€ä¸ªåæ–œæ ï¼Œä¾‹å¦‚ 1ab www.baidu.com å¾—æ”¹å†™ä¸º 1ab www.baidu.com&#x2F; 2ï¼‰abå‘½ä»¤å¯èƒ½ä¼šç”±äºç›®æ ‡webæœåŠ¡å™¨åšäº†ç›¸åº”çš„è¿‡æ»¤å¤„ç†ï¼Œå¯¼è‡´åœ¨æŸäº›æƒ…å†µä¸‹æ”¶ä¸åˆ°ä»»ä½•æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨â€-Hâ€å‚æ•°ï¼Œæ¥æ¨¡æ‹Ÿæˆæµè§ˆå™¨å‘é€è¯·æ±‚ã€‚ä¾‹å¦‚ï¼š æ¨¡æ‹ŸæˆChromeæµè§ˆå™¨å‘ç™¾åº¦å‘é€1ä¸ªè¯·æ±‚ 1ab -H &quot;Mozilla&#x2F;5.0 (Windows; U; Windows NT 5.1; en-Us) AppleWeb Kit&#x2F;534.2 (KHTML, like Gecko) Chrome&#x2F;6.0.447.0 Safari&#x2F;534.2&quot; www.baidu.com&#x2F; 3ï¼‰æœ€åï¼Œè¦æ³¨æ„çš„å°±æ˜¯ï¼Œåœ¨ä½¿ç”¨abå‘½ä»¤æµ‹è¯•æœåŠ¡å™¨æ—¶ï¼Œåƒä¸‡è¦å°å¿ƒï¼Œå¹¶ä¸”è¦é™åˆ¶å¯¹æœåŠ¡å™¨å‘å‡ºçš„è¯·æ±‚æ•°é‡ï¼Œç£¨é€”æ­Œå¸Œæœ›å¤§å®¶ç†æ€§ä½¿ç”¨è¿™äº›å‹åŠ›æµ‹è¯•å·¥å…·ï¼Œæˆ‘ä»¬éƒ½ä¸å¸Œæœ›ä»»ä½•ä¸€å°æ­£å¸¸çš„æœåŠ¡å™¨é™·å…¥ä¸å¿…è¦çš„éº»çƒ¦ã€‚ æ›´å¤šçš„å¯é€‰å‚æ•°å¦‚ä¸‹ï¼š æ›´å¤šå‚æ•° è¯´æ˜ -A é‡‡ç”¨base64ç¼–ç å‘æœåŠ¡å™¨æä¾›èº«ä»½éªŒè¯ä¿¡æ¯ï¼Œç”¨æ³•: -A ç”¨æˆ·å:å¯†ç  -C cookieä¿¡æ¯ï¼Œç”¨æ³•: -C mo2g=ç£¨é€”æ­Œ -d ä¸æ˜¾ç¤ºpecentiles served table -e ä¿å­˜åŸºå‡†æµ‹è¯•ç»“æœä¸ºcsvæ ¼å¼çš„æ–‡ä»¶ -g ä¿å­˜åŸºå‡†æµ‹è¯•ç»“æœä¸ºgunplotæˆ–TSVæ ¼å¼çš„æ–‡ä»¶ -h æ˜¾ç¤ºabå¯é€‰å‚æ•°åˆ—è¡¨ -H é‡‡ç”¨å­—æ®µå€¼çš„æ–¹å¼å‘é€å¤´ä¿¡æ¯å’Œè¯·æ±‚ -i å‘é€HEADè¯·æ±‚ï¼Œé»˜è®¤å‘é€GETè¯·æ±‚ -p é€šè¿‡POSTå‘é€æ•°æ®ï¼Œç”¨æ³•ï¼š -p blog=åšå®¢&amp;name=ç™½èœ -h æ˜¾ç¤ºabå¯é€‰å‚æ•°åˆ—è¡¨ -q æ‰§è¡Œå¤šä½™100ä¸ªè¯·æ±‚æ—¶éšè—æ‰è¿›åº¦è¾“å‡º -s ä½¿ç”¨Httpsåè®®å‘é€è¯·æ±‚ï¼Œé»˜è®¤ä½¿ç”¨Http -S éšè—ä¸­ä½æ•°å’Œæ ‡å‡†åå·®å€¼ -v -v 2 åŠä»¥ä¸Šå°†æ‰“å°è­¦å‘Šå’Œä¿¡æ¯ï¼Œ-v 3 æ‰“å°httpå“åº”ç ï¼Œ-v 4 æ‰“å°å¤´ä¿¡æ¯ -V æ˜¾ç¤ºabå·¥å…·çš„ç‰ˆæœ¬å· -w é‡‡ç”¨HTMLè¡¨æ ¼æ‰“å°ç»“æœ -x HTMLæ ‡ç­¾å±æ€§ï¼Œä½¿ç”¨ -w å‚æ•°æ—¶ï¼Œå°†æ”¾ç½®åœ¨&lt;table&gt;æ ‡ç­¾ä¸­ -X è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼Œç”¨æ³• -X 192.168.1.1:80 -y HTMLæ ‡ç­¾å±æ€§ï¼Œä½¿ç”¨ -w å‚æ•°æ—¶ï¼Œå°†æ”¾ç½®åœ¨&lt;tr&gt;æ ‡ç­¾ä¸­ -z HTMLæ ‡ç­¾å±æ€§ï¼Œä½¿ç”¨ -w å‚æ•°æ—¶ï¼Œå°†æ”¾ç½®åœ¨&lt;td&gt;æ ‡ç­¾ä¸­","categories":[{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"http://blog.crazylaw.cn/categories/%E6%B5%8B%E8%AF%95/"}],"tags":[{"name":"æµ‹è¯•å·¥å…·","slug":"æµ‹è¯•å·¥å…·","permalink":"http://blog.crazylaw.cn/tags/%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/"},{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"å‹åŠ›æµ‹è¯•","slug":"å‹åŠ›æµ‹è¯•","permalink":"http://blog.crazylaw.cn/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/"},{"name":"æ€§èƒ½æµ‹è¯•","slug":"æ€§èƒ½æµ‹è¯•","permalink":"http://blog.crazylaw.cn/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"}]},{"title":"Hello World","slug":"hello-world","date":"2016-12-28T17:01:00.000Z","updated":"2021-03-20T16:25:01.806Z","comments":true,"path":"2016/12/29/hello-world/","link":"","permalink":"http://blog.crazylaw.cn/2016/12/29/hello-world/","excerpt":"è¯´æ˜æ–°åšå®¢åˆ›å»ºæ—¶é—´ä¸ºï¼š2019-03-19 17:14:25åšæ–‡ 2019 å¹´ä¹‹å‰çš„åŸºæœ¬å°±æ˜¯æ—§æ–‡ç« ï¼Œè™½ç„¶æœ‰ä¸€äº›æ—§æ–‡ç« æœ‰ç‚¹æŠ€æœ¯å«é‡ä¸é«˜ï¼Œä½†æ˜¯ä¹Ÿæ˜¯è®°å½•ä¸ºçš„å­¦ä¹ è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸ºå†³å®šè¿˜æ˜¯æŠŠä¸€äº›æœ‰ç‚¹ç”¨çš„æ–‡ç« è®°å½•ä¸‹æ¥ï¼Œæ—¶é—´ä¸å¤ªå‡†ç¡® æ¬¢è¿å¤§å®¶æ¥åˆ°æˆ‘çš„ æŠ€æœ¯åšå®¢!ï¼Œè¿™æ˜¯æˆ‘ 2019 å¹´æ–°çš„åšå®¢ï¼Œç”±äºæ—§çš„åšå®¢é‡‡ç”¨åç«¯åšå®¢çš„å½¢å¼ï¼ˆå…¶å®æ˜¯ç”±äºä¹‹å‰æˆ‘æ‰‹è¯¯ï¼Œåˆæ²¡æœ‰å¤‡ä»½ä»£ç ï¼Œæ‰€ä»¥å¯¼è‡´åšå®¢ä»£ç å…¨åˆ äº†ï¼‰ï¼Œæ‰€ä»¥ç°åœ¨é‡æ–°å¼„äº†ä¸€ä¸ªæ›´åŠ ç°ä»£çš„åšå®¢ï¼Œåšå®¢å°†é‡‡ç”¨ hexo å¼ºåŠ›é©±åŠ¨ï¼Œæ¥è½¨ç°ä»£å‰ç«¯åšå®¢çš„æµè¡Œæ€§ï¼Œç»™å¤§å®¶æ›´åŠ çš„ä½“éªŒã€‚ï¼ˆğŸ˜„ ä¹Ÿæ–¹ä¾¿æˆ‘è‡ªå·±ç»´æŠ¤ï¼‰ï¼Œç”±äºåªæ˜¯ä»£ç åˆ é™¤äº†ï¼Œæ•°æ®åº“ä¸­çš„æ–‡ç« è¿˜æ˜¯æœ‰ä¿ç•™ä¸‹æ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šé™†é™†ç»­ç»­æŠŠæ–‡ç« éƒ½æ”¾å›ä¸Šå»ï¼Œä½†æ˜¯æœ‰ä¸€äº›å›¾ç‰‡ä»€ä¹ˆçš„ï¼ŒåŸºæœ¬å°±æ²¡æœ‰çš„ï¼Œæˆ‘ä¹Ÿä¼šæŠŠæ–‡ç« å‡çº§ä¸€ä¸‹ï¼Œç”±äºä»¥å‰åˆšæ¯•ä¸šï¼Œæ–‡ç« è´¨é‡ä¸€èˆ¬èˆ¬ï¼Œç°åœ¨ä¼šå–å…¶ç²¾åï¼Œå»å…¶ç³Ÿç²•ï¼Œæµ“ç¼©æ›´åŠ æœ‰ä»·å€¼çš„æ–‡ç« å‡ºæ¥å’Œå¤§å®¶ä¸€èµ·å­¦ä¹ ï¼Œæ¬¢è¿å¤§å®¶æ¥å’Œæˆ‘ä¸€èµ·å…±åŒæˆé•¿ï½ ğŸŒ¹ğŸŒ æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç”¨ C è¯­è¨€å†™ä¸‹å’Œå¤§å®¶é—®å¥½çš„ä»£ç  123456#include&lt;stdio.h&gt;int main(void)&#123; printf(\"Hello World\"); return 0; &#125;","text":"è¯´æ˜æ–°åšå®¢åˆ›å»ºæ—¶é—´ä¸ºï¼š2019-03-19 17:14:25åšæ–‡ 2019 å¹´ä¹‹å‰çš„åŸºæœ¬å°±æ˜¯æ—§æ–‡ç« ï¼Œè™½ç„¶æœ‰ä¸€äº›æ—§æ–‡ç« æœ‰ç‚¹æŠ€æœ¯å«é‡ä¸é«˜ï¼Œä½†æ˜¯ä¹Ÿæ˜¯è®°å½•ä¸ºçš„å­¦ä¹ è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸ºå†³å®šè¿˜æ˜¯æŠŠä¸€äº›æœ‰ç‚¹ç”¨çš„æ–‡ç« è®°å½•ä¸‹æ¥ï¼Œæ—¶é—´ä¸å¤ªå‡†ç¡® æ¬¢è¿å¤§å®¶æ¥åˆ°æˆ‘çš„ æŠ€æœ¯åšå®¢!ï¼Œè¿™æ˜¯æˆ‘ 2019 å¹´æ–°çš„åšå®¢ï¼Œç”±äºæ—§çš„åšå®¢é‡‡ç”¨åç«¯åšå®¢çš„å½¢å¼ï¼ˆå…¶å®æ˜¯ç”±äºä¹‹å‰æˆ‘æ‰‹è¯¯ï¼Œåˆæ²¡æœ‰å¤‡ä»½ä»£ç ï¼Œæ‰€ä»¥å¯¼è‡´åšå®¢ä»£ç å…¨åˆ äº†ï¼‰ï¼Œæ‰€ä»¥ç°åœ¨é‡æ–°å¼„äº†ä¸€ä¸ªæ›´åŠ ç°ä»£çš„åšå®¢ï¼Œåšå®¢å°†é‡‡ç”¨ hexo å¼ºåŠ›é©±åŠ¨ï¼Œæ¥è½¨ç°ä»£å‰ç«¯åšå®¢çš„æµè¡Œæ€§ï¼Œç»™å¤§å®¶æ›´åŠ çš„ä½“éªŒã€‚ï¼ˆğŸ˜„ ä¹Ÿæ–¹ä¾¿æˆ‘è‡ªå·±ç»´æŠ¤ï¼‰ï¼Œç”±äºåªæ˜¯ä»£ç åˆ é™¤äº†ï¼Œæ•°æ®åº“ä¸­çš„æ–‡ç« è¿˜æ˜¯æœ‰ä¿ç•™ä¸‹æ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šé™†é™†ç»­ç»­æŠŠæ–‡ç« éƒ½æ”¾å›ä¸Šå»ï¼Œä½†æ˜¯æœ‰ä¸€äº›å›¾ç‰‡ä»€ä¹ˆçš„ï¼ŒåŸºæœ¬å°±æ²¡æœ‰çš„ï¼Œæˆ‘ä¹Ÿä¼šæŠŠæ–‡ç« å‡çº§ä¸€ä¸‹ï¼Œç”±äºä»¥å‰åˆšæ¯•ä¸šï¼Œæ–‡ç« è´¨é‡ä¸€èˆ¬èˆ¬ï¼Œç°åœ¨ä¼šå–å…¶ç²¾åï¼Œå»å…¶ç³Ÿç²•ï¼Œæµ“ç¼©æ›´åŠ æœ‰ä»·å€¼çš„æ–‡ç« å‡ºæ¥å’Œå¤§å®¶ä¸€èµ·å­¦ä¹ ï¼Œæ¬¢è¿å¤§å®¶æ¥å’Œæˆ‘ä¸€èµ·å…±åŒæˆé•¿ï½ ğŸŒ¹ğŸŒ æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç”¨ C è¯­è¨€å†™ä¸‹å’Œå¤§å®¶é—®å¥½çš„ä»£ç  123456#include&lt;stdio.h&gt;int main(void)&#123; printf(\"Hello World\"); return 0; &#125; åšå®¢å°†ä¼šæ¶‰åŠä»¥ä¸‹å†…å®¹ PHP C Python Erlang Shell Lua Rust Redis Memcached Openresty Mysql Tidb Docker K8s Devops æœåŠ¡å™¨ å¤§æ•°æ® æ•°æ®ç»“æ„ ç®—æ³• æ¶æ„ ç­‰ç­‰ å¸Œæœ›å¤§å®¶å¯ä»¥å’Œæˆ‘ä¸€èµ·æœ‰æ‰€æ”¶è·ï¼Œé“­è®°ä¸€å¥è¯ï¼šè¯´åˆ°åšä¸åˆ°ï¼Œç­‰äºä¸çŸ¥é“ å…±å‹‰ã€‚","categories":[{"name":"åšå®¢é¢ä¸–","slug":"åšå®¢é¢ä¸–","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%9A%E5%AE%A2%E9%9D%A2%E4%B8%96/"}],"tags":[{"name":"åšå®¢é¢ä¸–","slug":"åšå®¢é¢ä¸–","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%9A%E5%AE%A2%E9%9D%A2%E4%B8%96/"}]}],"categories":[{"name":"ç»„ä»¶ä¼˜åŒ–","slug":"ç»„ä»¶ä¼˜åŒ–","permalink":"http://blog.crazylaw.cn/categories/%E7%BB%84%E4%BB%B6%E4%BC%98%E5%8C%96/"},{"name":"æ™ºèƒ½å®¶å±…","slug":"æ™ºèƒ½å®¶å±…","permalink":"http://blog.crazylaw.cn/categories/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/"},{"name":"å¤šåª’ä½“","slug":"å¤šåª’ä½“","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%9A%E5%AA%92%E4%BD%93/"},{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"å¹¿å‘Šè¡Œä¸š","slug":"å¹¿å‘Šè¡Œä¸š","permalink":"http://blog.crazylaw.cn/categories/%E5%B9%BF%E5%91%8A%E8%A1%8C%E4%B8%9A/"},{"name":"Mac","slug":"Mac","permalink":"http://blog.crazylaw.cn/categories/Mac/"},{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/categories/DevOps/"},{"name":"Goæºç å‰–æç³»åˆ—","slug":"Goæºç å‰–æç³»åˆ—","permalink":"http://blog.crazylaw.cn/categories/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%B3%BB%E5%88%97/"},{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/categories/Golang/"},{"name":"TIDB","slug":"TIDB","permalink":"http://blog.crazylaw.cn/categories/TIDB/"},{"name":"çŸ¥è¯†ç‚¹","slug":"çŸ¥è¯†ç‚¹","permalink":"http://blog.crazylaw.cn/categories/%E7%9F%A5%E8%AF%86%E7%82%B9/"},{"name":"å¹´ç»ˆæ€»ç»“","slug":"å¹´ç»ˆæ€»ç»“","permalink":"http://blog.crazylaw.cn/categories/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"},{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/categories/kubernetes/"},{"name":"rust","slug":"rust","permalink":"http://blog.crazylaw.cn/categories/rust/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"æ•°æ®åº“","slug":"æ•°æ®ç»“æ„/æ•°æ®åº“","permalink":"http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93/"},{"name":"çˆ¬è™«","slug":"çˆ¬è™«","permalink":"http://blog.crazylaw.cn/categories/%E7%88%AC%E8%99%AB/"},{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/categories/Docker/"},{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/categories/Redis/"},{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"http://blog.crazylaw.cn/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/categories/Linux/"},{"name":"Golang","slug":"å¤§æ•°æ®/Golang","permalink":"http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/Golang/"},{"name":"ç½‘ç»œåè®®","slug":"ç½‘ç»œåè®®","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/"},{"name":"Cè¯­è¨€","slug":"Cè¯­è¨€","permalink":"http://blog.crazylaw.cn/categories/C%E8%AF%AD%E8%A8%80/"},{"name":"LeeCode","slug":"LeeCode","permalink":"http://blog.crazylaw.cn/categories/LeeCode/"},{"name":"ç®—æ³•","slug":"LeeCode/ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/LeeCode/%E7%AE%97%E6%B3%95/"},{"name":"APIç½‘å…³","slug":"APIç½‘å…³","permalink":"http://blog.crazylaw.cn/categories/API%E7%BD%91%E5%85%B3/"},{"name":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","permalink":"http://blog.crazylaw.cn/categories/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"},{"name":"nginx","slug":"nginx","permalink":"http://blog.crazylaw.cn/categories/nginx/"},{"name":"Docker","slug":"kubernetes/Docker","permalink":"http://blog.crazylaw.cn/categories/kubernetes/Docker/"},{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/categories/PHP/"},{"name":"k8s","slug":"k8s","permalink":"http://blog.crazylaw.cn/categories/k8s/"},{"name":"Rust","slug":"Rust","permalink":"http://blog.crazylaw.cn/categories/Rust/"},{"name":"Python","slug":"Docker/Python","permalink":"http://blog.crazylaw.cn/categories/Docker/Python/"},{"name":"æµ‹è¯•","slug":"Docker/Python/æµ‹è¯•","permalink":"http://blog.crazylaw.cn/categories/Docker/Python/%E6%B5%8B%E8%AF%95/"},{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/categories/Nginx/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E7%AE%97%E6%B3%95/"},{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/categories/%E6%AD%A3%E5%88%99/"},{"name":"Git","slug":"Git","permalink":"http://blog.crazylaw.cn/categories/Git/"},{"name":"Nginx","slug":"PHP/Nginx","permalink":"http://blog.crazylaw.cn/categories/PHP/Nginx/"},{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C/"},{"name":"åè®®","slug":"ç½‘ç»œ/åè®®","permalink":"http://blog.crazylaw.cn/categories/%E7%BD%91%E7%BB%9C/%E5%8D%8F%E8%AE%AE/"},{"name":"MongoDb","slug":"MongoDb","permalink":"http://blog.crazylaw.cn/categories/MongoDb/"},{"name":"PHP","slug":"Linux/PHP","permalink":"http://blog.crazylaw.cn/categories/Linux/PHP/"},{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/"},{"name":"ç½‘ç»œ","slug":"åè®®/ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C/"},{"name":"Linux","slug":"åè®®/ç½‘ç»œ/Linux","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C/Linux/"},{"name":"MQ","slug":"MQ","permalink":"http://blog.crazylaw.cn/categories/MQ/"},{"name":"è¿›åˆ¶","slug":"è¿›åˆ¶","permalink":"http://blog.crazylaw.cn/categories/%E8%BF%9B%E5%88%B6/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"ç®—æ³•","slug":"åè®®/ç½‘ç»œ/ç®—æ³•","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%8F%E8%AE%AE/%E7%BD%91%E7%BB%9C/%E7%AE%97%E6%B3%95/"},{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/categories/C/"},{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"http://blog.crazylaw.cn/categories/%E6%B5%8B%E8%AF%95/"},{"name":"åšå®¢é¢ä¸–","slug":"åšå®¢é¢ä¸–","permalink":"http://blog.crazylaw.cn/categories/%E5%8D%9A%E5%AE%A2%E9%9D%A2%E4%B8%96/"}],"tags":[{"name":"cache","slug":"cache","permalink":"http://blog.crazylaw.cn/tags/cache/"},{"name":"æ™ºèƒ½å®¶å±…","slug":"æ™ºèƒ½å®¶å±…","permalink":"http://blog.crazylaw.cn/tags/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85/"},{"name":"Home Assistant","slug":"Home-Assistant","permalink":"http://blog.crazylaw.cn/tags/Home-Assistant/"},{"name":"HA","slug":"HA","permalink":"http://blog.crazylaw.cn/tags/HA/"},{"name":"aac","slug":"aac","permalink":"http://blog.crazylaw.cn/tags/aac/"},{"name":"å¤§æ•°æ®","slug":"å¤§æ•°æ®","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"},{"name":"å…¬å¸","slug":"å…¬å¸","permalink":"http://blog.crazylaw.cn/tags/%E5%85%AC%E5%8F%B8/"},{"name":"å¹¿å‘Šè¡Œä¸š","slug":"å¹¿å‘Šè¡Œä¸š","permalink":"http://blog.crazylaw.cn/tags/%E5%B9%BF%E5%91%8A%E8%A1%8C%E4%B8%9A/"},{"name":"Mac","slug":"Mac","permalink":"http://blog.crazylaw.cn/tags/Mac/"},{"name":"DevOps","slug":"DevOps","permalink":"http://blog.crazylaw.cn/tags/DevOps/"},{"name":"Golang","slug":"Golang","permalink":"http://blog.crazylaw.cn/tags/Golang/"},{"name":"Goæºç å‰–æ","slug":"Goæºç å‰–æ","permalink":"http://blog.crazylaw.cn/tags/Go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"},{"name":"flink","slug":"flink","permalink":"http://blog.crazylaw.cn/tags/flink/"},{"name":"TIDB","slug":"TIDB","permalink":"http://blog.crazylaw.cn/tags/TIDB/"},{"name":"2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“","slug":"2022æ‚ä¹±çŸ¥è¯†ç‚¹æ€»ç»“","permalink":"http://blog.crazylaw.cn/tags/2022%E6%9D%82%E4%B9%B1%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/"},{"name":"å¹´ç»ˆæ€»ç»“","slug":"å¹´ç»ˆæ€»ç»“","permalink":"http://blog.crazylaw.cn/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"},{"name":"kubernetes","slug":"kubernetes","permalink":"http://blog.crazylaw.cn/tags/kubernetes/"},{"name":"rust","slug":"rust","permalink":"http://blog.crazylaw.cn/tags/rust/"},{"name":"Kafka","slug":"Kafka","permalink":"http://blog.crazylaw.cn/tags/Kafka/"},{"name":"TiDB","slug":"TiDB","permalink":"http://blog.crazylaw.cn/tags/TiDB/"},{"name":"RocketDB","slug":"RocketDB","permalink":"http://blog.crazylaw.cn/tags/RocketDB/"},{"name":"SQL","slug":"SQL","permalink":"http://blog.crazylaw.cn/tags/SQL/"},{"name":"flume","slug":"flume","permalink":"http://blog.crazylaw.cn/tags/flume/"},{"name":"kudu","slug":"kudu","permalink":"http://blog.crazylaw.cn/tags/kudu/"},{"name":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","slug":"æ•°æ®åº“å¼€å‘çŸ¥è¯†","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/"},{"name":"Jenkins","slug":"Jenkins","permalink":"http://blog.crazylaw.cn/tags/Jenkins/"},{"name":"çˆ¬è™«","slug":"çˆ¬è™«","permalink":"http://blog.crazylaw.cn/tags/%E7%88%AC%E8%99%AB/"},{"name":"Docker","slug":"Docker","permalink":"http://blog.crazylaw.cn/tags/Docker/"},{"name":"å¤§æ•°æ®ï¼ŒHadoop","slug":"å¤§æ•°æ®ï¼ŒHadoop","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%EF%BC%8CHadoop/"},{"name":"Redis","slug":"Redis","permalink":"http://blog.crazylaw.cn/tags/Redis/"},{"name":"Impala","slug":"Impala","permalink":"http://blog.crazylaw.cn/tags/Impala/"},{"name":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒRabbitmq","slug":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒRabbitmq","permalink":"http://blog.crazylaw.cn/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8CRabbitmq/"},{"name":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","slug":"æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒKafka","permalink":"http://blog.crazylaw.cn/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8CKafka/"},{"name":"Linux","slug":"Linux","permalink":"http://blog.crazylaw.cn/tags/Linux/"},{"name":"Swoole","slug":"Swoole","permalink":"http://blog.crazylaw.cn/tags/Swoole/"},{"name":"å¤§æ•°æ®ï¼Œæµå¼è®¡ç®—","slug":"å¤§æ•°æ®ï¼Œæµå¼è®¡ç®—","permalink":"http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%B5%81%E5%BC%8F%E8%AE%A1%E7%AE%97/"},{"name":"TCP","slug":"TCP","permalink":"http://blog.crazylaw.cn/tags/TCP/"},{"name":"Redisï¼Œæºç å‰–æ","slug":"Redisï¼Œæºç å‰–æ","permalink":"http://blog.crazylaw.cn/tags/Redis%EF%BC%8C%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"Cè¯­è¨€","slug":"Cè¯­è¨€","permalink":"http://blog.crazylaw.cn/tags/C%E8%AF%AD%E8%A8%80/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"http://blog.crazylaw.cn/tags/%E7%AE%97%E6%B3%95/"},{"name":"LeeCode","slug":"LeeCode","permalink":"http://blog.crazylaw.cn/tags/LeeCode/"},{"name":"APIç½‘å…³","slug":"APIç½‘å…³","permalink":"http://blog.crazylaw.cn/tags/API%E7%BD%91%E5%85%B3/"},{"name":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","slug":"æœåŠ¡æ³¨å†Œå’Œå‘ç°","permalink":"http://blog.crazylaw.cn/tags/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/"},{"name":"nginx","slug":"nginx","permalink":"http://blog.crazylaw.cn/tags/nginx/"},{"name":"PHP","slug":"PHP","permalink":"http://blog.crazylaw.cn/tags/PHP/"},{"name":"k8s","slug":"k8s","permalink":"http://blog.crazylaw.cn/tags/k8s/"},{"name":"Rust","slug":"Rust","permalink":"http://blog.crazylaw.cn/tags/Rust/"},{"name":"Shell","slug":"Shell","permalink":"http://blog.crazylaw.cn/tags/Shell/"},{"name":"Python","slug":"Python","permalink":"http://blog.crazylaw.cn/tags/Python/"},{"name":"æµ‹è¯•","slug":"æµ‹è¯•","permalink":"http://blog.crazylaw.cn/tags/%E6%B5%8B%E8%AF%95/"},{"name":"jsonschema","slug":"jsonschema","permalink":"http://blog.crazylaw.cn/tags/jsonschema/"},{"name":"Laravel","slug":"Laravel","permalink":"http://blog.crazylaw.cn/tags/Laravel/"},{"name":"Nginx","slug":"Nginx","permalink":"http://blog.crazylaw.cn/tags/Nginx/"},{"name":"Openresty","slug":"Openresty","permalink":"http://blog.crazylaw.cn/tags/Openresty/"},{"name":"è¿›åˆ¶","slug":"è¿›åˆ¶","permalink":"http://blog.crazylaw.cn/tags/%E8%BF%9B%E5%88%B6/"},{"name":"ssl","slug":"ssl","permalink":"http://blog.crazylaw.cn/tags/ssl/"},{"name":"æ­£åˆ™","slug":"æ­£åˆ™","permalink":"http://blog.crazylaw.cn/tags/%E6%AD%A3%E5%88%99/"},{"name":"Git","slug":"Git","permalink":"http://blog.crazylaw.cn/tags/Git/"},{"name":"åè®®","slug":"åè®®","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%8F%E8%AE%AE/"},{"name":"ç½‘ç»œ","slug":"ç½‘ç»œ","permalink":"http://blog.crazylaw.cn/tags/%E7%BD%91%E7%BB%9C/"},{"name":"Crontab","slug":"Crontab","permalink":"http://blog.crazylaw.cn/tags/Crontab/"},{"name":"MongoDb","slug":"MongoDb","permalink":"http://blog.crazylaw.cn/tags/MongoDb/"},{"name":"ç½‘ç»œï¼Œå¼‚æ­¥","slug":"ç½‘ç»œï¼Œå¼‚æ­¥","permalink":"http://blog.crazylaw.cn/tags/%E7%BD%91%E7%BB%9C%EF%BC%8C%E5%BC%82%E6%AD%A5/"},{"name":"å…¨æ–‡æœç´¢","slug":"å…¨æ–‡æœç´¢","permalink":"http://blog.crazylaw.cn/tags/%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2/"},{"name":"æ ‘","slug":"æ ‘","permalink":"http://blog.crazylaw.cn/tags/%E6%A0%91/"},{"name":"TcpDump","slug":"TcpDump","permalink":"http://blog.crazylaw.cn/tags/TcpDump/"},{"name":"ç¼–è¯‘å®‰è£…","slug":"ç¼–è¯‘å®‰è£…","permalink":"http://blog.crazylaw.cn/tags/%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"},{"name":"Centos7","slug":"Centos7","permalink":"http://blog.crazylaw.cn/tags/Centos7/"},{"name":"Systemctl","slug":"Systemctl","permalink":"http://blog.crazylaw.cn/tags/Systemctl/"},{"name":"ascii","slug":"ascii","permalink":"http://blog.crazylaw.cn/tags/ascii/"},{"name":"Promise","slug":"Promise","permalink":"http://blog.crazylaw.cn/tags/Promise/"},{"name":"ES6","slug":"ES6","permalink":"http://blog.crazylaw.cn/tags/ES6/"},{"name":"C","slug":"C","permalink":"http://blog.crazylaw.cn/tags/C/"},{"name":"IDå‘å·å™¨","slug":"IDå‘å·å™¨","permalink":"http://blog.crazylaw.cn/tags/ID%E5%8F%91%E5%8F%B7%E5%99%A8/"},{"name":"MQ","slug":"MQ","permalink":"http://blog.crazylaw.cn/tags/MQ/"},{"name":"è®¾è®¡æ¨¡å¼ï¼ŒPHP","slug":"è®¾è®¡æ¨¡å¼ï¼ŒPHP","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%8CPHP/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"http://blog.crazylaw.cn/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"},{"name":"åŠ¨æ€è§„åˆ’","slug":"åŠ¨æ€è§„åˆ’","permalink":"http://blog.crazylaw.cn/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"},{"name":"Hashå‡½æ•°","slug":"Hashå‡½æ•°","permalink":"http://blog.crazylaw.cn/tags/Hash%E5%87%BD%E6%95%B0/"},{"name":"è¯­è¨€åŒ…","slug":"è¯­è¨€åŒ…","permalink":"http://blog.crazylaw.cn/tags/%E8%AF%AD%E8%A8%80%E5%8C%85/"},{"name":"Ascii","slug":"Ascii","permalink":"http://blog.crazylaw.cn/tags/Ascii/"},{"name":"IP","slug":"IP","permalink":"http://blog.crazylaw.cn/tags/IP/"},{"name":"BSTæ ‘","slug":"BSTæ ‘","permalink":"http://blog.crazylaw.cn/tags/BST%E6%A0%91/"},{"name":"å¾ªç¯é˜Ÿåˆ—","slug":"å¾ªç¯é˜Ÿåˆ—","permalink":"http://blog.crazylaw.cn/tags/%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97/"},{"name":"PHPæ‰©å±•","slug":"PHPæ‰©å±•","permalink":"http://blog.crazylaw.cn/tags/PHP%E6%89%A9%E5%B1%95/"},{"name":"å•é“¾è¡¨","slug":"å•é“¾è¡¨","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%95%E9%93%BE%E8%A1%A8/"},{"name":"çº¿æ€§å­˜å‚¨ç»“æ„","slug":"çº¿æ€§å­˜å‚¨ç»“æ„","permalink":"http://blog.crazylaw.cn/tags/%E7%BA%BF%E6%80%A7%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/"},{"name":"å­¦ä¹ è®°å½•","slug":"å­¦ä¹ è®°å½•","permalink":"http://blog.crazylaw.cn/tags/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"},{"name":"JWT","slug":"JWT","permalink":"http://blog.crazylaw.cn/tags/JWT/"},{"name":"æµ‹è¯•å·¥å…·","slug":"æµ‹è¯•å·¥å…·","permalink":"http://blog.crazylaw.cn/tags/%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/"},{"name":"å‹åŠ›æµ‹è¯•","slug":"å‹åŠ›æµ‹è¯•","permalink":"http://blog.crazylaw.cn/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/"},{"name":"æ€§èƒ½æµ‹è¯•","slug":"æ€§èƒ½æµ‹è¯•","permalink":"http://blog.crazylaw.cn/tags/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"},{"name":"åšå®¢é¢ä¸–","slug":"åšå®¢é¢ä¸–","permalink":"http://blog.crazylaw.cn/tags/%E5%8D%9A%E5%AE%A2%E9%9D%A2%E4%B8%96/"}]}