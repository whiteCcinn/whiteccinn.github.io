<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【Golang】- 使用golang重写tga服务 | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="【Golang】- 使用golang重写tga服务"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>【Golang】- 使用golang重写tga服务</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2020/12/17/Golang/使用golang重写tga服务/" rel="bookmark">
        <time class="entry-date published" datetime="2020-12-17T01:46:51.000Z">
          2020-12-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>早期，在我们的部门中后端的技术栈语言主要有三种语言，分别是<code>php/python/erlang</code>，其中用于做服务的是 <code>php/erlang</code>。</p>
<p>在我们的体系中，日志采集服务体系目前都是用erlang写的，而php写的服务多是基于swoole写的一些基础服务。</p>
<p>在tga服务中，我们需要从<code>kafka</code> -&gt; <code>服务</code> -&gt; <code>本地文件</code>的模式。</p>
<p>业务据流图如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|                                                               |</span><br><span class="line">|                                                               |</span><br><span class="line">|       +---------------------------------------------+         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                  kafka服务                   |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       +----------------------+----------------------+         |</span><br><span class="line">|                              |                                |</span><br><span class="line">|                              |                                |</span><br><span class="line">|       +----------------------v-----------------------+        |                     +----------------------------+</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |               mthinkingdata服务               |        &lt;---------------------+          logbus服务        |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       +----------------------+-----------------------+        |                     +----------------------------+</span><br><span class="line">|                              |                                |</span><br><span class="line">|                              |                                |</span><br><span class="line">|       +----------------------v------------------------+       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                   本地文件                     +-------+</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       +-----------------------------------------------+       |</span><br><span class="line">|                                                               |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>


<p>于是我们试探性的自研基于swoole的kafka客户端，我们自己实现根据kafka协议的封包，解包，流程处理。(<code>swoole-kafka</code>)<br><code>mthinkingdata服务</code>就是我们基于<code>kafka-swoole</code>研发的业务服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+------------+</span><br><span class="line">|            |</span><br><span class="line">|  message1  +------------+</span><br><span class="line">|            |            |</span><br><span class="line">+------------+            |</span><br><span class="line">                          |</span><br><span class="line">+------------+     +------+--------+</span><br><span class="line">|            |     |               |</span><br><span class="line">|  message2  +-----+   snappy压缩   |</span><br><span class="line">|            |     |               |</span><br><span class="line">+------------+     +------+--------+</span><br><span class="line">                           |</span><br><span class="line">+---------------+          |</span><br><span class="line">|               |          |</span><br><span class="line">| message[3..n] +----------+</span><br><span class="line">|               |</span><br><span class="line">+---------------+</span><br></pre></td></tr></table></figure>

<p>在这个过程中，我们发现php对于cpu密集型的处理存在瓶颈，因为我们在生产者一方如果发送多条协议的情况下，会经过 <code>snappy</code> 算法的压缩再推送以便减少network-io（增加cpu-io）。<br>消费者在接受消息的时候也是被压缩过的数据，所以我们需要解压，在这个解压的过程中，是个十分消费cpu的过程，即使我们当时是基于swoole4.3的协程版本来处理，<br>不行的是的抢占式协程当时并没有很好的完成，我们没办法达到快速的接受多个数据包的行为。消费速度也并不是特别理想。<br>在这个大环境下，我们还需要借助redis来作为中间的存储。而redis是单线程的，我们在这个过程中，试过使用<code>pipeline</code>等手段减少tcp中的响应包的带来的性能损耗。但是由于redis只能利用单核的缘故，批量处理一批指令后，最高的cpu利用率接近100%下无法再增长。<br>也因此，我们的服务注定无法达到很好的性能测试。</p>
<p>我们得出结论，当时服务的瓶颈在于：</p>
<ul>
<li><ol>
<li>php语言本身的性能</li>
</ol>
</li>
<li><ol start="2">
<li>swoole协程不支持抢占式调度</li>
</ol>
</li>
<li><ol start="3">
<li>未实现动态伸缩扩展worker数量（感兴趣可以去看看kafka-swoole的架构分享）</li>
</ol>
</li>
<li><ol start="4">
<li>redis未能利用多核，cpu利用率达到峰值</li>
</ol>
</li>
</ul>
<a id="more"></a>

<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>针对以上几个问题，我们逐一得出解决方案</p>
<ul>
<li><ol>
<li>使用golang语言（语言优先在公司内部博客有比较）</li>
</ol>
</li>
<li><ol start="2">
<li>使用基于golang的嵌入式存储服务作为中间存储服务（<code>badger</code>）（<code>rocksdb</code>的使用在尝试中）</li>
</ol>
</li>
</ul>
<p>也因此催生出了使用golang重写tga服务（<code>mtga</code>）的需求。以其中一个项目开发为例子(项目编号：<code>24</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── _build                                 # 部署的目录结构</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── bin                                 </span><br><span class="line">│   │   └── mtga                           # 编译后的二进制文件</span><br><span class="line">│   ├── config</span><br><span class="line">│   │   ├── common.env</span><br><span class="line">│   │   ├── msource.yml</span><br><span class="line">│   │   ├── mtga.local.yml</span><br><span class="line">│   │   └── mtga.yml</span><br><span class="line">│   ├── mctl                               # 操作入口脚本</span><br><span class="line">│   ├── scripts</span><br><span class="line">│   │   └── init.sh                        # 第一次部署项目需要执行的初始化脚本</span><br><span class="line">│   ├── settings</span><br><span class="line">│   │   ├── mthinkingdata:filter.24.json</span><br><span class="line">│   │   └── mthinkingdata:metadata.24.json</span><br><span class="line">│   └── tmp</span><br><span class="line">├── _local_build                           # 本地开发部署的目录结构</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── bin</span><br><span class="line">│   │   └── mtga</span><br><span class="line">│   ├── config</span><br><span class="line">│   │   ├── common.env</span><br><span class="line">│   │   ├── msource.yml</span><br><span class="line">│   │   ├── mtga.local.yml</span><br><span class="line">│   │   └── mtga.yml</span><br><span class="line">│   ├── mctl</span><br><span class="line">│   ├── scripts</span><br><span class="line">│   │   └── init.sh</span><br><span class="line">│   ├── settings</span><br><span class="line">│   │   ├── mthinkingdata:filter.24.json</span><br><span class="line">│   │   └── mthinkingdata:metadata.24.json</span><br><span class="line">│   └── tmp</span><br><span class="line">├── build</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── Jenkinsfile</span><br><span class="line">│   └── README.md</span><br><span class="line">└── src</span><br><span class="line">    ├── Makefile                         # 便于构建服务</span><br><span class="line">    ├── app                              # 业务代码</span><br><span class="line">    │   ├── bussiness.go                 # 消费者的业务核心代码</span><br><span class="line">    │   ├── config</span><br><span class="line">    │   │   ├── app.go</span><br><span class="line">    │   │   ├── redis_keys.go</span><br><span class="line">    │   │   ├── setting_tools.go</span><br><span class="line">    │   │   └── settings.go</span><br><span class="line">    │   ├── main.go</span><br><span class="line">    │   └── reporter</span><br><span class="line">    │       └── notify.go</span><br><span class="line">    ├── cmd                              # cli终端命令</span><br><span class="line">    │   ├── clear_failure_queue.go       # 清理失败队列</span><br><span class="line">    │   ├── failure_queue_count.go       # 失败队列数量</span><br><span class="line">    │   ├── kafka_lag.go                 # 当前消费者阻塞总数据量</span><br><span class="line">    │   ├── offset_checker.go            # topic中各个partition的当前offset以及阻塞情况</span><br><span class="line">    │   ├── restart.go                   # 重启服务</span><br><span class="line">    │   ├── root.go</span><br><span class="line">    │   ├── start.go                     # 启动服务</span><br><span class="line">    │   ├── start_not_daemon.go          # 以非守护进程的方式启动服务</span><br><span class="line">    │   └── stop.go                      # 暂停服务</span><br><span class="line">    ├── config                           # 配置目录</span><br><span class="line">    │   ├── msource.yml</span><br><span class="line">    │   ├── mtga.local.yml</span><br><span class="line">    │   └── mtga.yml</span><br><span class="line">    ├── go.mod</span><br><span class="line">    ├── go.sum</span><br><span class="line">    ├── main.go</span><br><span class="line">    ├── settings</span><br><span class="line">    │   ├── mthinkingdata:filter.24.json</span><br><span class="line">    │   └── mthinkingdata:metadata.24.json</span><br><span class="line">    └── test</span><br><span class="line">        ├── setting_test.go</span><br><span class="line">        └── setting_tools_test.go</span><br></pre></td></tr></table></figure>

<blockquote>
<p>早期我们还没抛弃redis的时候，持续占用cpu100%的话就会出现这个。如果不用pipe模式的话，tps测试只有2500-3500之间。<br>抛弃redis使用了badger之后， 结合业务逻辑，tps:1w/s左右</p>
</blockquote>
<p>其中用到内部的组件包含如下：</p>
<ul>
<li>commentjson</li>
<li>go-graceful-daemon</li>
<li>logbdev</li>
<li>metl-sdk</li>
<li>msink</li>
<li>msource</li>
</ul>
<h2 id="mtga-amp-amp-msource"><a href="#mtga-amp-amp-msource" class="headerlink" title="mtga &amp;&amp; msource"></a>mtga &amp;&amp; msource</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转换前</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"headers"</span>:&#123;</span><br><span class="line">        <span class="attr">"app_id"</span>:<span class="number">24</span>,</span><br><span class="line">        <span class="attr">"log_name"</span>:<span class="string">"log_item"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"logs"</span>:&#123;</span><br><span class="line">        <span class="attr">"account_name"</span>:<span class="string">"4866014107"</span>,</span><br><span class="line">        <span class="attr">"action"</span>:<span class="number">2146</span>,</span><br><span class="line">        <span class="attr">"agent_id"</span>:<span class="number">36</span>,</span><br><span class="line">        <span class="attr">"amount"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"bag_amount"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"bag_type"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"bind_type"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"client_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"device_id"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"end_time"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"idfa"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"imei"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"is_internal"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"item_id"</span>:<span class="number">31103003</span>,</span><br><span class="line">        <span class="attr">"mac"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"mtime"</span>:<span class="number">1608184243</span>,</span><br><span class="line">        <span class="attr">"pid"</span>:<span class="number">1608184244000008</span>,</span><br><span class="line">        <span class="attr">"platform"</span>:<span class="number">3100</span>,</span><br><span class="line">        <span class="attr">"quality"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"regrow"</span>:<span class="number">14</span>,</span><br><span class="line">        <span class="attr">"role_id"</span>:<span class="number">6001310009300</span>,</span><br><span class="line">        <span class="attr">"role_level"</span>:<span class="number">800</span>,</span><br><span class="line">        <span class="attr">"server_id"</span>:<span class="number">5001</span>,</span><br><span class="line">        <span class="attr">"server_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"sn"</span>:<span class="string">"205914E03BF640CB76"</span>,</span><br><span class="line">        <span class="attr">"star"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"start_time"</span>:<span class="number">1608184243</span>,</span><br><span class="line">        <span class="attr">"upf"</span>:<span class="number">3100</span>,</span><br><span class="line">        <span class="attr">"via"</span>:<span class="string">"36|3100"</span>,</span><br><span class="line">        <span class="attr">"zero_dateline"</span>:<span class="number">1608134400</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换后</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"#account_id"</span>:<span class="string">"10289100005300x"</span>,</span><br><span class="line">    <span class="attr">"#distinct_id"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"#event_name"</span>:<span class="string">"t_log_item"</span>,</span><br><span class="line">    <span class="attr">"#ip"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"#time"</span>:<span class="string">"2020-12-17 13:52:39"</span>,</span><br><span class="line">    <span class="attr">"#type"</span>:<span class="string">"track"</span>,</span><br><span class="line">    <span class="attr">"properties"</span>:&#123;</span><br><span class="line">        <span class="attr">"account_name"</span>:<span class="string">"1608153237001005108"</span>,</span><br><span class="line">        <span class="attr">"action"</span>:<span class="number">1005</span>,</span><br><span class="line">        <span class="attr">"agent_id"</span>:<span class="number">11</span>,</span><br><span class="line">        <span class="attr">"amount"</span>:<span class="number">-1</span>,</span><br><span class="line">        <span class="attr">"bag_amount"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"bag_type"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"bind_type"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"client_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"device_id"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"end_time"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"idfa"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"imei"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"is_internal"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"item_id"</span>:<span class="number">10203101</span>,</span><br><span class="line">        <span class="attr">"mac"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"mtime"</span>:<span class="number">1608184359</span>,</span><br><span class="line">        <span class="attr">"pid"</span>:<span class="number">1608184359000031</span>,</span><br><span class="line">        <span class="attr">"platform"</span>:<span class="number">101</span>,</span><br><span class="line">        <span class="attr">"quality"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"regrow"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"role_id"</span>:<span class="number">110289100005300</span>,</span><br><span class="line">        <span class="attr">"role_level"</span>:<span class="number">160</span>,</span><br><span class="line">        <span class="attr">"server_id"</span>:<span class="number">289</span>,</span><br><span class="line">        <span class="attr">"server_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"sn"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"star"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"start_time"</span>:<span class="number">1608184359</span>,</span><br><span class="line">        <span class="attr">"upf"</span>:<span class="number">101</span>,</span><br><span class="line">        <span class="attr">"via"</span>:<span class="string">"11|101"</span>,</span><br><span class="line">        <span class="attr">"zero_dateline"</span>:<span class="number">1608134400</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据在<code>msource</code>到<code>mtga</code>的交互</p>
<p>改版前：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                       +-----------------------------------------+</span><br><span class="line">                       | +---------+                             |</span><br><span class="line">                       | | msource |                             |</span><br><span class="line">                       | +---------+                             |</span><br><span class="line">                       |                                         |</span><br><span class="line">                       |    +--------------------------------+   |</span><br><span class="line">                       |    |                                |   |</span><br><span class="line">                       |    |       spoutKafka(channel)      |   |</span><br><span class="line">                       |    |                                +-&gt;X+-------------------------+</span><br><span class="line">                       |    |                                |   |                         |</span><br><span class="line">                       |    +-------------^----------^-------+   |           +-------------v----------------+</span><br><span class="line">                       |                  |          |           |           |-----------+                  |</span><br><span class="line">                       |                  |          |           |           || 业务服务 |                   |</span><br><span class="line">                       |                  |          |           |           +-----------+                  |</span><br><span class="line">+------------+         |                  |          |           |           |                              |</span><br><span class="line">|            |         |    +--------------------------------+   |           |      XXXXXXXXXXXXXXX         |</span><br><span class="line">|   kafka    +---------&gt;X+  | +-------+   |          |       |   |           |      X1.过滤的数据 X          |</span><br><span class="line">|            |         | |  | | badge |   |          |       |   |           |      XXXXXXXXXXXXXXX         |</span><br><span class="line">+------------+         | |  | +-------+   |          |       |   |           |                              |</span><br><span class="line">                       | |  |             |          |       |   |           |                              |</span><br><span class="line">                       | |  |      +------+-------+  |       |   |           |      +---------------+       |</span><br><span class="line">                       | ^---------&gt;              |  |       | ^--------------------+2.失败的数据     |       |</span><br><span class="line">                       |    |      |  等待ack队列   &lt;-----^   | | |           |      +---------------+       |</span><br><span class="line">                       |    |      |              |  |  |    | | |           |                              |</span><br><span class="line">                       |    |      +--------------+  |  |    | | |           |                              |</span><br><span class="line">                       |    |                        |  |    | | |           |                              |</span><br><span class="line">                       |    |      +--------------+  |  |    | | |           |     +------------------+     |</span><br><span class="line">                       |    |      |              +--^  &lt;--------------------------+3.正常处理完的数据   |     |</span><br><span class="line">                       |    |      |  业务失败队列  |          | | |           |     +------------------+     |</span><br><span class="line">                       |    |      |              &lt;------------v |           |                              |</span><br><span class="line">                       |    |      +--------------+          |   |           +------------------------------+</span><br><span class="line">                       |    +--------------------------------+   |</span><br><span class="line">                       +-----------------------------------------+</span><br></pre></td></tr></table></figure>

<p>改版后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                       +-----------------------------------------+</span><br><span class="line">                       | +---------+                             |           +-----------------------+</span><br><span class="line">                       | | msource |                             |           |                       |</span><br><span class="line">                       | +---------+                             |           |  特定条件下提交offse    &lt;----------+</span><br><span class="line">                       |                                         |           |                       |          |</span><br><span class="line">                       |    +--------------------------------+   |           +-----------------------+          |</span><br><span class="line">                       |    |                                |   |                                              |</span><br><span class="line">                       | +--&gt;       spoutKafka(channel)      |   |                                              |</span><br><span class="line">                       | |  |        （有缓冲）                +-&gt;X+-------------------------+                    |</span><br><span class="line">                       | |  |                                |   |                         |                    |</span><br><span class="line">                       | |  +------------------------^-------+   |           +-------------v----------------+   |</span><br><span class="line">                       | |                           |           |           |-----------+                  |   |</span><br><span class="line">                       | |                           |           |           || 业务服务  |                  |   |</span><br><span class="line">                       | |                           |           |           +-----------+                  |   |</span><br><span class="line">+------------+         | |                           |           |           |                              |   |</span><br><span class="line">|            |         | |  +--------------------------------+   |           |      XXXXXXXXXXXXXXX         |   |</span><br><span class="line">|   kafka    +---------&gt;X+  | +-------+              |       |   |           |      X1.过滤的数据   X         |   |</span><br><span class="line">|            |         |    | | badge |              |       |   |           |      XXXXXXXXXXXXXXX         |   |</span><br><span class="line">+------------+         |    | +-------+     ^--------&gt;       |   |           |                              |   |</span><br><span class="line">                       |    |               |                |   |           |                              |   |</span><br><span class="line">                       |    |       +-------+------+         |   |           |      +---------------+       |   |</span><br><span class="line">                       |    |       |              &lt;-----------+X+------------------+2.失败的数据     |       |   |</span><br><span class="line">                       |    |       |  业务失败队列  |         |   |           |      +---------------+       |   |</span><br><span class="line">                       |    |       |              |         |   |           |                              |   |</span><br><span class="line">                       |    |       +--------------+         |   |           |                              |   |</span><br><span class="line">                       |    |                                |   |           |                              |   |</span><br><span class="line">                       |    |                                |   |           |     +------------------+     |   |</span><br><span class="line">                       |    +--------------------------------+   |           |     |3.正常处理完的数据   +---------&gt;</span><br><span class="line">                       |                                         |           |     +------------------+     |</span><br><span class="line">                       |                                         |           |                              |</span><br><span class="line">                       |                                         |           +------------------------------+</span><br><span class="line">                       |                                         |</span><br><span class="line">                       +-----------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>每10s记录一次本地offset</li>
<li>接收到信号量（<code>SIGINT/SIGTERM</code>）到时候也提交一次</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收到信号量到时候也提交一次</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">  signal.Notify(ch, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">  <span class="keyword">for</span> _ = <span class="keyword">range</span> ch &#123;</span><br><span class="line">    t.Stop()</span><br><span class="line">    logic.ackf.RLock()</span><br><span class="line">    <span class="keyword">for</span> _, partitionMessage := <span class="keyword">range</span> logic.acks &#123;</span><br><span class="line">      <span class="keyword">for</span> _,msg := <span class="keyword">range</span> partitionMessage &#123;</span><br><span class="line">        logic.Sk.Ack(msg)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    logic.ackf.RUnlock()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每10s记录一次本地offset</span></span><br><span class="line">t := time.NewTicker(<span class="number">10</span> * time.Second)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">      logic.ackf.RLock()</span><br><span class="line">      <span class="keyword">for</span> _, partitionMessage := <span class="keyword">range</span> logic.acks &#123;</span><br><span class="line">        <span class="keyword">for</span> _,msg := <span class="keyword">range</span> partitionMessage &#123;</span><br><span class="line">          logic.Sk.Ack(msg)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      logic.ackf.RUnlock()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务worker启动核心逻辑</span></span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">logic := <span class="built_in">new</span>(CoreLogic)</span><br><span class="line">logic.Sk = sk</span><br><span class="line">logic.acks = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">int32</span>]*kafka.Message&#123;&#125;</span><br><span class="line">logic.ackf = sync.RWMutex&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; config.AppConfig.Worker; &#123;</span><br><span class="line">		wg.Add(<span class="number">1</span>)</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wg.Done()</span><br><span class="line">			logic.Consume()</span><br><span class="line">		&#125;()</span><br><span class="line">		i++</span><br><span class="line">	&#125;</span><br><span class="line">wg.Wait()</span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bussiness.go 的核心代码</span></span><br><span class="line"><span class="keyword">type</span> CoreLogic <span class="keyword">struct</span> &#123;</span><br><span class="line">	Sk *msource.SpoutKafka</span><br><span class="line"></span><br><span class="line">	ackf sync.RWMutex</span><br><span class="line">	acks <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">int32</span>]*kafka.Message</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(business *CoreLogic)</span> <span class="title">Consume</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 从正常队列来的数据</span></span><br><span class="line">	<span class="keyword">if</span> msg.TopicPartition.Topic != <span class="literal">nil</span> &#123;</span><br><span class="line">			business.ackf.Lock()</span><br><span class="line">			<span class="keyword">if</span> _, ok := business.acks[*msg.TopicPartition.Topic]; !ok &#123;</span><br><span class="line">				business.acks[*msg.TopicPartition.Topic] = <span class="keyword">map</span>[<span class="keyword">int32</span>]*kafka.Message&#123;&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			business.acks[*msg.TopicPartition.Topic][msg.TopicPartition.Partition] = msg</span><br><span class="line">			business.ackf.Unlock()</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 从失败队列来的数据，独立写入，独立Ack</span></span><br><span class="line">		err = p.Write(fileName, <span class="keyword">string</span>(sinkBuffer))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logbdev.Error(err)</span><br><span class="line">		&#125;</span><br><span class="line">			business.Sk.Ack(msg)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们的消费者需要从<code>msource</code>中把消息拉出来，所以设置了一个<code>Corelogic</code>的结构体，其中包含了 <code>sk</code>,<code>acks</code>,<code>ackf</code>三个属性。</p>
<blockquote>
<p>由于我们需要异步的提交offset，所以需要设置 ackf 的锁来确保数据的完整性</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取消息的方式</span></span><br><span class="line"><span class="keyword">for</span> msg := <span class="keyword">range</span> business.Sk.MessageChan() &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>golang的格式化时间戳很奇葩，需要以<code>&quot;2006-01-02 15:04:05&quot;</code>为格式进行格式化。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// yyyy-MM-dd hh:mm:ss</span></span><br><span class="line"><span class="comment">// yyyy-MM-dd H:i:s</span></span><br><span class="line"></span><br><span class="line">jsonArray[<span class="string">"#time"</span>] = time.Unix(time.Now().Unix(), <span class="number">0</span>).Format(<span class="string">"2006-01-02 15:04:05"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="msource"><a href="#msource" class="headerlink" title="msource"></a>msource</h2><p><code>msource</code>是<code>kafka</code>和<code>本地存储</code>的桥梁(通信服务)，间接得做着服务可靠性的保证。（数据不丢，不重，方便查看堵塞情况）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mctl</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  mtga [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  clear_failure_queue 清空失败队列</span><br><span class="line">  failure_queue_count 失败队列数量</span><br><span class="line">  kafka_lag           消费阻塞</span><br><span class="line">  offset_checker      offset的情况</span><br></pre></td></tr></table></figure>

<p>以下命令都是msource提供出来的api，再由业务服务封装成命令</p>
<p>例如：offset_checker</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.---.----------------.-----------.------------.------------.------------.-----.</span><br><span class="line">| # |     Topic      | Partition |    Low     |    High    |  Current   | Lag |</span><br><span class="line">+---+----------------+-----------+------------+------------+------------+-----+</span><br><span class="line">| 0 | mulog_clean_24 | 0         | 6171720626 | 6197511755 | 6197511494 | 261 |</span><br><span class="line">| 1 | mulog_clean_24 | 1         | 6169152656 | 6197196879 | 6197196555 | 324 |</span><br><span class="line">| 2 | mulog_clean_24 | 2         | 6169656725 | 6195509715 | 6195509483 | 232 |</span><br><span class="line">| 3 | mulog_clean_24 | 3         | 6172416843 | 6197496752 | 6197496518 | 234 |</span><br><span class="line">| 4 | mulog_clean_24 | 4         | 6170706518 | 6197423974 | 6197423659 | 315 |</span><br><span class="line">| 5 | mulog_clean_24 | 5         | 6168091223 | 6196757252 | 6196756991 | 261 |</span><br><span class="line">&#39;---&#39;----------------&#39;-----------&#39;------------&#39;------------&#39;------------&#39;-----&#39;</span><br></pre></td></tr></table></figure>

<p>例如：kafka_lag/failure_queue_count</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1234</span><br></pre></td></tr></table></figure>

<p>msource如何做到由业务系统控制指定offset中消费呢？</p>
<p>我们还是通过了<code>badger</code>来存储各个topic-partition的offset。服务在启动的时候会取各个partition的offset，如果存在的话，就设置需要从对应的offset开始读取数据。如果不存在对应的offset的话，那么就根据你的策略从<code>最早</code>,<code>最近</code>开始选择拉取数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+</span><br><span class="line">|---------+         |</span><br><span class="line">|| badger |         |</span><br><span class="line">+---------+         +---------------+</span><br><span class="line">|                   |               |</span><br><span class="line">|      offset存储   |               |</span><br><span class="line">|                   |               |</span><br><span class="line">+-------------------+     +---------v-------------+</span><br><span class="line">                          |                       |      +------------+</span><br><span class="line">                          |  从partition拉取数据    +-----+   。。。。。。|</span><br><span class="line">                          |                       |      +------------+</span><br><span class="line">                          +---------+-------------+</span><br><span class="line">                                    |</span><br><span class="line">                                    |</span><br><span class="line">+-------------------+               |</span><br><span class="line">|                   |               |</span><br><span class="line">|      Kafka        &lt;---------------+</span><br><span class="line">|                   |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure>

<p>msource的工作原理在介绍mtga的时候基本也差不多介绍完了。至于这些api的实现是基于<code>Unix Socket</code>实现的。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sk *SpoutKafka)</span> <span class="title">unixSocketListen</span><span class="params">()</span></span> &#123;</span><br><span class="line">start:</span><br><span class="line">	lis, err := net.Listen(<span class="string">"unix"</span>, UNIX_SOCKET_FILE)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		logbdev.Info(<span class="string">"UNIX Domain Socket 创建失败，正在尝试重新创建 -&gt; "</span>, err)</span><br><span class="line">		err = os.Remove(UNIX_SOCKET_FILE)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logbdev.Info(<span class="string">"删除 sock 文件失败！程序退出 -&gt; "</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">goto</span> start</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		logbdev.Info(<span class="string">"创建 UNIX Domain Socket 成功"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		&lt;-sigs</span><br><span class="line">		<span class="keyword">if</span> sk.SigTermCbNeed &#123;</span><br><span class="line">			sk.SigTermCb(<span class="literal">true</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		lis.Close()</span><br><span class="line">		os.Remove(UNIX_SOCKET_FILE)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	invokeObjectMethod := <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn, object <span class="keyword">interface</span>&#123;&#125;, methodName <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">		inputs := <span class="built_in">make</span>([]reflect.Value, <span class="built_in">len</span>(args))</span><br><span class="line">		<span class="keyword">for</span> i, _ := <span class="keyword">range</span> args &#123;</span><br><span class="line">			inputs[i] = reflect.ValueOf(args[i])</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		intCb := <span class="function"><span class="keyword">func</span><span class="params">(v reflect.Value)</span></span> &#123;</span><br><span class="line">			n, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"%d\n"</span>, v.Int())))</span><br><span class="line">			<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">				logbdev.Info(fmt.Sprintf(<span class="string">"Cmd: %s ,成功响应结果: %d"</span>, methodName, v.Int()))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				logbdev.Error(fmt.Sprintf(<span class="string">"Cmd: %s ,响应失败 %s"</span>, methodName, err))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		strCb := <span class="function"><span class="keyword">func</span><span class="params">(v reflect.Value)</span></span> &#123;</span><br><span class="line">			n, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"%s\n"</span>, v.String())))</span><br><span class="line">			<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">				logbdev.Info(fmt.Sprintf(<span class="string">"Cmd: %s ,成功响应结果: %s"</span>, methodName, v.String()))</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				logbdev.Error(fmt.Sprintf(<span class="string">"Cmd: %s ,响应失败 %s"</span>, methodName, err))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> _, v := <span class="keyword">range</span> reflect.ValueOf(object).MethodByName(methodName).Call(inputs) &#123;</span><br><span class="line">			<span class="keyword">switch</span> v.Kind() &#123;</span><br><span class="line">			<span class="keyword">case</span> reflect.Int:</span><br><span class="line">			<span class="keyword">case</span> reflect.Int64:</span><br><span class="line">				intCb(v)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">case</span> reflect.String:</span><br><span class="line">				strCb(v)</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				_, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"%s\n"</span>, <span class="string">"不支持的响应数据类型"</span>)))</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					handleError(err.Error())</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	handle := <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>)</span><br><span class="line">			n, err := conn.Read(buf)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 如果已经没数据了，则结束</span></span><br><span class="line">			<span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				logbdev.Info(<span class="string">"Socket conn read error:"</span>, err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> cmd Cmd</span><br><span class="line">			<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">				err := json.Unmarshal(buf[:n], &amp;cmd)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					_, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"Rpc-Json解析失败, err: %s"</span>, err) + <span class="string">"\n"</span>))</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						logbdev.Warn(err)</span><br><span class="line">						<span class="keyword">continue</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				invokeObjectMethod(conn, sk, cmd.RpcFuncName, cmd.Params...)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		conn, err := lis.Accept()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			logbdev.Info(<span class="string">"请求接收错误 -&gt; "</span>, err)</span><br><span class="line">			<span class="keyword">continue</span> <span class="comment">// 一个连接错误，不会影响整体的稳定性，忽略就好</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> handle(conn) <span class="comment">//开始处理数据</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前在mtga中出现过一个问题，那就是rpc超时问题的问题（socket超时）。这个问题导致了我们在执行各种命令的时候，如果出现问题会一直<code>hang up</code>的状态，得不到结果的同时一直卡住。影响到了我们对服务的监控。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------------+</span><br><span class="line">|   +-------------+                                        |</span><br><span class="line">|   |   msource   |                                        |</span><br><span class="line">|   +-------------+                                        |</span><br><span class="line">|                                                          |</span><br><span class="line">|   +---------------------+     +---------------------+    |</span><br><span class="line">|   |                     |     |                     |    |</span><br><span class="line">|   | unix socket server  |     | unix socket client  |    |</span><br><span class="line">|   |                     |     |                     |    |</span><br><span class="line">|   +---------------------+     +---------------------+    |</span><br><span class="line">+----------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>为了解决这个问题。我们在<code>unix socket client</code> 这里加了一个超时的机制。借助是<code>context</code>的机制，实现协程之间的超时通信。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	TimeoutMsg = <span class="string">"操作超时, 请检查服务状态!"</span></span><br><span class="line">	TimeoutInt = <span class="number">-1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">rcn := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), time.Second*<span class="number">10</span>)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> exists(UNIX_SOCKET_FILE) &#123;</span><br><span class="line">    conn, err := net.Dial(<span class="string">"unix"</span>, UNIX_SOCKET_FILE)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      handleError(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    rpc := Cmd&#123;RpcFuncName: <span class="string">"FailureQueueCount"</span>&#125;</span><br><span class="line">    data, err := json.Marshal(rpc)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      handleError(fmt.Sprintf(<span class="string">"encode-json失败"</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n, err := conn.Write(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> &amp;&amp; err == <span class="literal">nil</span> &#123;</span><br><span class="line">      reader := bufio.NewReader(conn)</span><br><span class="line">      msg, err := reader.ReadString(<span class="string">'\n'</span>)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logbdev.Info(err)</span><br><span class="line">      &#125;</span><br><span class="line">      msg = msg[:<span class="built_in">len</span>(msg)-<span class="built_in">len</span>(<span class="string">"\n"</span>)]</span><br><span class="line">      lagInt, err := strconv.Atoi(msg)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        handleError(err.Error())</span><br><span class="line">      &#125;</span><br><span class="line">      lag = <span class="keyword">int64</span>(lagInt)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sk := SourceToolRun(configOpts)</span><br><span class="line">    lag = sk.FailureQueueCount()</span><br><span class="line">  &#125;</span><br><span class="line">  rcn &lt;- <span class="literal">true</span></span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">    <span class="keyword">if</span> ctx.Err() != <span class="literal">nil</span> &#123;</span><br><span class="line">      logbdev.Warn(ctx.Err())</span><br><span class="line">      <span class="keyword">return</span> TimeoutInt</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> lag</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">case</span> &lt;- rcn:</span><br><span class="line">    <span class="keyword">return</span> lag</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是，这个<code>context.WithTimeout</code> 是不管你内部是否处理完毕，一定会在指定的时间内<code>timeout</code>，所以如果提前完成了必须通过自己的手段提前结束。</p>
<h2 id="msink"><a href="#msink" class="headerlink" title="msink"></a>msink</h2><p>这个组件的作用主要是用于把指定的消息进行sink到各种<code>终端</code>，例如<code>msink_file</code>,<code>msink_kafka</code>等等。</p>
<p>目前我们是封装在同一个仓库中，以不同文件保存，后续，我们或许会考虑拆分开来便于维护发版。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">├── Dockerfile</span><br><span class="line">├── README.MD</span><br><span class="line">├── config.go</span><br><span class="line">├── config.yml</span><br><span class="line">├── config_test.go</span><br><span class="line">├── error.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── msource_spout.go</span><br><span class="line">├── msource_spout_test.go</span><br><span class="line">└── rpc.go</span><br></pre></td></tr></table></figure>


<p>这里主要和大家说以下<code>msink_file</code>吧，<code>msink_kafka</code>的实现原理差不多。</p>
<ul>
<li>支持自定义回调函数，判断是否写入成功</li>
<li>支持批处理和流式处理</li>
</ul>
<p>流式处理有独立的Api</p>
<ul>
<li><code>func (f *FileClient) WriteWithoutEol(filePath string, message string) error</code></li>
<li><code>func (f *FileClient) Write(filePath string, message string) error</code></li>
<li><code>(f *FileClient) BatchLineDataChannel() chan&lt;- map[Filename]ChannelMessage</code></li>
</ul>
<p>批处理的Api</p>
<ul>
<li><code>(f *FileClient) BatchLineDataChannel() chan&lt;- map[Filename]ChannelMessage</code></li>
</ul>
<p>可能细心的朋友已经发现了，流式处理的Api包含了批处理的Api。<br>是的，被包含在一起了，为什么会这样子？</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFileClient</span><span class="params">(client afero.Fs, opts ...DialOption)</span> *<span class="title">FileClient</span></span> &#123;</span><br><span class="line">	p := <span class="built_in">new</span>(FileClient)</span><br><span class="line">	p.client = client</span><br><span class="line">	p.dopts = defaultOptions()</span><br><span class="line">	p.batchLineDataChannel = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">map</span>[Filename]ChannelMessage, <span class="number">1000</span>)</span><br><span class="line">	p.events = <span class="built_in">make</span>(<span class="keyword">chan</span> FileMetaMessage, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//循环调用opts</span></span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		opt.apply(&amp;p.dopts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> writer <span class="function"><span class="keyword">func</span><span class="params">(fileClient *FileClient)</span></span></span><br><span class="line">	<span class="keyword">if</span> p.dopts.batchWrite &#123;</span><br><span class="line">		writer = channelBatchWriter</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		writer = channelWriter</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	p.wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		writer(p)</span><br><span class="line">		p.wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	p.wg.Add(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		p.run()</span><br><span class="line">		p.wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 流式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelWriter</span><span class="params">(client *FileClient)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> m := <span class="keyword">range</span> client.batchLineDataChannel &#123;</span><br><span class="line">		<span class="keyword">for</span> fn, msg := <span class="keyword">range</span> m &#123;</span><br><span class="line">			err := client.WriteWithoutEol(<span class="keyword">string</span>(fn), <span class="keyword">string</span>(msg))</span><br><span class="line">			client.events &lt;- FileMetaMessage&#123;Message: <span class="keyword">string</span>(msg), Error: err&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelBatchWriter</span><span class="params">(client *FileClient)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> buffered = <span class="built_in">make</span>(<span class="keyword">map</span>[Filename][]ChannelMessage)</span><br><span class="line">	bufferedCnt := <span class="number">0</span></span><br><span class="line">	batchSize := client.dopts.batchLineDataChannelCount</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> m := <span class="keyword">range</span> client.batchLineDataChannel &#123;</span><br><span class="line">		<span class="keyword">for</span> fn, msg := <span class="keyword">range</span> m &#123;</span><br><span class="line">			buffered[fn] = <span class="built_in">append</span>(buffered[fn], msg)</span><br><span class="line">			bufferedCnt++</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	loop:</span><br><span class="line">		<span class="keyword">for</span> <span class="literal">true</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> m, ok := &lt;-client.batchLineDataChannel:</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					<span class="keyword">break</span> loop</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> m == <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="built_in">panic</span>(<span class="string">"nil message received on batchLineDataChannel"</span>)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">for</span> fn, msg := <span class="keyword">range</span> m &#123;</span><br><span class="line">					buffered[fn] = <span class="built_in">append</span>(buffered[fn], msg)</span><br><span class="line">					bufferedCnt++</span><br><span class="line">					<span class="keyword">if</span> bufferedCnt &gt; batchSize &#123;</span><br><span class="line">						<span class="keyword">break</span> loop</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">break</span> loop</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> tmpLongMsg = <span class="built_in">make</span>(<span class="keyword">map</span>[Filename]<span class="keyword">string</span>)</span><br><span class="line">		<span class="keyword">for</span> Filename, ChannelMessageList := <span class="keyword">range</span> buffered &#123;</span><br><span class="line">			tmpMsg := <span class="string">""</span></span><br><span class="line">			<span class="keyword">for</span> _, cm := <span class="keyword">range</span> ChannelMessageList &#123;</span><br><span class="line">				tmpMsg += <span class="keyword">string</span>(cm)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			tmpLongMsg[Filename] = tmpMsg</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> Filename, longMsg := <span class="keyword">range</span> tmpLongMsg &#123;</span><br><span class="line">			err := client.WriteWithoutEol(<span class="keyword">string</span>(Filename), longMsg)</span><br><span class="line">			<span class="keyword">for</span> _, ChannelMessageList := <span class="keyword">range</span> buffered &#123;</span><br><span class="line">				<span class="keyword">for</span> _, cm := <span class="keyword">range</span> ChannelMessageList &#123;</span><br><span class="line">					client.events &lt;- FileMetaMessage&#123;Message: <span class="keyword">string</span>(cm), Error: err&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		buffered = <span class="built_in">make</span>(<span class="keyword">map</span>[Filename][]ChannelMessage)</span><br><span class="line">		bufferedCnt = <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到这里大家应该也知道Api应该就可以理解为什么会被包含在一起了。</p>
<h2 id="logdev"><a href="#logdev" class="headerlink" title="logdev"></a>logdev</h2><p>这是我们的日志组件，在上面的代码中，多多少少已经有了这个组件的身影。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── exported.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── hooks</span><br><span class="line">│   ├── reporter</span><br><span class="line">│   │   ├── metl.go</span><br><span class="line">│   │   ├── reporter.go</span><br><span class="line">│   │   └── reporter_test.go</span><br><span class="line">│   └── stacker</span><br><span class="line">│       ├── stacker.go</span><br><span class="line">│       └── stacker_test.go</span><br><span class="line">├── logbdev.go</span><br><span class="line">├── logbdev_test.go</span><br><span class="line">├── logger.go</span><br><span class="line">├── mc_formatter.go</span><br></pre></td></tr></table></figure>

<p>常规设置，主要是我们在这个组件中添加了几个<code>hook</code>，分别是<code>reporter</code>,<code>stacker</code></p>
<ul>
<li><p>reporter （设置需要上报日志的级别，用于如果发现了<code>error</code>级别的错误就推送日志到我们的<code>告警服务</code>中。）</p>
</li>
<li><p>stacker （设置需要输出堆栈的级别日志级别）</p>
</li>
</ul>
<p>日志存储的方式有几种</p>
<ul>
<li><ol>
<li>常规的单日志存储</li>
</ol>
</li>
<li><ol start="2">
<li>日志按照大小轮转</li>
</ol>
</li>
<li><ol start="3">
<li>日志按照日期轮转</li>
</ol>
</li>
</ul>
<h2 id="commentjson"><a href="#commentjson" class="headerlink" title="commentjson"></a>commentjson</h2><p>这个是用来解析包含了<code>换行符</code>,<code>空白行</code>,<code>行注释</code>,<code>段注释</code>等等的<code>json</code>字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── hjson.go</span><br><span class="line">├── hjson_test.go</span><br><span class="line">└── test.json</span><br></pre></td></tr></table></figure>

<p>这个原理也比较简单，就是一个个字符去匹配，重新构造出一个新的合法的json格式。里面的单元测试也做得比较完善了。</p>
<h2 id="go-graceful-daemon"><a href="#go-graceful-daemon" class="headerlink" title="go-graceful-daemon"></a>go-graceful-daemon</h2><p>这个组件是用来将服务变成守护进程用的。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── daemon.<span class="keyword">go</span></span><br><span class="line">├── <span class="keyword">go</span>.mod</span><br><span class="line">├── <span class="keyword">go</span>.mod2</span><br><span class="line">├── signal.<span class="keyword">go</span></span><br><span class="line">└── test</span><br><span class="line">    └── test.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>这里的核心主要是借助了<code>syscall</code>的<code>ForkExec</code>实现。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">forkDaemon</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	args := os.Args</span><br><span class="line">	os.Setenv(<span class="string">"__Daemon"</span>, <span class="string">"true"</span>)</span><br><span class="line">	procAttr := &amp;syscall.ProcAttr&#123;</span><br><span class="line">		Env:   os.Environ(),</span><br><span class="line">	&#125;</span><br><span class="line">	pid, err := syscall.ForkExec(os.Args[<span class="number">0</span>], args, procAttr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">"[%d] %s start daemon\n"</span>, pid, AppName)</span><br><span class="line">	savePid(pid)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并且支持自定实现信号量的捕捉处理逻辑</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ErrStop = errors.New(<span class="string">"stop serve signals"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SignalHandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(sig os.Signal)</span> <span class="params">(err error)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetSigHandler</span><span class="params">(handler SignalHandlerFunc, signals ...os.Signal)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, sig := <span class="keyword">range</span> signals &#123;</span><br><span class="line">		handlers[sig] = handler</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServeSignals calls handlers for system signals.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ServeSignals</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	signals := <span class="built_in">make</span>([]os.Signal, <span class="number">0</span>, <span class="built_in">len</span>(handlers))</span><br><span class="line">	<span class="keyword">for</span> sig := <span class="keyword">range</span> handlers &#123;</span><br><span class="line">		signals = <span class="built_in">append</span>(signals, sig)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">8</span>)</span><br><span class="line">	signal.Notify(ch, signals...)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> sig := <span class="keyword">range</span> ch &#123;</span><br><span class="line">		err = handlers[sig](sig)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	signal.Stop(ch)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err == ErrStop &#123;</span><br><span class="line">		err = <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handlers = <span class="built_in">make</span>(<span class="keyword">map</span>[os.Signal]SignalHandlerFunc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	handlers[syscall.SIGINT] = sigtermDefaultHandler</span><br><span class="line">	handlers[syscall.SIGTERM] = sigtermDefaultHandler</span><br><span class="line">	handlers[syscall.SIGHUP] = sighupDefaultHandler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sigtermDefaultHandler</span><span class="params">(sig os.Signal)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"[%d] %s stop graceful"</span>, os.Getpid(), AppName)</span><br><span class="line">	log.Printf(<span class="string">"[%d] %s stopped."</span>, os.Getpid(), AppName)</span><br><span class="line">	os.Remove(PidFile)</span><br><span class="line">	os.Exit(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> ErrStop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sighupDefaultHandler</span><span class="params">(sig os.Signal)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">//only deamon时不支持kill -HUP,因为可能监听地址会占用</span></span><br><span class="line">	log.Printf(<span class="string">"[%d] %s stopped."</span>, os.Getpid(), AppName)</span><br><span class="line">	os.Remove(PidFile)</span><br><span class="line">	os.Exit(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">return</span> ErrStop</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>目前内置了<code>SIGINT</code>,<code>SIGTERM</code>,<code>SIGHUP</code>的默认行为</p>
</blockquote>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/Golang/">Golang</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Golang/">Golang</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2025 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>