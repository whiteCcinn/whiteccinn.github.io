<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【服务注册和发现】- Consul | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="【服务注册和发现】- Consul"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>【服务注册和发现】- Consul</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/07/04/服务注册和发现/consul/" rel="bookmark">
        <time class="entry-date published" datetime="2019-07-04T03:15:00.000Z">
          2019-07-04
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>服务注册与服务发现是在分布式服务架构中常常会涉及到的东西，业界常用的服务注册与服务发现工具有 <a href="https://zookeeper.apache.org/" target="_blank" rel="noopener">ZooKeeper</a>、<a href="https://etcd.io/" target="_blank" rel="noopener">etcd</a>、<a href="https://www.consul.io/" target="_blank" rel="noopener">Consul</a> 和 <a href="https://github.com/Netflix/eureka" target="_blank" rel="noopener">Eureka</a>。Consul 的主要功能有服务发现、健康检查、KV 存储、安全服务沟通和多数据中心。Consul 与其他几个工具的区别可以在这里查看 <a href="https://www.consul.io/intro/vs/index.html" target="_blank" rel="noopener">Consul vs. Other Software。</a></p>
<a id="more"></a>

<h2 id="为什么需要有服务注册与服务发现？"><a href="#为什么需要有服务注册与服务发现？" class="headerlink" title="为什么需要有服务注册与服务发现？"></a>为什么需要有服务注册与服务发现？</h2><p>假设在分布式系统中有两个服务 Service-A （下文以“S-A”代称）和 Service-B（下文以“S-B”代称），当 S-A 想调用 S-B 时，我们首先想到的时直接在 S-A 中请求 S-B 所在服务器的 IP 地址和监听的端口，这在服务规模很小的情况下是没有任何问题的，但是在服务规模很大每个服务不止部署一个实例的情况下是存在一些问题的，比如 S-B 部署了三个实例 S-B-1、S-B-2 和 S-B-3，这时候 S-A 想调用 S-B 该请求哪一个服务实例的 IP 呢？还是将 3 个服务实例的 IP 都写在 S-A 的代码里，每次调用 S-B 时选择其中一个 IP？这样做显得很不灵活，这时我们想到了 Nginx 刚好就能很好的解决这个问题，引入 Nginx 后现在的架构变成了如下图这样：</p>
<p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE1.png" alt="图1"></p>
<p>我们还需要实现一个动态 upstream，就是当我们的 S-B 的服务换了机器或者更换机器 IP 之后，依然能够热重启 nginx。</p>
<p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE2.png" alt="图2"></p>
<p>在这个架构中：</p>
<ul>
<li>首先 S-B 的实例启动后将自身的服务信息（主要是服务所在的 IP 地址和端口号）注册到注册工具中。不同注册工具服务的注册方式各不相同，后文会讲 Consul 的具体注册方式。</li>
<li>服务将服务信息注册到注册工具后，注册工具就可以对服务做健康检查，以此来确定哪些服务实例可用哪些不可用。</li>
<li>S-A 启动后就可以通过服务注册和服务发现工具获取到所有健康的 S-B 实例的 IP 和端口，并将这些信息放入自己的内存中，S-A 就可用通过这些信息来调用 S-B。</li>
<li>S-A 可以通过监听（Watch）注册工具来更新存入内存中的 S-B 的服务信息。比如 S-B-1 挂了，健康检查机制就会将其标为不可用，这样的信息变动就被 S-A 监听到了，S-A 就更新自己内存中 S-B-1 的服务信息。</li>
</ul>
<p>所以务注册与服务发现工具除了服务本身的服务注册和发现功能外至少还需要有健康检查和状态变更通知的功能。</p>
<h2 id="Consul"><a href="#Consul" class="headerlink" title="Consul"></a>Consul</h2><p>Consul 作为一种分布式服务工具，为了避免单点故障常常以集群的方式进行部署，在 Consul 集群的节点中分为 Server 和 Client 两种节点（所有的节点也被称为 Agent），Server 节点保存数据，Client 节点负责健康检查及转发数据请求到 Server；Server 节点有一个 Leader 节点和多个 Follower 节点，Leader 节点会将数据同步到 Follower 节点，在 Leader 节点挂掉的时候会启动选举机制产生一个新的 Leader。</p>
<p>Client 节点很轻量且无状态，它以 RPC 的方式向 Server 节点做读写请求的转发，此外也可以直接向 Server 节点发送读写请求。下面是 Consul 的架构图：</p>
<p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE3.png" alt="图3"></p>
<p>Consul 的安装和具体使用及其他详细内容可浏览<a href="https://www.consul.io/docs/index.html" target="_blank" rel="noopener">官方文档</a>。</p>
<h3 id="Consul-默认端口"><a href="#Consul-默认端口" class="headerlink" title="Consul 默认端口"></a>Consul 默认端口</h3><table>
<thead>
<tr>
<th>Use</th>
<th>Default Ports</th>
<th>用途说明</th>
</tr>
</thead>
<tbody><tr>
<td>DNS: The DNS server (TCP and UDP)</td>
<td>8600</td>
<td>用于解析 DNS 查询。</td>
</tr>
<tr>
<td>HTTP: The HTTP API (TCP Only)</td>
<td>8500</td>
<td>客户端使用它来与 HTTP API 通信。</td>
</tr>
<tr>
<td>HTTPS: The HTTPs API</td>
<td>disabled (8501)*</td>
<td>（可选）默认情况下处于关闭状态，但端口 8501 是各种工具默认使用的约定。</td>
</tr>
<tr>
<td>gRPC: The gRPC API</td>
<td>disabled (8502)*</td>
<td>（可选）。目前 gRPC 仅用于将 xDS API 公开给 Envoy 代理。默认情况下它处于关闭状态，但端口 8502 是各种工具用作默认值的约定。在-dev 模式下默认为 8502 。</td>
</tr>
<tr>
<td>LAN Serf: The Serf LAN port (TCP and UDP)</td>
<td>8301</td>
<td>用于处理 LAN 中的八卦。所有代理商都要求。</td>
</tr>
<tr>
<td>Wan Serf: The Serf WAN port TCP and UDP)</td>
<td>8302</td>
<td>服务器使用它来通过 WAN 闲聊到其他服务器。从 Consul 0.8 开始，WAN 加入泛洪功能要求 Serf WAN 端口（TCP / UDP）在 WAN 和 LAN 接口上进行监听。</td>
</tr>
<tr>
<td>server: Server RPC address (TCP Only)</td>
<td>8300</td>
<td>服务器使用它来处理来自其他代理的传入请求。</td>
</tr>
<tr>
<td>Sidecar Proxy Min: Inclusive min port number to use for automatically assigned sidecar service registrations.</td>
<td>21000</td>
<td>无</td>
</tr>
<tr>
<td>Sidecar Proxy Max: Inclusive max port number to use for automatically assigned sidecar service registrations..</td>
<td>21255</td>
<td>无</td>
</tr>
</tbody></table>
<p>默认端口可以通过 <a href="https://www.consul.io/docs/agent/options.html#ports" target="_blank" rel="noopener">agent configuration</a> 来修改</p>
<h3 id="运行-Consul-服务"><a href="#运行-Consul-服务" class="headerlink" title="运行 Consul 服务"></a>运行 Consul 服务</h3><p>下面是我用 Docker 的方式搭建了一个有 2 个 Server 节点和 1 个 Client 节点的 Consul 集群。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 这是Consul服务主节点</span></span><br><span class="line">docker run -d --name=c1 -p 8500:8500 -e CONSUL_BIND_INTERFACE=eth0 consul agent --server=true --bootstrap-expect=2 --client=0.0.0.0 -ui</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it c1 ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:03</span><br><span class="line">          inet addr:172.17.0.3  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:24 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:16 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:5835 (5.6 KiB)  TX bytes:1619 (1.5 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>

<p>这里，我们看到我们的 server 的主节点的 IP 为:172.17.0.3</p>
<p>让 follwer 节点加入 leader 节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=c2 -e CONSUL_BIND_INTERFACE=eth0 consul agent --server=true --client=0.0.0.0 --join 172.17.0.3</span><br></pre></td></tr></table></figure>

<p>启动 client 节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">下面是启动 Client 节点</span></span><br><span class="line">docker run -d --name=c3 -e CONSUL_BIND_INTERFACE=eth0 consul agent --server=false --client=0.0.0.0 --join 172.17.0.3</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">CONTAINER ID        IMAGE                        COMMAND                  CREATED             STATUS              PORTS                                                                      NAMES</span><br><span class="line">262fcb21e07a        consul                       "docker-entrypoint.s…"   28 seconds ago      Up 27 seconds       8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                 c3</span><br><span class="line">ffd0c626653f        consul                       "docker-entrypoint.s…"   41 minutes ago      Up 41 minutes       8300-8302/tcp, 8500/tcp, 8301-8302/udp, 8600/tcp, 8600/udp                 c2</span><br><span class="line">d6bb5fee079d        consul                       "docker-entrypoint.s…"   43 minutes ago      Up 43 minutes       8300-8302/tcp, 8301-8302/udp, 8600/tcp, 8600/udp, 0.0.0.0:8500-&gt;8500/tcp   c1</span><br></pre></td></tr></table></figure>

<p>操作 Consul 有 <a href="https://www.consul.io/docs/commands/index.html" target="_blank" rel="noopener">Commands</a> 和 <a href="https://www.consul.io/api/index.html" target="_blank" rel="noopener">HTTP API</a> 两种方式，进入任意一个容器执行 <code>consul members</code> 都可以有如下的输出，说明 Consul 集群就已经搭建成功了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it c1 consul members</span><br><span class="line">Node          Address          Status  Type    Build  Protocol  DC   Segment</span><br><span class="line">d6bb5fee079d  172.17.0.3:8301  alive   server  1.5.2  2         dc1  &lt;all&gt;</span><br><span class="line">ffd0c626653f  172.17.0.4:8301  alive   server  1.5.2  2         dc1  &lt;all&gt;</span><br><span class="line">262fcb21e07a  172.17.0.5:8301  alive   client  1.5.2  2         dc1  &lt;default&gt;</span><br></pre></td></tr></table></figure>

<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>服务注册对方式有 2 种方式</p>
<ul>
<li>通过 client 的配置来注册</li>
<li>通过 Http-Api 来注册服务</li>
</ul>
<p>由于我们的需求是需要用 Http api 来注册服务，所以接下来的例子都是以<a href="https://www.consul.io/api/agent/service.html#register-service" target="_blank" rel="noopener">http-api-register-service</a>为例子</p>
<ul>
<li>请求 Method：PUT</li>
<li>请求 Path：/agent/server/register</li>
<li>请求 Content-type: application/json</li>
</ul>
<hr>
<ul>
<li>Blocking Queries：No</li>
<li>Consistency Modes：None</li>
<li>Agent Caching：None</li>
<li>ACL Required：service:write （Acl 需要拥有写入的权限）</li>
</ul>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p>参数不仅仅只支持 StudlyCaps（首字母大写的驼峰写法<code>camel_case</code>）,还支持 蛇形大小写，<code>snake_case</code>。</p>
<ul>
<li>Name (string: &lt;required&gt;): 指定服务的逻辑名称。许多服务实例可以共享相同的逻辑服务名称。</li>
<li>ID (string: “”) : 指定此服务的唯一 ID。每个代理必须是唯一的。Name 如果未提供，则默认为参数。</li>
<li>Tags (array&lt;string&gt;: nil) : 指定要分配给服务的标记列表。这些标记可用于以后的过滤，并通过 API 公开。</li>
<li>Address (string: “”) : 指定服务的地址。如果未提供，则在 DNS 查询期间将代理的地址用作服务的地址。</li>
<li>Meta (map&lt;string|string&gt;: nil) : 指定链接到服务实例的任意 KV 元数据。</li>
<li>Port (int: 0) : 指定服务的端口。</li>
<li>Kind (string: “”) : 默认为空，代表典型的 consul 服务，这个值可填写的：connect-proxy，代表另一个服务的支持 Connect 的代理服务</li>
<li>Connect (Connect: nil)- 指定 Connect 的 <a href="https://www.consul.io/docs/connect/configuration.html" target="_blank" rel="noopener">配置</a>。有关支持的字段，请参阅下面的<a href="https://www.consul.io/api/agent/service.html#connect-structure" target="_blank" rel="noopener">连接结构</a></li>
<li>Check (Check: nil) - 指定检查。有关接受的字段的详细信息，请参阅<a href="https://www.consul.io/api/agent/check.html" target="_blank" rel="noopener">检查文档</a>。如果您没有为支票提供名称或 ID，则会生成它们。要提供自定义 ID 和/或名称，请设置 CheckID 和/或 Name 字段。</li>
<li>Checks (array&lt;Check&amp;gt: nil) - 指定检查列表。有关接受的字段的详细信息，请参阅 <a href="https://www.consul.io/api/agent/check.html" target="_blank" rel="noopener">检查文档</a>。如果您没有为支票提供名称或 ID，则会生成它们。要提供自定义 ID 和/或名称，请设置 CheckID 和/或 Name 字段。自动生成 Name 并 CheckID 依赖于数组中检查的位置，因此即使行为是确定性的，建议所有检查要么让 consul CheckID 通过将字段留空/省略来设置，或者提供唯一值。</li>
<li>EnableTagOverride (bool: false) - 指定禁用此服务标签的反熵功能。如果 EnableTagOverride 设置为，true 则外部代理可以在<a href="https://www.consul.io/api/catalog.html" target="_blank" rel="noopener">目录</a>中更新此服务 并修改标记。此代理的后续本地同步操作将忽略更新的标记。例如，如果外部代理修改了此服务的标记和端口，并且 EnableTagOverride 设置为 true 在下一个同步周期之后，则服务的端口将恢复为原始值，但标记将保持更新的值。作为一个反例，如果一个外部代理修改了这个服务的标签和端口，并 EnableTagOverride 设置为 false 在下一个同步周期后服务的端口和 标签将恢复为原始值，并且所有修改都将丢失。</li>
<li>Weights (Weights: nil) - 指定服务的权重。有关权重的更多信息，请参阅 <a href="https://www.consul.io/docs/agent/services.html" target="_blank" rel="noopener">服务文档</a>。如果未提供此字段，则权限将默认为 {“Passing”: 1, “Warning”: 1}。请务必注意，这仅适用于本地注册的服务。如果您有多个节点都注册相同的服务，则其 EnableTagOverride 配置和所有其他服务配置项彼此独立。更新在一个节点上注册的服务的标记与在另一个节点上注册的相同服务（按名称）无关。如果 EnableTagOverride 未指定，则默认值为 false。有关详细信息，请参阅反熵同步。</li>
</ul>
<h3 id="服务注册-1"><a href="#服务注册-1" class="headerlink" title="服务注册"></a>服务注册</h3><h4 id="样本载体-Sample-Payload"><a href="#样本载体-Sample-Payload" class="headerlink" title="样本载体(Sample Payload)"></a>样本载体(Sample Payload)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">## cat payload1.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ID"</span>: <span class="string">"redis1"</span>,</span><br><span class="line">  <span class="attr">"Name"</span>: <span class="string">"redis"</span>,</span><br><span class="line">  <span class="attr">"Tags"</span>: [</span><br><span class="line">    <span class="string">"primary"</span>,</span><br><span class="line">    <span class="string">"v1"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"Address"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">  <span class="attr">"Port"</span>: <span class="number">8000</span>,</span><br><span class="line">  <span class="attr">"Meta"</span>: &#123;</span><br><span class="line">    <span class="attr">"redis_version"</span>: <span class="string">"4.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"Check"</span>: &#123;</span><br><span class="line">    <span class="attr">"HTTP"</span>: <span class="string">"http://127.0.0.1:5000/health"</span>,</span><br><span class="line">    <span class="attr">"Interval"</span>: <span class="string">"10s"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"Weights"</span>: &#123;</span><br><span class="line">    <span class="attr">"Passing"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"Warning"</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">## cat payload2.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ID"</span>: <span class="string">"redis2"</span>,</span><br><span class="line">  <span class="attr">"Name"</span>: <span class="string">"redis"</span>,</span><br><span class="line">  <span class="attr">"Tags"</span>: [</span><br><span class="line">    <span class="string">"primary"</span>,</span><br><span class="line">    <span class="string">"v1"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"Address"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">  <span class="attr">"Port"</span>: <span class="number">8000</span>,</span><br><span class="line">  <span class="attr">"Meta"</span>: &#123;</span><br><span class="line">    <span class="attr">"redis_version"</span>: <span class="string">"4.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"Weights"</span>: &#123;</span><br><span class="line">    <span class="attr">"Passing"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"Warning"</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">## cat payload3.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"ID"</span>: <span class="string">"redis3"</span>,</span><br><span class="line">  <span class="attr">"Name"</span>: <span class="string">"redis"</span>,</span><br><span class="line">  <span class="attr">"Tags"</span>: [</span><br><span class="line">    <span class="string">"primary"</span>,</span><br><span class="line">    <span class="string">"v1"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"Address"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">  <span class="attr">"Port"</span>: <span class="number">8001</span>,</span><br><span class="line">  <span class="attr">"Meta"</span>: &#123;</span><br><span class="line">    <span class="attr">"redis_version"</span>: <span class="string">"4.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"EnableTagOverride"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"Weights"</span>: &#123;</span><br><span class="line">    <span class="attr">"Passing"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"Warning"</span>: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="样本请求-Sample-Request"><a href="#样本请求-Sample-Request" class="headerlink" title="样本请求(Sample Request)"></a>样本请求(Sample Request)</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl \</span><br><span class="line">    --request PUT \</span><br><span class="line">    --data @payload1.json \</span><br><span class="line">    http://127.0.0.1:8500/v1/agent/service/register</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl \</span><br><span class="line">    --request PUT \</span><br><span class="line">    --data @payload2.json \</span><br><span class="line">    http://127.0.0.1:8500/v1/agent/service/register</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl \</span><br><span class="line">    --request PUT \</span><br><span class="line">    --data @payload3.json \</span><br><span class="line">    http://127.0.0.1:8500/v1/agent/service/register</span><br></pre></td></tr></table></figure>

<p>在 consul-ui 上可以看到是否注册成功，也可以通过 http-api 查看是否注册成功</p>
<p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE4.png" alt="图4"></p>
<p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE5.png" alt="图5"></p>
<p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE6.png" alt="图6"></p>
<p>从上图看出，有<code>check</code>机制的那个有一个节点目前是<code>心跳检测失败</code>的。</p>
<h4 id="心跳机制-check"><a href="#心跳机制-check" class="headerlink" title="心跳机制(check)"></a>心跳机制(check)</h4><p>Http 的 check 机制只要返回的状态为<code>2xx</code>，就算为成功，如果是<code>4xx</code>,就算为危险，<code>其他状态码</code>算为严重.</p>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>服务注册之后，我们就需要从 consul 中拿到这些服务信息</p>
<ul>
<li><a href="https://www.consul.io/api/health.html" target="_blank" rel="noopener">Health 相关的 API</a></li>
<li><a href="https://www.consul.io/api/health.html#list-nodes-for-service" target="_blank" rel="noopener">Health-service 的 API</a></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:8500/v1/health/service/redis?passing=true</span><br></pre></td></tr></table></figure>

<ul>
<li>passing （这个参数可以帮我们只显示可用的服务节点）</li>
<li>filter （服务需要定制过滤的可以传入这个参数，详情看文档）</li>
</ul>
<p>这个时候，我们可以拿到所有<code>可用</code>的服务列表之后，需要找到<code>地方(内存)</code>把这个<code>&quot;列表&quot;</code>存储起来，在我们的 Client 或者 API 网关进程内部实现一个内部<code>LB</code>的机制，这样子就不需要每次请求都去拿一次这个可用服务的信息。</p>
<p>内部的<code>LB</code>机制一般就是<code>轮训</code>或者<code>随机</code>。</p>
<h3 id="服务更新-LB-信息-Watch"><a href="#服务更新-LB-信息-Watch" class="headerlink" title="服务更新 LB 信息(Watch)"></a>服务更新 LB 信息(Watch)</h3><p>由于我们的服务不一定一直都处于可用的状态，所以我们要跟随者<code>服务注册中心</code>来更新我们的内部的<code>LB</code>内容，所以我们需要<code>服务注册中心</code>告诉我们我要访问的那些服务，哪一些服务变成不可用了，我要移除<code>LB</code>。</p>
<p>所以，这里，我们需要利用 consul 的<a href="https://www.consul.io/docs/agent/watches.html" target="_blank" rel="noopener">watch 机制</a>。</p>
<p>Consul 有两种 Watch 的方式</p>
<ul>
<li>script （触发 client 端本地的脚本）</li>
<li>http (触发远端的 url，类似钩子的行为)</li>
</ul>
<p>这里，我们选择 http 的方式。</p>
<h4 id="Watch-的类型"><a href="#Watch-的类型" class="headerlink" title="Watch 的类型"></a>Watch 的类型</h4><ul>
<li><a href="https://www.consul.io/docs/agent/watches.html#key" target="_blank" rel="noopener">key</a> - Watch a specific KV pair</li>
<li><a href="https://www.consul.io/docs/agent/watches.html#keyprefix" target="_blank" rel="noopener">keyprefix</a> - Watch a prefix in the KV store</li>
<li><a href="https://www.consul.io/docs/agent/watches.html#services" target="_blank" rel="noopener">services</a> - Watch the list of available services</li>
<li><a href="https://www.consul.io/docs/agent/watches.html#nodes" target="_blank" rel="noopener">nodes</a> - Watch the list of nodes</li>
<li><a href="https://www.consul.io/docs/agent/watches.html#service" target="_blank" rel="noopener">service</a>- Watch the instances of a service</li>
<li><a href="https://www.consul.io/docs/agent/watches.html#checks" target="_blank" rel="noopener">checks</a> - Watch the value of health checks</li>
<li><a href="https://www.consul.io/docs/agent/watches.html#event" target="_blank" rel="noopener">event</a> - Watch for custom user events</li>
</ul>
<p> 这里，我们需要 watch 的是<code>service</code>，因为我们需要动态的去更新我们自身的<code>LB</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;type&quot;: &quot;service&quot;,</span><br><span class="line">  &quot;service&quot;: &quot;redis&quot;,</span><br><span class="line">  &quot;handler_type&quot;: &quot;http&quot;,</span><br><span class="line">  &quot;http_handler_config&quot;: &#123;</span><br><span class="line">    &quot;path&quot;:&quot;https:&#x2F;&#x2F;localhost:8000&#x2F;callBackWatch&quot;,</span><br><span class="line">    &quot;method&quot;: &quot;POST&quot;,</span><br><span class="line">    &quot;header&quot;: &#123;&quot;x-foo&quot;:[&quot;bar&quot;, &quot;baz&quot;]&#125;,</span><br><span class="line">    &quot;timeout&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;tls_skip_verify&quot;: false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们提供了一个<code>callBackWatch</code>的服务用于接手 consul 的 watch 到 service 变化的 payload，用于更新我们自己的<code>LB</code> 内容。</p>
<h3 id="常规部署架构图"><a href="#常规部署架构图" class="headerlink" title="常规部署架构图"></a>常规部署架构图</h3><p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE8.png" alt="图8"></p>
<p>首先需要有一个正常的 Consul 集群，有 Server，有 Leader。这里在服务器 Server1、Server2、Server3 上分别部署了 Consul Server，假设他们选举了 Server2 上的 Consul Server 节点为 Leader。这些服务器上最好只部署 Consul 程序，以尽量维护 Consul Server 的稳定。</p>
<p>然后在服务器 Server4 和 Server5 上通过 Consul Client 分别注册 Service A、B、C，这里每个 Service 分别部署在了两个服务器上，这样可以避免 Service 的单点问题。服务注册到 Consul 可以通过 HTTP API（8500 端口）的方式，也可以通过 Consul 配置文件的方式。Consul Client 可以认为是无状态的，它将注册信息通过 RPC 转发到 Consul Server，服务信息保存在 Server 的各个节点中，并且通过 Raft 实现了强一致性。</p>
<p>最后在服务器 Server6 中 Program D 需要访问 Service B，这时候 Program D 首先访问本机 Consul Client 提供的 HTTP API，本机 Client 会将请求转发到 Consul Server，Consul Server 查询到 Service B 当前的信息返回，最终 Program D 拿到了 Service B 的所有部署的 IP 和端口，然后就可以选择 Service B 的其中一个部署并向其发起请求了。如果服务发现采用的是 DNS 方式，则 Program D 中直接使用 Service B 的服务发现域名，域名解析请求首先到达本机 DNS 代理，然后转发到本机 Consul Client，本机 Client 会将请求转发到 Consul Server，Consul Server 查询到 Service B 当前的信息返回，最终 Program D 拿到了 Service B 的某个部署的 IP 和端口。</p>
<h3 id="部署架构"><a href="#部署架构" class="headerlink" title="部署架构"></a>部署架构</h3><p>官方推荐的是那个主机都安装一个 clinet，这个是十分不科学的做法，如果你实在不想在每个主机部署 Consul Client，还有一个多路注册的方案可供选择。</p>
<p><img src="/images/%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0/consul/%E5%9B%BE7.png" alt="图7"></p>
<p>如图所示，在专门的服务器上部署 Consul Client，然后每个服务都注册到多个 Client，这里为了避免服务单点问题还是每个服务部署多份，需要服务发现时，程序向一个提供负载均衡的程序发起请求，该程序将请求转发到某个 Consul Client。这种方案需要注意将 Consul 的 8500 端口绑定到私网 IP 上，默认只有 127.0.0.1。</p>
<h4 id="这个架构的优势："><a href="#这个架构的优势：" class="headerlink" title="这个架构的优势："></a>这个架构的优势：</h4><ul>
<li>Consul 节点服务器与应用服务器隔离，互相干扰少；</li>
<li>不用每台主机都部署 Consul，方便 Consul 的集中管理；</li>
<li>某个 Consul Client 挂掉的情况下，注册到其上的服务仍有机会被访问到；</li>
</ul>
<h4 id="但也需要注意其缺点："><a href="#但也需要注意其缺点：" class="headerlink" title="但也需要注意其缺点："></a>但也需要注意其缺点：</h4><ul>
<li>引入更多技术栈：负载均衡的实现，不仅要考虑 Consul Client 的负载均衡，还要考虑负载均衡本身的单点问题。</li>
<li>Client 的节点数量：单个 Client 如果注册的服务太多，负载较重，需要有个算法（比如 hash 一致）合理分配每个 Client 上的服务数量，以及确定 Client 的总体数量。</li>
<li>服务发现要过滤掉重复的注册，因为注册到了多个节点会认为是多个部署（DNS 接口不会有这个问题）。</li>
</ul>
<p>这个方案其实还可以优化，服务发现使用的负载均衡可以直接代理 Server 节点，因为相关请求还是会转发到 Server 节点，不如直接就发到 Server。</p>
<h3 id="Consul-的健康检查"><a href="#Consul-的健康检查" class="headerlink" title="Consul 的健康检查"></a>Consul 的健康检查</h3><p>Consul 做服务发现是专业的，健康检查是其中一项必不可少的功能，其提供 Script/TCP/HTTP+Interval，以及 TTL 等多种方式。服务的健康检查由服务注册到的 Agent 来处理，这个 Agent 既可以是 Client 也可以是 Server。</p>
<p>很多同学都使用 ZooKeeper 或者 etcd 做服务发现，使用 Consul 时发现节点挂掉后服务的状态变为不可用了，所以有同学问服务为什么不在各个节点之间同步？这个根本原因是服务发现的实现原理不同。</p>
<h4 id="Consul-与-ZooKeeper、etcd-的区别"><a href="#Consul-与-ZooKeeper、etcd-的区别" class="headerlink" title="Consul 与 ZooKeeper、etcd 的区别"></a>Consul 与 ZooKeeper、etcd 的区别</h4><p>后边这两个工具是通过键值存储来实现服务的注册与发现。</p>
<ul>
<li>ZooKeeper 利用临时节点的机制，业务服务启动时创建临时节点，节点在服务就在，节点不存在服务就不存在。</li>
<li>etcd 利用 TTL 机制，业务服务启动时创建键值对，定时更新 ttl，ttl 过期则服务不可用。</li>
</ul>
<p>ZooKeeper 和 etcd 的键值存储都是强一致性的，也就是说键值对会自动同步到多个节点，只要在某个节点上存在就可以认为对应的业务服务是可用的。</p>
<p>Consul 的数据同步也是强一致性的，服务的注册信息会在 Server 节点之间同步，相比 ZK、etcd，服务的信息还是持久化保存的，即使服务部署不可用了，仍旧可以查询到这个服务部署。但是业务服务的可用状态是由注册到的 Agent 来维护的，Agent 如果不能正常工作了，则无法确定服务的真实状态，并且 Consul 是相当稳定了，Agent 挂掉的情况下大概率服务器的状态也可能是不好的，此时屏蔽掉此节点上的服务是合理的。Consul 也确实是这样设计的，DNS 接口会自动屏蔽挂掉节点上的服务，HTTP API 也认为挂掉节点上的服务不是 passing 的。</p>
<p>鉴于 Consul 健康检查的这种机制，同时避免单点故障，所有的业务服务应该部署多份，并注册到不同的 Consul 节点。部署多份可能会给你的设计带来一些挑战，因为调用方同时访问多个服务实例可能会由于会话不共享导致状态不一致，这个有许多成熟的解决方案，可以去查询，这里不做说明。</p>
<h4 id="健康检查能不能支持故障转移？"><a href="#健康检查能不能支持故障转移？" class="headerlink" title="健康检查能不能支持故障转移？"></a>健康检查能不能支持故障转移？</h4><p>上边提到健康检查是由服务注册到的 Agent 来处理的，那么如果这个 Agent 挂掉了，会不会有别的 Agent 来接管健康检查呢？答案是否定的。</p>
<p>从问题产生的原因来看，在应用于生产环境之前，肯定需要对各种场景进行测试，没有问题才会上线，所以显而易见的问题可以屏蔽掉；如果是新版本 Consul 的 BUG 导致的，此时需要降级；如果这个 BUG 是偶发的，那么只需要将 Consul 重新拉起来就可以了，这样比较简单；如果是硬件、网络或者操作系统故障，那么节点上服务的可用性也很难保障，不需要别的 Agent 接管健康检查。</p>
<p>从实现上看，选择哪个节点是个问题，这需要实时或准实时同步各个节点的负载状态，而且由于业务服务运行状态多变，即使当时选择出了负载比较轻松的节点，无法保证某个时段任务又变得繁重，可能造成新的更大范围的崩溃。如果原来的节点还要启动起来，那么接管的健康检查是否还要撤销，如果要，需要记录服务们最初注册的节点，然后有一个监听机制来触发，如果不要，通过服务发现就会获取到很多冗余的信息，并且随着时间推移，这种数据会越来越多，系统变的无序。</p>
<p>从实际应用看，节点上的服务可能既要被发现，又要发现别的服务，如果节点挂掉了，仅提供被发现的功能实际上服务还是不可用的。当然发现别的服务也可以不使用本机节点，可以通过访问一个 Nginx 实现的若干 Consul 节点的负载均衡来实现，这无疑又引入了新的技术栈。</p>
<p>如果不是上边提到的问题，或者你可以通过一些方式解决这些问题，健康检查接管的实现也必然是比较复杂的，因为分布式系统的状态同步是比较复杂的。同时不要忘了服务部署了多份，挂掉一个不应该影响系统的快速恢复，所以没必要去做这个接管。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/服务注册和发现/">服务注册和发现</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/服务注册和发现/">服务注册和发现</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2024 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>